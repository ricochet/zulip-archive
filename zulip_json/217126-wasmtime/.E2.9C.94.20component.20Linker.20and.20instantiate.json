[
    {
        "content": "<p>Maybe it's too early to try this, but I am trying to create an export in Rust and link it as a component to  a Wasm module with this</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">wasmtime</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Configure an `Engine` and compile the `Component` that is being run for</span>\n<span class=\"w\">    </span><span class=\"c1\">// the application.</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Config</span>::<span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_component_model</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Engine</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">config</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Module</span>::<span class=\"n\">from_file</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"./cswasi.wasm\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">HelloWorld</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">state</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">MyState</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span>::<span class=\"n\">new</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">name</span>: <span class=\"mi\">1</span><span class=\"k\">f32</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bindings</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">HelloWorld</span>::<span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">module</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">linker</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>which is wrong, for starters <code>instantiate</code> doesn't take the module but the component.  Is this too early, or can I modify this to work?</p>",
        "id": 374044511,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689012038
    },
    {
        "content": "<p>preceeding code is </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">bindgen</span><span class=\"o\">!</span><span class=\"p\">();</span>\n\n<span class=\"k\">struct</span> <span class=\"nc\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span>: <span class=\"kt\">f32</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// Imports into the world, like the `name` import for this world, are satisfied</span>\n<span class=\"c1\">// through traits.</span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">HelloWorldImports</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Note the `Result` return value here where `Ok` is returned back to</span>\n<span class=\"w\">    </span><span class=\"c1\">// the component and `Err` will raise a trap.S</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">name</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span>: <span class=\"kt\">f32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">wasmtime</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Hello from rust {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>and the wit</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">my</span>:<span class=\"nc\">project</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"o\">-</span><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">name</span>: <span class=\"nc\">func</span><span class=\"p\">(</span><span class=\"n\">f</span>: <span class=\"nc\">float32</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">greet</span>: <span class=\"nc\">func</span><span class=\"p\">()</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 374044951,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689012140
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395878\">@Scott Waye</span> this should work, but you want <code>let component = Component::from_binary(&amp;engine, &amp;component_bytes).unwrap();</code></p>",
        "id": 374047593,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1689012811
    },
    {
        "content": "<p>I haven't personally been able to figure out function imports yet, but instances with functions can be added eg via</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">iface_instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instance</span><span class=\"p\">(</span><span class=\"s\">\"iface\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"n\">iface_instance</span><span class=\"p\">.</span><span class=\"n\">func_wrap</span><span class=\"p\">(</span><span class=\"s\">\"name\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">_store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">params</span>: <span class=\"p\">(</span><span class=\"kt\">f32</span><span class=\"p\">,)</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">})</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>For the WIT:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">iface</span>: <span class=\"nc\">interface</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">name</span>: <span class=\"nc\">func</span><span class=\"p\">(</span><span class=\"n\">f</span>: <span class=\"nc\">float32</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 374047917,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1689012902
    },
    {
        "content": "<p>also depending on how you produce the component you may need to include the wasi bindings</p>",
        "id": 374048049,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1689012953
    },
    {
        "content": "<p>there's a wasi linking example in <a href=\"https://github.com/bytecodealliance/componentize-js/blob/main/example/src/main.rs\">https://github.com/bytecodealliance/componentize-js/blob/main/example/src/main.rs</a> if it helps</p>",
        "id": 374048182,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1689012985
    },
    {
        "content": "<p>for plain function imports which are not inside an instance, <code>linker.root()</code> gives you the root namespace, as a substitute to linker.instance(\"name\")?</p>",
        "id": 374049396,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689013303
    },
    {
        "content": "<p>ah nice, I wasn't aware of that</p>",
        "id": 374049713,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1689013390
    },
    {
        "content": "<p>If my terminology is right, I thought the component would be produced by the <code>bindgen!</code> macro and the <code>impl</code>.  I want to export from rust, so I change the wit to </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"o\">-</span><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">name</span>: <span class=\"nc\">func</span><span class=\"p\">(</span><span class=\"n\">f</span>: <span class=\"nc\">float32</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>but what is the trait name, I tried HelloWorld and HelloWorldExports and neither compiles.  or if I <code>func_wrap</code> do I not need the trait?</p>",
        "id": 374050934,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689013709
    },
    {
        "content": "<p>the trait should be named <code>Host</code></p>",
        "id": 374051103,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689013755
    },
    {
        "content": "<p>i'm not sure off the top of my head what module it lives in. i usually run <code>cargo doc</code> when i need to figure out what got generated.</p>",
        "id": 374051356,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689013813
    },
    {
        "content": "<p>the componentize-js example looks interesting, I guess I should be getting some wasm generated by the macro which I need to <code> let component = Component::from_file(&amp;engine, \"hello.component.wasm\").unwrap();</code></p>",
        "id": 374051730,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689013925
    },
    {
        "content": "<p>no wait, that can't be right</p>",
        "id": 374051862,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689013962
    },
    {
        "content": "<p>let me try <code>linker.root</code></p>",
        "id": 374052061,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689014015
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253992\">Pat Hickey</span> <a href=\"#narrow/stream/217126-wasmtime/topic/component.20Linker.20and.20instantiate/near/374051103\">said</a>:</p>\n<blockquote>\n<p>the trait should be named <code>Host</code></p>\n</blockquote>\n<p>WHere does the string <code>Host</code> come from, is that hard coded somewhere as it is not in my rust or wit?</p>",
        "id": 374059293,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689015778
    },
    {
        "content": "<p>and I get </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">[</span><span class=\"n\">E0405</span><span class=\"p\">]</span>: <span class=\"nc\">cannot</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Host</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">scope</span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">src</span><span class=\"err\">\\</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">12</span>:<span class=\"mi\">6</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"o\">^^^^</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">scope</span>\n</code></pre></div>",
        "id": 374059520,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689015825
    },
    {
        "content": "<p>every trait generated by wasmtime::component::bindgen! is named <code>Host</code>, but they end up in different modules to differentiate them</p>",
        "id": 374060034,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689015941
    },
    {
        "content": "<p>im not sure what module the root ends up in (and maybe it doesnt, which would be a bug) - that was what i was suggesting cargo doc to explore</p>",
        "id": 374060228,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689015979
    },
    {
        "content": "<p>try <code>hello_world::Host</code> i suppose</p>",
        "id": 374060287,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689016001
    },
    {
        "content": "<p>I see, unfortunately <code>cargo doc</code>errors with </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">Documenting</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"o\">-</span><span class=\"n\">wasmtime</span><span class=\"p\">)</span>\n<span class=\"n\">error</span><span class=\"p\">[</span><span class=\"n\">E0405</span><span class=\"p\">]</span>: <span class=\"nc\">cannot</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Host</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">scope</span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">src</span><span class=\"err\">\\</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">12</span>:<span class=\"mi\">6</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">      </span><span class=\"o\">^^^^</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">scope</span>\n\n<span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"> </span><span class=\"n\">about</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kr\">try</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">explain</span><span class=\"w\"> </span><span class=\"n\">E0405</span><span class=\"err\">`</span><span class=\"p\">.</span>\n</code></pre></div>",
        "id": 374060345,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689016022
    },
    {
        "content": "<p>oh, you'll have to comment out the parts of your code that dont typecheck yet</p>",
        "id": 374060393,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689016033
    },
    {
        "content": "<p>it should be sufficient to just run bindgen in an otherwise empty crate and see the docs of it</p>",
        "id": 374060481,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689016063
    },
    {
        "content": "<p>thanks, <code>doc</code> has completed, but I dont thinkg the trait was generated as a grep for Host in <code>cs-runtime-example-wasmtime\\target\\doc\\cs_runtime_example</code> revealed no hits<br>\n<a href=\"/user_uploads/15107/CXwQzFrmm1b67TsJK-ygD7Qe/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/15107/CXwQzFrmm1b67TsJK-ygD7Qe/image.png\" title=\"image.png\"><img src=\"/user_uploads/15107/CXwQzFrmm1b67TsJK-ygD7Qe/image.png\"></a></div>",
        "id": 374062218,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689016529
    },
    {
        "content": "<p>oh, ok. i had gotten <code>import</code> and <code>export</code> mixed up when i read your example.</p>",
        "id": 374063876,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689016975
    },
    {
        "content": "<p><code>export name: func...</code> means that the HelloWorld struct will have a <code>run_name</code> method.</p>",
        "id": 374064004,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689017006
    },
    {
        "content": "<p>try adding <code>import name2: func...</code> and then hopefully itll generate a trait</p>",
        "id": 374064123,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689017042
    },
    {
        "content": "<p>wasmtime is defining the implementation of a world, so the traits provide the implementations of imports, and methods on the world struct are used to call exports, which are implemented in the Component</p>",
        "id": 374064457,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689017119
    },
    {
        "content": "<p>Thanks, that does indeed generate the trait, in my case I want the rust to be the component and provide the method which will be called by a wasm module, at least that is what I'm trying to do.  So if I'm reading your last comment right.  I don't need the export, I just need the import.</p>",
        "id": 374082423,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689022582
    },
    {
        "content": "<p>I'm trying something which I hope is simpler, wrapping a function in the root namespace.  I'm going to need a componet::Linker I think, but looking at <a href=\"https://github.com/bytecodealliance/componentize-js/blob/4afe77879cef8154f4c8671a61ffbd3d651fc251/example/src/main.rs#L27\">https://github.com/bytecodealliance/componentize-js/blob/4afe77879cef8154f4c8671a61ffbd3d651fc251/example/src/main.rs#L27</a> that would seem easy, but for me I get</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"o\">-</span><span class=\"n\">wasmtime</span><span class=\"p\">)</span>\n<span class=\"n\">error</span><span class=\"p\">[</span><span class=\"n\">E0282</span><span class=\"p\">]</span>: <span class=\"nc\">type</span><span class=\"w\"> </span><span class=\"n\">annotations</span><span class=\"w\"> </span><span class=\"n\">needed</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasmtime</span>::<span class=\"n\">component</span>::<span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"err\">`</span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">src</span><span class=\"err\">\\</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">36</span>:<span class=\"mi\">9</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"o\">^^^^^^^^^^</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"n\">help</span>: <span class=\"nc\">consider</span><span class=\"w\"> </span><span class=\"n\">giving</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">linker</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">explicit</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"nc\">for</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"nc\">parameter</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">T</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">specified</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">component</span>::<span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">                   </span><span class=\"o\">++++++++++++++++++++++++++++++++</span>\n\n<span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"> </span><span class=\"n\">about</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kr\">try</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">explain</span><span class=\"w\"> </span><span class=\"n\">E0282</span><span class=\"err\">`</span><span class=\"p\">.</span>\n</code></pre></div>\n<p>What type should be given to the variable?</p>",
        "id": 374120056,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689040465
    },
    {
        "content": "<p>Maybe I dont need that looking at other examples.  I now have</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"o\">-</span><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">name2</span>: <span class=\"nc\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">f</span>: <span class=\"nc\">float32</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">name</span>: <span class=\"nc\">func</span><span class=\"p\">(</span><span class=\"n\">f</span>: <span class=\"nc\">float32</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">wasmtime</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Configure an `Engine` and compile the `Component` that is being run for</span>\n<span class=\"w\">    </span><span class=\"c1\">// the application.</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Config</span>::<span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_component_model</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Engine</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">config</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Module</span>::<span class=\"n\">from_file</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"./cswasi.wasm\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span>:<span class=\"nc\">MyState</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span>::<span class=\"n\">new</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">state</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"n\">HelloWorld</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">x</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p><code>|x| x</code> seems to be a common way to call <code>add_to_linker</code>, but I get</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"o\">-</span><span class=\"n\">wasmtime</span><span class=\"p\">)</span>\n<span class=\"n\">error</span><span class=\"p\">[</span><span class=\"n\">E0282</span><span class=\"p\">]</span>: <span class=\"nc\">type</span><span class=\"w\"> </span><span class=\"n\">annotations</span><span class=\"w\"> </span><span class=\"n\">needed</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"err\">`</span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">src</span><span class=\"err\">\\</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">45</span>:<span class=\"mi\">45</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">HelloWorld</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">x</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">                                             </span><span class=\"o\">^</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"n\">help</span>: <span class=\"nc\">consider</span><span class=\"w\"> </span><span class=\"n\">giving</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"w\"> </span><span class=\"n\">parameter</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">explicit</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"nc\">for</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"nc\">parameter</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">T</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">specified</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">HelloWorld</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">x</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">                                              </span><span class=\"o\">++++++++</span>\n\n<span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"> </span><span class=\"n\">about</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kr\">try</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">explain</span><span class=\"w\"> </span><span class=\"n\">E0282</span><span class=\"err\">`</span><span class=\"p\">.</span>\n<span class=\"n\">error</span>: <span class=\"nc\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"s\">\"cs-runtime-example\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">error</span>\n</code></pre></div>",
        "id": 374129547,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689046034
    },
    {
        "content": "<p>I don't think you need to call HelloWorld::add_to_linker, as long as you define the import function in the linker via eg <code>linker.root().func_wrap</code> as above</p>",
        "id": 374130305,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1689046551
    },
    {
        "content": "<p>HelloWorld::add_to_linker provides the correct func_wrap invocations that will dispatch to the Host traits</p>",
        "id": 374133961,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689048750
    },
    {
        "content": "<p>ah, I never figured out how to call it correctly myself :P</p>",
        "id": 374134072,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1689048819
    },
    {
        "content": "<p>the closure argument given to add_to_linker is for mapping to the particular ctx type that your Host trait uses - the idea is that you can have some <code>struct CustomCtx { wasi: WasiCtx, table: Table, hello: HelloCtx }</code></p>",
        "id": 374134081,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689048823
    },
    {
        "content": "<p>that suits your embedding</p>",
        "id": 374134096,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689048832
    },
    {
        "content": "<p>and then you provide an <code>impl hello_world::Host for HelloCtx { ... }</code></p>",
        "id": 374134166,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689048847
    },
    {
        "content": "<p>and your <code>struct HelloCtx {...}</code> can have whatever members you need to implement those imports.</p>",
        "id": 374134180,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689048862
    },
    {
        "content": "<p>the func wrapping that happens in add_to_linker is all about applying the closure you provide - in this case it would be something like <code>|ctx: &amp;mut CustomCtx| &amp;mut ctx.hello</code> - to the data (T) kept in your Store&lt;T&gt; (accessed in the func_wrap via Caller&lt;T&gt;, but if you squint Caller is just a more restricted interface to Store)</p>",
        "id": 374134263,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689048908
    },
    {
        "content": "<p>the reason youve seen the <code>|x| x</code> pattern a bunch in components is a complication we have at the moment where we need to share the <code>Table</code> member across many different impls... in the future we're going to make Table provided directly by the component runtime instead of a plug in from wasi, and then all the WasiView nonsense will go away and you'll go back to calling <code>Wasi::add_to_linker(&amp;mut store, |ctx| &amp;mut ctx.wasi)</code></p>",
        "id": 374134404,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689049012
    },
    {
        "content": "<p>you can ignore that explanation if you arent yet trying to do anything resource-like. proper support for resources is coming soon.</p>",
        "id": 374134553,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689049138
    },
    {
        "content": "<p>Thanks, that is super useful and I think I now have the structs and closure set up correctly.  At <a href=\"https://radu-matei.com/pdf/wasm-components-host-implementations.pdf\">https://radu-matei.com/pdf/wasm-components-host-implementations.pdf</a> it has <code>let instance = linker.instantiate(&amp;mut store, &amp;module)?;</code> but I suppose that is not the right way to do things now and I need a component wasm, not a module?  I.e. its not possible to link a module with a component, or at least not yet.</p>",
        "id": 374475270,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689130337
    },
    {
        "content": "<p>Which seems to lead to the next question, how does one create a wasm component.  There is <code>wasm-tools component</code> but can it convert a module with an <code>import</code> to a component that can be instantiated using <code>wasmtime::component::from_file</code> that I could then use <code>Linker</code> to link with the rust compoent?</p>",
        "id": 374479749,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689132772
    },
    {
        "content": "<p>I did try but get</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"o\">-</span><span class=\"n\">wasmtime</span><span class=\"o\">&gt;</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">cswasi</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">cswasi</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">module</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">module</span><span class=\"w\"> </span><span class=\"n\">requires</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">rust</span><span class=\"err\">`</span>\n</code></pre></div>\n<p>This module does indeed have an import from <code>rust</code> as the one I am trying to satisfy from the call to <code>add_to_linker</code></p>",
        "id": 374618200,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689168197
    },
    {
        "content": "<p>I tried <code>wasm-tools component embed --dummy -o dummy.wat -t -w hello-world wit/cswasi.wit</code> and it looks like the import name is going to be <code>$root</code>, no way to change that from the wit I suppose?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">module</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"kt\">f32</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(;</span><span class=\"mi\">1</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"$root\"</span><span class=\"w\"> </span><span class=\"s\">\"name2\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)))</span>\n</code></pre></div>",
        "id": 374620889,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689168750
    },
    {
        "content": "<p>Having aligned the module name it <code>wasm-tools component new</code> now seems to want to know where the import is coming from which seems counter intuitive</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"o\">-</span><span class=\"n\">wasmtime</span><span class=\"o\">&gt;</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">cswasi</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">cswasi</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">module</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">no</span><span class=\"w\"> </span><span class=\"n\">top</span><span class=\"o\">-</span><span class=\"n\">level</span><span class=\"w\"> </span><span class=\"n\">imported</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasmImportFloat32Param</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">specified</span>\n</code></pre></div>",
        "id": 374624687,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689169464
    },
    {
        "content": "<p>I changed my wit to use that name, but as the wit is not an import to <code>wasm-tools component new</code> that seems irrelevant for this step.</p>",
        "id": 374624999,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689169513
    },
    {
        "content": "<p>Think I will look at the source code for <code>linker.instantiate</code> to see what is uses to determine if a wasm file is a component or module</p>",
        "id": 374658334,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689175416
    },
    {
        "content": "<p>that doc from radu is super out of date, that was using machinery for components that was basically just a prototype for what ended up becoming the implementation today.</p>",
        "id": 374683298,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689180182
    },
    {
        "content": "<p>you want to use <code>wasmtime::component::Linker</code> for all your linking. that will only accept a <code>Component</code> in instantiate: <a href=\"https://docs.rs/wasmtime/latest/wasmtime/component/struct.Linker.html#method.instantiate\">https://docs.rs/wasmtime/latest/wasmtime/component/struct.Linker.html#method.instantiate</a></p>",
        "id": 374684173,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689180380
    },
    {
        "content": "<p><code>wasm-tools component new</code> creates a component from a module. to do so, it needs to map all of the module's imports and exports (we often call these the core wasm imports and exports) to component imports and exports. to do so, it needs all of the component type information</p>",
        "id": 374684511,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689180450
    },
    {
        "content": "<p>it can get that type information from one of two places: special custom sections in the wasm module, or from special adapter arguments (this is really just used to map wasi preview 1 to wasi preview 2, and i would recommend not using it for anything else)</p>",
        "id": 374685243,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689180613
    },
    {
        "content": "<p>if you are creating your wasm module using one of the various wit-bindgen language implementations, it will stick the special custom sections into your linked executable for you (exception being the C backend, where it emits an object file that you need to manually pass into your linking step, but thats really just a C-specific detail)</p>",
        "id": 374685590,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689180685
    },
    {
        "content": "<p>if you are not using wit-bindgen, then you have to replicate that behavior on your own somehow, and that is a whole can of worms, but for now i'll assume you are indeed using wit-bindgen - is that correct?</p>",
        "id": 374685806,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689180726
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253992\">Pat Hickey</span> <a href=\"#narrow/stream/217126-wasmtime/topic/component.20Linker.20and.20instantiate/near/374685806\">said</a>:</p>\n<blockquote>\n<p>wit-bindgen - is that correct?</p>\n</blockquote>\n<p>Not really, I(we) want to add the ability to wit-bindgen because we are using c#.  So for now we are using a mixture of a prototype <code>wit-bindgen</code> and the NativeAOT-LLVM c# compiler (which I help develop).  I assume our Wasm that we produce is lacking some info that makes the wasm file a component, and I need to understand what those \"special custom sections\" are to see if ideally I can coerce clang/wasm-ld to produce them or if not, create a tool using a library that Alex Crichton mentioned <code>wasm-encoder</code></p>",
        "id": 374717732,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689188953
    },
    {
        "content": "<p>For a first cut I could just edit the wat to add them.  For my simple case, I'm guessing that is not too much.</p>",
        "id": 374718608,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689189194
    },
    {
        "content": "<p>I think a need a <code>component-type</code> section, I'll see what the layout of that should be.</p>",
        "id": 374752921,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689198950
    },
    {
        "content": "<p>That is not trivial: <a href=\"https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/src/metadata.rs\">https://github.com/bytecodealliance/wasm-tools/blob/main/crates/wit-component/src/metadata.rs</a></p>",
        "id": 374755286,
        "sender_full_name": "Lann Martin",
        "timestamp": 1689199885
    },
    {
        "content": "<p>maybe not, wasm2wat doesn't help as apparently custom sections are not defined for wat</p>",
        "id": 374779620,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689211052
    },
    {
        "content": "<p>does look like it is text though</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Contents</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">section</span><span class=\"w\"> </span><span class=\"n\">Custom</span>:\n<span class=\"mi\">00</span><span class=\"n\">b0f05</span>: <span class=\"mi\">1363</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f6d</span><span class=\"w\"> </span><span class=\"mi\">706</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mf\">6e65</span><span class=\"w\"> </span><span class=\"mf\">6e74</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"n\">d74</span><span class=\"w\"> </span><span class=\"mi\">7970</span><span class=\"w\"> </span><span class=\"mi\">653</span><span class=\"n\">a</span><span class=\"w\">  </span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"k\">type</span>:\n<span class=\"mi\">00</span><span class=\"n\">b0f15</span>: <span class=\"mi\">686</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7374</span><span class=\"w\"> </span><span class=\"mi\">0300</span><span class=\"w\"> </span><span class=\"mi\">0468</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f73</span><span class=\"w\"> </span><span class=\"mi\">7400</span><span class=\"w\"> </span><span class=\"mi\">6173</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">d0d</span><span class=\"w\">  </span><span class=\"n\">host</span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">asm</span><span class=\"p\">.</span>\n<span class=\"mi\">00</span><span class=\"n\">b0f25</span>: <span class=\"mi\">0001</span><span class=\"w\"> </span><span class=\"mi\">0007</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"n\">d01</span><span class=\"w\"> </span><span class=\"mi\">4102</span><span class=\"w\"> </span><span class=\"mi\">0141</span><span class=\"w\"> </span><span class=\"mi\">0401</span><span class=\"w\"> </span><span class=\"mi\">4001</span><span class=\"w\"> </span><span class=\"mi\">036</span><span class=\"n\">d</span><span class=\"w\">  </span><span class=\"o\">....=</span><span class=\"p\">.</span><span class=\"n\">A</span><span class=\"o\">..</span><span class=\"n\">A</span><span class=\"o\">..@..</span><span class=\"n\">m</span>\n<span class=\"mi\">00</span><span class=\"n\">b0f35</span>: <span class=\"mi\">7367</span><span class=\"w\"> </span><span class=\"mi\">7301</span><span class=\"w\"> </span><span class=\"mi\">0003</span><span class=\"w\"> </span><span class=\"mi\">0005</span><span class=\"w\"> </span><span class=\"mi\">7072</span><span class=\"w\"> </span><span class=\"mi\">696</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">7401</span><span class=\"w\"> </span><span class=\"mi\">0001</span><span class=\"w\">  </span><span class=\"n\">sgs</span><span class=\"o\">....</span><span class=\"p\">.</span><span class=\"n\">print</span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"mi\">00</span><span class=\"n\">b0f45</span>: <span class=\"mi\">4000</span><span class=\"w\"> </span><span class=\"mi\">0100</span><span class=\"w\"> </span><span class=\"mi\">0400</span><span class=\"w\"> </span><span class=\"mi\">0372</span><span class=\"w\"> </span><span class=\"mi\">756</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">0101</span><span class=\"w\"> </span><span class=\"mi\">0401</span><span class=\"w\"> </span><span class=\"mi\">1165</span><span class=\"w\">  </span><span class=\"o\">@......</span><span class=\"n\">run</span><span class=\"o\">....</span><span class=\"p\">.</span><span class=\"n\">e</span>\n<span class=\"mi\">00</span><span class=\"n\">b0f55</span>: <span class=\"mi\">7861</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">d70</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">c65</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"n\">a68</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f73</span><span class=\"w\"> </span><span class=\"mi\">742</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">686</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7374</span><span class=\"w\">  </span><span class=\"n\">xample</span>:<span class=\"nc\">host</span><span class=\"o\">/</span><span class=\"n\">host</span>\n<span class=\"mi\">00</span><span class=\"n\">b0f65</span>: <span class=\"mi\">0400</span><span class=\"w\"> </span><span class=\"mi\">0045</span><span class=\"w\"> </span><span class=\"mi\">0970</span><span class=\"w\"> </span><span class=\"mi\">726</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6475</span><span class=\"w\"> </span><span class=\"mi\">6365</span><span class=\"w\"> </span><span class=\"mi\">7273</span><span class=\"w\"> </span><span class=\"mi\">010</span><span class=\"n\">c</span><span class=\"w\">  </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"n\">E</span><span class=\"p\">.</span><span class=\"n\">producers</span><span class=\"o\">..</span>\n<span class=\"mi\">00</span><span class=\"n\">b0f75</span>: <span class=\"mi\">7072</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f63</span><span class=\"w\"> </span><span class=\"mi\">6573</span><span class=\"w\"> </span><span class=\"mi\">7365</span><span class=\"w\"> </span><span class=\"mi\">642</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">6279</span><span class=\"w\"> </span><span class=\"mi\">020</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">7769</span><span class=\"w\">  </span><span class=\"n\">processed</span><span class=\"o\">-</span><span class=\"n\">by</span><span class=\"o\">..</span><span class=\"n\">wi</span>\n<span class=\"mi\">00</span><span class=\"n\">b0f85</span>: <span class=\"mi\">742</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">636</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">d70</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f6e</span><span class=\"w\"> </span><span class=\"mi\">656</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">7406</span><span class=\"w\"> </span><span class=\"mi\">302</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">3131</span><span class=\"w\">  </span><span class=\"n\">t</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"mf\">0.11</span>\n<span class=\"mi\">00</span><span class=\"n\">b0f95</span>: <span class=\"mf\">2e30</span><span class=\"w\"> </span><span class=\"mi\">1077</span><span class=\"w\"> </span><span class=\"mi\">6974</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"n\">d62</span><span class=\"w\"> </span><span class=\"mi\">696</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">6467</span><span class=\"w\"> </span><span class=\"mi\">656</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"n\">d72</span><span class=\"w\">  </span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"o\">-</span><span class=\"n\">r</span>\n<span class=\"mi\">00</span><span class=\"n\">b0fa5</span>: <span class=\"mi\">7573</span><span class=\"w\"> </span><span class=\"mi\">7405</span><span class=\"w\"> </span><span class=\"mi\">302</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">382</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">300</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">1601</span><span class=\"w\"> </span><span class=\"mi\">0110</span><span class=\"w\"> </span><span class=\"mi\">6578</span><span class=\"w\">  </span><span class=\"n\">ust</span><span class=\"p\">.</span><span class=\"mf\">0.8.</span><span class=\"mi\">0</span><span class=\"o\">....</span><span class=\"p\">.</span><span class=\"n\">ex</span>\n<span class=\"mi\">00</span><span class=\"n\">b0fb5</span>: <span class=\"mi\">616</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">706</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">653</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">686</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7374</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"n\">f77</span><span class=\"w\"> </span><span class=\"mi\">6974</span><span class=\"w\"> </span><span class=\"mi\">0300</span><span class=\"w\">  </span><span class=\"n\">ample</span>:<span class=\"nc\">host</span><span class=\"o\">/</span><span class=\"n\">wit</span><span class=\"p\">.</span>\n</code></pre></div>",
        "id": 374779835,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689211152
    },
    {
        "content": "<p>Will try to reuse <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/main/crates/c/src/component_type_object.rs\">https://github.com/bytecodealliance/wit-bindgen/blob/main/crates/c/src/component_type_object.rs</a>  Seems like the sensible path</p>",
        "id": 374787584,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689215451
    },
    {
        "content": "<p>a component type section contains a wasm component</p>",
        "id": 374992436,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689265774
    },
    {
        "content": "<p>so, to parse it, you need to use wasmparser again</p>",
        "id": 374993176,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689265927
    },
    {
        "content": "<p>I've produced a component section, but for this error</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"o\">&gt;</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"err\">\\</span><span class=\"n\">Release</span><span class=\"err\">\\</span><span class=\"n\">net8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"err\">\\</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"err\">\\</span><span class=\"n\">native</span><span class=\"err\">\\</span><span class=\"n\">cswasi</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">my</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">cs</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\">  </span><span class=\"o\">--</span><span class=\"n\">adapt</span><span class=\"w\"> </span><span class=\"n\">wasi_snapshot_preview1</span><span class=\"o\">=</span><span class=\"n\">c</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">rust_wit</span><span class=\"err\">\\</span><span class=\"n\">host</span><span class=\"err\">\\</span><span class=\"n\">wasi_snapshot_preview1</span><span class=\"p\">.</span><span class=\"n\">reactor</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">error</span>: <span class=\"nc\">decoding</span><span class=\"w\"> </span><span class=\"n\">custom</span><span class=\"w\"> </span><span class=\"n\">section</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"k\">type</span>:<span class=\"nc\">the</span><span class=\"o\">-</span><span class=\"n\">world</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">component</span><span class=\"o\">-</span><span class=\"k\">type</span> <span class=\"nc\">version</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">supported</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>\n<p>I suppose this is because the wasm-tools is newer than than the version specified in the custom section and I should merge the latest wit-bindgen</p>",
        "id": 375822263,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689534263
    },
    {
        "content": "<p>Looks like upgrading solved the version porblem.  I'm not sure about the naming conventions here, when i get the error</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"o\">&gt;</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"err\">\\</span><span class=\"n\">Release</span><span class=\"err\">\\</span><span class=\"n\">net8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"err\">\\</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"err\">\\</span><span class=\"n\">native</span><span class=\"err\">\\</span><span class=\"n\">cswasi</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">my</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">cs</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\">  </span><span class=\"o\">--</span><span class=\"n\">adapt</span><span class=\"w\"> </span><span class=\"n\">wasi_snapshot_preview1</span><span class=\"o\">=</span><span class=\"n\">c</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">rust_wit</span><span class=\"err\">\\</span><span class=\"n\">host</span><span class=\"err\">\\</span><span class=\"n\">wasi_snapshot_preview1</span><span class=\"p\">.</span><span class=\"n\">reactor</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">module</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">validate</span><span class=\"w\"> </span><span class=\"n\">exported</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">foo</span>:<span class=\"nc\">foo</span><span class=\"o\">/</span><span class=\"n\">floats</span><span class=\"err\">`</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">module</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">foo</span>:<span class=\"nc\">foo</span><span class=\"o\">/</span><span class=\"n\">floats</span>#<span class=\"n\">float32</span><span class=\"o\">-</span><span class=\"n\">param</span><span class=\"err\">`</span>\n</code></pre></div>\n<p>Should I have a function in my wasm module with that exact name: <code>foo:foo/floats#float32-param</code> ?</p>",
        "id": 375874404,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689562326
    },
    {
        "content": "<p>yes this is an error where a core wasm being lifted into a component doesn't export the function of that name, and that symbol (with <code>:</code> and <code>/</code> and <code>#</code>) is the name that's expected</p>",
        "id": 376046216,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1689604298
    },
    {
        "content": "<p>Many thanks, I now have a componet from C# which feels like a decent step forward.  I'm following <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6523\">https://github.com/bytecodealliance/wasmtime/issues/6523</a> for ideas and have the following error at runtime</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">     </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">github</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"o\">-</span><span class=\"n\">wasmtime</span><span class=\"err\">\\</span><span class=\"n\">target</span><span class=\"err\">\\</span><span class=\"n\">debug</span><span class=\"err\">\\</span><span class=\"n\">cs</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">example</span><span class=\"p\">.</span><span class=\"n\">exe</span><span class=\"err\">`</span>\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">main</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">cannot</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">func_wrap_async</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">without</span><span class=\"w\"> </span><span class=\"n\">enabling</span><span class=\"w\"> </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"n\">support</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span>:<span class=\"err\">\\</span><span class=\"n\">Users</span><span class=\"err\">\\</span><span class=\"n\">scott</span><span class=\"err\">\\</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"err\">\\</span><span class=\"n\">registry</span><span class=\"err\">\\</span><span class=\"n\">src</span><span class=\"err\">\\</span><span class=\"n\">index</span><span class=\"p\">.</span><span class=\"n\">crates</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"o\">-</span><span class=\"mi\">6</span><span class=\"n\">f17d22bba15001f</span><span class=\"err\">\\</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mf\">10.0.1</span><span class=\"err\">\\</span><span class=\"n\">src</span><span class=\"err\">\\</span><span class=\"n\">component</span><span class=\"err\">\\</span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">287</span>:<span class=\"mi\">9</span>\n</code></pre></div>\n<p>Is this a simple one?  Sorry I'm a rust newbie.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/6523\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/eff28184cdd3682e605928b2e939439b6308e8c8\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396161643533353031633834373233393038323331333038346265336630356231353738653864616233303136383261353062323239616237396436636331352f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f36353233)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/6523\" title=\"import `wasi:clocks/wall-clock` has the wrong type when instantiating component · Issue #6523 · bytecodealliance/wasmtime\">import `wasi:clocks/wall-clock` has the wrong type when instantiating component · Issue #6523 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Hi, I'm trying to instantiate a component compiled using tinygo from wasmtime in rust The components implements the following WIT interface package producer:host world producer-interface { export h...</div></div></div>",
        "id": 376714334,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689781786
    },
    {
        "content": "<p>in my <code>toml</code> I have</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"10.0.1\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"component-model\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"async\"</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>",
        "id": 376719135,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689782657
    },
    {
        "content": "<p>I believe you need to use <a href=\"https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.async_support\">https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.async_support</a> to fix that error.</p>",
        "id": 376722391,
        "sender_full_name": "Jamey Sharp",
        "timestamp": 1689783325
    },
    {
        "content": "<p>Thanks, that did fix it.  I missed that from the other example :-O</p>",
        "id": 376725715,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689784027
    },
    {
        "content": "<p>Feels close</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">customCtx</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">CustomCtx</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">state</span>: <span class=\"nc\">state</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">table</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"p\">};</span>\n\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span>::<span class=\"n\">preview2</span>::<span class=\"n\">wasi</span>::<span class=\"n\">command</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span>: <span class=\"nc\">Store</span><span class=\"o\">&lt;</span><span class=\"n\">CustomCtx</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span>::<span class=\"n\">new</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">customCtx</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"n\">TheWorld</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">ctx</span><span class=\"w\"> </span>: <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">CustomCtx</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"p\">.</span><span class=\"n\">state</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instantiate_async</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">()).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"_start\"</span><span class=\"p\">)).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">\"export wasnt a function\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">.</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"p\">[],</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"p\">[])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"w\">        </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">trap</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"fm\">panic!</span><span class=\"p\">(</span><span class=\"s\">\"execution of _start failed {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>complains</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">[</span><span class=\"n\">E0382</span><span class=\"p\">]</span>: <span class=\"nc\">borrow</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">moved</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"err\">`</span><span class=\"n\">store</span><span class=\"err\">`</span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">src</span><span class=\"err\">\\</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">91</span>:<span class=\"mi\">22</span>\n<span class=\"w\">   </span><span class=\"o\">|</span>\n<span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span>: <span class=\"nc\">Store</span><span class=\"o\">&lt;</span><span class=\"n\">CustomCtx</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span>::<span class=\"n\">new</span><span class=\"p\">(</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"o\">---------</span><span class=\"w\"> </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"n\">occurs</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">store</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"err\">`</span><span class=\"n\">Store</span><span class=\"o\">&lt;</span><span class=\"n\">CustomCtx</span><span class=\"o\">&gt;</span><span class=\"err\">`</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">implement</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Copy</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"k\">trait</span>\n<span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"_start\"</span><span class=\"p\">)).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">\"export wasnt a function\"</span><span class=\"p\">);</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">                                             </span><span class=\"o\">-----</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">moved</span><span class=\"w\"> </span><span class=\"n\">here</span>\n<span class=\"mi\">90</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"mi\">91</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">.</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"p\">[],</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"p\">[])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">                      </span><span class=\"o\">^^^^^^^^^^</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">borrowed</span><span class=\"w\"> </span><span class=\"n\">here</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"k\">move</span>\n</code></pre></div>\n<p>Have a got something wrong with the store creation?</p>",
        "id": 376729600,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689784850
    },
    {
        "content": "<p>nvm more RTFM required between keyboard and chair</p>",
        "id": 376730796,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689785094
    },
    {
        "content": "<p>Can <code>WasiCtxBuilder</code> and <code>inherit_stdout</code> be used to make <code>printf</code> out put to stdout from <code>cargo run</code>? <br>\n I'm trying to do some low level debugging</p>",
        "id": 377113283,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689887770
    },
    {
        "content": "<p>Currently my printfs seems to go nowhere</p>",
        "id": 377113484,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689887832
    },
    {
        "content": "<p>Maybe a simpler question is in order.  If my component includes static global c++ constructors e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"nc\">InitializeRuntimePointerHelper</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">InitializeRuntimePointerHelper</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">RhSetRuntimeInitializationCallback</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">InitializeRuntime</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">initializeRuntimePointerHelper</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>Is wasmtime going to run them ?</p>",
        "id": 377116485,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689888856
    },
    {
        "content": "<p>I'm guessing it wont.  So I'm trying to initialize things myself by calling <code>__wasm_call_ctors</code> which is a function that I've exported before creating the component:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"__wasm_call_ctors\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$__wasm_call_ctors</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>However from rust</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bindings</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TheWorld</span>::<span class=\"n\">instantiate_async</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">component</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">linker</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">init_func</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"__wasm_call_ctors\"</span><span class=\"p\">).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">\"__wasm_call_ctors not found\"</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>panics</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">main</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"nb\">__</span><span class=\"na\">wasm_call_ctors</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"err\">\\</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">105</span>:<span class=\"mi\">72</span>\n</code></pre></div>\n<p>Is this possible or is <code>wasm-tools component new</code> going to remove my exports?</p>",
        "id": 377122713,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689891051
    },
    {
        "content": "<p>wasm and ctors is a sticky subject. when we last were having problems with it, here is where i wrote up everything i was able to learn from talking to joel, dan, and others <a href=\"https://github.com/bytecodealliance/preview2-prototyping/issues/99\">https://github.com/bytecodealliance/preview2-prototyping/issues/99</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/preview2-prototyping/issues/99\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/65d2c7c142cc9263b0fa7e7c85d5e770e56e4f54\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326535623563633934316636663531633065336561633932643161353863656538333238363361346433303762333965303631323533363831666365666430382f62797465636f6465616c6c69616e63652f70726576696577322d70726f746f747970696e672f6973737565732f3939)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/preview2-prototyping/issues/99\" title=\"Tooling issue: Components and Constructors · Issue #99 · bytecodealliance/preview2-prototyping\">Tooling issue: Components and Constructors · Issue #99 · bytecodealliance/preview2-prototyping</a></div><div class=\"message_embed_description\">Components and Constructors Pat Hickey, 28 Feb 2023 Presently, there are some major problems using C/C++ constructors (ctors) with the component model. Rust and C/C++ guests need to define a cabi_r...</div></div></div>",
        "id": 377135032,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897087
    },
    {
        "content": "<p><code> preview 1 adapter short-circuits import function calls in ctors</code> this fix is done but it isnt actually relevant to you i dont think</p>",
        "id": 377135143,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897134
    },
    {
        "content": "<p><code>guest bindgen behavior eliminates ctor calls in cabi_realloc</code> this change was done in the rust bindgen. if you're using a c bindgen, you may need to do it yourself.</p>",
        "id": 377135184,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897164
    },
    {
        "content": "<p>wasi-libc still uses ctors, and the long-term goal of straitening out the whole ctors story by way of tool-conventions and canonical ABI support is kicked off but nowhere near done afaik</p>",
        "id": 377135261,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897220
    },
    {
        "content": "<p>the simpler question might be what happens with your printfs. WasiCtxBuilder by default will not do anything with the stdout and stderr coming from your wasi program. if you <code>inherit_stdout</code> and <code>inherit_stderr</code> it will forward them to your host process's stdout and stderr.</p>",
        "id": 377135368,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897298
    },
    {
        "content": "<p>so please do give that a try</p>",
        "id": 377135384,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897304
    },
    {
        "content": "<p>the behavior you're seeing with <code>export \"__wasm_call_ctors\"</code> being inside your component, but not available via instance.get_func, is that the export you are seeing is actually a core wasm module export</p>",
        "id": 377135524,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897417
    },
    {
        "content": "<p>core wasm modules are present inside components, but only functions that are part of your wit definition's exports will get turned into component exports.</p>",
        "id": 377135588,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897452
    },
    {
        "content": "<p>the core wasm modules and their exports inside a component are totally opaque, so you'll never be able to call __wasm_call_ctors from the wasmtime component apis.</p>",
        "id": 377135684,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689897494
    },
    {
        "content": "<p>Thanks. So it seems that if I want <code>__wasm_call_ctors</code> to be called I'm going to have to do it myself, which might be possible - I'll need to try a few things.  Regards the printf, I'll take a closer look at what I've done.</p>",
        "id": 377157738,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689906739
    },
    {
        "content": "<p>not quite - if you dont ever call __wasm_call_ctors yourself, lld will put calls to it in on each export function from your module</p>",
        "id": 377442210,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689979048
    },
    {
        "content": "<p>if you use __wasm_call_ctors even once in your code, then lld will not have that behavior</p>",
        "id": 377442239,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689979067
    },
    {
        "content": "<p>we suggest you invoke them manually so that it does not get inserted by lld before the invocation of cabi_realloc.</p>",
        "id": 377442360,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689979121
    },
    {
        "content": "<p>because during calls into cabi_realloc, the component is not allowed to call any export functions, and sometimes ctors can call export functions (e.g. the ctors in wasi-libc may end up initializing the env variables, for older wasi-libcs)</p>",
        "id": 377442436,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689979168
    },
    {
        "content": "<p>hope that makes sense. like i said before, the ctors story is tricky :)</p>",
        "id": 377442549,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1689979221
    },
    {
        "content": "<p>Yes, thanks that does makes sense.  I seem to have <code>_start</code> which is stopping lld inserting the calls, I must have invoked <code>lld</code> badly.  If the only exports I have are those from the wit, I suppose I'll have to do it via a wit export</p>",
        "id": 377447748,
        "sender_full_name": "Scott Waye",
        "timestamp": 1689981772
    },
    {
        "content": "<p><a href=\"https://github.com/WebAssembly/wasi-sdk/issues/110#issuecomment-1185582357\">https://github.com/WebAssembly/wasi-sdk/issues/110#issuecomment-1185582357</a> I'll give this a try.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-sdk/issues/110#issuecomment-1185582357\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/c51e5557697ccc3b20349df90f631dc59116ccfe\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623162306437356230663464303532366461346334626134623931343230666330646165343033633739323264306437646630393534613465646363663963372f576562417373656d626c792f776173692d73646b2f6973737565732f313130)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-sdk/issues/110#issuecomment-1185582357\" title=\"Question: The correct way to compile without main function · Issue #110 · WebAssembly/wasi-sdk\">Question: The correct way to compile without main function · Issue #110 · WebAssembly/wasi-sdk</a></div><div class=\"message_embed_description\">Hi guys, I would like to create a WASM file from the following C file: int total_count = 0; // Modules can have state int count() { return ++total_count; } // They can do work int add(int a, int b)...</div></div></div>",
        "id": 377609506,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690034493
    },
    {
        "content": "<p>Is <code>_initialize</code> executed by reactor components after instansiation ?</p>",
        "id": 377641753,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690043355
    },
    {
        "content": "<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasmtime/src/linker.rs\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasmtime/src/linker.rs</a> looks like it should</p>",
        "id": 377649542,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690045878
    },
    {
        "content": "<p>What I'e found is that <code>_initialize</code> would work and be called if it was exported but it is not.   Maybe while there appears to be no solution at present I can fork wasm-tools and change <code>component new</code> to re-export.</p>",
        "id": 377672846,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690055786
    },
    {
        "content": "<p>I have a workaround for <code>_intiialize</code> and I have got so far as the host calling the component.  Now I want to call back to the host from the component, but I don't know what the wasm symbol should be for the instantiation to link the component back to the host.  I.e. <code>float32_param</code> here</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">foo</span>::<span class=\"n\">foo</span>::<span class=\"n\">floats</span>::<span class=\"n\">Host</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi</span>::<span class=\"n\">preview2</span>::<span class=\"p\">{</span><span class=\"n\">WasiCtx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Table</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiView</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiCtxBuilder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">};</span>\n\n<span class=\"n\">bindgen</span><span class=\"o\">!</span><span class=\"p\">({</span><span class=\"n\">world</span>:<span class=\"s\">\"the-world\"</span><span class=\"p\">,</span><span class=\"k\">async</span>: <span class=\"nc\">true</span><span class=\"p\">});</span>\n\n<span class=\"k\">struct</span> <span class=\"nc\">MyCtx</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"c1\">// Imports into the world, like the `name` import for this world, are satisfied</span>\n<span class=\"c1\">// through traits.</span>\n<span class=\"cp\">#[async_trait]</span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyCtx</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Note the `Result` return value here where `Ok` is returned back to</span>\n<span class=\"w\">    </span><span class=\"c1\">// the component and `Err` will raise a trap.S</span>\n<span class=\"w\">    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">float32_param</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"n\">x</span>:<span class=\"kt\">f32</span><span class=\"p\">,)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">wasmtime</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Hello from rust {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div>",
        "id": 377721578,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690081256
    },
    {
        "content": "<p>Something that is not clear to me from <a href=\"#narrow/stream/217126-wasmtime/topic/component.20Linker.20and.20instantiate/near/376046216\">https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/component.20Linker.20and.20instantiate/near/376046216</a> is if a world imports and exports the same interface how are the import names differentiated from the export names in the module before conversion to a component?</p>",
        "id": 377873191,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690128791
    },
    {
        "content": "<p>Components cannot import and export the same name</p>",
        "id": 377878146,
        "sender_full_name": "Lann Martin",
        "timestamp": 1690130266
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 377878317,
        "sender_full_name": "Lann Martin",
        "timestamp": 1690130314
    },
    {
        "content": "<blockquote>\n<p>Kebab names are required to be unique between all the imports and exports in a single component definition, component type or instance type, so that a single kebab-name uniquely identifies one import or export.</p>\n</blockquote>",
        "id": 377878684,
        "sender_full_name": "Lann Martin",
        "timestamp": 1690130426
    },
    {
        "content": "<p>(<a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#import-and-export-definitions\">https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#import-and-export-definitions</a>)</p>",
        "id": 377878745,
        "sender_full_name": "Lann Martin",
        "timestamp": 1690130443
    },
    {
        "content": "<p>But it's valid to import and export the same interface like <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/main/tests/codegen/floats.wit\">https://github.com/bytecodealliance/wit-bindgen/blob/main/tests/codegen/floats.wit</a> isn't it?</p>",
        "id": 377921578,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690142216
    },
    {
        "content": "<p>These are not kebab names as I understand it</p>",
        "id": 377921714,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690142272
    },
    {
        "content": "<p>the _initialize logic you see is in wasmtimes core wasm module linker, but support for that is not part of the component model</p>",
        "id": 377974619,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1690168113
    },
    {
        "content": "<p>if you need to call a function to initialize your component, you'll need to add a function for that as an export in your component's world. it will need a kebab-name so you cant call it _initialize, but plain initialize should work</p>",
        "id": 377974790,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1690168189
    },
    {
        "content": "<p>for your component to be able to call into the trait defined by bindgen, you need to use the <code>add_to_linker(&amp;mut wasmtime::component::Linker, ...)</code> function that is created by bindgen. it will be in the same rust module as the Host trait is defined.</p>",
        "id": 377975012,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1690168286
    },
    {
        "content": "<p>Thanks, for the .Net CoreCLR runtime, that approach would be complicated as the transition from unmanaged to managed code (which occurs on a WIT call to .Net) expects the runtime to already be initialised so it's a bit of a chicken and egg.  I can implement something in the runtime to get round this utilizing the fact that webassembly memory content is zero bytes upon creation.</p>",
        "id": 378148390,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690206294
    },
    {
        "content": "<p>I think I see how <code>wit-bindgen</code> is doing the import and export of the same interface.  It prefixes the exports with <code>exports</code>resolving the conflicts (if there was a moduled named <code>exports_foo</code>, that might be a problem I suppose, not sure about the mangling rules:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"c1\">// Imported Functions from `foo:foo/floats`</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">foo_foo_floats_float32_param</span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">);</span>\n\n<span class=\"c1\">// Exported Functions from `foo:foo/floats`</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">exports_foo_foo_floats_float32_param</span><span class=\"p\">(</span><span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">);</span>\n</code></pre></div>",
        "id": 378983580,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690424874
    },
    {
        "content": "<p>Thanks all who commented to my wanderings here, I have it working now so can continue on wit-&gt;c#.</p>",
        "id": 379934660,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690691640
    },
    {
        "content": "<p>I can't close this due to it being &gt; 7 days old, but please can a moderator close it?  THanks</p>",
        "id": 379934718,
        "sender_full_name": "Scott Waye",
        "timestamp": 1690691681
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"234973\">Till Schneidereit</span> has marked this topic as resolved.</p>",
        "id": 380006672,
        "sender_full_name": "Notification Bot",
        "timestamp": 1690716994
    }
]