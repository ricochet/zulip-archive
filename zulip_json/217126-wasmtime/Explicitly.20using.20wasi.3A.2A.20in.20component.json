[
    {
        "content": "<p>I am trying to export a wasi-http incoming-handler from my component. I have copied Wasmtime's version of the WASI wit files into a <code>deps/</code> directory alongside the definition of my world (in both the guest and host crates), and that seems to be enough to make <code>cargo-component</code> happy (able to resolve references to WASI stuff). However, the Wasmtime side of things using <code>component::bindgen!</code> is not so happy:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span>:<span class=\"nc\">http</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">deps</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"w\">            </span><span class=\"o\">-</span>-&gt; <span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">jeff</span><span class=\"o\">/</span><span class=\"n\">aaa</span><span class=\"o\">/</span><span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">job</span><span class=\"o\">-</span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">wit</span>:<span class=\"mi\">7</span>:<span class=\"mi\">12</span>\n<span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"w\">           </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">wasi</span>:<span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">incoming</span><span class=\"o\">-</span><span class=\"n\">handler</span>\n<span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"o\">^--------</span>\n<span class=\"w\"> </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">src</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">7</span>:<span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span>::<span class=\"n\">component</span>::<span class=\"n\">bindgen</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"job-server\"</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"s\">\"wit/deps\"</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>\n<span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">this</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">originates</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"kr\">macro</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasmtime</span>::<span class=\"n\">component</span>::<span class=\"n\">bindgen</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">Nightly</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"kr\">macro</span><span class=\"o\">-</span><span class=\"n\">backtrace</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>I can't find any options on the <code>component::bindgen!</code> macro to tell it how to resolve dependencies referenced in my world definition.</p>\n<p>Here is my component world:</p>\n<div class=\"codehilite\" data-code-language=\"wit\"><pre><span></span><code>package jeffparsons:job-server\n\nworld job-server {\n    export hello-world: func() -&gt; string\n\n    export wasi:http/incoming-handler\n}\n</code></pre></div>\n<p>And here's what my host's <code>wit/</code> dir looks like:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">Projects</span><span class=\"o\">/</span><span class=\"n\">aaa</span><span class=\"w\"> </span><span class=\"n\">took</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"n\">s</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">filesystem</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">filesystem</span><span class=\"o\">/</span><span class=\"n\">world</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">filesystem</span><span class=\"o\">/</span><span class=\"n\">types</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">filesystem</span><span class=\"o\">/</span><span class=\"n\">preopens</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">logging</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">logging</span><span class=\"o\">/</span><span class=\"n\">logging</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">clocks</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">clocks</span><span class=\"o\">/</span><span class=\"n\">timezone</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">clocks</span><span class=\"o\">/</span><span class=\"n\">monotonic</span><span class=\"o\">-</span><span class=\"n\">clock</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">clocks</span><span class=\"o\">/</span><span class=\"n\">wall</span><span class=\"o\">-</span><span class=\"n\">clock</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">io</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">io</span><span class=\"o\">/</span><span class=\"n\">streams</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">poll</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">poll</span><span class=\"o\">/</span><span class=\"n\">poll</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">random</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">random</span><span class=\"o\">/</span><span class=\"n\">insecure</span><span class=\"o\">-</span><span class=\"n\">seed</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">random</span><span class=\"o\">/</span><span class=\"n\">insecure</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">random</span><span class=\"o\">/</span><span class=\"n\">random</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">cli</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">cli</span><span class=\"o\">/</span><span class=\"n\">command</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">cli</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">cli</span><span class=\"o\">/</span><span class=\"n\">stdio</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">cli</span><span class=\"o\">/</span><span class=\"n\">terminal</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">cli</span><span class=\"o\">/</span><span class=\"n\">reactor</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">cli</span><span class=\"o\">/</span><span class=\"n\">environment</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">cli</span><span class=\"o\">/</span><span class=\"n\">exit</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">http</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">proxy</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">types</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">incoming</span><span class=\"o\">-</span><span class=\"n\">handler</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">outgoing</span><span class=\"o\">-</span><span class=\"n\">handler</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">sockets</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">sockets</span><span class=\"o\">/</span><span class=\"n\">tcp</span><span class=\"o\">-</span><span class=\"n\">create</span><span class=\"o\">-</span><span class=\"n\">socket</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">sockets</span><span class=\"o\">/</span><span class=\"n\">udp</span><span class=\"o\">-</span><span class=\"n\">create</span><span class=\"o\">-</span><span class=\"n\">socket</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">sockets</span><span class=\"o\">/</span><span class=\"n\">ip</span><span class=\"o\">-</span><span class=\"n\">name</span><span class=\"o\">-</span><span class=\"n\">lookup</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">sockets</span><span class=\"o\">/</span><span class=\"n\">tcp</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">sockets</span><span class=\"o\">/</span><span class=\"n\">udp</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">sockets</span><span class=\"o\">/</span><span class=\"n\">network</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">sockets</span><span class=\"o\">/</span><span class=\"n\">instance</span><span class=\"o\">-</span><span class=\"n\">network</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">job</span><span class=\"o\">-</span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n</code></pre></div>\n<p>Is this something that is meant to be possible (yet)? Hopefully I've just missed something simple!</p>\n<p>From my <code>Cargo.lock</code>:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[[package]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"wasmtime\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"13.0.0\"</span>\n<span class=\"n\">source</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"git+https://github.com/bytecodealliance/wasmtime.git?branch=release-13.0.0#d57fc24b5370e05697d718ff1e8412acd04e7bc4\"</span>\n</code></pre></div>\n<p>Thanks! <span aria-label=\"bow\" class=\"emoji emoji-1f647\" role=\"img\" title=\"bow\">:bow:</span> </p>\n<p>(P.S. I'm not sure if this is the right venue for these sorts of end-user questions — please point me in the right direction if not!)</p>",
        "id": 391783733,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1695075384
    },
    {
        "content": "<p>this is a totally fine venue for these questions</p>",
        "id": 391784013,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1695075513
    },
    {
        "content": "<p>i think you just need to move the contents of wit/deps/wasi to wit/deps</p>",
        "id": 391784043,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1695075525
    },
    {
        "content": "<p>Thanks! I eventually got this working by structuring my <code>wit/</code> dir like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">job</span><span class=\"o\">-</span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">filesystem</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">filesystem</span><span class=\"o\">/</span><span class=\"n\">world</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n</code></pre></div>\n<p>And invoking the <code>bindgen!</code> macro like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span>::<span class=\"n\">component</span>::<span class=\"n\">bindgen</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"jeffparsons:job-server/job-server\"</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>I think my mental model of how it would be looking for <code>*.wit</code> files was just wrong; I expected it to be looking for files from some common root, rather than always looking for dependencies beneath a <code>deps/</code> directory as a sibling of the package you're generating bindings for.</p>\n<p>I've started using <code>wit-deps</code> to manage this dir, so in practice the <code>wit/job-server.wit</code> listed above is actually a symlink to <code>wit/deps/job-server/world.wit</code>. It feels a bit weird, but it works!!</p>",
        "id": 391838478,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1695104720
    }
]