[
    {
        "content": "<p>Hi, I'm new to components and am trying to figure out returning a user defined type from the guest to host (Rust). My goal is to use the component for building different data source connectors for use in production. Now if the guest returns a string, everything works (using cargo component); but if I try to return a simple Record type, I get the below error at run time. Could you please help? If you could also point me to some educational material, I'd appreciate it! The one I'm looking at now is <a href=\"https://component-model.bytecodealliance.org/\">https://component-model.bytecodealliance.org/</a>. Thanks.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Error</span>: <span class=\"nc\">import</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span>:<span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">environment</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">wrong</span><span class=\"w\"> </span><span class=\"k\">type</span>\n\n<span class=\"nc\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">instance</span><span class=\"w\"> </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">get</span><span class=\"o\">-</span><span class=\"n\">environment</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">wrong</span><span class=\"w\"> </span><span class=\"k\">type</span>\n    <span class=\"mi\">1</span>: <span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">nothing</span>\n</code></pre></div>",
        "id": 429999797,
        "sender_full_name": "Sekhar Ravinutala",
        "timestamp": 1711604220
    },
    {
        "content": "<p>This error (which hopefully will be improved in the next version of wasmtime) indicates that the your component imports <code>wasi:cli/environment#get-environment</code> but the host (or more specifically the linker used by the host) does not have an implementation for that import.</p>\n<p>This error happens when the linker is not configured properly. If you're component is targeting the <code>wasi:cli/command</code> world (which is the case often by default for many toolchains) I imagine you're missing the following line somewhere:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime_wasi</span>::<span class=\"n\">command</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>This configures the linker properly to handle that world.</p>",
        "id": 430019528,
        "sender_full_name": "Ryan Levick (rylev)",
        "timestamp": 1711615344
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"590805\">@Ryan Levick (rylev)</span>! I tried doing that and ran into a number of issues. First, it wanted my component to implement WasiView (bound apparently needed to add to linker), which I did. Then it wanted implementation to be async, which I tried doing (add async support to engine, implement instantiation and call functions as they weren't generated for async, etc.) but am just getting deeper into a rabbit hole that I feel is misguided. All I want to do is just return a user defined type to the host, would you have an example or a pointer to docs that I can follow. I don't need async for this, right? Sorry for the newbie questions.</p>",
        "id": 430099995,
        "sender_full_name": "Sekhar Ravinutala",
        "timestamp": 1711640830
    },
    {
        "content": "<p>Update: I noticed that there is a sync version for command, adding the below instead kept it sync and gave me the results. Whew, basically what you said, but with the sync option. Thanks again.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime_wasi</span>::<span class=\"n\">command</span>::<span class=\"n\">sync</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>",
        "id": 430118284,
        "sender_full_name": "Sekhar Ravinutala",
        "timestamp": 1711644669
    }
]