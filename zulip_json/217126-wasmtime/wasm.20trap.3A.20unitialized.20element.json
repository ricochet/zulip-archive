[
    {
        "content": "<p>Hi!<br>\nI'm trying to port a kind of big projet (llama.cpp) to WASI. I have managed to compile a wasm binary after patching some stuff,  but when it comes to run it with wasmtime, I'm getting this error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">base</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">jgomez</span><span class=\"o\">@</span><span class=\"n\">DESKTOP</span><span class=\"o\">-</span><span class=\"n\">ANTLE2E</span>:<span class=\"o\">~/</span><span class=\"n\">llama</span><span class=\"p\">.</span><span class=\"n\">cpp</span><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">features</span><span class=\"o\">=</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">modules</span><span class=\"o\">=</span><span class=\"n\">experimental</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\">  </span><span class=\"o\">--</span><span class=\"n\">listenfd</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">dir</span><span class=\"o\">=</span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"w\">  </span><span class=\"n\">llama</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">wiz</span>\n<span class=\"n\">ardcoder</span><span class=\"o\">-</span><span class=\"n\">python</span><span class=\"o\">-</span><span class=\"mi\">34</span><span class=\"n\">b</span><span class=\"o\">-</span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">Q3_K_M</span><span class=\"p\">.</span><span class=\"n\">gguf</span>\n<span class=\"n\">Log</span><span class=\"w\"> </span><span class=\"n\">start</span>\n<span class=\"n\">main</span>: <span class=\"nc\">warning</span>: <span class=\"nc\">changing</span><span class=\"w\"> </span><span class=\"n\">RoPE</span><span class=\"w\"> </span><span class=\"n\">frequency</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"mf\">10000.0</span><span class=\"p\">)</span>\n<span class=\"n\">main</span>: <span class=\"nc\">warning</span>: <span class=\"nc\">scaling</span><span class=\"w\"> </span><span class=\"n\">RoPE</span><span class=\"w\"> </span><span class=\"n\">frequency</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"p\">)</span>\n<span class=\"n\">main</span>: <span class=\"nc\">build</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1274</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ffe88a3</span><span class=\"p\">)</span>\n<span class=\"n\">main</span>: <span class=\"nc\">built</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">16.0.0</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">wasi</span>\n<span class=\"n\">main</span>: <span class=\"nc\">seed</span><span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1696600350</span>\n<span class=\"n\">Error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">llama</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">invoke</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">default</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n           <span class=\"mi\">0</span>: <span class=\"mh\">0x7790c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">__fseeko</span>\n<span class=\"w\">           </span><span class=\"mi\">1</span>: <span class=\"mh\">0x7794f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">fseek</span>\n<span class=\"w\">           </span><span class=\"mi\">2</span>: <span class=\"mh\">0xfa37b</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">llama_file</span>::<span class=\"n\">llama_file</span><span class=\"p\">(</span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"mi\">3</span>: <span class=\"mh\">0x9ea93</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">llama_model_loader</span>::<span class=\"n\">llama_model_loader</span><span class=\"p\">(</span><span class=\"n\">std</span>::<span class=\"n\">__2</span>::<span class=\"n\">basic_string</span><span class=\"o\">&lt;</span><span class=\"kt\">char</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">__2</span>::<span class=\"n\">char_traits</span><span class=\"o\">&lt;</span><span class=\"kt\">char</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">__2</span>::<span class=\"n\">allocator</span><span class=\"o\">&lt;</span><span class=\"kt\">char</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"o\">&amp;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"mi\">4</span>: <span class=\"mh\">0x9a9b0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">llama_load_model_from_file</span>\n<span class=\"w\">           </span><span class=\"mi\">5</span>: <span class=\"mh\">0x878be</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">main</span>\n<span class=\"w\">           </span><span class=\"mi\">6</span>: <span class=\"mh\">0x734b8</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">__main_void</span>\n<span class=\"w\">           </span><span class=\"mi\">7</span>: <span class=\"mh\">0x1482</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">_start</span>\n<span class=\"w\">       </span><span class=\"n\">note</span>: <span class=\"nc\">using</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"n\">variable</span><span class=\"w\"> </span><span class=\"n\">may</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">debugging</span><span class=\"w\"> </span><span class=\"n\">information</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span>: <span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"n\">trap</span>: <span class=\"nc\">uninitialized</span><span class=\"w\"> </span><span class=\"n\">element</span>\n</code></pre></div>\n<p>If I run in debug mode (using the <code>-g</code> flag, as the <code>-D debug-info</code> is not recognized) I'm getting this error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">main</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">assertion</span><span class=\"w\"> </span><span class=\"n\">failed</span>: <span class=\"err\">`</span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"p\">)</span><span class=\"err\">`</span>\n<span class=\"w\">  </span><span class=\"n\">left</span>: <span class=\"err\">`</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"p\">,</span>\n<span class=\"w\"> </span><span class=\"n\">right</span>: <span class=\"err\">`</span><span class=\"mi\">0</span><span class=\"err\">`</span>: <span class=\"nc\">the</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"n\">pointer</span><span class=\"w\"> </span><span class=\"n\">may</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">incorrect</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">sharing</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">564</span>:<span class=\"mi\">13</span>\n<span class=\"n\">note</span>: <span class=\"nc\">run</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">RUST_BACKTRACE</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"n\">variable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>\n</code></pre></div>\n<p>gdb is telling me:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Thread</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"s\">\"wasmtime\"</span><span class=\"w\"> </span><span class=\"n\">received</span><span class=\"w\"> </span><span class=\"n\">signal</span><span class=\"w\"> </span><span class=\"n\">SIGILL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Illegal</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"p\">.</span>\n<span class=\"mh\">0x00007ffff749e08f</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">??</span><span class=\"w\"> </span><span class=\"p\">()</span>\n<span class=\"p\">(</span><span class=\"n\">gdb</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">bt</span>\n#<span class=\"mi\">0</span><span class=\"w\">  </span><span class=\"mh\">0x00007ffff749e08f</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">??</span><span class=\"w\"> </span><span class=\"p\">()</span>\n#<span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"mh\">0x0000000000000000</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">??</span><span class=\"w\"> </span><span class=\"p\">()</span>\n</code></pre></div>\n<p>... which is not very informative. <br>\nI guess it is relevant to mention that I'm using <code>wasi-threads</code> (it's obvious from the  args passed to wasmtime, though :))<br>\nAny pointer on how to move forward? It'll be great if there's a way I can see what illegal instruction is actually causing this.<br>\nThanks!!!</p>",
        "id": 395285727,
        "sender_full_name": "Juan Gómez",
        "timestamp": 1696606855
    },
    {
        "content": "<p>If I inspect the core file emitted after the trap with wasmgdb, I get this other error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">implemented</span>: <span class=\"nc\">value</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 395288832,
        "sender_full_name": "Juan Gómez",
        "timestamp": 1696607882
    },
    {
        "content": "<p>Ok, this looks like an error of wasmgdb itself (wasm-parser?):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">base</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">jgomez</span><span class=\"o\">@</span><span class=\"n\">DESKTOP</span><span class=\"o\">-</span><span class=\"n\">ANTLE2E</span>:<span class=\"o\">~/</span><span class=\"n\">llama</span><span class=\"p\">.</span><span class=\"n\">cpp</span><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmgdb</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">file</span>\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">main</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">not</span><span class=\"w\"> </span><span class=\"n\">implemented</span>: <span class=\"nc\">value</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">jgomez</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">registry</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">index</span><span class=\"p\">.</span><span class=\"n\">crates</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"o\">-</span><span class=\"mi\">6</span><span class=\"n\">f17d22bba15001f</span><span class=\"o\">/</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">parser</span><span class=\"o\">-</span><span class=\"mf\">0.1.22</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">coredump</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">100</span>:<span class=\"mi\">17</span>\n</code></pre></div>",
        "id": 395289975,
        "sender_full_name": "Juan Gómez",
        "timestamp": 1696608229
    },
    {
        "content": "<p>To set expectations a bit, the wasm threads proposal is still pretty green-field in wasmtime and it's not a well-trodden path, things shouldn't be expected to all work with the threads proposal. For example the <code>-g</code> flag seems like it doesn't support shared memory, which isn't all that surprising. I don't know what <code>not implemented: value type 0</code> refers to, but <code>wasmgdb</code> is not a project I am familiar with.</p>\n<p>All that being said you probably don't need gdb here, or even if you could get it working it may not help a whole lot. I'd recommend setting <code>WASMTIME_BACKTRACE_DETAILS=1</code> to try to get line numbers in your backtrace. You could then take a look at the source of the <code>__fseeko</code> function ot see why it's possibly trapping.</p>\n<p>At a high level though you're likely running into one of the limitations of the current implementation of threads which is that each thread's function table can get out of sync. I'm not sure if you're explicitly adding to the function table or if the module itself is modifying its function table, but modifications in one thread will not reach other threads. If you've only got one thread in your program though then this wouldn't be the issue.</p>\n<p>The trap here itself is akin to calling the null function pointer in native code. This may also indicate it's simply a bug in the original source program. I'd recommend taking a look at <code>__fseeko</code> and working backwards from there to figure out why the indirect function call is calling null (or trapping)</p>",
        "id": 395296868,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1696610786
    },
    {
        "content": "<p>Thanks Alex, that makes a lot of sense. Gonna focus in the  __fseeko stuff and see where I can get from there :)</p>",
        "id": 395302595,
        "sender_full_name": "Juan Gómez",
        "timestamp": 1696613349
    },
    {
        "content": "<p>I should also mention, one possible culprit is that <code>--dir /</code> and <code>--tcplisten</code><a href=\"https://github.com/bytecodealliance/wasmtime/issues/3936\">don't work together</a>, so this may be fixable by dropping <code>--tcplisten</code>. If you need TCP, however, that's something to fix on Wasmtime's side</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/3936\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/9925c5fa53f1683d6ec52ae0751240fd27ece309\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343934323936303736333764623139376463646336373137633563663433353637643936333336643033623361316434343761653333386233323965636161332f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f33393336)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/3936\" title=\"In wasmtime CLI, passing --tcplisten argument breaks --dir · Issue #3936 · bytecodealliance/wasmtime\">In wasmtime CLI, passing --tcplisten argument breaks --dir · Issue #3936 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Test Case testcase.zip Steps to Reproduce Extract main.wasm from the test case zip file. Or compile it yourself using WASI SDK and the following source code, e.g. via ~/wasi-sdk/bin/clang main.c --...</div></div></div>",
        "id": 395304204,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1696614105
    }
]