[
    {
        "content": "<p>I have <a href=\"https://github.com/brettcannon/cpython-wasi-build/releases/tag/v3.12.0\">compiled CPython using the WASI SDK with threading support</a>, but I'm getting an error when trying to run under wasmtime that I don't get from a non-threaded build and  I'm not sure how to solve it:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"err\">❯</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">modules</span><span class=\"w\"> </span><span class=\"n\">experimental</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">mapdir</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">tmp</span>::<span class=\"o\">/</span><span class=\"n\">tmp</span><span class=\"w\"> </span><span class=\"n\">python</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">python</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">invoke</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">default</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n           <span class=\"mi\">0</span>: <span class=\"mh\">0x394497</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">__wasi_clock_time_get</span>\n<span class=\"w\">           </span><span class=\"mi\">1</span>: <span class=\"mh\">0x34d8af</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">init</span>\n<span class=\"w\">           </span><span class=\"mi\">2</span>: <span class=\"mh\">0x544e</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">__wasm_call_ctors</span>\n<span class=\"w\">           </span><span class=\"mi\">3</span>: <span class=\"mh\">0x5513</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">_start</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span>: <span class=\"nc\">missing</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">export</span>\n</code></pre></div>\n<p>I feel like I'm missing a flag or something (either for wasmtime or WASI SDK), but I can't figure out what other flag to try or what could be causing this as everything <a href=\"https://github.com/brettcannon/cpython-wasi-build/actions/runs/6411555476/job/17407245080\">compiles fine</a>. And as I said, everything works fine in a non-threaded build, so this seems specific to that.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/brettcannon/cpython-wasi-build/releases/tag/v3.12.0\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/29e91fd77213fb5a5fb9b5fab044bb42ae50c0a5\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f336238643861613138313264653765323965356334356265306565623865353565303134616434376531626435373431623066313235376230353536666530322f627265747463616e6e6f6e2f63707974686f6e2d776173692d6275696c642f72656c65617365732f7461672f76332e31322e30)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/brettcannon/cpython-wasi-build/releases/tag/v3.12.0\" title=\"Release CPython 3.12.0 w/ WASI SDK 20 · brettcannon/cpython-wasi-build\">Release CPython 3.12.0 w/ WASI SDK 20 · brettcannon/cpython-wasi-build</a></div><div class=\"message_embed_description\">Unofficial WASI builds of CPython. Contribute to brettcannon/cpython-wasi-build development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/brettcannon/cpython-wasi-build/actions/runs/6411555476/job/17407245080\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/d29ffdec9ddb3d21ba57e0acc200b9ce15076301\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616365353437336132346438303036626637336366396233623134323264353338643834306532653139356534633830653766623038306636336334666666662f627265747463616e6e6f6e2f63707974686f6e2d776173692d6275696c64)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/brettcannon/cpython-wasi-build/actions/runs/6411555476/job/17407245080\" title=\"Create release · brettcannon/cpython-wasi-build@daf2e16\">Create release · brettcannon/cpython-wasi-build@daf2e16</a></div><div class=\"message_embed_description\">Unofficial WASI builds of CPython. Contribute to brettcannon/cpython-wasi-build development by creating an account on GitHub.</div></div></div>",
        "id": 397359617,
        "sender_full_name": "Brett Cannon",
        "timestamp": 1697651390
    },
    {
        "content": "<p>I think you'll want <code>-Wl,--export-memory</code> (the <code>--export-memory</code> to <code>wasm-ld</code>) to get past that check</p>",
        "id": 397361259,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1697652040
    },
    {
        "content": "<p>threaded modules for WASI need to both import and export their memory right now</p>",
        "id": 397361276,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1697652048
    },
    {
        "content": "<p>Thanks! I opened <a href=\"https://github.com/python/cpython/issues/111046\">https://github.com/python/cpython/issues/111046</a> to track this.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/python/cpython/issues/111046\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e9ba002f48eb528bf87221dfc442bbf1a503a906\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353835346662366666363934666464623731343732643238396434646137346533373562393239383465613736396134316165353030333363303230356238362f707974686f6e2f63707974686f6e2f6973737565732f313131303436)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/python/cpython/issues/111046\" title=\"Fix threaded build under WASI · Issue #111046 · python/cpython\">Fix threaded build under WASI · Issue #111046 · python/cpython</a></div><div class=\"message_embed_description\">Bug report Bug description: https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/.60missing.20required.20memory.20export.60.20for.20threaded.20CPython/near/397361259 I think ...</div></div></div>",
        "id": 397390105,
        "sender_full_name": "Brett Cannon",
        "timestamp": 1697667286
    }
]