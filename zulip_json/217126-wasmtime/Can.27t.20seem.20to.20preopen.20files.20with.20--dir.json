[
    {
        "content": "<p>Hello folks! I've got a tiny little Rust program that takes a file name as an argument, reads it and prints it out.</p>\n<p>It works just fine when compiled natively, but when running on Wasmtime of course it needs to be given capabilities over that file.</p>\n<p>I learned there's a <code>--dir</code> flag that I could use from playing around with <code>wasmtime help run</code>, but I'm not entirely sure how I should use it?</p>\n<p>E.g, if I call my program as <code>wasmtime run ./cat.wasm -- ./text</code> then I'd expect to be able to add <code>--dir=$(pwd)</code> or <code>--dir=.</code> an have that work.</p>\n<p>Unfortunately, I can't seem to give it a path that it likes for this and I'm not sure if I'm missing some consideration about how PATHs are handled in WASI.</p>\n<p>Any insights to share? :)</p>",
        "id": 217548937,
        "sender_full_name": "Leandro Ostera",
        "timestamp": 1606047890
    },
    {
        "content": "<p>The error looks like this btw:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'&lt;</span><span class=\"n\">unnamed</span><span class=\"o\">&gt;'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">called</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Result</span>::<span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Err</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"nc\">Custom</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">kind</span>: <span class=\"nc\">Other</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">error</span>: <span class=\"s\">\"failed to find a preopened file descriptor through which </span><span class=\"se\">\\\"</span><span class=\"s\">test_a.txt</span><span class=\"se\">\\\"</span><span class=\"s\"> could be opened\"</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"o\">'</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 217549002,
        "sender_full_name": "Leandro Ostera",
        "timestamp": 1606047986
    },
    {
        "content": "<p>Hi Leandro! That should indeed work, yes. Can you share what the exact command line looks like that fails for you? Based on your description it sounds like perhaps you're adding the <code>--dir=.</code> to the very end. In that case, that wouldn't work, since everything after the <code> -- </code> is passed as arguments to the content, not <code>wasmtime</code>. So this wouldn't work:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">text</span><span class=\"w\"></span>\n</code></pre></div>\n<p>but (assuming you're trying to open the file <code>text</code> in the current working directory) this should:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">dir</span><span class=\"o\">=</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">text</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 217552908,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1606054194
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"206238\" href=\"/#narrow/stream/206238-general/topic/wasmtime.3A.20Can.27t.20seem.20to.20preopen.20files.20with.20--dir\">#general &gt; wasmtime: Can't seem to preopen files with --dir</a> by <span class=\"user-mention silent\" data-user-id=\"234973\">Till Schneidereit</span></p>",
        "id": 217552955,
        "sender_full_name": "Notification Bot",
        "timestamp": 1606054230
    },
    {
        "content": "<p>Hej <span class=\"user-mention\" data-user-id=\"234973\">@Till Schneidereit</span>, I'm currently running this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"err\">λ</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">dir</span><span class=\"o\">=</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">test</span><span class=\"w\"></span>\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'&lt;</span><span class=\"n\">unnamed</span><span class=\"o\">&gt;'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">called</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Result</span>::<span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Err</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"nc\">Custom</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">kind</span>: <span class=\"nc\">Other</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"s\">\"failed to find a preopened file descriptor through which </span><span class=\"se\">\\\"</span><span class=\"s\">./test</span><span class=\"se\">\\\"</span><span class=\"s\"> could be opened\"</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"o\">'</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I also tried removing the call to fs::read_to_string that reads the file, and I'm still getting the same thing. Does wasmtime do anything with the arguments in case they are paths? (E.g, try to \"preopen\" them?)</p>",
        "id": 217553524,
        "sender_full_name": "Leandro Ostera",
        "timestamp": 1606055014
    },
    {
        "content": "<p>That looks like it should work, yes — though of course that depends on the actual code you're compiling <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>\n<p>For reference, I just tested this code (in a project created with <code>cargo new wasi-exp</code>), and it successfully prints the project's <code>Cargo.toml</code> file:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">error</span>::<span class=\"n\">Error</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"p\">{</span><span class=\"n\">env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fs</span><span class=\"p\">};</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">args</span>: <span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"nb\">String</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">env</span>::<span class=\"n\">args</span><span class=\"p\">().</span><span class=\"n\">collect</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"kt\">str</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fs</span>::<span class=\"n\">read_to_string</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">])</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">println</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"Reading file '{}'. contents:</span><span class=\"se\">\\n</span><span class=\"s\">{}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"kt\">str</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The command I used to run it is</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>wasmtime run --dir<span class=\"o\">=</span>. target/wasm32-wasi/debug/wasi-exp.wasm ./Cargo.toml\n</code></pre></div>",
        "id": 217557067,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1606060203
    },
    {
        "content": "<blockquote>\n<p>Does wasmtime do anything with the arguments in case they are paths? (E.g, try to \"preopen\" them?)</p>\n</blockquote>\n<p>It doesn't, because it can't know that they're meant to be files. That's because there's no way to provide typed arguments to a WASI <code>main</code> function — yet <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 217557109,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1606060293
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"234973\">@Till Schneidereit</span> -- In essence the code I'm running is this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">fs</span>::<span class=\"n\">read_to_string</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s\">\"</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n</code></pre></div>\n<p>where <code>path</code> is passed in after parsing the arguments. Printing it out it shows me the same thing I'm passing in.</p>\n<p>This data is then printed out again with <code>print!</code> very similarly to how you showed.</p>\n<p>However, in the interest of keeping this self-contained as an example, I omitted that I'm putting together this binary by building a WASM library and using Walrus to extend the .wasm to include the right boot code.</p>\n<p>The reason for this is that I'm building a little virtual machine that builds targets into binaries that are self-contained (so you don't need to _also_ install the virtual machine, which wouldn't be possible in a browser).</p>\n<p>Could this have anything to do with that? Is there any \"seal\" that I'm breaking that Wasmtime will look into?</p>",
        "id": 217740979,
        "sender_full_name": "Leandro Ostera",
        "timestamp": 1606217341
    },
    {
        "content": "<p>that sounds like a pretty cool setup! <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>\n<p>It shouldn't affect preopen in and of itself, and there's definitely not some kind of \"seal\" to be broken. but depending on the details of what you're doing, perhaps it has an impact on the Rust std library implementation of preopen support?</p>\n<p>You should be able to see the details of which file operations are attempted by prepending <code>RUST_LOG=wasi</code> to your command line. That'll spew a pretty verbose wall of log info, so it might take some wading through, but it should in particular include these relevant ones:</p>\n<ol>\n<li><code>DEBUG</code> messages about paths being preopened, including the absolute path, and the <code>preopen_path</code> — i.e. the path that the content code \"sees\". These messages should start with</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code> DEBUG wasi_common::old::snapshot_0::ctx                   &gt; WasiCtx inserting\n</code></pre></div>\n<ol start=\"2\">\n<li>a <code>TRACE</code> message for the invocation of the WASI syscall <code>path_open</code>. This message should be</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code> TRACE wasi_common::wasi::wasi_snapshot_preview1           &gt; wiggle abi<span class=\"p\">;</span> <span class=\"nv\">module</span><span class=\"o\">=</span><span class=\"s2\">\"wasi_snapshot_preview1\"</span> <span class=\"k\">function</span><span class=\"o\">=</span><span class=\"s2\">\"path_open\"</span>\n</code></pre></div>\n<p>And following that <code>TRACE</code> message various lines about the path operations related to <code>path_open</code>, which should be the most interesting part for debugging this. For reference, here's what that section looks like for my test case posted yesterday:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code> TRACE wasi_common::wasi::wasi_snapshot_preview1           &gt; wiggle abi<span class=\"p\">;</span> <span class=\"nv\">module</span><span class=\"o\">=</span><span class=\"s2\">\"wasi_snapshot_preview1\"</span> <span class=\"k\">function</span><span class=\"o\">=</span><span class=\"s2\">\"path_open\"</span>\n TRACE wasi_common::wasi::wasi_snapshot_preview1           &gt; <span class=\"nv\">fd</span><span class=\"o\">=</span>Fd<span class=\"o\">(</span><span class=\"m\">3</span><span class=\"o\">)</span> <span class=\"nv\">dirflags</span><span class=\"o\">=</span>symlink_follow <span class=\"o\">(</span>0x1<span class=\"o\">)</span> <span class=\"nv\">path</span><span class=\"o\">=</span>*guest 0x1100f0/10 <span class=\"nv\">oflags</span><span class=\"o\">=</span>empty <span class=\"o\">(</span>0x0<span class=\"o\">)</span> <span class=\"nv\">fs_rights_base</span><span class=\"o\">=</span>fd_read<span class=\"p\">|</span>fd_seek<span class=\"p\">|</span>fd_fdstat_set_flags<span class=\"p\">|</span>fd_sync<span class=\"p\">|</span>fd_tell<span class=\"p\">|</span>fd_advise<span class=\"p\">|</span>path_create_directory<span class=\"p\">|</span>path_create_file<span class=\"p\">|</span>path_link_source<span class=\"p\">|</span>path_link_target<span class=\"p\">|</span>path_open<span class=\"p\">|</span>fd_readdir<span class=\"p\">|</span>path_readlink<span class=\"p\">|</span>path_rename_source<span class=\"p\">|</span>path_rename_target<span class=\"p\">|</span>path_filestat_get<span class=\"p\">|</span>fd_filestat_get<span class=\"p\">|</span>fd_filestat_set_times<span class=\"p\">|</span>path_symlink<span class=\"p\">|</span>path_remove_directory<span class=\"p\">|</span>path_unlink_file<span class=\"p\">|</span>poll_fd_readwrite <span class=\"o\">(</span>0xfa7febe<span class=\"o\">)</span> <span class=\"nv\">fs_rights_inherting</span><span class=\"o\">=</span>fd_read<span class=\"p\">|</span>fd_seek<span class=\"p\">|</span>fd_fdstat_set_flags<span class=\"p\">|</span>fd_sync<span class=\"p\">|</span>fd_tell<span class=\"p\">|</span>fd_advise<span class=\"p\">|</span>path_create_directory<span class=\"p\">|</span>path_create_file<span class=\"p\">|</span>path_link_source<span class=\"p\">|</span>path_link_target<span class=\"p\">|</span>path_open<span class=\"p\">|</span>fd_readdir<span class=\"p\">|</span>path_readlink<span class=\"p\">|</span>path_rename_source<span class=\"p\">|</span>path_rename_target<span class=\"p\">|</span>path_filestat_get<span class=\"p\">|</span>fd_filestat_get<span class=\"p\">|</span>fd_filestat_set_times<span class=\"p\">|</span>path_symlink<span class=\"p\">|</span>path_remove_directory<span class=\"p\">|</span>path_unlink_file<span class=\"p\">|</span>poll_fd_readwrite <span class=\"o\">(</span>0xfa7febe<span class=\"o\">)</span> <span class=\"nv\">fdflags</span><span class=\"o\">=</span>empty <span class=\"o\">(</span>0x0<span class=\"o\">)</span>\n TRACE wasi_common::snapshots::wasi_snapshot_preview1      &gt;      <span class=\"p\">|</span> <span class=\"nv\">needed_rights</span><span class=\"o\">=</span>HandleRights <span class=\"o\">{</span> base: path_open <span class=\"o\">(</span>0x2000<span class=\"o\">)</span>, inheriting: fd_read<span class=\"p\">|</span>fd_seek<span class=\"p\">|</span>fd_fdstat_set_flags<span class=\"p\">|</span>fd_sync<span class=\"p\">|</span>fd_tell<span class=\"p\">|</span>fd_advise<span class=\"p\">|</span>path_create_directory<span class=\"p\">|</span>path_create_file<span class=\"p\">|</span>path_link_source<span class=\"p\">|</span>path_link_target<span class=\"p\">|</span>path_open<span class=\"p\">|</span>fd_readdir<span class=\"p\">|</span>path_readlink<span class=\"p\">|</span>path_rename_source<span class=\"p\">|</span>path_rename_target<span class=\"p\">|</span>path_filestat_get<span class=\"p\">|</span>fd_filestat_get<span class=\"p\">|</span>fd_filestat_set_times<span class=\"p\">|</span>path_symlink<span class=\"p\">|</span>path_remove_directory<span class=\"p\">|</span>path_unlink_file<span class=\"p\">|</span>poll_fd_readwrite <span class=\"o\">(</span>0xfa7febe<span class=\"o\">)</span> <span class=\"o\">}</span>\n TRACE wasi_common::path                                   &gt; <span class=\"nv\">path</span><span class=\"o\">=</span><span class=\"s2\">\"Cargo.toml\"</span>\n DEBUG wasi_common::path                                   &gt; path get <span class=\"nv\">cur_path</span><span class=\"o\">=</span>Cargo.toml\n DEBUG wasi_common::path                                   &gt; path_get <span class=\"nv\">path_stack</span><span class=\"o\">=[]</span>\n DEBUG wasi_common::sys::unix::path                        &gt; path_get readlinkat <span class=\"nv\">path</span><span class=\"o\">=</span><span class=\"s2\">\"Cargo.toml\"</span>\n TRACE wasi_common::snapshots::wasi_snapshot_preview1      &gt;      <span class=\"p\">|</span> calling path_open impl: <span class=\"nv\">read</span><span class=\"o\">=</span>true, <span class=\"nv\">write</span><span class=\"o\">=</span><span class=\"nb\">false</span>\n DEBUG wasi_common::sys::unix::path                        &gt; path_open <span class=\"nv\">dirfd</span><span class=\"o\">=</span>OsDir <span class=\"o\">{</span> rights: Cell <span class=\"o\">{</span> value: HandleRights <span class=\"o\">{</span> base: Rights<span class=\"o\">(</span><span class=\"m\">264240792</span><span class=\"o\">)</span>, inheriting: Rights<span class=\"o\">(</span><span class=\"m\">268435455</span><span class=\"o\">)</span> <span class=\"o\">}</span> <span class=\"o\">}</span>, handle: RawOsHandle<span class=\"o\">(</span>File <span class=\"o\">{</span> fd: <span class=\"m\">7</span>, path: <span class=\"s2\">\"/Users/till/exp/wasi-exp\"</span>, read: true, write: <span class=\"nb\">false</span> <span class=\"o\">})</span>, stream_ptr: RefCell <span class=\"o\">{</span> value: Dir<span class=\"o\">(</span>0x7faf99204190<span class=\"o\">)</span> <span class=\"o\">}</span> <span class=\"o\">}</span> <span class=\"nv\">path</span><span class=\"o\">=</span><span class=\"s2\">\"Cargo.toml\"</span> <span class=\"nv\">oflags</span><span class=\"o\">=</span>NOFOLLOW\n DEBUG wasi_common::sys::unix::path                        &gt; <span class=\"nv\">new_fd</span><span class=\"o\">=</span><span class=\"m\">9</span>\n DEBUG wasi_common::sys::unix                              &gt; Host fd <span class=\"m\">9</span> is a file\n DEBUG wasi_common::sys                                    &gt; Created new instance of OsFile <span class=\"nv\">handle</span><span class=\"o\">=</span>OsFile <span class=\"o\">{</span> rights: Cell <span class=\"o\">{</span> value: HandleRights <span class=\"o\">{</span> base: Rights<span class=\"o\">(</span><span class=\"m\">148898239</span><span class=\"o\">)</span>, inheriting: Rights<span class=\"o\">(</span><span class=\"m\">0</span><span class=\"o\">)</span> <span class=\"o\">}</span> <span class=\"o\">}</span>, handle: RawOsHandle<span class=\"o\">(</span>File <span class=\"o\">{</span> fd: <span class=\"m\">9</span>, path: <span class=\"s2\">\"/Users/till/exp/wasi-exp/Cargo.toml\"</span>, read: true, write: <span class=\"nb\">false</span> <span class=\"o\">})</span> <span class=\"o\">}</span>\n TRACE wasi_common::wasi::wasi_snapshot_preview1           &gt; <span class=\"nv\">opened_fd</span><span class=\"o\">=</span>Fd<span class=\"o\">(</span><span class=\"m\">4</span><span class=\"o\">)</span>\n TRACE wasi_common::wasi::wasi_snapshot_preview1           &gt; <span class=\"nv\">success</span><span class=\"o\">=</span>No error occurred. System call completed successfully. <span class=\"o\">(</span>Errno::Success<span class=\"o\">(</span><span class=\"m\">0</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 217752526,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1606224328
    },
    {
        "content": "<p>Thanks! This is the output I've gotten with <code>RUST_LOG=wasi</code> set. I can't seem to find a TRACE call to <code>path_open</code> :/ </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"err\">λ</span><span class=\"w\"> </span><span class=\"n\">RUST_LOG</span><span class=\"o\">=</span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">dir</span><span class=\"o\">=</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserting</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"n\">pending</span><span class=\"o\">=</span><span class=\"n\">PendingEntry</span>::<span class=\"n\">Thunk</span><span class=\"p\">(</span><span class=\"mh\">0x7fff947ae470</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">ctx</span><span class=\"w\">       </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserted</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"o\">=</span><span class=\"n\">Fd</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">ctx</span><span class=\"w\">       </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserting</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"n\">pending</span><span class=\"o\">=</span><span class=\"n\">PendingEntry</span>::<span class=\"n\">Thunk</span><span class=\"p\">(</span><span class=\"mh\">0x7fff947ae470</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">ctx</span><span class=\"w\">       </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserted</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"o\">=</span><span class=\"n\">Fd</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">ctx</span><span class=\"w\">       </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserting</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"n\">pending</span><span class=\"o\">=</span><span class=\"n\">PendingEntry</span>::<span class=\"n\">Thunk</span><span class=\"p\">(</span><span class=\"mh\">0x7fff947ae470</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">ctx</span><span class=\"w\">       </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserted</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"o\">=</span><span class=\"n\">Fd</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">ctx</span><span class=\"w\">       </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserted</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"o\">=</span><span class=\"n\">Fd</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserting</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">PendingEntry</span>::<span class=\"n\">Thunk</span><span class=\"p\">(</span><span class=\"mh\">0x7fff947ae918</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span>::<span class=\"n\">entry_impl</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">ctx</span><span class=\"w\">                   </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserting</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">PendingEntry</span>::<span class=\"n\">Thunk</span><span class=\"p\">(</span><span class=\"mh\">0x7fff947ae928</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span>::<span class=\"n\">entry_impl</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">ctx</span><span class=\"w\">                   </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserting</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">PendingEntry</span>::<span class=\"n\">Thunk</span><span class=\"p\">(</span><span class=\"mh\">0x7fff947ae938</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span>::<span class=\"n\">entry_impl</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">device</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span>::<span class=\"n\">entry_impl</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">ctx</span><span class=\"w\">                   </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">inserting</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Entry</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">file_type</span>: <span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">descriptor</span>: <span class=\"nc\">OsHandle</span><span class=\"p\">(</span><span class=\"n\">OsHandle</span><span class=\"p\">(</span><span class=\"n\">File</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">fd</span>: <span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">path</span>: <span class=\"s\">\"/home/ostera/repos/github.com/AbstractMachinesLab/lam/examples/cat\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">read</span>: <span class=\"nc\">t</span><span class=\"w\"></span>\n<span class=\"n\">rue</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">write</span>: <span class=\"nc\">false</span><span class=\"w\"> </span><span class=\"p\">})),</span><span class=\"w\"> </span><span class=\"n\">rights_base</span>: <span class=\"mi\">264240792</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rights_inheriting</span>: <span class=\"mi\">268435455</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">preopen_path</span>: <span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"s\">\".\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">})</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasi_common</span>::<span class=\"n\">old</span>::<span class=\"n\">snapshot_0</span>::<span class=\"n\">ctx</span><span class=\"w\">                   </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">2</span>: <span class=\"nc\">Entry</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">file_type</span>: <span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">descriptor</span>: <span class=\"nc\">Stderr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rights_base</span>: <span class=\"mi\">136314954</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rights_inheriting</span>: <span class=\"mi\">136314954</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">preopen_path</span>: <span class=\"nc\">None</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"mi\">1</span>: <span class=\"nc\">Entry</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">file_type</span>: <span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">descri</span><span class=\"w\"></span>\n<span class=\"n\">ptor</span>: <span class=\"nc\">Stdout</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rights_base</span>: <span class=\"mi\">136314954</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rights_inheriting</span>: <span class=\"mi\">136314954</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">preopen_path</span>: <span class=\"nc\">None</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"mi\">3</span>: <span class=\"nc\">Entry</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">file_type</span>: <span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">descriptor</span>: <span class=\"nc\">OsHandle</span><span class=\"p\">(</span><span class=\"n\">OsHandle</span><span class=\"p\">(</span><span class=\"n\">File</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">fd</span>: <span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">path</span>: <span class=\"s\">\"/home/ostera/repos/github.com/AbstractMachinesLab/lam/examples/cat</span>\n<span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">read</span>: <span class=\"nc\">true</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">write</span>: <span class=\"nc\">false</span><span class=\"w\"> </span><span class=\"p\">})),</span><span class=\"w\"> </span><span class=\"n\">rights_base</span>: <span class=\"mi\">264240792</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rights_inheriting</span>: <span class=\"mi\">268435455</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">preopen_path</span>: <span class=\"nc\">Some</span><span class=\"p\">(</span><span class=\"s\">\".\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"mi\">0</span>: <span class=\"nc\">Entry</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">file_type</span>: <span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">descriptor</span>: <span class=\"nc\">Stdin</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rights_base</span>: <span class=\"mi\">136314954</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rights_inheriting</span>: <span class=\"mi\">136314954</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">preopen_path</span>: <span class=\"nc\">None</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The full log is here: <a href=\"https://gist.github.com/ostera/c35aa5498fc4fc7cee60e3eabe45d9de\">https://gist.github.com/ostera/c35aa5498fc4fc7cee60e3eabe45d9de</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://gist.github.com/ostera/c35aa5498fc4fc7cee60e3eabe45d9de\" style=\"background-image: url(https://github.githubassets.com/images/modules/gists/gist-og-image.png)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://gist.github.com/ostera/c35aa5498fc4fc7cee60e3eabe45d9de\" title=\"wasi.log\">wasi.log</a></div><div class=\"message_embed_description\">wasi.log. GitHub Gist: instantly share code, notes, and snippets.</div></div></div>",
        "id": 217760245,
        "sender_full_name": "Leandro Ostera",
        "timestamp": 1606227977
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"234973\">@Till Schneidereit</span> any thoughts on why i can't find that sys call? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 218001504,
        "sender_full_name": "Leandro Ostera",
        "timestamp": 1606397453
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"366212\">@Leandro Ostera</span> I don't know the details of how Rust's standard library handles preopened files. It's possible that there's a check happening inside the content code that already detects that no preopened directory can be found that'd make this path resolve.</p>\n<p>Given that it seems like that should work — see my example above — perhaps the boot code you're injecting somehow breaks it? To test that, maybe you could use the reduced test case I posted above, verify that it works with the Wasmtime CLI as expected, and then see whether it also fails in your setup?</p>",
        "id": 218300437,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1606749657
    }
]