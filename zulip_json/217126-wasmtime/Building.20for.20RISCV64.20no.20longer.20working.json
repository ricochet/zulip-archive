[
    {
        "content": "<p>I have been able to build for RISCV64 before, but since the repo I updated yesterday (321294a5d21f7006a959ba378ebd32782a76d3d2) building on RISCV64 fails on wasmtime-runtime v16.0.0 with the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">custom</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"w\"> </span><span class=\"n\">v16</span><span class=\"p\">.</span><span class=\"mf\">0.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ace5g</span><span class=\"o\">/</span><span class=\"n\">shared</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"p\">)</span><span class=\"err\">`</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n  <span class=\"nc\">process</span><span class=\"w\"> </span><span class=\"n\">didn</span><span class=\"o\">'</span><span class=\"na\">t</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">successfully</span>: <span class=\"err\">`</span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ace5g</span><span class=\"o\">/</span><span class=\"n\">shared</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">d1197a7c0d12cf2e</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">-</span><span class=\"n\">script</span><span class=\"o\">-</span><span class=\"n\">build</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span>: <span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"o\">---</span><span class=\"w\"> </span><span class=\"n\">stdout</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">rerun</span><span class=\"o\">-</span><span class=\"k\">if</span><span class=\"o\">-</span><span class=\"n\">changed</span><span class=\"o\">=</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">helpers</span><span class=\"p\">.</span><span class=\"n\">c</span>\n<span class=\"w\">  </span><span class=\"n\">TARGET</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"s\">\"riscv64gc-unknown-linux-gnu\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">OPT_LEVEL</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"s\">\"3\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">HOST</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"s\">\"riscv64gc-unknown-linux-gnu\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">CC_riscv64gc</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">None</span>\n<span class=\"w\">  </span><span class=\"n\">CC_riscv64gc_unknown_linux_gnu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">None</span>\n<span class=\"w\">  </span><span class=\"n\">HOST_CC</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">None</span>\n<span class=\"w\">  </span><span class=\"n\">CC</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"s\">\"clang-15\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">CFLAGS_riscv64gc</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">None</span>\n<span class=\"w\">  </span><span class=\"n\">CFLAGS_riscv64gc_unknown_linux_gnu</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">None</span>\n<span class=\"w\">  </span><span class=\"n\">HOST_CFLAGS</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">None</span>\n<span class=\"w\">  </span><span class=\"n\">CFLAGS</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">None</span>\n<span class=\"w\">  </span><span class=\"n\">CRATE_CC_NO_DEFAULTS</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">None</span>\n<span class=\"w\">  </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"s\">\"false\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">running</span>: <span class=\"s\">\"clang-15\"</span><span class=\"w\"> </span><span class=\"s\">\"-O3\"</span><span class=\"w\"> </span><span class=\"s\">\"-ffunction-sections\"</span><span class=\"w\"> </span><span class=\"s\">\"-fdata-sections\"</span><span class=\"w\"> </span><span class=\"s\">\"-fPIC\"</span><span class=\"w\"> </span><span class=\"s\">\"--target=riscv64-unknown-linux-gnu\"</span><span class=\"w\"> </span><span class=\"s\">\"-Wall\"</span><span class=\"w\"> </span><span class=\"s\">\"-Wextra\"</span><span class=\"w\"> </span><span class=\"s\">\"-DCFG_TARGET_OS_linux\"</span><span class=\"w\"> </span><span class=\"s\">\"-DCFG_TARGET_ARCH_riscv64\"</span><span class=\"w\"> </span><span class=\"s\">\"-DVERSIONED_SUFFIX=_16_0_0\"</span><span class=\"w\"> </span><span class=\"s\">\"-o\"</span><span class=\"w\"> </span><span class=\"s\">\"/home/ace5g/shared/wasmtime/target/release/build/wasmtime-runtime-2c4c2ea10989c7f1/out/src/helpers.o\"</span><span class=\"w\"> </span><span class=\"s\">\"-c\"</span><span class=\"w\"> </span><span class=\"s\">\"src/helpers.c\"</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">helpers</span><span class=\"p\">.</span><span class=\"n\">c</span>:<span class=\"mi\">55</span>:<span class=\"mi\">7</span>: <span class=\"nc\">error</span>: <span class=\"nc\">__builtin_setjmp</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">supported</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">target</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">platform_setjmp</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"w\">      </span><span class=\"o\">^~~~~~~~~~~~~~~~~~~~</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">helpers</span><span class=\"p\">.</span><span class=\"n\">c</span>:<span class=\"mi\">39</span>:<span class=\"mi\">30</span>: <span class=\"nc\">note</span>: <span class=\"nc\">expanded</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"kr\">macro</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">platform_setjmp</span><span class=\"o\">'</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span>#<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">platform_setjmp</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">__builtin_setjmp</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"w\">                             </span><span class=\"o\">^~~~~~~~~~~~~~~~~~~~~</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">helpers</span><span class=\"p\">.</span><span class=\"n\">c</span>:<span class=\"mi\">65</span>:<span class=\"mi\">3</span>: <span class=\"nc\">error</span>: <span class=\"nc\">__builtin_longjmp</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">supported</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">target</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"w\">  </span><span class=\"n\">platform_longjmp</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">buf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"w\">  </span><span class=\"o\">^~~~~~~~~~~~~~~~~~~~~~~~~</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">helpers</span><span class=\"p\">.</span><span class=\"n\">c</span>:<span class=\"mi\">40</span>:<span class=\"mi\">36</span>: <span class=\"nc\">note</span>: <span class=\"nc\">expanded</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"kr\">macro</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">platform_longjmp</span><span class=\"o\">'</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span>#<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">platform_longjmp</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">__builtin_longjmp</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"w\">                                   </span><span class=\"o\">^~~~~~~~~~~~~~~~~~~~~~~~~~~</span>\n<span class=\"w\">  </span><span class=\"n\">cargo</span>:<span class=\"nc\">warning</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">errors</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"p\">.</span>\n<span class=\"w\">  </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span>: <span class=\"mi\">1</span>\n\n<span class=\"w\">  </span><span class=\"o\">---</span><span class=\"w\"> </span><span class=\"n\">stderr</span>\n\n\n<span class=\"w\">  </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">occurred</span>: <span class=\"nc\">Command</span><span class=\"w\"> </span><span class=\"s\">\"clang-15\"</span><span class=\"w\"> </span><span class=\"s\">\"-O3\"</span><span class=\"w\"> </span><span class=\"s\">\"-ffunction-sections\"</span><span class=\"w\"> </span><span class=\"s\">\"-fdata-sections\"</span><span class=\"w\"> </span><span class=\"s\">\"-fPIC\"</span><span class=\"w\"> </span><span class=\"s\">\"--target=riscv64-unknown-linux-gnu\"</span><span class=\"w\"> </span><span class=\"s\">\"-Wall\"</span><span class=\"w\"> </span><span class=\"s\">\"-Wextra\"</span><span class=\"w\"> </span><span class=\"s\">\"-DCFG_TARGET_OS_linux\"</span><span class=\"w\"> </span><span class=\"s\">\"-DCFG_TARGET_ARCH_riscv64\"</span><span class=\"w\"> </span><span class=\"s\">\"-DVERSIONED_SUFFIX=_16_0_0\"</span><span class=\"w\"> </span><span class=\"s\">\"-o\"</span><span class=\"w\"> </span><span class=\"s\">\"/home/ace5g/shared/wasmtime/target/release/build/wasmtime-runtime-2c4c2ea10989c7f1/out/src/helpers.o\"</span><span class=\"w\"> </span><span class=\"s\">\"-c\"</span><span class=\"w\"> </span><span class=\"s\">\"src/helpers.c\"</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"s\">\"clang-15\"</span><span class=\"w\"> </span><span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">execute</span><span class=\"w\"> </span><span class=\"n\">successfully</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span>: <span class=\"mi\">1</span><span class=\"p\">).</span>\n</code></pre></div>\n<p>Any insights on how to fix this are appreciated.</p>",
        "id": 402189028,
        "sender_full_name": "Mats Brorsson",
        "timestamp": 1700041664
    },
    {
        "content": "<p><span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span> Hey,</p>\n<p>I was able to reproduce this both natively and while cross compiling. This only seems to happen when compiling with <code>clang</code> as the C compiler.</p>\n<p>It looks like there is already a <a href=\"https://github.com/bytecodealliance/wasmtime/blob/aa549e61ed6af48b8ca710c3db6e142ae00231a6/crates/runtime/src/helpers.c#L11-L22\">workaround for S390X and AArch64 in helper.c</a>, so you might want to enable that temporarily. I'm going to submit a PR enabling that for RISC-V as well</p>",
        "id": 402216602,
        "sender_full_name": "Afonso Bordado",
        "timestamp": 1700049348
    },
    {
        "content": "<p>Here's the PR: <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7541\">https://github.com/bytecodealliance/wasmtime/pull/7541</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/7541\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/14dd62758d714a62d99afb030f36254441b756d2\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303635383139343032393761333665326365356134323630386566323364613766373063613863313737376465666264333364636135343433623730363263352f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f37353431)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/7541\" title=\"wasmtime: Fix RISC-V build when using clang by afonso360 路 Pull Request #7541 路 bytecodealliance/wasmtime\">wasmtime: Fix RISC-V build when using clang by afonso360 路 Pull Request #7541 路 bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\"> Hey,\nAs reported in zulip, it looks like clang does not expose __builtin_{set,long}jmp for some platforms. This was a known issue previously for AArch64 and S390X, but it looks like it also affec...</div></div></div>",
        "id": 402220495,
        "sender_full_name": "Afonso Bordado",
        "timestamp": 1700050279
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"410955\">Afonso Bordado</span> <a href=\"#narrow/stream/217126-wasmtime/topic/Building.20for.20RISCV64.20no.20longer.20working/near/402216602\">said</a>:</p>\n<blockquote>\n<p><span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span> Hey,</p>\n<p>I was able to reproduce this both natively and while cross compiling. This only seems to happen when compiling with <code>clang</code> as the C compiler.</p>\n<p>It looks like there is already a <a href=\"https://github.com/bytecodealliance/wasmtime/blob/aa549e61ed6af48b8ca710c3db6e142ae00231a6/crates/runtime/src/helpers.c#L11-L22\">workaround for S390X and AArch64 in helper.c</a>, so you might want to enable that temporarily. I'm going to submit a PR enabling that for RISC-V as well</p>\n</blockquote>\n<p>Thanks,  that works. But how would you otherwise go about and force the use of gcc instead of clang? I am completely new to build scripts so it's a mystery for me.</p>",
        "id": 402224568,
        "sender_full_name": "Mats Brorsson",
        "timestamp": 1700051297
    },
    {
        "content": "<p>I was able to reproduce this using <code>CC=clang cargo build</code>, so it might work to replace that with gcc in your usecase?</p>",
        "id": 402229859,
        "sender_full_name": "Afonso Bordado",
        "timestamp": 1700052575
    }
]