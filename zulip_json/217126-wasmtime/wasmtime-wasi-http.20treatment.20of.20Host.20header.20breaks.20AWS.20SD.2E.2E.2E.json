[
    {
        "content": "<p>wasmtime-wasi-http <a href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/types.rs#L98\">forbids guests to set the Host header</a>, and then <a href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/http_impl.rs#L74\">synthesizes it from the authority part of the URI</a>, with a default port number added if none was already present.</p>\n<p>I've run into a case where this presents a problem for a guest component. The AWS SDK includes the host header (or maybe what it assumes the HTTP connector will set it to — it actually looked like it was not even attempting to set when I was debugging this) in a digest that it sends with API requests to AWS servers. Because wasmtime-wasi-http inserts the port number into the host header, this means that the digest will never match, and AWS servers return an opaque auth error. I formed this belief because in my testing, if I replicate the same request using curl it fails in the same way, but if I remove the port number from the Host header then it succeeds.</p>\n<p>Now, I don't understand what the port number insertion is for, so I'm not confident in suggesting any specific change here. Instead, I'll ask a few questions: </p>\n<ul>\n<li>\n<p>Instead of forbidding the Host header, could it be allowed as long as it is set to something that is \"compatible\" with the authority part of the URL — i.e. same host, and also port if one was specified in the authority part of the URI? This option if possible seems most flexible.</p>\n</li>\n<li>\n<p>Instead of including the port number in the synthesized Host header, could it just be the authority part of the URI without the port number added? This option would at least let the AWS SDK work. </p>\n</li>\n<li>\n<p>What is the port number added for here? Is it some correctness/security concern, or is it just a convenient place to store it so it can be plucked out later when the actual connection is made? Or is it not even deliberate? </p>\n</li>\n</ul>\n<p>Thanks in advance for any thoughts on this! <span aria-label=\"sparkling heart\" class=\"emoji emoji-1f496\" role=\"img\" title=\"sparkling heart\">:sparkling_heart:</span><span aria-label=\"man bowing\" class=\"emoji emoji-1f647-200d-2642\" role=\"img\" title=\"man bowing\">:man_bowing:</span></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/types.rs#L98\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/8fc9ca2e0a4b72d0b4ee91aca67b95eb85c1ff42\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306265323033646661653463636338336631343638343161613466326262613263633833303637333035313262633561313634396166646239343264613333352f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/types.rs#L98\" title=\"wasmtime/crates/wasi-http/src/types.rs at 1fa8de140fce161ed5d77cf939558de79d3956c1 · bytecodealliance/wasmtime\">wasmtime/crates/wasi-http/src/types.rs at 1fa8de140fce161ed5d77cf939558de79d3956c1 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/http_impl.rs#L74\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/8fc9ca2e0a4b72d0b4ee91aca67b95eb85c1ff42\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306265323033646661653463636338336631343638343161613466326262613263633833303637333035313262633561313634396166646239343264613333352f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/http_impl.rs#L74\" title=\"wasmtime/crates/wasi-http/src/http_impl.rs at 1fa8de140fce161ed5d77cf939558de79d3956c1 · bytecodealliance/wasmtime\">wasmtime/crates/wasi-http/src/http_impl.rs at 1fa8de140fce161ed5d77cf939558de79d3956c1 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>",
        "id": 434474786,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1713593812
    },
    {
        "content": "<p>I can confirm this problem, which is caused by AWS's request signing mechanism which includes the exact host header value in its signature payload. I think a close reading of the http/1.1 spec suggests that wasmtime-wasi-http's behavior is incorrect (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/http_impl.rs#L68-L69\">here</a>): <a href=\"https://httpwg.org/http-core/draft-ietf-httpbis-messaging-latest.html#request.target\">https://httpwg.org/http-core/draft-ietf-httpbis-messaging-latest.html#request.target</a></p>\n<blockquote>\n<p>If the target URI includes an authority component, then a client MUST send a field value for Host that is identical to that authority component</p>\n</blockquote>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/http_impl.rs#L68-L69\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/2cced6cb66ce69563ff036f54b383ac30df11f2f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373236646234306663363330333433393865626134373838663334633363323734316365356431623538316437613562306135656365323664623337333438612f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/1fa8de140fce161ed5d77cf939558de79d3956c1/crates/wasi-http/src/http_impl.rs#L68-L69\" title=\"wasmtime/crates/wasi-http/src/http_impl.rs at 1fa8de140fce161ed5d77cf939558de79d3956c1 · bytecodealliance/wasmtime\">wasmtime/crates/wasi-http/src/http_impl.rs at 1fa8de140fce161ed5d77cf939558de79d3956c1 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>",
        "id": 434740046,
        "sender_full_name": "Lann Martin",
        "timestamp": 1713790083
    },
    {
        "content": "<p>Made an issue to track: <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8430\">https://github.com/bytecodealliance/wasmtime/issues/8430</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/8430\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/5e3c519e50a0933e932ee7907abb273e05d65280\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333735323536376234343131666231376435316361343638623064373737383663623933393732323738393166633961636462386238393265373037353031362f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f38343330)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/8430\" title=\"`wasmtime-wasi-http` shouldn't add the default port to outbound `host header · Issue #8430 · bytecodealliance/wasmtime\">`wasmtime-wasi-http` shouldn't add the default port to outbound `host header · Issue #8430 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">The outbound HTTP implementation will add a default port to the URI authority if not present: wasmtime/crates/wasi-http/src/http_impl.rs Lines 68 to 69 in 1fa8de1 } else { format!(\"{}:{port}\", auth...</div></div></div>",
        "id": 434742116,
        "sender_full_name": "Lann Martin",
        "timestamp": 1713790599
    },
    {
        "content": "<p>As a workaround you might be able to force the AWS SDK to include the default port number by setting it explicitly in the endpoint, e.g. <code>s3.us-east-2.amazonaws.com:443</code>?</p>",
        "id": 434742254,
        "sender_full_name": "Lann Martin",
        "timestamp": 1713790641
    }
]