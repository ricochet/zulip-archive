[
    {
        "content": "<p>I am trying to implement the solution proposed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8857\">in this GitHub issue in the wasmtime repository</a>.</p>\n<p>I have a wasm component whose interface is defined as:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">docs</span><span class=\"p\">:</span><span class=\"nc\">adder</span><span class=\"o\">@</span><span class=\"mf\">0.1.0</span><span class=\"p\">;</span>\n\n<span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">add</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">func</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">s32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">s32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">s32</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I am trying to invoke the exported <code>add</code> function using the following Rust code:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">anyhow</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::{</span><span class=\"n\">Component</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Val</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::{</span><span class=\"n\">Engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::{</span><span class=\"n\">ResourceTable</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiCtxBuilder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiView</span><span class=\"p\">};</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Create an engine and store</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Engine</span><span class=\"p\">::</span><span class=\"n\">default</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">WasiCtxBuilder</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">().</span><span class=\"n\">inherit_stdio</span><span class=\"p\">().</span><span class=\"n\">build</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ServerWasiView</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">wasi</span><span class=\"p\">));</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Load the component</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"p\">::</span><span class=\"n\">from_file</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"target/wasm32-wasip1/release/add.wasm\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Create a linker</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">ServerWasiView</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Add WASI to the linker</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_sync</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Instantiate the component</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">component</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">possible_names</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<span class=\"w\">        </span><span class=\"s\">\"add#add\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s\">\"docs:adder/add@0.1.0#add\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s\">\"adder/add@0.1.0#add\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s\">\"/add@0.1.0#add\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s\">\"add@0.1.0#add\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s\">\"#add\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s\">\"add\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">];</span>\n\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">exports</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">possible_names</span><span class=\"p\">.</span><span class=\"n\">iter</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"p\">.</span><span class=\"n\">instance</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">).</span><span class=\"n\">is_some</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Found add instance with name: {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Try to get the add function with different possible names</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">instance</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"add\"</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">or_else</span><span class=\"p\">(</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"docs:adder/add@0.1.0#add\"</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">or_else</span><span class=\"p\">(</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"adder/add@0.1.0#add\"</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">or_else</span><span class=\"p\">(</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"/add@0.1.0#add\"</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">or_else</span><span class=\"p\">(</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"add@0.1.0#add\"</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">or_else</span><span class=\"p\">(</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"#add\"</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">or_else</span><span class=\"p\">(</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"add\"</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">\"add function not found\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Found add function\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Prepare the arguments and results</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">results</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">Val</span><span class=\"p\">::</span><span class=\"n\">S32</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)];</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Call the function</span>\n<span class=\"w\">    </span><span class=\"n\">add</span><span class=\"p\">.</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"p\">[</span><span class=\"n\">Val</span><span class=\"p\">::</span><span class=\"n\">S32</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">Val</span><span class=\"p\">::</span><span class=\"n\">S32</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">)],</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">results</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Extract the result</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">Val</span><span class=\"p\">::</span><span class=\"n\">S32</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">results</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">panic!</span><span class=\"p\">(</span><span class=\"s\">\"Unexpected result type\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"5 + 3 = {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">ServerWasiView</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ResourceTable</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiCtx</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">ServerWasiView</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiCtx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Self</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">table</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ResourceTable</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"bp\">Self</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">table</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">WasiView</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">ServerWasiView</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">table</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">ResourceTable</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">table</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">ctx</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">ctx</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I have not managed to get a reference to the exported function in the host code. What am I missing?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/8857\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/a9b072f5e5f0f0858fc92a2c6cc6d01713be953b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333533376161313139396162323064376437383434353963326337356639316138303439663832636562616662643461353735313934383236303538366364662f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f38383537&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/8857\" title=\"[Partially answered myself] [Question] Problems with leveraging `cargo component` and `wasmtime-wasi` to run a &quot;plugin&quot; on the host · Issue #8857 · bytecodealliance/wasmtime\">[Partially answered myself] [Question] Problems with leveraging `cargo component` and `wasmtime-wasi` to run a \"plugin\" on the host · Issue #8857 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">EDIT: So it all boils down to: how can I invoke a function on an interface?! ORIGINAL: Okay, so I am a total noob with wasm(time) and my mistake is totally a layer 8 problem. But after digging I co...</div></div></div>",
        "id": 452865805,
        "sender_full_name": "Samuel Mwangi",
        "timestamp": 1721495610
    },
    {
        "content": "<p><code>target/wasm32-wasip1</code> suggests you didn't compile as a component, components are wasip2</p>",
        "id": 452876873,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1721501282
    },
    {
        "content": "<p>Thank you, <span class=\"user-mention\" data-user-id=\"550770\">@Ramon Klass</span> .</p>\n<p>The information you provided is incorrect though. I tried going down that path but could not get a <code>wasm32-wasip2</code> target for stable and nightly Rust toolchains.</p>\n<p>I have figured out what I was doing wrong and provided <a href=\"https://github.com/cryarchy/add-workspace-basic\">an example for future users who run into the same issue.</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/cryarchy/add-workspace-basic\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/322fe655a5e9b2a0c2049c6c5fe763b97f7d25dd/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613662646263356639313531373862653930383666343735383264386365356132633430653461626134396433663463316332323934313964353563373963372f63727961726368792f6164642d776f726b73706163652d6261736963&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/cryarchy/add-workspace-basic\" title=\"GitHub - cryarchy/add-workspace-basic: Run a basic WebAssembly component using wasmtime that exports a function named `add` through an interface.\">GitHub - cryarchy/add-workspace-basic: Run a basic WebAssembly component using wasmtime that exports a function named `add` through an interface.</a></div><div class=\"message_embed_description\">Run a basic WebAssembly component using wasmtime that exports a function named `add` through an interface. - cryarchy/add-workspace-basic</div></div></div>",
        "id": 453155719,
        "sender_full_name": "Samuel Mwangi",
        "timestamp": 1721648446
    },
    {
        "content": "<p>I'm glad you found a solution and thanks for sharing it :) My guess was really a shot in the dark, personally I've started only working with components through bindgen a long time ago, I should also do more with the lowlevel interfaces again :)</p>",
        "id": 453157267,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1721648888
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"737773\">@Samuel Mwangi</span> if there's anything you could contribute to the docs that you read which lead you down the wrong path/wasn't clear enough that would be greatly appreciated! </p>\n<p>I looked at the examples you posted and couldn't figure out what was wrong (and unlike <span class=\"user-mention\" data-user-id=\"550770\">@Ramon Klass</span> I didn't even have an educated guess to offer in trying to help) -- so it would be great if we could fix this for future users</p>",
        "id": 453213703,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1721663400
    },
    {
        "content": "<p>Hi, <span class=\"user-mention\" data-user-id=\"598440\">@Victor Adossi</span> .</p>\n<p>I will look into how I can contribute to the docs. I am trying to resolve a couple of other issues that I encountered when trying to invoke a function defined in one wasm component in another component without having to pipe the function via a wrapper as I have in <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8985\">the example associated with this issue</a>.</p>\n<p>If you have any idea on how I can go about this I will greatly appreciate any help you can offer.</p>\n<p>Once I am done. I will provide comprehensive documentation on how to set up the projects correctly and how to invoke a function exported from one wasm module in another wasm module.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/8985\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/5bd1bdc001bd2d198329af2999e8097a9d9ff0a0/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663261343934626639383032643539343664613730623835326661643537636162663330626338636432633838343736656263303832353339386633653239312f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f38393835&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/8985\" title=\"Error when calling a function defined in a wasm component from another wasm component after it's use in the host application. · Issue #8985 · bytecodealliance/wasmtime\">Error when calling a function defined in a wasm component from another wasm component after it's use in the host application. · Issue #8985 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">I have provided an example to reproduce the bug. To run the example: Run the following command from the add folder: cargo component build --release Run the following command from the calculator fol...</div></div></div>",
        "id": 453220906,
        "sender_full_name": "Samuel Mwangi",
        "timestamp": 1721665227
    },
    {
        "content": "<p>Was the core issue that you wanted to trigger the function call from one component in another, <em>without</em> the host call? </p>\n<p>Ah it looks like <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8985#issuecomment-2243633899\">Alex alreadyy helped squash the errors?</a> -- did you need more help on this issue or do you want to mark it resolved?</p>\n<p>Along with Alex's suggestion of looking into <a href=\"https://github.com/peterhuene/wac\"><code>wac</code> codebase</a>, I'd suggest also looking at/using appreciate the <a href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wasm-compose\"><code>wasm-tools compose</code> codebase</a> (and along the way, <code>wasm-tools component wit</code> &amp; <code>wasm-tools print</code>)</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/8985#issuecomment-2243633899\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/84d31f33fe1490100f8e9a062513aa36a303e09a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616161383238633164643039613439303837633463666532353932656333366433623538333764363035383966353065386364633638363631646666373463332f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f38393835&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/8985#issuecomment-2243633899\" title=\"Error when calling a function defined in a wasm component from another wasm component after it's use in the host application. · Issue #8985 · bytecodealliance/wasmtime\">Error when calling a function defined in a wasm component from another wasm component after it's use in the host application. · Issue #8985 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">I have provided an example to reproduce the bug. To run the example: Run the following command from the add folder: cargo component build --release Run the following command from the calculator fol...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/peterhuene/wac\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/fd96f69589b1e8e418965da141a063e34f1c2e83/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663338393232326162363232316636303064626239613234666665393930346430383639636539313639366232393433353632333430663533373131306231362f70657465726875656e652f776163&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/peterhuene/wac\" title=\"GitHub - peterhuene/wac: WebAssembly Composition (WAC) tooling\">GitHub - peterhuene/wac: WebAssembly Composition (WAC) tooling</a></div><div class=\"message_embed_description\">WebAssembly Composition (WAC) tooling. Contribute to peterhuene/wac development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wasm-compose\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/27caa6e08cc807168fcd41f48efdfcb7700ed9ab/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646239333861393632636335313362363037343035303831623339306334366135343362643539333464623532633432303963393339313336306438356238612f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wasm-compose\" title=\"wasm-tools/crates/wasm-compose at main · bytecodealliance/wasm-tools\">wasm-tools/crates/wasm-compose at main · bytecodealliance/wasm-tools</a></div><div class=\"message_embed_description\"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div>",
        "id": 453329136,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1721711868
    },
    {
        "content": "<p>Thank you, <span class=\"user-mention\" data-user-id=\"598440\">@Victor Adossi</span>.</p>\n<p>Yes. I wanted to invoke a function defined in one component from another without providing a host function to forward the call.</p>\n<p>Thank you for the links. I did not want to compose the components. I wanted them linked separately.</p>\n<p>It would be nice if it was possible to do something like:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">..</span><span class=\"p\">.</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">component_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">component_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instantiate_async</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">component_1</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">link_from_instance</span><span class=\"p\">(</span><span class=\"n\">instance_1</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// define the names exported from component_1 in the linker</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">interface_export</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">component_2</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">export_index</span><span class=\"p\">(</span><span class=\"nb\">None</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"package:name/interface\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fn_2_export</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">component_2</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">export_index</span><span class=\"p\">(</span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">calc_interface_export</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"s\">\"fn-2\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">component_2_instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">instantiate_async</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">component_2</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">fn_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">calc_instance</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">get_func</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fn_2_export</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">\"fn-2 function not found\"</span><span class=\"p\">);</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">Val</span><span class=\"p\">::</span><span class=\"n\">S32</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)];</span>\n<span class=\"n\">fn_2</span><span class=\"p\">.</span><span class=\"n\">call_async</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.).</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// defined in component_2 and internally invokes a function defined in component_1</span>\n\n<span class=\"o\">..</span><span class=\"p\">.</span>\n</code></pre></div>",
        "id": 453477510,
        "sender_full_name": "Samuel Mwangi",
        "timestamp": 1721755913
    },
    {
        "content": "<p>Yeah I think what you're asking for might not be possible -- is there a way you could imagine it working?</p>\n<p>The binaries are separate, so I'm not sure how they could call each other without being composed <em>or</em> something doing the call. If you are trying to achieve something like... wasm-in-wasm (i.e. trying to feed a component to another component) there is actually some really interesting work done by <span class=\"user-mention\" data-user-id=\"590805\">@Ryan Levick (rylev)</span>  on that:</p>\n<p><a href=\"https://github.com/rylev/dyna\">https://github.com/rylev/dyna</a></p>\n<p>At the end of the day you still need a host to do <em>some</em> forwarding though, so I'm not sure if this fits what you wanted!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rylev/dyna\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/608320aba027bb4263436170cf9cc8abd81a08ee/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393262386136386230626136353733313838326362643363336635376530613566653662333865383662343030373432653431336538373162636462636337662f72796c65762f64796e61&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rylev/dyna\" title=\"GitHub - rylev/dyna: Instantiate, inspect, and invoke Wasm components from within a component.\">GitHub - rylev/dyna: Instantiate, inspect, and invoke Wasm components from within a component.</a></div><div class=\"message_embed_description\">Instantiate, inspect, and invoke Wasm components from within a component. - rylev/dyna</div></div></div>",
        "id": 453744151,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1721838722
    },
    {
        "content": "<p>Thank you, <span class=\"user-mention\" data-user-id=\"598440\">@Victor Adossi</span>.</p>\n<p>The work by <span class=\"user-mention\" data-user-id=\"590805\">@Ryan Levick (rylev)</span> is pretty cool and is somewhat similar to what I was trying to achieve. The subtle difference is that the host application would be responsible for instantiating both components and generating the request piping code using the component WITs.</p>",
        "id": 453801227,
        "sender_full_name": "Samuel Mwangi",
        "timestamp": 1721856847
    }
]