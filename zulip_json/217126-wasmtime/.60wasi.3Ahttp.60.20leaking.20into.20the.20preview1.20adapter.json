[
    {
        "content": "<p>As briefly discussed in last component model meeting, it appears that somehow <code>wasi:http</code> is bleeding into the WASI preview1 adapter. Unfortunately, I do not have time to produce a minimized reproducer right now, but here's a way to reproduce it in context of wasmCloud:<br>\nThis commit <a href=\"https://github.com/rvolosatovs/wasmCloud/commit/739373ccd114bf47e8991d79ca18327cdd921d98\">https://github.com/rvolosatovs/wasmCloud/commit/739373ccd114bf47e8991d79ca18327cdd921d98</a> causes this error (e.g. <a href=\"https://github.com/rvolosatovs/wasmCloud/actions/runs/6077133453/job/16486311720\">https://github.com/rvolosatovs/wasmCloud/actions/runs/6077133453/job/16486311720</a>):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">Error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">rvolosatovs</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">github</span><span class=\"p\">.</span><span class=\"n\">com</span><span class=\"o\">/</span><span class=\"n\">wasmCloud</span><span class=\"o\">/</span><span class=\"n\">wasmCloud</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">test</span><span class=\"o\">-</span><span class=\"n\">actors</span><span class=\"o\">-</span><span class=\"mi\">255025094142</span><span class=\"n\">f50f</span><span class=\"o\">/</span><span class=\"n\">out</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">-</span><span class=\"n\">builtins</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">reactor</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span>\n\n<span class=\"w\">  </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n      <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">WASI</span><span class=\"w\"> </span><span class=\"n\">adapter</span>\n<span class=\"w\">      </span><span class=\"mi\">1</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">WIT</span><span class=\"w\"> </span><span class=\"n\">packages</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">adapter</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi_snapshot_preview1</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">packages</span>\n<span class=\"w\">      </span><span class=\"mi\">2</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span>:<span class=\"nc\">http</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">existing</span><span class=\"w\"> </span><span class=\"n\">copy</span>\n<span class=\"w\">      </span><span class=\"mi\">3</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">types</span><span class=\"err\">`</span>\n<span class=\"w\">      </span><span class=\"mi\">4</span>: <span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">incoming</span><span class=\"o\">-</span><span class=\"n\">request</span><span class=\"o\">-</span><span class=\"n\">path</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">present</span>\n</code></pre></div>\n<p>Which originates here <a href=\"https://github.com/rvolosatovs/wasmCloud/blob/739373ccd114bf47e8991d79ca18327cdd921d98/tests/actors/build.rs#L297-L302\">https://github.com/rvolosatovs/wasmCloud/blob/739373ccd114bf47e8991d79ca18327cdd921d98/tests/actors/build.rs#L297-L302</a></p>\n<p>Here's the component <a href=\"https://github.com/rvolosatovs/wasmCloud/blob/chore/upstream-http/tests/actors/rust/builtins-component-reactor/src/lib.rs\">https://github.com/rvolosatovs/wasmCloud/blob/chore/upstream-http/tests/actors/rust/builtins-component-reactor/src/lib.rs</a><br>\nHere's the WIT <a href=\"https://github.com/rvolosatovs/wasmCloud/blob/739373ccd114bf47e8991d79ca18327cdd921d98/tests/actors/rust/builtins-component-reactor/wit/actor.wit#L1-L5\">https://github.com/rvolosatovs/wasmCloud/blob/739373ccd114bf47e8991d79ca18327cdd921d98/tests/actors/rust/builtins-component-reactor/wit/actor.wit#L1-L5</a></p>\n<p>It also transitively pulls in this WIT</p>\n<ul>\n<li><a href=\"https://github.com/rvolosatovs/wasmCloud/blob/739373ccd114bf47e8991d79ca18327cdd921d98/crates/actor/src/lib.rs#L1-L6\">https://github.com/rvolosatovs/wasmCloud/blob/739373ccd114bf47e8991d79ca18327cdd921d98/crates/actor/src/lib.rs#L1-L6</a></li>\n<li><a href=\"https://github.com/rvolosatovs/wasmCloud/blob/739373ccd114bf47e8991d79ca18327cdd921d98/crates/actor/wit/interfaces.wit#L3-L14\">https://github.com/rvolosatovs/wasmCloud/blob/739373ccd114bf47e8991d79ca18327cdd921d98/crates/actor/wit/interfaces.wit#L3-L14</a></li>\n</ul>\n<p>cc <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> <span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rvolosatovs/wasmCloud/commit/739373ccd114bf47e8991d79ca18327cdd921d98\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/72241d139fa207a1362fd56d7bd7317b944a6564\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656338666633653638343462396132326630323861333131663766663435653565396539343830643038643463383030383833383430363066303762666436342f72766f6c6f7361746f76732f7761736d436c6f75642f636f6d6d69742f37333933373363636431313462663437653839393164373963613138333237636464393231643938)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rvolosatovs/wasmCloud/commit/739373ccd114bf47e8991d79ca18327cdd921d98\" title=\"test: switch to upstream http in actor · rvolosatovs/wasmCloud@739373c\">test: switch to upstream http in actor · rvolosatovs/wasmCloud@739373c</a></div><div class=\"message_embed_description\">Signed-off-by: Roman Volosatovs &lt;rvolosatovs@riseup.net&gt;</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rvolosatovs/wasmCloud/actions/runs/6077133453/job/16486311720\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/53e8e584e64a7b50dc05bb57c36005e92ecbaa83\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666635653039363866373137636261333261623364363035626531363962333431393632626537343838666538353734646464643761643238383134666136302f72766f6c6f7361746f76732f7761736d436c6f7564)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rvolosatovs/wasmCloud/actions/runs/6077133453/job/16486311720\" title=\"wasmCloud · rvolosatovs/wasmCloud@739373c\">wasmCloud · rvolosatovs/wasmCloud@739373c</a></div><div class=\"message_embed_description\">Project homepage. wasmCloud allows for simple, secure, distributed application development using WebAssembly actors and capability providers. - wasmCloud · rvolosatovs/wasmCloud@739373c</div></div></div>",
        "id": 389044581,
        "sender_full_name": "Roman Volosatovs",
        "timestamp": 1693857521
    },
    {
        "content": "<p>i believe i ran into the same issue and had to use the wit definition as specified in the <code>wasmtime-wasi</code> crate <a href=\"https://github.com/bytecodealliance/wasmtime/tree/main/crates/wasi/wit/deps/http\">here</a></p>",
        "id": 389049547,
        "sender_full_name": "Eduardo Rodrigues",
        "timestamp": 1693861431
    },
    {
        "content": "<p>Right, so we fixed that by renaming the <code>types</code>, but the point is that there <em>should not</em> be anything related to <code>wasi:http</code> inside the adapter (because the error is triggered by composing the component, it's not a Wasmtime runtime error)</p>",
        "id": 389063616,
        "sender_full_name": "Roman Volosatovs",
        "timestamp": 1693868455
    },
    {
        "content": "<p>Thanks! I'll try to take a look at this some time this week</p>",
        "id": 389196371,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1693922304
    },
    {
        "content": "<p>Looks like the adapters are coming from <code>wasmcloud-component-adapters</code> as a crate. I added that to a project and the <code>*.command.wasm</code> adapter does not reference <code>wasi:http</code>, but the <code>*.reactor.wasm</code> does. Looking at the <a href=\"https://github.com/wasmCloud/wasmcloud-component-adapters\">source for this crate</a> it looks like these adapters are downloaded from nix things (sorry I don't really understand what's going on here with nix). I see references to the 12.0.1 download URLs. I can confirm though that the 12.0.1 artifacts from Wasmtime have <code>wasi:http</code> in the <code>*.reactor.wasm</code> as well, but not <code>*.command.wasm</code>. </p>\n<p>Looks like though on the <code>dev</code> tag neither have the <code>wasi:http</code> interfaces, so this may have been a transient issue fixed on <code>main</code>?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/wasmCloud/wasmcloud-component-adapters\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/9f685c0617776bbb495ebc628fbc4ad3ac03c2a8\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316563626561613233663937613135306638306331303236356532303461626437643536646361323837616133303431336637303935336361623566666530312f7761736d436c6f75642f7761736d636c6f75642d636f6d706f6e656e742d6164617074657273)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/wasmCloud/wasmcloud-component-adapters\" title=\"GitHub - wasmCloud/wasmcloud-component-adapters\">GitHub - wasmCloud/wasmcloud-component-adapters</a></div><div class=\"message_embed_description\">Contribute to wasmCloud/wasmcloud-component-adapters development by creating an account on GitHub.</div></div></div>",
        "id": 389283596,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1693948412
    },
    {
        "content": "<p>thanks for looking into this!</p>\n<p>Nix is just used there for vendoring really, we're pulling the adapters from the Wasmtime release page and validate the contents using the digests computed by Nix and stored in <code>flake.lock</code>.<br>\nIf this is fixed in <code>main</code>, any chance this could land in a patch release for Wasmtime 12?</p>",
        "id": 389297981,
        "sender_full_name": "Roman Volosatovs",
        "timestamp": 1693954936
    },
    {
        "content": "<p>perhaps! I'm not sure what fixed it so I don't know what that would look like</p>",
        "id": 389298493,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1693955220
    },
    {
        "content": "<p>I just tested the adapter I built from <span class=\"user-mention\" data-user-id=\"253992\">@Pat Hickey</span> 's <code>pch/backpressure_2</code> branch and can confirm it is fixed. Pat mentioned it could have something to do with the build process pulling in all dependencies in the <code>wit/deps</code> directory before</p>",
        "id": 389954938,
        "sender_full_name": "Roman Volosatovs",
        "timestamp": 1694210062
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> <span class=\"user-mention\" data-user-id=\"253992\">@Pat Hickey</span> <span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span> looks like the issue might have appeared to be fixed due to dependencies accidentally being in sync, I hit it again with adapter from Wasmtime <code>dev</code> and <code>wasi:http</code> mismatch<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/issues/7266\">https://github.com/bytecodealliance/wasmtime/issues/7266</a><br>\n<a href=\"https://github.com/rvolosatovs/wasmtime-adapter-http-repro\">https://github.com/rvolosatovs/wasmtime-adapter-http-repro</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/7266\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e2c8970673be49d1611dda747f95ad54e19ba39e\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363933633331373032353931346364656463323031393436313037343762306261666239316463316135323337366565363736353732393039393961626137352f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f37323636)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/7266\" title=\"`wasi:http` bleeding into the preview2 adapter · Issue #7266 · bytecodealliance/wasmtime\">`wasi:http` bleeding into the preview2 adapter · Issue #7266 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Test Case https://github.com/rvolosatovs/wasmtime-adapter-http-repro Steps to Reproduce clone https://github.com/rvolosatovs/wasmtime-adapter-http-repro curl -sL https://github.com/bytecodealliance...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rvolosatovs/wasmtime-adapter-http-repro\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/a1998847ecc43d61dc2eaa4d2693a42cc68d47df\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656436616232666561346161343162316463333666306336636339393832346462386134303437383134623964653664646531323666626266323366346530372f72766f6c6f7361746f76732f7761736d74696d652d616461707465722d687474702d726570726f)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rvolosatovs/wasmtime-adapter-http-repro\" title=\"GitHub - rvolosatovs/wasmtime-adapter-http-repro: repro of `wasi:http` bleeding into the WASI preview2 adapter\">GitHub - rvolosatovs/wasmtime-adapter-http-repro: repro of `wasi:http` bleeding into the WASI preview2 adapter</a></div><div class=\"message_embed_description\">repro of `wasi:http` bleeding into the WASI preview2 adapter - GitHub - rvolosatovs/wasmtime-adapter-http-repro: repro of `wasi:http` bleeding into the WASI preview2 adapter</div></div></div>",
        "id": 397101909,
        "sender_full_name": "Roman Volosatovs",
        "timestamp": 1697547044
    },
    {
        "content": "<p>Thanks for the issue/repro! I'll dig in today</p>",
        "id": 397119655,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1697552386
    }
]