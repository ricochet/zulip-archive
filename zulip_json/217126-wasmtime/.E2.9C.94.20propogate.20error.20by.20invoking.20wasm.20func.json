[
    {
        "content": "<p>Hey there, I have a wasm module that is written in Rust and it's <code>main</code> function returns a <code>anyhow::Err()</code>. I noticed that if wasmtime API calls the <code>main()</code> function directly, it won't return the correct status code.  I then tried to use <code>linker.get_default()</code> and call the function, and I can see the status code returned is 1. Why does <code>instance.call()</code> won't return the same status code? </p>\n<p>Calling <code>instance.call()</code></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">module</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"n\">instance</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">get_typed_func</span>::<span class=\"o\">&lt;</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"main\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Error: ErrorWithDescription<span class=\"o\">(</span><span class=\"s2\">\"failed\"</span><span class=\"o\">)</span>\n<span class=\"o\">(</span>base<span class=\"o\">)</span> ➜  wasi-error git:<span class=\"o\">(</span>main<span class=\"o\">)</span> ✗ <span class=\"nb\">echo</span> <span class=\"nv\">$?</span>\n<span class=\"m\">0</span>\n</code></pre></div>\n<p>The above program does not return the expected status code. </p>\n<p>Calling <code>linker.get_default().call()</code></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">module</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">module</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"n\">linker</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">get_default</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">typed</span>::<span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">store</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">())</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Error: ErrorWithDescription<span class=\"o\">(</span><span class=\"s2\">\"failed\"</span><span class=\"o\">)</span>\nError: Exited with i32 <span class=\"nb\">exit</span> status <span class=\"m\">1</span>\nwasm backtrace:\n    ...\n</code></pre></div>\n<p>This program returns the correct status code 1.</p>",
        "id": 287917566,
        "sender_full_name": "Mossaka (Joe)",
        "timestamp": 1656535112
    },
    {
        "content": "<p>You need to call <code>_start</code>, not <code>main</code>. Otherwise constructors and destructors don't run. In addition <code>main</code> returns an exit code. <code>_start</code> calls <code>exit()</code> if the exit code of <code>main</code> is non-zero. The act of calling <code>exit()</code> results in the error you show.</p>",
        "id": 287925874,
        "sender_full_name": "bjorn3",
        "timestamp": 1656536891
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"487764\">mossaka</span> has marked this topic as resolved.</p>",
        "id": 287955221,
        "sender_full_name": "Notification Bot",
        "timestamp": 1656545505
    }
]