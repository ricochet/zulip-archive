[
    {
        "content": "<p>I originally mentioned this <a href=\"https://github.com/awslabs/aws-sdk-rust/issues/59#issuecomment-2055873631\">over on the aws-sdk-rust issue tracker</a> and <span class=\"user-mention\" data-user-id=\"678052\">@Landon James</span> suggested moving the conversation over here.</p>\n<p>When I add <code>aws-smithy-wasm</code> as a dependency I end up with this output in <code>cargo-component build</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">Projects</span><span class=\"o\">/</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">/</span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"n\">ec2</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"n\">dev</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.03</span><span class=\"n\">s</span>\n<span class=\"n\">error</span>: <span class=\"nc\">module</span><span class=\"w\"> </span><span class=\"n\">requires</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">env</span><span class=\"err\">`</span>\n\n<span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n   <span class=\"mi\">0</span>: <span class=\"nc\">anyhow</span>::<span class=\"n\">error</span>::<span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">anyhow</span>::<span class=\"n\">Error</span><span class=\"o\">&gt;</span>::<span class=\"n\">msg</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span>: <span class=\"nc\">anyhow</span>::<span class=\"n\">__private</span>::<span class=\"n\">format_err</span><span class=\"p\">.</span><span class=\"mi\">6620</span>\n<span class=\"w\">   </span><span class=\"mi\">2</span>: <span class=\"nc\">wit_component</span>::<span class=\"n\">encoding</span>::<span class=\"n\">world</span>::<span class=\"n\">ComponentWorld</span>::<span class=\"n\">new</span>\n<span class=\"w\">   </span><span class=\"mi\">3</span>: <span class=\"nc\">wit_component</span>::<span class=\"n\">encoding</span>::<span class=\"n\">ComponentEncoder</span>::<span class=\"n\">encode</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span>: <span class=\"nc\">cargo_component</span>::<span class=\"n\">run_cargo_command</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">   </span><span class=\"mi\">5</span>: <span class=\"nc\">cargo_component</span>::<span class=\"n\">main</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">   </span><span class=\"mi\">6</span>: <span class=\"nc\">cargo_component</span>::<span class=\"n\">main</span>\n<span class=\"w\">   </span><span class=\"mi\">7</span>: <span class=\"nc\">std</span>::<span class=\"n\">sys_common</span>::<span class=\"n\">backtrace</span>::<span class=\"n\">__rust_begin_short_backtrace</span>\n<span class=\"w\">   </span><span class=\"mi\">8</span>: <span class=\"nc\">main</span>\n<span class=\"w\">   </span><span class=\"mi\">9</span>: <span class=\"nc\">__libc_start_call_main</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">csu</span><span class=\"o\">/../</span><span class=\"n\">sysdeps</span><span class=\"o\">/</span><span class=\"n\">nptl</span><span class=\"o\">/</span><span class=\"n\">libc_start_call_main</span><span class=\"p\">.</span><span class=\"n\">h</span>:<span class=\"mi\">58</span>:<span class=\"mi\">16</span>\n<span class=\"w\">  </span><span class=\"mi\">10</span>: <span class=\"nc\">__libc_start_main_impl</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">csu</span><span class=\"o\">/../</span><span class=\"n\">csu</span><span class=\"o\">/</span><span class=\"n\">libc</span><span class=\"o\">-</span><span class=\"n\">start</span><span class=\"p\">.</span><span class=\"n\">c</span>:<span class=\"mi\">392</span>:<span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"mi\">11</span>: <span class=\"nc\">_start</span>\n</code></pre></div>\n<p>I have to admit I don't entirely understand how feature selection works, but the output of <code>cargo-tree</code> looks slightly suspicious to me:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.2</span>\n<span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">api</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"default\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">api</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"http-1x\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">types</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"default\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"default\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"default\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"default\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"default\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">└──</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"default\"</span>\n<span class=\"err\">│</span><span class=\"w\">       </span><span class=\"err\">├──</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">12.1</span><span class=\"o\">+</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"mf\">0.2.0</span>\n<span class=\"err\">│</span><span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\">   </span><span class=\"err\">└──</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"realloc\"</span>\n<span class=\"err\">│</span><span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\">       </span><span class=\"err\">└──</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">19.2</span>\n<span class=\"err\">│</span><span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\">           </span><span class=\"err\">└──</span><span class=\"w\"> </span><span class=\"n\">bitflags</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"default\"</span>\n<span class=\"err\">│</span><span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\">               </span><span class=\"err\">└──</span><span class=\"w\"> </span><span class=\"n\">bitflags</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">.</span><span class=\"mf\">5.0</span>\n<span class=\"err\">│</span><span class=\"w\">       </span><span class=\"err\">└──</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"s\">\"std\"</span>\n<span class=\"err\">│</span><span class=\"w\">           </span><span class=\"err\">└──</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">12.1</span><span class=\"o\">+</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"mf\">0.2.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>And <a href=\"https://github.com/smithy-lang/smithy-rs/blob/5f7113f506f301296311ef637e40d226e0a6e548/rust-runtime/aws-smithy-wasm/Cargo.toml\"><code>aws-smithy-wasm</code>'s <code>Cargo.toml</code></a> looks like it's pulling in various other crates with their default features enabled... which might not be intended?</p>\n<p>Here are my versions of things:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">Projects</span><span class=\"o\">/</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">/</span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"n\">ec2</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">cargo</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"mf\">0.11.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">40320</span><span class=\"n\">a9</span><span class=\"w\"> </span><span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">04</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"n\">wasi</span>:<span class=\"mi\">040</span><span class=\"n\">ec92</span><span class=\"p\">)</span>\n<span class=\"o\">~/</span><span class=\"n\">Projects</span><span class=\"o\">/</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">/</span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"n\">ec2</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"mf\">1.76.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">07</span><span class=\"n\">dca489a</span><span class=\"w\"> </span><span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">04</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Am I just holding it wrong?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/awslabs/aws-sdk-rust/issues/59#issuecomment-2055873631\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/003493a83577662ca3c1ac3b51834519eb3b98f5\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656433636263643666653338376337313262653439353330363537636134363831623638376134396435626533356366356336376536396634306161383233302f6177736c6162732f6177732d73646b2d727573742f6973737565732f3539)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/awslabs/aws-sdk-rust/issues/59#issuecomment-2055873631\" title=\"WebAssembly support · Issue #59 · awslabs/aws-sdk-rust\">WebAssembly support · Issue #59 · awslabs/aws-sdk-rust</a></div><div class=\"message_embed_description\">❗ Are you interested in using the Rust SDK in Web Assembly? Please comment on this issue with more details about your potential use case! ❗ Community Note Please vote on this issue by adding a 👍 re...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/smithy-lang/smithy-rs/blob/5f7113f506f301296311ef637e40d226e0a6e548/rust-runtime/aws-smithy-wasm/Cargo.toml\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e80a1632c048e4b806f7197f1460f6441d001368\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613237396632653934623566653366363532626362616564386135316166663461336234303061346132333736373331666661373631346436653437643136632f736d697468792d6c616e672f736d697468792d7273)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/smithy-lang/smithy-rs/blob/5f7113f506f301296311ef637e40d226e0a6e548/rust-runtime/aws-smithy-wasm/Cargo.toml\" title=\"smithy-rs/rust-runtime/aws-smithy-wasm/Cargo.toml at 5f7113f506f301296311ef637e40d226e0a6e548 · smithy-lang/smithy-rs\">smithy-rs/rust-runtime/aws-smithy-wasm/Cargo.toml at 5f7113f506f301296311ef637e40d226e0a6e548 · smithy-lang/smithy-rs</a></div><div class=\"message_embed_description\">Code generation for the AWS SDK for Rust, as well as server and generic smithy client generation. - smithy-lang/smithy-rs</div></div></div>",
        "id": 433438448,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1713240532
    },
    {
        "content": "<p>Full repro:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"n\">tmp</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n<span class=\"w\">     </span><span class=\"n\">Created</span><span class=\"w\"> </span><span class=\"n\">binary</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">application</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">bar</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">package</span>\n<span class=\"w\">     </span><span class=\"n\">Updated</span><span class=\"w\"> </span><span class=\"n\">manifest</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">bar</span><span class=\"err\">`</span>\n<span class=\"w\">   </span><span class=\"n\">Generated</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"err\">`</span>\n<span class=\"o\">/</span><span class=\"n\">tmp</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"o\">/</span>\n<span class=\"o\">/</span><span class=\"n\">tmp</span><span class=\"o\">/</span><span class=\"n\">bar</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">default</span><span class=\"o\">-</span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">Updating</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"w\"> </span><span class=\"n\">index</span>\n<span class=\"w\">      </span><span class=\"n\">Adding</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.2</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">dependencies</span><span class=\"p\">.</span>\n<span class=\"w\">    </span><span class=\"n\">Updating</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"w\"> </span><span class=\"n\">index</span>\n<span class=\"o\">/</span><span class=\"n\">tmp</span><span class=\"o\">/</span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">took</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"n\">s</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"w\">  </span><span class=\"n\">Generating</span><span class=\"w\"> </span><span class=\"n\">bindings</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">bindings</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">)</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">proc</span><span class=\"o\">-</span><span class=\"n\">macro2</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">0.80</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">pin</span><span class=\"o\">-</span><span class=\"n\">project</span><span class=\"o\">-</span><span class=\"n\">lite</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">2.14</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">unicode</span><span class=\"o\">-</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">0.12</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">6.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">autocfg</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">2.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">itoa</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">0.11</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">fnv</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">0.7</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">powerfmt</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">2.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">pin</span><span class=\"o\">-</span><span class=\"n\">utils</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">3.30</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"o\">-</span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">3.30</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">either</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">11.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">outref</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">5.1</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">once_cell</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">19.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">-</span><span class=\"n\">conv</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.2</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">vsimd</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">8.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">tokio</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">37.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">ryu</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">0.17</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">19.2</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"o\">-</span><span class=\"n\">util</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">3.30</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">bitflags</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">.</span><span class=\"mf\">5.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"o\">-</span><span class=\"n\">rt</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">24.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">percent</span><span class=\"o\">-</span><span class=\"n\">encoding</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">.</span><span class=\"mf\">3.1</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">deranged</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">3.11</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.32</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">-</span><span class=\"n\">traits</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">2.18</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">12.1</span><span class=\"o\">+</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"mf\">0.2.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">base64</span><span class=\"o\">-</span><span class=\"n\">simd</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">8.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">2.12</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"o\">-</span><span class=\"n\">utils</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.4</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">1.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">0.36</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">syn</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">.</span><span class=\"mf\">0.59</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">3.36</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"o\">-</span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">4.6</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">-</span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.46</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">2.1</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">types</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">1.8</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"o\">-</span><span class=\"n\">attributes</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.27</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.40</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">api</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">.</span><span class=\"mf\">4.0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">60.7</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">aws</span><span class=\"o\">-</span><span class=\"n\">smithy</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.2</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">tmp</span><span class=\"o\">/</span><span class=\"n\">bar</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"n\">dev</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">4.97</span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"n\">Creating</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">bar</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">error</span>: <span class=\"nc\">module</span><span class=\"w\"> </span><span class=\"n\">requires</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">env</span><span class=\"err\">`</span>\n\n<span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n   <span class=\"mi\">0</span>: <span class=\"nc\">anyhow</span>::<span class=\"n\">error</span>::<span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">anyhow</span>::<span class=\"n\">Error</span><span class=\"o\">&gt;</span>::<span class=\"n\">msg</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span>: <span class=\"nc\">anyhow</span>::<span class=\"n\">__private</span>::<span class=\"n\">format_err</span><span class=\"p\">.</span><span class=\"mi\">6620</span>\n<span class=\"w\">   </span><span class=\"mi\">2</span>: <span class=\"nc\">wit_component</span>::<span class=\"n\">encoding</span>::<span class=\"n\">world</span>::<span class=\"n\">ComponentWorld</span>::<span class=\"n\">new</span>\n<span class=\"w\">   </span><span class=\"mi\">3</span>: <span class=\"nc\">wit_component</span>::<span class=\"n\">encoding</span>::<span class=\"n\">ComponentEncoder</span>::<span class=\"n\">encode</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span>: <span class=\"nc\">cargo_component</span>::<span class=\"n\">run_cargo_command</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">   </span><span class=\"mi\">5</span>: <span class=\"nc\">cargo_component</span>::<span class=\"n\">main</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">   </span><span class=\"mi\">6</span>: <span class=\"nc\">cargo_component</span>::<span class=\"n\">main</span>\n<span class=\"w\">   </span><span class=\"mi\">7</span>: <span class=\"nc\">std</span>::<span class=\"n\">sys_common</span>::<span class=\"n\">backtrace</span>::<span class=\"n\">__rust_begin_short_backtrace</span>\n<span class=\"w\">   </span><span class=\"mi\">8</span>: <span class=\"nc\">main</span>\n<span class=\"w\">   </span><span class=\"mi\">9</span>: <span class=\"nc\">__libc_start_call_main</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">csu</span><span class=\"o\">/../</span><span class=\"n\">sysdeps</span><span class=\"o\">/</span><span class=\"n\">nptl</span><span class=\"o\">/</span><span class=\"n\">libc_start_call_main</span><span class=\"p\">.</span><span class=\"n\">h</span>:<span class=\"mi\">58</span>:<span class=\"mi\">16</span>\n<span class=\"w\">  </span><span class=\"mi\">10</span>: <span class=\"nc\">__libc_start_main_impl</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">csu</span><span class=\"o\">/../</span><span class=\"n\">csu</span><span class=\"o\">/</span><span class=\"n\">libc</span><span class=\"o\">-</span><span class=\"n\">start</span><span class=\"p\">.</span><span class=\"n\">c</span>:<span class=\"mi\">392</span>:<span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"mi\">11</span>: <span class=\"nc\">_start</span>\n</code></pre></div>",
        "id": 433438629,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1713240688
    },
    {
        "content": "<p>This chunk:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"n\">dev</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">4.97</span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"n\">Creating</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">bar</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">error</span>: <span class=\"nc\">module</span><span class=\"w\"> </span><span class=\"n\">requires</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">env</span><span class=\"err\">`</span>\n</code></pre></div>\n<p>Makes it seem like the failure is in embedding the component metadata rather than compiling the project, so I don't think that the issue has to do with un-needed features in the dependencies of <code>aws-smithy-wasm</code>. </p>\n<p>I'm wondering what version of <code>cargo-component</code> you are using and if that might be older? Or potentially the smithy crate's dependency on the <code>wasi</code> crate is out of date? I'll try to do some more digging into this tomorrow.</p>",
        "id": 433439289,
        "sender_full_name": "Landon James",
        "timestamp": 1713241134
    },
    {
        "content": "<p>In the meantime, there is a working example of this buried deep in the Rust SDK's canary package. <a href=\"https://github.com/smithy-lang/smithy-rs/tree/main/tools/ci-cdk/canary-wasm\">https://github.com/smithy-lang/smithy-rs/tree/main/tools/ci-cdk/canary-wasm</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/smithy-lang/smithy-rs/tree/main/tools/ci-cdk/canary-wasm\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e80a1632c048e4b806f7197f1460f6441d001368\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613237396632653934623566653366363532626362616564386135316166663461336234303061346132333736373331666661373631346436653437643136632f736d697468792d6c616e672f736d697468792d7273)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/smithy-lang/smithy-rs/tree/main/tools/ci-cdk/canary-wasm\" title=\"smithy-rs/tools/ci-cdk/canary-wasm at main · smithy-lang/smithy-rs\">smithy-rs/tools/ci-cdk/canary-wasm at main · smithy-lang/smithy-rs</a></div><div class=\"message_embed_description\">Code generation for the AWS SDK for Rust, as well as server and generic smithy client generation. - smithy-lang/smithy-rs</div></div></div>",
        "id": 433439427,
        "sender_full_name": "Landon James",
        "timestamp": 1713241259
    },
    {
        "content": "<p>Weird, I am able to repro your issue, but I can also build<br>\none of my projects  using it just fine and I’m not sure what the difference is. The SDK does rely on env to work in WASI (mostly to load credentials from environment variables), but I don’t think you should have to do anything to link it in</p>",
        "id": 433440963,
        "sender_full_name": "Landon James",
        "timestamp": 1713242412
    },
    {
        "content": "<p>Ah the <code>env</code> module is the default module emitted by LLD for unresolved symbols, so what you're hitting is something that should be a link-time error but ends up getting papered over for tooling to fail later down the road. I'd recomend <code>wasm-tools print</code>-ing the file and looking at what the symbol is under the <code>env</code> module as that'll help provide a clue as to what library is pulling in a symbol that needs adjusting.</p>\n<p>Orthogonally and independently it'd probably be good to improve the error message here to say more than just <code>env</code> as well!</p>",
        "id": 433533034,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713277005
    },
    {
        "content": "<p>Printing the <code>cargo-component</code> init (with the <code>aws-smithy-wasm</code> import) file shows the below:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code>  <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"env\"</span> <span class=\"s2\">\"cabi_realloc_wit_bindgen_0_19_2\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$cabi_realloc_wit_bindgen_0_19_2</span> <span class=\"cm\">(;4;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">7</span><span class=\"p\">)))</span>\n</code></pre></div>\n<p>So it seems like it should be getting <code>env</code> from <code>wit-bindgen</code>? Full wat file included if it helps.</p>\n<p><a href=\"/user_uploads/15107/8RrO1cbIu97oWhxM5fGCoITE/bar.wat\">bar.wat</a></p>",
        "id": 433556691,
        "sender_full_name": "Landon James",
        "timestamp": 1713283136
    },
    {
        "content": "<p>Do you have a dep on <code>wit-bindgen</code> somewhere? <code>cargo-component</code> projects currently should only have a dep on <code>wit-bindgen-rt</code></p>",
        "id": 433557529,
        "sender_full_name": "Peter Huene",
        "timestamp": 1713283372
    },
    {
        "content": "<p><code>aws-smithy-wasm</code> depends on the <code>wasi</code> crate which depends directly on <code>wit-bindgen</code>, so it is in there transitively, but not directly</p>",
        "id": 433557942,
        "sender_full_name": "Landon James",
        "timestamp": 1713283482
    },
    {
        "content": "<p>that should be fine then, not sure why it isn't linking in realloc though</p>",
        "id": 433558118,
        "sender_full_name": "Peter Huene",
        "timestamp": 1713283535
    },
    {
        "content": "<p>Possibly-unrelated, what's up with <code>cabi_realloc_wit_bindgen_0_19_2</code>? I saw this the other day and didn't recognize the suffix.</p>",
        "id": 433558406,
        "sender_full_name": "Lann Martin",
        "timestamp": 1713283602
    },
    {
        "content": "<p>I think that suffix is due to another issue I encountered a few weeks ago:<br>\nissue: <a href=\"https://github.com/bytecodealliance/wit-bindgen/issues/849\">https://github.com/bytecodealliance/wit-bindgen/issues/849</a><br>\nfix: <a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/851\">https://github.com/bytecodealliance/wit-bindgen/pull/851</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/issues/849\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/6876d0efae67dfa572efa6c9423a7228f7849884\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653939353864666462656138383964656531633239303862386465663634373632623832396431363637383537346633616630353665333963613666653834302f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f6973737565732f383439)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/issues/849\" title=\"Compilation error when multiple versions of `wit-bindgen` present in project · Issue #849 · bytecodealliance/wit-bindgen\">Compilation error when multiple versions of `wit-bindgen` present in project · Issue #849 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">When there are multiple versions of wit-bindgen present in a project compilation fails with an error like: = note: rust-lld: error: duplicate symbol: cabi_realloc &gt;&gt;&gt; defined in /Volumes/workplace/...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/pull/851\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/fd6f3ab87ad13a4ef82d961e97947008e62b4c38\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663863346539613061326361626131613763323562393161306630376635623435363963613436616166373239323565626137393239643232353931306138352f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f383531)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/851\" title=\"rust: Define `cabi_realloc` as a weak symbol by alexcrichton · Pull Request #851 · bytecodealliance/wit-bindgen\">rust: Define `cabi_realloc` as a weak symbol by alexcrichton · Pull Request #851 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">This commit updates the wit-bindgen Rust crate to define the cabi_realloc symbol as a weak symbol. This is not easy because Rust does not offer a stable means by which to do this. Despite this thro...</div></div></div>",
        "id": 433558824,
        "sender_full_name": "Landon James",
        "timestamp": 1713283720
    },
    {
        "content": "<p>i think it is an attempt to allow linkage against multiple wit-bindgen deps of differing versions; alex or dan have the context there iirc</p>",
        "id": 433558825,
        "sender_full_name": "Peter Huene",
        "timestamp": 1713283720
    },
    {
        "content": "<p>Yeah. When you have multiple expansions of the wit-bindgen bindings linked into the same program, it's a way to make their <code>cabi_realloc</code>s not collide.</p>",
        "id": 433571635,
        "sender_full_name": "Dan Gohman",
        "timestamp": 1713287808
    },
    {
        "content": "<p>hm the fact that this symbol is imported indicates a bug in something in wit-bindgen/wasi/etc for sure</p>",
        "id": 433575705,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713289463
    },
    {
        "content": "<p>Given the repro here I'll try to dig into this this week and see if I can't figure out what's going wrong</p>",
        "id": 433575825,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713289521
    },
    {
        "content": "<p>I just blew out my Cargo.lock and rebuilt my previously working project and hit the same error, so this is likely something fairly new. I think I first built that project about 2 weeks ago, so probably something in that timeframe?</p>",
        "id": 433577203,
        "sender_full_name": "Landon James",
        "timestamp": 1713290129
    },
    {
        "content": "<p>I've reduced this to:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[package]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bar\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.1.0\"</span>\n<span class=\"n\">edition</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2021\"</span>\n\n<span class=\"k\">[dependencies]</span>\n<span class=\"n\">wit-bindgen-rt1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.24.0\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"s1\">'wit-bindgen-rt'</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"n\">wit-bindgen-rt2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.23.0\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"s1\">'wit-bindgen-rt'</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>and </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wit_bindgen_rt1</span>::<span class=\"n\">maybe_link_cabi_realloc</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>My current suspicion is that both versions of wit-bindgen use <code>libwit_bindgen_cabi_realloc.a</code> as a library name. Still digging though</p>",
        "id": 433616966,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713306361
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"470250\">@Jeff Parsons</span> do you have a larger reproduction of this issue?</p>\n<p>I ask because your current issue as-stated above can be fixed with:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">extern</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"w\"> </span><span class=\"n\">aws_smithy_wasm</span><span class=\"p\">;</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>\n</code></pre></div>\n<p>I opened <a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/928\">https://github.com/bytecodealliance/wit-bindgen/pull/928</a> to fix that specific issue, but linking is often weird and surprising. If you have a larger reproduction I'd like to test that the fix in that PR fixes the issue as well in case there's something else I'm missing</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/pull/928\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/7bd55dbed8d970755b3753aa27f8fe1b4aa3d0db\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393430336230376239343966353937346664393834663864613035393161653134613339383765363831653137333337633935336265666238653166363033382f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f393238)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/928\" title=\"Use a unique name for `libwit_bindgen_cabi_realloc.a` per-crate-version by alexcrichton · Pull Request #928 · bytecodealliance/wit-bindgen\">Use a unique name for `libwit_bindgen_cabi_realloc.a` per-crate-version by alexcrichton · Pull Request #928 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">This commit updates how the weak cabi_realloc symbol is linked. Previously rustc was told to use -lwit_bindgen_cabi_realloc with a -L pointing to the source directory of the crate which has a preco...</div></div></div>",
        "id": 433620709,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713308430
    },
    {
        "content": "<p>b/c the fix I have relies on a crate not actually being used, which seems unlikely in a larger reproduction situation</p>",
        "id": 433620744,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713308447
    },
    {
        "content": "<p>Wow, that is wild. I don't have one at hand, but when I get a chance I will try to make a \"realistic use\" repro.</p>\n<p>BTW, the context for all this was roughly:</p>\n<ul>\n<li>OMG, <code>aws-sdk-ec2</code> builds are killing me (and my machine, and my colleagues).</li>\n<li>I know: I'll wrap it up in a Wasm Component, and then I can just build it on CI. (We don't have Mac CI workers, but all dev machines are MacBooks.)</li>\n<li>This issue. </li>\n</ul>\n<p>I'm unlikely to be near a computer today, but when I am I will push that \"realistic use\" repro somewhere and link it here. </p>\n<p>Thanks, y'all! <span aria-label=\"sparkling heart\" class=\"emoji emoji-1f496\" role=\"img\" title=\"sparkling heart\">:sparkling_heart:</span></p>",
        "id": 433621753,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1713308972
    },
    {
        "content": "<p>(Also, this feels like a great excuse to sneak Wasm in the door at work. <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span>)</p>",
        "id": 433622132,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1713309216
    },
    {
        "content": "<p>no worries! This may not actually reproduce in a larger context which in that case I'll publish a fix once it's merged</p>",
        "id": 433622901,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713309735
    },
    {
        "content": "<p>Sweet, once you do get around to having it work on your machine feel free to reach out if you have anymore questions about the AWS Rust SDK with wasm bits! As far as I know I'm the only one using it so far so would love to get some extra eyes on it and find any lingering bugs I might have missed.</p>",
        "id": 433623490,
        "sender_full_name": "Landon James",
        "timestamp": 1713310166
    },
    {
        "content": "<p>I can confirm that</p>\n<ol>\n<li>If I actually _use_ something from the crate, e.g., <code>let wasi_http_client = aws_smithy_wasm::wasi::WasiHttpClientBuilder::new().build();</code> then this error no longer occurs.</li>\n<li>Adding <code>extern crate aws_smithy_wasm;</code>also makes it go away.</li>\n</ol>\n<p>I guess I hit this one when nobody else did because... I work in a strange way sometimes. :)</p>\n<p>Working-ish code is here: <a href=\"https://github.com/jeffparsons/aws-wasm-components\">https://github.com/jeffparsons/aws-wasm-components</a>. It can talk to an AWS server! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> (Haven't gotten auth working yet, but that's off-topic.)</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/jeffparsons/aws-wasm-components\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/5a6c271700a18d9a0ba8059105ca71a92220ed27\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306234373838343837313334663863626266353462643063313931323736373730326538393332333365373961636139323530343838633638343264346662612f6a656666706172736f6e732f6177732d7761736d2d636f6d706f6e656e7473)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/jeffparsons/aws-wasm-components\" title=\"GitHub - jeffparsons/aws-wasm-components\">GitHub - jeffparsons/aws-wasm-components</a></div><div class=\"message_embed_description\">Contribute to jeffparsons/aws-wasm-components development by creating an account on GitHub.</div></div></div>",
        "id": 433633280,
        "sender_full_name": "Jeff Parsons",
        "timestamp": 1713317975
    },
    {
        "content": "<p>Ok sounds good, and thanks regardless for the report!</p>",
        "id": 433634456,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713318994
    }
]