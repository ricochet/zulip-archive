[
    {
        "content": "<p>Hello, I have a Rust workspace with multiple packages in it, each one with its own unit and integration tests.<br>\nNow, I want to have a single wasm file with all tests, how can I do it? </p>\n<p>I tried using <code>wasm-merge --rename-export-conflicts</code> but, if I have two test files <code>test1.wasm</code> and <code>test2.wasm</code>, when I merge them into <code>merge.wasm</code>, only the tests in first one in the order are executed when running on a wasm runtime.</p>\n<p>If I look at the wat representation, I see that both <code>test1.wasm</code> and <code>test2.wasm</code> export <code>__main_void</code> and <code>_start</code>. The <code>merge.wasm</code> that I generate also contains  <code>__main_void</code> and <code>_start</code>.<br>\nIs there any workaround, like making tests export a different function name, so that I can call them directly from the runtime when running <code>merge.wasm</code>?</p>\n<p>Thanks</p>",
        "id": 425065597,
        "sender_full_name": "Enrico Loparco",
        "timestamp": 1709724962
    },
    {
        "content": "<p>I think you did have to first have to rewrite all modules to rename their <code>_start</code> to unique names, then write a new module with <code>_start</code> which calls all renamed <code>_start</code> in order and then merge all these modules together. <code>__main_void</code> is generated by rustc and there is no way to make rustc use a different name. <code>__main_void</code> is called by <code>_start</code> and should never be called directly. <code>_start</code> is defined by the crt1.o of wasi-libc, which comes precompiled. Because of this all I think directly rewriting the wasm modules to change the export names is the best option you have. The alternative would be to skip rustc's testing infrastructure entirely and compile every test crate as <code>cdylib</code> and have them export a single function with a unique name which internally calls all tests.</p>",
        "id": 425132391,
        "sender_full_name": "bjorn3",
        "timestamp": 1709743616
    }
]