[
    {
        "content": "<p>I am embedding Wasmtime in a program which eventually creates child processes. Currently, the embedding goes as such:</p>\n<ol>\n<li>Parent process creates a store and loads wasm_module_t via wasmtime_module_new() in order to validate each module, imports, etc...</li>\n<li>Parent process calls fork() and create a child process</li>\n<li>Child process creates new stores and instantiates said modules from the modules created in step 1. (thanks to CoW)</li>\n<li>All is well but when the child process exits (after closing all instances and stores), Valgrind reports the following memory leaks (see below)</li>\n</ol>\n<p>I don't know what is causing those but I suspect the fork isn't carrying all necessary Rayon resources to the child process; any idea what is going on here? Should loaded stores not be forked at all?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"mi\">024</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"n\">direct</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"n\">indirect</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">blocks</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">definitely</span><span class=\"w\"> </span><span class=\"n\">lost</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">loss</span><span class=\"w\"> </span><span class=\"n\">record</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"mh\">0x4840B65</span>: <span class=\"nc\">calloc</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">vg_replace_malloc</span><span class=\"p\">.</span><span class=\"n\">c</span>:<span class=\"mi\">760</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x52FAE72</span>: <span class=\"nc\">__cxa_thread_atexit_impl</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">libc</span><span class=\"o\">-</span><span class=\"mf\">2.33.</span><span class=\"n\">so</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CBD759</span>: <span class=\"nc\">try_register_dtor</span><span class=\"o\">&lt;</span><span class=\"n\">crossbeam_epoch</span>::<span class=\"n\">collector</span>::<span class=\"n\">LocalHandle</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">490</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CBD759</span>: <span class=\"nc\">_ZN3std6thread5local4fast12Key</span><span class=\"cp\">$LT$T$GT$</span><span class=\"mi\">14</span><span class=\"n\">try_initialize17h9f6740ecb45ddd03E</span><span class=\"p\">.</span><span class=\"n\">llvm</span><span class=\"p\">.</span><span class=\"mi\">8233611950401219567</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">471</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB6922</span>: <span class=\"nc\">try_with</span><span class=\"o\">&lt;</span><span class=\"n\">crossbeam_epoch</span>::<span class=\"n\">collector</span>::<span class=\"n\">LocalHandle</span><span class=\"p\">,</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"kt\">bool</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">271</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB6922</span>: <span class=\"nc\">with_handle</span><span class=\"o\">&lt;</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"kt\">bool</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">default</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">43</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB6922</span>: <span class=\"nc\">is_pinned</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">default</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">30</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB6922</span>: <span class=\"nc\">crossbeam_deque</span>::<span class=\"n\">deque</span>::<span class=\"n\">Stealer</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span>::<span class=\"n\">steal</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">deque</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">619</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB7D0A</span>: <span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">registry</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">779</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB7D0A</span>: <span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"p\">,</span><span class=\"n\">rayon_core</span>::<span class=\"n\">job</span>::<span class=\"n\">JobRef</span><span class=\"p\">,</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iterator</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">2257</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB7D0A</span>: <span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"p\">,(),</span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">control_flow</span>::<span class=\"n\">ControlFlow</span><span class=\"o\">&lt;</span><span class=\"n\">rayon_core</span>::<span class=\"n\">job</span>::<span class=\"n\">JobRef</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1078</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB7D0A</span>: <span class=\"nc\">call_mut</span><span class=\"o\">&lt;</span><span class=\"p\">((),</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">),</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">function</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">269</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB7D0A</span>: <span class=\"nc\">try_fold</span><span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">range</span>::<span class=\"n\">Range</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"o\">&gt;</span><span class=\"p\">,(),</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">control_flow</span>::<span class=\"n\">ControlFlow</span><span class=\"o\">&lt;</span><span class=\"n\">rayon_core</span>::<span class=\"n\">job</span>::<span class=\"n\">JobRef</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iterator</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1888</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB7D0A</span>: <span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">iter</span>::<span class=\"n\">adapters</span>::<span class=\"n\">chain</span>::<span class=\"n\">Chain</span><span class=\"o\">&lt;</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"n\">B</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">iter</span>::<span class=\"n\">traits</span>::<span class=\"n\">iterator</span>::<span class=\"nb\">Iterator</span><span class=\"o\">&gt;</span>::<span class=\"n\">try_fold</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">chain</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">105</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB2AFC</span>: <span class=\"nc\">try_fold</span><span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">iter</span>::<span class=\"n\">adapters</span>::<span class=\"n\">chain</span>::<span class=\"n\">Chain</span><span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">range</span>::<span class=\"n\">Range</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">range</span>::<span class=\"n\">Range</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"p\">,(),</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">control_flow</span>::<span class=\"n\">ControlFlow</span><span class=\"o\">&lt;</span><span class=\"n\">rayon_core</span>::<span class=\"n\">job</span>::<span class=\"n\">JobRef</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1127</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB2AFC</span>: <span class=\"nc\">find_map</span><span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">iter</span>::<span class=\"n\">adapters</span>::<span class=\"n\">Filter</span><span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">iter</span>::<span class=\"n\">adapters</span>::<span class=\"n\">chain</span>::<span class=\"n\">Chain</span><span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">range</span>::<span class=\"n\">Range</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">range</span>::<span class=\"n\">Range</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"n\">rayon_core</span>::<span class=\"n\">job</span>::<span class=\"n\">JobRef</span><span class=\"p\">,</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iterator</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">2263</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB2AFC</span>: <span class=\"nc\">steal</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">registry</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">774</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB2AFC</span>: <span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">registry</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">726</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB2AFC</span>: <span class=\"nc\">or_else</span><span class=\"o\">&lt;</span><span class=\"n\">rayon_core</span>::<span class=\"n\">job</span>::<span class=\"n\">JobRef</span><span class=\"p\">,</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">option</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">786</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB2AFC</span>: <span class=\"nc\">rayon_core</span>::<span class=\"n\">registry</span>::<span class=\"n\">WorkerThread</span>::<span class=\"n\">wait_until_cold</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">registry</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">724</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB1349</span>: <span class=\"nc\">wait_until</span><span class=\"o\">&lt;</span><span class=\"n\">rayon_core</span>::<span class=\"n\">latch</span>::<span class=\"n\">CountLatch</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">registry</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">704</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB1349</span>: <span class=\"nc\">main_loop</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">registry</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">837</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB1349</span>: <span class=\"nc\">rayon_core</span>::<span class=\"n\">registry</span>::<span class=\"n\">ThreadBuilder</span>::<span class=\"n\">run</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">registry</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">56</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB4A24</span>: <span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">registry</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">101</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB4A24</span>: <span class=\"nc\">std</span>::<span class=\"n\">sys_common</span>::<span class=\"n\">backtrace</span>::<span class=\"n\">__rust_begin_short_backtrace</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">backtrace</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">125</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB451C</span>: <span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span><span class=\"o\">&lt;</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"p\">,()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">474</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB451C</span>: <span class=\"nc\">call_once</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">panic</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">322</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB451C</span>: <span class=\"nc\">do_call</span><span class=\"o\">&lt;</span><span class=\"n\">std</span>::<span class=\"n\">panic</span>::<span class=\"n\">AssertUnwindSafe</span><span class=\"o\">&lt;</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"p\">,()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">panicking</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">381</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB451C</span>: <span class=\"nc\">try</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"n\">std</span>::<span class=\"n\">panic</span>::<span class=\"n\">AssertUnwindSafe</span><span class=\"o\">&lt;</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">panicking</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">345</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB451C</span>: <span class=\"nc\">catch_unwind</span><span class=\"o\">&lt;</span><span class=\"n\">std</span>::<span class=\"n\">panic</span>::<span class=\"n\">AssertUnwindSafe</span><span class=\"o\">&lt;</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"p\">,()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">panic</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">396</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB451C</span>: <span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span><span class=\"o\">&lt;</span><span class=\"n\">closure</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"p\">,()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">473</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4CB451C</span>: <span class=\"nc\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">function</span>::<span class=\"nb\">FnOnce</span>::<span class=\"n\">call_once</span><span class=\"p\">{{</span><span class=\"n\">vtable</span><span class=\"o\">-</span><span class=\"n\">shim</span><span class=\"p\">}}</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">function</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">227</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4FE5AF9</span>: <span class=\"nc\">call_once</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"nb\">FnOnce</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"n\">alloc</span>::<span class=\"n\">alloc</span>::<span class=\"n\">Global</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">boxed</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1307</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4FE5AF9</span>: <span class=\"nc\">call_once</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"n\">alloc</span>::<span class=\"n\">boxed</span>::<span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"nb\">FnOnce</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alloc</span>::<span class=\"n\">alloc</span>::<span class=\"n\">Global</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"n\">alloc</span>::<span class=\"n\">alloc</span>::<span class=\"n\">Global</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">boxed</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1307</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4FE5AF9</span>: <span class=\"nc\">std</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span>::<span class=\"n\">thread</span>::<span class=\"n\">Thread</span>::<span class=\"n\">new</span>::<span class=\"n\">thread_start</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">thread</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">71</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x4881298</span>: <span class=\"nc\">start_thread</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">libpthread</span><span class=\"o\">-</span><span class=\"mf\">2.33.</span><span class=\"n\">so</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">==</span><span class=\"mi\">298987</span><span class=\"o\">==</span><span class=\"w\">    </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"mh\">0x53BA152</span>: <span class=\"nc\">clone</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">libc</span><span class=\"o\">-</span><span class=\"mf\">2.33.</span><span class=\"n\">so</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 226567682,
        "sender_full_name": "Thibault Charbonnier",
        "timestamp": 1613505554
    },
    {
        "content": "<p>2nd Valgrind report was too long, attached here: <a href=\"/user_uploads/15107/7VlRMdMKYd99qqa7HJgilW0E/valgrind.out\">valgrind.out</a></p>",
        "id": 226568000,
        "sender_full_name": "Thibault Charbonnier",
        "timestamp": 1613505686
    },
    {
        "content": "<p>AFAIK a leak like that is likely due to not joining on all child threads before the program exits (e.g. the rayon workers), and is generally a false positive</p>",
        "id": 226570305,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1613506653
    },
    {
        "content": "<p>I'm not sure if rayon provides a way to shut down its thread pool</p>",
        "id": 226570334,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1613506662
    },
    {
        "content": "<p>Ah, thank you <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span>! I've been treating them as false positives so far but really wanted to hear a more informed opinion.</p>",
        "id": 226572943,
        "sender_full_name": "Thibault Charbonnier",
        "timestamp": 1613507897
    },
    {
        "content": "<p>I don't think it is very safe to call <code>fork()</code> after calling <code>wasmtime_module_new</code>. It spawned new threads. Unless your process is guaranteed to be single-threaded, it is generally a bad idea to <code>fork()</code>. After a <code>fork()</code> only the current thread exists in the new process, which will lead to dead-locks if any of the other threads were holding a lock. While Wasmtime currently waits for all compilation threads to finish their job before returning from <code>wasmtime_module_new</code>, this is not guaranteed, though it unlikely to change I think. What I would be more worried about it rayon not playing nice with <code>fork()</code> and maybe expecting that the worker threads still exist in the new thread.</p>",
        "id": 226631117,
        "sender_full_name": "bjorn3",
        "timestamp": 1613553488
    },
    {
        "content": "<p>I believe you are right <span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> and thank you for the heads-up. This is exactly what I'm observing, so good to know, I'll make the necessary changes. <br>\nCould this limitation around <code>fork()</code> be somewhat limiting for server-side embedding use-cases then? This seems to be Rayon's side to the story on shutting down thread pools: <a href=\"https://github.com/rayon-rs/rayon/issues/688\">https://github.com/rayon-rs/rayon/issues/688</a>. Would running <code>wasmtime_module_new</code> single-threaded be a foolish thing to do/allow?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rayon-rs/rayon/issues/688\" style=\"background-image: url(https://avatars.githubusercontent.com/u/32576850?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rayon-rs/rayon/issues/688\" title=\"Consider adding an easier way of synchronously shutting down a thread-pool. 路 Issue #688 路 rayon-rs/rayon\">Consider adding an easier way of synchronously shutting down a thread-pool. 路 Issue #688 路 rayon-rs/rayon</a></div><div class=\"message_embed_description\">AFAICT ThreadPool::drop is async, so there&#39;s no easy way to ensure that all threads have shot down. Ideally, I&#39;d like the guarantee of all threads having shot down, including running TLS de...</div></div></div>",
        "id": 227051985,
        "sender_full_name": "Thibault Charbonnier",
        "timestamp": 1613781918
    }
]