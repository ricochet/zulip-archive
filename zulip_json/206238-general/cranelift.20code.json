[
    {
        "content": "<p>Hi, I just asked this community about linear memory, and thanks to <span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> , I finally found the code that I have to work on. Looking into the code for hours, got some questions. I have a poor understanding on JITs or Interpreters, so the following codes were very confusing. Such as</p>\n<p>let adj_bound = pos.ins().iadd_imm(bound, -(access_size as i64));<br>\nor<br>\npos.func.dfg.replace(inst).iconst(addr_ty, 0);<br>\nor<br>\nlet final_addr = pos.ins().iadd(base, offset);</p>\n<p>My guess is, that they are generating Cranelift IR, which will further be optimized and turned into platform specific machine code. Am I right? But the fact that some of these codes are \"returning\" a value is so confusing. What are they returning? If they are returning the result of the instruction, why bother turn them into a machine code and execute it again even if we know the result? Sorry for my poor english and understanding of the topic. Any reply will help.</p>",
        "id": 223217839,
        "sender_full_name": "Minyeong Jeong",
        "timestamp": 1611058534
    },
    {
        "content": "<p>You could think about the \"Value\"s accepted and returned from these functions as a register names or stack locations. They don't define the actual value, but only the location at which it would appear at runtime.</p>",
        "id": 223223032,
        "sender_full_name": "bjorn3",
        "timestamp": 1611061660
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"381260\">@Minyeong Jeong</span> you can get a pretty good overview of this sort of code generation by understanding the IR (intermediate representation) formats such as CLIF (Cranelift's IR) or LLVM's IR. Typically these IRs write instructions like \"result = add(arg1, arg2)\". That's an add instruction, but we just write the destination \"register\" on the left; it's just different notation :-)  The code that generates the IR will look like that. The operations are not running at compile time; all of the args and results are symbolic (registers or other sorts of values, as bjorn3 says).</p>",
        "id": 223257624,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1611076077
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> <span class=\"user-mention\" data-user-id=\"254389\">@Chris Fallin</span>  thank you and thank you again, for your kind explanation to a beginner. Appreciate it!</p>",
        "id": 223336657,
        "sender_full_name": "Minyeong Jeong",
        "timestamp": 1611124042
    },
    {
        "content": "<p>I have trouble understanding the code from dynamic_heap. </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">ins</span><span class=\"p\">().</span><span class=\"n\">global_value</span><span class=\"p\">(</span><span class=\"n\">offset_ty</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bound_gv</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">cc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">access_size</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"c1\">// `offset &gt; bound - 1` is the same as `offset &gt;= bound`.</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">IntCC</span>::<span class=\"n\">UnsignedGreaterThanOrEqual</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">access_size</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">min_size</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"c1\">// We know that bound &gt;= min_size, so here we can compare `offset &gt; bound - access_size`</span>\n<span class=\"w\">        </span><span class=\"c1\">// without wrapping.</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">adj_bound</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">ins</span><span class=\"p\">().</span><span class=\"n\">iadd_imm</span><span class=\"p\">(</span><span class=\"n\">bound</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"p\">(</span><span class=\"n\">access_size</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">));</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">IntCC</span>::<span class=\"n\">UnsignedGreaterThan</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">adj_bound</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"c1\">// We need an overflow check for the adjusted offset.</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">access_size_val</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">ins</span><span class=\"p\">().</span><span class=\"n\">iconst</span><span class=\"p\">(</span><span class=\"n\">offset_ty</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">access_size</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">adj_offset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">ins</span><span class=\"p\">().</span><span class=\"n\">iadd_ifcout</span><span class=\"p\">(</span><span class=\"n\">offset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">access_size_val</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">ins</span><span class=\"p\">().</span><span class=\"n\">trapif</span><span class=\"p\">(</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">isa</span><span class=\"p\">.</span><span class=\"n\">unsigned_add_overflow_condition</span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">overflow</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">ir</span>::<span class=\"n\">TrapCode</span>::<span class=\"n\">HeapOutOfBounds</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">IntCC</span>::<span class=\"n\">UnsignedGreaterThan</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">adj_offset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">};</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Can someone explain how can they assure that there is no overflow from the second condition of if statement? I just generally don't get it why they have to split the last to conditions, and why one adjusts offset and one adjusts bound.</p>",
        "id": 223336810,
        "sender_full_name": "Minyeong Jeong",
        "timestamp": 1611124266
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"381260\">@Minyeong Jeong</span> can you expand what you mean by \"second condition of if statement\"? Do you mean the \"else if\" body?</p>\n<p>One key invariant in that code that might be useful is that we know that <code>bound</code> is at least <code>min_size</code>; in other words, the heap is always at least <code>min_size</code>. Given <code>access_size &lt;= min_size</code> in this branch, and given <code>min_size &lt;= bound</code> by that invariant, we have <code>access_size &lt;= bound</code>, so the <code>bound - access_size</code> expression is always nonnegative.</p>",
        "id": 223338024,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1611125820
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254389\">@Chris Fallin</span> Thank you for your kind explanation and sparing your valuable time. The answer was exactly about what I was curious about.</p>",
        "id": 223463451,
        "sender_full_name": "Minyeong Jeong",
        "timestamp": 1611196562
    },
    {
        "content": "<p>Hi, this may be a very nooby qerstion to ask, but as there is no representation of arrays in Cranelift, how would I go about representing an array of for example, int32? Is it possible?</p>",
        "id": 252872378,
        "sender_full_name": "Ron Shavit",
        "timestamp": 1631323855
    },
    {
        "content": "<p>Arrays go in memory, and your local variable is instead the pointer to the array</p>",
        "id": 252877785,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1631330438
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"344989\">Mario Carneiro</span> <a href=\"#narrow/stream/206238-general/topic/cranelift.20code/near/252877785\">said</a>:</p>\n<blockquote>\n<p>Arrays go in memory, and your local variable is instead the pointer to the array</p>\n</blockquote>\n<p>Oh I'm dumb :)<br>\nI haven't touched c in so long that I forgot, thank you!</p>",
        "id": 252905586,
        "sender_full_name": "Ron Shavit",
        "timestamp": 1631362678
    },
    {
        "content": "<p>hello I'm getting this error whenever I try to call a function from <code>_start</code> function:<br>\n<code>thread 'main' panicked at 'index out of bounds: the len is 0 but the index is 0', home/.cargo/registry/src/github.com-1ecc6299db9ec823/cranelift-codegen-0.79.0/src/ir/dfg.rs:707:44     note: run with </code>RUST_BACKTRACE=1<code> environment variable to display a backtrace</code></p>",
        "id": 265986980,
        "sender_full_name": "dammi-i",
        "timestamp": 1640334834
    },
    {
        "content": "<p>That panic indicates that you are trying to call a function that isn't declared inside the current <code>Function</code>. Make sure that you use declare_func_in_func to get the <code>FuncRef</code> for every function you use it in instead of reusing it across codegen of different functions.</p>",
        "id": 266010463,
        "sender_full_name": "bjorn3",
        "timestamp": 1640361498
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"466174\">@dammi-i</span></p>",
        "id": 266010467,
        "sender_full_name": "bjorn3",
        "timestamp": 1640361510
    },
    {
        "content": "<p>thanks!!, one question btw how would I call libc functions eg printf</p>",
        "id": 266031807,
        "sender_full_name": "dammi-i",
        "timestamp": 1640390479
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"466174\">@dammi-i</span> You can use <code>module.declare_function(\"printf\", Linkage::Import, &amp;printf_signature)</code>.</p>",
        "id": 266070665,
        "sender_full_name": "bjorn3",
        "timestamp": 1640457928
    },
    {
        "content": "<p>And similar for other functions.</p>",
        "id": 266070670,
        "sender_full_name": "bjorn3",
        "timestamp": 1640457955
    },
    {
        "content": "<p>for some reasons it seems to segfault when I call a libc  function here is the code: <a href=\"https://paste.rs/vYL.rs\">https://paste.rs/vYL.rs</a> let me know what is wrong. I used <code>cc</code> to link the object file with libc (arch: aarc64, os: linux)<br>\nand thanks!</p>",
        "id": 266149256,
        "sender_full_name": "dammi-i",
        "timestamp": 1640585368
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"466174\">@dammi-i</span>  Why is the <code>module.declare_func_in_func</code> commented out? Your code works fine on x86_64 with <code>cc out.o -o out</code>. It also works fine when cross compiling to aarch64-unknown-linux-gnu and then using qemu. Can you do <code>objdump -dr ./out</code>? (assuming you name the linked executable <code>./out</code>)</p>",
        "id": 266169958,
        "sender_full_name": "bjorn3",
        "timestamp": 1640609298
    },
    {
        "content": "<p>here is the output of <code>objdump -dr</code>: <a href=\"https://paste.rs/zWh.s\">https://paste.rs/zWh.s</a></p>",
        "id": 266173746,
        "sender_full_name": "dammi-i",
        "timestamp": 1640612951
    },
    {
        "content": "<p>Could you also run <code>readelf -r out</code> on the same executable? For me the relevant sections of <code>objdump -dr</code> and <code>readelf -r</code> look like:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mi\">0000000000000784</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">main</span><span class=\"o\">&gt;</span>:\n <span class=\"mi\">784</span>:   <span class=\"nc\">a9bf7bfd</span><span class=\"w\">        </span><span class=\"n\">stp</span><span class=\"w\">     </span><span class=\"n\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x30</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span>#<span class=\"o\">-</span><span class=\"mi\">16</span><span class=\"p\">]</span><span class=\"o\">!</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mi\">788</span>:   <span class=\"mi\">910003</span><span class=\"n\">fd</span><span class=\"w\">        </span><span class=\"n\">mov</span><span class=\"w\">     </span><span class=\"n\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mi\">78</span><span class=\"n\">c</span>:   <span class=\"nc\">d2800180</span><span class=\"w\">        </span><span class=\"n\">mov</span><span class=\"w\">     </span><span class=\"n\">x0</span><span class=\"p\">,</span><span class=\"w\"> </span>#<span class=\"mh\">0xc</span><span class=\"w\">                        </span><span class=\"c1\">// #12</span>\n<span class=\"w\"> </span><span class=\"mi\">790</span>:   <span class=\"mi\">58000041</span><span class=\"w\">        </span><span class=\"n\">ldr</span><span class=\"w\">     </span><span class=\"n\">x1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">798</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">main</span><span class=\"o\">+</span><span class=\"mh\">0x14</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mi\">794</span>:   <span class=\"mi\">14000003</span><span class=\"w\">        </span><span class=\"n\">b</span><span class=\"w\">       </span><span class=\"mi\">7</span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">main</span><span class=\"o\">+</span><span class=\"mh\">0x1c</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">a0</span>:   <span class=\"nc\">d63f0020</span><span class=\"w\">        </span><span class=\"n\">blr</span><span class=\"w\">     </span><span class=\"n\">x1</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">a4</span>:   <span class=\"nc\">d2800000</span><span class=\"w\">        </span><span class=\"n\">mov</span><span class=\"w\">     </span><span class=\"n\">x0</span><span class=\"p\">,</span><span class=\"w\"> </span>#<span class=\"mh\">0x0</span><span class=\"w\">                        </span><span class=\"c1\">// #0</span>\n<span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">a8</span>:   <span class=\"nc\">a8c17bfd</span><span class=\"w\">        </span><span class=\"n\">ldp</span><span class=\"w\">     </span><span class=\"n\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x30</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">sp</span><span class=\"p\">],</span><span class=\"w\"> </span>#<span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">ac</span>:   <span class=\"nc\">d65f03c0</span><span class=\"w\">        </span><span class=\"n\">ret</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Relocation</span><span class=\"w\"> </span><span class=\"n\">section</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"k\">dyn</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mh\">0x468</span><span class=\"w\"> </span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"n\">entries</span>:\n  <span class=\"nc\">Offset</span><span class=\"w\">          </span><span class=\"n\">Info</span><span class=\"w\">           </span><span class=\"n\">Type</span><span class=\"w\">           </span><span class=\"n\">Sym</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\">    </span><span class=\"n\">Sym</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">Addend</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"o\">..</span><span class=\"p\">.]</span><span class=\"w\"></span>\n<span class=\"mi\">000000000798</span><span class=\"w\">  </span><span class=\"mi\">000300000101</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_ABS64</span><span class=\"w\">   </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"o\">@</span><span class=\"n\">GLIBC_2</span><span class=\"p\">.</span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Basically the address to the <code>exit</code> function that is loaded is relocated at runtime.</p>",
        "id": 266195716,
        "sender_full_name": "bjorn3",
        "timestamp": 1640631122
    },
    {
        "content": "<p>In your case it seems like the address is already relocated at link time.</p>",
        "id": 266195794,
        "sender_full_name": "bjorn3",
        "timestamp": 1640631191
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"466174\">@dammi-i</span></p>",
        "id": 266195798,
        "sender_full_name": "bjorn3",
        "timestamp": 1640631197
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Relocation</span><span class=\"w\"> </span><span class=\"n\">section</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"k\">dyn</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mh\">0x490</span><span class=\"w\"> </span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">entries</span>:\n  <span class=\"nc\">Offset</span><span class=\"w\">          </span><span class=\"n\">Info</span><span class=\"w\">           </span><span class=\"n\">Type</span><span class=\"w\">           </span><span class=\"n\">Sym</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\">    </span><span class=\"n\">Sym</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">Addend</span><span class=\"w\"></span>\n<span class=\"mi\">000000002930</span><span class=\"w\">  </span><span class=\"mi\">000000000403</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_RELATIV</span><span class=\"w\">                    </span><span class=\"mi\">2730</span><span class=\"w\"></span>\n<span class=\"mi\">000000002938</span><span class=\"w\">  </span><span class=\"mi\">000000000403</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_RELATIV</span><span class=\"w\">                    </span><span class=\"mi\">2740</span><span class=\"w\"></span>\n<span class=\"mi\">000000002940</span><span class=\"w\">  </span><span class=\"mi\">000000000403</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_RELATIV</span><span class=\"w\">                    </span><span class=\"mi\">2750</span><span class=\"w\"></span>\n<span class=\"mi\">000000002948</span><span class=\"w\">  </span><span class=\"mi\">000000000403</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_RELATIV</span><span class=\"w\">                    </span><span class=\"mi\">16</span><span class=\"n\">a0</span><span class=\"w\"></span>\n\n<span class=\"n\">Relocation</span><span class=\"w\"> </span><span class=\"n\">section</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"n\">plt</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mh\">0x4f0</span><span class=\"w\"> </span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">entries</span>:\n  <span class=\"nc\">Offset</span><span class=\"w\">          </span><span class=\"n\">Info</span><span class=\"w\">           </span><span class=\"n\">Type</span><span class=\"w\">           </span><span class=\"n\">Sym</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\">    </span><span class=\"n\">Sym</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">Addend</span><span class=\"w\"></span>\n<span class=\"mi\">000000002968</span><span class=\"w\">  </span><span class=\"mi\">000200000402</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_JUMP_SL</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">__libc_init</span><span class=\"o\">@</span><span class=\"n\">LIBC</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"mi\">000000002970</span><span class=\"w\">  </span><span class=\"mi\">000100000402</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_JUMP_SL</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">__cxa_atexit</span><span class=\"o\">@</span><span class=\"n\">LIBC</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"mi\">000000002978</span><span class=\"w\">  </span><span class=\"mi\">000300000402</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_JUMP_SL</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">__register_atfork</span><span class=\"o\">@</span><span class=\"n\">LIBC</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"mi\">000000002980</span><span class=\"w\">  </span><span class=\"mi\">000400000402</span><span class=\"w\"> </span><span class=\"n\">R_AARCH64_JUMP_SL</span><span class=\"w\"> </span><span class=\"mi\">0000000000001720</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"o\">@</span><span class=\"n\">LIBC</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 266199898,
        "sender_full_name": "dammi-i",
        "timestamp": 1640634497
    },
    {
        "content": "<p>Yours uses relative instead of absolute relocations for some reasons despite the code expecting absolute addresses.<br>\nedit: misinterpreted. it is actually missing the relocation entirely.</p>",
        "id": 266201841,
        "sender_full_name": "bjorn3",
        "timestamp": 1640636312
    },
    {
        "content": "<p>What does <code>cc -v -Wl,-v out.o -o out</code> show? Maybe the linker is configured differently?</p>",
        "id": 266201989,
        "sender_full_name": "bjorn3",
        "timestamp": 1640636451
    },
    {
        "content": "<p>When trying it on my android phone, it gives a linker warning about a relocation in the .text section and refuses to run it for this reason. Cranelift doesn't yet support position independent code (which should make it run on Android) for AArch64 it seems.</p>",
        "id": 266202976,
        "sender_full_name": "bjorn3",
        "timestamp": 1640637448
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">13.0.0</span><span class=\"w\"></span>\n<span class=\"n\">Target</span>: <span class=\"nc\">aarch64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">android24</span><span class=\"w\"></span>\n<span class=\"n\">Thread</span><span class=\"w\"> </span><span class=\"n\">model</span>: <span class=\"nc\">posix</span><span class=\"w\"></span>\n<span class=\"n\">InstalledDir</span>: <span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">termux</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"w\"></span>\n<span class=\"s\">\"/data/data/com.termux/files/usr/bin/ld.lld\"</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">sysroot</span><span class=\"o\">=/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">termux</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">pie</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">noexecstack</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">EL</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">fix</span><span class=\"o\">-</span><span class=\"n\">cortex</span><span class=\"o\">-</span><span class=\"n\">a53</span><span class=\"o\">-</span><span class=\"mi\">843419</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">warn</span><span class=\"o\">-</span><span class=\"n\">shared</span><span class=\"o\">-</span><span class=\"n\">textrel</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">relro</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"o\">-</span><span class=\"n\">page</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">4096</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">hash</span><span class=\"o\">-</span><span class=\"n\">style</span><span class=\"o\">=</span><span class=\"n\">gnu</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">enable</span><span class=\"o\">-</span><span class=\"n\">new</span><span class=\"o\">-</span><span class=\"n\">dtags</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">rpath</span><span class=\"o\">=/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">termux</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">eh</span><span class=\"o\">-</span><span class=\"n\">frame</span><span class=\"o\">-</span><span class=\"n\">hdr</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">aarch64linux</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">dynamic</span><span class=\"o\">-</span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">system</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">linker64</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">termux</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">crtbegin_dynamic</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">L</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">termux</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">L</span><span class=\"o\">/</span><span class=\"n\">system</span><span class=\"o\">/</span><span class=\"n\">lib64</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">termux</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"o\">/</span><span class=\"mf\">13.0.0</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">android</span><span class=\"o\">/</span><span class=\"n\">libclang_rt</span><span class=\"p\">.</span><span class=\"n\">builtins</span><span class=\"o\">-</span><span class=\"n\">aarch64</span><span class=\"o\">-</span><span class=\"n\">android</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">l</span>:<span class=\"nc\">libunwind</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">ldl</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">lc</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">termux</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"o\">/</span><span class=\"mf\">13.0.0</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">android</span><span class=\"o\">/</span><span class=\"n\">libclang_rt</span><span class=\"p\">.</span><span class=\"n\">builtins</span><span class=\"o\">-</span><span class=\"n\">aarch64</span><span class=\"o\">-</span><span class=\"n\">android</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">l</span>:<span class=\"nc\">libunwind</span><span class=\"p\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">ldl</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">data</span><span class=\"o\">/</span><span class=\"n\">com</span><span class=\"p\">.</span><span class=\"n\">termux</span><span class=\"o\">/</span><span class=\"n\">files</span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">crtend_android</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\"></span>\n<span class=\"n\">LLD</span><span class=\"w\"> </span><span class=\"mf\">13.0.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">compatible</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">GNU</span><span class=\"w\"> </span><span class=\"n\">linkers</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 266203614,
        "sender_full_name": "dammi-i",
        "timestamp": 1640638012
    },
    {
        "content": "<p>Oh, you are on android. I don't know why the linker mislinks it in the first place, but android requires position independent code. Cranelift doesn't support it yet on AArch64, so unfortunately I can't help you for now. <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2907\">https://github.com/bytecodealliance/wasmtime/issues/2907</a> is the issue for adding pic support.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/2907\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e569e35d0b96104656475c50840f37c8b27e6cbb\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646337646430613534616163333031353463386639343935656563343632376336616261666363373836636233613733633737383432313764393731313034322f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f32393037)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/2907\" title=\"Cranelift: implement PIC relocations on AArch64 · Issue #2907 · bytecodealliance/wasmtime\">Cranelift: implement PIC relocations on AArch64 · Issue #2907 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Cranelift emits AbsoluteRelocation Reloc::Abs8 when is_pic setting is enabled in architecture aarch64 Steps to Reproduce (module ;; Recursive factorial (func (export &quot;fac-rec&quot;) (param i64...</div></div></div>",
        "id": 266204101,
        "sender_full_name": "bjorn3",
        "timestamp": 1640638490
    }
]