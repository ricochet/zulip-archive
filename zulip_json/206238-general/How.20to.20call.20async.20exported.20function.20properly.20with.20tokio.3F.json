[
    {
        "content": "<p>I wrote a simple example to export an async function like the following:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[no_mangle]</span><span class=\"w\"></span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">answer</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i32</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"call inner answer\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"mi\">42</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>After use <code>cargo wasi build</code> to get the wasm target, I create an example with tokio:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[package]</span><span class=\"w\"></span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"lib-async\"</span><span class=\"w\"></span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"0.1.0\"</span><span class=\"w\"></span>\n<span class=\"n\">edition</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"2021\"</span><span class=\"w\"></span>\n\n<span class=\"k\">[dependencies]</span><span class=\"w\"></span>\n<span class=\"n\">anyhow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"1.0\"</span><span class=\"w\"></span>\n<span class=\"n\">tokio</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"1.8.0\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"full\"</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"0.38\"</span><span class=\"w\"></span>\n<span class=\"n\">wasmtime-wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"0.38\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"tokio\"</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and the source code is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span>::<span class=\"p\">{</span><span class=\"n\">Config</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi</span>::<span class=\"p\">{</span><span class=\"n\">tokio</span>::<span class=\"n\">WasiCtxBuilder</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span><span class=\"p\">};</span><span class=\"w\"></span>\n\n<span class=\"cp\">#[tokio::main]</span><span class=\"w\"></span>\n<span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">anyhow</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Config</span>::<span class=\"n\">new</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">async_support</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">consume_fuel</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Engine</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">config</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Module</span>::<span class=\"n\">from_file</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"target/wasm32-wasi/debug/lib_async_example.wasm\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span>::<span class=\"n\">tokio</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">join</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tokio</span>::<span class=\"n\">task</span>::<span class=\"n\">spawn</span><span class=\"p\">(</span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">get_answer</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">module</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"w\"> </span><span class=\"p\">});</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">join</span><span class=\"p\">.</span><span class=\"k\">await</span><span class=\"o\">??</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"answer is {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">get_answer</span><span class=\"p\">(</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">linker</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">WasiCtx</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">engine</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">Engine</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">module</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">Module</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">anyhow</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"kt\">i32</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">WasiCtxBuilder</span>::<span class=\"n\">new</span><span class=\"p\">().</span><span class=\"n\">inherit_stdout</span><span class=\"p\">().</span><span class=\"n\">build</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">out_of_fuel_async_yield</span><span class=\"p\">(</span><span class=\"kt\">u64</span>::<span class=\"n\">MAX</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instantiate_async</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">answer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">get_typed_func</span>::<span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"answer\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">answer</span><span class=\"p\">.</span><span class=\"n\">call_async</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">()).</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I expect the print answer is 42, but the actual answer is 0.</p>",
        "id": 287299784,
        "sender_full_name": "raindust",
        "timestamp": 1656056653
    },
    {
        "content": "<p>You can't directly call an async function from the host. I am surprised rustc even allows <code>extern \"C\"</code> on async functions. Async functions return a future you need to poll from an executor. You can't poll them from the host. Wasmtime's <code>call_async</code> requires a sync wasm function. The difference with non-async <code>call</code> I believe is that functions from the host called by the wasm module can be async. If such a function is called and it isn't ready yet, wasmtime will skip past the wasm functions entirely and return a not-ready result from <code>call_async</code>, if you poll it again, it will immediately poll the host async function that was originally called. Only when this function is ready will it return back to the wasm caller. In other words wasmtime async support is transparent to the wasm module. If you want async functions on the wasm module side you will need to write an executor for this or use an existing one like tokio. <a href=\"https://github.com/tokio-rs/tokio/pull/4716\">https://github.com/tokio-rs/tokio/pull/4716</a> will add wasi support to tokio.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tokio-rs/tokio/pull/4716\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/4115c0742d8e2758ee3bd285c812801a01a0cb44\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623236386465373433383339613761376266333737326335616431656462366138353934646334343536353536383466613762303937633839666563626534362f746f6b696f2d72732f746f6b696f2f70756c6c2f34373136)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tokio-rs/tokio/pull/4716\" title=\"Wasm32-wasi target support by rjzak · Pull Request #4716 · tokio-rs/tokio\">Wasm32-wasi target support by rjzak · Pull Request #4716 · tokio-rs/tokio</a></div><div class=\"message_embed_description\">Motivation\nGetting Tokio working on WebAssembly-WASI so that web applications can be executed by a Wasi runtime, such as Wasmtime and others.\nSolution\nWorking on supporting the wasm32-wasi target. ...</div></div></div>",
        "id": 287306982,
        "sender_full_name": "bjorn3",
        "timestamp": 1656061613
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> thanks for reply.<br>\nI thought wasm (or wasi) already support async functions because <a href=\"https://rustwasm.github.io/wasm-bindgen/reference/js-promises-and-rust-futures.html\">wasm-bindgen can wrap a rust <code>Future</code> into JS <code>Promise</code></a>, and we compile the <code>extern \"C\"</code> on async functions with <code>wasm32-wasi</code>, is it means can translate a rust <code>Future</code> to the wasm grammar but wasmtime still can't support it yet?</p>\n<blockquote>\n<p><a href=\"https://github.com/tokio-rs/tokio/pull/4716\">https://github.com/tokio-rs/tokio/pull/4716</a> </p>\n</blockquote>\n<p>The issue above I think it is used to support tokio when cargo build with <code>wasm32-wasi</code>. But I think what we really need is let wasmtime can recognize (or give use the choice to identify) there is an async function, so we can call it in the async way.</p>",
        "id": 287315934,
        "sender_full_name": "raindust",
        "timestamp": 1656067917
    },
    {
        "content": "<p>And if I add dependencies in <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/tokio/wasm/Cargo.toml\">https://github.com/bytecodealliance/wasmtime/blob/main/examples/tokio/wasm/Cargo.toml</a> like the following:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[dependencies]</span><span class=\"w\"></span>\n<span class=\"n\">futures</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"0.3\"</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and modify <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/tokio/wasm/tokio-wasi.rs\">https://github.com/bytecodealliance/wasmtime/blob/main/examples/tokio/wasm/tokio-wasi.rs</a> like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">futures</span>::<span class=\"n\">executor</span>::<span class=\"n\">block_on</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">hello_world</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"hello world from async!\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">env</span>::<span class=\"n\">var</span><span class=\"p\">(</span><span class=\"s\">\"NAME\"</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Hello, world! My name is {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">std</span>::<span class=\"n\">thread</span>::<span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"n\">std</span>::<span class=\"n\">time</span>::<span class=\"n\">Duration</span>::<span class=\"n\">from_secs</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">));</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Goodbye from {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">future</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">hello_world</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"c1\">// Nothing is printed</span>\n<span class=\"w\">    </span><span class=\"n\">block_on</span><span class=\"p\">(</span><span class=\"n\">future</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// `future` is run and \"hello, world!\" is printed</span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>It works properly.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/tokio/wasm/Cargo.toml\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/0e718a8e3b7cf2afd2432ded14d3a8dabee60b08\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363332353761326633386365393563613730373632323664353838363232613236643230666239353537636433363931306231386330313837666339353432612f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/tokio/wasm/Cargo.toml\" title=\"wasmtime/Cargo.toml at main · bytecodealliance/wasmtime\">wasmtime/Cargo.toml at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/Cargo.toml at main · bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/tokio/wasm/tokio-wasi.rs\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/0e718a8e3b7cf2afd2432ded14d3a8dabee60b08\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363332353761326633386365393563613730373632323664353838363232613236643230666239353537636433363931306231386330313837666339353432612f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/tokio/wasm/tokio-wasi.rs\" title=\"wasmtime/tokio-wasi.rs at main · bytecodealliance/wasmtime\">wasmtime/tokio-wasi.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/tokio-wasi.rs at main · bytecodealliance/wasmtime</div></div></div>",
        "id": 287316254,
        "sender_full_name": "raindust",
        "timestamp": 1656068141
    },
    {
        "content": "<p>Wasm itself doesn't have the concept of async functions and as such wasmtime can't recognize them. In rust async functions are lowered to a function that returns a value implementing the <code>Future</code> trait. This trait has a method called <code>poll</code> that needs to be called to drive the future to completion. This method uses the \"Rust\" calling convention and as such isn't callable outside of the rust code from which you compile the wasm module. The <code>wasm_bindgen_futures</code> crate has an async executor that can handle javascript <code>Promise</code>'s. There is no equivalent to this for wasi yet. Note that <code>futures::block_on</code> only works in this case as the future is always immediately ready. If it isn't, <code>futures::block_on</code> will attempt to park the current thread until the waker is called. I think libstd implements thread parking as a panic on wasm/wasi as they are single threaded platforms at the moment and thus parking the current thread doesn't make sense as nobody could unpark it again. In addition neither wasm nor wasi has an api to park a thread in the first place.</p>",
        "id": 287316639,
        "sender_full_name": "bjorn3",
        "timestamp": 1656068407
    },
    {
        "content": "<p>Ah, I forgot wasm/wasi are single threaded platforms. So if I wanna get rid of the \"callback hell\" in a wasi library, write a single export function like the following still works, am I Right? </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[no_mangle]</span><span class=\"w\"></span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">message_loop</span><span class=\"p\">(</span><span class=\"n\">op_len</span>: <span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">req_len</span>: <span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i32</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">task</span>::<span class=\"n\">block_on</span><span class=\"p\">(</span><span class=\"n\">future</span>::<span class=\"n\">poll_fn</span><span class=\"p\">(</span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">cx</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Context</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;|</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">loop</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"c1\">// message handling related logic</span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 287330823,
        "sender_full_name": "raindust",
        "timestamp": 1656077520
    },
    {
        "content": "<p>What exactly are you using async for?</p>",
        "id": 287335348,
        "sender_full_name": "bjorn3",
        "timestamp": 1656079726
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/206238-general/topic/How.20to.20call.20async.20exported.20function.20properly.20with.20tokio.3F/near/287335348\">said</a>:</p>\n<blockquote>\n<p>What exactly are you using async for?</p>\n</blockquote>\n<p>I have a handler map in a wasi library used to store callbacks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">lazy_static</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\"> </span><span class=\"n\">MAP_HANDLER</span>: <span class=\"nc\">Mutex</span><span class=\"o\">&lt;</span><span class=\"n\">HashMap</span><span class=\"o\">&lt;</span><span class=\"kt\">u64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"n\">CallbackItem</span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Mutex</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">HashMap</span>::<span class=\"n\">new</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"nc\">Callback</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"nb\">FnOnce</span><span class=\"p\">(</span><span class=\"n\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nb\">Sync</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nb\">Send</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"nb\">static</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"nc\">CallbackItem</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"n\">callback</span>: <span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"n\">Callback</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"n\">timeout</span>: <span class=\"nc\">Duration</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"n\">start_at</span>: <span class=\"nc\">SystemTime</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">add_callback</span><span class=\"o\">&lt;</span><span class=\"n\">F</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">seq_number</span>: <span class=\"kt\">u64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">callback</span>: <span class=\"nc\">F</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"k\">where</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">F</span>: <span class=\"nb\">FnOnce</span><span class=\"p\">(</span><span class=\"n\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nb\">Sync</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nb\">Send</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"nb\">static</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">MAP_HANDLER</span><span class=\"p\">.</span><span class=\"n\">lock</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">callback_item</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">CallbackItem</span>::<span class=\"n\">with_default_duration</span><span class=\"p\">(</span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">callback</span><span class=\"p\">))</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">.</span><span class=\"n\">get_mut</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">seq_number</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">callback_list</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">callback_list</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">callback_item</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">map</span><span class=\"p\">.</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">seq_number</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[</span><span class=\"n\">callback_item</span><span class=\"p\">]);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And when the callback reply reached, I use the following function to handle it: </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">result_handler</span><span class=\"p\">(</span><span class=\"n\">msg</span>: <span class=\"kp\">&amp;</span><span class=\"p\">[</span><span class=\"kt\">u8</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">seq_number</span>: <span class=\"kt\">u64</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">callback</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">MAP_HANDLER</span><span class=\"p\">.</span><span class=\"n\">lock</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">hash_map</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">hash_map</span><span class=\"p\">.</span><span class=\"n\">get_mut</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">seq_number</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">callback_list</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">callback</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">callback_list</span><span class=\"p\">.</span><span class=\"n\">pop</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">callback_list</span><span class=\"p\">.</span><span class=\"n\">is_empty</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                        </span><span class=\"n\">hash_map</span><span class=\"p\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">seq_number</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">callback</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"nb\">None</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">error</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"Result handler lock failed, details: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"nb\">None</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">};</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">deserialize</span>::<span class=\"o\">&lt;</span><span class=\"n\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">msg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">content</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">callback</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">callback</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">callback</span><span class=\"p\">.</span><span class=\"n\">callback</span><span class=\"p\">)(</span><span class=\"n\">content</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">error</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"Cannot find callback function (seq_number: {}) from hashmap. Cannot callback\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">seq_number</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">warn</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"s\">\"failed to deserialize reply message (seq_number: {}): {:?}\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">seq_number</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Using the handler map I wrote above,  I can do something asynchronously using callback like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">call_async</span><span class=\"o\">&lt;</span><span class=\"n\">F</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">id</span>: <span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">operation</span>: <span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">callback</span>: <span class=\"nc\">F</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"k\">where</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">F</span>: <span class=\"nb\">FnOnce</span><span class=\"p\">(</span><span class=\"n\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">TeaResult</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nb\">Sync</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nb\">Send</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"nb\">static</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">seq_number</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get_seq_number</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">add_callback</span><span class=\"p\">(</span><span class=\"n\">seq_number</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">callback</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// do something synchronously</span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>As you can see, using callback is hard to read and debug, so I want replace these callback functions with <code>async</code>.</p>",
        "id": 287342864,
        "sender_full_name": "raindust",
        "timestamp": 1656083157
    },
    {
        "content": "<p>I see. I did recommend writing your own executor. <a href=\"https://rust-lang.github.io/async-book/02_execution/04_executor.html\">https://rust-lang.github.io/async-book/02_execution/04_executor.html</a> has an explanation on how to do this. <a href=\"https://os.phil-opp.com/async-await/\">https://os.phil-opp.com/async-await/</a> is also a really nice explanation of how async in rust internally works. It is written in the context of implementing an OS in rust, but a lot is applicable outside of this context too.</p>",
        "id": 287345520,
        "sender_full_name": "bjorn3",
        "timestamp": 1656084360
    },
    {
        "content": "<p>Thanks a lot, I will read these tutorials carefully and write my own executor</p>",
        "id": 287403850,
        "sender_full_name": "raindust",
        "timestamp": 1656121900
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"510310\">raindust</span> has marked this topic as resolved.</p>",
        "id": 287403913,
        "sender_full_name": "Notification Bot",
        "timestamp": 1656121958
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"510310\">raindust</span> has marked this topic as unresolved.</p>",
        "id": 287710263,
        "sender_full_name": "Notification Bot",
        "timestamp": 1656420392
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> . I wrote an example in <a href=\"https://github.com/raindust/executor-test\">https://github.com/raindust/executor-test</a> to simulate async executor running on single threaded platform. But I find it's hard to changed a callback based function into an async function.<br>\n<a href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L89-L108\">https://github.com/raindust/executor-test/blob/master/src/main.rs#L89-L108</a> here is a callback based function,  is there any way I can changed it like this <a href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L110-L114\">https://github.com/raindust/executor-test/blob/master/src/main.rs#L110-L114</a> ? You can see I have implemented it, but it will stuck if uncomment in here <a href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L62-L64\">https://github.com/raindust/executor-test/blob/master/src/main.rs#L62-L64</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/raindust/executor-test\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/bed58a99265e1e6f68433eae2a553dbf7ed38587\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613933313163343835346430383361633834653337366566396136363931343261366261313461326566383731343162353938393433613363616239336130642f7261696e647573742f6578656375746f722d74657374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/raindust/executor-test\" title=\"GitHub - raindust/executor-test\">GitHub - raindust/executor-test</a></div><div class=\"message_embed_description\">Contribute to raindust/executor-test development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L89-L108\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/bed58a99265e1e6f68433eae2a553dbf7ed38587\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613933313163343835346430383361633834653337366566396136363931343261366261313461326566383731343162353938393433613363616239336130642f7261696e647573742f6578656375746f722d74657374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L89-L108\" title=\"executor-test/main.rs at master · raindust/executor-test\">executor-test/main.rs at master · raindust/executor-test</a></div><div class=\"message_embed_description\">Contribute to raindust/executor-test development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L110-L114\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/bed58a99265e1e6f68433eae2a553dbf7ed38587\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613933313163343835346430383361633834653337366566396136363931343261366261313461326566383731343162353938393433613363616239336130642f7261696e647573742f6578656375746f722d74657374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L110-L114\" title=\"executor-test/main.rs at master · raindust/executor-test\">executor-test/main.rs at master · raindust/executor-test</a></div><div class=\"message_embed_description\">Contribute to raindust/executor-test development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L62-L64\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/bed58a99265e1e6f68433eae2a553dbf7ed38587\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613933313163343835346430383361633834653337366566396136363931343261366261313461326566383731343162353938393433613363616239336130642f7261696e647573742f6578656375746f722d74657374)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/raindust/executor-test/blob/master/src/main.rs#L62-L64\" title=\"executor-test/main.rs at master · raindust/executor-test\">executor-test/main.rs at master · raindust/executor-test</a></div><div class=\"message_embed_description\">Contribute to raindust/executor-test development by creating an account on GitHub.</div></div></div>",
        "id": 287712037,
        "sender_full_name": "raindust",
        "timestamp": 1656421259
    },
    {
        "content": "<p>You can't use std's channel implementation in async functions without deadlocking. You need an async aware channel implementation like <code>futures::channel::oneshot</code>.</p>",
        "id": 287712373,
        "sender_full_name": "bjorn3",
        "timestamp": 1656421406
    },
    {
        "content": "<p>Do you mean changes like <a href=\"https://github.com/raindust/executor-test/commit/3070697e8b80d38077da1723fd04c0f29361ab78\">https://github.com/raindust/executor-test/commit/3070697e8b80d38077da1723fd04c0f29361ab78</a> this ?  I tried and it got stuck again.  Is there some thing else I missed?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/raindust/executor-test/commit/3070697e8b80d38077da1723fd04c0f29361ab78\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/873869544d9dc4c744a1bd39fd4aaac2b6e4ab5f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373862623539623563623465323437313762663430313962363964333636353966636364333664313734666333353363313464666632653862333063393934312f7261696e647573742f6578656375746f722d746573742f636f6d6d69742f33303730363937653862383064333830373764613137323366643034633066323933363161623738)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/raindust/executor-test/commit/3070697e8b80d38077da1723fd04c0f29361ab78\" title=\"change channel into future oneshort channel · raindust/executor-test@3070697\">change channel into future oneshort channel · raindust/executor-test@3070697</a></div><div class=\"message_embed_description\">Contribute to raindust/executor-test development by creating an account on GitHub.</div></div></div>",
        "id": 287714106,
        "sender_full_name": "raindust",
        "timestamp": 1656422244
    },
    {
        "content": "<p>Yes. Not sure what the issue is.</p>",
        "id": 287714283,
        "sender_full_name": "bjorn3",
        "timestamp": 1656422316
    }
]