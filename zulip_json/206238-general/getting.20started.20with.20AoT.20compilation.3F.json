[
    {
        "content": "<p>Hello! <span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span> I was able to successfully follow the <a href=\"https://github.com/bytecodealliance/cranelift-jit-demo\">Cranelift JIT demo</a> to get a working <a href=\"https://gist.github.com/samestep/d45a6a00a4f3fbd9ac7487e555ee002c\">Cranelift JIT hello world example</a>, but I'm having trouble finding a place to look to make a similar \"hello world\" example for ahead-of-time compilation. I tried using <a href=\"https://github.com/ctiedt/cranefuck\">someone's example Brainfuck compiler</a>, but I got linking errors on all my machines (x86 WSL2, ARM64 macOS, and i386 Linux) so I'm not exactly sure how to adapt it so it'll work. I assume there already exists some simple example for producing a static binary using Cranelift; where can I find it?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/cranelift-jit-demo\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/cb634abf554c1066f100e1985c16bbceba60c042/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383337376438663530333438316161313737623065316162633634633731306231633931313434376338386135353034396238633234326134326637326164632f62797465636f6465616c6c69616e63652f6372616e656c6966742d6a69742d64656d6f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/cranelift-jit-demo\" title=\"GitHub - bytecodealliance/cranelift-jit-demo: JIT compiler and runtime for a toy language, using Cranelift\">GitHub - bytecodealliance/cranelift-jit-demo: JIT compiler and runtime for a toy language, using Cranelift</a></div><div class=\"message_embed_description\">JIT compiler and runtime for a toy language, using Cranelift - bytecodealliance/cranelift-jit-demo</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://gist.github.com/samestep/d45a6a00a4f3fbd9ac7487e555ee002c\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/91f9baed8f4fc08c462d1a4de5a8c23942d45e97/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f6173736574732f676973742d6f672d696d6167652d3534666437646330373133652e706e67&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://gist.github.com/samestep/d45a6a00a4f3fbd9ac7487e555ee002c\" title=\"Cranelift JIT hello world\">Cranelift JIT hello world</a></div><div class=\"message_embed_description\">Cranelift JIT hello world. GitHub Gist: instantly share code, notes, and snippets.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/ctiedt/cranefuck\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b7acaf9e0810a9c9df154a47bb8da91df5eeee6f/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f636363643534386236353334333233616563623563303039346162643963656662353964653738323839626532383637333538333366373235373538646563312f6374696564742f6372616e656675636b&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/ctiedt/cranefuck\" title=\"GitHub - ctiedt/cranefuck\">GitHub - ctiedt/cranefuck</a></div><div class=\"message_embed_description\">Contribute to ctiedt/cranefuck development by creating an account on GitHub.</div></div></div>",
        "id": 463475990,
        "sender_full_name": "Sam Estep",
        "timestamp": 1724091458
    },
    {
        "content": "<p>Are you passing <code>-lc</code> when linking? And are you defining a <code>main</code> function which you mark as <code>Linkage::Export</code>?</p>",
        "id": 463495367,
        "sender_full_name": "bjorn3",
        "timestamp": 1724096411
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> sorry for being slow to respond; thankfully the cranefuck author helped me <a href=\"https://github.com/ctiedt/cranefuck/pull/1#issuecomment-2302143713\">figure out how to get linking working</a> though!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/ctiedt/cranefuck/pull/1#issuecomment-2302143713\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/3d827fd88863c575dd276feff23c45caf044e5cf/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613437383930363362636466333034653739326232313732303337343139366566323161363132316135383030336533623638633538363334396133613631362f6374696564742f6372616e656675636b2f70756c6c2f31&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/ctiedt/cranefuck/pull/1#issuecomment-2302143713\" title=\"Fix `build.sh` by samestep 路 Pull Request #1 路 ctiedt/cranefuck\">Fix `build.sh` by samestep 路 Pull Request #1 路 ctiedt/cranefuck</a></div><div class=\"message_embed_description\">This PR fixes some typos in build.sh. Unfortunately, on both my WSL2 machine and my M1 MacBook, even with the fixes it still fails with this error:\nNo crt1.o found</div></div></div>",
        "id": 467565172,
        "sender_full_name": "Sam Estep",
        "timestamp": 1725461788
    },
    {
        "content": "<p>Wait, why are you directly using ld instead of using gcc or clang? Gcc and clang pass a bunch of flags to the linker to tell it where to find system libraries, which libraries are unconditionally required and so on.</p>",
        "id": 467565997,
        "sender_full_name": "bjorn3",
        "timestamp": 1725461924
    },
    {
        "content": "<p>Pretty much everyone on Unix systems uses gcc, clang or whatever C compiler is the default for the platform instead of directly running the linker.</p>",
        "id": 467566334,
        "sender_full_name": "bjorn3",
        "timestamp": 1725461984
    },
    {
        "content": "<p>This is both a lot more portable and much simpler than reproducing all this logic for every OS you want to target.</p>",
        "id": 467566743,
        "sender_full_name": "bjorn3",
        "timestamp": 1725462032
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"746849\">@Sam Estep</span></p>",
        "id": 467566795,
        "sender_full_name": "bjorn3",
        "timestamp": 1725462042
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> that makes a lot of sense, sounds like I should be using gcc or clang instead! More generally, I'd like to distribute my compiler as a standalone binary (via musl etc) which itself can produce standalone binaries, so I don't really want to just assume that the user already has gcc or clang installed on their system. What should I do in this case? For instance, it seems like the Rust compiler itself comes with a linker, but I assume that's because Rust bundles LLVM. Is there a way I can achieve this same UX but with Cranelift?</p>",
        "id": 467568712,
        "sender_full_name": "Sam Estep",
        "timestamp": 1725462366
    },
    {
        "content": "<p>Do you mean rust-lld? On all Unix systems we (rustc) actually tell gcc/clang to use rust-lld as linker rather than directly invoking rust-lld.</p>",
        "id": 467570176,
        "sender_full_name": "bjorn3",
        "timestamp": 1725462631
    },
    {
        "content": "<p>OK gotcha; so, what happens when someone installs Rust but doesn't already have gcc or clang installed?</p>",
        "id": 467570462,
        "sender_full_name": "Sam Estep",
        "timestamp": 1725462690
    },
    {
        "content": "<p>You get an error that gcc or clang was not found.</p>",
        "id": 467570565,
        "sender_full_name": "bjorn3",
        "timestamp": 1725462716
    },
    {
        "content": "<p>What about on Windows?</p>",
        "id": 467570805,
        "sender_full_name": "Sam Estep",
        "timestamp": 1725462758
    },
    {
        "content": "<p>Sounds like you're saying I essentially can't just distribute one standalone binary for my compiler and also produce standalone binaries from user programs, is that accurate?</p>",
        "id": 467571245,
        "sender_full_name": "Sam Estep",
        "timestamp": 1725462847
    },
    {
        "content": "<p>For wasm and embedded systems without OS rustc does directly invoke rust-lld as for those there is no libc and such.</p>\n<p>For MSVC Windows by default we expect link.exe in the PATH, but can run rust-lld in link.exe mode. Even so you need the Windows SDK installed (which we legally can't redistribute) for import libraries and a couple of things that get statically linked into the executable. For MinGW Windows we ship a copy of MinGW.</p>",
        "id": 467571319,
        "sender_full_name": "bjorn3",
        "timestamp": 1725462860
    }
]