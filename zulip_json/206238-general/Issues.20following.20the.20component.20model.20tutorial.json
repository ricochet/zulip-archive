[
    {
        "content": "<p>I've been trying to learn how to build components and checked out this tutorial here: <a href=\"https://component-model.bytecodealliance.org/tutorial.html\">https://component-model.bytecodealliance.org/tutorial.html</a></p>\n<p>After some false starts, I managed to get three wasm files built from referencing the given WIT file (instead of the default location wit file generated by cargo-component). I'm running into problems trying to compose them however:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasm-tools<span class=\"w\"> </span>compose<span class=\"w\"> </span>/path/to/calculator.wasm<span class=\"w\"> </span>-d<span class=\"w\"> </span>/path/to/adder.wasm<span class=\"w\">  </span>-o<span class=\"w\"> </span>composed.wasm\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>docs:calculator/add@0.1.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>docs:calculator/add@0.1.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/environment@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/environment@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/exit@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/exit@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:io/error@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:io/error@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:io/streams@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:io/streams@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/stdin@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/stdin@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/stdout@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/stdout@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/stderr@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:cli/stderr@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:clocks/wall-clock@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:clocks/wall-clock@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:filesystem/types@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:filesystem/types@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\n<span class=\"o\">[</span><span class=\"m\">2024</span>-03-16T23:40:21Z<span class=\"w\"> </span>WARN<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span>instance<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:filesystem/preopens@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>will<span class=\"w\"> </span>be<span class=\"w\"> </span>imported<span class=\"w\"> </span>because<span class=\"w\"> </span>a<span class=\"w\"> </span>dependency<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>wasi:filesystem/preopens@0.2.0<span class=\"sb\">`</span><span class=\"w\"> </span>could<span class=\"w\"> </span>not<span class=\"w\"> </span>be<span class=\"w\"> </span>found\nerror:<span class=\"w\"> </span>no<span class=\"w\"> </span>dependencies<span class=\"w\"> </span>of<span class=\"w\"> </span>component<span class=\"w\"> </span><span class=\"sb\">`</span>/path/to/calculator.wasm<span class=\"sb\">`</span><span class=\"w\"> </span>were<span class=\"w\"> </span>found\n</code></pre></div>\n<p>The first warning was unexpected to me, as I would expect that to be made available by the <code>adder.wasm</code> dep being passed on the CLI. All of the remaining errors are unexpected to me as <code>calculator.wasm</code> was built from a lib crate and while the target was <code>wasm32-wasi</code>, none of those symbols are referenced in the WIT file (or my program).</p>\n<p>I don't think I've deviated in any way, but here's a repo with the full source in play here just in case: <a href=\"https://github.com/ssnover/wasm-component-tutorial\">https://github.com/ssnover/wasm-component-tutorial</a></p>\n<p>Just so I'm sure I understand the warnings: When it says will be imported, does that mean that it searches the provided dependencies? The phrasing of the first warning about adder strikes me as odd as I wouldn't expect a warning if it had searched the dependencies, I would expect an error. On the other hand, if it hadn't it seems like it shouldn't be a warning, since that's the happy path of linking a dependency.</p>\n<p>Thanks!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/ssnover/wasm-component-tutorial\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/5b582bd2a82b060ee1a6548142aa855f590497b6\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323336346339316634333936363562393362646161623930326664363138303434653239626330373437336663633165303030363235356336303366646564622f73736e6f7665722f7761736d2d636f6d706f6e656e742d7475746f7269616c)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/ssnover/wasm-component-tutorial\" title=\"GitHub - ssnover/wasm-component-tutorial\">GitHub - ssnover/wasm-component-tutorial</a></div><div class=\"message_embed_description\">Contribute to ssnover/wasm-component-tutorial development by creating an account on GitHub.</div></div></div>",
        "id": 426943085,
        "sender_full_name": "Shane Snover (ssnover)",
        "timestamp": 1710633246
    },
    {
        "content": "<p>Hi Shane! I'm unable to reproduce the error, as when I clone your repo, do a <code>cargo component build</code> in <code>adder</code>, a <code>cargo component build</code> in <code>calculator</code>, then finally a <code>wasm-tools compose calculator/target/wasm32-wasi/debug/calculator.wasm -d adder/target/wasm32-wasi/debug/adder.wasm -o composed.wasm</code>, I get a successful composition.</p>\n<p>That said, the way the <code>-d</code> option works in <code>wasm-tools compose</code> is that it registers the exports of the provided component as potential dependencies to satisfy instantiation arguments with; the (potentially poorly worded) warning is letting you know that a dependency to satisfy the import <code>docs:calculator/add@0.1.0</code> of  <code>calculator.wasm</code> could not be located, so it will remain an import in the composed component. One reason for this is that your <code>adder.wasm</code> is not exporting using the expected name, perhaps?</p>\n<p>Try setting the <code>RUST_LOG=debug</code> environment variable when running <code>wasm-tools compose</code>; there might be useful diagnostic information to determine why the export from adder doesn't match the import from calculator.</p>\n<p>The remaining warnings for all of the WASI instances is because the tool was written well before WASI preview 2 was a thing, so it treats those imports like any other import; those warnings are expected for practically every component that uses WASI as a result. We should probably elide those warnings entirely (although I'm working on a replacement for <code>wasm-tools compose</code> that doesn't behave this way at all).</p>",
        "id": 427012789,
        "sender_full_name": "Peter Huene",
        "timestamp": 1710652772
    },
    {
        "content": "<p>Hey Peter! Thanks for checking out my test repo and confirming I've at least got the build set up right now (it seems maybe my compiled <code>adder.wasm</code> was left over from a previous configuration).</p>\n<p>Your explanation points out a potential hole in my knowledge: when a component is compiled can it be compiled such that not all of its imported symbols are linked? (i.e. maybe with the expectation that they'll be linked to host runtime symbols?)  Did my invocation fail specifically because it could not resolve <em>any</em> of the imports then, since it's okay to not resolve all of them?</p>\n<p>The additional logging statements help a lot, and confirm that I had made some changes after my most recent build of <code>adder.wasm</code>. Is there a tool specifically for listing the imports and exports for a <code>.wasm</code> file? I tried going through the <code>wasm-tools objdump</code> subcommand looking for precisely the list of imports/exports that shows up in the debug logs of <code>compose</code>, but had no luck there. I see in the usage text that it mentions <code>objdump</code> is relatively incomplete.</p>",
        "id": 427130600,
        "sender_full_name": "Shane Snover (ssnover)",
        "timestamp": 1710685133
    },
    {
        "content": "<blockquote>\n<p>when a component is compiled can it be compiled such that not all of its imported symbols are linked? (i.e. maybe with the expectation that they'll be linked to host runtime symbols?)</p>\n</blockquote>\n<p>Yes, imports are not statically linked at compilation time and remain imports in the output module/component, with the expectation that either a host or, in the case of the component model, another component may satisfy the imports via a composition.</p>\n<p>Eventually <code>cargo-component</code> will have some functionality around automatically composing dependencies into the output, if desired, but it currently lacks that feature.</p>\n<blockquote>\n<p>Did my invocation fail specifically because it could not resolve any of the imports then, since it's okay to not resolve all of them?</p>\n</blockquote>\n<p>That's correct, the tool will error if none of the imports were satisfied by a dependency as otherwise the output would be identical to the input; at least one of the imports must be satisfied for the tool to output a composed component.</p>\n<blockquote>\n<p>Is there a tool specifically for listing the imports and exports for a .wasm file? </p>\n</blockquote>\n<p>I generally use <code>wasm-tools print</code> on the component and look for the imports / exports, but that can be verbose; I don't know of a tool that prints only that information, but it would be easy to write and useful enough to include in <code>wasm-tools</code>, I think.</p>",
        "id": 427202288,
        "sender_full_name": "Peter Huene",
        "timestamp": 1710704387
    },
    {
        "content": "<p>Thanks for answering all my questions here! I'll look into writing something like that, I find imported/exported symbols to be the first thing I look to when I'm debugging linking with native binary objects.</p>",
        "id": 427222562,
        "sender_full_name": "Shane Snover (ssnover)",
        "timestamp": 1710709814
    },
    {
        "content": "<p>Also, for components there is <code>wasm-tools component wit</code> that will show the world representation of the component as WIT, which can be one way of seeing its imports and exports.</p>",
        "id": 427264700,
        "sender_full_name": "Peter Huene",
        "timestamp": 1710720965
    }
]