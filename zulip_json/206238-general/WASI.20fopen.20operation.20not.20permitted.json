[
    {
        "content": "<p>I am trying to use wasmtime from my own program to run a module that opens a file for reading. The file is in same folder with the runtime.<br>\nI have tried setting up WASI and the linker in the following manner after which I run the Wasm module.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Wasi</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiCtx</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">std</span>::<span class=\"n\">env</span>::<span class=\"n\">args</span><span class=\"p\">()).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Wasi Error&quot;</span><span class=\"p\">));</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">wasi</span><span class=\"p\">.</span><span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">main_module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Module</span>::<span class=\"n\">from_file</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">engine</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s\">&quot;./example_main.wasm&quot;</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">main_instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">main_module</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instance</span><span class=\"p\">(</span><span class=\"s\">&quot;example_main&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">main_instance</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s\">&quot;example_main&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;env&quot;</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>However, calling fopen in the module returns NULL and perror prints a message saying \"Operation not permitted\".<br>\nThe same code in C works fine, so file permissions are unlikely the cause. The file also has 777 permissions.</p>\n<p>I would assume that I have some permissions missing from WASI to allow it to access files.<br>\nI tried passing different switches to the program <code>./example --dir=. --dir=absolute/path/to/example/folder</code> <code>./example  -- --dir=. --dir=absolute/path/to/example/folder</code>, but none change the error message.</p>\n<p>Pointers to where the issue could be are appreciated.</p>",
        "id": 208682432,
        "sender_full_name": "Risto",
        "timestamp": 1598964868
    },
    {
        "content": "<p>Tried to use fopen with wasmtime-cli too, but it has the same error, so the problem isnt specific to my code either.</p>",
        "id": 208689308,
        "sender_full_name": "Risto",
        "timestamp": 1598968195
    },
    {
        "content": "<p>You need to use <code>WasiCtxBuilder</code> and call <a href=\"https://docs.rs/wasmtime-wasi/0.19.1/wasmtime_wasi/struct.WasiCtxBuilder.html#method.preopened_dir\"><code>preopened_dir</code></a> I think. <code>WasiCtx::new</code> takes the arguments to be passed to the wasm module, not arguments to customize <code>WasiCtx</code>.</p>",
        "id": 208691625,
        "sender_full_name": "bjorn3",
        "timestamp": 1598969224
    },
    {
        "content": "<p>It seems that the issue might be with the module itself. It was built with emscripten.<br>\nRunning the examples from here worked fine, unless compiled with emscripten <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md#executing-in-wasmtime-runtime\">https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md#executing-in-wasmtime-runtime</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md#executing-in-wasmtime-runtime\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-tutorial.md#executing-in-wasmtime-runtime\" title=\"bytecodealliance/wasmtime\">bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>",
        "id": 208692091,
        "sender_full_name": "Risto",
        "timestamp": 1598969435
    },
    {
        "content": "<p>Posted an issue about it here: <a href=\"https://github.com/emscripten-core/emscripten/issues/12094\">https://github.com/emscripten-core/emscripten/issues/12094</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/emscripten-core/emscripten/issues/12094\" style=\"background-image: url(https://avatars2.githubusercontent.com/u/46011144?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/emscripten-core/emscripten/issues/12094\" title=\"wasm_standalone fopen operation not permitted 路 Issue #12094 路 emscripten-core/emscripten\">wasm_standalone fopen operation not permitted 路 Issue #12094 路 emscripten-core/emscripten</a></div><div class=\"message_embed_description\">I am trying to compile and run the examples depicted here: https://github.com/bytecodealliance/wasmtime/blob/fbe29da5cc1c0847af176f151f114a6a535534ff/docs/WASI-tutorial.md The tools I try to use ar...</div></div></div>",
        "id": 208712167,
        "sender_full_name": "Risto",
        "timestamp": 1598977395
    }
]