[
    {
        "content": "<p>I'm building a web platform similar to Netlify/Heroku, and I'd like users to write code in Rust/AssemblyScript/... and have my platform run their code (not targeted for web). The issue I'm facing is that wasm lacks support for advanced types like structs, strings, bools, etc.</p>\n<p>Would the best solution for now be to make my users write their code with <a href=\"https://github.com/bytecodealliance/wit-bindgen\">wit-bindgen</a>?<br>\n(Their code will be generated with <a href=\"https://github.com/thalo-rs/esdl\">https://github.com/thalo-rs/esdl</a>, and implemented in Rust).</p>\n<p>I know the code users write will be very basic functions (if else kind of business logic), and all their functions are basic scalar types (string/int/float/bool) or structs with fields only of these types.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/2693d25a9019d979fb63b2275e13f696bc376364\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663932663539613333336161386263663635613431636134356339643061623631333566343531666433303964386664623865363665386533306637386161392f62797465636f6465616c6c69616e63652f7769742d62696e6467656e)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen\" title=\"GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types\">GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/thalo-rs/esdl\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/cff0a2afce09bf1a5ea9205d8da8d850cae5b13a\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303563306130316562616537343730383339393463393466313761303265363132346366333166653763313734343964656434336637316134386337663732662f7468616c6f2d72732f6573646c)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/thalo-rs/esdl\" title=\"GitHub - thalo-rs/esdl: Event Sourcing Schema Definition Language\">GitHub - thalo-rs/esdl: Event Sourcing Schema Definition Language</a></div><div class=\"message_embed_description\">Event Sourcing Schema Definition Language. Contribute to thalo-rs/esdl development by creating an account on GitHub.</div></div></div>",
        "id": 269614637,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643307245
    },
    {
        "content": "<p>I would go with writing your SDK using wit-bindgen, but handle user's data via serialization. Otherwise you will need generate your host app for each of the user's data type (or work with dynamic types of wasm imports/exports, which is not convenient at all).</p>",
        "id": 269618887,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643309119
    },
    {
        "content": "<p>I see. I am finding it quite hard to figure out how to use wit-bindgen.<br>\nWould the users need to run the cli themselves? The thing about my situation is that my library provides codegen, and they define their traits in a separate schema language.. so I will know what functions are available already.</p>",
        "id": 269697608,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643355934
    },
    {
        "content": "<p>After trying and  looking through Github issues, I have had no luck.<br>\nI came across this issue: <a href=\"https://github.com/rustwasm/wasm-bindgen/issues/2471\">https://github.com/rustwasm/wasm-bindgen/issues/2471</a><br>\nIt seems like the type interface isn't ready and won't be for quite some time sadly</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rustwasm/wasm-bindgen/issues/2471\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/6e42bccab8d53620382ea598238d0009a48f1931\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623831653939646464316438363535376234663234353533333335326231376365653663376339646436346566353739613766633037346265306235303837362f727573747761736d2f7761736d2d62696e6467656e2f6973737565732f32343731)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rustwasm/wasm-bindgen/issues/2471\" title=\"Can't work with wasm32-wasi target from rustc-2021-01-13 · Issue #2471 · rustwasm/wasm-bindgen\">Can't work with wasm32-wasi target from rustc-2021-01-13 · Issue #2471 · rustwasm/wasm-bindgen</a></div><div class=\"message_embed_description\">rust version: rustc 1.52.0-nightly (a143517d4 2021-02-16) wasm-bindgen: 0.2.71 wasm-bindgen-cli: 0.2.71 use wasm_bindgen::prelude::*; #[wasm_bindgen] pub fn greet(_name: &amp;str) { } With the abov...</div></div></div>",
        "id": 269704655,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643360159
    },
    {
        "content": "<p>It looks like your user will run Rust compiler right?<br>\nThey don't need CLI then. Instead of using cli you use procedural macro in your SDK or generated code:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wit_bindgen_rust</span>::<span class=\"n\">export</span><span class=\"p\">(</span><span class=\"s\">\"some-wit-file.wit\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"n\">wit_bindgen_rust</span>::<span class=\"n\">import</span><span class=\"p\">(</span><span class=\"s\">\"other-wit-file.wit\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And then use types generated. For <code>export</code> to work you will need a new structure and implement a trait. Compiler will guide you through this (by error messages).</p>\n<p>You can use CLI to generate another copy of the code just to see what is being generated (or alternatively use <code>cargo expand</code>)</p>",
        "id": 269713988,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643365149
    },
    {
        "content": "<p>Generally, yes it's a bit rough. And documentation is lacking.</p>",
        "id": 269714025,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643365180
    },
    {
        "content": "<p>(fwiw, we're very much aware. All of this is evolving rapidly and will be in a much better shape with fewer rough edges and more stability soon(-ish))</p>",
        "id": 269731410,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1643374767
    },
    {
        "content": "<p>Is the <code>wit_bindgen_rust</code> crate published on <a href=\"http://crates.io\">crates.io</a>? Or could I import it from git directly?</p>",
        "id": 269785227,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643396377
    },
    {
        "content": "<p>Importing from git works just fine</p>",
        "id": 269785546,
        "sender_full_name": "Fabrice Desré",
        "timestamp": 1643396481
    },
    {
        "content": "<p>I was struggling with it because it doesnt seem to be in the cargo workspace, and is nested in crates directory</p>",
        "id": 269785608,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643396508
    },
    {
        "content": "<p>Pretty much what I'm trying to do is:</p>\n<ul>\n<li>Write Rust code (and in the future hopefully this can extend to be written in Go/etc...)</li>\n<li>Compile to wasm</li>\n<li>Import and run wasm from other Rust code</li>\n</ul>",
        "id": 269785637,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643396520
    },
    {
        "content": "<p>I have that in my Cargo.toml :</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"n\">dependencies</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"o\">-</span><span class=\"n\">rust</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"https://github.com/bytecodealliance/wit-bindgen.git\"</span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 269785820,
        "sender_full_name": "Fabrice Desré",
        "timestamp": 1643396585
    },
    {
        "content": "<p>Can I write rust code and have my wit file generated from the Rust code?</p>",
        "id": 269786114,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643396682
    },
    {
        "content": "<p>There is <a href=\"https://github.com/bnjjj/witgen\">https://github.com/bnjjj/witgen</a> but I'm not sure what the state it is.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bnjjj/witgen\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/07f0e030f2fd604f3f87a5168dce2078f7bfb408\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376639376338636262336163323464316339633936323938363266306238656264386338633935353932636232323332326464383466653666656436383165632f626e6a6a6a2f77697467656e)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bnjjj/witgen\" title=\"GitHub - bnjjj/witgen: witgen is a library to generate .wit files for WebAssembly in Rust\">GitHub - bnjjj/witgen: witgen is a library to generate .wit files for WebAssembly in Rust</a></div><div class=\"message_embed_description\">witgen is a library to generate .wit files for WebAssembly in Rust - GitHub - bnjjj/witgen: witgen is a library to generate .wit files for WebAssembly in Rust</div></div></div>",
        "id": 269786341,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643396764
    },
    {
        "content": "<p>Ah okay, sorry I'm still trying to understand the details.<br>\nWould the library author of the wasm code use <code>wit_bindgen_rust::export</code>, and my rust code that wants to use their wasm would use <code>wit_bindgen_rust::import</code>?</p>",
        "id": 269786607,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643396862
    },
    {
        "content": "<p>For example, I want to write an add function. I have a wit file:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">add</span>: <span class=\"nc\">function</span><span class=\"p\">(</span><span class=\"n\">input</span>: <span class=\"nc\">string</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">string</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And then Rust <a href=\"http://lib.rs\">lib.rs</a> file:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wit_bindgen_rust</span>::<span class=\"n\">import</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"n\">import</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"./witgen.wit\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">add</span><span class=\"p\">(</span><span class=\"n\">input</span>: <span class=\"nb\">String</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">String</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">format!</span><span class=\"p\">(</span><span class=\"s\">\"{} there\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 269786814,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643396921
    },
    {
        "content": "<p>But I'm not exactly sure what I'm doing.. if I need to use a proc macro on my add function (eg wasm_bindgen, or if wit_bindgen is a replacement for that..)</p>",
        "id": 269786888,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643396949
    },
    {
        "content": "<p>This example might explain it:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wit_bindgen_rust</span>::<span class=\"n\">import</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"n\">import</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"./witgen.wit\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">witgen</span>::<span class=\"n\">add</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Hello {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"s\">\"hello\"</span><span class=\"p\">));</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Importing is to get this function from the host app. <code>import</code> macro will declare a function in a module that is named after the file. So common case is to rexport it from the module that uses <code>import</code> macro (<code>pub use module_name::func_name;</code>).</p>",
        "id": 269787742,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643397346
    },
    {
        "content": "<p>Ah okay so import is for importing a wit file.. but how should I export?<br>\nThe export macro seems to expect me to define a type with the same name or something</p>",
        "id": 269788391,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643397634
    },
    {
        "content": "<p>Also, should I be using a specific wasm builder with this?</p>",
        "id": 269788420,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643397655
    },
    {
        "content": "<p>Like wasm-pack, or wasmtime, etc</p>",
        "id": 269788480,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643397678
    },
    {
        "content": "<p>Yeah, you just make an empty structure, and put function on it's implementation (note no self, just use type as a module):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"witgen.wit\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"k\">struct</span> <span class=\"nc\">Witgen</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">witgent</span>::<span class=\"n\">Witgen</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Witgen</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">fn</span> <span class=\"nf\">add</span><span class=\"p\">(</span><span class=\"n\">inp</span>: <span class=\"nb\">String</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">String</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">format!</span><span class=\"p\">(</span><span class=\"s\">\"{} there\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 269788901,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643397883
    },
    {
        "content": "<blockquote>\n<p>Also, should I be using a specific wasm builder with this?</p>\n</blockquote>\n<p>No. No specific builder, just regular <code>cargo build --target=wasm32-wasi</code> (or <code>wasm32-unknown-unknown</code>)</p>",
        "id": 269789011,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643397933
    },
    {
        "content": "<p>Okay so I have made a project.<br>\n<code>/app.wit</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">add</span>: <span class=\"nc\">function</span><span class=\"p\">(</span><span class=\"n\">input</span>: <span class=\"nc\">string</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">string</span><span class=\"w\"></span>\n</code></pre></div>\n<p><code>/src/lib.rs</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wit_bindgen_rust</span>::<span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"./app.wit\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"k\">struct</span> <span class=\"nc\">App</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">app</span>::<span class=\"n\">App</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">App</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">add</span><span class=\"p\">(</span><span class=\"n\">input</span>: <span class=\"nb\">String</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">String</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"fm\">format!</span><span class=\"p\">(</span><span class=\"s\">\"{} there\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p><code>/src/main.rs</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wit_bindgen_rust</span>::<span class=\"n\">import</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"n\">import</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"./app.wit\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">app</span>::<span class=\"n\">add</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Hello {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"s\">\"hello\"</span><span class=\"p\">));</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Then I build the lib:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ cargo build --target wasm32-wasi --lib --release\n</code></pre></div>\n<p>And try to run the app:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ cargo run\n</code></pre></div>",
        "id": 269789642,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643398227
    },
    {
        "content": "<p>But I get this:</p>\n<blockquote>\n<p>error: linking with <code>cc</code> failed: exit status: 1</p>\n</blockquote>",
        "id": 269789668,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643398244
    },
    {
        "content": "<p>I must be missing something.. I'm not sure where it imports the wasm file from</p>",
        "id": 269789702,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643398269
    },
    {
        "content": "<p>I tried to move the app.wasm file from /target to the root of my project</p>",
        "id": 269789937,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643398385
    },
    {
        "content": "<p>Oh. well well, <code>wit_bindgen_rust</code> is only for in-wasm part. And you have to write full wasmtime-based runner/host for that. And use <code>wit_bindgen_wasmtime</code> for the host app.</p>",
        "id": 269790036,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643398442
    },
    {
        "content": "<p>Along the lines of this: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/wasi/main.rs\">https://github.com/bytecodealliance/wasmtime/blob/main/examples/wasi/main.rs</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/wasi/main.rs\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/6d3906e195d975ab5da41f55ec22136588215064\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613430656666653138323634363037366637396639643861623861643663643131613361656164376638386434386430346230623961383832383436326161302f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/examples/wasi/main.rs\" title=\"wasmtime/main.rs at main · bytecodealliance/wasmtime\">wasmtime/main.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - wasmtime/main.rs at main · bytecodealliance/wasmtime</div></div></div>",
        "id": 269790207,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643398518
    },
    {
        "content": "<p>Unless what you're trying it to link two wasm modules, then wasmtime-cli might have a some way to do that, I'm not sure.</p>",
        "id": 269790386,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643398590
    },
    {
        "content": "<p>Oh cool thank you, I'll have a look!</p>",
        "id": 269790849,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643398809
    },
    {
        "content": "<p>I've made a Github repo showing what I'm trying and how its not working. If anyone could take a look, it would be really appreciated... I feel like I'm almost there, but maybe missing one last thing.</p>\n<p><a href=\"https://github.com/tqwewe/wasmer-wasi\">https://github.com/tqwewe/wasmer-wasi</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tqwewe/wasmer-wasi\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/62fb8f86bbe051cb22fdd72aa884a18184bce96c\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306433646665313562316662303430646132383331636266346134646530366333316364313435383131383531313031343564303665396634363731303166332f7471776577652f7761736d65722d77617369)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tqwewe/wasmer-wasi\" title=\"GitHub - tqwewe/wasmer-wasi: Issues with wasmer and wasi\">GitHub - tqwewe/wasmer-wasi: Issues with wasmer and wasi</a></div><div class=\"message_embed_description\">Issues with wasmer and wasi. Contribute to tqwewe/wasmer-wasi development by creating an account on GitHub.</div></div></div>",
        "id": 269796329,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643401028
    },
    {
        "content": "<p>The README.md shows the commands and my error</p>",
        "id": 269796379,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643401039
    },
    {
        "content": "<p><a href=\"https://github.com/tqwewe/wasmer-wasi/blob/main/runner/src/main.rs\">https://github.com/tqwewe/wasmer-wasi/blob/main/runner/src/main.rs</a><br>\nShould use <code>wit_bindgen_wasmtime</code> (not <code>wit_bindgen_rust</code>, <code>_rust</code> is for wasm-compiled modules)</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tqwewe/wasmer-wasi/blob/main/runner/src/main.rs\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/62fb8f86bbe051cb22fdd72aa884a18184bce96c\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306433646665313562316662303430646132383331636266346134646530366333316364313435383131383531313031343564303665396634363731303166332f7471776577652f7761736d65722d77617369)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tqwewe/wasmer-wasi/blob/main/runner/src/main.rs\" title=\"wasmer-wasi/main.rs at main · tqwewe/wasmer-wasi\">wasmer-wasi/main.rs at main · tqwewe/wasmer-wasi</a></div><div class=\"message_embed_description\">Issues with wasmer and wasi. Contribute to tqwewe/wasmer-wasi development by creating an account on GitHub.</div></div></div>",
        "id": 269822098,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643415205
    },
    {
        "content": "<p>Hm I tried it in the runner package <a href=\"http://main.rs\">main.rs</a>, but I get an error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">domain</span>::<span class=\"n\">add</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"c1\">//      ^^^^^^^^^^^ no `add` in `domain`</span>\n</code></pre></div>\n<p>This is just from replacing <code>wit_bindgen_rust</code> with <code>wit_bindgen_wasmtime</code> in Cargo.toml and <a href=\"http://main.rs\">main.rs</a>.</p>\n<p>I thought the domain package (lib) also needs to use <code>wit_bindgen_wasmtime</code>, but when trying to build the wasm I get a bunch of errors:</p>\n<blockquote>\n<p>thread 'main' panicked at 'error when identifying target: \"no supported isa found for arch <code>wasm32</code>\"', /Users/ari/.cargo/registry/src/github.com-1ecc6299db9ec823/cranelift-codegen-0.80.0/build.rs:42:53</p>\n</blockquote>",
        "id": 269848285,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643443800
    },
    {
        "content": "<p>I see.. looks like I need to <code>pub use domain::Domain</code>... and then use <code>Domain::new(...)</code></p>",
        "id": 269848719,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643444316
    },
    {
        "content": "<p>I just need to figure out the right arguments to provide for <code>::new(...)</code>... and <code>caller: impl AsContextMut&lt;Data = T&gt;,</code> for when calling <code>.add()</code></p>",
        "id": 269848740,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643444373
    },
    {
        "content": "<p><a href=\"https://github.com/tqwewe/wasmer-wasi/blob/main/runner/src/main.rs\">https://github.com/tqwewe/wasmer-wasi/blob/main/runner/src/main.rs</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tqwewe/wasmer-wasi/blob/main/runner/src/main.rs\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/62fb8f86bbe051cb22fdd72aa884a18184bce96c\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306433646665313562316662303430646132383331636266346134646530366333316364313435383131383531313031343564303665396634363731303166332f7471776577652f7761736d65722d77617369)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tqwewe/wasmer-wasi/blob/main/runner/src/main.rs\" title=\"wasmer-wasi/main.rs at main · tqwewe/wasmer-wasi\">wasmer-wasi/main.rs at main · tqwewe/wasmer-wasi</a></div><div class=\"message_embed_description\">Issues with wasmer and wasi. Contribute to tqwewe/wasmer-wasi development by creating an account on GitHub.</div></div></div>",
        "id": 269849636,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643445423
    },
    {
        "content": "<p>That works... but I don't know if my approach is correct.<br>\nI did:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">WasiCtxBuilder</span>::<span class=\"n\">new</span><span class=\"p\">()</span><span class=\"o\">..</span><span class=\"p\">.;</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">domain_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">.</span><span class=\"n\">table</span><span class=\"p\">().</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">DomainData</span>::<span class=\"n\">default</span><span class=\"p\">()))</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"n\">Domain</span>::<span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">module</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"p\">.</span><span class=\"n\">table</span><span class=\"p\">().</span><span class=\"n\">get_mut</span>::<span class=\"o\">&lt;</span><span class=\"n\">DomainData</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">domain_index</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"c1\">// This doesnt seem very right...</span>\n<span class=\"p\">})</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 269849684,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643445477
    },
    {
        "content": "<p>It looks like you've pushed your domain data to the WASI file descriptor table. It will work, but there is a simpler way.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// create your own Data structure</span>\n<span class=\"k\">struct</span> <span class=\"nc\">Data</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">//wasi structure here</span>\n<span class=\"w\">  </span><span class=\"n\">wasi</span>: <span class=\"nc\">wasmtime_wasi</span>:<span class=\"nc\">sync</span>::<span class=\"n\">WasiCtx</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// and any extra data for wasm here, including domain data:</span>\n<span class=\"w\">  </span><span class=\"n\">domain</span>: <span class=\"nc\">DomainData</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"c1\">// then instead of passing wasi directly to `Store` use your own Data:</span>\n<span class=\"n\">Store</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Data</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">domain</span><span class=\"w\"> </span><span class=\"p\">});</span><span class=\"w\"></span>\n<span class=\"c1\">// in all linking functions use an attribute</span>\n<span class=\"n\">wasmtime_wasi</span>::<span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">.</span><span class=\"n\">wasi</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"n\">Domain</span>::<span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">module</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">.</span><span class=\"n\">domain</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>In some cases you need to specify type on these lambdas like <code>|s: &amp;mut Data| s.wasi</code>.</p>",
        "id": 269859702,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643457461
    },
    {
        "content": "<p>Worked perfectly! Thank you so much, this is exactly what I was looking for since a few days ago</p>",
        "id": 269860248,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643458015
    },
    {
        "content": "<p>So this approach should allow possibly Golang or Python to write the library side of it?</p>",
        "id": 269860276,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643458050
    },
    {
        "content": "<p>In theory, yes. But I think there is no codegen for them yet. Also in Go I think standard compiler is tied to browser (GOOS=js), although tinygo should work if you write bindings manually. Similarly with Python there are few ways to compile it for wasm including RustPython and Pyodide, I'm not sure what is the state of any of that.</p>",
        "id": 269862269,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643460524
    },
    {
        "content": "<p>Is it possible to dynamically call functions with wit? For example, load a wit file and execute a function at runtime of a Rust app?</p>",
        "id": 269869837,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643469275
    },
    {
        "content": "<p>In theory yes. With current implementation -- no, as far as I understand. Wasmtime allows to call functions dynamically, so you can use the parser of wit and build function arguments manually.</p>\n<p>But I'm also not sure what's the point. If you want to user-specified JSON and give it to wasm for processing, just feed that json to wasm directly instead of deserializing it and building wasmtime signature of it.</p>",
        "id": 269870293,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643469765
    },
    {
        "content": "<p>I see, I guess the simple approach is json (de)serialize like you suggested.<br>\nBut in my case, I am building a platform where users can upload/submit a wasm file, but along with the wasm file is a schema file similar to .wit files.<br>\nSo it would be beneficial for my system to be able to call their functions directly as I know the function signatures available</p>",
        "id": 269871197,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643470786
    },
    {
        "content": "<p>Otherwise the users have to use a standardized function which takes the data as json and they have to deserialize it themselves</p>",
        "id": 269871256,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643470814
    },
    {
        "content": "<p>The only problem with wasmtime dynamic calling, is I don't think it is easy to do with non-number types</p>",
        "id": 269871383,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643470945
    },
    {
        "content": "<p><a href=\"https://docs.rs/wasmtime/latest/wasmtime/struct.Instance.html#method.get_typed_func\">https://docs.rs/wasmtime/latest/wasmtime/struct.Instance.html#method.get_typed_func</a></p>",
        "id": 269871386,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643470947
    },
    {
        "content": "<p>Typed func needs params and return types to be <code>WasmTy</code>, which is only implemented for numeric types it seems.. unless there's a different way of doing it</p>",
        "id": 269871410,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643470984
    },
    {
        "content": "<p>Take a look what <code>wit-bindgen-cli wasmtime your.wit</code> generates. You have to use ints as pointers and read the wasm VM's memory.</p>",
        "id": 269871620,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643471253
    },
    {
        "content": "<p>Yeah I was just about to say that</p>",
        "id": 269871629,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643471266
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 269871636,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643471274
    },
    {
        "content": "<p>I guess I'd have to rewrite this code</p>",
        "id": 269871680,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643471293
    },
    {
        "content": "<p><a href=\"/user_uploads/15107/weH6M3kOgf3-voDDmEeSFSZU/Screen-Shot-2022-01-29-at-10.47.32-pm.png\">Screen-Shot-2022-01-29-at-10.47.32-pm.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/15107/weH6M3kOgf3-voDDmEeSFSZU/Screen-Shot-2022-01-29-at-10.47.32-pm.png\" title=\"Screen-Shot-2022-01-29-at-10.47.32-pm.png\"><img src=\"/user_uploads/15107/weH6M3kOgf3-voDDmEeSFSZU/Screen-Shot-2022-01-29-at-10.47.32-pm.png\"></a></div>",
        "id": 269871684,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643471302
    },
    {
        "content": "<p>Generally it looks like you'll be using wit as json-schema. I'm not sure this is a the best idea. JSON schema (or most other validators) are more powerful and rich in types. Although, I like variant types in wit, so it may be good idea.</p>",
        "id": 269871837,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643471511
    },
    {
        "content": "<p>I made a schema language <a href=\"https://github.com/thalo-rs/esdl\">https://github.com/thalo-rs/esdl</a><br>\nFrom ESDL files, it generates Rust code for the user. So given that I know the Rust code from this schema, I could probably some library that can dynamically call based on the schema file.. but it seems like a deep rabbit hole to go down, especially since I'm not very familiar with how wasm works under the hood</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/thalo-rs/esdl\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/cff0a2afce09bf1a5ea9205d8da8d850cae5b13a\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303563306130316562616537343730383339393463393466313761303265363132346366333166653763313734343964656434336637316134386337663732662f7468616c6f2d72732f6573646c)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/thalo-rs/esdl\" title=\"GitHub - thalo-rs/esdl: Event Sourcing Schema Definition Language\">GitHub - thalo-rs/esdl: Event Sourcing Schema Definition Language</a></div><div class=\"message_embed_description\">Event Sourcing Schema Definition Language. Contribute to thalo-rs/esdl development by creating an account on GitHub.</div></div></div>",
        "id": 269871902,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643471556
    },
    {
        "content": "<p>I could probably piggy back off the <code>wit_bindgen_wasmtime</code> import macro in some way if I did go down that route</p>",
        "id": 269872002,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643471675
    },
    {
        "content": "<p>So you probably can generate structures and serde signatures for esdl, and make it transparent for users whether there is serde or wit under the hood?</p>",
        "id": 269872033,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643471729
    },
    {
        "content": "<p>I'm not sure I understand completely, but my main goal is go keep things as simple as possible for users writing the code which will be compiled to wasm.<br>\n<a href=\"https://github.com/thalo-rs/thalo/tree/main/examples/bank-account\">https://github.com/thalo-rs/thalo/tree/main/examples/bank-account</a><br>\nI'd like them to be able to just write this basic code, and upload the WASM + ESDL/Wit file to my platform, and my platform can run their commands defined</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/thalo-rs/thalo/tree/main/examples/bank-account\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/59d0d6f257f4c8fe00e7bda7a0b38f0ec46a149b\\/68747470733a2f2f7265706f7369746f72792d696d616765732e67697468756275736572636f6e74656e742e636f6d2f3432353136353530392f38343165316262362d666236622d343636302d386164322d356261343838323538633739)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/thalo-rs/thalo/tree/main/examples/bank-account\" title=\"thalo/examples/bank-account at main · thalo-rs/thalo\">thalo/examples/bank-account at main · thalo-rs/thalo</a></div><div class=\"message_embed_description\">🚀 Event sourcing suite for Rust 🦀. Contribute to thalo-rs/thalo development by creating an account on GitHub.</div></div></div>",
        "id": 269872228,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643471957
    },
    {
        "content": "<p>Hm. It looks like you're doing exactly that (generating serde models) in generated code :)</p>",
        "id": 269872642,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643472341
    },
    {
        "content": "<p>Yep, additionally a trait for users to implement</p>",
        "id": 269872719,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643472385
    },
    {
        "content": "<p>(in the example, it's <code>BankAccountCommand</code> trait)</p>",
        "id": 269872727,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643472401
    },
    {
        "content": "<p>So I'd use some <code>process_event: function (data: list&lt;u8&gt;) -&gt; list&lt;u8&gt;</code> signature and use the same codegen or a macro to generate necessary ser/de calls. So users don't have to come with their own <code>wit</code> file for each <code>esdl</code> file. This sounds friendlier to users. No?</p>",
        "id": 269873000,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643472663
    },
    {
        "content": "<p>Yeah if I understand correctly, I started doing something like that. Making a standard wit file they use:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">apply</span>: <span class=\"nc\">function</span><span class=\"p\">(</span><span class=\"n\">event</span>: <span class=\"nc\">string</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">string</span><span class=\"w\"></span>\n<span class=\"n\">handle</span>: <span class=\"nc\">function</span><span class=\"p\">(</span><span class=\"n\">command</span>: <span class=\"nc\">string</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">string</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And all the wasm files use this wit file. And the users code would have some kind of macro or helper to define these methods which kind of wires things up from within the wasm module itself</p>",
        "id": 269873162,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643472841
    },
    {
        "content": "<p>Going with that approach seems to make the most sense</p>",
        "id": 269873205,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643472852
    },
    {
        "content": "<p>Is <code>_</code> valid in wit files?<br>\nI was looking here: <a href=\"https://github.com/WebAssembly/interface-types/blob/main/proposals/interface-types/Explainer.md#interface-types\">https://github.com/WebAssembly/interface-types/blob/main/proposals/interface-types/Explainer.md#interface-types</a><br>\nAnd I see for expected:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">intertype</span><span class=\"o\">&gt;?</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">intertype</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And tried <code>apply: function(event: list&lt;u8&gt;) -&gt; expected&lt;_, s64&gt;</code> in the online playground and it seemed to work</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/interface-types/blob/main/proposals/interface-types/Explainer.md#interface-types\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/ceb7f3fe118a8339971a8a5ba1dbfd30cd569f87\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653064386132616438623264636632646464626163396236396237666239636566396537373462666663353766663631623337393930316434383162356162302f576562417373656d626c792f696e746572666163652d7479706573)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/interface-types/blob/main/proposals/interface-types/Explainer.md#interface-types\" title=\"interface-types/Explainer.md at main · WebAssembly/interface-types\">interface-types/Explainer.md at main · WebAssembly/interface-types</a></div><div class=\"message_embed_description\">Contribute to WebAssembly/interface-types development by creating an account on GitHub.</div></div></div>",
        "id": 269884626,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643485958
    },
    {
        "content": "<p>Note the first generic of expected is <code>_</code> in <code>expected&lt;_, s64&gt;</code></p>",
        "id": 269884894,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643486120
    },
    {
        "content": "<p>Yeah, looks like it stands for rustish <code>()</code>. I think it doesn't work in any other case except in <code>expected</code> though.</p>",
        "id": 269887481,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643488903
    },
    {
        "content": "<p>I think I got a nice generic approach which should work with many different implementations.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// domain.wit</span>\n\n<span class=\"c1\">// Errors which can occur</span>\n<span class=\"n\">variant</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">command</span><span class=\"p\">(</span><span class=\"n\">list</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">deserialize</span><span class=\"o\">-</span><span class=\"n\">state</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">deserialize</span><span class=\"o\">-</span><span class=\"n\">event</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">deserialize</span><span class=\"o\">-</span><span class=\"n\">command</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">serialize</span><span class=\"o\">-</span><span class=\"n\">state</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"c1\">// Creates a new instance</span>\n<span class=\"c1\">// Returns state</span>\n<span class=\"n\">new</span><span class=\"o\">-</span><span class=\"n\">instance</span>: <span class=\"nc\">function</span><span class=\"p\">(</span><span class=\"n\">id</span>: <span class=\"nc\">string</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">expected</span><span class=\"o\">&lt;</span><span class=\"n\">list</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n\n<span class=\"c1\">// Takes state, event</span>\n<span class=\"c1\">// Returns new state</span>\n<span class=\"n\">apply</span><span class=\"o\">-</span><span class=\"n\">event</span>: <span class=\"nc\">function</span><span class=\"p\">(</span><span class=\"n\">state</span>: <span class=\"nc\">list</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">event</span>: <span class=\"nc\">list</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">expected</span><span class=\"o\">&lt;</span><span class=\"n\">list</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n\n<span class=\"c1\">// Takes state, command</span>\n<span class=\"c1\">// Returns list of events</span>\n<span class=\"n\">handle</span><span class=\"o\">-</span><span class=\"n\">command</span>: <span class=\"nc\">function</span><span class=\"p\">(</span><span class=\"n\">state</span>: <span class=\"nc\">list</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">command</span>: <span class=\"nc\">list</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">expected</span><span class=\"o\">&lt;</span><span class=\"n\">list</span><span class=\"o\">&lt;</span><span class=\"n\">list</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 269924432,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643537800
    },
    {
        "content": "<p>I wrote a bunch of magic in the <code>thalo::include_aggregate!(\"BankAccount\");</code> macro, and it makes that bank example code I sent above just work as is (just need to add the domain.wit file to the project</p>",
        "id": 269924458,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643537866
    },
    {
        "content": "<hr>\n<p>Regarding the struct which implements the trait from <code>wit_bindgen_rust::export!(\"./domain.wit\");</code>... I cannot store anything there in wasm?<br>\nAs in, none of the wit methods take self, so I cannot maintain state there.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wit_bindgen_rust</span>::<span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"./domain.wit\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"k\">struct</span> <span class=\"nc\">Domain</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">};</span><span class=\"w\"> </span><span class=\"c1\">// the state inside cannot be used from my wasm module?</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">domain</span>::<span class=\"n\">Domain</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Domain</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">my_function</span><span class=\"p\">(</span><span class=\"n\">foo</span>: <span class=\"nb\">String</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"c1\">// Doesn't take self... cannot use any of the state?</span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 269925030,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643538621
    },
    {
        "content": "<p>I put my function calls in a loop 100,000 times and timed it.<br>\nFrom Rust, calling wasm functions I got: ~920ms average</p>\n<p>When I call the functions in pure Rust without compiling to wasm, I get: ~140ms average</p>",
        "id": 269926782,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643540990
    },
    {
        "content": "<p>Is that just the performance of wasm? Can I expect that to improve with time?</p>",
        "id": 269926827,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1643541006
    },
    {
        "content": "<p>You can use <code>resource</code> to keep state: <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/main/WIT.md#item-resource\">https://github.com/bytecodealliance/wit-bindgen/blob/main/WIT.md#item-resource</a> (or just use global/static variables in Rust).</p>\n<p>Regarding performance. I can't comment on specific numbers. But generally yes, some overhead is expected. You can probably send events in batches to make the overhead smaller.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/blob/main/WIT.md#item-resource\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/43a41ed5bd7db3399af305ea88269ee736bf52a6\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623934666365386430323764616365353136316335313938663434353136633436383930376431323633386533303832356332646538626537303130366236612f62797465636f6465616c6c69616e63652f7769742d62696e6467656e)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/main/WIT.md#item-resource\" title=\"wit-bindgen/WIT.md at main · bytecodealliance/wit-bindgen\">wit-bindgen/WIT.md at main · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - wit-bindgen/WIT.md at main · bytecodealliance/wit-bindgen</div></div></div>",
        "id": 269962690,
        "sender_full_name": "Paul Colomiets",
        "timestamp": 1643582941
    },
    {
        "content": "<p>Are resources still a thing in the wit spec?<br>\nI'm trying to use it on the wit playground &lt;<a href=\"https://bytecodealliance.github.io/wit-bindgen/\">https://bytecodealliance.github.io/wit-bindgen/</a>&gt;... but it doesn't parse the syntax correctly.</p>",
        "id": 308927548,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1668061846
    },
    {
        "content": "<p>I don't know when the playground was last deployed or if it even uses git version of wit but at this point wit is so much in fluctuation that I would always test locally</p>",
        "id": 308980971,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1668084487
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"550770\">Ramon Klass</span> <a href=\"#narrow/stream/206238-general/topic/Building.20a.20platform.20for.20users.20to.20deploy.20wasm.20libraries/near/308980971\">said</a>:</p>\n<blockquote>\n<p>I don't know when the playground was last deployed or if it even uses git version of wit but at this point wit is so much in fluctuation that I would always test locally</p>\n</blockquote>\n<p>I also tested it locally and sadly got the same results. I was even using the dependency from git main branch</p>",
        "id": 308992728,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1668088344
    },
    {
        "content": "<p>Resources remain part of the WIT spec but have been (temporarily) removed from implementations to ease transition to the component model. ref: <a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/346\">https://github.com/bytecodealliance/wit-bindgen/pull/346</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/pull/346\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/2d149979eca38a89cfe0c93fea0f829652870463\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306666303336663264326539646263613566396162613030623938626135353833303465333164343963313931623563616534303635663335333466356566302f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f333436)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/346\" title=\"Remove support for handles and resources by alexcrichton · Pull Request #346 · bytecodealliance/wit-bindgen\">Remove support for handles and resources by alexcrichton · Pull Request #346 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">This commit removes all support for the resource and Handle types from the AST of wit-parser and all related support in all code generators. The motivation for this commit is that wit-bindgen is on...</div></div></div>",
        "id": 308993974,
        "sender_full_name": "Lann Martin",
        "timestamp": 1668088738
    },
    {
        "content": "<p>Resources are not currently part of the component model but the plan is that they're the next feature to add</p>",
        "id": 309011027,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1668093544
    },
    {
        "content": "<p>Is there anywhere I can follow updates about resources support?</p>",
        "id": 311937664,
        "sender_full_name": "Ari Seyhun",
        "timestamp": 1669260954
    },
    {
        "content": "<p><a href=\"https://github.com/WebAssembly/component-model/pull/129\">https://github.com/WebAssembly/component-model/pull/129</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/component-model/pull/129\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/0a4b07bbbf25b16c3d66287495ca1231ac8aa2ca\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376630613732303061343964393964633664373438386535343037393066306666383366373362316237343137326562376166653139616636336638303464332f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c2f70756c6c2f313239)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/component-model/pull/129\" title=\"Add resource, own and borrow types (Draft) by lukewagner · Pull Request #129 · WebAssembly/component-model\">Add resource, own and borrow types (Draft) by lukewagner · Pull Request #129 · WebAssembly/component-model</a></div><div class=\"message_embed_description\">(I'm publishing in draft state in case anyone wants to look at it before all the TODOs are filled in.  I think the essential additions in the AST and binary format are roughly right, I'm just filli...</div></div></div>",
        "id": 314361111,
        "sender_full_name": "Bailey Hayes",
        "timestamp": 1670376832
    }
]