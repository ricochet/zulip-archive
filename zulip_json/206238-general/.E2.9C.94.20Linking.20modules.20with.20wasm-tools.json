[
    {
        "content": "<p>I met an error when generating a component with an executable wasm and a dynamic library wasm via <code>wasm-tools component link</code>, and I am wondering that I might make a mistake and hope some helps here. I am gona list all my steps below and please highlight all my mistakes no matter how minor it is.</p>\n<p>it is a simple reproduction of the shared-everything-linking example. Since I am going to use wasi-libc, I just bypass the libc code (which is in the example)</p>\n<p>Here is the code</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"c1\">// libzip.h</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdlib.h&gt;</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">import_module</span><span class=\"p\">(</span><span class=\"s\">\"libzip\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">import_name</span><span class=\"p\">(</span><span class=\"s\">\"zip\"</span><span class=\"p\">)))</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span>\n<span class=\"n\">zip</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">in</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">in_size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">out_size</span><span class=\"p\">);</span>\n\n<span class=\"c1\">// libzip.c</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">\"libzip.h\"</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;string.h&gt;</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"zip\"</span><span class=\"p\">)))</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">zip</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">in</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">in_size</span><span class=\"p\">,</span>\n<span class=\"w\">                                              </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">out_size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"--&gt; in zip()</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">in_size</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">in</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">in_size</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"o\">*</span><span class=\"n\">out_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">in_size</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// zipper.c</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">\"libzip.h\"</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdio.h&gt;</span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"-- in zipper main()</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">in</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">out_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">zip</span><span class=\"p\">(</span><span class=\"n\">in</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">out_size</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">out_size</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I use  <code>/opt/wasi-sdk-21.0/bin/clang -fPIC -shared libzip.so libzip.c</code> to build a shared library wasm and <code>/opt/wasi-sdk-21.0/bin/clang -fPIC -pie -Wl,--import-memory -o zipper.wasm zipper.c</code> to build an executable wasm. (<code>--import-memory</code> is necessary here since all wasm modules in one component are sharing the memory, IIUC)</p>\n<p>Then, I tried to use <code>/opt/wasm-tools-1.201.0-x86_64-linux/wasm-tools component link -t -o zipper.component.wat libc.so=/opt/wasi-sdk-21.0/share/wasi-sysroot/lib/wasm32-wasi/libc.so libzipper.so zipper.wasm</code> to create a component (in .wat). </p>\n<p>And I got an error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">modules</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">validate</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">output</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">missing</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">instantiation</span><span class=\"w\"> </span><span class=\"n\">argument</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">libzip</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mh\">0x6bc2</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Plus, adding <code>--adapt wasi_snapshot_preview1=./wasi_snapshot_preview1.command.wasm</code> won't fix the error.</p>",
        "id": 430748081,
        "sender_full_name": "lum1n0us",
        "timestamp": 1712049792
    },
    {
        "content": "<p>Hi.  Looks like you're trying to repro the example from <a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md\">https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md</a>, right?  That example was written before <code>wasm-tools component link</code> even existed, and the implementation in <code>wit-component</code> (which is what provides <code>wasm-tools component link</code>) works differently than that document describes.  Specifically, the inputs are expected to all be dynamic libraries which adhere to <a href=\"https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md\">https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md</a>.  They should all import a memory and function table, and none of them is the \"main\" module.  Instead, <code>wit-component</code> will synthesize a main module which provides the memory and function table which the user-supplied modules import.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/d9f2f6e9135d40597d610faf293968ef257d345a\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366639666639626139326162633461383737633531326364306538363136333563643232326631633336386432306535613964636664643239363436323236612f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md\" title=\"component-model/design/mvp/examples/SharedEverythingDynamicLinking.md at main · WebAssembly/component-model\">component-model/design/mvp/examples/SharedEverythingDynamicLinking.md at main · WebAssembly/component-model</a></div><div class=\"message_embed_description\">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/2004e71472b8f330dedabd13dba60ccb6c23726c\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666632333738663231626664393164353663343366383837613738303164626237373435353230353263356464383939346432393839633764356338613862362f576562417373656d626c792f746f6f6c2d636f6e76656e74696f6e73)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md\" title=\"tool-conventions/DynamicLinking.md at main · WebAssembly/tool-conventions\">tool-conventions/DynamicLinking.md at main · WebAssembly/tool-conventions</a></div><div class=\"message_embed_description\">Conventions supporting interoperatibility between tools working with WebAssembly. - WebAssembly/tool-conventions</div></div></div>",
        "id": 430831955,
        "sender_full_name": "Joel Dice",
        "timestamp": 1712076288
    },
    {
        "content": "<p>Hypothetically, we could add support to <code>wit-component</code> for allowing the user to provide the \"main\" module instead of synthesizing it, but that's not currently supported (and I'm not sure how useful it would be beyond the current mode of operation anyway).</p>",
        "id": 430832877,
        "sender_full_name": "Joel Dice",
        "timestamp": 1712076587
    },
    {
        "content": "<p>BTW, I also notice that you didn't provide <code>libzip.so</code> as one of the parameters to <code>wasm-tools component link</code>.  Was that a deliberate omission?  Note that <code>wasm-tools component link</code> does not yet support generating components which import modules, although that would definitely be a useful feature and I plan to add it someday if nobody beats me to it.</p>",
        "id": 430833221,
        "sender_full_name": "Joel Dice",
        "timestamp": 1712076704
    },
    {
        "content": "<p>Yes. I am trying to repro the example from <a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md\">https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md</a>. </p>\n<p><em>main</em> module is not mandatory. It is just my guess and it's wrong.  I have fixed it by building <em>zipper.wasm</em> as a shared library too.  </p>\n<p>Add <code>libzipper.so</code> to command which now is <code>/opt/wasm-tools-1.201.0-x86_64-linux/wasm-tools component link -t -o zipper.component.wat libc.so=/opt/wasi-sdk-21.0/share/wasi-sysroot/lib/wasm32-wasi/libc.so libzipper.so=libzipper.so zipper.wasm</code>. Run it and the error from <em>wit-component</em> has gone. But more questions are raised.</p>\n<ul>\n<li>use <code>/opt/wasi-sdk-21.0/bin/clang -fPIC --shared -o zipper.wasm zipper.c</code>and check <em>zipper.wasm</em>. In its <em>@dylink.0</em> section, <code>needed</code> value is <em>libc.so</em>. But I guess it should be <em>libzipper.so</em>. or <em>zipper</em>. So, is there a way to tell clang how to fill in <em>needed</em> of <em>@dylink.0</em> ==?</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"o\">@</span><span class=\"n\">dylink</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">mem</span><span class=\"o\">-</span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">needed</span><span class=\"w\"> </span><span class=\"s\">\"libc.so\"</span><span class=\"p\">)</span><span class=\"w\">  </span>#<span class=\"w\"> </span><span class=\"o\">&lt;==</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"s\">\"libzipper.so\"</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"s\">\"zipper\"</span>\n<span class=\"w\">  </span><span class=\"p\">)</span>\n</code></pre></div>\n<ul>\n<li>the output of  <code>wit component link</code> doesn't include anything from <em>libzipper.so</em> and <em>zipper.so</em>. It seems it only synthesize necessary <em>main</em> modules but forgot to <em>link</em>. Did I use the wrong command line optioins?<br>\n<code>\n  (component\n  (core module (;0;)\n    (table (;0;) 1 funcref)\n    (memory (;0;) 17)\n    (global (;0;) (mut i32) i32.const 1048576)\n    (global (;1;) (mut i32) i32.const 1048592)\n    (global (;2;) (mut i32) i32.const 1114112)\n    (export \"__stack_pointer\" (global 0))\n    (export \"__heap_base\" (global 1))\n    (export \"__heap_end\" (global 2))\n    (export \"__indirect_function_table\" (table 0))\n    (export \"memory\" (memory 0))\n    (@producers\n      (processed-by \"wit-component\" \"0.201.0\")\n    )\n  )\n  (core module (;1;)\n    (type (;0;) (func))\n    (type (;1;) (func (param i32)))\n    (import \"env\" \"memory\" (memory (;0;) 0))\n    (import \"env\" \"__indirect_function_table\" (table (;0;) 0 funcref))\n    (func (;0;) (type 0))\n    (start 0)\n    (elem (;0;) (i32.const 1) func)\n    (elem (;1;) (i32.const 1) func)\n    (data (;0;) (i32.const 1048576) \"\\00\\00\\00\\00\\00\\00\\10\\00\")\n    (@producers\n      (processed-by \"wit-component\" \"0.201.0\")\n    )\n  )\n  (core instance (;0;) (instantiate 0))\n  (alias core export 0 \"memory\" (core memory (;0;)))\n  (core instance (;1;) (instantiate 1\n      (with \"env\" (instance 0))\n    )\n  )\n  (@producers\n    (processed-by \"wit-component\" \"0.201.0\")\n  )\n)\n  </code></li>\n</ul>\n<p>P.S. </p>\n<p>Exactly same problem happens when I trying with WATs from <a href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wit-component/tests/components/link\">https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wit-component/tests/components/link</a>. </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">components</span><span class=\"o\">/</span><span class=\"n\">link</span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">c</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">c</span><span class=\"p\">.</span><span class=\"n\">wat</span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wat</span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">bar</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">bar</span><span class=\"p\">.</span><span class=\"n\">wat</span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">trial1</span><span class=\"p\">.</span><span class=\"n\">wat</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">=</span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">c</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">=</span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"o\">=</span><span class=\"n\">lib</span><span class=\"o\">-</span><span class=\"n\">bar</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">trail1</span><span class=\"p\">.</span><span class=\"n\">wat</span>\n<span class=\"p\">(</span><span class=\"n\">component</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">funcref</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">global</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1048576</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">global</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">1</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1048592</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">global</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">2</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1114112</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"__stack_pointer\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">global</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"__heap_base\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">global</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"__heap_end\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">global</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"__indirect_function_table\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"memory\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"o\">@</span><span class=\"n\">producers</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">processed</span><span class=\"o\">-</span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"s\">\"wit-component\"</span><span class=\"w\"> </span><span class=\"s\">\"0.202.0\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">1</span><span class=\"p\">;)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"p\">(;</span><span class=\"mi\">1</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"memory\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"s\">\"__indirect_function_table\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">funcref</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">1</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">1048576</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"s\">\"</span><span class=\"se\">\\0</span><span class=\"s\">0</span><span class=\"se\">\\0</span><span class=\"s\">0</span><span class=\"se\">\\0</span><span class=\"s\">0</span><span class=\"se\">\\0</span><span class=\"s\">0</span><span class=\"se\">\\0</span><span class=\"s\">0</span><span class=\"se\">\\0</span><span class=\"s\">0\\10</span><span class=\"se\">\\0</span><span class=\"s\">0\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"o\">@</span><span class=\"n\">producers</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">processed</span><span class=\"o\">-</span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"s\">\"wit-component\"</span><span class=\"w\"> </span><span class=\"s\">\"0.202.0\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">alias</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"s\">\"memory\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">0</span><span class=\"p\">;)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(;</span><span class=\"mi\">1</span><span class=\"p\">;)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"env\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"o\">@</span><span class=\"n\">producers</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">processed</span><span class=\"o\">-</span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"s\">\"wit-component\"</span><span class=\"w\"> </span><span class=\"s\">\"0.202.0\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">)</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/ddfadfe3c59cd2ad98e4eb20d1d556c4c4742de6\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616565333933376534396364306365376333313837313037373832316436333734613432313633653365333764636330643533356131383234626263303136662f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/examples/SharedEverythingDynamicLinking.md\" title=\"component-model/design/mvp/examples/SharedEverythingDynamicLinking.md at main · WebAssembly/component-model\">component-model/design/mvp/examples/SharedEverythingDynamicLinking.md at main · WebAssembly/component-model</a></div><div class=\"message_embed_description\">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wit-component/tests/components/link\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/5bacbcaf63ea9f53fc10717fc5bff88d5ce06ed7\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633236633566353932323934623365343263656339663938653836646161396566643162383938323664303331343861353037623361313835636533623332622f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wit-component/tests/components/link\" title=\"wasm-tools/crates/wit-component/tests/components/link at main · bytecodealliance/wasm-tools\">wasm-tools/crates/wit-component/tests/components/link at main · bytecodealliance/wasm-tools</a></div><div class=\"message_embed_description\"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div>",
        "id": 430909271,
        "sender_full_name": "lum1n0us",
        "timestamp": 1712113182
    },
    {
        "content": "<p>When generating a component, <code>wasm-tools component link</code> will omit any libraries which it can prove are unreachable (and indeed omit all of them if they're all unreachable, although it should probably report an error in that case).  \"Unreachable\", in this case, means that a library neither exports any functions at the component level, nor does it provide imports to at least one other library which exports such functions, nor are any of its functions reachable via <code>dlopen</code>/<code>dlsym</code> (see the <code>--dl-openable</code> option).</p>\n<p>Based on your previous message, I take it the component-level export should be <code>wasi:cli/run@0.2.0</code> (i.e. you're making a CLI app), thus the <code>main</code> function in zipper.c.  And zipper.wasm should be importing functions from <code>libzip.so</code> and/or <code>libc.so</code>, correct?  In that case, using the header files for those libraries, building zipper.wasm as a shared library, and using the wasi_snapshot_preview1.command.wasm adapter to convert the WASIp1-style <code>_start</code> export into a WASIp2-style <code>wasi:cli/run@0.2.0</code> export should be sufficient.  No need for <code>__attribute__((import_module(...), import_name(...)))</code> or anything.  When you compile and link zipper.wasm, you'll need to add e.g. <code>-lzip</code> and possibly point the linker to where <code>libzip.so</code> is using a <code>-L</code> flag.  That will add <code>libzip.so</code> to the <code>@dylink.0</code> <code>needed</code> entry.</p>\n<p>Would you mind pushing what you have to a public repo?  I can help debug that, if you like.  Also, for reference, there are a bunch of tests which serve as small examples in <a href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wit-component/tests/components\">https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wit-component/tests/components</a> -- the ones whose names start with \"link\" are the relevant ones.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wit-component/tests/components\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/7fa34f09263f190771068a1f9e18201f11eef3db\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373366333335653438633031663263373866336635633632666137663265343830313237626463646439363936343039326665363035373861313866343962382f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wit-component/tests/components\" title=\"wasm-tools/crates/wit-component/tests/components at main · bytecodealliance/wasm-tools\">wasm-tools/crates/wit-component/tests/components at main · bytecodealliance/wasm-tools</a></div><div class=\"message_embed_description\"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div>",
        "id": 431002346,
        "sender_full_name": "Joel Dice",
        "timestamp": 1712150559
    },
    {
        "content": "<p>Thanks a lot.</p>\n<p>I have uploaded them to <a href=\"https://github.com/lum1n0us/about_shared_everything_linking\">https://github.com/lum1n0us/about_shared_everything_linking</a>. </p>\n<p>The reproduction of  the example of SharedEverythingLinking in <em>example</em> is success now. I am wondering: </p>\n<ul>\n<li>since I am looking for a smooth transition from <em>core wasm</em> to <em>cm</em>, I am hoping that wasm application developers don't have to change any of their code but compilation files. Is it possible that I can keep <code>__attribute__((import_module(\"\"), import_name(\"zip\")))</code>? </li>\n</ul>\n<p>The demo in <em>link</em> is still failed. Its error are something like:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>error:<span class=\"w\"> </span>failed<span class=\"w\"> </span>to<span class=\"w\"> </span>encode<span class=\"w\"> </span>a<span class=\"w\"> </span>component<span class=\"w\"> </span>from<span class=\"w\"> </span>modules\n\nCaused<span class=\"w\"> </span>by:\n<span class=\"w\">    </span><span class=\"m\">0</span>:<span class=\"w\"> </span>failed<span class=\"w\"> </span>to<span class=\"w\"> </span>validate<span class=\"w\"> </span>component<span class=\"w\"> </span>output\n<span class=\"w\">    </span><span class=\"m\">1</span>:<span class=\"w\"> </span>missing<span class=\"w\"> </span>module<span class=\"w\"> </span>instantiation<span class=\"w\"> </span>argument<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>test:test/test<span class=\"sb\">`</span><span class=\"w\"> </span><span class=\"o\">(</span>at<span class=\"w\"> </span>offset<span class=\"w\"> </span>0xaee<span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/lum1n0us/about_shared_everything_linking\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/89dd6744fe9ab0d7ba07939f3100afc1bba1341f\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633638353933396366316166393061663866376562623832333731313936643861383437336532393232383164613161383433303438373464346237343438622f6c756d316e3075732f61626f75745f7368617265645f65766572797468696e675f6c696e6b696e67)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/lum1n0us/about_shared_everything_linking\" title=\"GitHub - lum1n0us/about_shared_everything_linking\">GitHub - lum1n0us/about_shared_everything_linking</a></div><div class=\"message_embed_description\">Contribute to lum1n0us/about_shared_everything_linking development by creating an account on GitHub.</div></div></div>",
        "id": 431256435,
        "sender_full_name": "lum1n0us",
        "timestamp": 1712219800
    },
    {
        "content": "<p>I just opened a PR to fix the <code>link</code> demo: <a href=\"https://github.com/lum1n0us/about_shared_everything_linking/pull/1\">https://github.com/lum1n0us/about_shared_everything_linking/pull/1</a></p>\n<p>Regarding your other question: I think <code>__attribute__((import_module(\"env\"), import_name(\"zip\")))</code> should work.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/lum1n0us/about_shared_everything_linking/pull/1\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/fa765a67320ba28c25da8047c6af65880f844b82\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396337323563626530373736623363386436333335346664353461306635613838353239613935616636313031623336363931633531616532376661643636652f6c756d316e3075732f61626f75745f7368617265645f65766572797468696e675f6c696e6b696e672f70756c6c2f31)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/lum1n0us/about_shared_everything_linking/pull/1\" title=\"fix `link` example by dicej · Pull Request #1 · lum1n0us/about_shared_everything_linking\">fix `link` example by dicej · Pull Request #1 · lum1n0us/about_shared_everything_linking</a></div><div class=\"message_embed_description\">This tells wasm-tools to embed lib-bar's component type (defined in lib-bar.wit) into out/lib-bar.wasm. wasm tools component link needs that to be able to construct the component.</div></div></div>",
        "id": 431318343,
        "sender_full_name": "Joel Dice",
        "timestamp": 1712238698
    },
    {
        "content": "<p>thanks. it helps a lot.</p>",
        "id": 431653955,
        "sender_full_name": "lum1n0us",
        "timestamp": 1712392041
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"415410\">lum1n0us</span> has marked this topic as resolved.</p>",
        "id": 431653957,
        "sender_full_name": "Notification Bot",
        "timestamp": 1712392050
    }
]