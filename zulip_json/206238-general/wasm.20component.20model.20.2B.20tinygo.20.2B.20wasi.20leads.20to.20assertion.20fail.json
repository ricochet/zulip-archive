[
    {
        "content": "<p>Hi!</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>versions and etc</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>wasmtime-cli 16.0.0<br>\ntinygo version 0.30.0 darwin/arm64 (using go version go1.21.5 and LLVM version 16.0.6)<br>\nwasi_snapshot_preview1.command.wasm from wasmtime v16.0.0: Release</p>\n</div></div>\n<p>Steps to reproduce:</p>\n<p>Build wasm wasi binary with tinygo:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>tinygo</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>tinygo build -x -no-debug -target=wasi -o tinygo.wasm main.go </p>\n<p>package main</p>\n<p>import (<br>\n    \"fmt\"<br>\n    \"sync\"<br>\n)</p>\n<p>func main() {<br>\n    var wg sync.WaitGroup</p>\n<div class=\"codehilite\"><pre><span></span><code>wg.Add(10)\n\nfor i := 0; i &lt; 10; i++ {\n    go func(wg *sync.WaitGroup, id int) {\n        defer wg.Done()\n\n        fmt.Printf(&quot;[%d] hello goroutine!\\n&quot;, id)\n    }(&amp;wg, i)\n}\n\nwg.Wait()\n</code></pre></div>\n\n<p>}</p>\n</div></div>\n<p>Build component from wasm core module:</p>\n<blockquote>\n<p>wasm-tools component new tinygo.wasm  --adapt wasi_snapshot_preview1.command.wasm -o tinygo.component.wasm</p>\n</blockquote>\n<p>Run:</p>\n<blockquote>\n<p>wasmtime -D logging=y --wasm component-model tinygo.component.wasm</p>\n</blockquote>\n<p>Got error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">unreachable</span><span class=\"w\"> </span><span class=\"n\">executed</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">adapter</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"mi\">2552</span>: <span class=\"nc\">assertion</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n\n<span class=\"n\">Error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">tinygo</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">invoke</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">run</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">function</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n           <span class=\"mi\">0</span>: <span class=\"mh\">0x2a398</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span>:<span class=\"nc\">adapter</span>:<span class=\"nc\">wasi_snapshot_preview1</span><span class=\"o\">!</span><span class=\"n\">fd_write</span>\n<span class=\"w\">           </span><span class=\"mi\">1</span>: <span class=\"mh\">0x2e83f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span>:<span class=\"nc\">shim</span><span class=\"o\">!</span><span class=\"n\">adapt</span><span class=\"o\">-</span><span class=\"n\">wasi_snapshot_preview1</span><span class=\"o\">-</span><span class=\"n\">fd_write</span>\n<span class=\"w\">           </span><span class=\"mi\">2</span>: <span class=\"mh\">0x147f6</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"p\">.</span><span class=\"n\">unixFileHandle</span><span class=\"p\">).</span><span class=\"n\">Write</span>\n<span class=\"w\">           </span><span class=\"mi\">3</span>: <span class=\"mh\">0x7ee9</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">os</span><span class=\"p\">.</span><span class=\"n\">File</span><span class=\"p\">).</span><span class=\"n\">Write</span>\n<span class=\"w\">           </span><span class=\"mi\">4</span>: <span class=\"mh\">0x7cd5</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">interface</span>:<span class=\"p\">{</span><span class=\"n\">Write</span>:<span class=\"nc\">func</span>:<span class=\"p\">{</span><span class=\"n\">slice</span>:<span class=\"nc\">basic</span>:<span class=\"nc\">uint8</span><span class=\"p\">}{</span><span class=\"n\">basic</span>:<span class=\"nc\">int</span><span class=\"p\">,</span><span class=\"n\">named</span>:<span class=\"nc\">error</span><span class=\"p\">}}.</span><span class=\"n\">Write</span><span class=\"cp\">$invoke</span>\n<span class=\"w\">           </span><span class=\"mi\">5</span>: <span class=\"mh\">0xa809</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">main</span><span class=\"cp\">$</span><span class=\"mi\">2</span><span class=\"cp\">$gowrapper</span>\n<span class=\"w\">           </span><span class=\"mi\">6</span>: <span class=\"mh\">0x8e64</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">_start</span>\n<span class=\"w\">           </span><span class=\"mi\">7</span>: <span class=\"mh\">0x27598</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span>:<span class=\"nc\">adapter</span>:<span class=\"nc\">wasi_snapshot_preview1</span><span class=\"o\">!</span><span class=\"n\">wasi</span>:<span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">12</span><span class=\"o\">-</span><span class=\"mi\">05</span>#<span class=\"n\">run</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span>: <span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"n\">trap</span>: <span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">unreachable</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"w\"> </span><span class=\"n\">executed</span>\n</code></pre></div>\n<p>Running original core wasm binary works just fine:</p>\n<blockquote>\n<p>wasmtime -D logging=y build/tinygo.wasm</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">5</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n<span class=\"p\">[</span><span class=\"mi\">9</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"n\">goroutine</span><span class=\"o\">!</span>\n</code></pre></div>\n<p>I have looked at the adapter source, the assertion that failed looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">with</span><span class=\"p\">(</span><span class=\"n\">f</span>: <span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"nb\">FnOnce</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">State</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">Errno</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">Errno</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">state_ref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">State</span>::<span class=\"n\">ptr</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">state_ref</span><span class=\"p\">.</span><span class=\"n\">magic1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">MAGIC</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// HERE crates/wasi-preview1-component-adapter/src/lib.rs:2552</span>\n<span class=\"w\">        </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">state_ref</span><span class=\"p\">.</span><span class=\"n\">magic2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">MAGIC</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">(</span><span class=\"n\">state_ref</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ERRNO_SUCCESS</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Where I should start debugging?</p>",
        "id": 410853509,
        "sender_full_name": "Boris",
        "timestamp": 1704205816
    },
    {
        "content": "<p>If that assertion is tripping then that means that some memory corruption has happened in the guest somewhere. I'm not sure how best to debug that but it may mean that tinygo's allocator doesn't play well with what the adapter is doing to allocate its own state and/or its stack</p>",
        "id": 410877237,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1704215415
    },
    {
        "content": "<p>Thanks, Alex!</p>\n<blockquote>\n<p>doing to allocate its own state and/or its stack<br>\nsounds like I can try to play with the base address (or something similar) of tinygo :)</p>\n</blockquote>",
        "id": 410879028,
        "sender_full_name": "Boris",
        "timestamp": 1704216248
    },
    {
        "content": "<p>There's a few ways that the adapter tries to allocate things, I think it tries to use <code>cabi_realloc</code> by default if it's present, but it's possible to configure <code>wasm-tools component new</code> to always use <code>memory.grow</code> I believe (I also forget if that was a wish-to-be-implemented or has-been-implemented thing)</p>",
        "id": 410880523,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1704216872
    },
    {
        "content": "<p>yes, it has-been-implemented thing )<br>\nI will try --realloc-via-memory-grow, thanks!</p>",
        "id": 410881622,
        "sender_full_name": "Boris",
        "timestamp": 1704217432
    },
    {
        "content": "<p>didn't help, same behavior :(</p>",
        "id": 410881826,
        "sender_full_name": "Boris",
        "timestamp": 1704217530
    },
    {
        "content": "<p>how much mem does the adapter require?</p>",
        "id": 410881973,
        "sender_full_name": "Boris",
        "timestamp": 1704217594
    },
    {
        "content": "<p>allegedly it will only consume 1 wasm page (64k)</p>",
        "id": 410882098,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1704217668
    },
    {
        "content": "<p>Thanks, Pat! </p>\n<p>So for example, if I somehow reserve this 1 page, everything should work fine?</p>",
        "id": 410882706,
        "sender_full_name": "Boris",
        "timestamp": 1704217964
    },
    {
        "content": "<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L2591\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L2591</a></p>",
        "id": 410882778,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1704218012
    },
    {
        "content": "<p>the adapter will use a function exported as \"cabi_realloc\" from the adaptee module</p>",
        "id": 410882833,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1704218038
    },
    {
        "content": "<p>and then use that allocation for rest of the instance</p>",
        "id": 410882928,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1704218068
    }
]