[
    {
        "content": "<p>Hello, I'm trying to execute on wamr a simple multithread program on arm cortex a53 (zephyr os), compilation goes well but it shows this log</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"n\">west</span><span class=\"w\"> </span><span class=\"n\">build</span>: <span class=\"nc\">running</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">run</span>\n<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">To</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">QEMU</span><span class=\"w\"> </span><span class=\"n\">enter</span>: <span class=\"o\">'</span><span class=\"na\">CTRL</span><span class=\"o\">+</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">'</span><span class=\"p\">[</span><span class=\"n\">QEMU</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">CPU</span>: <span class=\"nc\">cortex</span><span class=\"o\">-</span><span class=\"n\">a53</span>\n<span class=\"o\">***</span><span class=\"w\"> </span><span class=\"n\">Booting</span><span class=\"w\"> </span><span class=\"n\">Zephyr</span><span class=\"w\"> </span><span class=\"n\">OS</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">zephyr</span><span class=\"o\">-</span><span class=\"n\">v3</span><span class=\"p\">.</span><span class=\"mf\">5.0</span><span class=\"o\">-</span><span class=\"mi\">4528</span><span class=\"o\">-</span><span class=\"n\">g04de43b1a119</span><span class=\"w\"> </span><span class=\"o\">***</span>\n<span class=\"p\">[</span><span class=\"mi\">00</span>:<span class=\"mi\">00</span>:<span class=\"mi\">00</span>:<span class=\"mi\">000</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">4002</span><span class=\"n\">F990</span><span class=\"p\">]</span>: <span class=\"nc\">warning</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pthread_create</span><span class=\"p\">)</span>\n<span class=\"p\">[</span><span class=\"mi\">00</span>:<span class=\"mi\">00</span>:<span class=\"mi\">00</span>:<span class=\"mi\">000</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">4002</span><span class=\"n\">F990</span><span class=\"p\">]</span>: <span class=\"nc\">warning</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pthread_join</span><span class=\"p\">)</span>\n<span class=\"n\">Exception</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">unlinked</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pthread_create</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>I’ve also enabled wasi-libc of course. My compiling command is </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"cp\">$HOME</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"w\">     </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">pthread</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">524288</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">initial</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">=</span><span class=\"mi\">1048576</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">--</span><span class=\"n\">sysroot</span><span class=\"o\">=/</span><span class=\"cp\">$HOME</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sysroot</span><span class=\"w\">  </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">allow</span><span class=\"o\">-</span><span class=\"n\">undefined</span><span class=\"o\">-</span><span class=\"n\">file</span><span class=\"o\">=/</span><span class=\"cp\">$HOME</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sysroot</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"o\">/</span><span class=\"n\">defined</span><span class=\"o\">-</span><span class=\"n\">symbols</span><span class=\"p\">.</span><span class=\"n\">txt</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">strip</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">nostdlib</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">export</span><span class=\"o\">=</span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">export</span><span class=\"o\">=</span><span class=\"n\">__data_end</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">export</span><span class=\"o\">=</span><span class=\"n\">__heap_base</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">allow</span><span class=\"o\">-</span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"cp\">$WASM_BIN</span><span class=\"w\"> </span><span class=\"cp\">$C_FILE</span>\n</code></pre></div>\n<p>I’ve also tried to not use <code>-nostdlib</code> flag but this led to blank output. Anyone can help me? Thanks in advance :)</p>",
        "id": 418606049,
        "sender_full_name": "Salvatore Bramante",
        "timestamp": 1706524084
    },
    {
        "content": "<p>use this instead</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"cp\">$HOME</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"w\">     </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">pthread</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">524288</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">initial</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">=</span><span class=\"mi\">1048576</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"cp\">$WASM_BIN</span><span class=\"w\"> </span><span class=\"cp\">$C_FILE</span>\n</code></pre></div>",
        "id": 418613838,
        "sender_full_name": "YAMAMOTO Takashi",
        "timestamp": 1706526729
    },
    {
        "content": "<p>I've just tried but it gives me blank output (I've included a print before creating a thread but is not shown)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"n\">west</span><span class=\"w\"> </span><span class=\"n\">build</span>: <span class=\"nc\">running</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">run</span>\n<span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">To</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">QEMU</span><span class=\"w\"> </span><span class=\"n\">enter</span>: <span class=\"o\">'</span><span class=\"na\">CTRL</span><span class=\"o\">+</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">'</span><span class=\"p\">[</span><span class=\"n\">QEMU</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">CPU</span>: <span class=\"nc\">cortex</span><span class=\"o\">-</span><span class=\"n\">a53</span>\n<span class=\"o\">***</span><span class=\"w\"> </span><span class=\"n\">Booting</span><span class=\"w\"> </span><span class=\"n\">Zephyr</span><span class=\"w\"> </span><span class=\"n\">OS</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">zephyr</span><span class=\"o\">-</span><span class=\"n\">v3</span><span class=\"p\">.</span><span class=\"mf\">5.0</span><span class=\"o\">-</span><span class=\"mi\">4528</span><span class=\"o\">-</span><span class=\"n\">g04de43b1a119</span><span class=\"w\"> </span><span class=\"o\">***</span>\n</code></pre></div>\n<p>I'm calling this module in a C program so, to my mind, I've to export the module main function</p>",
        "id": 418614650,
        "sender_full_name": "Salvatore Bramante",
        "timestamp": 1706527046
    },
    {
        "content": "<p>in wasi, the entry point is usually _start, which is provided by crt.</p>",
        "id": 418621467,
        "sender_full_name": "YAMAMOTO Takashi",
        "timestamp": 1706529675
    },
    {
        "content": "<p>given your stack-size and --initial-memory values, i guess it won't be able to create a thread.</p>",
        "id": 418621805,
        "sender_full_name": "YAMAMOTO Takashi",
        "timestamp": 1706529813
    },
    {
        "content": "<p>I should give bigger stack and initial memory?</p>",
        "id": 418621958,
        "sender_full_name": "Salvatore Bramante",
        "timestamp": 1706529869
    },
    {
        "content": "<p>have you flushed your printf output? depending on configurations, your stdout might not be line-buffered.</p>",
        "id": 418622010,
        "sender_full_name": "YAMAMOTO Takashi",
        "timestamp": 1706529896
    },
    {
        "content": "<p>smaller stack and larger memory</p>",
        "id": 418622078,
        "sender_full_name": "YAMAMOTO Takashi",
        "timestamp": 1706529926
    },
    {
        "content": "<p>I've tried to double the initial memory and reduce stack but nothing happened. I do not think that the missing prints are related to stdout flush because with my first command:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"cp\">$HOME</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"w\">     </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">pthread</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">524288</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">initial</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">=</span><span class=\"mi\">1048576</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">--</span><span class=\"n\">sysroot</span><span class=\"o\">=/</span><span class=\"cp\">$HOME</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sysroot</span><span class=\"w\">  </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">allow</span><span class=\"o\">-</span><span class=\"n\">undefined</span><span class=\"o\">-</span><span class=\"n\">file</span><span class=\"o\">=/</span><span class=\"cp\">$HOME</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">21.0</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sysroot</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"o\">/</span><span class=\"n\">defined</span><span class=\"o\">-</span><span class=\"n\">symbols</span><span class=\"p\">.</span><span class=\"n\">txt</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">strip</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">nostdlib</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">export</span><span class=\"o\">=</span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">export</span><span class=\"o\">=</span><span class=\"n\">__data_end</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">export</span><span class=\"o\">=</span><span class=\"n\">__heap_base</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">Wl</span><span class=\"p\">,</span><span class=\"o\">--</span><span class=\"n\">allow</span><span class=\"o\">-</span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"cp\">$WASM_BIN</span><span class=\"w\"> </span><span class=\"cp\">$C_FILE</span>\n</code></pre></div>\n<p>prinft worked but pthread did not.  The command you have suggested works only on my host machine (darwin) and not on my target (zephyr/qemu_cortex_a53).</p>",
        "id": 418799891,
        "sender_full_name": "Salvatore Bramante",
        "timestamp": 1706607934
    },
    {
        "content": "<blockquote>\n<p>I do not think that the missing prints are related to stdout flush</p>\n</blockquote>\n<p>have you tried to flush it?</p>",
        "id": 421649453,
        "sender_full_name": "YAMAMOTO Takashi",
        "timestamp": 1708002352
    }
]