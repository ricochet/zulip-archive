[
    {
        "content": "<p>Hi, we use WAMR and I call <code>wasm_runtime_set_exception</code> to stop the vm but I call it from a thread different to the vm thread. With thread sanitiser I detected bunch of data races between <code>wasm_func_call</code> and <code>wasm_runtime_set_exception</code></p>\n<p>Found this example but it seems it's also calling roughly the same non thread safe function <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/samples/terminate/src/main.c#L177\">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/samples/terminate/src/main.c#L177</a></p>\n<p>p.s. I asked the same thing in github discussions <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/discussions/3800#discussion-7202551\">https://github.com/bytecodealliance/wasm-micro-runtime/discussions/3800#discussion-7202551</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/samples/terminate/src/main.c#L177\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/3edbb45a7a22a47c29500ec2dbb0749a82978e6e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363333313765626435666537363637643437633162356539626130386537303032643762643365366639383437616331353963666337393335366266633335362f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/samples/terminate/src/main.c#L177\" title=\"wasm-micro-runtime/samples/terminate/src/main.c at main · bytecodealliance/wasm-micro-runtime\">wasm-micro-runtime/samples/terminate/src/main.c at main · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/discussions/3800#discussion-7202551\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f6a12d91b00f51755112148668b16ffbdd856feb/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616637303762623639633263343635663161363530366138373463643034393635633464383762333035376637633333623032316638663636313035366331322f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d652f64697363757373696f6e732f33383030&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/discussions/3800#discussion-7202551\" title=\"Is there a thread safe way to call wasm_runtime_set_exception? · bytecodealliance wasm-micro-runtime · Discussion #3800\">Is there a thread safe way to call wasm_runtime_set_exception? · bytecodealliance wasm-micro-runtime · Discussion #3800</a></div><div class=\"message_embed_description\">Hi, I call wasm_runtime_set_exception to stop the vm but I call it from a thread different to the vm thread. With thread sanitiser I detected bunch of data races between wasm_func_call and wasm_run...</div></div></div>",
        "id": 471273635,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1726669711
    },
    {
        "content": "<p>My current idea is:</p>\n<ol>\n<li>To add an API that can set an atomic flag</li>\n<li>Insert check for this atomic flag inside <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/iwasm/interpreter/wasm_interp_fast.c#L1419\">HANDLE_OP_END</a><br>\nand if the flag is set call <code>wasm_runtime_set_exception</code></li>\n</ol>\n<p>But maybe there's already an api that I missed or somebody dealt with the problem in another way?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/iwasm/interpreter/wasm_interp_fast.c#L1419\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/3edbb45a7a22a47c29500ec2dbb0749a82978e6e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363333313765626435666537363637643437633162356539626130386537303032643762643365366639383437616331353963666337393335366266633335362f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/iwasm/interpreter/wasm_interp_fast.c#L1419\" title=\"wasm-micro-runtime/core/iwasm/interpreter/wasm_interp_fast.c at main · bytecodealliance/wasm-micro-runtime\">wasm-micro-runtime/core/iwasm/interpreter/wasm_interp_fast.c at main · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>",
        "id": 471274822,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1726670027
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"206238\" href=\"/#narrow/stream/206238-general/topic/threadsafe.20api.20to.20terminate.20WAMR.20VM.20from.20another.20thread.3F\">#general &gt; threadsafe api to terminate WAMR VM from another thread?</a> by <span class=\"user-mention silent\" data-user-id=\"253990\">fitzgen (he/him)</span>.</p>",
        "id": 471279640,
        "sender_full_name": "Notification Bot",
        "timestamp": 1726671392
    },
    {
        "content": "<p>here's the API that works for WASM <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/main...g0djan:wasm-micro-runtime:godjan/terminate_from_another_thread?expand=1\">https://github.com/bytecodealliance/wasm-micro-runtime/compare/main...g0djan:wasm-micro-runtime:godjan/terminate_from_another_thread?expand=1</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/main...g0djan:wasm-micro-runtime:godjan/terminate_from_another_thread?expand=1\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b786db39614e6005f6d7db1cda04b4ecf514e279/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393730663064633431316331366463333639306639386639313234323464383633356136313332386361643632323735326330613264393264653937343863382f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/main...g0djan:wasm-micro-runtime:godjan/terminate_from_another_thread?expand=1\" title=\"Comparing bytecodealliance:main...g0djan:godjan/terminate_from_another_thread · bytecodealliance/wasm-micro-runtime\">Comparing bytecodealliance:main...g0djan:godjan/terminate_from_another_thread · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>",
        "id": 474246586,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1727861985
    },
    {
        "content": "<p>but when I try setting exception from a different thread to the VM running AOT it seems like AOT code continues to execute inside of <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/iwasm/aot/aot_runtime.c#L2240\">this line</a> after the exception is set. Inside it clears the stack with repetitive <code>aot_free_frame</code> calls before <code>invoke_native</code> is finished</p>\n<p>As a result <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/main...g0djan:wasm-micro-runtime:godjan/terminate_from_another_thread?expand=1#diff-1fd6c0616814f8c13b3c36913fbecc727c852643979ef9d20b2daf707fd48bd3L6191\">created call stack</a> appears to be empty </p>\n<p><span class=\"user-mention\" data-user-id=\"415404\">@Wenyong Huang</span> do you know why <code>invoke_native</code> continues to execute when set_exception is called from another thread?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/iwasm/aot/aot_runtime.c#L2240\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b786db39614e6005f6d7db1cda04b4ecf514e279/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393730663064633431316331366463333639306639386639313234323464383633356136313332386361643632323735326330613264393264653937343863382f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/iwasm/aot/aot_runtime.c#L2240\" title=\"wasm-micro-runtime/core/iwasm/aot/aot_runtime.c at main · bytecodealliance/wasm-micro-runtime\">wasm-micro-runtime/core/iwasm/aot/aot_runtime.c at main · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/main...g0djan:wasm-micro-runtime:godjan/terminate_from_another_thread?expand=1#diff-1fd6c0616814f8c13b3c36913fbecc727c852643979ef9d20b2daf707fd48bd3L6191\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b786db39614e6005f6d7db1cda04b4ecf514e279/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393730663064633431316331366463333639306639386639313234323464383633356136313332386361643632323735326330613264393264653937343863382f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/main...g0djan:wasm-micro-runtime:godjan/terminate_from_another_thread?expand=1#diff-1fd6c0616814f8c13b3c36913fbecc727c852643979ef9d20b2daf707fd48bd3L6191\" title=\"Comparing bytecodealliance:main...g0djan:godjan/terminate_from_another_thread · bytecodealliance/wasm-micro-runtime\">Comparing bytecodealliance:main...g0djan:godjan/terminate_from_another_thread · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>",
        "id": 474248136,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1727862464
    },
    {
        "content": "<p>I made a workaround by inserting these lines inside of  <code>aot_free_frame</code></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">aot_copy_exception</span><span class=\"p\">(</span><span class=\"n\">module_inst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">aot_create_call_stack</span><span class=\"p\">(</span><span class=\"n\">exec_env</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">aot_dump_call_stack</span><span class=\"p\">(</span><span class=\"n\">exec_env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>but I believe the root problem is that there's an attempt to clear stack after exception is set and I don't get why it is like that</p>",
        "id": 474248665,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1727862625
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"614761\">@Georgii Rylov</span> thanks for the testing, I think the <code>invoke_native</code> you mentioned is to execute the AOT function, and since the AOT code only checks whether the exception was thrown and whether current thread's terminated flag is set in several places (see the callings to check_exception_thrown in aot_emit_function.c and the callings to check_suspend_flags in core/iwasm/compilation), normally it will continue to execute until these places are met (for check_suspend_flags, we should also set the terminate flag in other thread).</p>\n<p>How to safely terminate, suspend and resume wasm threads is really difficult to implement, normally the idea is to stop the world first - let all the threads (except the thread asking to stop) suspend and wait until other thread notify it to run. I ever opened an issue for the feature:<br>\n<a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/issues/2319\">https://github.com/bytecodealliance/wasm-micro-runtime/issues/2319</a>,<br>\nand had done some work in branch dev/thread_suspension:<br>\n<a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/tree/dev/thread_suspension\">https://github.com/bytecodealliance/wasm-micro-runtime/tree/dev/thread_suspension</a></p>\n<p>But due to time bandwidth, I didn't test a lot, there may be some issues. If you are interested, maybe you can have a try, e.g. by calling the API wasm_runtime_terminate_all in thread_manager.h, and adding <code>--enable-multi-thread</code> flag for wamrc when generating AOT file.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/issues/2319\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/952d6338e3b5dfec57e5a4a64cfcf86e76b6f05c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633764323232353262326638613039373030643961383932383262393634353231323463386236653430323636376631633963386463636334373334653664362f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d652f6973737565732f32333139&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/issues/2319\" title=\"Support threads(cluster) suspension/resume · Issue #2319 · bytecodealliance/wasm-micro-runtime\">Support threads(cluster) suspension/resume · Issue #2319 · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">Motivation Some applications/scenarios require that the threads in a cluster run into the suspension state, or is to suspend all threads except the thread which is requesting the suspension. Normal...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/tree/dev/thread_suspension\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/fbc1714b5f2d2f7ef3e2d9712be211e66eb1a189/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376337626262333364616261636633643766643732623163366137393337636235303030636631613764623439656539386134643933613839393532363665642f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/tree/dev/thread_suspension\" title=\"GitHub - bytecodealliance/wasm-micro-runtime at dev/thread_suspension\">GitHub - bytecodealliance/wasm-micro-runtime at dev/thread_suspension</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>",
        "id": 475467555,
        "sender_full_name": "Wenyong Huang",
        "timestamp": 1728362351
    },
    {
        "content": "<p>Please refer to <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/dev/thread_suspension\">https://github.com/bytecodealliance/wasm-micro-runtime/compare/dev/thread_suspension</a> for the code changes.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/dev/thread_suspension\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/fbc1714b5f2d2f7ef3e2d9712be211e66eb1a189/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376337626262333364616261636633643766643732623163366137393337636235303030636631613764623439656539386134643933613839393532363665642f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/compare/dev/thread_suspension\" title=\"Comparing main...dev/thread_suspension · bytecodealliance/wasm-micro-runtime\">Comparing main...dev/thread_suspension · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>",
        "id": 475467960,
        "sender_full_name": "Wenyong Huang",
        "timestamp": 1728362647
    },
    {
        "content": "<p>Hey thank you for sharing , we got back to that but with a different approach that better suits our needs</p>\n<p>Our problem: we want to report stacktraces when WASM app has stuck for some reason to be able to debug it</p>\n<p>Our new proposal(I have a POC): send SIGUSR2 to the WASM VM thread and record \"simplified\" stacktraces in signal handler</p>\n<p>The main complication there is achieving \"async signal safety\". <br>\nFor that I figured:</p>\n<ol>\n<li>once frame created and placed on stack it's function index is never changed</li>\n<li>And frame positions also never change</li>\n<li>The stack is allocated once and only freed on termintation</li>\n<li>Head of the stack changes on add/remove operations</li>\n</ol>\n<p>So in my POC I keep atomic pointer to the stack memory and atomic pointer to the head frame. That helps me to ensure that the interruption doesn't leave the stack in an invalid state as nothing besides change of this 2 pointers could be interrupted.</p>\n<p>In signal handler I just check that the memory is still allocated and iterate over frames starting from the atomic pointer to the head frame and recording function indexes. Then I write it to the file as its async signal safe operation.</p>\n<p>So regarding that I have few questions:</p>\n<ol>\n<li>Does this logic make sense to you?</li>\n<li>I don't see how to test or validate async signal safety, especially how to ensure  future changes won't make it unsafe. Any ideas on that?</li>\n</ol>",
        "id": 486281751,
        "sender_full_name": "Georgii Rylov",
        "timestamp": 1733397808
    }
]