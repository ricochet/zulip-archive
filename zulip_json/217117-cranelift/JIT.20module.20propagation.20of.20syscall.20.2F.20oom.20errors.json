[
    {
        "content": "<p>Hey folks, when starting to use the JIT module, I noticed there are a number of places where it <code>expects</code> or <code>panics</code> on syscall errors, for example <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L193\">this panic</a> on <code>mprotect</code> or <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L691\">this one</a> during function allocation.</p>\n<p>I’d like to update these to propagate the errors onward instead, as just crashing can be a nasty source of correlated failure in distributed systems, eg in Linux if the <code>vm.max_map_count</code> for the process is mistakenly configured too low, you would see correlated panics when each node tries to <code>mmap</code> or <code>mprotect</code> one too many times</p>\n<p>Doing so would involve updating some apis like <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L171\">set_readable_and_executable</a> and <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L430\">finalize_definitions</a> to return Result types and let the caller handle the error (probably initially by just unwrapping, punting the issue upward a few layers)</p>\n<p>How stable are the JIT module apis, is it generally OK to update them in this manner?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L193\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/3dd878c9fd09caaa36ab6a25e8ba54e23dde4b2b\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132333362336138653864336134343564386138303533343136376233366230396638343831393162353537346665363537633633366238666131373338632f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L193\" title=\"wasmtime/memory.rs at main · bytecodealliance/wasmtime\">wasmtime/memory.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L691\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/3dd878c9fd09caaa36ab6a25e8ba54e23dde4b2b\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132333362336138653864336134343564386138303533343136376233366230396638343831393162353537346665363537633633366238666131373338632f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L691\" title=\"wasmtime/backend.rs at main · bytecodealliance/wasmtime\">wasmtime/backend.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L171\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/3dd878c9fd09caaa36ab6a25e8ba54e23dde4b2b\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132333362336138653864336134343564386138303533343136376233366230396638343831393162353537346665363537633633366238666131373338632f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/memory.rs#L171\" title=\"wasmtime/memory.rs at main · bytecodealliance/wasmtime\">wasmtime/memory.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L430\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/3dd878c9fd09caaa36ab6a25e8ba54e23dde4b2b\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132333362336138653864336134343564386138303533343136376233366230396638343831393162353537346665363537633633366238666131373338632f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/jit/src/backend.rs#L430\" title=\"wasmtime/backend.rs at main · bytecodealliance/wasmtime\">wasmtime/backend.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>",
        "id": 307353304,
        "sender_full_name": "Evan Thompson",
        "timestamp": 1667320605
    },
    {
        "content": "<p>I would expect this to be an OK refactoring; <span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> might have more opinions.</p>",
        "id": 307375667,
        "sender_full_name": "Andrew Brown",
        "timestamp": 1667326780
    },
    {
        "content": "<p>Returning errors would be fine, however be sure to ensure that all invariants are upheld even if an error is returned. For example if you want to remove the expects in <code>finalize_definitions</code> (which I don't think you should as they are programmer errors, not environment errors) you have to put back all not yet processed functions or data objects to finalize.</p>",
        "id": 307376410,
        "sender_full_name": "bjorn3",
        "timestamp": 1667326981
    },
    {
        "content": "<p>Thanks! I wasn't planning to remove the existing <code>expects</code> (for function and data object compilation) from <code>finalize_definitions</code>, but I was planning to add some new error handling. For example, <code>finalize_definitions</code> calls <code>self.memory.code.set_readable_and_executable</code> which is really a wrapper around syscalls like <code>mprotect</code>, which can fail for a variety of reasons not programmer-error-related</p>",
        "id": 307379953,
        "sender_full_name": "Evan Thompson",
        "timestamp": 1667328097
    },
    {
        "content": "<p>Yeah, those are totally reasonable to turn into Result returning functions.</p>",
        "id": 307404133,
        "sender_full_name": "bjorn3",
        "timestamp": 1667337057
    },
    {
        "content": "<p>You should however probably ensure that if mprotect fails that the respective memory region is not marked as having been made read+execute in the state of <code>self.memory.code</code>.</p>",
        "id": 307404309,
        "sender_full_name": "bjorn3",
        "timestamp": 1667337140
    }
]