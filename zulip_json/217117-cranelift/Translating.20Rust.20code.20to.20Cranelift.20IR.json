[
    {
        "content": "<p>I'm attempting to translate a <code>no_std</code> Rust program into Cranelift IR using the <code>rustc_codegen_cranelift</code> backend but am encountering linker issues (undefined symbols on a m-series mac). Not sure why?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">ir</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">nihal</span><span class=\"p\">.</span><span class=\"n\">pasham</span><span class=\"o\">/</span><span class=\"n\">devspace</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">ir</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"p\">)</span>\n<span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linking</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">cc</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">env</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">IPHONEOS_DEPLOYMENT_TARGET</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">TVOS_DEPLOYMENT_TARGET</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">XROS_DEPLOYMENT_TARGET</span><span class=\"w\"> </span><span class=\"n\">LC_ALL</span><span class=\"o\">=</span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">PATH</span><span class=\"o\">=</span><span class=\"s\">\"/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/bin:/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/bin:/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/bin:/Users/nihal.pasham/.modular/pkg/packages.modular.com_mojo/bin:/Users/nihal.pasham/.wasmtime/bin:/opt/homebrew/opt/llvm/bin:/Users/nihal.pasham/.cargo/bin:/opt/homebrew/opt/openssl@3/bin:/opt/homebrew/opt/make/libexec/gnubin:/Users/nihal.pasham/.local/bin:/opt/homebrew/opt/openjdk/bin:/Users/nihal.pasham/Library/xPacks/@xpack-dev-tools/arm-none-eabi-gcc/10.3.1-2.3.1/.content/bin:/opt/local/bin:/opt/local/sbin:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin:/Library/Apple/usr/bin:/Users/nihal.pasham/.cargo/binexport\"</span><span class=\"w\"> </span><span class=\"n\">VSLANG</span><span class=\"o\">=</span><span class=\"s\">\"1033\"</span><span class=\"w\"> </span><span class=\"n\">ZERO_AR_DATE</span><span class=\"o\">=</span><span class=\"s\">\"1\"</span><span class=\"w\"> </span><span class=\"s\">\"cc\"</span><span class=\"w\"> </span><span class=\"s\">\"-arch\"</span><span class=\"w\"> </span><span class=\"s\">\"arm64\"</span><span class=\"w\"> </span><span class=\"s\">\"-mmacosx-version-min=11.0.0\"</span><span class=\"w\"> </span><span class=\"s\">\"/var/folders/rj/5hqdh1tn6v314krprh453jd40000gn/T/rustcecz3Du/symbols.o\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/devspace/compiler/cranelift-ir-test/target/debug/deps/cranelift_ir_test-06cd2efd590c2c55.9zu9dm6yolguzepxzrn2yw7xs.rcgu.o\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/lib/librustc_std_workspace_core-86a91ad72b99b853.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/lib/libcore-0d6279724923194b.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/lib/libcompiler_builtins-108b1d39fdc49a06.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"-o\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/devspace/compiler/cranelift-ir-test/target/debug/deps/cranelift_ir_test-06cd2efd590c2c55\"</span><span class=\"w\"> </span><span class=\"s\">\"-Wl,-dead_strip\"</span><span class=\"w\"> </span><span class=\"s\">\"-nodefaultlibs\"</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">no</span><span class=\"w\"> </span><span class=\"n\">platform</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">'/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">nihal</span><span class=\"p\">.</span><span class=\"n\">pasham</span><span class=\"o\">/</span><span class=\"n\">devspace</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">ir</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">cranelift_ir_test</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"n\">cd2efd590c2c55</span><span class=\"p\">.</span><span class=\"mi\">9</span><span class=\"n\">zu9dm6yolguzepxzrn2yw7xs</span><span class=\"p\">.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">assuming</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">macOS</span>\n<span class=\"w\">          </span><span class=\"n\">Undefined</span><span class=\"w\"> </span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"s\">\"_main\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"n\">initial</span><span class=\"o\">-</span><span class=\"n\">undefines</span><span class=\"o\">&gt;</span>\n<span class=\"w\">            </span><span class=\"s\">\"dyld_stub_binder\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"n\">initial</span><span class=\"o\">-</span><span class=\"n\">undefines</span><span class=\"o\">&gt;</span>\n<span class=\"w\">          </span><span class=\"n\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">symbol</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span>\n<span class=\"w\">          </span><span class=\"n\">clang</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"p\">)</span>\n\n\n<span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">ir</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"s\">\"cranelift-ir-test\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">error</span>\n</code></pre></div>",
        "id": 473424037,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727596268
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"726787\">Nihal Pasham</span> <a href=\"#narrow/stream/217117-cranelift/topic/Translating.20Rust.20code.20to.20Cranelift.20IR/near/473424037\">said</a>:</p>\n<blockquote>\n<p>I'm attempting to translate a <code>no_std</code> Rust program into Cranelift IR using the <code>rustc_codegen_cranelift</code> backend but am encountering linker issues (undefined symbols on a m-series mac). Not sure why?</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">ir</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">nihal</span><span class=\"p\">.</span><span class=\"n\">pasham</span><span class=\"o\">/</span><span class=\"n\">devspace</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">ir</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"p\">)</span>\n<span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linking</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">cc</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">env</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">IPHONEOS_DEPLOYMENT_TARGET</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">TVOS_DEPLOYMENT_TARGET</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">XROS_DEPLOYMENT_TARGET</span><span class=\"w\"> </span><span class=\"n\">LC_ALL</span><span class=\"o\">=</span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">PATH</span><span class=\"o\">=</span><span class=\"s\">\"/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/bin:/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/bin:/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/bin:/Users/nihal.pasham/.modular/pkg/packages.modular.com_mojo/bin:/Users/nihal.pasham/.wasmtime/bin:/opt/homebrew/opt/llvm/bin:/Users/nihal.pasham/.cargo/bin:/opt/homebrew/opt/openssl@3/bin:/opt/homebrew/opt/make/libexec/gnubin:/Users/nihal.pasham/.local/bin:/opt/homebrew/opt/openjdk/bin:/Users/nihal.pasham/Library/xPacks/@xpack-dev-tools/arm-none-eabi-gcc/10.3.1-2.3.1/.content/bin:/opt/local/bin:/opt/local/sbin:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin:/Library/Apple/usr/bin:/Users/nihal.pasham/.cargo/binexport\"</span><span class=\"w\"> </span><span class=\"n\">VSLANG</span><span class=\"o\">=</span><span class=\"s\">\"1033\"</span><span class=\"w\"> </span><span class=\"n\">ZERO_AR_DATE</span><span class=\"o\">=</span><span class=\"s\">\"1\"</span><span class=\"w\"> </span><span class=\"s\">\"cc\"</span><span class=\"w\"> </span><span class=\"s\">\"-arch\"</span><span class=\"w\"> </span><span class=\"s\">\"arm64\"</span><span class=\"w\"> </span><span class=\"s\">\"-mmacosx-version-min=11.0.0\"</span><span class=\"w\"> </span><span class=\"s\">\"/var/folders/rj/5hqdh1tn6v314krprh453jd40000gn/T/rustcecz3Du/symbols.o\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/devspace/compiler/cranelift-ir-test/target/debug/deps/cranelift_ir_test-06cd2efd590c2c55.9zu9dm6yolguzepxzrn2yw7xs.rcgu.o\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/lib/librustc_std_workspace_core-86a91ad72b99b853.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/lib/libcore-0d6279724923194b.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/.rustup/toolchains/nightly-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/lib/libcompiler_builtins-108b1d39fdc49a06.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"-o\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/nihal.pasham/devspace/compiler/cranelift-ir-test/target/debug/deps/cranelift_ir_test-06cd2efd590c2c55\"</span><span class=\"w\"> </span><span class=\"s\">\"-Wl,-dead_strip\"</span><span class=\"w\"> </span><span class=\"s\">\"-nodefaultlibs\"</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">no</span><span class=\"w\"> </span><span class=\"n\">platform</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">'/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">nihal</span><span class=\"p\">.</span><span class=\"n\">pasham</span><span class=\"o\">/</span><span class=\"n\">devspace</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">ir</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">cranelift_ir_test</span><span class=\"o\">-</span><span class=\"mi\">06</span><span class=\"n\">cd2efd590c2c55</span><span class=\"p\">.</span><span class=\"mi\">9</span><span class=\"n\">zu9dm6yolguzepxzrn2yw7xs</span><span class=\"p\">.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">assuming</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">macOS</span>\n<span class=\"w\">          </span><span class=\"n\">Undefined</span><span class=\"w\"> </span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"s\">\"_main\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"n\">initial</span><span class=\"o\">-</span><span class=\"n\">undefines</span><span class=\"o\">&gt;</span>\n<span class=\"w\">            </span><span class=\"s\">\"dyld_stub_binder\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"n\">initial</span><span class=\"o\">-</span><span class=\"n\">undefines</span><span class=\"o\">&gt;</span>\n<span class=\"w\">          </span><span class=\"n\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">symbol</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span>\n<span class=\"w\">          </span><span class=\"n\">clang</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"p\">)</span>\n\n\n<span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">ir</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"s\">\"cranelift-ir-test\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">error</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Also, is there a simpler standalone utility for translating Rust to Cranelift IR, ideally something that doesn't require writing a complete frontend parser?</p>",
        "id": 473424460,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727596466
    },
    {
        "content": "<p>For additional context: I'm simply trying to generate Cranelift IR for a pure function (i.e., very basic, without any dependencies) while avoiding the standard library or runtime.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#![no_std]</span>\n<span class=\"cp\">#![no_main]</span>\n\n<span class=\"cp\">#[allow(dead_code)]</span>\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">test</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_c</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"cp\">#[panic_handler]</span>\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">panic</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">core</span><span class=\"p\">::</span><span class=\"n\">panic</span><span class=\"p\">::</span><span class=\"n\">PanicInfo</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">loop</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 473445435,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727613545
    },
    {
        "content": "<p>I'm personally not familiar with the details of cg-clif, and I don't think too many people that hang out here are, other than <span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span>; I suspect you might get better support in the rust zulip, if they aren't around right now</p>",
        "id": 473470380,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1727630324
    },
    {
        "content": "<p>The problem here is that you are trying to build an executable without linking libc. On macOS linking libc is mandatory for executables. You also haven't defined a main function for your executable.</p>",
        "id": 473484219,
        "sender_full_name": "bjorn3",
        "timestamp": 1727638056
    },
    {
        "content": "<p>If you want to get clif ir, you should pass <code>--emit llvm-ir</code> to get clif ir text files instead of compiling down to object files and linking.</p>",
        "id": 473484284,
        "sender_full_name": "bjorn3",
        "timestamp": 1727638103
    },
    {
        "content": "<p>Also what do you want to use the clif ir files for?</p>",
        "id": 473484305,
        "sender_full_name": "bjorn3",
        "timestamp": 1727638136
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/217117-cranelift/topic/Translating.20Rust.20code.20to.20Cranelift.20IR/near/473484305\">said</a>:</p>\n<blockquote>\n<p>Also what do you want to use the clif ir files for?</p>\n</blockquote>\n<p>I'm trying to understand how Cranelift works under the hood, starting with its IR. I used the <code>--emit=llvm-ir</code> option along with the <code>std-lib</code>, which I believe produces a folder in the target directory that contains <code>.clif</code> IR files for the entire executable. That's a lot of output. Is there a way to generate the IR for just a single file?</p>\n<p>I tried the following:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>rustc<span class=\"w\"> </span>--emit<span class=\"o\">=</span>llvm-ir<span class=\"w\"> </span>src/main.rs\n</code></pre></div>\n<p>However, this only produces LLVM IR, not Cranelift IR.</p>",
        "id": 473540196,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727664438
    },
    {
        "content": "<p>I presume we need to force <code>rustc</code> to use the Cranelift backend while emitting, correct?</p>",
        "id": 473542893,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727665013
    },
    {
        "content": "<p>For each codegend function three files are emitted. The .unopt.clif file contains what cg_clif emits. The .opt.clif file contains the result of optimizing by Cranelift and the .vcode file contains the ir right before cranelift emits machine code bytes.</p>",
        "id": 473810136,
        "sender_full_name": "bjorn3",
        "timestamp": 1727718700
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"726787\">Nihal Pasham</span> <a href=\"#narrow/stream/217117-cranelift/topic/Translating.20Rust.20code.20to.20Cranelift.20IR/near/473542893\">said</a>:</p>\n<blockquote>\n<p>I presume we need to force <code>rustc</code> to use the Cranelift backend while emitting, correct?</p>\n</blockquote>\n<p>If you want to avoid cargo, you can use rustc-clif instead of cargo-clif.</p>",
        "id": 473810337,
        "sender_full_name": "bjorn3",
        "timestamp": 1727718761
    },
    {
        "content": "<p>This will still emit clif ir for standard library functions if rustc decides to codegen them as part of the local crate however. There is no way to filter for just local functions.</p>",
        "id": 473810470,
        "sender_full_name": "bjorn3",
        "timestamp": 1727718817
    },
    {
        "content": "<p>speaking of, is there a way to dump that clif to a text format?</p>",
        "id": 473992192,
        "sender_full_name": "Jubilee",
        "timestamp": 1727774694
    },
    {
        "content": "<p>surely <code>--emit=clif-ir</code> will not Simply Work</p>",
        "id": 473992472,
        "sender_full_name": "Jubilee",
        "timestamp": 1727774772
    },
    {
        "content": "<p>I believe </p>\n<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/217117-cranelift/topic/Translating.20Rust.20code.20to.20Cranelift.20IR/near/473810470\">said</a>:</p>\n<blockquote>\n<p>This will still emit clif ir for standard library functions if rustc decides to codegen them as part of the local crate however. There is no way to filter for just local functions.</p>\n</blockquote>\n<p>Got it .</p>\n<p>My goal is to document my learning journey with Cranelift, potentially through a series of videos for future reference. I'm focusing on understanding the process from IR generation for a simple program to how Cranelift ultimately produces machine code. The steps I’m aiming to cover are:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">CLIF</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">legalization</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">mid</span><span class=\"o\">-</span><span class=\"n\">end</span><span class=\"w\"> </span><span class=\"n\">egraph</span><span class=\"w\"> </span><span class=\"n\">rewrites</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">enabled</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">using</span><span class=\"w\"> </span><span class=\"n\">ISLE</span><span class=\"w\"> </span><span class=\"n\">rules</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">lowering</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">backend</span><span class=\"o\">-</span><span class=\"n\">specific</span><span class=\"w\"> </span><span class=\"n\">VCode</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"w\"> </span><span class=\"n\">ISLE</span><span class=\"w\"> </span><span class=\"n\">rules</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">regalloc</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">binary</span><span class=\"w\"> </span><span class=\"n\">emission</span>\n</code></pre></div>\n<p>I believe I've gained a basic understanding of egraphs and ISLE, but I still don’t feel confident enough to walk through an entire example covering all the stages. Is there a way to dynamically step through each of these phases at runtime to observe how they work? Any suggestions or guidance would be greatly appreciated.</p>",
        "id": 474015575,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727782865
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"356464\">Jubilee</span> <a href=\"#narrow/stream/217117-cranelift/topic/Translating.20Rust.20code.20to.20Cranelift.20IR/near/473992192\">said</a>:</p>\n<blockquote>\n<p>speaking of, is there a way to dump that clif to a text format?</p>\n</blockquote>\n<p>To dump the IR for the entire program, I used the following command:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>../rustc_codegen_cranelift/dist/rustc-clif<span class=\"w\"> </span>--emit<span class=\"o\">=</span>llvm-ir<span class=\"w\"> </span>src/main.rs\n</code></pre></div>\n<p>This creates a directory named <code>main.clif</code> that contains all the artifacts.</p>",
        "id": 474020885,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727784571
    },
    {
        "content": "<blockquote>\n<p>Is there a way to dynamically step through each of these phases at runtime to observe how they work?</p>\n</blockquote>\n<p>Cranelift emits logs which contain the clif ir at each step, but cg_clif doesn't currently expose a way to enable logs.</p>",
        "id": 474044296,
        "sender_full_name": "bjorn3",
        "timestamp": 1727790895
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"726787\">@Nihal Pasham</span> I must warn you that if you try to inspect the details of how the compiler works at runtime and document based on that, instead of from the external boundaries of the program, your documentation will age <em>much</em> more rapidly.</p>",
        "id": 474089448,
        "sender_full_name": "Jubilee",
        "timestamp": 1727803600
    },
    {
        "content": "<p>I believe I've found what I was looking for. Since functions in Cranelift are compiled individually, I can simply add the <code>#[no_mangle]</code> attribute to the function I'm interested in (i.e., the one for which we want to see the generated IR). This approach produces the three different versions (<code>.opt</code>, <code>.unopt</code>, <code>.vcode</code>). While this isn’t exactly a straightforward \"Rust function in, IR out,\" it does make it easier to locate the IR for a specific function.</p>\n<p>Another observation: I noticed that the IR generated by <code>cg_clif</code> differs slightly from what's in Cranelift's IR reference documentation.</p>\n<p>For example, the function signature syntax produced by <code>cg_clif</code> looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">9</span><span class=\"p\">(</span><span class=\"kt\">i8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"nc\">apple_aarch64</span>\n</code></pre></div>\n<p>whereas Cranelift IR uses a <code>%</code> like so:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">average</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">f32</span><span class=\"w\"> </span><span class=\"nc\">system_v</span>\n</code></pre></div>\n<p>Just to confirm—does <code>cg_clif</code> produce a more specialized IR tailored for the Rust compiler's use?</p>",
        "id": 474451709,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727924223
    },
    {
        "content": "<p>those are just two different ways to name functions, either the <code>i</code>th namespace and <code>j</code>th function within it, or some user-provided string</p>",
        "id": 474454523,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1727925153
    },
    {
        "content": "<p>So, it seems like <code>u0</code> is the identifier for the \"compilation unit,\" and <code>9</code> represents the function's unique identifier within that unit—correct?</p>\n<p>Also, I noticed this in one of the blocks:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">v0</span>\n<span class=\"w\">    </span><span class=\"n\">v5</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">v0</span>\n<span class=\"w\">    </span><span class=\"n\">v11</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">v0</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">v1</span>\n<span class=\"w\">    </span><span class=\"n\">v6</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">v1</span>\n<span class=\"w\">    </span><span class=\"n\">v12</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">v1</span>\n<span class=\"w\">    </span><span class=\"n\">nop</span>\n<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">write_cvalue</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Var</span><span class=\"p\">(</span><span class=\"n\">_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">var1</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"kt\">u8</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ByVal</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"kt\">u8</span>\n<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">write_cvalue</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Var</span><span class=\"p\">(</span><span class=\"n\">_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">var2</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"kt\">u8</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ByVal</span><span class=\"p\">(</span><span class=\"n\">v1</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"kt\">u8</span>\n<span class=\"w\">    </span><span class=\"nc\">jump</span><span class=\"w\"> </span><span class=\"n\">block1</span>\n</code></pre></div>\n<p>Are these simply assignments, or should I interpret them differently?</p>",
        "id": 474460628,
        "sender_full_name": "Nihal Pasham",
        "timestamp": 1727926343
    },
    {
        "content": "<p>cranelift-module uses <code>u0:X</code> to refer to function X within the current module (can be an import) and <code>u1:Y</code> to refer to data object Y.</p>",
        "id": 474495001,
        "sender_full_name": "bjorn3",
        "timestamp": 1727938066
    },
    {
        "content": "<p>The <code>v2 -&gt; v0</code> are aliases. So in this case all references to <code>v2</code> are implicitly replaced with <code>v0</code> during compilation. They mostly exist to make the SSA lowering in cranelift-frontend easier.</p>",
        "id": 474495533,
        "sender_full_name": "bjorn3",
        "timestamp": 1727938149
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"264278\">@bjorn3</span> <code>--emit llvm-ir</code> doesn't seem to work with <code>-O</code> to get clif IR with optimzations enabled. It just doesn't create the directory.</p>",
        "id": 474575488,
        "sender_full_name": "Amanieu",
        "timestamp": 1727957918
    },
    {
        "content": "<p>It works fine for me.</p>",
        "id": 474575819,
        "sender_full_name": "bjorn3",
        "timestamp": 1727957978
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">dist</span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">-</span><span class=\"n\">clif</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">emit</span><span class=\"w\"> </span><span class=\"n\">llvm</span><span class=\"o\">-</span><span class=\"n\">ir</span>\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"o\">^</span><span class=\"n\">D</span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">grep</span><span class=\"w\"> </span><span class=\"n\">rust_out</span>\n<span class=\"o\">-</span><span class=\"n\">rw</span><span class=\"o\">-</span><span class=\"n\">rw</span><span class=\"o\">-</span><span class=\"n\">r</span><span class=\"o\">--</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">gh</span><span class=\"o\">-</span><span class=\"n\">bjorn3</span><span class=\"w\"> </span><span class=\"n\">gh</span><span class=\"o\">-</span><span class=\"n\">bjorn3</span><span class=\"w\">  </span><span class=\"mi\">2264</span><span class=\"w\"> </span><span class=\"n\">Oct</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">rust_out</span><span class=\"p\">.</span><span class=\"n\">allocator_shim</span><span class=\"p\">.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>\n<span class=\"n\">drwxrwxr</span><span class=\"o\">-</span><span class=\"n\">x</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">gh</span><span class=\"o\">-</span><span class=\"n\">bjorn3</span><span class=\"w\"> </span><span class=\"n\">gh</span><span class=\"o\">-</span><span class=\"n\">bjorn3</span><span class=\"w\">  </span><span class=\"mi\">4096</span><span class=\"w\"> </span><span class=\"n\">Oct</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"mi\">19</span><span class=\"w\"> </span><span class=\"n\">rust_out</span><span class=\"p\">.</span><span class=\"n\">clif</span>\n</code></pre></div>",
        "id": 474576208,
        "sender_full_name": "bjorn3",
        "timestamp": 1727958033
    },
    {
        "content": "<p>Hmm maybe it's because my nightly is a month old</p>",
        "id": 474577726,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958282
    },
    {
        "content": "<p>I'm using rustc-codegen-cranelift-preview</p>",
        "id": 474577781,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958294
    },
    {
        "content": "<p>from rustup</p>",
        "id": 474577802,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958297
    },
    {
        "content": "<p>Should have worked fine back for the last couple of years.</p>",
        "id": 474577932,
        "sender_full_name": "bjorn3",
        "timestamp": 1727958317
    },
    {
        "content": "<p>Are you passing any <code>-o</code> or <code>--out-dir</code>?</p>",
        "id": 474578006,
        "sender_full_name": "bjorn3",
        "timestamp": 1727958331
    },
    {
        "content": "<p>Here's the command I'm using:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"k\">crate</span><span class=\"o\">-</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">rlib</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Zcodegen</span><span class=\"o\">-</span><span class=\"n\">backend</span><span class=\"o\">=</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">emit</span><span class=\"w\"> </span><span class=\"n\">llvm</span><span class=\"o\">-</span><span class=\"n\">ir</span>\n</code></pre></div>",
        "id": 474578121,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958351
    },
    {
        "content": "<p>If I add <code>-O</code> then no test.clif directory is created.</p>",
        "id": 474578185,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958362
    },
    {
        "content": "<p>Same with <code>-Copt-level</code> with any value except 0.</p>",
        "id": 474578293,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958375
    },
    {
        "content": "<p>That is weird...</p>",
        "id": 474578478,
        "sender_full_name": "bjorn3",
        "timestamp": 1727958406
    },
    {
        "content": "<p>Hmm maybe the whole function is optimized away?</p>",
        "id": 474578578,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958423
    },
    {
        "content": "<p>Oh yea that was it.</p>",
        "id": 474578731,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958447
    },
    {
        "content": "<p><code>#[no_mangle]</code> fixed it</p>",
        "id": 474578843,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958467
    },
    {
        "content": "<p>That explains it.</p>",
        "id": 474578912,
        "sender_full_name": "bjorn3",
        "timestamp": 1727958478
    },
    {
        "content": "<p>It still has <code>set opt_level=none</code> even with <code>-O</code>, is that intended?</p>",
        "id": 474579255,
        "sender_full_name": "Amanieu",
        "timestamp": 1727958528
    },
    {
        "content": "<p><code>-O</code> is equivalent to <code>-Copt-level=2</code>, which is internally called <code>OptLevel::Default</code> for whatever reason. For this and <code>-Copt-level=1</code> I don't set the <code>opt_level</code> flag at all, so Cranelift defaults to <code>opt_level=none</code>. Will fix in a bit. In any case <code>-Copt-level=3</code> should work for now.</p>",
        "id": 474579683,
        "sender_full_name": "bjorn3",
        "timestamp": 1727958649
    },
    {
        "content": "<p>Pushed a fix</p>",
        "id": 474580732,
        "sender_full_name": "bjorn3",
        "timestamp": 1727958997
    }
]