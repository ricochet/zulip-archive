[
    {
        "content": "<p>I got a few verifier errors with cg_clif saying that the domtree is not valid. I can't reproduce it with clif-util even when enabling the exact same flags.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">rustc</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">called</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Result</span>::<span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Err</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"nc\">Compilation</span><span class=\"p\">(</span><span class=\"n\">Verifier</span><span class=\"p\">(</span><span class=\"n\">VerifierErrors</span><span class=\"p\">([</span><span class=\"n\">VerifierError</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">location</span>: <span class=\"nc\">block3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">context</span>: <span class=\"nb\">None</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">message</span>: <span class=\"s\">\"invalid domtree, expected idom(block3) = Some(inst11), got Some(inst10)\"</span><span class=\"w\"> </span><span class=\"p\">}])))</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">base</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">133</span>:<span class=\"mi\">14</span><span class=\"w\"></span>\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">rustc</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">called</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Result</span>::<span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Err</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"nc\">Compilation</span><span class=\"p\">(</span><span class=\"n\">Verifier</span><span class=\"p\">(</span><span class=\"n\">VerifierErrors</span><span class=\"p\">([</span><span class=\"n\">VerifierError</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">location</span>: <span class=\"nc\">block4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">context</span>: <span class=\"nb\">None</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">message</span>: <span class=\"s\">\"invalid domtree, expected idom(block4) = Some(inst4), got Some(inst5)\"</span><span class=\"w\"> </span><span class=\"p\">}])))</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">base</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">133</span>:<span class=\"mi\">14</span><span class=\"w\"></span>\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">rustc</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">called</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Result</span>::<span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Err</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"nc\">Compilation</span><span class=\"p\">(</span><span class=\"n\">Verifier</span><span class=\"p\">(</span><span class=\"n\">VerifierErrors</span><span class=\"p\">([</span><span class=\"n\">VerifierError</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">location</span>: <span class=\"nc\">block4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">context</span>: <span class=\"nb\">None</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">message</span>: <span class=\"s\">\"invalid domtree, expected idom(block4) = Some(inst15), got Some(inst14)\"</span><span class=\"w\"> </span><span class=\"p\">}])))</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">base</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">133</span>:<span class=\"mi\">14</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 222973827,
        "sender_full_name": "bjorn3",
        "timestamp": 1610792933
    },
    {
        "content": "<p>Any idea how I can debug this?</p>",
        "id": 222973843,
        "sender_full_name": "bjorn3",
        "timestamp": 1610792978
    },
    {
        "content": "<p>The manual verifier pass just after the generation of clif ir doesn't give any error. Only once compilation happens does this verifier error get hit.</p>",
        "id": 222973894,
        "sender_full_name": "bjorn3",
        "timestamp": 1610793049
    },
    {
        "content": "<p>Weird, do you have all the CLIF + same settings? And using the same backends in both cases?</p>",
        "id": 222974423,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1610793855
    },
    {
        "content": "<p>(same CPU flags too)</p>",
        "id": 222974428,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1610793871
    },
    {
        "content": "<p>Yes, I used the same cranelift commit, matched all flags and used the old backend in both cases.</p>",
        "id": 222974570,
        "sender_full_name": "bjorn3",
        "timestamp": 1610794105
    },
    {
        "content": "<p>Currently testing if the latest cranelift version has the same problem.</p>",
        "id": 222974579,
        "sender_full_name": "bjorn3",
        "timestamp": 1610794135
    },
    {
        "content": "<p>Updating doesn't help.</p>",
        "id": 222974801,
        "sender_full_name": "bjorn3",
        "timestamp": 1610794495
    },
    {
        "content": "<p>If you want to reproduce, just use <code>./prepare.sh &amp;&amp; ./test.sh --debug</code> on the latest commit of cg_clif.</p>",
        "id": 222974811,
        "sender_full_name": "bjorn3",
        "timestamp": 1610794529
    },
    {
        "content": "<p>Removing <a href=\"https://github.com/bjorn3/rustc_codegen_cranelift/blob/3ea8915d4a247b5b3c4cfb3424c230ccd2645b17/src/base.rs#L114-L119\">https://github.com/bjorn3/rustc_codegen_cranelift/blob/3ea8915d4a247b5b3c4cfb3424c230ccd2645b17/src/base.rs#L114-L119</a> doesn't help.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bjorn3/rustc_codegen_cranelift/blob/3ea8915d4a247b5b3c4cfb3424c230ccd2645b17/src/base.rs#L114-L119\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/17426603?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bjorn3/rustc_codegen_cranelift/blob/3ea8915d4a247b5b3c4cfb3424c230ccd2645b17/src/base.rs#L114-L119\" title=\"bjorn3/rustc_codegen_cranelift\">bjorn3/rustc_codegen_cranelift</a></div><div class=\"message_embed_description\">Cranelift based backend for rustc. Contribute to bjorn3/rustc_codegen_cranelift development by creating an account on GitHub.</div></div></div>",
        "id": 222974915,
        "sender_full_name": "bjorn3",
        "timestamp": 1610794690
    },
    {
        "content": "<p>One thing that would be interesting is the backtrace - the verifier runs several times during compilation, so knowing when it happens would be interesting.</p>",
        "id": 222975003,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1610794831
    },
    {
        "content": "<p>If you have the CLIF graph around, might be valuable too?</p>",
        "id": 222975006,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1610794838
    },
    {
        "content": "<p>This is the clif that gets compiled:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"w\"> </span><span class=\"n\">haswell</span><span class=\"w\"></span>\n\n<span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">117</span><span class=\"p\">(</span><span class=\"kt\">f32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i8</span> <span class=\"nc\">system_v</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"n\">_ZN4core3f3221_</span><span class=\"cp\">$LT$impl$u20$f32$GT$</span><span class=\"mi\">8</span><span class=\"n\">classify17h334bc58d8063a2b5E</span><span class=\"w\"></span>\n<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"n\">Instance</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">def</span>: <span class=\"nc\">Item</span><span class=\"p\">(</span><span class=\"n\">WithOptConstParam</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">did</span>: <span class=\"nc\">DefId</span><span class=\"p\">(</span><span class=\"mi\">0</span>:<span class=\"mi\">125</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"mf\">25e5</span><span class=\"p\">]</span>::<span class=\"kt\">f32</span>::<span class=\"p\">{</span><span class=\"k\">impl</span><span class=\"err\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span>::<span class=\"n\">classify</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">const_param_did</span>: <span class=\"nb\">None</span> <span class=\"p\">}),</span><span class=\"w\"> </span><span class=\"n\">substs</span>: <span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">ss0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">explicit_slot</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">f32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i32</span> <span class=\"nc\">system_v</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">118</span><span class=\"w\"> </span><span class=\"n\">sig0</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span>: <span class=\"kt\">f32</span><span class=\"p\">)</span>:\n                                    <span class=\"nc\">v1</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v0</span><span class=\"w\"></span>\n<span class=\"w\">                                    </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"w\">                                    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block1</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block1</span>:\n                                    <span class=\"nc\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0002</span><span class=\"w\">                               </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v1</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                                    </span><span class=\"n\">v3</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v2</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0002</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block2</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block2</span>:\n<span class=\"o\">@</span><span class=\"mi\">0002</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0005</span><span class=\"w\">                               </span><span class=\"n\">v4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0x007f_ffff</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0005</span><span class=\"w\">                               </span><span class=\"n\">v5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"w\"></span>\n<span class=\"w\">                                    </span><span class=\"n\">v11</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v5</span><span class=\"w\"></span>\n<span class=\"w\">                                    </span><span class=\"n\">v23</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v5</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0008</span><span class=\"w\">                               </span><span class=\"n\">v6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0x7f80_0000</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0008</span><span class=\"w\">                               </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v6</span><span class=\"w\"></span>\n<span class=\"w\">                                    </span><span class=\"n\">v8</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v7</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">c</span><span class=\"w\">                               </span><span class=\"n\">brz</span><span class=\"w\"> </span><span class=\"n\">v5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block3</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">c</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v7</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block3</span>:\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">c</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">d</span><span class=\"w\">                               </span><span class=\"n\">brz</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">d</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v8</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v9</span>: <span class=\"kt\">i32</span><span class=\"p\">)</span>:\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">d</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">e</span><span class=\"w\">                               </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp_imm</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"n\">v9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x7f80_0000</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">e</span><span class=\"w\">                               </span><span class=\"n\">brnz</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block5</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">e</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block12</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block12</span>:\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">e</span><span class=\"w\">                               </span><span class=\"n\">brz</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block8</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">e</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block5</span>:\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">e</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">f</span><span class=\"w\">                               </span><span class=\"n\">brz</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block9</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">f</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block10</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block6</span>:\n<span class=\"o\">@</span><span class=\"mi\">000</span><span class=\"n\">f</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0010</span><span class=\"w\">                               </span><span class=\"n\">v12</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0010</span><span class=\"w\">                               </span><span class=\"n\">stack_store</span><span class=\"w\"> </span><span class=\"n\">v12</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">v13</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stack_load</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v13</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block7</span>:\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0012</span><span class=\"w\">                               </span><span class=\"n\">v14</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0012</span><span class=\"w\">                               </span><span class=\"n\">stack_store</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stack_load</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v15</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block8</span>:\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0013</span><span class=\"w\">                               </span><span class=\"n\">v16</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0013</span><span class=\"w\">                               </span><span class=\"n\">stack_store</span><span class=\"w\"> </span><span class=\"n\">v16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stack_load</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v17</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block9</span>:\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0014</span><span class=\"w\">                               </span><span class=\"n\">v18</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0014</span><span class=\"w\">                               </span><span class=\"n\">stack_store</span><span class=\"w\"> </span><span class=\"n\">v18</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">v19</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stack_load</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v19</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block10</span>:\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0015</span><span class=\"w\">                               </span><span class=\"n\">v20</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0015</span><span class=\"w\">                               </span><span class=\"n\">stack_store</span><span class=\"w\"> </span><span class=\"n\">v20</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">v21</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stack_load</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v21</span><span class=\"w\"></span>\n\n<span class=\"w\">                                </span><span class=\"n\">block11</span>:\n<span class=\"o\">@</span><span class=\"mi\">0011</span><span class=\"w\">                               </span><span class=\"n\">nop</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0017</span><span class=\"w\">                               </span><span class=\"n\">v22</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">stack_load</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">ss0</span><span class=\"w\"></span>\n<span class=\"o\">@</span><span class=\"mi\">0017</span><span class=\"w\">                               </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v22</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 222975177,
        "sender_full_name": "bjorn3",
        "timestamp": 1610795044
    },
    {
        "content": "<p>did cg_clif insert these nops?</p>",
        "id": 222975592,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1610795576
    },
    {
        "content": "<p>for instance for block3, the expected dominator value is wrong -- it's the actual value that's correct</p>",
        "id": 222975647,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1610795650
    },
    {
        "content": "<p>Yes, cg_clif inserts these nops at the start of the codegen of each mir block. I have code writing comments after specified instructions when printing the clif ir. The comment for the first mir statement is attached to this nop.</p>",
        "id": 222975863,
        "sender_full_name": "bjorn3",
        "timestamp": 1610795948
    },
    {
        "content": "<p>When making <code>Context::verify</code> panic on verifier errors I got the following backtrace:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">   </span><span class=\"mi\">0</span>: <span class=\"nc\">rust_begin_unwind</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"mf\">44e3</span><span class=\"n\">daf5eee8263dfc3a2509e78ddd1f6f783a0e</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">panicking</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">493</span>:<span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">1</span>: <span class=\"nc\">std</span>::<span class=\"n\">panicking</span>::<span class=\"n\">begin_panic_fmt</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"mf\">44e3</span><span class=\"n\">daf5eee8263dfc3a2509e78ddd1f6f783a0e</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">panicking</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">435</span>:<span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">2</span>: <span class=\"nc\">cranelift_codegen</span>::<span class=\"n\">context</span>::<span class=\"n\">Context</span>::<span class=\"n\">verify</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">bjorn</span><span class=\"o\">/</span><span class=\"n\">Documenten</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">context</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">293</span>:<span class=\"mi\">13</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">3</span>: <span class=\"nc\">cranelift_codegen</span>::<span class=\"n\">context</span>::<span class=\"n\">Context</span>::<span class=\"n\">verify_if</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">bjorn</span><span class=\"o\">/</span><span class=\"n\">Documenten</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">context</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">302</span>:<span class=\"mi\">13</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">4</span>: <span class=\"nc\">cranelift_codegen</span>::<span class=\"n\">context</span>::<span class=\"n\">Context</span>::<span class=\"n\">preopt</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">bjorn</span><span class=\"o\">/</span><span class=\"n\">Documenten</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">context</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">347</span>:<span class=\"mi\">9</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">5</span>: <span class=\"nc\">cranelift_codegen</span>::<span class=\"n\">context</span>::<span class=\"n\">Context</span>::<span class=\"n\">compile</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">bjorn</span><span class=\"o\">/</span><span class=\"n\">Documenten</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">context</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">173</span>:<span class=\"mi\">13</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">6</span>: <span class=\"o\">&lt;</span><span class=\"n\">cranelift_object</span>::<span class=\"n\">backend</span>::<span class=\"n\">ObjectModule</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">cranelift_module</span>::<span class=\"n\">module</span>::<span class=\"n\">Module</span><span class=\"o\">&gt;</span>::<span class=\"n\">define_function</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">bjorn</span><span class=\"o\">/</span><span class=\"n\">Documenten</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">object</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">backend</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">263</span>:<span class=\"mi\">13</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">7</span>: <span class=\"nc\">rustc_codegen_cranelift</span>::<span class=\"n\">base</span>::<span class=\"n\">codegen_fn</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">bjorn</span><span class=\"o\">/</span><span class=\"n\">Documenten</span><span class=\"o\">/</span><span class=\"n\">cg_clif</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">base</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">126</span>:<span class=\"mi\">9</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The verifier error happens after preopt.</p>",
        "id": 222977359,
        "sender_full_name": "bjorn3",
        "timestamp": 1610798096
    },
    {
        "content": "<p><code>context.domtree.clear()</code> after the optimizations done by cg_clif itself fixes it.</p>",
        "id": 222977679,
        "sender_full_name": "bjorn3",
        "timestamp": 1610798468
    },
    {
        "content": "<p>Some optimizations probably don't expect it to already be computed and thus don't invalidate it as necessary.</p>",
        "id": 222977754,
        "sender_full_name": "bjorn3",
        "timestamp": 1610798552
    },
    {
        "content": "<p>Fixed in <a href=\"https://github.com/bjorn3/rustc_codegen_cranelift/commit/cfedad1f75bf22468fce59f754daf1501fa2827d\">https://github.com/bjorn3/rustc_codegen_cranelift/commit/cfedad1f75bf22468fce59f754daf1501fa2827d</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bjorn3/rustc_codegen_cranelift/commit/cfedad1f75bf22468fce59f754daf1501fa2827d\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/17426603?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bjorn3/rustc_codegen_cranelift/commit/cfedad1f75bf22468fce59f754daf1501fa2827d\" title=\"Clear domtree after cg_clif optimizations · bjorn3/rustc_codegen_cranelift@cfedad1\">Clear domtree after cg_clif optimizations · bjorn3/rustc_codegen_cranelift@cfedad1</a></div><div class=\"message_embed_description\">Cranelift based backend for rustc. Contribute to bjorn3/rustc_codegen_cranelift development by creating an account on GitHub.</div></div></div>",
        "id": 222977922,
        "sender_full_name": "bjorn3",
        "timestamp": 1610798753
    },
    {
        "content": "<p>Nice to know there's a workaround, I'd be really interested in extracting a clif test case to reproduce. Maybe time to eat the frog and set up cg_clif <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 222979178,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1610800492
    },
    {
        "content": "<p>I think the repro would be something like <code>context.compute_cfg(); context.compute_domtree(); context.preopt(isa).unwrap();</code> with the verifier enabled on a function containing a nop instruction.</p>",
        "id": 222979314,
        "sender_full_name": "bjorn3",
        "timestamp": 1610800718
    }
]