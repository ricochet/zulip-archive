[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254389\">@Chris Fallin</span> <span class=\"user-mention\" data-user-id=\"506239\">@Trevor Elliott</span>: will ra2 ever prefer to spill rather than start to use non-preferred registers when it has only been using preferred registers thus far?</p>\n<p>I ask because I'm seeing the following distributions of number of clobbered callee-save registers for our sightglass benchmarks. I find it very surprising that it is always zero or all callee-save registers. Not ever a single time where we clobber just some of the callee-save registers.</p>\n<h3>pulldown-cmark</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">757</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.9682959048877162</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4428038716280174</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.967290755240832</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">9</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">459</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">298</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>spidermonkey</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">18279</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.8119153126538674</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4034432514706436</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.77653946303978</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">233</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">11655</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">6624</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>bz2</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">127</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.5511811023622047</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.5659198268780583</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.452104904209808</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">113</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>",
        "id": 373032545,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1688682012
    },
    {
        "content": "<p>RA2 will try to use non-preferred registers before spilling</p>",
        "id": 373034104,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1688682734
    },
    {
        "content": "<p>I don't have time to page in enough context to grok the above right now but I'm happy to look at it with you later</p>",
        "id": 373034183,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1688682769
    },
    {
        "content": "<p>Incidentally, something that would be interesting to try is to move pregs from the non-preferred set to the preferred set when they are used for the first time. The logic here is that once you've saved the register is the function prologue, it costs just as much as other callee-saved registers to use.</p>",
        "id": 373161686,
        "sender_full_name": "Amanieu",
        "timestamp": 1688726519
    },
    {
        "content": "<p>ah that's actually a great idea -- happy to review a PR for that if you want to make one</p>",
        "id": 373256332,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1688744966
    },
    {
        "content": "<p>My use case doesn't have proper stack frames (returns are treated as a new entry point into the function), so it's not something I would use myself. I just use preferred/non-preferred to hint towards selecting registers with a compressed RISC-V encoding (x8-x15).</p>",
        "id": 373324257,
        "sender_full_name": "Amanieu",
        "timestamp": 1688762275
    },
    {
        "content": "<p>It would be nice to be able to save callee-saved registers only in the paths that actually clobber them. Interpreters may have a fast path where they don't clobber any callee-saved registers and a slow path which does a lot more work and as such has to clobber some callee-saved registers. Moving the saves from the prologue to the slow path would speed up the fast path.</p>",
        "id": 373333114,
        "sender_full_name": "bjorn3",
        "timestamp": 1688765810
    }
]