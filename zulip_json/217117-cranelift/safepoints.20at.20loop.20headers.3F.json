[
    {
        "content": "<p>right now, we only insert safepoints at calls and interrupt traps:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61\">https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61</a></p>\n<p>it seems like we would really want to insert them at loop headers as well, to allow GC during long-lasting loops.</p>\n<p>does anyone know if either (a) I'm overlooking some code that handles this for us, or (b) if we already have an issue on file for this (a cursory search failed to find any)? thanks!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61\" title=\"bytecodealliance/wasmtime\">bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>",
        "id": 199682837,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1591221809
    },
    {
        "content": "<p>FWIW, I did some digging last week on this (in the context of eventual reftype work) and also couldn't find anything for loops</p>",
        "id": 199684953,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1591223184
    },
    {
        "content": "<p>filed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1815\">https://github.com/bytecodealliance/wasmtime/issues/1815</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/1815\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/1815\" title=\"Insert safepoints at loop headers 路 Issue #1815 路 bytecodealliance/wasmtime\">Insert safepoints at loop headers 路 Issue #1815 路 bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Right now, we only insert them at (resumable) interrupt traps and calls: https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61 But long runnin...</div></div></div>",
        "id": 199687879,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1591225381
    },
    {
        "content": "<p>but actually, now that I think about it, the loop header has to have some sort of check for whether the gc requested that the wasm synchronize and stop at a safepoint, which likely will involve some call, e.g it checks a flag hanging off the vmctx and (if set) calls into  <code>gc_synchronize</code> or something, and that call will get a safepoint. so maybe everything is fine here, and nothing needs to change...</p>",
        "id": 199688028,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1591225494
    },
    {
        "content": "<p>I was curious how this works in wasm on Ion/x86, so I went digging a bit... here's the insertion of an interrupt-check op in the loop header: <a href=\"https://searchfox.org/mozilla-central/source/js/src/wasm/WasmIonCompile.cpp#2218\">https://searchfox.org/mozilla-central/source/js/src/wasm/WasmIonCompile.cpp#2218</a>  (<code>MWasmInterruptCheck</code> IR node, lowered to <code>LWasmInterruptCheck</code>) which eventually leads to this codegen: <a href=\"https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#13952\">https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#13952</a></p>",
        "id": 199690222,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1591227204
    },
    {
        "content": "<p>The interrupt check itself is a conditional branch (on some flag in the tlsdata) around a trap instruction: <a href=\"https://searchfox.org/mozilla-central/source/js/src/jit/MacroAssembler.cpp#3253\">https://searchfox.org/mozilla-central/source/js/src/jit/MacroAssembler.cpp#3253</a></p>",
        "id": 199690302,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1591227250
    },
    {
        "content": "<p>interestingly, it does seem to add a safepoint in the happy (non-interrupt) path, so I can only assume this is zero cost (i.e. doesn't spill anything): <a href=\"https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#13958\">https://searchfox.org/mozilla-central/source/js/src/jit/CodeGenerator.cpp#13958</a></p>",
        "id": 199690335,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1591227300
    },
    {
        "content": "<p>(actually, that safepoint is right at the return PC for the trap so semantically it's really part of the cold path; I suppose because only the return PC is available when the trap is handled)</p>",
        "id": 199690431,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1591227370
    },
    {
        "content": "<p>in any case you're probably right that we'd be able to call some handler and we'd get the safepoint for free</p>",
        "id": 199690441,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1591227384
    },
    {
        "content": "<p>So Cranelift-in-Spidermonkey generates an interrupt check as well, at the top of loop headers <a href=\"https://searchfox.org/mozilla-central/source/js/src/wasm/cranelift/src/wasm2clif.rs#1244\">https://searchfox.org/mozilla-central/source/js/src/wasm/cranelift/src/wasm2clif.rs#1244</a>, and this will end handling the interrupt the same way Spidermonkey does.</p>",
        "id": 199728506,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1591266816
    },
    {
        "content": "<p>The translate_loop_header documentation explicitly mentions safepoints, but it seems we don't generate them at this point <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 199728687,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1591266912
    },
    {
        "content": "<p>I just saw this link from <span class=\"user-mention\" data-user-id=\"253990\">@fitzgen (he/him)</span> 's issue on github: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61\">https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61</a><br>\nSo yeah, since Spidermonkey generates this trapnz at loop headers, it will create a safepoint there. This sort of synchronization might be a bit fragile...</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L54-L61\" title=\"bytecodealliance/wasmtime\">bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>",
        "id": 199746751,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1591277561
    },
    {
        "content": "<p>(And here's a new piece of information: it actually doesn't get added, because Spidermonkey generates trapif, not trap! Did i say this was fragile...)</p>",
        "id": 199749505,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1591278695
    },
    {
        "content": "<p>Only resumable_trap get safepoints because otherwise nothing is considered live after the trap</p>",
        "id": 199761029,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1591283372
    },
    {
        "content": "<p>Traps in Spidermonkey are resumable, so there might be something going on here...</p>",
        "id": 199761550,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1591283565
    },
    {
        "content": "<p>Actually, the CLIR Trap and ReusableTrap would both get a safepoint created, only not instructions using the CondTrap format.</p>",
        "id": 199762705,
        "sender_full_name": "Benjamin Bouvier",
        "timestamp": 1591283986
    },
    {
        "content": "<p>if you look at <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L22\"><code>insert_and_encode_safepoint</code></a>, if there are no live references, then it skips the insertion of the safepoint, and for non-resumable traps (<code>trap</code>) there are always no live references. I was playing around with this a bit yesterday trying to make <code>emit_stackmaps</code> check <code>if let Some(TrapCode::Interrupt) = pos.func.dfg[inst].trap_code()</code> instead of explicitly only checking for <code>InstructionFormat::Trap</code> instructions</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L22\" style=\"background-image: url(https://avatars0.githubusercontent.com/u/54038801?s=400&amp;v=4)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/regalloc/safepoint.rs#L22\" title=\"bytecodealliance/wasmtime\">bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Standalone JIT-style runtime for WebAssembly, using Cranelift - bytecodealliance/wasmtime</div></div></div>",
        "id": 199774286,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1591288578
    }
]