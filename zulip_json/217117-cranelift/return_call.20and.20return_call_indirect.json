[
    {
        "content": "<p>(I'm aware of <a href=\"#narrow/stream/217117-cranelift/topic/jump_indirect.20instruction.3F\">previous discussions regarding tail calls</a> and <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1065\">the corresponding Github issue</a>.)</p>\n<p>I am trying to create new CLIF instructions <code>return_call</code> and <code>return_call_indirect</code>. The idea is to translate WASM <code>return_call</code> and <code>return_call_indirect</code> into them respectively.</p>\n<p>One roadblock I've hit is that cranelift will complain about the block containing the <code>return_call</code> instruction is not filled when finalizing the translation in the function (<code>FunctionBuilder::finalize(&amp;mut self)</code> in <code>cranelift/frontend/src/frontend.rs:479:17</code>). </p>\n<p>In the added <code>return_call</code> instruction, we've used the <code>InstructionFormat</code> of <code>Call</code> and make sure that <code>is_call</code>, <code>is_return</code> and <code>is_terminator</code> is true. In <code>translate_operator()</code> in <code>cranelift/wasm/src/code_translator.rs</code>, I have made sure to set <code>state.reachable</code> to <code>false</code> after translating WASM <code>return_call</code>.</p>\n<p>Is there any other places I've overlooked for implementing this CLIR instruction? Thanks!</p>\n<p>See attached for the test case I'm working on and the error trace. <br>\n<a href=\"/user_uploads/15107/HC8TVjBibdtFcDJub-d5iLvv/error-trace.txt\">error-trace.txt</a> <br>\n<a href=\"/user_uploads/15107/RZOXqSVBeqbdhnouvJa4qGQe/factorial-return-call.wat\">factorial-return-call.wat</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/1065\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/56179eb96159bd21d9c1731226174a7708ad0a13\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653462353665383439353966376265376166633834363837396664333165326462623865393532353063636639333133653562303636663539613530663937662f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f31303635)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/1065\" title=\"Is there any support for tail call eliminations? Are there any plans about it? · Issue #1065 · bytecodealliance/wasmtime\">Is there any support for tail call eliminations? Are there any plans about it? · Issue #1065 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">To write a functional language compiler using this IR, tail call eliminations would be desirable. Are there any plans to support this? I couldn't find any details in the docs.</div></div></div>",
        "id": 289502694,
        "sender_full_name": "Yangtian Zi",
        "timestamp": 1657737718
    },
    {
        "content": "<p>the block should be marked filled on line 159 when the instruction builder is used to insert a terminator instruction</p>\n<p>I'd suggest adding some <code>eprintln!</code>s and <code>dbg!</code>s to help debug where your updates to <code>is_terminator</code> and the frontend code is going wrong</p>\n<p>but backing up a bit: adding tail call support is something that is going to have pretty deep implications to our calling conventions and I'd encourage you to figure all that out first and reach consensus with the wasmtime/cranelift teams via an <a href=\"https://github.com/bytecodealliance/rfcs/\">RFC</a> on what the updated calling conventions will be since this is so fundamental and spans all of cranelift and wasmtime. for example, the github issue linked links to <a href=\"https://docs.google.com/document/d/1oi6ROZJuE-hBb21Tgq-XcUegPktecF52gADzBJcYL34\">SpiderMonkey's document describing their new calling convention</a> and everything required to support the union of tail calls, multi-value returns, and reference types with stack maps and it is 25 pages long. we should really agree on what we want things to look like at the end before diving head first into implementation</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/rfcs/\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/5fe2b5cb078cc331ae1ded4fcdfcb30bbc4fbaee\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626337613061393135363465633063653437663530396136306533643964623264366462353432393163666565386536643633616638613139353831356537332f62797465636f6465616c6c69616e63652f72666373)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/rfcs/\" title=\"GitHub - bytecodealliance/rfcs: RFC process for Bytecode Alliance projects\">GitHub - bytecodealliance/rfcs: RFC process for Bytecode Alliance projects</a></div><div class=\"message_embed_description\">RFC process for Bytecode Alliance projects. Contribute to bytecodealliance/rfcs development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://docs.google.com/document/d/1oi6ROZJuE-hBb21Tgq-XcUegPktecF52gADzBJcYL34\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/107e31e2ee200f7dbeaa344e3bd603785decdcbb\\/68747470733a2f2f6c68362e676f6f676c6575736572636f6e74656e742e636f6d2f51625950376b4d3364347a5a323378395662344a674c664c3251666a547a556d51676b694d35327473733343437648465a58725f736961535a7947676d7958753831744b4b4b6a4c34476f556f413d77313230302d683633302d70)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://docs.google.com/document/d/1oi6ROZJuE-hBb21Tgq-XcUegPktecF52gADzBJcYL34\" title=\"WebAssembly ABI 2020\">WebAssembly ABI 2020</a></div><div class=\"message_embed_description\">WebAssembly ABI 2020 As noted below, this document has been superseded by WebAssembly ABI 2022.  What follows is of historical interest only! Summary The “ABI” (Application Binary Interface) defines conventions for interoperations between different pieces of code.  In SpiderMonkey, the WebAssembl...</div></div></div>",
        "id": 289520109,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1657745996
    }
]