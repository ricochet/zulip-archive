[
    {
        "content": "<p>I added an <a href=\"https://github.com/bytecodealliance/meetings/pull/272\">agenda item</a> but as <span class=\"user-mention\" data-user-id=\"254389\">@Chris Fallin</span> mentioned no reason this can't be done async either!</p>\n<p>I have a really old branch for using AVX instructions for <code>ucomis*</code> and <code>ptest</code> rather than today where Cranelift unconditionally uses the pre-AVX versions (even when AVX is enabled). I tried to revive that this weekend and one of the main reasons I never landed it was <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b26fd0af77ddce3431ce97065380241b20ef76a1/cranelift/codegen/src/isa/x64/inst.isle#L2837-L2838\">this comment</a>. The <code>x64_ucomis</code> is an unusual instruction helper  in that it takes <code>Value</code> arguments as opposed to registers, and it appears to be due to this comment.</p>\n<p>I was hoping, while looking at this instruction, to improve the consistency of this helper with the rest of the backend. To that effect I added back in <code>put_in_xmm_mem</code> to hope I saw a failure of some kind in the test suite, but nothing arose. Keeping the <code>put_in_xmm_mem</code> there I tried my best to craft CLIF to generate a sunk load into the <code>ucomis</code> instruction to see if I could get it to be duplicated by accident. In the end though I couldn't \"cause a problem\" by reverting back to the \"buggy code\".</p>\n<p>This comment was added in <a href=\"https://github.com/bytecodealliance/wasmtime/pull/3934\">3934</a> which references <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2576\">2576</a> as well. The test case added in 3934 no longer reproduces the issue (I checked out 3934 as-is and could reproduce the issue, however).</p>\n<p>So that leads me to the final question: does anyone know how to trigger the behavior to generate multiple cmp instructions? I'd like to add a test case to make sure I don't accidentally break anything. If we can't find a test case, does anyone know if this comment is still applicable and/or if other changes in the meantime have made it obsolete?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/meetings/pull/272\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/7659815a25990b11e41035d1ca6c5f6d2222c195\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393437303337313730386337656236653366373932643736633330353239633362646334343861346664643762636666366331373633626262396635663839322f62797465636f6465616c6c69616e63652f6d656574696e67732f70756c6c2f323732)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/meetings/pull/272\" title=\"Add an agenda item for next week's Cranelift meeting by alexcrichton · Pull Request #272 · bytecodealliance/meetings\">Add an agenda item for next week's Cranelift meeting by alexcrichton · Pull Request #272 · bytecodealliance/meetings</a></div><div class=\"message_embed_description\">I'm pretty sure I asked this before but I've forgotten the answer in the meantime.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/b26fd0af77ddce3431ce97065380241b20ef76a1/cranelift/codegen/src/isa/x64/inst.isle#L2837-L2838\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/d28d4f5064e27ea9e924ad2dd21f5b5eff09d3b0\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366664336238316531373433616662376462366661646438313165656337616335333765373466653534616465303763633164656137623230376335313762652f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/b26fd0af77ddce3431ce97065380241b20ef76a1/cranelift/codegen/src/isa/x64/inst.isle#L2837-L2838\" title=\"wasmtime/cranelift/codegen/src/isa/x64/inst.isle at b26fd0af77ddce3431ce97065380241b20ef76a1 · bytecodealliance/wasmtime\">wasmtime/cranelift/codegen/src/isa/x64/inst.isle at b26fd0af77ddce3431ce97065380241b20ef76a1 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/3934\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/083f4d979bf0ed03753aee61328fb7d6d9115053\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653661643035376239633232636638323936623035303265376361663832633564336132346136336436613136323461656639386135343831643338643039362f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f33393334)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/3934\" title=\"x64 backend: fix fpcmp to avoid load-op merging. by cfallin · Pull Request #3934 · bytecodealliance/wasmtime\">x64 backend: fix fpcmp to avoid load-op merging. by cfallin · Pull Request #3934 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">The fpcmp helper in the x64 backend uses put_in_xmm_mem for one of\nits operands, which allows the compiler to merge a load with the compare\ninstruction (ucomiss or ucomisd).\nUnfortunately, as we sa...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/2576\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/7b0d1006b93ac3456ce9bc0aa36314a166e06c95\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373133353538626235633661633535303738313434393865356438633831396234663665386130356334633231616233363833393938646261653634313131302f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f32353736)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/2576\" title=\"x64 bugfix: prevent load-op fusion of cmp because it could be emitted multiple times. by cfallin · Pull Request #2576 · bytecodealliance/wasmtime\">x64 bugfix: prevent load-op fusion of cmp because it could be emitted multiple times. by cfallin · Pull Request #2576 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">On x64, the new backend generates cmp instructions at their use-sites\nwhen possible (when the icmp that generates a boolean is known) so that\nthe condition flows directly through flags rather than ...</div></div></div>",
        "id": 433319056,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713194331
    },
    {
        "content": "<p>The short answer is that we <em>should</em> still be generating a <code>cmp</code> every time we use the flags; try e.g. two different selects from the same cond, with different data inputs so they don't merge in GVN?</p>",
        "id": 433373752,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713210627
    },
    {
        "content": "<p>The tradeoff we've made here is that we don't want to deal with \"at most one flags value can be alive at once\" in regalloc, combined with rematerialization to recreate flags when that's a conflict; that's a much much harder cross-cutting problem</p>",
        "id": 433373865,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713210672
    },
    {
        "content": "<p>so instead, we generate flags at use, and that's baked in pretty deeply</p>",
        "id": 433373890,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713210681
    },
    {
        "content": "<p>I don't have a chance to look at the test now (very short layover then long flight) but can try to help reproduce this next week if still stuck</p>",
        "id": 433373977,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713210710
    },
    {
        "content": "<p>FWIW, to your initial point: we could take <code>Xmm</code> args instead of <code>Value</code> args, which would still force the same thing (no load-op merging) while being more in line with other instruction ctors; maybe that would help?</p>",
        "id": 433374293,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713210794
    },
    {
        "content": "<p>yeah taking <code>Xmm Xmm</code> would work well, but I was hoping to avoid that to over-specialize on this case</p>",
        "id": 433377998,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713211956
    },
    {
        "content": "<p>e.g. if this is still necessary I'd prefer to have the comment for \"don't put this in mem\" right next to the place that requires it</p>",
        "id": 433378034,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713211974
    },
    {
        "content": "<p>it feels pretty buried-at-a-distance right now</p>",
        "id": 433378057,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713211982
    },
    {
        "content": "<p>Currently with this input clif:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">a</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">f32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">f32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">f32</span> <span class=\"p\">{</span>\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span>: <span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span>: <span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span>: <span class=\"kt\">f32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span>: <span class=\"kt\">f32</span><span class=\"p\">)</span>:\n  <span class=\"nc\">v8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">f32</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">v0</span>\n<span class=\"w\">  </span><span class=\"n\">v9</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">f32</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">v1</span>\n<span class=\"w\">  </span><span class=\"n\">v4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fcmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"n\">v8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v9</span>\n\n<span class=\"w\">  </span><span class=\"n\">v5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">select</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span>\n<span class=\"w\">  </span><span class=\"n\">v6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">select</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"w\">  </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fadd</span><span class=\"w\"> </span><span class=\"n\">v5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v6</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v7</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I can get:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">clif</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">x86_64</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">opt_level</span><span class=\"o\">=</span><span class=\"n\">speed</span>\n<span class=\"p\">.</span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"mi\">85</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">137</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">229</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">102</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">111</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">232</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">243</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">243</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">38</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">46</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">220</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">102</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">111</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">213</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">102</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">111</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">194</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">139</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">242</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">193</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">132</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">242</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">193</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">46</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">220</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">139</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">242</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">202</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">132</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">242</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">202</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">243</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">193</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">137</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">236</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">93</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">195</span>\n\n<span class=\"n\">Disassembly</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">79</span><span class=\"w\"> </span><span class=\"n\">bytes</span>:\n   <span class=\"mi\">0</span>:   <span class=\"mi\">55</span><span class=\"w\">                      </span><span class=\"n\">pushq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span>:   <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">e8</span><span class=\"w\">             </span><span class=\"n\">movdqa</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm5</span>\n<span class=\"w\">   </span><span class=\"mi\">8</span>:   <span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"n\">f</span><span class=\"w\">             </span><span class=\"n\">movss</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm3</span>\n<span class=\"w\">   </span><span class=\"n\">c</span>:   <span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">26</span><span class=\"w\">             </span><span class=\"n\">movss</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm4</span>\n<span class=\"w\">  </span><span class=\"mi\">10</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">dc</span><span class=\"w\">                </span><span class=\"n\">ucomiss</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm3</span>\n<span class=\"w\">  </span><span class=\"mi\">13</span>:   <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">d5</span><span class=\"w\">             </span><span class=\"n\">movdqa</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm2</span>\n<span class=\"w\">  </span><span class=\"mi\">17</span>:   <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">c2</span><span class=\"w\">             </span><span class=\"n\">movdqa</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm0</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"n\">b</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">jnp</span><span class=\"w\">     </span><span class=\"mh\">0x25</span>\n<span class=\"w\">  </span><span class=\"mi\">21</span>:   <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">c1</span><span class=\"w\">             </span><span class=\"n\">movsd</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm0</span>\n<span class=\"w\">  </span><span class=\"mi\">25</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">je</span><span class=\"w\">      </span><span class=\"mh\">0x2f</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"n\">b</span>:   <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">c1</span><span class=\"w\">             </span><span class=\"n\">movsd</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm0</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"n\">f</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">dc</span><span class=\"w\">                </span><span class=\"n\">ucomiss</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm3</span>\n<span class=\"w\">  </span><span class=\"mi\">32</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">jnp</span><span class=\"w\">     </span><span class=\"mh\">0x3c</span>\n<span class=\"w\">  </span><span class=\"mi\">38</span>:   <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">ca</span><span class=\"w\">             </span><span class=\"n\">movsd</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"n\">c</span>:   <span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">je</span><span class=\"w\">      </span><span class=\"mh\">0x46</span>\n<span class=\"w\">  </span><span class=\"mi\">42</span>:   <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">ca</span><span class=\"w\">             </span><span class=\"n\">movsd</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span>\n<span class=\"w\">  </span><span class=\"mi\">46</span>:   <span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">58</span><span class=\"w\"> </span><span class=\"n\">c1</span><span class=\"w\">             </span><span class=\"n\">addss</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm0</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"n\">a</span>:   <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rsp</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"n\">d</span>:   <span class=\"mi\">5</span><span class=\"n\">d</span><span class=\"w\">                      </span><span class=\"n\">popq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"n\">e</span>:   <span class=\"nc\">c3</span><span class=\"w\">                      </span><span class=\"n\">retq</span>\n</code></pre></div>\n<p>and this is _after_ I remove the <code>put_in_xmm</code> to let the values get naturally coerced to <code>Xmm</code> and <code>XmmMem</code></p>",
        "id": 433378997,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713212331
    },
    {
        "content": "<p>so I can see the <code>ucomiss</code> getting duplicated, but I can't somehow get sinking to happen</p>",
        "id": 433379037,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713212349
    },
    {
        "content": "<p>when I debugged this a bit it seemed like instruction colors were differing which prevented sinking, so I'm wondering as well if the coloring part (which I don't fully understand) serves as the guard here and the comment in <code>inst.isle</code> isn't necessary</p>",
        "id": 433379157,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713212380
    },
    {
        "content": "<p>Ah, try with only one load</p>",
        "id": 433381684,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713213302
    },
    {
        "content": "<p>no dice :(</p>",
        "id": 433381908,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713213377
    },
    {
        "content": "<p>I tried <code>v4 = fcmp eq v2, v8</code> and swapped the v2/v8 operands and still no load sinking</p>",
        "id": 433381952,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713213396
    },
    {
        "content": "<p>The issue with comment location is: where else would it go? The basic issue has to do with compares and there’s no other central place for that. Possibly a typesafe encoding to make this aspect of lowering completely separate</p>",
        "id": 433381959,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713213400
    },
    {
        "content": "<p>oh that's just it, I don't know where to put this</p>",
        "id": 433382030,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713213430
    },
    {
        "content": "<p>(Boarding doors closing / phone off, more thoughts later)</p>",
        "id": 433382058,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713213439
    },
    {
        "content": "<p>the current location feels wrong because I can't seem to trigger the bad case</p>",
        "id": 433382072,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713213444
    },
    {
        "content": "<p>np!</p>",
        "id": 433382079,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713213446
    },
    {
        "content": "<p>took another look at tracelog output; it seems the multiplicity analysis is doing the right thing here and marking v8 and v9 as <code>Multiple</code> (transitively) because <code>v4</code> (the cmp) is used multiple times</p>",
        "id": 433437787,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713240104
    },
    {
        "content": "<p>so... maybe that handles any multi-use case actually? I'm having trouble thinking of a way to get the fcmp to codegen multiple times without actually using the value at the SSA level multiple times</p>",
        "id": 433437965,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713240202
    },
    {
        "content": "<p>coloring will serve to keep the loads \"in order\", which is why I had suggested trying one load earlier -- sinking one load over the other might have been problematic -- but doesn't deal with multiplicity</p>",
        "id": 433438055,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713240251
    },
    {
        "content": "<p><code>git blame</code> tells me I wrote the multiplicity analysis in Apr 2022 (<code>e4b7c8a7376</code>, <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4061\">https://github.com/bytecodealliance/wasmtime/pull/4061</a>), after the initial bugs above, so maybe we can actually remove this safeguard in <code>inst.isle</code>?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/4061\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/0f51e0a16c0588a4517f7d11fb46ade32b6c15d8\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333133613735343538356166376266393833366265623532333462393330323038373834333334633866623362623934616665386135373264636531323966352f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f34303631)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/4061\" title=\"Cranelift: fix #3953: rework single/multiple-use logic in lowering. by cfallin · Pull Request #4061 · bytecodealliance/wasmtime\">Cranelift: fix #3953: rework single/multiple-use logic in lowering. by cfallin · Pull Request #4061 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This PR addresses the longstanding issue with loads trying to merge\ninto compares on x86-64, and more generally, with the lowering\nframework falsely recognizing \"single uses\" of one op by\nanother (...</div></div></div>",
        "id": 433438359,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713240474
    },
    {
        "content": "<p>all of my 2021/2022 cranelift hacking is a blur at this point and from a good practices PoV I'd rather lean on trusting the tests and fuzzing than \"no wait stop there's a subtle thing only in my brain\" so... please do feel free to remove it!</p>",
        "id": 433438478,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1713240574
    },
    {
        "content": "<p>ok sounds good! I'll try to collect a suite of tests while I'm at it which look like load sinking maybe should occur and I'll leave a comment in the test that if load sinking does end up happening in the future more thought needs to be applied to the various rules</p>",
        "id": 433533426,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1713277109
    }
]