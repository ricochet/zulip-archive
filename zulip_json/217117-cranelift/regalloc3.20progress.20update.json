[
    {
        "content": "<p>Happy new year! I'd like to give an update on my progress with regalloc3: I've been working on a new algorithm for live range splitting that is inspired by the one used in LLVM. The basic idea is as follows:</p>\n<ul>\n<li>Identify the hottest use in a live range. This is usually the one in the deepest loop.</li>\n<li>Starting from that use, build \"gaps\" that extend the live range to the next or previous use (in linear instruction order), or to the next/previous loop boundary.</li>\n<li>Then for each physical register in the allocation order:<ul>\n<li>Iterate over all interfering vregs in that register to find, for each gap, the maximum spill weight that needs to be evicted in order to allocate a live range to the gap. Fixed interference (fixed constraints &amp; clobbers) has an infinite spill weight.</li>\n<li>Once interference has been collected, try to grow a region starting from the best use to include gaps to the left and right of it. Stop if including a gap would cause the spill weight of the region to go below the spill weight that needs to be evicted. Region growth prefers higher-frequency gaps over lower-frequency ones to prefer covering an entire loop.</li>\n</ul>\n</li>\n<li>Once a split region has been computed for each physical registers, the best region is selected using a heuristic which prefers larger regions. The selected region is split off while the remaining parts to the left and right are also split off into their own vreg.</li>\n</ul>\n<p>Benchmark results show a promising performance improvement, although compilation speed suffers a lot. This is mainly because I haven't focused on optimizing the code yet, in particular the part that collects interference. I believe the compilation speed can be significantly improves to be in line with the current performance of regalloc2.</p>\n<h3>Benchmark results</h3>\n<p>These benchmarks were run using the <code>split</code> branch on <a href=\"https://github.com/Amanieu/regalloc3\">https://github.com/Amanieu/regalloc3</a>, using the regalloc2-to-regalloc3 adapter from the <code>regalloc3</code> branch of <a href=\"https://github.com/Amanieu/regalloc2\">https://github.com/Amanieu/regalloc2</a>.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">compilation</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">cycles</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">105151020</span><span class=\"w\"> </span><span class=\"mf\">112663113.33</span><span class=\"w\"> </span><span class=\"mi\">142774958</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">58353818</span><span class=\"w\"> </span><span class=\"mf\">65341754.47</span><span class=\"w\"> </span><span class=\"mi\">105462298</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">spill</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">98641846</span><span class=\"w\"> </span><span class=\"mf\">112952493.80</span><span class=\"w\"> </span><span class=\"mi\">157907792</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">split</span><span class=\"o\">-</span><span class=\"n\">new5</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"n\">execution</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">cycles</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">87786800</span><span class=\"w\"> </span><span class=\"mf\">88337229.47</span><span class=\"w\"> </span><span class=\"mi\">94848250</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">86056240</span><span class=\"w\"> </span><span class=\"mf\">87312036.27</span><span class=\"w\"> </span><span class=\"mi\">93641650</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">spill</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">82282446</span><span class=\"w\"> </span><span class=\"mf\">82995957.27</span><span class=\"w\"> </span><span class=\"mi\">89504782</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">split</span><span class=\"o\">-</span><span class=\"n\">new5</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"n\">compilation</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">cycles</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">89363986</span><span class=\"w\"> </span><span class=\"mf\">108134334.47</span><span class=\"w\"> </span><span class=\"mi\">136772140</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">75750146</span><span class=\"w\"> </span><span class=\"mf\">93458888.47</span><span class=\"w\"> </span><span class=\"mi\">111040262</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">spill</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">139417192</span><span class=\"w\"> </span><span class=\"mf\">165489712.73</span><span class=\"w\"> </span><span class=\"mi\">209262902</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">split</span><span class=\"o\">-</span><span class=\"n\">new5</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"n\">execution</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">cycles</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">6561456</span><span class=\"w\"> </span><span class=\"mf\">6676379.93</span><span class=\"w\"> </span><span class=\"mi\">6795542</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">6519470</span><span class=\"w\"> </span><span class=\"mf\">6589951.00</span><span class=\"w\"> </span><span class=\"mi\">6883314</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">spill</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">6302414</span><span class=\"w\"> </span><span class=\"mf\">6376103.27</span><span class=\"w\"> </span><span class=\"mi\">6464282</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">split</span><span class=\"o\">-</span><span class=\"n\">new5</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"n\">compilation</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">cycles</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">556633590</span><span class=\"w\"> </span><span class=\"mf\">595953455.53</span><span class=\"w\"> </span><span class=\"mi\">678524764</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">493291612</span><span class=\"w\"> </span><span class=\"mf\">550306873.73</span><span class=\"w\"> </span><span class=\"mi\">691952498</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">spill</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">823929652</span><span class=\"w\"> </span><span class=\"mf\">879684180.93</span><span class=\"w\"> </span><span class=\"mi\">1008727294</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">split</span><span class=\"o\">-</span><span class=\"n\">new5</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"n\">execution</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">cycles</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">781633522</span><span class=\"w\"> </span><span class=\"mf\">785413154.47</span><span class=\"w\"> </span><span class=\"mi\">795564016</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">785475380</span><span class=\"w\"> </span><span class=\"mf\">788557095.93</span><span class=\"w\"> </span><span class=\"mi\">799293270</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">spill</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">765625126</span><span class=\"w\"> </span><span class=\"mf\">767272451.73</span><span class=\"w\"> </span><span class=\"mi\">773143238</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ra3</span><span class=\"o\">-</span><span class=\"n\">split</span><span class=\"o\">-</span><span class=\"n\">new5</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/Amanieu/regalloc3\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/e168a6e5ae9517216909e6b7ce43212c107641f0/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383437643631306665373835306537303562663662323964303665383937363633653264616339366234393530393263333462633464363838363230386334312f416d616e6965752f726567616c6c6f6333&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/Amanieu/regalloc3\" title=\"GitHub - Amanieu/regalloc3: New register allocator designed as a successor to regalloc2\">GitHub - Amanieu/regalloc3: New register allocator designed as a successor to regalloc2</a></div><div class=\"message_embed_description\">New register allocator designed as a successor to regalloc2 - Amanieu/regalloc3</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/Amanieu/regalloc2\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/731f3a692c5657c2a3be729db8e80fb10586b856/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383266663262626132386334363032356433343464663636663737663132326330396333343331626535613261363836626263333261363138326137663664342f416d616e6965752f726567616c6c6f6332&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/Amanieu/regalloc2\" title=\"GitHub - Amanieu/regalloc2: A new register allocator\">GitHub - Amanieu/regalloc2: A new register allocator</a></div><div class=\"message_embed_description\">A new register allocator. Contribute to Amanieu/regalloc2 development by creating an account on GitHub.</div></div></div>",
        "id": 491635900,
        "sender_full_name": "Amanieu",
        "timestamp": 1735836350
    },
    {
        "content": "<p>Also I think now would be a good time to discuss how the Cranelift team wants to move forward with this. The first step would probably be to add it via the regalloc2 wrapper as a 3rd algorithm (in addition to the existing <code>ion</code> and <code>fastalloc</code>). Maybe this could be discussed during the cranelift meeting next week?</p>",
        "id": 491642477,
        "sender_full_name": "Amanieu",
        "timestamp": 1735839264
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"301625\">@Amanieu</span> -- I gave my thoughts on this last month in <a href=\"#narrow/channel/217117-cranelift/topic/Could.20regalloc3.20eliminate.20those.20spills.3F/near/486593041\">this message</a>. Technically I'd like to see the blockparams-on-single-pred-blocks issue resolved; we don't want to have to have a rewrite pass even in no-opt builds in Cranelift.</p>\n<p>I think the social side is a much bigger concern: right now we have general familiarity with RA2 and every line has been code-reviewed; BA standards would require us to code-review all of RA3 and we'd want to make sure that folks on our team are familiar with the codebase before switching to it. We also have standards around ensuring key bits are owned/published by team permissions rather than individuals -- we don't want a bus factor of one when we need to push security fixes, for example -- which practically speaking would probably mean maybe trying to adopt RA3 as a BA project. Basically, outsourcing regalloc to a \"third-party crate\" (that third party is you, hi, at least we know you!) is a risk factor w.r.t. flexibility during security incidents, and flexibility with our own requirements, that we'd want to address somehow.</p>",
        "id": 491644584,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1735840281
    },
    {
        "content": "<p>Happy to discuss further in the CL meeting of course -- please feel free to add an agenda item</p>",
        "id": 491644641,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1735840311
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254389\">@Chris Fallin</span> The rewrite is <em>very</em> straightforward, as you can see from how it is implemented in the regalloc wrapper <a href=\"https://github.com/Amanieu/regalloc2/blob/e7f429c52f6eb787146037b05a99c69f7d3d6339/src/regalloc3.rs#L489\">here</a>. I don't think this will cost much in compilation time and it significantly simplifies the implementation of the register allocator.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/Amanieu/regalloc2/blob/e7f429c52f6eb787146037b05a99c69f7d3d6339/src/regalloc3.rs#L489\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/731f3a692c5657c2a3be729db8e80fb10586b856/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383266663262626132386334363032356433343464663636663737663132326330396333343331626535613261363836626263333261363138326137663664342f416d616e6965752f726567616c6c6f6332&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/Amanieu/regalloc2/blob/e7f429c52f6eb787146037b05a99c69f7d3d6339/src/regalloc3.rs#L489\" title=\"regalloc2/src/regalloc3.rs at e7f429c52f6eb787146037b05a99c69f7d3d6339 · Amanieu/regalloc2\">regalloc2/src/regalloc3.rs at e7f429c52f6eb787146037b05a99c69f7d3d6339 · Amanieu/regalloc2</a></div><div class=\"message_embed_description\">A new register allocator. Contribute to Amanieu/regalloc2 development by creating an account on GitHub.</div></div></div>",
        "id": 491682237,
        "sender_full_name": "Amanieu",
        "timestamp": 1735862082
    },
    {
        "content": "<p>Fair enough, perhaps we can do the remapping as part of our lowering pass (which runs regardless of optimizations). A PR that adds this invariant to CL's VCode blockparams would be welcome</p>",
        "id": 491684838,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1735863785
    }
]