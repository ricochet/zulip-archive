[
    {
        "content": "<p>I made a few c bindings around the cranelift and cranelift-codegen crate, and linked them with a zig project. Here are my findings.</p>\n<p>This is crate is <code>cranelift</code></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">-</span><span class=\"n\">rw</span><span class=\"o\">-</span><span class=\"n\">rw</span><span class=\"o\">-</span><span class=\"n\">r</span><span class=\"o\">--</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">christopher</span><span class=\"w\"> </span><span class=\"n\">christopher</span><span class=\"w\"> </span><span class=\"mi\">29038</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">May</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"w\"> </span><span class=\"mi\">13</span>:<span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"n\">libcraneliftc</span><span class=\"p\">.</span><span class=\"n\">a</span>\n</code></pre></div>\n<p>It's total size is 29M,</p>\n<p>I built this without the panic handler, as I couldn't figure out what I needed to link for <code>_Unwind_Resume</code> or whatever it was, I didn't write it down in my notes.</p>\n<p>Cargo.toml</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[package]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"cranelift-export\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"0.1.0\"</span>\n<span class=\"n\">edition</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"2021\"</span>\n\n<span class=\"k\">[profile.release]</span>\n<span class=\"n\">panic</span><span class=\"o\">=</span><span class=\"s\">\"abort\"</span>\n\n<span class=\"k\">[profile.dev]</span>\n<span class=\"n\">panic</span><span class=\"o\">=</span><span class=\"s\">\"abort\"</span>\n\n<span class=\"k\">[lib]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"craneliftc\"</span>\n<span class=\"n\">crate-type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"staticlib\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"cdylib\"</span><span class=\"p\">]</span>\n\n<span class=\"k\">[dependencies]</span>\n<span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"0.96.1\"</span>\n</code></pre></div>\n<p>This allowed me to link the rust std library with my application.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">-</span><span class=\"n\">rw</span><span class=\"o\">-</span><span class=\"n\">r</span><span class=\"o\">--</span><span class=\"n\">r</span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">christopher</span><span class=\"w\"> </span><span class=\"n\">christopher</span><span class=\"w\">  </span><span class=\"mi\">10</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">May</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"mi\">13</span>:<span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"n\">libstd</span><span class=\"o\">-</span><span class=\"mi\">89</span><span class=\"n\">bc084783fdc439</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>So the resulting size is 39M with cranelift and the rust std library.</p>\n<p>The size ended up being larger for cranelift-codegen! <code>28762K</code> to be exact. I really can't explain that, unless there is some treeshaking in cranelift, whereas there could be none in cranelift-codegen.</p>\n<p>I haven't decided if I'm going to use the better interface for cranelift or go all out on cranelift-codegen. I recently saw a conversation on github, and here about no_std. And I am early enough in my project, that I'm not worried about it. but having no_std in codegen could be a huge win from saving 10M and not having to distribute rusts horribly named std lib.</p>",
        "id": 360620322,
        "sender_full_name": "Chris Clark",
        "timestamp": 1684869380
    },
    {
        "content": "<p>Are you linking with <code>--gc-sections</code> when linking against <code>libcraneliftc.a</code>? That will prevent unused functions (like most of the standard library) from ending up in the linked artifacy.</p>",
        "id": 360624395,
        "sender_full_name": "bjorn3",
        "timestamp": 1684870694
    },
    {
        "content": "<p>By the way if you pass <code>--print native-staticlibs</code> when compiling the staticlib, rustc will tell you all the linker flags necessary for successfully linking. This does not include <code>--gc-sections</code> however as it is not strictly necessary. Just recommended.</p>",
        "id": 360624658,
        "sender_full_name": "bjorn3",
        "timestamp": 1684870789
    },
    {
        "content": "<p>You don't need to ship <a href=\"http://libstd.so\">libstd.so</a> when compiling as either staticlib or cdylib. Rustc will link it into the compiled staticlib or cdylib automatically.</p>",
        "id": 360624945,
        "sender_full_name": "bjorn3",
        "timestamp": 1684870878
    },
    {
        "content": "<p>Note that the cdylib is linked by rustc with <code>--gc-sections</code> by default, but for staticlibs rustc doesn't have control over the linker invocation.</p>",
        "id": 360625232,
        "sender_full_name": "bjorn3",
        "timestamp": 1684870971
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/217117-cranelift/topic/Initial.20Findings/near/360624945\">said</a>:</p>\n<blockquote>\n<p>You don't need to ship <a href=\"http://libstd.so\">libstd.so</a> when compiling as either staticlib or cdylib. Rustc will link it into the compiled staticlib or cdylib automatically.</p>\n</blockquote>\n<p>Hmm, my linker complains. At least a 100 or so of these.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">ld</span><span class=\"p\">.</span><span class=\"n\">lld</span>: <span class=\"nc\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span>: <span class=\"nc\">_Unwind_SetGR</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>: <span class=\"nc\">referenced</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">gcc</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">208</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">personality</span><span class=\"o\">/</span><span class=\"n\">gcc</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">208</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>:               <span class=\"nc\">std</span><span class=\"o\">-</span><span class=\"mi\">89</span><span class=\"n\">bc084783fdc439</span><span class=\"p\">.</span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"mi\">5</span><span class=\"n\">f6d52e5</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>:<span class=\"p\">(</span><span class=\"n\">rust_eh_personality</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">christopher</span><span class=\"o\">/</span><span class=\"n\">source</span><span class=\"o\">/</span><span class=\"k\">type</span><span class=\"o\">-</span><span class=\"n\">lang</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">libcraneliftc</span><span class=\"p\">.</span><span class=\"n\">a</span>\n<span class=\"n\">error</span>: <span class=\"nc\">ld</span><span class=\"p\">.</span><span class=\"n\">lld</span>: <span class=\"nc\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span>: <span class=\"nc\">_Unwind_SetIP</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>: <span class=\"nc\">referenced</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">gcc</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">214</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">personality</span><span class=\"o\">/</span><span class=\"n\">gcc</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">214</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>:               <span class=\"nc\">std</span><span class=\"o\">-</span><span class=\"mi\">89</span><span class=\"n\">bc084783fdc439</span><span class=\"p\">.</span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"mi\">5</span><span class=\"n\">f6d52e5</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>:<span class=\"p\">(</span><span class=\"n\">rust_eh_personality</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">christopher</span><span class=\"o\">/</span><span class=\"n\">source</span><span class=\"o\">/</span><span class=\"k\">type</span><span class=\"o\">-</span><span class=\"n\">lang</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">libcraneliftc</span><span class=\"p\">.</span><span class=\"n\">a</span>\n<span class=\"n\">error</span>: <span class=\"nc\">ld</span><span class=\"p\">.</span><span class=\"n\">lld</span>: <span class=\"nc\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span>: <span class=\"nc\">fstat64</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>: <span class=\"nc\">referenced</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">fs</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1055</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">sys</span><span class=\"o\">/</span><span class=\"n\">unix</span><span class=\"o\">/</span><span class=\"n\">fs</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1055</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>:               <span class=\"nc\">std</span><span class=\"o\">-</span><span class=\"mi\">89</span><span class=\"n\">bc084783fdc439</span><span class=\"p\">.</span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"mi\">5</span><span class=\"n\">f6d52e5</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>:<span class=\"p\">(</span><span class=\"n\">std</span>::<span class=\"n\">backtrace_rs</span>::<span class=\"n\">symbolize</span>::<span class=\"n\">gimli</span>::<span class=\"n\">mmap</span>::<span class=\"n\">h1f7010bebead819b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">christopher</span><span class=\"o\">/</span><span class=\"n\">source</span><span class=\"o\">/</span><span class=\"k\">type</span><span class=\"o\">-</span><span class=\"n\">lang</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">libcraneliftc</span><span class=\"p\">.</span><span class=\"n\">a</span>\n<span class=\"n\">error</span>: <span class=\"nc\">ld</span><span class=\"p\">.</span><span class=\"n\">lld</span>: <span class=\"nc\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span>: <span class=\"nc\">mmap</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>: <span class=\"nc\">referenced</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">mmap_unix</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/../../</span><span class=\"n\">backtrace</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">symbolize</span><span class=\"o\">/</span><span class=\"n\">gimli</span><span class=\"o\">/</span><span class=\"n\">mmap_unix</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">14</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>:               <span class=\"nc\">std</span><span class=\"o\">-</span><span class=\"mi\">89</span><span class=\"n\">bc084783fdc439</span><span class=\"p\">.</span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"mi\">5</span><span class=\"n\">f6d52e5</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>:<span class=\"p\">(</span><span class=\"n\">std</span>::<span class=\"n\">backtrace_rs</span>::<span class=\"n\">symbolize</span>::<span class=\"n\">gimli</span>::<span class=\"n\">mmap</span>::<span class=\"n\">h1f7010bebead819b</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">christopher</span><span class=\"o\">/</span><span class=\"n\">source</span><span class=\"o\">/</span><span class=\"k\">type</span><span class=\"o\">-</span><span class=\"n\">lang</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">libcraneliftc</span><span class=\"p\">.</span><span class=\"n\">a</span>\n<span class=\"n\">error</span>: <span class=\"nc\">ld</span><span class=\"p\">.</span><span class=\"n\">lld</span>: <span class=\"nc\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span>: <span class=\"nc\">dl_iterate_phdr</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>: <span class=\"nc\">referenced</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">libs_dl_iterate_phdr</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/../../</span><span class=\"n\">backtrace</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">symbolize</span><span class=\"o\">/</span><span class=\"n\">gimli</span><span class=\"o\">/</span><span class=\"n\">libs_dl_iterate_phdr</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">15</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">note</span>:               <span class=\"nc\">std</span><span class=\"o\">-</span><span class=\"mi\">89</span><span class=\"n\">bc084783fdc439</span><span class=\"p\">.</span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"mi\">5</span><span class=\"n\">f6d52e5</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>:<span class=\"p\">(</span><span class=\"n\">std</span>::<span class=\"n\">backtrace_rs</span>::<span class=\"n\">symbolize</span>::<span class=\"n\">gimli</span>::<span class=\"n\">resolve</span>::<span class=\"n\">haecb1fefe4a8bc82</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">christopher</span><span class=\"o\">/</span><span class=\"n\">source</span><span class=\"o\">/</span><span class=\"k\">type</span><span class=\"o\">-</span><span class=\"n\">lang</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">libcraneliftc</span><span class=\"p\">.</span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 360631970,
        "sender_full_name": "Chris Clark",
        "timestamp": 1684873397
    },
    {
        "content": "<p>You are likely missing <code>-lunwind</code> as linker argument. If you compile with <code>--print native-static-libs</code> you get the full list of libraries necessary.</p>",
        "id": 360636364,
        "sender_full_name": "bjorn3",
        "timestamp": 1684875052
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/217117-cranelift/topic/Initial.20Findings/near/360636364\">said</a>:</p>\n<blockquote>\n<p>You are likely missing <code>-lunwind</code> as linker argument. If you compile with <code>--print native-static-libs</code> you get the full list of libraries necessary.</p>\n</blockquote>\n<p>cargo with --print native-static-libs produced unexpected argument --print found.<br>\nWeird, I thought it was std because of this line</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">note</span>:               <span class=\"nc\">std</span><span class=\"o\">-</span><span class=\"mi\">89</span><span class=\"n\">bc084783fdc439</span><span class=\"p\">.</span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"mi\">5</span><span class=\"n\">f6d52e5</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>\n</code></pre></div>\n<p>and <code>libstd-89bc084783fdc439.so</code> is the version I had in my rust location.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">        </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">full_path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">.</span><span class=\"n\">fmt</span><span class=\"p\">(</span><span class=\"s\">\"{s}/lib/libstd-89bc084783fdc439.so\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">.{</span><span class=\"n\">path_unpadded</span><span class=\"p\">});</span>\n<span class=\"w\">        </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">full_path</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"c1\">//s_lib.addObjectFile(full_path);</span>\n</code></pre></div>\n<p>however your suggestion appears to have worked. I wouldn't consider linking with unwind unreasonable. So that's perfect.</p>",
        "id": 360650010,
        "sender_full_name": "Chris Clark",
        "timestamp": 1684881102
    },
    {
        "content": "<p><code>--print native-static-libs</code> is a rustc argument, so you either have to put it in <code>RUSTFLAGS</code> (which triggers a rebuild) or use <code>cargo rustc -- --print native-static-libs</code>.</p>\n<p>The linker error comes from the version of libstd bundled into the staticlib. I can understand the confusion though.</p>",
        "id": 360706819,
        "sender_full_name": "bjorn3",
        "timestamp": 1684912197
    },
    {
        "content": "<p>Alright, after some more research, trial and error. I am going the redhat approach <a href=\"https://developers.redhat.com/articles/2022/09/05/how-create-c-binding-rust-library#output_pointer_for_a_string\">here</a>.</p>\n<p>I will make macros like below for exposing pretty much every part of cranelift I need.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"fm\">macro_rules!</span><span class=\"w\"> </span><span class=\"n\">dispose</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"cp\">$namespace</span>:<span class=\"nc\">ident</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">paste</span>::<span class=\"n\">paste</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"cp\">#[no_mangle]</span>\n<span class=\"w\">            </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"p\">[</span><span class=\"o\">&lt;</span><span class=\"n\">CL_</span><span class=\"w\"> </span><span class=\"cp\">$namespace</span><span class=\"w\"> </span><span class=\"n\">_dispose</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"p\">](</span><span class=\"n\">val</span>: <span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"cp\">$namespace</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"p\">])</span><span class=\"w\"> </span>-&gt; <span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                    </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"nb\">Box</span>::<span class=\"n\">from_raw</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">));</span>\n<span class=\"w\">                </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I know this question has came up a few times. Is this something you guys are interested in as a crate? Right now, I just have it in my project, but could probably republish these bindings.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://developers.redhat.com/articles/2022/09/05/how-create-c-binding-rust-library#output_pointer_for_a_string\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/81b03d456227b8172d5cbc6bc87e6345d9dd59d2\\/68747470733a2f2f646576656c6f706572732e7265646861742e636f6d2f73697465732f64656661756c742f66696c65732f7374796c65732f73686172652f7075626c69632f626c6f672f323032312f30342f486f775f527573745f6d616b65735f5261796f6e5f6d61676963616c2d30312e706e673f69746f6b3d3846496d5a444d61)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://developers.redhat.com/articles/2022/09/05/how-create-c-binding-rust-library#output_pointer_for_a_string\" title=\"How to create C binding for a Rust library | Red Hat Developer\">How to create C binding for a Rust library | Red Hat Developer</a></div><div class=\"message_embed_description\">Learn techniques to create a binding to make a library written in Rust accessible to C programmers. (Part 2 of 4)</div></div></div>",
        "id": 361354934,
        "sender_full_name": "Chris Clark",
        "timestamp": 1685113201
    },
    {
        "content": "<p>See also <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1164\">https://github.com/bytecodealliance/wasmtime/issues/1164</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/1164\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/b0e4968e8da7bb9a60a7eab7ffca039d0ca782f7\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383037326239343533343131333662363162633964663133383166313563336666376338333466376639363136646430393031386565393134366462663862622f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f31313634)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/1164\" title=\"Cranelift: provide a C API · Issue #1164 · bytecodealliance/wasmtime\">Cranelift: provide a C API · Issue #1164 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">What I'd like to see is a way to use Cranelift apis from another (non rust) language. Currently the cranelift apis are rust only, but having a layer on top of that like \"llvm-c\" is, would make the ...</div></div></div>",
        "id": 361373752,
        "sender_full_name": "bjorn3",
        "timestamp": 1685117141
    },
    {
        "content": "<p>By the way I think I would personally prefer <code>cranelift_</code> or maybe <code>clif_</code> as prefix rather than <code>CL_</code>, but others may have a different opinion.</p>",
        "id": 361374071,
        "sender_full_name": "bjorn3",
        "timestamp": 1685117209
    },
    {
        "content": "<p>Ideally the C bindings for the <code>InstBuilder</code> would be automatically generated from the instruction definitions in cranelift-codegen-meta.</p>",
        "id": 361374407,
        "sender_full_name": "bjorn3",
        "timestamp": 1685117283
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/217117-cranelift/topic/Initial.20Findings/near/361373752\">said</a>:</p>\n<blockquote>\n<p>See also <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1164\">https://github.com/bytecodealliance/wasmtime/issues/1164</a></p>\n</blockquote>\n<p>yes, you must reexport all functionality in an extern \"C\" wrapper, if you wanted to return the data directly, you must repr(C) a wrapper struct, and then take care of the translation. Doing this seemed tedious, and also very difficult in some scenarios,  like if the members had enums with values in their variants. So it is a shorter put to do the pointer style, and I would also use cbindgen</p>",
        "id": 361377530,
        "sender_full_name": "Chris Clark",
        "timestamp": 1685117998
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/217117-cranelift/topic/Initial.20Findings/near/361374407\">said</a>:</p>\n<blockquote>\n<p>Ideally the C bindings for the <code>InstBuilder</code> would be automatically generated from the instruction definitions in cranelift-codegen-meta.</p>\n</blockquote>\n<p>I haven't gotten to this part yet, can you explain what you mean? are they already exported for C API?</p>",
        "id": 361377793,
        "sender_full_name": "Chris Clark",
        "timestamp": 1685118045
    },
    {
        "content": "<p>oh wow, i just saw the link to the gist. they did all that work by hand!</p>",
        "id": 361378803,
        "sender_full_name": "Chris Clark",
        "timestamp": 1685118245
    },
    {
        "content": "<p>cranelift-codegen-meta has a list of all instructions using which the <code>InstBuilder</code> trait is automatically generated among ither things. Ideally the C bindings for these methods would be generated from the same list of instructions rather than written by hand.</p>",
        "id": 361409620,
        "sender_full_name": "bjorn3",
        "timestamp": 1685125822
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/217117-cranelift/topic/Initial.20Findings/near/361409620\">said</a>:</p>\n<blockquote>\n<p>cranelift-codegen-meta has a list of all instructions using which the <code>InstBuilder</code> trait is automatically generated among ither things. Ideally the C bindings for these methods would be generated from the same list of instructions rather than written by hand.</p>\n</blockquote>\n<p>I copied their code, and found about 200 errors on the <code>.ins()</code>method on the <code>FunctionBuilder</code>. I am guessing things like <code>x86_pminu(val, val)</code> are not supported. So I think what you are saying is the InstBuilder (and many other things) are generated dynamically. so functions like this wrapper.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[no_mangle]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">cranelift_x86_macho_tls_get_addr</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">ptr</span>: <span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">FunctionData</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">gv</span>: <span class=\"nc\">GlobalValueCode</span><span class=\"p\">,</span>\n<span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">ValueCode</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">assert!</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">ptr</span><span class=\"p\">.</span><span class=\"n\">is_null</span><span class=\"p\">());</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">inst</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">builder</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">ins</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">x86_macho_tls_get_addr</span><span class=\"p\">(</span><span class=\"n\">GlobalValue</span>::<span class=\"n\">from_u32</span><span class=\"p\">(</span><span class=\"n\">gv</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">as_u32</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>the <code>x86_macho_tls_get_addr</code> function and the other 200+ are being generated?</p>\n<p>I think the API they have made which works on this <code>FunctionData</code> struct is fine for now. and would definitely agree that those should be hoisted, and worked on directly from the <code>InstBuilder</code> since it is very dynamic in nature.</p>\n<p>What is the purpose of this instbuilder losing these 200+ functions, is it safe for me to delete them from this gist, or are there replacements somewhere?</p>",
        "id": 361415431,
        "sender_full_name": "Chris Clark",
        "timestamp": 1685127526
    },
    {
        "content": "<p>Since that gist was created there have been a decent amount of changes in which instructions exist. Hence why I did prefer if the bindings are autogenerated from the canonical list of instructions.</p>",
        "id": 361422067,
        "sender_full_name": "bjorn3",
        "timestamp": 1685129518
    },
    {
        "content": "<blockquote>\n<p>So I think what you are saying is the InstBuilder (and many other things) are generated dynamically.</p>\n</blockquote>\n<p>Exactly!</p>\n<blockquote>\n<p>so functions like this wrapper. [...] the <code>x86_macho_tls_get_addr</code> function and the other 200+ are being generated?</p>\n</blockquote>\n<p>I don't think those were autogenerated in the gist, but I would like them to be.</p>",
        "id": 361422572,
        "sender_full_name": "bjorn3",
        "timestamp": 1685129650
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"619350\">Chris Clark</span> <a href=\"#narrow/stream/217117-cranelift/topic/Initial.20Findings/near/361415431\">said</a>:</p>\n<blockquote>\n<p>What is the purpose of this instbuilder losing these 200+ functions, is it safe for me to delete them from this gist, or are there replacements somewhere?</p>\n</blockquote>\n<p>Those were probably only used by the old x86 backend which has since been deleted. It is fine to delete the bindings from the gist.</p>",
        "id": 361422793,
        "sender_full_name": "bjorn3",
        "timestamp": 1685129712
    },
    {
        "content": "<p>I was able to pull in the meta crate, make a little binary that just calls generate, and generate the <code>.isle</code>files. What do they do? The comments inside those files didn't help.</p>\n<p>And then, I can see everything else in <code>out</code> which made the inst_builder, settings, types, etc.</p>\n<p>Are you suggesting I modify meta to have a \"generate c api\" function which makese those C compatible?</p>",
        "id": 361424202,
        "sender_full_name": "Chris Clark",
        "timestamp": 1685130152
    },
    {
        "content": "<p>ISLE is a pattern matching DSL. It is used for optimizations and for lowering cranelift instructions to machine instructions. It isn't relecant for generating C bindings.</p>",
        "id": 361428943,
        "sender_full_name": "bjorn3",
        "timestamp": 1685131695
    },
    {
        "content": "<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/41417d9e0feff2aa3ae0ca66a7b8777bfaa88dc2/cranelift/codegen/meta/src/gen_inst.rs#L1014\">https://github.com/bytecodealliance/wasmtime/blob/41417d9e0feff2aa3ae0ca66a7b8777bfaa88dc2/cranelift/codegen/meta/src/gen_inst.rs#L1014</a> is the function generating the <code>InstBuilder</code> trait.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/41417d9e0feff2aa3ae0ca66a7b8777bfaa88dc2/cranelift/codegen/meta/src/gen_inst.rs#L1014\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/737ac69fea81604cd977bbcaba777cddba23652d\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653338303336643236303065643735646632633137616663396337393035383162316538333335636431656233306132626563323532666239633031346234362f62797465636f6465616c6c69616e63652f7761736d74696d65)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/41417d9e0feff2aa3ae0ca66a7b8777bfaa88dc2/cranelift/codegen/meta/src/gen_inst.rs#L1014\" title=\"wasmtime/gen_inst.rs at 41417d9e0feff2aa3ae0ca66a7b8777bfaa88dc2 · bytecodealliance/wasmtime\">wasmtime/gen_inst.rs at 41417d9e0feff2aa3ae0ca66a7b8777bfaa88dc2 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>",
        "id": 361429165,
        "sender_full_name": "bjorn3",
        "timestamp": 1685131796
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264278\">bjorn3</span> <a href=\"#narrow/stream/217117-cranelift/topic/Initial.20Findings/near/361429165\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/41417d9e0feff2aa3ae0ca66a7b8777bfaa88dc2/cranelift/codegen/meta/src/gen_inst.rs#L1014\">https://github.com/bytecodealliance/wasmtime/blob/41417d9e0feff2aa3ae0ca66a7b8777bfaa88dc2/cranelift/codegen/meta/src/gen_inst.rs#L1014</a> is the function generating the <code>InstBuilder</code> trait.</p>\n</blockquote>\n<p>Can we outline the requirements for an acceptable PR?</p>",
        "id": 361430814,
        "sender_full_name": "Chris Clark",
        "timestamp": 1685132371
    },
    {
        "content": "<p>You will have to ask that to one of the maintainers. I'm merely a contributor, so I can't approve the PR.</p>",
        "id": 361440993,
        "sender_full_name": "bjorn3",
        "timestamp": 1685136175
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"254389\">@Chris Fallin</span> <span class=\"user-mention\" data-user-id=\"504918\">@Jamey Sharp</span>  are you maintainers?</p>",
        "id": 361665827,
        "sender_full_name": "Chris Clark",
        "timestamp": 1685236183
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"619350\">@Chris Clark</span> it's best if you create an issue on the GitHub repo to discuss rather than tag individual people here (also mindful of the weekend you may not get immediate replies) -- it's hard for me to tell exactly what the need at hand is, so outlining the issue and the proposed solution with as much context as reasonable would be a good start, then we can go from there</p>",
        "id": 361671853,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1685241235
    },
    {
        "content": "<p>The advice that bjorn3 has already given is all a good start, but yeah, we should discuss this further in an issue if you want the result to be something we can merge. We're interested in doing things that make Cranelift usable in more projects! On the other hand, maintaining a C API is a pain, so we want to be a little careful about it.</p>",
        "id": 362238661,
        "sender_full_name": "Jamey Sharp",
        "timestamp": 1685464410
    }
]