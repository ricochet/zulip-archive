[
    {
        "content": "<p>I'm trying to use Cranelift to call <code>malloc</code>, with the following IR:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">0</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i64</span> <span class=\"nc\">system_v</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i64</span> <span class=\"nc\">system_v</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">sig1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i64</span> <span class=\"nc\">system_v</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">sig0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">fn1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig1</span><span class=\"w\"></span>\n\n<span class=\"n\">block0</span>:\n    <span class=\"nc\">v0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">imul</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn1</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v5</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>fn0 is (should be?) <code>malloc</code> and fn1 is (should be?) <code>free</code>.</p>\n<p>This compiles fine on x86_64 MacOS, however, when I emit an object file (using <code>cranelift-module</code>), link with <code>cc</code> and run it, I obtain the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">dyld</span>: <span class=\"nc\">BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">writable</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">/&lt;</span><span class=\"n\">redacted</span><span class=\"o\">&gt;/</span><span class=\"n\">examples</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">a</span><span class=\"p\">.</span><span class=\"n\">out</span><span class=\"w\"></span>\n<span class=\"n\">zsh</span>: <span class=\"nc\">abort</span><span class=\"w\">      </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">a</span><span class=\"p\">.</span><span class=\"n\">out</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I'm not sure if I'm doing something wrong (most likely) or this is a bug in Cranelift – any help would be much appreciated.</p>",
        "id": 266202238,
        "sender_full_name": "Teymour Aldridge",
        "timestamp": 1640636698
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"330139\">@Teymour Aldridge</span>  Can you run <code>otool -hltdr ./a.out</code>?</p>",
        "id": 266203305,
        "sender_full_name": "bjorn3",
        "timestamp": 1640637716
    },
    {
        "content": "<p>Yes:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">a</span><span class=\"p\">.</span><span class=\"n\">out</span>:\n<span class=\"nc\">Mach</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">magic</span><span class=\"w\">  </span><span class=\"n\">cputype</span><span class=\"w\"> </span><span class=\"n\">cpusubtype</span><span class=\"w\">  </span><span class=\"n\">caps</span><span class=\"w\">    </span><span class=\"n\">filetype</span><span class=\"w\"> </span><span class=\"n\">ncmds</span><span class=\"w\"> </span><span class=\"n\">sizeofcmds</span><span class=\"w\">      </span><span class=\"n\">flags</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mh\">0xfeedfacf</span><span class=\"w\"> </span><span class=\"mi\">16777223</span><span class=\"w\">          </span><span class=\"mi\">3</span><span class=\"w\">  </span><span class=\"mh\">0x00</span><span class=\"w\">           </span><span class=\"mi\">2</span><span class=\"w\">    </span><span class=\"mi\">14</span><span class=\"w\">        </span><span class=\"mi\">744</span><span class=\"w\"> </span><span class=\"mh\">0x00000085</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_SEGMENT_64</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">segname</span><span class=\"w\"> </span><span class=\"n\">__PAGEZERO</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">vmaddr</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000000</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">vmsize</span><span class=\"w\"> </span><span class=\"mh\">0x0000000100000000</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">fileoff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">filesize</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">maxprot</span><span class=\"w\"> </span><span class=\"mh\">0x00000000</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">initprot</span><span class=\"w\"> </span><span class=\"mh\">0x00000000</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">nsects</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_SEGMENT_64</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">232</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">segname</span><span class=\"w\"> </span><span class=\"n\">__TEXT</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">vmaddr</span><span class=\"w\"> </span><span class=\"mh\">0x0000000100000000</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">vmsize</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000004000</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">fileoff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">filesize</span><span class=\"w\"> </span><span class=\"mi\">16384</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">maxprot</span><span class=\"w\"> </span><span class=\"mh\">0x00000005</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">initprot</span><span class=\"w\"> </span><span class=\"mh\">0x00000005</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">nsects</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"></span>\n<span class=\"n\">Section</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sectname</span><span class=\"w\"> </span><span class=\"n\">__text</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">segname</span><span class=\"w\"> </span><span class=\"n\">__TEXT</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"mh\">0x0000000100003f88</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000030</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mi\">16264</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">align</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">^</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">reloff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">nreloc</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"mh\">0x80000600</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">reserved1</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">reserved2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">Section</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sectname</span><span class=\"w\"> </span><span class=\"n\">__unwind_info</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">segname</span><span class=\"w\"> </span><span class=\"n\">__TEXT</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"mh\">0x0000000100003fb8</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000048</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mi\">16312</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">align</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">reloff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">nreloc</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"mh\">0x00000000</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">reserved1</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">reserved2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_SEGMENT_64</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">segname</span><span class=\"w\"> </span><span class=\"n\">__LINKEDIT</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">vmaddr</span><span class=\"w\"> </span><span class=\"mh\">0x0000000100004000</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">vmsize</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000004000</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">fileoff</span><span class=\"w\"> </span><span class=\"mi\">16384</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">filesize</span><span class=\"w\"> </span><span class=\"mi\">240</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">maxprot</span><span class=\"w\"> </span><span class=\"mh\">0x00000001</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">initprot</span><span class=\"w\"> </span><span class=\"mh\">0x00000001</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">nsects</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_DYLD_INFO_ONLY</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">rebase_off</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">rebase_size</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">       </span><span class=\"n\">bind_off</span><span class=\"w\"> </span><span class=\"mi\">16384</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">bind_size</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">weak_bind_off</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">weak_bind_size</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lazy_bind_off</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">lazy_bind_size</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">export_off</span><span class=\"w\"> </span><span class=\"mi\">16424</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">export_size</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_SYMTAB</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">symoff</span><span class=\"w\"> </span><span class=\"mi\">16480</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">nsyms</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">stroff</span><span class=\"w\"> </span><span class=\"mi\">16560</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">strsize</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_DYSYMTAB</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">ilocalsym</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">nlocalsym</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">iextdefsym</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">nextdefsym</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">iundefsym</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">nundefsym</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"n\">tocoff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"n\">ntoc</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">modtaboff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">nmodtab</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">extrefsymoff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">nextrefsyms</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">indirectsymoff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">nindirectsyms</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">extreloff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">nextrel</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">locreloff</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">nlocrel</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"></span>\n<span class=\"w\">          </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_LOAD_DYLINKER</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">dyld</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_UUID</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">uuid</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"n\">D372077</span><span class=\"o\">-</span><span class=\"mi\">63</span><span class=\"n\">F5</span><span class=\"o\">-</span><span class=\"mi\">3</span><span class=\"n\">F81</span><span class=\"o\">-</span><span class=\"mi\">9</span><span class=\"n\">AEC</span><span class=\"o\">-</span><span class=\"mi\">969682</span><span class=\"n\">BFFD4B</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_BUILD_VERSION</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">platform</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">minos</span><span class=\"w\"> </span><span class=\"mf\">10.15</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">sdk</span><span class=\"w\"> </span><span class=\"mf\">10.15.6</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">ntools</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">tool</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">609.8</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_SOURCE_VERSION</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">0.0</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"></span>\n<span class=\"w\">       </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_MAIN</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">entryoff</span><span class=\"w\"> </span><span class=\"mi\">16264</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">stacksize</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"></span>\n<span class=\"w\">          </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_LOAD_DYLIB</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">libSystem</span><span class=\"p\">.</span><span class=\"n\">B</span><span class=\"p\">.</span><span class=\"n\">dylib</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">stamp</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">Thu</span><span class=\"w\"> </span><span class=\"n\">Jan</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">01</span>:<span class=\"mi\">00</span>:<span class=\"mi\">02</span><span class=\"w\"> </span><span class=\"mi\">1970</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">1281.100.1</span><span class=\"w\"></span>\n<span class=\"n\">compatibility</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">1.0.0</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_FUNCTION_STARTS</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">dataoff</span><span class=\"w\"> </span><span class=\"mi\">16472</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">datasize</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_DATA_IN_CODE</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">dataoff</span><span class=\"w\"> </span><span class=\"mi\">16480</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">datasize</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">__TEXT</span><span class=\"p\">,</span><span class=\"n\">__text</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">section</span><span class=\"w\"></span>\n<span class=\"mi\">0000000100003</span><span class=\"n\">f88</span><span class=\"w\"> </span><span class=\"mi\">55</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\"> </span><span class=\"n\">bf</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"></span>\n<span class=\"mi\">0000000100003</span><span class=\"n\">f98</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">d6</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">c7</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"></span>\n<span class=\"mi\">0000000100003</span><span class=\"n\">fa8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">d6</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">c0</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">c3</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 266203381,
        "sender_full_name": "Teymour Aldridge",
        "timestamp": 1640637772
    },
    {
        "content": "<p>Just to confirm you are on x86_64, right?</p>",
        "id": 266203717,
        "sender_full_name": "bjorn3",
        "timestamp": 1640638183
    },
    {
        "content": "<p>Also can you run the same command on the original object file before linking?</p>",
        "id": 266203809,
        "sender_full_name": "bjorn3",
        "timestamp": 1640638234
    },
    {
        "content": "<p>Does it still error if you omit one or both of the calls?</p>",
        "id": 266203844,
        "sender_full_name": "bjorn3",
        "timestamp": 1640638268
    },
    {
        "content": "<p>I'm on MacOS Catalina, x86_64.</p>\n<p>I don't the see the error if I emit both calls. </p>\n<p>When I run the command on the object file I get this output:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">program</span><span class=\"p\">.</span><span class=\"n\">o</span>:\n<span class=\"nc\">Mach</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">magic</span><span class=\"w\">  </span><span class=\"n\">cputype</span><span class=\"w\"> </span><span class=\"n\">cpusubtype</span><span class=\"w\">  </span><span class=\"n\">caps</span><span class=\"w\">    </span><span class=\"n\">filetype</span><span class=\"w\"> </span><span class=\"n\">ncmds</span><span class=\"w\"> </span><span class=\"n\">sizeofcmds</span><span class=\"w\">      </span><span class=\"n\">flags</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mh\">0xfeedfacf</span><span class=\"w\"> </span><span class=\"mi\">16777223</span><span class=\"w\">          </span><span class=\"mi\">3</span><span class=\"w\">  </span><span class=\"mh\">0x00</span><span class=\"w\">           </span><span class=\"mi\">1</span><span class=\"w\">     </span><span class=\"mi\">2</span><span class=\"w\">        </span><span class=\"mi\">176</span><span class=\"w\"> </span><span class=\"mh\">0x00000000</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_SEGMENT_64</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">152</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">segname</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">vmaddr</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000000</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">vmsize</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000030</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">fileoff</span><span class=\"w\"> </span><span class=\"mi\">208</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">filesize</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">maxprot</span><span class=\"w\"> </span><span class=\"mh\">0x00000007</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">initprot</span><span class=\"w\"> </span><span class=\"mh\">0x00000007</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">nsects</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"></span>\n<span class=\"n\">Section</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sectname</span><span class=\"w\"> </span><span class=\"n\">__text</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">segname</span><span class=\"w\"> </span><span class=\"n\">__TEXT</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000000</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"mh\">0x0000000000000030</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mi\">208</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">align</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">^</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">reloff</span><span class=\"w\"> </span><span class=\"mi\">328</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">nreloc</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"mh\">0x80000400</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">reserved1</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">reserved2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"n\">LC_SYMTAB</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">cmdsize</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">symoff</span><span class=\"w\"> </span><span class=\"mi\">256</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">nsyms</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">stroff</span><span class=\"w\"> </span><span class=\"mi\">304</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">strsize</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"w\"></span>\n<span class=\"n\">Relocation</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">__TEXT</span><span class=\"p\">,</span><span class=\"n\">__text</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"w\"></span>\n<span class=\"n\">address</span><span class=\"w\">  </span><span class=\"n\">pcrel</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">type</span>    <span class=\"nc\">scattered</span><span class=\"w\"> </span><span class=\"n\">symbolnum</span><span class=\"o\">/</span><span class=\"n\">value</span><span class=\"w\"></span>\n<span class=\"mi\">0000000</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\">     </span><span class=\"mi\">3</span><span class=\"w\">      </span><span class=\"mi\">1</span><span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"w\">         </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"mi\">0000001</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\">     </span><span class=\"mi\">3</span><span class=\"w\">      </span><span class=\"mi\">1</span><span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"w\">         </span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">__TEXT</span><span class=\"p\">,</span><span class=\"n\">__text</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">section</span><span class=\"w\"></span>\n<span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"mi\">55</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\"> </span><span class=\"n\">bf</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"></span>\n<span class=\"mi\">0000000000000010</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">d6</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">c7</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"></span>\n<span class=\"mi\">0000000000000020</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">d6</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">c0</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">c3</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The error doesn't appear if I omit both calls.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">0</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i64</span> <span class=\"nc\">system_v</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"n\">block0</span>:\n    <span class=\"nc\">v0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>It does appear if I just omit the call to <code>free</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">0</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i64</span> <span class=\"nc\">system_v</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i64</span> <span class=\"nc\">system_v</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">sig0</span><span class=\"w\"></span>\n\n<span class=\"n\">block0</span>:\n    <span class=\"nc\">v0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">imul</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 266247738,
        "sender_full_name": "Teymour Aldridge",
        "timestamp": 1640687184
    },
    {
        "content": "<p>Weirdly enough, I compiled the same program (instantiating the module for Linux) on Linux (Fedora) and it worked fine.</p>",
        "id": 266269075,
        "sender_full_name": "Teymour Aldridge",
        "timestamp": 1640705905
    },
    {
        "content": "<p>Strange. I don't have a clue what could be going wrong.</p>",
        "id": 266273545,
        "sender_full_name": "bjorn3",
        "timestamp": 1640709848
    },
    {
        "content": "<p>Me too! I searched the internet quite a bit and couldn't find anything, so I thought it might be worth asking here.</p>\n<p>Do you know of any examples (source-viewable code ideally) using Cranelift and malloc on MacOS?</p>",
        "id": 266274575,
        "sender_full_name": "Teymour Aldridge",
        "timestamp": 1640710741
    },
    {
        "content": "<p>I _think_ there has been a related bug in LLVM: <a href=\"https://lists.llvm.org/pipermail/llvm-dev/2017-July/115222.html\">https://lists.llvm.org/pipermail/llvm-dev/2017-July/115222.html</a></p>",
        "id": 266277709,
        "sender_full_name": "Teymour Aldridge",
        "timestamp": 1640713515
    },
    {
        "content": "<p>I managed to fix it! <br>\ndetails: <a href=\"https://github.com/bailion/compiler/commit/909f733af57e33f939940bdfbad4ed36a6bc9b72\">https://github.com/bailion/compiler/commit/909f733af57e33f939940bdfbad4ed36a6bc9b72</a></p>\n<p>Turns out PIC is needed on MacOS (I think at least).</p>\n<p>Thank you for your help!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bailion/compiler/commit/909f733af57e33f939940bdfbad4ed36a6bc9b72\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/2d1a82082e8ace7fcd4ce79406aec4467243ed40\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656365366238353231373364363434333732616431623131336534303238383365373165303136643539356639373466663263623835636130303639666464662f6261696c696f6e2f636f6d70696c65722f636f6d6d69742f39303966373333616635376533336639333939343062646662616434656433366136626339623732)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bailion/compiler/commit/909f733af57e33f939940bdfbad4ed36a6bc9b72\" title=\"Fix compilation on MacOS. · bailion/compiler@909f733\">Fix compilation on MacOS. · bailion/compiler@909f733</a></div><div class=\"message_embed_description\">The error previously was (on one line)\n```\ndyld: BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment 1\nwhich is not writable in /&lt;redacted&gt;/examples/./a.out\n```\n\nThe issue was that Cranelift ...</div></div></div>",
        "id": 266289542,
        "sender_full_name": "Teymour Aldridge",
        "timestamp": 1640723110
    },
    {
        "content": "<p>Nice! That explains why cg_clif doesn't hit this issue.</p>",
        "id": 266292531,
        "sender_full_name": "bjorn3",
        "timestamp": 1640725622
    }
]