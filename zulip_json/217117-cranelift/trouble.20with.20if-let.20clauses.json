[
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"254389\">@Chris Fallin</span> </p>\n<p>I just  pulled down your if-let changes and auto rebased my local branch (which was building fine), but  I'm getting some unexpected issues in <a href=\"http://generated_code.rs\">generated_code.rs</a> relating to patterns that, I'm pretty sure, I'm not touching. The errors all look like:</p>\n<p>error[E0317]: <code>if</code> may be missing an <code>else</code> clause<br>\n...<br>\n     |                  ^^ expected enum <code>core::option::Option</code>, found <code>()</code><br>\n     |<br>\n     = note:   expected enum <code>core::option::Option&lt;reg::Reg&gt;</code><br>\n             found unit type <code>()</code></p>\n<p>Have you see this before?</p>",
        "id": 281137574,
        "sender_full_name": "Sam Parker",
        "timestamp": 1651661101
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"421408\">@Sam Parker</span> I will take a look! I have not seen this before</p>",
        "id": 281181008,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1651681703
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"421408\">@Sam Parker</span> on current <code>main</code> (<code>527b7a9b0594c6d9cc4b5c93db81871f356793a5</code>) I don't see any issue: I tried regenerating ISLE to be sure (<code>cargo check -p cranelift-codegen --features rebuild-isle,all-arch</code>) and all generated source typechecks, with no diffs vs what's checked in</p>",
        "id": 281182216,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1651682187
    },
    {
        "content": "<p>do you have local changes triggering this? I'm happy to help debug if you can give me a diff</p>",
        "id": 281182252,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1651682200
    },
    {
        "content": "<p>(if you see this in your tomorrow (Thu) then I'm out on Thu/Fri but will take a look as soon as I can)</p>",
        "id": 281182554,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1651682318
    },
    {
        "content": "<p>Yes, sorry, it has to be my changes (my main is fine) but I just don't understand, yet, how my new simd patterns are affecting some existing scalar patterns and wondered if you'd ever seen something similar. After looking all at the problem patterns, they all shared the use of iconst and I have been playing with constants :)</p>",
        "id": 281263132,
        "sender_full_name": "Sam Parker",
        "timestamp": 1651736670
    },
    {
        "content": "<p>I've removed most of my changes, yet I still haven't figured out the root cause... But from my naive perspective it looks like the generated constructors are now being written in the wrong order; an example of generated code diff look like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\"> </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">constructor_put_nonzero_in_reg_sext64</span><span class=\"o\">&lt;</span><span class=\"n\">C</span>: <span class=\"nc\">Context</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">ctx</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg0</span>: <span class=\"nc\">Value</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">Reg</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">pattern0_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">arg0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"o\">+</span><span class=\"w\">    </span><span class=\"c1\">// Rule at src/isa/aarch64/lower.isle line 444.</span>\n<span class=\"o\">+</span><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">expr0_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">constructor_put_in_reg_sext64</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern0_0</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"o\">+</span><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">expr1_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">constructor_trap_if_zero_divisor</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">expr0_0</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"o\">+</span><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">expr1_0</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">pattern1_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">C</span>::<span class=\"n\">value_type</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern0_0</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">pattern2_0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">C</span>::<span class=\"n\">def_inst</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern0_0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">pattern3_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">C</span>::<span class=\"n\">inst_data</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern2_0</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">InstructionData</span>::<span class=\"n\">UnaryImm</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">opcode</span>: <span class=\"nc\">ref</span><span class=\"w\"> </span><span class=\"n\">pattern4_0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">imm</span>: <span class=\"nc\">pattern4_1</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">pattern3_0</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">Opcode</span>::<span class=\"n\">Iconst</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pattern4_0</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                 </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">pattern6_0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">C</span>::<span class=\"n\">nonzero_u64_from_imm64</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern4_1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                     </span><span class=\"c1\">// Rule at src/isa/aarch64/lower.isle line 449.</span>\n<span class=\"w\">                     </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">expr0_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">constructor_imm</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern1_0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern6_0</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">                     </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">expr0_0</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">                 </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">         </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"o\">-</span><span class=\"w\">    </span><span class=\"c1\">// Rule at src/isa/aarch64/lower.isle line 444.</span>\n<span class=\"o\">-</span><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">expr0_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">constructor_put_in_reg_sext64</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pattern0_0</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"o\">-</span><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">expr1_0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">constructor_trap_if_zero_divisor</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">expr0_0</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"o\">-</span><span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">expr1_0</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And my changes to lower.isle are minimal:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">             </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">Extract</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">low</span><span class=\"w\"> </span><span class=\"n\">half</span><span class=\"w\"> </span><span class=\"n\">components</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">rn</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"p\">;;</span><span class=\"w\">   </span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">c</span><span class=\"o\">|</span><span class=\"n\">a</span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"o\">-</span><span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"n\">Reg</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">xtn64</span><span class=\"w\"> </span><span class=\"n\">rn</span><span class=\"w\"> </span><span class=\"cp\">$false</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"o\">+</span><span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"n\">Reg</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">xtn64</span><span class=\"w\"> </span><span class=\"n\">rn</span><span class=\"p\">))</span><span class=\"w\"></span>\n\n<span class=\"w\">             </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">respective</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">half</span><span class=\"w\"> </span><span class=\"n\">components</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"p\">;;</span><span class=\"w\">   </span><span class=\"n\">rd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">dg</span><span class=\"o\">+</span><span class=\"n\">ch</span><span class=\"o\">|</span><span class=\"n\">be</span><span class=\"o\">+</span><span class=\"n\">af</span><span class=\"o\">||</span><span class=\"n\">dg</span><span class=\"o\">+</span><span class=\"n\">ch</span><span class=\"o\">|</span><span class=\"n\">be</span><span class=\"o\">+</span><span class=\"n\">af</span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"o\">@@</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">273</span><span class=\"p\">,</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mi\">273</span><span class=\"p\">,</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"w\"></span>\n\n<span class=\"w\">             </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">Extract</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">low</span><span class=\"w\"> </span><span class=\"n\">half</span><span class=\"w\"> </span><span class=\"n\">components</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"p\">;;</span><span class=\"w\">   </span><span class=\"n\">tmp2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">g</span><span class=\"o\">|</span><span class=\"n\">e</span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"o\">-</span><span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">tmp2</span><span class=\"w\"> </span><span class=\"n\">Reg</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">xtn64</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"w\"> </span><span class=\"cp\">$false</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"o\">+</span><span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">tmp2</span><span class=\"w\"> </span><span class=\"n\">Reg</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">xtn64</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"p\">))</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 281278249,
        "sender_full_name": "Sam Parker",
        "timestamp": 1651745447
    },
    {
        "content": "<p>I've now tried three completely separate isle touching local branches, and they're all affected in the same way. It's actually possible to reproduce this by just reordering the bconst lower rules, so I'm assuming any change at the source level can reproduce this bug.</p>",
        "id": 281298671,
        "sender_full_name": "Sam Parker",
        "timestamp": 1651757259
    },
    {
        "content": "<p>(fyi: Chris is out for the rest of the week; he will be back on Monday)</p>",
        "id": 281314013,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1651764155
    },
    {
        "content": "<p>I suspect this has to do with the recent changes to ISLE's trie IR where priority ranges were removed and replaced with scalar priorities. Probably just a bug that fell out during that change, and not fundamental to the range -&gt; scalar change.</p>",
        "id": 281314212,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1651764238
    },
    {
        "content": "<p>probably the same thing as: <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4093#issuecomment-1118654081\">https://github.com/bytecodealliance/wasmtime/pull/4093#issuecomment-1118654081</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/4093#issuecomment-1118654081\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/7f51ff17e4881079db12dc4af81bd76c2ff57674\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313831333235353332666433346334326132643362306464636538306663303035646432306636373661613239663665666661326265616664323133386230302f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f34303933)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/4093#issuecomment-1118654081\" title=\"ISLE compiler: fix priority-trie interval bug. by cfallin · Pull Request #4093 · bytecodealliance/wasmtime\">ISLE compiler: fix priority-trie interval bug. by cfallin · Pull Request #4093 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This PR fixes a bug in the ISLE compiler related to rule priorities.\nAn important note first: the bug did not affect the correctness of the Cranelift backends, either in theory (because the rules s...</div></div></div>",
        "id": 281314446,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1651764334
    },
    {
        "content": "<p>(hi from the airport) yes, I think reverting that PR is the right move and I'll figure it out on Monday. Sorry for the trouble!</p>",
        "id": 281321494,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1651767201
    },
    {
        "content": "<p><a href=\"https://github.com/bytecodealliance/wasmtime/pull/4102\">https://github.com/bytecodealliance/wasmtime/pull/4102</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/4102\" style=\"background-image: url(https\\:\\/\\/uploads\\.zulipusercontent\\.net\\/e7071597fe031ccfb83ee0246b6b50da6124dacf\\/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626166323937383838633036626562646665656230633063643431313337303839663736653836343962616161356261363631313336616264323833393264622f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f34313032)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/4102\" title=\"Revert ISLE priority trie regression and fix ISLE rebuild CI job by fitzgen · Pull Request #4102 · bytecodealliance/wasmtime\">Revert ISLE priority trie regression and fix ISLE rebuild CI job by fitzgen · Pull Request #4102 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">\n No description provided. \n</div></div></div>",
        "id": 281327708,
        "sender_full_name": "fitzgen (he/him)",
        "timestamp": 1651769858
    },
    {
        "content": "<p>Thanks, I can confirm that reordering the bconst rules doesn't result in illegal generated_code. Something is still going wrong for me though. On one branch I can still see my original issue and on another, which should only touch the aarch64 backend, I'm seeing changes for x64 and s390x along with test failures for s390x... So, I can only assume that I'm building things incorrectly. Any ideas?</p>",
        "id": 281823067,
        "sender_full_name": "Sam Parker",
        "timestamp": 1652188968
    },
    {
        "content": "<p>Okay, fixed the odd x64 and s390x issues by manually reverting the changes, not sure how those changes ended up in the commit but also confused as to why they aren't regenerated (correctly)</p>",
        "id": 281826739,
        "sender_full_name": "Sam Parker",
        "timestamp": 1652190793
    },
    {
        "content": "<p>Ah, you're probably hitting the same issue I did: the manifest indicated things were up to date, so the compiler fix didn't cause a rebuild for you locally</p>",
        "id": 281844769,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1652197977
    },
    {
        "content": "<p>This is yet more evidence to me that we need to do something better IMHO; I'll think a bit more and follow up on the \"don't check in source\" issue</p>",
        "id": 281844895,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1652198031
    },
    {
        "content": "<p>Yes, I agree. I think I've spent as much time figuring out build quirks as writing the patches and that isn't right, plus I'm yet to solve all my problems :)</p>",
        "id": 281862417,
        "sender_full_name": "Sam Parker",
        "timestamp": 1652205479
    }
]