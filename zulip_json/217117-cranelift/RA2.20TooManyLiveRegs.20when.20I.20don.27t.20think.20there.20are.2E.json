[
    {
        "content": "<p>So I believe that there might be a problem when there are exactly enough PREGS in a class for Defs of an instruction, and one of the Defs reuses an input in the same RegClass.</p>\n<p>Take the following example where I have defined the semantics required to represent the x86 instruction SBB, which modifies the CF, PF, AF, ZF, SF and OF flags, but also reads the CF flag and uses it in the internal computation.</p>\n<p>Below is my definition of the instruction. <code>FlagIn/RegIn</code> values are Early-Uses, <code>FlagOut/RegOut</code> values are LateDefs meaning that their liveness does not overlap.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">sbb_r_rs</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">Data</span><span class=\"p\">(),</span>\n<span class=\"w\">        </span><span class=\"n\">RegIn</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Reg</span><span class=\"p\">),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">right</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Any</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">FlagIn</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">cf_in</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_CF</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"c1\">// CF read by the SBB instruction.</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">RegOut</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Reuse</span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"p\">.</span><span class=\"n\">index</span><span class=\"p\">()))</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">FlagOut</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">of</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_OF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">sf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_SF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">zf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_ZF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">af</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_AF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">cf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Reuse</span><span class=\"p\">(</span><span class=\"n\">cf_in</span><span class=\"p\">.</span><span class=\"n\">index</span><span class=\"p\">())),</span><span class=\"w\">   </span><span class=\"c1\">// Notice the reuse of the input of CF because it must also be in PREG_CF</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">pf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_PF</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">),</span>\n</code></pre></div>\n<p>The Flag PRegs are in the Vector RegClass, where the Reg PRegs are in the Integer RegClass.</p>\n<p>In the Vector(flag) RegClass has 6 total PRegs: PREG_CF, PREG_PF, PREG_AF, PREF_ZF, PREG_SF, PREF_OF. Notice that this is exactly the number of Defs the instruction has.</p>\n<p>This looks like it should work to me, there are 6 Defs in the Vector class, 6 available PRegs in the Vector class, one Use from the Vector class, but if that use is needed after this instruction, it could be spilled. </p>\n<p>So, why is it when I run RegAlloc2 over this, I get the error TooManyLiveRegs? I don't believe I should be getting this error, unless? Any input is greatly appreciated!</p>",
        "id": 451845763,
        "sender_full_name": "Leaves",
        "timestamp": 1721158855
    },
    {
        "content": "<p>RA2 doesn't make a guarantee about \"exact fit\": because register allocation operates on heuristics, it could be the case that it needs more than the strictly optimal number of registers for your program. (Guaranteeing otherwise is equivalent to providing an exact rather than heuristic solution to the graph coloring problem.)</p>",
        "id": 451852389,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721161052
    },
    {
        "content": "<p>I still feel that modeling individual flags as registers feels... not in line with the way that RA2 is designed to work; I'd encourage you to see if you can find a way to \"lift\" the handling of flags to a higher level somehow, and generate flag spills/restores (or lazy computation, or ...) from your own instruction-generation logic</p>",
        "id": 451852553,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721161107
    },
    {
        "content": "<p>To the first: But with the constraints I've given it, it is forced to put the flags where I've specified. It cannot put edits into the middle(before the early and late) stages of my instruction. It must satisfy the constraints coming in, that the <code>in_cf</code>(or a copy of it) be in PREG_CF, and that PREG_CF will be something different on the way out. If the value of <code>in_cf</code> lives past this SBB instruction, shouldn't regalloc2 be aware that it cannot store it  in a PREG and force a spill of the value, meaning it exists in both a stack slot and PREG_CF going in to the SBB? But really, <code>in_cf</code> is dead after the instruction, so to me it isn't clear why it cannot be allocated for both <code>in_cf</code> and <code>[out_]cf</code>.</p>\n<p>To the second: This is ALMOST easy to do... The main issue is that not all instructions touch all flags. One option I pursued was treating the flags as a single register, and merge pseudo-instructions to merge flag outputs from different instructions based on a mask: <code>(Flags1 &amp; Mask1) | (Flags2 &amp; Mask2)</code>. But I would still end up using RA2 to model spills of this flag register. This merge pseudo-instruction would also always need to be emitted(probably turned into a function call to do the computation) when any computation that only modifies a strict subset of the flags happens.</p>",
        "id": 451865288,
        "sender_full_name": "Leaves",
        "timestamp": 1721164815
    },
    {
        "content": "<p>Yes, you're right, the constraints do admit a solution; you, as a human, can see it. The register allocator is not an exhaustive solver, it's a collection of heuristics and approximation algorithms, so it does not in this case</p>",
        "id": 451865596,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721164933
    },
    {
        "content": "<p>If you're able to make it do so, PRs welcome!</p>",
        "id": 451865610,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721164939
    },
    {
        "content": "<p>The problem that several of us have run into when looking into corner-cases like this is: fix the heuristics for one case, another breaks. We seem to be at a fairly stable \"local maximum\" unfortunately</p>",
        "id": 451865744,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721164982
    },
    {
        "content": "<p>I'd encourage you to look at how e.g. Valgrind handles flags; iirc it tracks which operands and operator last affected flags, and lazily computes flags when needed</p>",
        "id": 451865987,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721165073
    },
    {
        "content": "<p>Ok so too many live regs isn't really saying it is impossible. It is just a failure of the heuristics to handle the super edge case I've created. The comments in the source somewhat misleading when saying it is \"impossible\" <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>",
        "id": 451868124,
        "sender_full_name": "Leaves",
        "timestamp": 1721165894
    },
    {
        "content": "<p>context is: impossible given the current assignment of minimal bundles to registers, not impossible under all possible assignments that the constraints admit</p>",
        "id": 451868547,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721166005
    },
    {
        "content": "<p><span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span> got it, thank you very much!</p>",
        "id": 451868639,
        "sender_full_name": "Leaves",
        "timestamp": 1721166027
    },
    {
        "content": "<p>no problem, best of luck!</p>",
        "id": 451868669,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721166035
    },
    {
        "content": "<p>So just to see what happened, I added some more pseudo registers to the Vector(flag) RegClass to temporarily move past that issue and see if I could get it to at least allocate. And now I have something interesting happening.</p>\n<p>In the prolog, <code>v2v</code> is defined as an input flag param and is <code>OperandConstraint::Fixed(p0v)</code>.</p>\n<p>In the body, this value of <code>v2v</code>(in <code>p0v</code>) is copied into <code>p19v</code> for storage in the first edit:<br>\nthe SBB instruction is emitted, which creates a new value of the carry flag <code>v6v</code>, also fixed in <code>p0v</code> because of the <code>OperandConstraint::Reuse(2)</code>, the 2nd operand being SBB's read of the CF value <code>v2v</code>, with constraint <code>OperandConstraint::Fixed(p0v)</code>.<br>\nAt this point after the SBB, <code>p0v</code> contains the value of the carry flag computed by the SBB.<br>\nBut now, another edit is emitted which moves from <code>p19v</code> into <code>p0v</code>, overwriting the carry flag value computed by the SBB and restoring <code>v2v</code> into <code>p0v</code> for seemingly no reason.</p>\n<p>In the epilog, the value of <code>v6v</code> is used, and it is <code>OperandConstraint::Fixed(p0v)</code> so it is going to read from <code>p0v</code>. But <code>v6v</code> won't be in <code>p0v</code> because of the edit above!</p>\n<p>So now I'm quite confused, am I looking at a bug? What is going on? Any ideas are appreciated. I feel like despite the nonsense I'm doing with the flags, those edits still should not exist.<br>\n<br>\nThe machine instructions I have that I pass to RA2 are pictured below, their operand slices follow them, none of them have any clobbers.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Prolog</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nc\">Inst</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">reg_params</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v0i</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0i</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v1i</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p2i</span><span class=\"p\">)),</span>\n<span class=\"w\">  </span><span class=\"n\">Inst</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">flag_params</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v2v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0v</span><span class=\"p\">)),</span>\n\n<span class=\"n\">Body</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nc\">Edit</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">p0v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">p19v</span>\n<span class=\"w\">  </span><span class=\"n\">Inst</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">sbb_r_rs</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v0i</span><span class=\"w\"> </span><span class=\"n\">reg</span><span class=\"p\">),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v1i</span><span class=\"w\"> </span><span class=\"n\">any</span><span class=\"p\">),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v2v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v4i</span><span class=\"w\"> </span><span class=\"n\">reuse</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v5v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p11v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v8v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p7v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v9v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p6v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v7v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p4v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v6v</span><span class=\"w\"> </span><span class=\"n\">reuse</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v10v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p2v</span><span class=\"p\">)),</span>\n<span class=\"w\">  </span><span class=\"n\">Edit</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">p19v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">p0v</span>\n\n<span class=\"n\">Epilog</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nc\">Inst</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">reg_outputs</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v4i</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0i</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"n\">Inst</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">flag_outputs</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v6v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0v</span><span class=\"p\">)),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v10v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p2v</span><span class=\"p\">)),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v7v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p4v</span><span class=\"p\">)),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v9v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p6v</span><span class=\"p\">)),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v8v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p7v</span><span class=\"p\">)),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v5v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p11v</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"n\">Inst</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ret</span>\n</code></pre></div>",
        "id": 451885279,
        "sender_full_name": "Leaves",
        "timestamp": 1721170606
    },
    {
        "content": "<p>Unfortunately I don't have any more spare cycles to read this message in detail and process it or continue this conversation. A few of us nominally maintain RA2 (and I wrote most of it) but all of us are way overloaded with other work right now. PRs always welcome if you're able to help with algorithmic improvements. All the best...</p>",
        "id": 451887501,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721171194
    },
    {
        "content": "<p>Absolutely no worries at all and I very much appreciate your help so far. I WILL eventually solve this problem, and I will report back when I do <span aria-label=\"salute\" class=\"emoji emoji-1fae1\" role=\"img\" title=\"salute\">:salute:</span></p>",
        "id": 451887783,
        "sender_full_name": "Leaves",
        "timestamp": 1721171308
    },
    {
        "content": "<p>Looking forward to it!</p>",
        "id": 451887800,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721171317
    },
    {
        "content": "<p>I'm going to go reading through the RA2 source now. I noticed that if I fix the Integer registers being allocated, it works... The following will work, see the first 3 operands(the only integer operands) are now fixed.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">sbb_r_rs</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v0i</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0i</span><span class=\"p\">)),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v1i</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p2i</span><span class=\"p\">)),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v2v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v4i</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0i</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v5v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p11v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v8v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p7v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v9v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p6v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v7v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p4v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v6v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v10v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p2v</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>However as soon as I leave them to RA2 to decide, notice first 3 operands are reg/any/reuse, not fixed:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">sbb_r_rs</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v0i</span><span class=\"w\"> </span><span class=\"n\">reg</span><span class=\"p\">),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v1i</span><span class=\"w\"> </span><span class=\"n\">any</span><span class=\"p\">),(</span><span class=\"n\">Use</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v2v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v4i</span><span class=\"w\"> </span><span class=\"n\">reuse</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v5v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p11v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v8v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p7v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v9v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p6v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v7v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p4v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v6v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p0v</span><span class=\"p\">)),(</span><span class=\"n\">Def</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v10v</span><span class=\"w\"> </span><span class=\"n\">fixed</span><span class=\"p\">(</span><span class=\"n\">p2v</span><span class=\"p\">)),</span><span class=\"n\">Clobbers</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n</code></pre></div>\n<p>it panics with \".\\src\\ion\\process.rs:1241:17\":\"Could not allocate minimal bundle, but the allocation problem should be possible to solve\" </p>\n<p><span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>",
        "id": 451890680,
        "sender_full_name": "Leaves",
        "timestamp": 1721172582
    },
    {
        "content": "<p>Looks like I'm tickling: <a href=\"https://github.com/bytecodealliance/regalloc2/issues/145\">Support instructions that clobber all registers and have non-fixed uses · Issue #145 · bytecodealliance/regalloc2 (github.com)</a> ...</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/regalloc2/issues/145\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/843b29ed958606fc241602d6fb35362969d0982a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633034376130663937393230666433366562393231353537616630356431316231363762363338383561323131613935376638353633313332393237396230642f62797465636f6465616c6c69616e63652f726567616c6c6f63322f6973737565732f313435&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/regalloc2/issues/145\" title=\"Support instructions that clobber all registers and have non-fixed uses · Issue #145 · bytecodealliance/regalloc2\">Support instructions that clobber all registers and have non-fixed uses · Issue #145 · bytecodealliance/regalloc2</a></div><div class=\"message_embed_description\">There are currently special cases for when an instruction uses a fixed register and clobbers it, but when an instruction uses an unconstrained register and clobbers all registers there is no specia...</div></div></div>",
        "id": 451916629,
        "sender_full_name": "Leaves",
        "timestamp": 1721183248
    },
    {
        "content": "<p>But not exactly, seeing as how the all the clobbered/defs are in a separate class.</p>",
        "id": 451917206,
        "sender_full_name": "Leaves",
        "timestamp": 1721183561
    },
    {
        "content": "<p>Does RA2 only allow for only a single <code>OperandConstraint::Reuse</code> per instruction? Here is code in liveranges.rs:465 that raises this question:</p>\n<div class=\"message_inline_image\"><a href=\"https://i.imgur.com/4nyUS8J.png\"><img src=\"https://uploads.zulipusercontent.net/f055fe91388c0083e76719b4b67a800cd60fdb4e/68747470733a2f2f692e696d6775722e636f6d2f346e795553384a2e706e67\"></a></div>",
        "id": 452213060,
        "sender_full_name": "Leaves",
        "timestamp": 1721259631
    },
    {
        "content": "<p>I believe this is the source of the incorrect edit's above, when two <code>OperandConstraint::Reuse</code>s were present.</p>",
        "id": 452213200,
        "sender_full_name": "Leaves",
        "timestamp": 1721259761
    },
    {
        "content": "<p>It is supported in that it won't miscompile, but I don't think it handles it well.</p>",
        "id": 452298688,
        "sender_full_name": "Amanieu",
        "timestamp": 1721295718
    },
    {
        "content": "<p>That may very well be the issue here.</p>",
        "id": 452298838,
        "sender_full_name": "Amanieu",
        "timestamp": 1721295754
    },
    {
        "content": "<p>that could be it indeed; it seems worth an experiment (if you're willing) to switch out the <code>Option</code> for a <code>Vec</code> (\"small set\", no need to reach for a hashset) and do <code>contains</code> later when we check if inputs are reused</p>",
        "id": 452373007,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721316035
    },
    {
        "content": "<p>Yep, will be experimenting with it today. Also curious as to how cranelift handles x86's XCHG with this, being that it would require two <code>OperandConstraint::Reuse</code>s to correctly describe. Will look into that as well.</p>",
        "id": 452389694,
        "sender_full_name": "Leaves",
        "timestamp": 1721320554
    },
    {
        "content": "<p>We don't emit xchg, so we don't have to solve that problem fortunately!</p>",
        "id": 452390044,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721320683
    },
    {
        "content": "<p>(We only need to support the subset of instructions we actually emit, so we can pretend any other instruction we don't need simply doesn't exist)</p>",
        "id": 452390093,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721320707
    },
    {
        "content": "<p>Well that saves me having to go look, thanks.</p>",
        "id": 452390109,
        "sender_full_name": "Leaves",
        "timestamp": 1721320716
    },
    {
        "content": "<p>I wonder if XCHG could help with circular moves in RA2, when a scratch register is used. when R1 and R2 need to swap. Although I would guess this is a rare occurrence?</p>",
        "id": 452390217,
        "sender_full_name": "Leaves",
        "timestamp": 1721320770
    },
    {
        "content": "<p>I think there's some discussion of that in one of the issues about the move resolver (or at least, I've discussed this with folks). cycles are pretty rare but you could certainly add a stat and see how rare and estimate what impact it might have</p>",
        "id": 452390577,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721320910
    },
    {
        "content": "<p>internally (in the CPU) moves and xchg's are both handled by move elision at the rename stage and have zero cost in the execution backend, so instruction fetch bandwidth would be the only real effect I suspect (may be a bottleneck in some cases, not always)</p>",
        "id": 452390740,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721320968
    },
    {
        "content": "<p>Might see some slowdowns if it's a move to a stack slot though, as the cpu will lock the cache for that location. So if lots of stack slot loads are happening around there maybe could be worse.</p>",
        "id": 452390852,
        "sender_full_name": "Leaves",
        "timestamp": 1721321031
    },
    {
        "content": "<p>oh, yeah, mem/reg xchg's are a different beast entirely</p>",
        "id": 452390992,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721321074
    },
    {
        "content": "<p>Ok so, good news! Changing to allow for proper handling of multiple reuse operands has allowed me to fix my problem.(sort of)</p>\n<div class=\"message_inline_image\"><a href=\"https://i.imgur.com/ECstFsP.png\"><img src=\"https://uploads.zulipusercontent.net/c67b81d152d1de3c84aab8e94fe8e62ecf769d5e/68747470733a2f2f692e696d6775722e636f6d2f454373744673502e706e67\"></a></div><p>Now, instead of modeling my <code>SBB</code> like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">sbb_r_rs</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">Data</span><span class=\"p\">(),</span>\n<span class=\"w\">        </span><span class=\"n\">RegIn</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Reg</span><span class=\"p\">),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">right</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Any</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">FlagIn</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">cf_in</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_CF</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">RegOut</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Reuse</span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"p\">.</span><span class=\"n\">index</span><span class=\"p\">()))</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">FlagOut</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">of</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_OF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">sf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_SF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">zf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_ZF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">af</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_AF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">cf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_CF</span><span class=\"p\">)),</span><span class=\"w\">  </span><span class=\"c1\">// Notice this is not reusing, it is just specifying fixed at same register as the in_cf...</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">pf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_PF</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">),</span>\n</code></pre></div>\n<p>I model it like this, which seems to avoid the problem of TooManyLiveRegs</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">sbb_r_rs</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">Data</span><span class=\"p\">(),</span>\n<span class=\"w\">        </span><span class=\"n\">RegIn</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Reg</span><span class=\"p\">),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">right</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Any</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">FlagIn</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">cf_in</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_CF</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">RegOut</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Reuse</span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"p\">.</span><span class=\"n\">index</span><span class=\"p\">()))</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">FlagOut</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">of</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_OF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">sf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_SF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">zf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_ZF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">af</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_AF</span><span class=\"p\">)),</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">cf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">Reuse</span><span class=\"p\">(</span><span class=\"n\">cf_in</span><span class=\"p\">.</span><span class=\"n\">index</span><span class=\"p\">())),</span><span class=\"w\">   </span><span class=\"c1\">//notice now this is a reuse of the fixed reg cf_in.</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"n\">pf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OperandConstraint</span><span class=\"p\">::</span><span class=\"n\">FixedReg</span><span class=\"p\">(</span><span class=\"n\">PREG_PF</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">),</span>\n</code></pre></div>",
        "id": 452411247,
        "sender_full_name": "Leaves",
        "timestamp": 1721326693
    },
    {
        "content": "<p>And this does now allocate <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>",
        "id": 452411363,
        "sender_full_name": "Leaves",
        "timestamp": 1721326715
    },
    {
        "content": "<p>nice! happy to take a PR if you'd like; our standard for testing is running the <code>ion_checker</code> fuzzer locally for a while (overnight on multiple cores if you're able)</p>",
        "id": 452411784,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721326808
    },
    {
        "content": "<p>I've never actually contributed to open source before... so not very familiar with the procedure, but I'd be happy to run the tests for a while no problem.</p>",
        "id": 452412025,
        "sender_full_name": "Leaves",
        "timestamp": 1721326867
    },
    {
        "content": "<p>ah! so if you have a git commit with your change, it should be not so bad: create a fork of the repo on GitHub (there's a button for this), add the git remote and push your branch to your fork, then either use the web UI or the link that the git server returns in a message to create a PR</p>",
        "id": 452413036,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721327095
    },
    {
        "content": "<p>Alright I've got 8 of the ion checker running, I'll let those go for a while. I'll look into creating a PR. :thumbsup:</p>",
        "id": 452451972,
        "sender_full_name": "Leaves",
        "timestamp": 1721342890
    },
    {
        "content": "<p>awesome!</p>",
        "id": 452453619,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1721343922
    },
    {
        "content": "<p>Ok submitted PR!, commenting on #145 too.</p>",
        "id": 452607912,
        "sender_full_name": "Leaves",
        "timestamp": 1721405235
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"254389\">Chris Fallin</span> <a href=\"#narrow/stream/217117-cranelift/topic/RA2.20TooManyLiveRegs.20when.20I.20don't.20think.20there.20are.2E/near/452390740\">said</a>:</p>\n<blockquote>\n<p>internally (in the CPU) moves and xchg's are both handled by move elision at the rename stage and have zero cost in the execution backend, so instruction fetch bandwidth would be the only real effect I suspect (may be a bottleneck in some cases, not always)</p>\n</blockquote>\n<p>just as an aside, this is not true for even recent chips, e.g. Alder Lake executes xchg in the backend.<br>\nOnly Zen started renaming xchgs but with worse latency than moves so three moves is the better codegen in general.</p>",
        "id": 452996306,
        "sender_full_name": "T0b1",
        "timestamp": 1721574566
    },
    {
        "content": "<p>Unless to facilitate the 3 moves, you have to spill another value to create a scratch register.(which you will unless you designate a scratch register for regalloc). So only when above a certain number of cyclic moves are happening, such that the equivalent cost of the XCHG instructions is more than the spill load/restore of the value for the scratch register, will the XCHGs be slower I think?</p>",
        "id": 453030850,
        "sender_full_name": "Leaves",
        "timestamp": 1721590107
    },
    {
        "content": "<p>I don‘t know about the design of regalloc2, but if you have a register that‘s currently free, you can just use that. And note that spill+3movs might actually be faster than xchg if it is part of a dependency chain even if you need to restore that value later since that will likely get forwarded.<br>\nimo it is just pretty dependent on the actual code (+uarch) which option is faster, most of the time it doesn‘t matter and it doesn‘t happen that often which is why (to the best of my knowledge) most compilers don‘t bother trying to optimize this.<br>\nAnd since CPU vendors optimize for code that‘s already out there it‘s usually best to just stick to what other compilers would generate in similar cases (as I had to learn recently).</p>\n<p>Sorry about the long message, I didn’t intend to derail the thread, just note something I myself was surprised about when I first learned that xchg is not renamed.</p>",
        "id": 453066433,
        "sender_full_name": "T0b1",
        "timestamp": 1721617189
    }
]