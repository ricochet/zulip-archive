[
    {
        "content": "<p>OK, bear with me, but I want to use javascript (NOT my language, though easy learn) to create a wasi:http component for preview 2. I can do custom wit components easily enough using this sample: <a href=\"https://github.com/bytecodealliance/ComponentizeJS/blob/main/EXAMPLE.md\">https://github.com/bytecodealliance/ComponentizeJS/blob/main/EXAMPLE.md</a>. What is done up front is to take a .wit file and then implement the function listed there, nothing fancy. So far so good. So I have the wasi wit block in a repo.... But I need to understand the <em>binding step</em> for js. In the example above, you merely reference <code>hello</code> and then implement <code>hello</code> and call <code>jco componentize</code> and you have a component.</p>",
        "id": 416788028,
        "sender_full_name": "Ralph",
        "timestamp": 1705674160
    },
    {
        "content": "<p>But that's custom wit.</p>",
        "id": 416788049,
        "sender_full_name": "Ralph",
        "timestamp": 1705674167
    },
    {
        "content": "<p>so for wasi:http, do I need to implement this?</p>",
        "id": 416788254,
        "sender_full_name": "Ralph",
        "timestamp": 1705674251
    },
    {
        "content": "<p>interface incoming-handler {<br>\n  use types.{incoming-request, response-outparam};</p>\n<p>/// This function is invoked with an incoming HTTP Request, and a resource<br>\n  /// <code>response-outparam</code> which provides the capability to reply with an HTTP<br>\n  /// Response. The response is sent by calling the <code>response-outparam.set</code><br>\n  /// method, which allows execution to continue after the response has been<br>\n  /// sent. This enables both streaming to the response body, and performing other<br>\n  /// work.<br>\n  ///<br>\n  /// The implementor of this function must write a response to the<br>\n  /// <code>response-outparam</code> before returning, or else the caller will respond<br>\n  /// with an error on its behalf.<br>\n  handle: func(<br>\n    request: incoming-request,<br>\n    response-out: response-outparam<br>\n  );<br>\n}</p>",
        "id": 416788272,
        "sender_full_name": "Ralph",
        "timestamp": 1705674256
    },
    {
        "content": "<p>what I'm missing as a newbie here is the <em>binding mechanism</em> between the WIT function \" and the js needed to implement it. Do I simply \"implement the function\" name, as I can do with the above <code>hello</code> function?</p>",
        "id": 416788640,
        "sender_full_name": "Ralph",
        "timestamp": 1705674372
    },
    {
        "content": "<p>or is there a js binding generator for wasi:http/proxy that I need to locate and them merely \"import\" the types to use?</p>",
        "id": 416788726,
        "sender_full_name": "Ralph",
        "timestamp": 1705674406
    },
    {
        "content": "<p>i get that concept, and I'm golden here.</p>",
        "id": 416788766,
        "sender_full_name": "Ralph",
        "timestamp": 1705674420
    },
    {
        "content": "<p>wait, are these they: do I just need to reference them in the package.json?</p>",
        "id": 416798622,
        "sender_full_name": "Ralph",
        "timestamp": 1705677292
    },
    {
        "content": "<p>},<br>\n  \"devDependencies\": {<br>\n    \"@bytecodealliance/jco\": \"^0.14.2\",<br>\n    \"@bytecodealliance/preview2-shim\": \"^0.14.2\",</p>",
        "id": 416798625,
        "sender_full_name": "Ralph",
        "timestamp": 1705677293
    },
    {
        "content": "<p>I'm not sure if the shim includes wasi-http but in general yes, you add jco to your devDependencies and preview2-shim to your dependencies and then jco transpile'd components \"just work\" but as I said I only use preview2, I didn't follow. the wasi-http changes yet</p>",
        "id": 416800433,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1705677784
    },
    {
        "content": "<p>I'm on preview 12_05, so that's fine</p>",
        "id": 416801501,
        "sender_full_name": "Ralph",
        "timestamp": 1705678071
    },
    {
        "content": "<p>sorry for not using</p>",
        "id": 416802653,
        "sender_full_name": "Ralph",
        "timestamp": 1705678391
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"code\"><pre><span></span><code>\n</code></pre></div>",
        "id": 416802689,
        "sender_full_name": "Ralph",
        "timestamp": 1705678406
    },
    {
        "content": "<p>in terms of the JS to define to componentize, you'd want to write a JS file like:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"k\">export</span><span class=\"w\"> </span><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">incomingHandler</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nx\">handle</span><span class=\"p\">(</span><span class=\"nx\">request</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">response</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>we do have an example of using outgoing handler in ComponentizeJS in <a href=\"https://github.com/bytecodealliance/jco/blob/main/test/fixtures/componentize/wasi-http-proxy/source.js\">https://github.com/bytecodealliance/jco/blob/main/test/fixtures/componentize/wasi-http-proxy/source.js</a> although it doesn't contain the incoming handler currently, so you'd need to check the types to figure it out.</p>\n<p>Generating template JS / TypeScript bindings for these ComponentizeJS workflows has been a TODO for a while... agreed it should be a thing.</p>",
        "id": 416843011,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1705689202
    },
    {
        "content": "<p>thanks Guy; if I've imported preview2-shim and npm intalled, I seem to get the incomingHandler type and it resolves, so hopefully that's really all I need to do.....</p>",
        "id": 416849056,
        "sender_full_name": "Ralph",
        "timestamp": 1705691316
    },
    {
        "content": "<p>when you say generating bindings, what do you mean that's not:<br>\n<a href=\"/user_uploads/15107/sc1y3mfmySJmTeJ4TKEI1DkU/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/15107/sc1y3mfmySJmTeJ4TKEI1DkU/image.png\" title=\"image.png\"><img src=\"/user_uploads/15107/sc1y3mfmySJmTeJ4TKEI1DkU/image.png\"></a></div>",
        "id": 416849304,
        "sender_full_name": "Ralph",
        "timestamp": 1705691409
    },
    {
        "content": "<p>that looks right, although in ComponentizeJS the bindings have a different import convention - <code>import 'wasi:http@0.2.0-rc-2024-01-16/incoming-handler</code> etc instead</p>",
        "id": 416850136,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1705691745
    },
    {
        "content": "<p>but if you are just having this import for IDE types to work out making it an <code>import type { IncomingHandler } from '@bytecodealliance/preview2/http'</code> might make sense with <code>tsc</code> itself stripping that out</p>",
        "id": 416850278,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1705691785
    },
    {
        "content": "<p>at least with jco transpile, it does put the .d.ts files in the right locations and IDEs can just autocomplete imports</p>",
        "id": 416850348,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1705691807
    },
    {
        "content": "<p>yeah so if we had something similar for ComponentizeJS it might be useful to generate types that work for authoring components to arbitrary WIT</p>",
        "id": 416850427,
        "sender_full_name": "Guy Bedford",
        "timestamp": 1705691842
    },
    {
        "content": "<p>well, from my position I've been building all the wasi:http languages as best I can</p>",
        "id": 416850489,
        "sender_full_name": "Ralph",
        "timestamp": 1705691876
    },
    {
        "content": "<p>I have dan's rust, Joe's go, and Joel's Python implementations of incomingHandler(). So here I am, wanting to make a JavaScript incomingHandler() impl for comparison.</p>",
        "id": 416850660,
        "sender_full_name": "Ralph",
        "timestamp": 1705691928
    },
    {
        "content": "<p>but I couldn't figure out where to get the .js/.ts types for wasi:http</p>",
        "id": 416850711,
        "sender_full_name": "Ralph",
        "timestamp": 1705691948
    },
    {
        "content": "<p>npm install preview2-shim gave them to me, which sure seemed easy to me......</p>",
        "id": 416850888,
        "sender_full_name": "Ralph",
        "timestamp": 1705692007
    },
    {
        "content": "<p>but note, once I have this running I'll be at the point where I need to create a module from the .js (with spidermonkey) and then I can make that module a component.</p>",
        "id": 416851133,
        "sender_full_name": "Ralph",
        "timestamp": 1705692119
    },
    {
        "content": "<p>I think that's where componentizeJS comes in, it should implement the \"make a component out of a js file and spidermonkey\" step</p>",
        "id": 416851291,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1705692174
    },
    {
        "content": "<p>that's what I think, too, but isn't jco component that comment?</p>",
        "id": 416851404,
        "sender_full_name": "Ralph",
        "timestamp": 1705692216
    },
    {
        "content": "<p>command?</p>",
        "id": 416851412,
        "sender_full_name": "Ralph",
        "timestamp": 1705692218
    },
    {
        "content": "<p>because help says that YOU MUST have a component on the argument line</p>",
        "id": 416851447,
        "sender_full_name": "Ralph",
        "timestamp": 1705692231
    },
    {
        "content": "<p>yeah I also was confused, from the docs both implement the same, <span class=\"user-mention\" data-user-id=\"553681\">@Guy Bedford</span> probably needs to answer that</p>",
        "id": 416851558,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1705692256
    },
    {
        "content": "<p>whoops, no, I'm wrong</p>",
        "id": 416851576,
        "sender_full_name": "Ralph",
        "timestamp": 1705692263
    },
    {
        "content": "<p>apologies</p>",
        "id": 416851582,
        "sender_full_name": "Ralph",
        "timestamp": 1705692267
    },
    {
        "content": "<p>It appears I need to: <code>jco componentize -w &lt;path&gt; -o hello-wasi-http-js.wasm index.js</code></p>",
        "id": 416851786,
        "sender_full_name": "Ralph",
        "timestamp": 1705692348
    },
    {
        "content": "<p>transpile takes a component and turns that into browser and node-compatible js, componentize seems to implement the same as componentizeJS does, if going by the docs?</p>",
        "id": 416851793,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1705692351
    },
    {
        "content": "<p>and that should work</p>",
        "id": 416851803,
        "sender_full_name": "Ralph",
        "timestamp": 1705692354
    },
    {
        "content": "<p>yeah, just working over Guy's stuff so I can complain because he and wassim and yosh and others worked so hard</p>",
        "id": 416851927,
        "sender_full_name": "Ralph",
        "timestamp": 1705692386
    },
    {
        "content": "<p>:-)</p>",
        "id": 416851930,
        "sender_full_name": "Ralph",
        "timestamp": 1705692388
    },
    {
        "content": "<p>goint to give this a try</p>",
        "id": 416851973,
        "sender_full_name": "Ralph",
        "timestamp": 1705692404
    },
    {
        "content": "<p>if it works, I'm going to drink and tell Guy it's amazing</p>",
        "id": 416852010,
        "sender_full_name": "Ralph",
        "timestamp": 1705692417
    },
    {
        "content": "<p>it was a weird feeling the first time I ran my own pyo3+python based example in a browser, it's impressive how far the component model has come :)</p>",
        "id": 416852268,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1705692498
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"268586\">@Ralph</span> Do you have your example hosted somewhere? I'm also struggling to know the correct implementation for my incoming request handler response object.</p>",
        "id": 483985273,
        "sender_full_name": "Tylr",
        "timestamp": 1732306945
    },
    {
        "content": "<p>Oh geez, I'll look for it. But I bet <span class=\"user-mention\" data-user-id=\"553681\">@Guy Bedford</span> or <span class=\"user-mention\" data-user-id=\"763150\">@Tomasz Andrzejak</span> has one newer</p>",
        "id": 483985460,
        "sender_full_name": "Ralph",
        "timestamp": 1732307036
    },
    {
        "content": "<p>That was a while back</p>",
        "id": 483985529,
        "sender_full_name": "Ralph",
        "timestamp": 1732307050
    },
    {
        "content": "<p>Thanks, I just found it at <a href=\"https://github.com/squillace/hello-wasi-http\">https://github.com/squillace/hello-wasi-http</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/squillace/hello-wasi-http\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/c24ad6092db1b8b1ba43cef0db13a1d64c5b9833/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333738316666633737383363386533633263656566383634393361313037613033393561663565346336613733373765306639323138396436373035643364652f737175696c6c6163652f68656c6c6f2d776173692d68747470&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/squillace/hello-wasi-http\" title=\"GitHub - squillace/hello-wasi-http: simple repo to demonstrate how to debug Rust wasm components with wasmtime\">GitHub - squillace/hello-wasi-http: simple repo to demonstrate how to debug Rust wasm components with wasmtime</a></div><div class=\"message_embed_description\">simple repo to demonstrate how to debug Rust wasm components with wasmtime - squillace/hello-wasi-http</div></div></div>",
        "id": 483986145,
        "sender_full_name": "Tylr",
        "timestamp": 1732307305
    },
    {
        "content": "<p>Rust is easy</p>",
        "id": 483986243,
        "sender_full_name": "Ralph",
        "timestamp": 1732307352
    },
    {
        "content": "<p>Javascript is FUN</p>",
        "id": 483986253,
        "sender_full_name": "Ralph",
        "timestamp": 1732307359
    },
    {
        "content": "<p>Python is FUN</p>",
        "id": 483986263,
        "sender_full_name": "Ralph",
        "timestamp": 1732307364
    },
    {
        "content": "<p>Rust... Boring</p>",
        "id": 483986274,
        "sender_full_name": "Ralph",
        "timestamp": 1732307371
    },
    {
        "content": "<p>haha yeah, sorry. I copied wrong tab <a href=\"https://github.com/squillace/hello-wasi-http-js\">https://github.com/squillace/hello-wasi-http-js</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/squillace/hello-wasi-http-js\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f0266686e7955ca76fc943c03d8027340704514e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366464653336393363396131393462653535316132343439623866303761616133363139343234303064373936396338333565613631343264636638323366332f737175696c6c6163652f68656c6c6f2d776173692d687474702d6a73&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/squillace/hello-wasi-http-js\" title=\"GitHub - squillace/hello-wasi-http-js: hello world for wasi-http using js and jco\">GitHub - squillace/hello-wasi-http-js: hello world for wasi-http using js and jco</a></div><div class=\"message_embed_description\">hello world for wasi-http using js and jco. Contribute to squillace/hello-wasi-http-js development by creating an account on GitHub.</div></div></div>",
        "id": 483986286,
        "sender_full_name": "Tylr",
        "timestamp": 1732307375
    },
    {
        "content": "<p>That's old</p>",
        "id": 483986560,
        "sender_full_name": "Ralph",
        "timestamp": 1732307470
    },
    {
        "content": "<p>Ill iterate on this and see what I can get</p>",
        "id": 483986561,
        "sender_full_name": "Tylr",
        "timestamp": 1732307470
    },
    {
        "content": "<p>Hope it works</p>",
        "id": 483986577,
        "sender_full_name": "Ralph",
        "timestamp": 1732307478
    },
    {
        "content": "<blockquote>\n<p>That's old<br>\ndo you have a newer example? :D (hope builds)</p>\n</blockquote>",
        "id": 483986625,
        "sender_full_name": "Tylr",
        "timestamp": 1732307497
    },
    {
        "content": "<p>Now a days of ask <span class=\"user-mention\" data-user-id=\"763150\">@Tomasz Andrzejak</span> because he's supposed to teach me how it's done</p>",
        "id": 483986663,
        "sender_full_name": "Ralph",
        "timestamp": 1732307510
    },
    {
        "content": "<p>But I think he's asleep now</p>",
        "id": 483986745,
        "sender_full_name": "Ralph",
        "timestamp": 1732307524
    },
    {
        "content": "<p>Il send a new one soon or get him to do it</p>",
        "id": 483986779,
        "sender_full_name": "Ralph",
        "timestamp": 1732307540
    },
    {
        "content": "<p>But it's Friday night in Europe so I'm buzzed and I'm on my way to drunk</p>",
        "id": 483986849,
        "sender_full_name": "Ralph",
        "timestamp": 1732307567
    },
    {
        "content": "<p>Do forgive me</p>",
        "id": 483986864,
        "sender_full_name": "Ralph",
        "timestamp": 1732307572
    },
    {
        "content": "<p>enjoy your night! thanks <span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span></p>",
        "id": 483988248,
        "sender_full_name": "Tylr",
        "timestamp": 1732308124
    },
    {
        "content": "<p>Hey a bit late, but <code>jco</code> has an examples folder now with some examples that you might found useful:</p>\n<p><a href=\"https://github.com/bytecodealliance/jco/tree/main/examples/components\">https://github.com/bytecodealliance/jco/tree/main/examples/components</a></p>\n<p>There absolutely should be a HTTP hello world example in there as well but there isn't (yet), but you can use the one from wasmcloud as a stand-in!</p>\n<p><a href=\"https://github.com/wasmCloud/wasmCloud/tree/main/examples/typescript/components/http-hello-world\">https://github.com/wasmCloud/wasmCloud/tree/main/examples/typescript/components/http-hello-world</a></p>\n<p>Written in TS, but you can obviously remove the transpilation steps :)</p>\n<p>No need to use wasmCloud either -- if you reference the <code>package.json</code> you can see the jco build command!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/tree/main/examples/components\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/69996b768baddc5d6e6e87fa3b05c88cbedf830f/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653036643133373237386239366233613365343232613961313030356239343030323731396432373466303530636565303738313538626535343139376463362f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/tree/main/examples/components\" title=\"jco/examples/components at main · bytecodealliance/jco\">jco/examples/components at main · bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/wasmCloud/wasmCloud/tree/main/examples/typescript/components/http-hello-world\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/16762fc1438fdc6db4a0ad2e5782897700aa9a1f/68747470733a2f2f7265706f7369746f72792d696d616765732e67697468756275736572636f6e74656e742e636f6d2f3330343430333639322f31643761333062662d366433642d346161312d386663322d333663623031303938346463&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/wasmCloud/wasmCloud/tree/main/examples/typescript/components/http-hello-world\" title=\"wasmCloud/examples/typescript/components/http-hello-world at main · wasmCloud/wasmCloud\">wasmCloud/examples/typescript/components/http-hello-world at main · wasmCloud/wasmCloud</a></div><div class=\"message_embed_description\">wasmCloud is an open source Cloud Native Computing Foundation (CNCF) project that enables teams to build, manage, and scale polyglot apps across any cloud, K8s, or edge. - wasmCloud/wasmCloud</div></div></div>",
        "id": 484280949,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732536202
    },
    {
        "content": "<p>Victor thank you so much!</p>",
        "id": 484337745,
        "sender_full_name": "Tylr",
        "timestamp": 1732550237
    },
    {
        "content": "<p>Maybe im missing so js knowledge, but where do the object definitions come from? I see in the example you linked the type files referenced, but there is no implementation library included. Are these somehow fulfilled by the wasmCloud runtime? Else im not seeing how it would work as is</p>",
        "id": 484426092,
        "sender_full_name": "Tylr",
        "timestamp": 1732590101
    },
    {
        "content": "<p>looks like the preview shim implements them, <a href=\"https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/nodejs/http.js#L605\">https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/nodejs/http.js#L605</a><br>\nbut it isn't in the dependency list of the pkg.json file at <a href=\"https://github.com/wasmCloud/wasmCloud/blob/main/examples/typescript/components/http-hello-world/package.json\">https://github.com/wasmCloud/wasmCloud/blob/main/examples/typescript/components/http-hello-world/package.json</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/nodejs/http.js#L605\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/78ae1ad324b1a4e09506c864aa04a6390220c06d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366231376363316333663761656339646261303639323665386366653533653038643931376233306637666334666331373165353433643636363638663032362f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/nodejs/http.js#L605\" title=\"jco/packages/preview2-shim/lib/nodejs/http.js at main · bytecodealliance/jco\">jco/packages/preview2-shim/lib/nodejs/http.js at main · bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/wasmCloud/wasmCloud/blob/main/examples/typescript/components/http-hello-world/package.json\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/16762fc1438fdc6db4a0ad2e5782897700aa9a1f/68747470733a2f2f7265706f7369746f72792d696d616765732e67697468756275736572636f6e74656e742e636f6d2f3330343430333639322f31643761333062662d366433642d346161312d386663322d333663623031303938346463&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/wasmCloud/wasmCloud/blob/main/examples/typescript/components/http-hello-world/package.json\" title=\"wasmCloud/examples/typescript/components/http-hello-world/package.json at main · wasmCloud/wasmCloud\">wasmCloud/examples/typescript/components/http-hello-world/package.json at main · wasmCloud/wasmCloud</a></div><div class=\"message_embed_description\">wasmCloud is an open source Cloud Native Computing Foundation (CNCF) project that enables teams to build, manage, and scale polyglot apps across any cloud, K8s, or edge. - wasmCloud/wasmCloud</div></div></div>",
        "id": 484427756,
        "sender_full_name": "Tylr",
        "timestamp": 1732591237
    },
    {
        "content": "<p>it looks like jco arg <code>--preview2-adapter &lt;adapter&gt;  provide a custom preview2 adapter path</code> hints that it will fulfill the shim for me, but it isnt happening</p>",
        "id": 484429196,
        "sender_full_name": "Tylr",
        "timestamp": 1732592367
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"782420\">@Tylr</span> sorry a bit late here, but what happens is that <code>jco types</code> will generate a type signature given the WIT interface that is specified/passed in</p>",
        "id": 484445097,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732604227
    },
    {
        "content": "<p>The types that are defined there are a result of building a preview2 component, which adds relevant functionality -- the imports and usage are baked into the binary itself, and when the component is <em>run</em>, they are patched in/used.</p>",
        "id": 484445227,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732604284
    },
    {
        "content": "<p>hmm, I'll keep trying some variations. I get class undefined when using jco serve, or wasmtime serve</p>",
        "id": 484445304,
        "sender_full_name": "Tylr",
        "timestamp": 1732604343
    },
    {
        "content": "<p>So for example, if you run <code>wasmtime serve ...</code> with a component, the wasmtime script is responsible for <em>adding</em> the implementations of preview2 APIs. </p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L316\">https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L316</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L316\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/297e6f5b492b8a45ee184bf230a78ad05bfc9f97/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626166663033353730623234356464616438633937333637313736386666636666653562393839666661393538326238366332663861356561316565336132332f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/src/commands/serve.rs#L316\" title=\"wasmtime/src/commands/serve.rs at main · bytecodealliance/wasmtime\">wasmtime/src/commands/serve.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A fast and secure runtime for WebAssembly. Contribute to bytecodealliance/wasmtime development by creating an account on GitHub.</div></div></div>",
        "id": 484445318,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732604352
    },
    {
        "content": "<p>Hmnn that's really odd -- could you post the error/a repo I can poke around in, if it's something you can share?</p>",
        "id": 484445368,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732604388
    },
    {
        "content": "<p>yes, one sec, switching computers</p>",
        "id": 484445477,
        "sender_full_name": "Tylr",
        "timestamp": 1732604416
    },
    {
        "content": "<p>Also, doing it in pure JS might be the easiest way to start -- this is something we don't have an example for on the JCO side but it would certainly reduce complexity to start -- would be great if you could contribute that after we're done tinkering</p>",
        "id": 484445708,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732604532
    },
    {
        "content": "<p>i had started with just js, but kept getting errors and the same class undefined</p>",
        "id": 484446315,
        "sender_full_name": "Tylr",
        "timestamp": 1732604846
    },
    {
        "content": "<p>the current state; <a href=\"https://github.com/tylerhjones/wasm-lambda\">https://github.com/tylerhjones/wasm-lambda</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tylerhjones/wasm-lambda\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/2b0eb812b8bba361e0b9daf077dad3c2138abe73/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616266613339303665633035356166303762643432613336656231333939633930383963363131353536643837373632353232396330623464336262323231652f74796c6572686a6f6e65732f7761736d2d6c616d626461&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tylerhjones/wasm-lambda\" title=\"GitHub - tylerhjones/wasm-lambda\">GitHub - tylerhjones/wasm-lambda</a></div><div class=\"message_embed_description\">Contribute to tylerhjones/wasm-lambda development by creating an account on GitHub.</div></div></div>",
        "id": 484446412,
        "sender_full_name": "Tylr",
        "timestamp": 1732604886
    },
    {
        "content": "<p>i reset back to the same setup you had in the example, but ive broken / missed something still and get an error from wizer.</p>",
        "id": 484447463,
        "sender_full_name": "Tylr",
        "timestamp": 1732605484
    },
    {
        "content": "<p>Hey cranking on it right now</p>",
        "id": 484447592,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732605559
    },
    {
        "content": "<p>Will have a PR up to your repo soon that details how to get everything set up!</p>",
        "id": 484447611,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732605567
    },
    {
        "content": "<p>appreciate  the help, but ive gotta sleep <span aria-label=\"smiling face with tear\" class=\"emoji emoji-1f972\" role=\"img\" title=\"smiling face with tear\">:smiling_face_with_tear:</span> ill have to check in again in the morning</p>",
        "id": 484449079,
        "sender_full_name": "Tylr",
        "timestamp": 1732606322
    },
    {
        "content": "<p>No worries! Will make the PR and put it up to your repo :)</p>",
        "id": 484449131,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732606333
    },
    {
        "content": "<p>Not sure if you're still up but done:</p>\n<p><a href=\"https://github.com/tylerhjones/wasm-lambda/pull/1\">https://github.com/tylerhjones/wasm-lambda/pull/1</a></p>\n<p>Works on my machine <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tylerhjones/wasm-lambda/pull/1\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/07bb54edc7588554825fce12c261f1efb3177af2/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613834393166343335613631653033663336313137616663383262353765336233613863346633373835363364326336313633383731333765643239643031352f74796c6572686a6f6e65732f7761736d2d6c616d6264612f70756c6c2f31&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tylerhjones/wasm-lambda/pull/1\" title=\"refactor: fill out working example by vados-cosmonic · Pull Request #1 · tylerhjones/wasm-lambda\">refactor: fill out working example by vados-cosmonic · Pull Request #1 · tylerhjones/wasm-lambda</a></div><div class=\"message_embed_description\">This commit adds a working example of a HTTP handler and some docs to go with it.</div></div></div>",
        "id": 484451712,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732607549
    },
    {
        "content": "<p>When i try to componentize the js target I get an error about a duplicate export,</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">js_wasm_lambda</span><span class=\"o\">@</span><span class=\"mf\">1.0.0</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"p\">:</span><span class=\"nc\">js</span>\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">jco</span><span class=\"w\"> </span><span class=\"n\">componentize</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">world</span><span class=\"o\">-</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">dist</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">dist</span><span class=\"o\">/</span><span class=\"n\">index</span><span class=\"p\">.</span><span class=\"n\">js</span>\n\n<span class=\"p\">(</span><span class=\"n\">jco</span><span class=\"w\"> </span><span class=\"n\">componentize</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ComponentError</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">module</span>\n<span class=\"cp\">$failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">validate</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">output</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">duplicate</span><span class=\"w\"> </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"mi\">39</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mh\">0xab351c</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">componentNew</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">:</span><span class=\"sd\">///app/node_modules/@bytecodealliance/jco/obj/wasm-tools.js:3618:11)</span>\n</code></pre></div>",
        "id": 484614392,
        "sender_full_name": "Tylr",
        "timestamp": 1732664534
    },
    {
        "content": "<p>If I add code to the jco src/api.js <code>componentNew</code> function and have it write the given binary to a file and use wasm-tools after to inspect the binary it received as an argument, I see the following exports.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"memory\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"wizer.initialize\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"mi\">145</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"wizer.resume\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"mi\">146</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"cabi_realloc\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"mi\">5062</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"wasi:cli/run@0.2.2#run\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"mi\">260</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"wasi:http/incoming-handler@0.2.2#handle\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"mi\">261</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"cabi_realloc_adapter\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"mi\">5061</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"check_init\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"mi\">5068</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"wasi:http/incoming-handler@0.2.0#handle\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">incoming</span><span class=\"o\">-</span><span class=\"n\">handler</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">#</span><span class=\"n\">handle</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"cabi_post_wasi:http/incoming-handler@0.2.0#handle\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$post_wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">incoming</span><span class=\"o\">-</span><span class=\"n\">handler</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">#</span><span class=\"n\">handle</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>im guessing the conflicts is from this cabi_post_wasi? Im not sure what else would be in conflict.</p>",
        "id": 484616471,
        "sender_full_name": "Tylr",
        "timestamp": 1732665847
    },
    {
        "content": "<p>Are we componentizing with exactly the same code and getting different output? Did you add some code to what the PR had?</p>",
        "id": 484635689,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732679224
    },
    {
        "content": "<p>I'm using what is on master, which again can see is the exact same</p>",
        "id": 484636043,
        "sender_full_name": "Tylr",
        "timestamp": 1732679488
    },
    {
        "content": "<p>again* -&gt; afaict</p>",
        "id": 484735945,
        "sender_full_name": "Tylr",
        "timestamp": 1732718220
    },
    {
        "content": "<p>I'll check again this morning, maybe I've changed a line accidentally in merge</p>",
        "id": 484736250,
        "sender_full_name": "Tylr",
        "timestamp": 1732718306
    },
    {
        "content": "<p>Oh you know what -- what version of node are you using? Could you post your Node and NPM versions?</p>",
        "id": 484743059,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732720263
    },
    {
        "content": "<p>And also if you're running on windows or not -- it shouldn't matter too much but I'm just assuming macbook + some version of Node &amp; NPM</p>",
        "id": 484743325,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732720336
    },
    {
        "content": "<p>23<br>\n<a href=\"https://github.com/tylerhjones/wasm-lambda/blob/main/Dockerfile#L2\">https://github.com/tylerhjones/wasm-lambda/blob/main/Dockerfile#L2</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/tylerhjones/wasm-lambda/blob/main/Dockerfile#L2\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/ccc426e6215b354c620e88df62bd37ace1d54046/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376335393266643966343534623466663264323536373963383032643036353665376136326434313163303331653366613135366132353865303330633134382f74796c6572686a6f6e65732f7761736d2d6c616d626461&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/tylerhjones/wasm-lambda/blob/main/Dockerfile#L2\" title=\"wasm-lambda/Dockerfile at main · tylerhjones/wasm-lambda\">wasm-lambda/Dockerfile at main · tylerhjones/wasm-lambda</a></div><div class=\"message_embed_description\">Contribute to tylerhjones/wasm-lambda development by creating an account on GitHub.</div></div></div>",
        "id": 484743334,
        "sender_full_name": "Tylr",
        "timestamp": 1732720339
    },
    {
        "content": "<p>That is your problem! Please try using stable node!</p>",
        "id": 484743476,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732720384
    },
    {
        "content": "<p><span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>oh</p>",
        "id": 484743541,
        "sender_full_name": "Tylr",
        "timestamp": 1732720404
    },
    {
        "content": "<p>I think I saw this during wasmcon/kubecon just last week -- please try Node 22 -- if you're using <code>nvm</code> then the <code>.nvmrc</code>in there</p>",
        "id": 484743548,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732720406
    },
    {
        "content": "<p>I'll try with 22.<br>\nI have nvm, but wanted to keep with docker so I can use the image as a build agent on Jenkins.</p>",
        "id": 484743755,
        "sender_full_name": "Tylr",
        "timestamp": 1732720471
    },
    {
        "content": "<p>Don't worry -- this is absolutely a new failure mode, I <em>think</em> this is what I saw just a week or two ago in person and me (and the person who ran into it) were VERY stumped. We were getting weird errors from <code>npm</code> itself about not detecting terminal colors right, and there were odd errors -- even versions of <code>node</code> are stable, so if you wouldn't mind trying that it <em>might just work</em></p>",
        "id": 484743758,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732720472
    },
    {
        "content": "<p>Ah you can use docker as well, that's totally fine -- as long as you use Node 22 however you'd like!</p>",
        "id": 484743805,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732720488
    },
    {
        "content": "<p>if it solves the issue we might have to do something upstream to try and prevent/control this -- we've had this discussion before and were expecting node to be pretty good about maintaining compat/stuff not breaking underneath us... But if it has, then we've just run into an exception case very quickly :)</p>",
        "id": 484743946,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732720531
    },
    {
        "content": "<p>I'll swap it out and try in abt 20min, not by the computer right now.</p>",
        "id": 484744068,
        "sender_full_name": "Tylr",
        "timestamp": 1732720563
    },
    {
        "content": "<p>had some other delays, but I swapped to node 22 and it didn't fix it.<br>\ni switched to <code>pnpm</code> instead of using <code>npm</code>, rm'd the node_modules and lock file and it worked.<br>\nThere is some dependency resolution difference from pnpm and npm, but im not seeing in from the pnpm-lock vs package-lock</p>",
        "id": 484764236,
        "sender_full_name": "Tylr",
        "timestamp": 1732726971
    },
    {
        "content": "<p>ill evaluate the two files in more detail later today and see which versions do not match</p>",
        "id": 484764373,
        "sender_full_name": "Tylr",
        "timestamp": 1732727028
    },
    {
        "content": "<p>ah,</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">      </span><span class=\"o\">'@</span><span class=\"n\">bytecodealliance</span><span class=\"o\">/</span><span class=\"n\">jco</span><span class=\"o\">'</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"nc\">specifier</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">^</span><span class=\"mf\">1.7.0</span>\n<span class=\"w\">        </span><span class=\"n\">version</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">1.8.1</span>\n</code></pre></div>\n<p>while npm picked</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"s\">\"node_modules/@bytecodealliance/jco\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">      </span><span class=\"s\">\"version\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"1.7.2\"</span><span class=\"p\">,</span>\n</code></pre></div>",
        "id": 484764829,
        "sender_full_name": "Tylr",
        "timestamp": 1732727174
    },
    {
        "content": "<p>so for this example, jco must be ^1.8</p>",
        "id": 484765546,
        "sender_full_name": "Tylr",
        "timestamp": 1732727416
    },
    {
        "content": "<p>Ah OK, so an old JCO version was the issue? thanks for debugging this!</p>",
        "id": 484765723,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1732727487
    },
    {
        "content": "<p>thanks for the example and help.<br>\nyes an older jco version is the issue. If I update the pkg json to specify ^1.8<br>\n<code>\"@bytecodealliance/jco\": \"^1.8.1\",</code><br>\nthe example works with npm and node 22 (didnt rebuild image with 23, ill stay with 22 as its the 'active' version <a href=\"https://nodejs.org/en/about/previous-releases\">https://nodejs.org/en/about/previous-releases</a>)</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://nodejs.org/en/about/previous-releases\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/ae7c6e7ccee49fbeb73ebc4050341b98ce19a179/68747470733a2f2f6e6f64656a732e6f72672f656e2f6e6578742d646174612f6f672f616e6e6f756e63656d656e742f52756e2532304a61766153637269707425323045766572797768657265&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://nodejs.org/en/about/previous-releases\" title=\"Node.js — Node.js Releases\">Node.js — Node.js Releases</a></div><div class=\"message_embed_description\">Node.js® is a JavaScript runtime built on Chrome's V8 JavaScript engine.</div></div></div>",
        "id": 484766251,
        "sender_full_name": "Tylr",
        "timestamp": 1732727674
    },
    {
        "content": "<p>Hello! I'm having trouble using <code>fetch</code> in a wasm component that is invoked in the browser. Have any of y'all been able to do this successfully with the <a href=\"https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45\">brower wasi-preview2 shim</a>?</p>\n<p>Roughly, here's what I have</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// world.wit</span>\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">jcofetch</span><span class=\"p\">:</span><span class=\"nc\">hello</span><span class=\"p\">;</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">ping</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">func</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">string</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">string</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>And my component written in js which I componentize and transpile using <code>jco transpile --map 'wasi-*=@bytecodealliance/preview2-shim/*'</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">ping</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">url</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">URL</span><span class=\"p\">(</span><span class=\"s\">\"https://jsonplaceholder.typicode.com/posts/1\"</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">await</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">await</span><span class=\"w\"> </span><span class=\"n\">fetch</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">)).</span><span class=\"n\">json</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">hello</span><span class=\"p\">:</span><span class=\"cp\">$</span><span class=\"p\">{</span><span class=\"n\">s</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"p\">{</span><span class=\"n\">JSON</span><span class=\"p\">.</span><span class=\"n\">stringify</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">)}</span><span class=\"err\">`</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>My entrypoint <code>index.js</code>:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"k\">import</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nx\">ping</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"kr\">from</span><span class=\"w\"> </span><span class=\"s2\">\"../gen/hello/hello.component.js\"</span><span class=\"p\">;</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">ping</span><span class=\"p\">(</span><span class=\"s2\">\"ping\"</span><span class=\"p\">));</span>\n</code></pre></div>\n<p>Which gets bundled using esbuild and embeded in my <code>index.html</code> with</p>\n<div class=\"codehilite\" data-code-language=\"HTML\"><pre><span></span><code>  <span class=\"p\">&lt;</span><span class=\"nt\">script</span> <span class=\"na\">type</span><span class=\"o\">=</span><span class=\"s\">\"module\"</span> <span class=\"na\">src</span><span class=\"o\">=</span><span class=\"s\">\"bundle.js\"</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">script</span><span class=\"p\">&gt;</span>\n</code></pre></div>\n<p>I get the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">bundle</span><span class=\"p\">.</span><span class=\"n\">js</span><span class=\"p\">:</span><span class=\"mi\">992</span><span class=\"w\"> </span><span class=\"n\">Uncaught</span><span class=\"w\"> </span><span class=\"n\">TypeError</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Fields</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">constructor</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">trampoline7</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bundle</span><span class=\"p\">.</span><span class=\"n\">js</span><span class=\"p\">:</span><span class=\"mi\">992</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x227f6</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x58cdd</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x4dca8</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x253c4c</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x24d4a7</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x24544f</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x253b12</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x25487d</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"p\">.</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">core</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"p\">:</span><span class=\"mh\">0x2d4bef</span>\n</code></pre></div>\n<p>I wonder if there's something missing in the wasi preview2-shim for the browser... <a href=\"https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45\">https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45</a></p>\n<p>Any help (or pointers for how I can contribute upstream) would be really appreciated! <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/14b57f268bfd1f3d518146f94a35e10021faf29d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333431303262636237643033626633396530343763626265653830316639643136386532313937343535613538613437333361323639346666333537636562382f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/blob/fe90d2ff0af2fc43d42002373e3edb9f892d7f53/packages/preview2-shim/lib/browser/http.js#L35-L45\" title=\"jco/packages/preview2-shim/lib/browser/http.js at fe90d2ff0af2fc43d42002373e3edb9f892d7f53 · bytecodealliance/jco\">jco/packages/preview2-shim/lib/browser/http.js at fe90d2ff0af2fc43d42002373e3edb9f892d7f53 · bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>",
        "id": 490280389,
        "sender_full_name": "Thomas Wang",
        "timestamp": 1734770410
    },
    {
        "content": "<p>FWIW I got a different pure \"cowsay\" component (no wasi imports) to run in the browser using this bundler setup, so I suspect it's an underlying issue in the shim</p>",
        "id": 490280670,
        "sender_full_name": "Thomas Wang",
        "timestamp": 1734770707
    }
]