[
    {
        "content": "<p>kubkon edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 194902397,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587545147
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 194909347,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587549172
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 195322730,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587887440
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401297787\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401297787\">PR Review</a>.</p>",
        "id": 195476263,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588022259
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401297787\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401297787\">PR Review</a>.</p>",
        "id": 195476264,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588022259
    },
    {
        "content": "<p>pchickey created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416149497\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416149497\">PR Review Comment</a>:</p>\n<blockquote>\n<p>This is maybe a comment for the PR that introduced <code>Handle</code>, but if instead of having an <code>as_any(&amp;self) -&gt; &amp;dyn Any</code>, the <code>Handle</code> trait instead depended on <code>Any</code>, then you could drop that trivial method, and also this <code>'static' constraint, because </code>Any<code> implies </code>'static`.</p>\n</blockquote>",
        "id": 195476266,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588022259
    },
    {
        "content": "<p>pchickey created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416122367\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416122367\">PR Review Comment</a>:</p>\n<blockquote>\n<p>I think its pretty dangerous to panic here - instead, can we return a Result, so we can bubble this error outwards without crashing?</p>\n</blockquote>",
        "id": 195476267,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588022259
    },
    {
        "content": "<p>pchickey created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416154967\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416154967\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Can you leave a comment specifically on why we have to handle the tty and non-tty cases separately? Whether <code>io::stdout()</code> gives us a tty or not depends on how the embedding process is invoked, right? Is there any way to avoid exposing that to the guest?</p>\n</blockquote>",
        "id": 195476268,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588022259
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401853025\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401853025\">PR Review</a>.</p>",
        "id": 195566317,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588081703
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416627626\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416627626\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Agreed! I'll redo it returning a <code>Result</code> instead as suggested :-)</p>\n</blockquote>",
        "id": 195566318,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588081703
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401853874\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401853874\">PR Review</a>.</p>",
        "id": 195566432,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588081756
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416628328\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416628328\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Oh nice, I didn't think of that! Lemme give it a spin and report back. Oh, and thanks for the suggestion!</p>\n</blockquote>",
        "id": 195566433,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588081756
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401858527\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401858527\">PR Review</a>.</p>",
        "id": 195567034,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588082035
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416631961\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416631961\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Yeah, that's correct. I actually need to revisit at some point, but the reason we ended up with custom <code>Stdio</code> type which is a proxy for Rust's stdio handles, is because Windows was doing some crazy stdio redirects on the CI which were nontrivial to handle. I'll add some comments about for posterity. Thanks for spotting that one!</p>\n</blockquote>",
        "id": 195567035,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588082035
    },
    {
        "content": "<p>iximeow submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401994192\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401994192\">PR Review</a>.</p>",
        "id": 195587408,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090259
    },
    {
        "content": "<p>iximeow created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416741253\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416741253\">PR Review Comment</a>:</p>\n<blockquote>\n<p><em>drops in</em> This is just a <code>&amp;File -&gt; ManuallyDrop&lt;File&gt;</code> conversion, right? You ought to be able to remove this line (and the <code>AsFile</code> impl above, it seems?</p>\n</blockquote>",
        "id": 195587410,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090260
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 195587480,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090288
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401997524\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401997524\">PR Review</a>.</p>",
        "id": 195587980,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090499
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416744081\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416744081\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Ah, well spotted, thanks!</p>\n<p>As far as the <code>AsFile</code> impl goes, this blanket impl is needed so that any type that wraps <code>OsHandle</code> (which itself implements <code>AsRawFd</code>) to be able to convert automatically to <code>std::fs::File</code>.</p>\n</blockquote>",
        "id": 195587982,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090500
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401998128\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-401998128\">PR Review</a>.</p>",
        "id": 195588077,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090540
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416744560\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416744560\">PR Review Comment</a>:</p>\n<blockquote>\n<p>That's why, if you look closely, the impl goes for any <code>T: AsRawFd</code>.</p>\n</blockquote>",
        "id": 195588078,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090540
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 195588225,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090595
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402000359\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402000359\">PR Review</a>.</p>",
        "id": 195588477,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090691
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416746482\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416746482\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Done in 26c894a.</p>\n</blockquote>",
        "id": 195588479,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090691
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402000765\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402000765\">PR Review</a>.</p>",
        "id": 195588527,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090719
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416746834\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r416746834\">PR Review Comment</a>:</p>\n<blockquote>\n<p>The line removed in 5b7e54e BTW.</p>\n</blockquote>",
        "id": 195588528,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588090719
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402497394\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402497394\">PR Review</a>.</p>",
        "id": 195681419,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588152112
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417179216\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417179216\">PR Review Comment</a>:</p>\n<blockquote>\n<p>OK, so after some careful analysis, I believe we'll still require <code>as_any(&amp;self) -&gt; &amp;dyn Any</code> method defined in each implementor of the <code>Handle</code> trait. Here's the breakout of the reasons I discovered:</p>\n<ol>\n<li>vtables in Rust currently do not permit for trait upcasting (see <a href=\"https://articles.bchlr.de/traits-dynamic-dispatch-upcasting\" title=\"https://articles.bchlr.de/traits-dynamic-dispatch-upcasting\">here</a> and <a href=\"https://github.com/rust-lang/rust/pull/60900\" title=\"https://github.com/rust-lang/rust/pull/60900\">here</a>). This then implies that, even if <code>Handle: Any</code>, we can't go from <code>dyn Handle</code> to <code>dyn Any</code>.</li>\n<li>Even if we added the constraint <code>Handle: Any</code> and made <code>as_any(&amp;self) -&gt; &amp;dyn Any</code> a provided method, we'd still need to require that, at the very least, for <code>as_any(...)</code> <code>Self: Sized</code>. But then, <code>as_any(...)</code> is not available for <code>dyn Handle</code> trait object.</li>\n</ol>\n<p>All in all, requiring <code>Any</code> on <code>Handle</code> seems to only get rid of the <code>'static</code> requirement in the referenced <code>impl AsFile</code> which I don't think is worth it? Lemme know what you think! Maybe there's something obvious that I missed and this will actually work, or perhaps I misunderstood what you meant! :-)</p>\n</blockquote>",
        "id": 195681420,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588152112
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417188079\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417188079\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Just clarify further, as far as the guest is concerned, <code>Stdio</code> should be transparent to them. As I mentioned above, the only reason we have a separate <code>Stdio</code> type in <code>wasi-common</code> is to correctly facilitate redirects on Windows. To elaborate further, in POSIX, we can get a stdio handle by opening a specific fd <code>{0,1,2}</code>. On Windows however, we need to issue a syscall that's separate from standard Windows \"open\" to get a console handle, and this is <a href=\"https://docs.microsoft.com/en-us/windows/console/getstdhandle\" title=\"https://docs.microsoft.com/en-us/windows/console/getstdhandle\"><code>GetStdHandle</code></a>. This is exactly what Rust does and what is wrapped inside their <code>Stdio</code> object in the <code>libstd</code>. We wrap it here as well because of this nuance on Windows:</p>\n<blockquote>\n<p>The standard handles of a process may be redirected by a call to SetStdHandle, in which case GetStdHandle returns the redirected handle.</p>\n</blockquote>\n<p>The <a href=\"https://docs.microsoft.com/en-us/windows/console/getstdhandle\" title=\"https://docs.microsoft.com/en-us/windows/console/getstdhandle\">MSDN</a> also says this however:</p>\n<blockquote>\n<p>If the standard handles have been redirected, you can specify the CONIN$ value in a call to the CreateFile function to get a handle to a console's input buffer. Similarly, you can specify the CONOUT$ value to get a handle to a console's active screen buffer.</p>\n</blockquote>\n<p>But I'm not that well versed in Windows programming to know how to do this properly, which is not to say we shouldn't (re-)investigate at some point.</p>\n<p>Anyway, do you think this explanation would do here? Oh, and as far as the check for <code>TTY</code> goes, I'm actually not sure what to do here. I'm not sure whether the handle returned by <code>GetStdHandle</code> will be treated like a <code>TTY</code>. I guess we should investigate further, but I'd vouch for leaving a TODO comment in and do it in a subsequent PR?</p>\n</blockquote>",
        "id": 195683051,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588153070
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402508430\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402508430\">PR Review</a>.</p>",
        "id": 195683053,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588153070
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 195685337,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588154223
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402521873\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-402521873\">PR Review</a>.</p>",
        "id": 195685383,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588154247
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417198843\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417198843\">PR Review Comment</a>:</p>\n<blockquote>\n<p>OK, after careful analysis, I think we can remove the check and _always_ santise the output to <code>stdout</code> since <code>is_tty</code> will always resolve to true for <code>Stdio</code> handle type. However, I think we need to keep the check in case of <code>OsOther</code> handle type which can encapsulate user-specified handle to redirected stdio. I'm thinking here of piping and mainly on Unix, but perhaps it might also be possible on Windows.</p>\n<p>I've done that now in f76e7c4.</p>\n</blockquote>",
        "id": 195685385,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588154248
    },
    {
        "content": "<p><strong>kubkon</strong> requested <a href=\"https://github.com/alexcrichton\" title=\"https://github.com/alexcrichton\">alexcrichton</a>, <a href=\"https://github.com/pchickey\" title=\"https://github.com/pchickey\">pchickey</a>, <a href=\"https://github.com/peterhuene\" title=\"https://github.com/peterhuene\">peterhuene</a> and <a href=\"https://github.com/sunfishcode\" title=\"https://github.com/sunfishcode\">sunfishcode</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a>.</p>",
        "id": 195770891,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588194804
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403098669\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403098669\">PR Review</a>.</p>",
        "id": 195780655,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588201266
    },
    {
        "content": "<p>pchickey created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417661606\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417661606\">PR Review Comment</a>:</p>\n<blockquote>\n<p>I had no idea that trait upcasting was not allowed. That is a bummer and a sufficient reason for this design.</p>\n</blockquote>",
        "id": 195780657,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588201266
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403101098\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403101098\">PR Review</a>.</p>",
        "id": 195781154,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588201664
    },
    {
        "content": "<p>pchickey created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417663791\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417663791\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Thanks, I understand this a lot better now. Thanks for the explanation and adding it to the docs!</p>\n</blockquote>",
        "id": 195781155,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588201665
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403101291\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403101291\">PR Review</a>.</p>",
        "id": 195781228,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588201699
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403317233\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-403317233\">PR Review</a>.</p>",
        "id": 195811613,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588236080
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417849999\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r417849999\">PR Review Comment</a>:</p>\n<blockquote>\n<p>I didn't either, so thanks for prodding me to have a look! :-)</p>\n</blockquote>",
        "id": 195811614,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588236080
    },
    {
        "content": "<p>sunfishcode submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404446669\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404446669\">PR Review</a>.</p>",
        "id": 196023891,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404446669\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404446669\">PR Review</a>.</p>",
        "id": 196023892,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778444\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778444\">PR Review Comment</a>:</p>\n<blockquote>\n<p>And <code>stderr</code> here?</p>\n</blockquote>",
        "id": 196023893,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418783655\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418783655\">PR Review Comment</a>:</p>\n<blockquote>\n<p>How difficult would it be to split this enum out into three separate structs that all implement the <code>Handle</code> trait independently? Besides the additional dynamic dispatch inside the <code>read</code> and <code>write</code> methods, I think that'd really illustrate how this <code>Handle</code> trait works -- every different kind of stream has its own impl. There'd be some duplication in the other methods, but it seems like that could be factored out with helper methods. </p>\n</blockquote>",
        "id": 196023894,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778417\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778417\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Should this be <code>stdout</code>?</p>\n</blockquote>",
        "id": 196023895,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418779246\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418779246\">PR Review Comment</a>:</p>\n<blockquote>\n<p>This can be written as <code>Self::In { rights } | Self::Out { rights } | Self::Err { rights } =&gt; rights.get(),</code>, and similar in <code>set_rights</code>.</p>\n</blockquote>",
        "id": 196023896,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778968\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418778968\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Stdio won't always be a character device, such as when it's redirected from a file (\"grep foo &lt; file.txt\") or a pipe (\"cat file.txt | grep foo\"). We still need to do <code>fstat</code> on it to determine its type.</p>\n</blockquote>",
        "id": 196023897,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418784914\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418784914\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Should <code>OsHandle</code> have a name with <code>Raw</code> in it, since it wraps a <code>RawFd</code>/<code>RawHandle</code>? Maybe <code>RawOSHandle</code>?</p>\n</blockquote>",
        "id": 196023898,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418784679\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418784679\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Can you add a comment here briefly explaining what <code>OsOther</code> is?</p>\n</blockquote>",
        "id": 196023899,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418787377\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418787377\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Why does this use <code>OsOther</code> here? Looking at the code, that seems to be for things that aren't files.</p>\n</blockquote>",
        "id": 196023900,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418786597\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418786597\">PR Review Comment</a>:</p>\n<blockquote>\n<p>If I understand correctly, the main use for <code>update_from</code> is for the <code>fdstat_set_flags</code>, which on Windows opens a new handle. If that's the only thing that needs it, could we make <code>update_from</code> on Unix just panic?</p>\n<p>And, if we don't need to implement <code>update_from</code>, can <code>OsHandle</code> on Unix hold a plain <code>RawFd</code> instead of a <code>Cell&lt;RawFd&gt;</code>?</p>\n</blockquote>",
        "id": 196023901,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588379051
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506427\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506427\">PR Review</a>.</p>",
        "id": 196037809,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403039
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923344\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923344\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Oh shoot, you're absolutely correct, thanks for spotting it!</p>\n</blockquote>",
        "id": 196037810,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403039
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506468\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506468\">PR Review</a>.</p>",
        "id": 196037855,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403093
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923439\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923439\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Likewise here! Makes me start questioning our test suite. Then again, I'm not sure if there will be an obvious way of verifying stdio handles in the CI.</p>\n</blockquote>",
        "id": 196037856,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403094
    },
    {
        "content": "<p>kubkon edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923439\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923439\">PR Review Comment</a>.</p>",
        "id": 196037858,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403102
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506724\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506724\">PR Review</a>.</p>",
        "id": 196037981,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403384
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923851\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923851\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Right, however, here, I think it's safe to assume that our internal <code>Stdio</code> type will always be a character device since it is meant to be a wrapper for Rust's stdio primitives. I envisioned that redirections should be handled by a separate entity in the codebase, namely, <code>OsOther</code> which is something like a catch-all for everything not covered with the specific handle types. Does that make sense? In fact, that's why in <code>ctx.rs</code> we map <code>std::fs::File</code> to <code>OsOther</code> as currently we only ever permit specifying custom fds/handles for stdio when builing the context.</p>\n</blockquote>",
        "id": 196037982,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403384
    },
    {
        "content": "<p>kubkon edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923851\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923851\">PR Review Comment</a>.</p>",
        "id": 196037986,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403402
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506751\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506751\">PR Review</a>.</p>",
        "id": 196038024,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403426
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923898\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418923898\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Ah excellent, thanks!</p>\n</blockquote>",
        "id": 196038025,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403426
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506867\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404506867\">PR Review</a>.</p>",
        "id": 196038072,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403567
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924107\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924107\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Oh right, sure thing!</p>\n</blockquote>",
        "id": 196038073,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403567
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 196038135,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403757
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507081\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507081\">PR Review</a>.</p>",
        "id": 196038178,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403833
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924471\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924471\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Hmm, I think this should be fine. It will require some additional tweaks to <code>WasiCtxBuilder</code> but nothing major I think.</p>\n</blockquote>",
        "id": 196038179,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403833
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507136\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507136\">PR Review</a>.</p>",
        "id": 196038244,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403901
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924573\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924573\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Makes sense!</p>\n</blockquote>",
        "id": 196038245,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403901
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507163\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404507163\">PR Review</a>.</p>",
        "id": 196038250,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403932
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924611\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r418924611\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Oh, see my reply to your comment about <code>Stdio</code> :-)</p>\n</blockquote>",
        "id": 196038251,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588403932
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 196071060,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588455206
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404562434\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404562434\">PR Review</a>.</p>",
        "id": 196071114,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588455261
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419010783\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419010783\">PR Review Comment</a>:</p>\n<blockquote>\n<p>OK, I've separated it out into 3 standalone structs: <code>Stdin</code>, <code>Stdout</code> and <code>Stderr</code>.</p>\n</blockquote>",
        "id": 196071115,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588455262
    },
    {
        "content": "<p>kubkon edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419010783\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419010783\">PR Review Comment</a>.</p>",
        "id": 196071122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588455272
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404562563\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404562563\">PR Review</a>.</p>",
        "id": 196071197,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588455393
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419011014\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419011014\">PR Review Comment</a>:</p>\n<blockquote>\n<p>In order to clear it up a little bit, I've renamed <code>PendingEntry::File</code> to <code>PendingEntry::OsHandle</code>. This naming was somewhat confusing since the <code>File</code> in this case represented for instance a pipe which we then used in place of a stdio handle. Oh and this is precisely why we use <code>OsOther</code> here instead of an <code>OsFile</code>, since the former is meant to represent pipes as well, whereas the latter only regular files.</p>\n</blockquote>",
        "id": 196071198,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588455393
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 196145652,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588575062
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404742344\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404742344\">PR Review</a>.</p>",
        "id": 196145975,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588575374
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419241485\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419241485\">PR Review Comment</a>:</p>\n<blockquote>\n<p>OK, it's done now. Since, as you rightly pointed out in one of the comments above, we don't really need interior mutability on *nix wrt the inner <code>RawFd</code> instance, I've also replaced <code>RawFd</code> with <code>File</code> instance which takes care of a couple of ownership related things for us. I believe this is what @iximeow was suggesting all along as well. Now that @sunfishcode pointed out that issuing <code>RawOsHandle::update_from</code> call on *nix is a bug, using <code>File</code> was now possible.</p>\n</blockquote>",
        "id": 196145976,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588575374
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 196147434,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588576517
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404751476\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-404751476\">PR Review</a>.</p>",
        "id": 196147517,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588576564
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419248601\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419248601\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 196147518,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588576565
    },
    {
        "content": "<p><strong>kubkon</strong> requested <a href=\"https://github.com/alexcrichton\" title=\"https://github.com/alexcrichton\">alexcrichton</a>, <a href=\"https://github.com/peterhuene\" title=\"https://github.com/peterhuene\">peterhuene</a> and <a href=\"https://github.com/sunfishcode\" title=\"https://github.com/sunfishcode\">sunfishcode</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a>.</p>",
        "id": 196235936,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588624214
    },
    {
        "content": "<p>sunfishcode submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405343640\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405343640\">PR Review</a>.</p>",
        "id": 196239560,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588626048
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419725489\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419725489\">PR Review Comment</a>:</p>\n<blockquote>\n<p>The logic for flushing Rust's stdout buffer is in the <code>Stdout</code> implementation here, and we need that for files too. I expect we're always going to want to use <code>Stdout</code> for stdout, even when it's attached to a file, in order to ensure that we always stay in sync with Rust's stdout.</p>\n</blockquote>",
        "id": 196239561,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588626048
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405347964\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405347964\">PR Review</a>.</p>",
        "id": 196240266,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588626438
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419729048\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419729048\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Hmm, I'm a little bit confused here. We cannot create a <code>std::io::Stdout</code> instance from a raw file descriptor, so I'm not sure we can ever enforce that we always use <code>sys::stdio::Stdout</code> for stdout. I think we could probably think of extracting <code>PipedStdout</code> or something from <code>OsOther</code> that would have <code>RawFd</code>/<code>RawHandle</code> attached to it.</p>\n</blockquote>",
        "id": 196240267,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588626438
    },
    {
        "content": "<p>kubkon edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419729048\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419729048\">PR Review Comment</a>.</p>",
        "id": 196240863,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588626807
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405353137\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405353137\">PR Review</a>.</p>",
        "id": 196241068,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588626937
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419733289\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419733289\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Oh, wait, I think I get it now. If the OS redirects the stdio handles, Rust's <code>Stdout</code> will use the redirected <code>RawFd</code> underneath, and this one doesn't necessarily have to be a character device. Is that what you meant?</p>\n</blockquote>",
        "id": 196241069,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588626937
    },
    {
        "content": "<p>kubkon edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419733289\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419733289\">PR Review Comment</a>.</p>",
        "id": 196241189,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588627004
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 196243668,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588628561
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405370836\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405370836\">PR Review</a>.</p>",
        "id": 196243862,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588628711
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419747847\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419747847\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Fixed in 0945267. @sunfishcode if you could have a look and lemme know if that's what you had in mind!</p>\n</blockquote>",
        "id": 196243863,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588628712
    },
    {
        "content": "<p>sunfishcode submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405411327\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405411327\">PR Review</a>.</p>",
        "id": 196251520,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588634293
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419783680\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419783680\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Yes, that's right.</p>\n</blockquote>",
        "id": 196251521,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588634293
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 196671679,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588787195
    },
    {
        "content": "<p>sunfishcode submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405412568\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405412568\">PR Review</a>.</p>",
        "id": 196776129,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588860832
    },
    {
        "content": "<p>sunfishcode submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405412568\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-405412568\">PR Review</a>.</p>",
        "id": 196776130,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588860832
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419784821\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419784821\">PR Review Comment</a>:</p>\n<blockquote>\n<p>This <code>expect</code> could fail if the user passes in the wrong kind of handle? That feels like something where should return a <code>Result</code> and forward the error on, rather than panicking.</p>\n</blockquote>",
        "id": 196776131,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588860832
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419790853\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r419790853\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Can you comment on why this <code>as_file</code> method isn't part of the <code>Handle</code> trait? Looking at the implementation below, it's doing a lot of <code>as_any().downcast_ref&lt;Stuff&gt;()</code>, which seems like it would be avoided if you could just call <code>as_file</code> on a <code>Handle</code> directly.</p>\n</blockquote>",
        "id": 196776134,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588860832
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407517049\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407517049\">PR Review</a>.</p>",
        "id": 196776616,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588861012
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421539423\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421539423\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Ah, right! I was meant to do this and somehow forgot. Thanks for pointing this one out!</p>\n</blockquote>",
        "id": 196776617,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588861012
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407518597\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407518597\">PR Review</a>.</p>",
        "id": 196776857,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588861108
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421540616\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421540616\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Hmm, that's an interesting suggestion. So previously, <code>AsFile</code> wasn't part of <code>Handle</code> trait since it wasn't fallible, and hence, it wouldn't make much sense for <code>VirtualFile</code>, etc. But now, given that we return <code>Result</code> I guess we could in principle return <code>Errno::Badf</code> when called by a virtual handle? Or should be outright panic in such a case?</p>\n</blockquote>",
        "id": 196776860,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588861108
    },
    {
        "content": "<p>sunfishcode created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421600383\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421600383\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Oh, right. I wasn't thinking about cases like <code>VirtualHandle</code>. I think it's fine as is then.</p>\n</blockquote>",
        "id": 196788845,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588865800
    },
    {
        "content": "<p>sunfishcode submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407595096\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407595096\">PR Review</a>.</p>",
        "id": 196788846,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588865800
    },
    {
        "content": "<p>kubkon updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a> from <code>handle-rights</code> to <code>master</code>:</p>\n<blockquote>\n<p>This commit does a lot of reshuffling and even some more. It introduces<br>\nstrongly-typed system primitives which are: <code>OsFile</code>, <code>OsDir</code>, <code>Stdio</code>,<br>\nand <code>OsOther</code>. Those primitives are separate structs now, each implementing<br>\na subset of <code>Handle</code> methods, rather than all being an enumeration of some<br>\nsupertype such as <code>OsHandle</code>. To summarise the structs:</p>\n<ul>\n<li>\n<p><code>OsFile</code> represents a regular file, and implements fd-ops<br>\n  of <code>Handle</code> trait</p>\n</li>\n<li>\n<p><code>OsDir</code> represents a directory, and primarily implements path-ops, plus<br>\n<code>readdir</code> and some common fd-ops such as <code>fdstat</code>, etc.</p>\n</li>\n<li>\n<p><code>Stdio</code> represents a stdio handle, and implements a subset of fd-ops<br>\n  such as <code>fdstat</code> _and_ <code>read_</code> and <code>write_vectored</code> calls</p>\n</li>\n<li>\n<p><code>OsOther</code> currently represents anything else and implements a set similar<br>\n  to that implemented by <code>Stdio</code></p>\n</li>\n</ul>\n<p>This commit is effectively an experiment and an excercise into better<br>\nunderstanding what's going on for each OS resource/type under-the-hood.<br>\nIt's meant to give us some intuition in order to move on with the idea<br>\nof having strongly-typed handles in WASI both in the syscall impl as well<br>\nas at the libc level.</p>\n<p>Some more minor changes include making <code>OsHandle</code> represent an OS-specific<br>\nwrapper for a raw OS handle (Unix fd or Windows handle). Also, since <code>OsDir</code><br>\nis tricky across OSes, we also have a supertype of <code>OsHandle</code> called<br>\n<code>OsDirHandle</code> which may store a <code>DIR*</code> stream pointer (mainly BSD). Last but not<br>\nleast, the <code>Filetype</code> and <code>Rights</code> are now computed when the resource is created,<br>\nrather than every time we call <code>Handle::get_file_type</code> and <code>Handle::get_rights</code>.<br>\nFinally, in order to facilitate the latter, I've converted <code>EntryRights</code> into<br>\n<code>HandleRights</code> and pushed them into each <code>Handle</code> implementor.</p>\n</blockquote>",
        "id": 196833805,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588887667
    },
    {
        "content": "<p>kubkon submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407860230\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407860230\">PR Review</a>.</p>",
        "id": 196834380,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588887969
    },
    {
        "content": "<p>kubkon created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421813470\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421813470\">PR Review Comment</a>:</p>\n<blockquote>\n<p>Fixed in 36f07cf. So in order not to force public API changes, instead of throwing an error directly at the preopen callsite (either <code>preopened_dir</code> or <code>preopened_virt</code>), the creation of the actual instance is now postponed until we build the context object, much like creation of the stdio handles.</p>\n</blockquote>",
        "id": 196834381,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588887970
    },
    {
        "content": "<p>kubkon edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421813470\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#discussion_r421813470\">PR Review Comment</a>.</p>",
        "id": 196834522,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588888081
    },
    {
        "content": "<p>sunfishcode submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407893133\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561#pullrequestreview-407893133\">PR Review</a>.</p>",
        "id": 196840933,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588892407
    },
    {
        "content": "<p>sunfishcode merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/1561\" title=\"https://github.com/bytecodealliance/wasmtime/pull/1561\">PR #1561</a>.</p>",
        "id": 196840946,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1588892415
    }
]