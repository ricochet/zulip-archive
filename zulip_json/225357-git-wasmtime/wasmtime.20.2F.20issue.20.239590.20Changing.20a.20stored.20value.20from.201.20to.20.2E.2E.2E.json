[
    {
        "content": "<p>hungryzzz opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<h2>Test Cases</h2>\n<p><a href=\"https://github.com/user-attachments/files/17690564/case.zip\">case.zip</a></p>\n<h2>Steps to Reproduce</h2>\n<p>Hi, I run the attached two cases(<code>good.wasm</code> &amp; <code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h2>Expected Results &amp; Actual Results</h2>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li><code>Wasmtime</code>: 0.99s</li>\n<li><code>WasmEdge</code>: 1.06s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li><code>Wasmtime</code>: 6.57s</li>\n<li><code>WasmEdge</code>: 1.05s</li>\n</ul>\n<p>The difference between the attached two cases is as follows: changing the stored value in line 8 from <code>1</code> to <code>0</code>, which decreases Wasmtime performance by 5.5s but has no negative effect on WasmEdge.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>âžœ<span class=\"w\">  </span>diff<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n8c8\n&lt;<span class=\"w\">     </span>f64.const<span class=\"w\"> </span>0x1p+0<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"p\">;</span><span class=\"o\">=</span><span class=\"m\">1</span><span class=\"p\">;</span><span class=\"o\">)</span>\n---\n&gt;<span class=\"w\">     </span>f64.const<span class=\"w\"> </span>0x0p+0<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"p\">;</span><span class=\"o\">=</span><span class=\"m\">0</span><span class=\"p\">;</span><span class=\"o\">)</span>\n</code></pre></div>\n<h2>More observations &amp; questions:</h2>\n<ol>\n<li>The store operation is outside the loop, and the following instructions do not contain any load operations.</li>\n<li><code>Wasmtime</code> compiles the loop conditions in <code>bad.wasm</code> and <code>good.wasm</code> in different ways, but I don't understand why the changes of an instruction that seems unrelated to the loop can affect the compilation strategies to the loop.</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># part of machine code of bad.wasm generated by wasmtime</span>\n...\njne<span class=\"w\"> </span>5c<span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0x5c&gt;\nmovdqu<span class=\"w\"> </span><span class=\"o\">(</span>%rsp<span class=\"o\">)</span>,%xmm1\njmp<span class=\"w\"> </span><span class=\"m\">60</span><span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0x60&gt;\n...\nje<span class=\"w\"> </span>7f<span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0x7f&gt;\nmovdqu<span class=\"w\"> </span>%xmm1,<span class=\"o\">(</span>%rsp<span class=\"o\">)</span>\njmp<span class=\"w\"> </span><span class=\"m\">46</span><span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0x46&gt;\n...\nje<span class=\"w\"> </span>a2<span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0xa2&gt;\nmovdqu<span class=\"w\"> </span>%xmm1,<span class=\"o\">(</span>%rsp<span class=\"o\">)</span>\njmp<span class=\"w\"> </span><span class=\"m\">46</span><span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0x46&gt;\n...\n\n\n<span class=\"c1\"># part of machine code of good.wasm generated by wasmtime</span>\n...\nje<span class=\"w\"> </span>5f<span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0x5f&gt;\n...\njne<span class=\"w\"> </span>4f<span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0x4f&gt;\n...\njne<span class=\"w\"> </span>4f<span class=\"w\"> </span>&lt;wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">1</span><span class=\"o\">]</span>+0x4f&gt;\n...\n</code></pre></div>\n<h2>Versions and Environment</h2>\n<ul>\n<li>Wasmtime version or commit: c8b136965</li>\n<li>Operating system: Linux ringzzz-OptiPlex-Micro-Plus-7010 6.5.0-18-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-13500</li>\n</ul>\n</blockquote>",
        "id": 481537145,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731224121
    },
    {
        "content": "<p>primoly <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2466711821\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>Strangely, replacing that constant zero with an equivalent calculation fixes the issue. Cranelift should constant fold these instructions, so why do they affect machine code generation? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>\n<p>Replace line 8 in <code>bad.wasm</code> with one of the following for equal performance with <code>good.wasm</code>:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"nb\">f64.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">f64.abs</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"nb\">f64.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">f64.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">f64.add</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"nb\">f64.const</span> <span class=\"mi\">42</span>\n<span class=\"nb\">f64.const</span> <span class=\"mi\">42</span>\n<span class=\"nb\">f64.sub</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"nb\">f64.const</span> <span class=\"mf\">777</span>\n<span class=\"nb\">f64.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">f64.mul</span>\n</code></pre></div>\n</blockquote>",
        "id": 481556458,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731240937
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2467194805\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>This is happening because a register is being spilled, but why it's being spilled I'm not sure. Changing from 1 to 0 changes codegen which changes register allocation which causes this. In that sense I think it's worth digging in to why the spill happened here in the 0 case because I'm not sure what's going on. </p>\n<p>I've got this CLIF:</p>\n<div class=\"codehilite\" data-code-language=\"clif\"><pre><span></span><code>function u0:1(i64, i64) {\n    sig0 = (i64, i64)\n    fn0 = colocated u0:2 sig0\n\nblock0(v0: i64, v1: i64):\n    v2 = f64const 0.0\n    v7 = load.i64 notrap aligned readonly checked v0+120\n    v10 = iadd_imm v7, 16\n    store little heap v2, v10\n    call fn0(v0, v0)\n    v3 = iconst.i32 0\n    v17 = iconst.i32 0xffff\n    v15 = iconst.i32 1\n    jump block4(v3, v3, v2)\n\nblock4(v14: i32, v24: i32, v34: f64):\n    v37 = iconst.i32 0\n    brif v37, block6, block7(v34)\n\nblock6:\n    v38 = f64const 0.0\n    jump block7(v38)\n\nblock7(v33: f64):\n    v40 = band_imm.i32 v14, 0xffff\n    v42 = icmp_imm ne v40, 1\n    v43 = iadd_imm.i32 v14, 1\n    brif v42, block4(v43, v24, v33), block5\n\nblock5:\n    v46 = icmp_imm ne v24, 0xffff\n    v48 = iadd_imm.i32 v24, 1\n    brif v46, block4(v43, v48, v33), block9\n\nblock9:\n    trap user11\n}\n</code></pre></div>\n<p>compiled with <code>cargo run compile out.clif --target x86_64 -D --set opt_level=speed</code> to generate:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Disassembly</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"o\">&gt;</span><span class=\"p\">:</span>\n<span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">55</span><span class=\"w\">                      </span><span class=\"n\">pushq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">             </span><span class=\"n\">subq</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rsp</span>\n<span class=\"w\">   </span><span class=\"mi\">8</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"n\">c9</span><span class=\"w\">             </span><span class=\"n\">xorpd</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span>\n<span class=\"w\">   </span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">78</span><span class=\"w\">             </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"mh\">0x78</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rdx</span>\n<span class=\"w\">  </span><span class=\"mi\">10</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">          </span><span class=\"n\">movsd</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdx</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">  </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">SPILL</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"n\">d</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">callq</span><span class=\"w\">   </span><span class=\"mh\">0x22</span>\n<span class=\"w\">  </span><span class=\"mi\">22</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"w\">                </span><span class=\"n\">xorl</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10d</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">r10d</span>\n<span class=\"w\">  </span><span class=\"mi\">25</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">d6</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">  </span><span class=\"mi\">28</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">db</span><span class=\"w\">                </span><span class=\"n\">xorl</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r11d</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">r11d</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"mi\">85</span><span class=\"w\"> </span><span class=\"n\">db</span><span class=\"w\">                </span><span class=\"n\">testl</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">r11d</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">r11d</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"n\">e</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">85</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">jne</span><span class=\"w\">     </span><span class=\"mh\">0x3e</span>\n<span class=\"w\">  </span><span class=\"mi\">34</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">RELOAD</span>\n<span class=\"w\">  </span><span class=\"mi\">39</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">     </span><span class=\"mh\">0x42</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"n\">e</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"n\">c9</span><span class=\"w\">             </span><span class=\"n\">xorpd</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span>\n<span class=\"w\">  </span><span class=\"mi\">42</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">d7</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rdi</span>\n<span class=\"w\">  </span><span class=\"mi\">45</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">e7</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">andl</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0xffff</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">edi</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">c2</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">             </span><span class=\"n\">addl</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">r10d</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">                </span><span class=\"n\">cmpl</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">edi</span>\n<span class=\"w\">  </span><span class=\"mi\">52</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">je</span><span class=\"w\">      </span><span class=\"mh\">0x62</span>\n<span class=\"w\">  </span><span class=\"mi\">58</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">SPILL</span>\n<span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"n\">d</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"n\">c6</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">     </span><span class=\"mh\">0x28</span>\n<span class=\"w\">  </span><span class=\"mi\">62</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">8</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">                </span><span class=\"n\">leal</span><span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">edi</span>\n<span class=\"w\">  </span><span class=\"mi\">65</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">cmpl</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0xffff</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">esi</span>\n<span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">je</span><span class=\"w\">      </span><span class=\"mh\">0x7e</span>\n<span class=\"w\">  </span><span class=\"mi\">71</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">  </span><span class=\"mi\">74</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">SPILL</span>\n<span class=\"w\">  </span><span class=\"mi\">79</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"n\">aa</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">     </span><span class=\"mh\">0x28</span>\n<span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"n\">e</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">b</span><span class=\"w\">                   </span><span class=\"n\">ud2</span>\n</code></pre></div>\n<p>where I've annotated the spill/reload slots. </p>\n<p>@cfallin would you know how to perhaps debug this further to see why the spill is being inserted? It seems to require some of the bits at the beginning of the function (e.g. calling some other function) so it may be related to caller/callee saves or something like that. I'm not sure if this is related to ABI details though as opposed to register allocator behavior. If it's regalloc-related this might end up leading to some nice wins on other benchmarks if it's not just float-related perhaps?</p>\n</blockquote>",
        "id": 481628010,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731298309
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2467388917\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<blockquote>\n<p>@cfallin would you know how to perhaps debug this further to see why the spill is being inserted? It seems to require some of the bits at the beginning of the function (e.g. calling some other function) so it may be related to caller/callee saves or something like that. I'm not sure if this is related to ABI details though as opposed to register allocator behavior. If it's regalloc-related this might end up leading to some nice wins on other benchmarks if it's not just float-related perhaps?</p>\n</blockquote>\n<p>Maybe -- FWIW I have zero cycles to dedicate to this right now, so you'll need to dig into RA2 on this, unfortunately. Maybe at some later time I'll have the ability to make another performance push. Sorry!</p>\n</blockquote>",
        "id": 481647750,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731308748
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2472967410\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<blockquote>\n<p>compiled with <code>cargo run compile out.clif --target x86_64 -D --set opt_level=speed</code> to generate:</p>\n<p><code>\nDisassembly of 128 bytes &lt;u0:1&gt;:\n   0:   55                      pushq   %rbp\n   1:   48 89 e5                movq    %rsp, %rbp\n   4:   48 83 ec 10             subq    $0x10, %rsp\n   8:   66 0f 57 c9             xorpd   %xmm1, %xmm1\n   c:   48 8b 57 78             movq    0x78(%rdi), %rdx\n  10:   f2 0f 11 4a 10          movsd   %xmm1, 0x10(%rdx)\n  15:   48 89 fe                movq    %rdi, %rsi\n  18:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  1d:   e8 00 00 00 00          callq   0x22\n  22:   45 31 d2                xorl    %r10d, %r10d\n  25:   4c 89 d6                movq    %r10, %rsi\n  28:   45 31 db                xorl    %r11d, %r11d\n  2b:   45 85 db                testl   %r11d, %r11d\n  2e:   0f 85 0a 00 00 00       jne     0x3e\n  34:   f3 0f 6f 0c 24          movdqu  (%rsp), %xmm1     ;; RELOAD\n  39:   e9 04 00 00 00          jmp     0x42\n  3e:   66 0f 57 c9             xorpd   %xmm1, %xmm1\n  42:   4c 89 d7                movq    %r10, %rdi\n  45:   81 e7 ff ff 00 00       andl    $0xffff, %edi\n  4b:   41 83 c2 01             addl    $1, %r10d\n  4f:   83 ff 01                cmpl    $1, %edi\n  52:   0f 84 0a 00 00 00       je      0x62\n  58:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  5d:   e9 c6 ff ff ff          jmp     0x28\n  62:   8d 7e 01                leal    1(%rsi), %edi\n  65:   81 fe ff ff 00 00       cmpl    $0xffff, %esi\n  6b:   0f 84 0d 00 00 00       je      0x7e\n  71:   48 89 fe                movq    %rdi, %rsi\n  74:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  79:   e9 aa ff ff ff          jmp     0x28\n  7e:   0f 0b                   ud2\n</code></p>\n</blockquote>\n<p>Hi @alexcrichton, I went through again the codes and the following is my heuristic thoughts about this bug:</p>\n<ol>\n<li>\n<p>Is it possible that the SPILL in line 18 is caused by the calling instruction since the <code>xmm1</code> is one of the caller-saved registers? And the following RELOAD (line34) and SPILL (line58&amp;74) are the chain reaction due to the first SPILL(line18).</p>\n</li>\n<li>\n<p>However, in the <code>good.wasm</code>, it uses <code>xmm0</code> to store the value, but <code>xmm0</code> is not spilled before calling instruction even though <code>xmm0</code> is also one of the caller-saved registers. Therefore, is it possible that <code>cranelift</code> uses different strategies for <code>xmm0</code> and <code>xmm1</code> before calling instruction?</p>\n</li>\n</ol>\n</blockquote>",
        "id": 482125999,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731490043
    },
    {
        "content": "<p>hungryzzz edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2472967410\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<blockquote>\n<p>compiled with <code>cargo run compile out.clif --target x86_64 -D --set opt_level=speed</code> to generate:</p>\n<p><code>\nDisassembly of 128 bytes &lt;u0:1&gt;:\n   0:   55                      pushq   %rbp\n   1:   48 89 e5                movq    %rsp, %rbp\n   4:   48 83 ec 10             subq    $0x10, %rsp\n   8:   66 0f 57 c9             xorpd   %xmm1, %xmm1\n   c:   48 8b 57 78             movq    0x78(%rdi), %rdx\n  10:   f2 0f 11 4a 10          movsd   %xmm1, 0x10(%rdx)\n  15:   48 89 fe                movq    %rdi, %rsi\n  18:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  1d:   e8 00 00 00 00          callq   0x22\n  22:   45 31 d2                xorl    %r10d, %r10d\n  25:   4c 89 d6                movq    %r10, %rsi\n  28:   45 31 db                xorl    %r11d, %r11d\n  2b:   45 85 db                testl   %r11d, %r11d\n  2e:   0f 85 0a 00 00 00       jne     0x3e\n  34:   f3 0f 6f 0c 24          movdqu  (%rsp), %xmm1     ;; RELOAD\n  39:   e9 04 00 00 00          jmp     0x42\n  3e:   66 0f 57 c9             xorpd   %xmm1, %xmm1\n  42:   4c 89 d7                movq    %r10, %rdi\n  45:   81 e7 ff ff 00 00       andl    $0xffff, %edi\n  4b:   41 83 c2 01             addl    $1, %r10d\n  4f:   83 ff 01                cmpl    $1, %edi\n  52:   0f 84 0a 00 00 00       je      0x62\n  58:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  5d:   e9 c6 ff ff ff          jmp     0x28\n  62:   8d 7e 01                leal    1(%rsi), %edi\n  65:   81 fe ff ff 00 00       cmpl    $0xffff, %esi\n  6b:   0f 84 0d 00 00 00       je      0x7e\n  71:   48 89 fe                movq    %rdi, %rsi\n  74:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  79:   e9 aa ff ff ff          jmp     0x28\n  7e:   0f 0b                   ud2\n</code></p>\n</blockquote>\n<p>Hi @alexcrichton, I went through again the codes and the following is my heuristic thoughts about this bug:</p>\n<ol>\n<li>\n<p>Is it possible that the SPILL in line 18 is caused by the calling instruction since the <code>xmm1</code> is one of the caller-saved registers? And the following RELOAD (line34) and SPILL (line58&amp;74) are the chain reaction due to the first SPILL(line18)?</p>\n</li>\n<li>\n<p>However, in the <code>good.wasm</code>, it uses <code>xmm0</code> to store the value, but <code>xmm0</code> is not spilled before calling instruction even though <code>xmm0</code> is also one of the caller-saved registers. Therefore, is it possible that <code>cranelift</code> uses different strategies for <code>xmm0</code> and <code>xmm1</code> before calling instruction?</p>\n</li>\n</ol>\n</blockquote>",
        "id": 482126275,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731490113
    },
    {
        "content": "<p>hungryzzz edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2472967410\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<blockquote>\n<p>compiled with <code>cargo run compile out.clif --target x86_64 -D --set opt_level=speed</code> to generate:</p>\n<p><code>\nDisassembly of 128 bytes &lt;u0:1&gt;:\n   0:   55                      pushq   %rbp\n   1:   48 89 e5                movq    %rsp, %rbp\n   4:   48 83 ec 10             subq    $0x10, %rsp\n   8:   66 0f 57 c9             xorpd   %xmm1, %xmm1\n   c:   48 8b 57 78             movq    0x78(%rdi), %rdx\n  10:   f2 0f 11 4a 10          movsd   %xmm1, 0x10(%rdx)\n  15:   48 89 fe                movq    %rdi, %rsi\n  18:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  1d:   e8 00 00 00 00          callq   0x22\n  22:   45 31 d2                xorl    %r10d, %r10d\n  25:   4c 89 d6                movq    %r10, %rsi\n  28:   45 31 db                xorl    %r11d, %r11d\n  2b:   45 85 db                testl   %r11d, %r11d\n  2e:   0f 85 0a 00 00 00       jne     0x3e\n  34:   f3 0f 6f 0c 24          movdqu  (%rsp), %xmm1     ;; RELOAD\n  39:   e9 04 00 00 00          jmp     0x42\n  3e:   66 0f 57 c9             xorpd   %xmm1, %xmm1\n  42:   4c 89 d7                movq    %r10, %rdi\n  45:   81 e7 ff ff 00 00       andl    $0xffff, %edi\n  4b:   41 83 c2 01             addl    $1, %r10d\n  4f:   83 ff 01                cmpl    $1, %edi\n  52:   0f 84 0a 00 00 00       je      0x62\n  58:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  5d:   e9 c6 ff ff ff          jmp     0x28\n  62:   8d 7e 01                leal    1(%rsi), %edi\n  65:   81 fe ff ff 00 00       cmpl    $0xffff, %esi\n  6b:   0f 84 0d 00 00 00       je      0x7e\n  71:   48 89 fe                movq    %rdi, %rsi\n  74:   f3 0f 7f 0c 24          movdqu  %xmm1, (%rsp)     ;; SPILL\n  79:   e9 aa ff ff ff          jmp     0x28\n  7e:   0f 0b                   ud2\n</code></p>\n</blockquote>\n<p>Hi @alexcrichton, I went through again the codes and the following are my heuristic thoughts about this bug:</p>\n<ol>\n<li>\n<p>Is it possible that the SPILL in line 18 is caused by the calling instruction since the <code>xmm1</code> is one of the caller-saved registers? And the following RELOAD (line34) and SPILL (line58&amp;74) are the chain reaction due to the first SPILL(line18)?</p>\n</li>\n<li>\n<p>However, in the <code>good.wasm</code>, it uses <code>xmm0</code> to store the value, but <code>xmm0</code> is not spilled before calling instruction even though <code>xmm0</code> is also one of the caller-saved registers. Therefore, is it possible that <code>cranelift</code> uses different strategies for <code>xmm0</code> and <code>xmm1</code> before calling instruction?</p>\n</li>\n</ol>\n</blockquote>",
        "id": 482126322,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731490129
    },
    {
        "content": "<p>primoly <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2473099977\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>In the spilling case Cranelift uses the same value for multiple zero constants. In the non-spilling case it uses two different ones. In the original <code>bad.wasm</code> case it had to use different ones for 0 and 1, but you can get cranelift to use two different ones even when they are both zero, with for example the <code>(f64.abs (f64.const 0))</code> hack iâ€™ve shown above.</p>\n<h3>Generated CLIF after optimisations of @alexcrichtonâ€™s example (spills):</h3>\n<p>(Note how it uses only <code>v2</code> for the zero constant)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v56</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v61</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v62</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Example that does not spill:</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fabs</span><span class=\"p\">.</span><span class=\"kt\">f64</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v37</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v37</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v38</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v38</span><span class=\"p\">)</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v40</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v42</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp_imm</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v40</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v43</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v42</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v43</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v46</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp_imm</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v48</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v46</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v43</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v48</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<h3>Generated CLIF after optimisations of the above example:</h3>\n<p>(Note how it uses <code>v2</code> and <code>v55</code> for the zero constant)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v57</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v61</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v62</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v66</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v62</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v66</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n</blockquote>",
        "id": 482136795,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731493336
    },
    {
        "content": "<p>primoly edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2473099977\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>In the spilling case Cranelift uses the same value for multiple zero constants. In the non-spilling case it uses two different ones. In the original <code>good.wasm</code> case it had to use different ones for 0 and 1, but you can get cranelift to use two different ones even when they are both zero, with for example the <code>(f64.abs (f64.const 0))</code> hack iâ€™ve shown above.</p>\n<h3>Generated CLIF after optimisations of @alexcrichtonâ€™s example (spills):</h3>\n<p>(Note how it uses only <code>v2</code> for the zero constant)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v56</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v61</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v62</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Example that does not spill:</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fabs</span><span class=\"p\">.</span><span class=\"kt\">f64</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v37</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v37</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v38</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v38</span><span class=\"p\">)</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v40</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v42</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp_imm</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v40</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v43</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v42</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v43</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v46</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp_imm</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v48</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v46</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v43</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v48</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<h3>Generated CLIF after optimisations of the above example:</h3>\n<p>(Note how it uses <code>v2</code> and <code>v55</code> for the zero constant)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v57</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v61</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v62</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v66</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v62</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v66</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n</blockquote>",
        "id": 482136950,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731493391
    },
    {
        "content": "<p>primoly edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2473099977\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>In the spilling case Cranelift uses the same value for multiple zero constants. In the non-spilling case it uses two different ones. In the original <code>good.wasm</code> case it had to use different values for <code>0.0</code> and <code>1.0</code>, but you can get Cranelift to use two separate ones even when they are both <code>0.0</code>, with for example the <code>(f64.abs (f64.const 0))</code> hack iâ€™ve shown above.</p>\n<h3>Generated CLIF after optimisations of @alexcrichtonâ€™s example (spills)</h3>\n<p>Note how it uses only <code>v2</code> for the <code>0.0</code> constant in <code>block0</code>. This <code>v2</code> is then used twice, in the <code>store</code> as well as the <code>jump</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v56</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v61</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v62</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Example that does not spill</h3>\n<p>Note the additional <code>v6</code> that will get constant folded.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fabs</span><span class=\"p\">.</span><span class=\"kt\">f64</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v37</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v37</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v38</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v38</span><span class=\"p\">)</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v40</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v42</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp_imm</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v40</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v43</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v42</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v43</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v46</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp_imm</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v48</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_imm</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v46</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v43</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v48</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<h3>Generated CLIF after optimisations of the non-spilling example above</h3>\n<p>Note how it uses <code>v2</code> and <code>v55</code> for the <code>0.0</code> constant in <code>block0</code>. The <code>store</code> uses <code>v55</code> while the <code>jump</code> uses <code>v2</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">120</span>\n<span class=\"w\">    </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v49</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">16</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">little</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v55</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v14</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v34</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v34</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v56</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"n\">block6</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f64const</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n<span class=\"w\">    </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v57</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v57</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"n\">block7</span><span class=\"p\">(</span><span class=\"n\">v33</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v59</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v58</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v61</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v59</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v62</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v60</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v61</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v62</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block5</span>\n\n<span class=\"n\">block5</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v63</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0xffff</span>\n<span class=\"w\">    </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">v66</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v65</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block4</span><span class=\"p\">(</span><span class=\"n\">v62</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v66</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v33</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block9</span>\n\n<span class=\"n\">block9</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">trap</span><span class=\"w\"> </span><span class=\"n\">user11</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n</blockquote>",
        "id": 482228530,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731520231
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2478368271\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>Hi @alexcrichton @primoly, I also find that if I change the <code>local.get 0</code> (line 42) in the <code>bad.wasm</code> to  <code>f64.const 0x0p+0</code>, the performance will also be back to normal.</p>\n<p>In the loop, the local variable 0 will be set in a branch (line 16), and obtained outside this loop (line 42). is it possible this dependency affects some analysis?</p>\n<p>Here are the differences between their machine codes:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">&gt;</span><span class=\"p\">:</span>\n<span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">55</span><span class=\"w\">                      </span><span class=\"n\">push</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">       </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">       </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x8</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">       </span><span class=\"mi\">8</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">r10</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">       </span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">c2</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"w\">             </span><span class=\"n\">add</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x30</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">       </span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"n\">e2</span><span class=\"w\">                </span><span class=\"n\">cmp</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">      </span><span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">87</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">ja</span><span class=\"w\">     </span><span class=\"n\">b3</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0xb3</span><span class=\"o\">&gt;</span>\n<span class=\"w\">      </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\">             </span><span class=\"n\">sub</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x20</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsp</span>\n<span class=\"w\">      </span><span class=\"mi\">1</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">          </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">,</span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">21</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">c5</span><span class=\"w\"> </span><span class=\"n\">d9</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"n\">cc</span><span class=\"w\">             </span><span class=\"n\">vxorpd</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm4</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm4</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm1</span>\n<span class=\"w\">      </span><span class=\"mi\">25</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">47</span><span class=\"w\"> </span><span class=\"mi\">78</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x78</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rax</span>\n<span class=\"w\">      </span><span class=\"mi\">29</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">      </span><span class=\"mi\">2</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">c5</span><span class=\"w\"> </span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">          </span><span class=\"n\">vmovsd</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"p\">)</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">31</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">f3</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rbx</span>\n<span class=\"w\">      </span><span class=\"mi\">34</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">39</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rdi</span>\n<span class=\"w\">      </span><span class=\"mi\">3</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e8</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">call</span><span class=\"w\">   </span><span class=\"n\">c0</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">&gt;</span>\n<span class=\"w\">      </span><span class=\"mi\">41</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">                   </span><span class=\"n\">xor</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">edi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">edi</span>\n<span class=\"w\">      </span><span class=\"mi\">43</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">fa</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">      </span><span class=\"mi\">46</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">c9</span><span class=\"w\">                </span><span class=\"n\">xor</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r9d</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r9d</span>\n<span class=\"w\">      </span><span class=\"mi\">49</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"mi\">85</span><span class=\"w\"> </span><span class=\"n\">c9</span><span class=\"w\">                </span><span class=\"n\">test</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">r9d</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r9d</span>\n<span class=\"w\">      </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">85</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">jne</span><span class=\"w\">    </span><span class=\"mi\">5</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x5c</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">52</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\">                                      </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">57</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">    </span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x60</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">5</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">c5</span><span class=\"w\"> </span><span class=\"n\">e9</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"n\">ca</span><span class=\"w\">             </span><span class=\"n\">vxorpd</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">60</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">      </span><span class=\"mi\">63</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">e6</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">and</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0xffff</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">esi</span>\n<span class=\"w\">      </span><span class=\"mi\">69</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">                </span><span class=\"n\">add</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">edi</span>\n<span class=\"w\">      </span><span class=\"mi\">6</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">                </span><span class=\"n\">cmp</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">esi</span>\n<span class=\"w\">      </span><span class=\"mi\">6</span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">je</span><span class=\"w\">     </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x7f</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">75</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span><span class=\"w\">                                 </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">7</span><span class=\"n\">a</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"n\">c7</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">    </span><span class=\"mi\">46</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x46</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">d0</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rax</span>\n<span class=\"w\">      </span><span class=\"mi\">82</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">e0</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">and</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0xffff</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">eax</span>\n<span class=\"w\">      </span><span class=\"mi\">88</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">c2</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">             </span><span class=\"n\">add</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10d</span>\n<span class=\"w\">      </span><span class=\"mi\">8</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">f8</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">cmp</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0xffff</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">eax</span>\n<span class=\"w\">      </span><span class=\"mi\">92</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">je</span><span class=\"w\">     </span><span class=\"n\">a2</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0xa2</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">98</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span><span class=\"w\">                                   </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">9</span><span class=\"n\">d</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">    </span><span class=\"mi\">46</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x46</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"n\">a2</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">43</span><span class=\"w\"> </span><span class=\"mi\">58</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x58</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rax</span>\n<span class=\"w\">      </span><span class=\"n\">a6</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">68</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x68</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rdi</span>\n<span class=\"w\">      </span><span class=\"n\">aa</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"w\">                   </span><span class=\"n\">xor</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">edx</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">edx</span>\n<span class=\"w\">      </span><span class=\"n\">ac</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">de</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">      </span><span class=\"n\">af</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">ff</span><span class=\"w\"> </span><span class=\"n\">d0</span><span class=\"w\">                   </span><span class=\"n\">call</span><span class=\"w\">   </span><span class=\"o\">*%</span><span class=\"n\">rax</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 482570047,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731663619
    },
    {
        "content": "<p>hungryzzz edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2478368271\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>Hi @alexcrichton @primoly, I also find that if I change the <code>local.get 0</code> (line 42) in the <code>bad.wasm</code> to  <code>f64.const 0x0p+0</code>, the performance will also be back to normal. It seems that I can understand something about the register spills and reload.</p>\n<h3>Observations about the register spills and reload</h3>\n<ol>\n<li>The <code>local.set 0</code> instruction is in a branch within a double loop. (<code>4c</code> - <code>5f</code> in machine code) Besides,  there is a <code>local.get 0</code> outside the loop (even though it will be dropped right away.)</li>\n<li>I guess that Wasmtime will store the value of local[0] in address <code>%rsp</code>, and use <code>xmm1</code> register to store the new value of local[0].</li>\n<li>When the branch is true, <code>xmm1</code> is set to a new value (<code>5c</code>); while when the branch is false, <code>xmm1</code> is set to the current value of local[0]. (address <code>52</code>) This explains the register reload instruction in address<code>52</code>.</li>\n<li>In every iteration, the new value of <code>xmm1</code> will be stored back to the address <code>%rsp</code> (address <code>75</code> and <code>98</code>), this explains the register spilling instructions in address <code>75</code> and <code>98</code>.</li>\n<li>Even though I understand why the register spills and reloads happen in <code>bad.wasm</code>,  I still do not know why changing the <code>f64.const 0x0p+0</code> in line 8 from <code>f64.const 0x1p+0</code> prevents this situation from happening.</li>\n</ol>\n<p>Here are the differences between their machine codes:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">&gt;</span><span class=\"p\">:</span>\n<span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">55</span><span class=\"w\">                      </span><span class=\"n\">push</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">       </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">       </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x8</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">       </span><span class=\"mi\">8</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">r10</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">       </span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">c2</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"w\">             </span><span class=\"n\">add</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x30</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">       </span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"n\">e2</span><span class=\"w\">                </span><span class=\"n\">cmp</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">      </span><span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">87</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">ja</span><span class=\"w\">     </span><span class=\"n\">b3</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0xb3</span><span class=\"o\">&gt;</span>\n<span class=\"w\">      </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\">             </span><span class=\"n\">sub</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x20</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsp</span>\n<span class=\"w\">      </span><span class=\"mi\">1</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">          </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">,</span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">21</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">c5</span><span class=\"w\"> </span><span class=\"n\">d9</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"n\">cc</span><span class=\"w\">             </span><span class=\"n\">vxorpd</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm4</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm4</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm1</span>\n<span class=\"w\">      </span><span class=\"mi\">25</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">47</span><span class=\"w\"> </span><span class=\"mi\">78</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x78</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rax</span>\n<span class=\"w\">      </span><span class=\"mi\">29</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">      </span><span class=\"mi\">2</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">c5</span><span class=\"w\"> </span><span class=\"n\">fb</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">          </span><span class=\"n\">vmovsd</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"p\">)</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">31</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">f3</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rbx</span>\n<span class=\"w\">      </span><span class=\"mi\">34</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">39</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rdi</span>\n<span class=\"w\">      </span><span class=\"mi\">3</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e8</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">call</span><span class=\"w\">   </span><span class=\"n\">c0</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">&gt;</span>\n<span class=\"w\">      </span><span class=\"mi\">41</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">                   </span><span class=\"n\">xor</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">edi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">edi</span>\n<span class=\"w\">      </span><span class=\"mi\">43</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">fa</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10</span>\n<span class=\"w\">      </span><span class=\"mi\">46</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">c9</span><span class=\"w\">                </span><span class=\"n\">xor</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r9d</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r9d</span>\n<span class=\"w\">      </span><span class=\"mi\">49</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"mi\">85</span><span class=\"w\"> </span><span class=\"n\">c9</span><span class=\"w\">                </span><span class=\"n\">test</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">r9d</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r9d</span>\n<span class=\"w\">      </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">85</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">jne</span><span class=\"w\">    </span><span class=\"mi\">5</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x5c</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">52</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\">                                </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">57</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"mi\">04</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">    </span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x60</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">5</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">c5</span><span class=\"w\"> </span><span class=\"n\">e9</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"n\">ca</span><span class=\"w\">             </span><span class=\"n\">vxorpd</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">60</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">      </span><span class=\"mi\">63</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">e6</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">and</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0xffff</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">esi</span>\n<span class=\"w\">      </span><span class=\"mi\">69</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">                </span><span class=\"n\">add</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">edi</span>\n<span class=\"w\">      </span><span class=\"mi\">6</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">fe</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">                </span><span class=\"n\">cmp</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">esi</span>\n<span class=\"w\">      </span><span class=\"mi\">6</span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">je</span><span class=\"w\">     </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x7f</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">75</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span><span class=\"w\">                             </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">7</span><span class=\"n\">a</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"n\">c7</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">    </span><span class=\"mi\">46</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x46</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">d0</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rax</span>\n<span class=\"w\">      </span><span class=\"mi\">82</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">e0</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">and</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0xffff</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">eax</span>\n<span class=\"w\">      </span><span class=\"mi\">88</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">c2</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\">             </span><span class=\"n\">add</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10d</span>\n<span class=\"w\">      </span><span class=\"mi\">8</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"n\">f8</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">cmp</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0xffff</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">eax</span>\n<span class=\"w\">      </span><span class=\"mi\">92</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">je</span><span class=\"w\">     </span><span class=\"n\">a2</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0xa2</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">98</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">          </span><span class=\"n\">movdqu</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span><span class=\"w\">                           </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"mi\">9</span><span class=\"n\">d</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e9</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">          </span><span class=\"n\">jmp</span><span class=\"w\">    </span><span class=\"mi\">46</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">+</span><span class=\"mh\">0x46</span><span class=\"o\">&gt;</span><span class=\"w\">     </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"w\">      </span><span class=\"n\">a2</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">43</span><span class=\"w\"> </span><span class=\"mi\">58</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x58</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rax</span>\n<span class=\"w\">      </span><span class=\"n\">a6</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">68</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"mh\">0x68</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rdi</span>\n<span class=\"w\">      </span><span class=\"n\">aa</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"w\">                   </span><span class=\"n\">xor</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">edx</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">edx</span>\n<span class=\"w\">      </span><span class=\"n\">ac</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">de</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsi</span>\n<span class=\"w\">      </span><span class=\"n\">af</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">ff</span><span class=\"w\"> </span><span class=\"n\">d0</span><span class=\"w\">                   </span><span class=\"n\">call</span><span class=\"w\">   </span><span class=\"o\">*%</span><span class=\"n\">rax</span>\n</code></pre></div>\n</blockquote>",
        "id": 482651154,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731688562
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2480588477\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>@hungryzzz you might be right yeah! I would have naively expected live range splitting in regalloc2 though to kick in and make it such that the spill, if necessary, only happened around the call rather than through the loop. As for small differences, when it comes to regalloc heuristics AFAIK it's expected that small changes to the input can have subtle changes to the output. Especially with specific decisions like spilling here I'm not entirely surprised. That being said though I don't fully understand everything happening here so I can't really answer with certainty. (e.g. I don't know for certain why @primoly's changes resulted in different register allocation decisions)</p>\n</blockquote>",
        "id": 482773504,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731766480
    },
    {
        "content": "<p>primoly <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2480594555\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>The reason for the spill is the call to another function which leads to Cranelift saving the value of  the<code>xmm</code> register on the stack so it can retrieve it afterwards (caller saves). But when Cranelift treats the value of two zeros before the call and after as different values, it just writes a fresh <code>0.0</code> into another <code>xmm</code> register. Notice how the non-spilling cases always use two different <code>xmm</code> registers while the spilling ones only use one, matching the non-spilling CLIF using <code>v2</code> and <code>v55</code> while the spilling CLIF uses only <code>v2</code>.<br>\n</p>\n</blockquote>",
        "id": 482774573,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731767309
    },
    {
        "content": "<p>primoly edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590#issuecomment-2480594555\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9590\">issue #9590</a>:</p>\n<blockquote>\n<p>The reason for the spill is the call to another function which leads to Cranelift saving the value of  the<code>xmm</code> register on the stack so it can retrieve it afterwards (caller saves). But when Cranelift treats the two zeros before the call and after as different values, it just writes a fresh <code>0.0</code> into another <code>xmm</code> register. Notice how the non-spilling cases always use two different <code>xmm</code> registers while the spilling ones only use one, matching the non-spilling CLIF using <code>v55</code> before the <code>call fn0(v0, v0)</code> and <code>v2</code> after while the spilling CLIF uses <code>v2</code> before and after.<br>\n</p>\n</blockquote>",
        "id": 482779022,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1731770815
    }
]