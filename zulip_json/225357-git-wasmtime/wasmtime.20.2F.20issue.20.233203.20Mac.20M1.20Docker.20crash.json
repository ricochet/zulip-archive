[
    {
        "content": "<p>otaviopace labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p>I've created a repo just for this: <a href=\"https://github.com/otaviopace/mac-m1-wasmtime-docker\">https://github.com/otaviopace/mac-m1-wasmtime-docker</a>.</p>\n<p>To reproduce the error, one should build the docker image in a linux computer, than try to run it on a Mac M1 computer.</p>\n<p>For moving the image from one computer to the other, Docker Hub can be used, but <a href=\"https://stackoverflow.com/questions/24482822/how-to-share-my-docker-image-without-using-the-docker-hub/48856787#48856787\">this</a> works the same.</p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>Build docker image on Linux computer</li>\n<li>Load/pull built image on a Mac M1 computer</li>\n<li>Run the container</li>\n</ul>\n<h3>Expected Results</h3>\n<p><code>wasmtime</code> shouldn't crash from running amd64 on a Mac M1 computer.</p>\n<h3>Actual Results</h3>\n<p><code>wasmtime</code> crashes on the traphandlers file, like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">cool</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">assertion</span><span class=\"w\"> </span><span class=\"n\">failed</span>: <span class=\"err\">`</span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"p\">)</span><span class=\"err\">`</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">left</span>: <span class=\"err\">`</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">right</span>: <span class=\"err\">`</span><span class=\"mi\">0</span><span class=\"err\">`</span>: <span class=\"nc\">registering</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">sigaltstack</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">local</span><span class=\"o\">/</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">registry</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">github</span><span class=\"p\">.</span><span class=\"n\">com</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"n\">ecc6299db9ec823</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"mf\">0.27.0</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">traphandlers</span><span class=\"o\">/</span><span class=\"n\">unix</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">238</span>:<span class=\"mi\">9</span><span class=\"w\"></span>\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 0.27.0</p>\n<p>Operating system: Mac M1</p>\n<p>Architecture: arm64</p>\n<h3>Extra Info</h3>\n<p>This issue has been created because we're having this problem on <code>graph-node</code>: <a href=\"https://github.com/graphprotocol/graph-node/issues/2325\">https://github.com/graphprotocol/graph-node/issues/2325</a>.</p>\n<p>The weird thing is that we had no issues on the M1 running a Docker image built in Linux with <code>wasmtime</code> before. We have an automated process to generate the images for <code>graph-node</code>, and at some point in time, new images started to break without us changing this Docker automation, <code>wasmtime</code> version, or Docker for Mac version.</p>\n<p>To isolate the problem, I've created a repository that has a simple example with the same issue.</p>\n</blockquote>",
        "id": 249876516,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629304655
    },
    {
        "content": "<p>otaviopace opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p>I've created a repo just for this: <a href=\"https://github.com/otaviopace/mac-m1-wasmtime-docker\">https://github.com/otaviopace/mac-m1-wasmtime-docker</a>.</p>\n<p>To reproduce the error, one should build the docker image in a linux computer, than try to run it on a Mac M1 computer.</p>\n<p>For moving the image from one computer to the other, Docker Hub can be used, but <a href=\"https://stackoverflow.com/questions/24482822/how-to-share-my-docker-image-without-using-the-docker-hub/48856787#48856787\">this</a> works the same.</p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>Build docker image on Linux computer</li>\n<li>Load/pull built image on a Mac M1 computer</li>\n<li>Run the container</li>\n</ul>\n<h3>Expected Results</h3>\n<p><code>wasmtime</code> shouldn't crash from running amd64 on a Mac M1 computer.</p>\n<h3>Actual Results</h3>\n<p><code>wasmtime</code> crashes on the traphandlers file, like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">cool</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">assertion</span><span class=\"w\"> </span><span class=\"n\">failed</span>: <span class=\"err\">`</span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"p\">)</span><span class=\"err\">`</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">left</span>: <span class=\"err\">`</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">right</span>: <span class=\"err\">`</span><span class=\"mi\">0</span><span class=\"err\">`</span>: <span class=\"nc\">registering</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">sigaltstack</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">local</span><span class=\"o\">/</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">registry</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">github</span><span class=\"p\">.</span><span class=\"n\">com</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"n\">ecc6299db9ec823</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"mf\">0.27.0</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">traphandlers</span><span class=\"o\">/</span><span class=\"n\">unix</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">238</span>:<span class=\"mi\">9</span><span class=\"w\"></span>\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 0.27.0</p>\n<p>Operating system: Mac M1</p>\n<p>Architecture: arm64</p>\n<h3>Extra Info</h3>\n<p>This issue has been created because we're having this problem on <code>graph-node</code>: <a href=\"https://github.com/graphprotocol/graph-node/issues/2325\">https://github.com/graphprotocol/graph-node/issues/2325</a>.</p>\n<p>The weird thing is that we had no issues on the M1 running a Docker image built in Linux with <code>wasmtime</code> before. We have an automated process to generate the images for <code>graph-node</code>, and at some point in time, new images started to break without us changing this Docker automation, <code>wasmtime</code> version, or Docker for Mac version.</p>\n<p>To isolate the problem, I've created a repository that has a simple example with the same issue.</p>\n</blockquote>",
        "id": 249876517,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629304655
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901270705\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>Interesting -- it looks like this is an x86-64 binary running (via Rosetta 2) on M1 hardware? Does Docker on M1 run an x86-64 Linux kernel in a VM (as I think it works on Intel Mac hardware) or something else?</p>\n<p>@bnjbvr is our resident has-M1-hardware-and-knows-how-to-use-it person for M1 issues -- Ben, what do you think?</p>\n</blockquote>",
        "id": 249878399,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629305465
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901273708\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>If you can test out a custom build, <a href=\"https://github.com/bytecodealliance/wasmtime/pull/3204\">https://github.com/bytecodealliance/wasmtime/pull/3204</a> may help by providing the error code that <code>sigaltstack</code> is failing with (although I don't think it will help too much here in determining a cause...)</p>\n</blockquote>",
        "id": 249879084,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629305739
    },
    {
        "content": "<p>otaviopace <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901284937\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>@cfallin on the questions you've pointed out</p>\n<blockquote>\n<p>it looks like this is an x86-64 binary running (via Rosetta 2) on M1 hardware?</p>\n</blockquote>\n<p>Yes, it the problem seems to be related to Rosetta 2 translation.</p>\n<blockquote>\n<p>Does Docker on M1 run an x86-64 Linux kernel in a VM (as I think it works on Intel Mac hardware) or something else?</p>\n</blockquote>\n<p>I don't think Docker runs a VM for linux, I think it probably just uses Rosetta for the translation, but I'm not completly sure.</p>\n<p>@alexcrichton Thank you so much for the debug build, I'll try it and post the results here <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> </p>\n</blockquote>",
        "id": 249881436,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629306709
    },
    {
        "content": "<p>otaviopace edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901284937\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>@cfallin on the questions you've pointed out:</p>\n<blockquote>\n<p>it looks like this is an x86-64 binary running (via Rosetta 2) on M1 hardware?</p>\n</blockquote>\n<p>Yes, the problem seems to be related to Rosetta 2 translation.</p>\n<blockquote>\n<p>Does Docker on M1 run an x86-64 Linux kernel in a VM (as I think it works on Intel Mac hardware) or something else?</p>\n</blockquote>\n<p>I don't think Docker runs a VM for Linux, I think it probably just uses Rosetta for the translation, but I'm not completly sure.</p>\n<p>@alexcrichton Thank you so much for the debug build, I'll try it and post the results here <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> </p>\n</blockquote>",
        "id": 249882005,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629306927
    },
    {
        "content": "<p>peterhuene <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901344355\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>From Docker:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">trying</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"> </span><span class=\"n\">machine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">sometimes</span><span class=\"w\"> </span><span class=\"n\">crash</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">using</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">piece</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">software</span><span class=\"w\"> </span><span class=\"n\">called</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">emulate</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"w\"> </span><span class=\"n\">chips</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">occasionally</span><span class=\"w\"></span>\n<span class=\"n\">fails</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Where</span><span class=\"w\"> </span><span class=\"n\">possible</span><span class=\"w\"> </span><span class=\"n\">we</span><span class=\"w\"> </span><span class=\"n\">recommend</span><span class=\"w\"> </span><span class=\"n\">sticking</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"></span>\n<span class=\"n\">machines</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">also</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>From some Google searches, it seems that QEMU might have issues with <code>signaltstack</code> on M1 for x86-64 containers (seeing references to <code>EINVAL</code> for other projects).</p>\n<p>I think this might not be a Wasmtime issue currently.</p>\n</blockquote>",
        "id": 249893962,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629312149
    },
    {
        "content": "<p>peterhuene edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901344355\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>From Docker:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">trying</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"> </span><span class=\"n\">machine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">sometimes</span><span class=\"w\"> </span><span class=\"n\">crash</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">using</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">piece</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">software</span><span class=\"w\"> </span><span class=\"n\">called</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">emulate</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"w\"> </span><span class=\"n\">chips</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">occasionally</span><span class=\"w\"></span>\n<span class=\"n\">fails</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Where</span><span class=\"w\"> </span><span class=\"n\">possible</span><span class=\"w\"> </span><span class=\"n\">we</span><span class=\"w\"> </span><span class=\"n\">recommend</span><span class=\"w\"> </span><span class=\"n\">sticking</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"></span>\n<span class=\"n\">machines</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">also</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">However</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">attempts</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Apple</span><span class=\"w\"> </span><span class=\"n\">Silicon</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"n\">emulation</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"></span>\n<span class=\"n\">crash</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">sometimes</span><span class=\"w\"> </span><span class=\"n\">fails</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">addition</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filesystem</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">notification</span><span class=\"w\"> </span><span class=\"n\">APIs</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">inotify</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kr\">do</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">work</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">emulation</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Even</span><span class=\"w\"> </span><span class=\"n\">when</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"kr\">do</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">correctly</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"></span>\n<span class=\"n\">emulation</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">slower</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">equivalent</span><span class=\"p\">.</span><span class=\"w\"></span>\n\n<span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">summary</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Arm</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">regarded</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"></span>\n<span class=\"err\">“</span><span class=\"n\">best</span><span class=\"w\"> </span><span class=\"n\">effort</span><span class=\"err\">”</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">recommend</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Apple</span><span class=\"w\"> </span><span class=\"n\">Silicon</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">whenever</span><span class=\"w\"></span>\n<span class=\"n\">possible</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">encouraging</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"w\"> </span><span class=\"n\">authors</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">produce</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">arch</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">versions</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">their</span><span class=\"w\"></span>\n<span class=\"n\">containers</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">expect</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">issue</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"kr\">become</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">common</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">images</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"></span>\n<span class=\"n\">rebuilt</span><span class=\"w\"> </span><span class=\"n\">supporting</span><span class=\"w\"> </span><span class=\"n\">multiple</span><span class=\"w\"> </span><span class=\"n\">architectures</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>From some Google searches, it seems that QEMU might have issues with <code>signaltstack</code> on M1 for x86-64 containers (seeing references to <code>EINVAL</code> for other projects, e.g. running Chrome in an amd64 container).</p>\n<p>I think this might not be an actionable Wasmtime issue; we should see if an arm64 container has similar problems.</p>\n</blockquote>",
        "id": 249897207,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629313402
    },
    {
        "content": "<p>peterhuene edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901344355\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>From Docker:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">trying</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"> </span><span class=\"n\">machine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">sometimes</span><span class=\"w\"> </span><span class=\"n\">crash</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">using</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">piece</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">software</span><span class=\"w\"> </span><span class=\"n\">called</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">emulate</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"w\"> </span><span class=\"n\">chips</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">occasionally</span><span class=\"w\"></span>\n<span class=\"n\">fails</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Where</span><span class=\"w\"> </span><span class=\"n\">possible</span><span class=\"w\"> </span><span class=\"n\">we</span><span class=\"w\"> </span><span class=\"n\">recommend</span><span class=\"w\"> </span><span class=\"n\">sticking</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"></span>\n<span class=\"n\">machines</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">also</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">However</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">attempts</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Apple</span><span class=\"w\"> </span><span class=\"n\">Silicon</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"n\">emulation</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"></span>\n<span class=\"n\">crash</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">sometimes</span><span class=\"w\"> </span><span class=\"n\">fails</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">addition</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filesystem</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">notification</span><span class=\"w\"> </span><span class=\"n\">APIs</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">inotify</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kr\">do</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">work</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">emulation</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Even</span><span class=\"w\"> </span><span class=\"n\">when</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"kr\">do</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">correctly</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"></span>\n<span class=\"n\">emulation</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">slower</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">equivalent</span><span class=\"p\">.</span><span class=\"w\"></span>\n\n<span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">summary</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Arm</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">regarded</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"></span>\n<span class=\"err\">“</span><span class=\"n\">best</span><span class=\"w\"> </span><span class=\"n\">effort</span><span class=\"err\">”</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">recommend</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Apple</span><span class=\"w\"> </span><span class=\"n\">Silicon</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">whenever</span><span class=\"w\"></span>\n<span class=\"n\">possible</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">encouraging</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"w\"> </span><span class=\"n\">authors</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">produce</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">arch</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">versions</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">their</span><span class=\"w\"></span>\n<span class=\"n\">containers</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">expect</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">issue</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"kr\">become</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">common</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">images</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"></span>\n<span class=\"n\">rebuilt</span><span class=\"w\"> </span><span class=\"n\">supporting</span><span class=\"w\"> </span><span class=\"n\">multiple</span><span class=\"w\"> </span><span class=\"n\">architectures</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>From some Google searches, it seems that QEMU might have issues with <code>sigaltstack</code> on M1 for x86-64 containers (seeing references to <code>EINVAL</code> for other projects, e.g. running Chrome in an amd64 container).</p>\n<p>I think this might not be an actionable Wasmtime issue; we should see if an arm64 container has similar problems.</p>\n</blockquote>",
        "id": 249897630,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629313581
    },
    {
        "content": "<p>peterhuene edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901344355\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>From Docker:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">trying</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"> </span><span class=\"n\">machine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">sometimes</span><span class=\"w\"> </span><span class=\"n\">crash</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">using</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">piece</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">software</span><span class=\"w\"> </span><span class=\"n\">called</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">emulate</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"w\"> </span><span class=\"n\">chips</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">occasionally</span><span class=\"w\"></span>\n<span class=\"n\">fails</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Where</span><span class=\"w\"> </span><span class=\"n\">possible</span><span class=\"w\"> </span><span class=\"n\">we</span><span class=\"w\"> </span><span class=\"n\">recommend</span><span class=\"w\"> </span><span class=\"n\">sticking</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">M1</span><span class=\"w\"></span>\n<span class=\"n\">machines</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">also</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">However</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">attempts</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Apple</span><span class=\"w\"> </span><span class=\"n\">Silicon</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"n\">emulation</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"></span>\n<span class=\"n\">crash</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">sometimes</span><span class=\"w\"> </span><span class=\"n\">fails</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">addition</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filesystem</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">notification</span><span class=\"w\"> </span><span class=\"n\">APIs</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">inotify</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kr\">do</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">work</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"n\">qemu</span><span class=\"w\"> </span><span class=\"n\">emulation</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Even</span><span class=\"w\"> </span><span class=\"n\">when</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"kr\">do</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">correctly</span><span class=\"w\"> </span><span class=\"n\">under</span><span class=\"w\"></span>\n<span class=\"n\">emulation</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">slower</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">equivalent</span><span class=\"p\">.</span><span class=\"w\"></span>\n\n<span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">summary</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Arm</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">regarded</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"></span>\n<span class=\"err\">“</span><span class=\"n\">best</span><span class=\"w\"> </span><span class=\"n\">effort</span><span class=\"err\">”</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">recommend</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"w\"> </span><span class=\"n\">containers</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Apple</span><span class=\"w\"> </span><span class=\"n\">Silicon</span><span class=\"w\"> </span><span class=\"n\">machines</span><span class=\"w\"> </span><span class=\"n\">whenever</span><span class=\"w\"></span>\n<span class=\"n\">possible</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">encouraging</span><span class=\"w\"> </span><span class=\"n\">container</span><span class=\"w\"> </span><span class=\"n\">authors</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">produce</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">arch</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">versions</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">their</span><span class=\"w\"></span>\n<span class=\"n\">containers</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">expect</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">issue</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"kr\">become</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">common</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">images</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"></span>\n<span class=\"n\">rebuilt</span><span class=\"w\"> </span><span class=\"n\">supporting</span><span class=\"w\"> </span><span class=\"n\">multiple</span><span class=\"w\"> </span><span class=\"n\">architectures</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>From some Google searches, it seems that QEMU might have issues with <code>sigaltstack</code> on M1 for x86-64 containers (seeing references to <code>EINVAL</code> for other projects, e.g. running <a href=\"https://github.com/docker/for-mac/issues/5766\">Chrome in an amd64 container</a> or <a href=\"https://github.com/bitnami/bitnami-docker-rabbitmq/issues/147\">Rabbit MQ</a>).</p>\n<p>I think this might not be an actionable Wasmtime issue; we should see if an arm64 container has similar problems.</p>\n</blockquote>",
        "id": 249897822,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629313680
    },
    {
        "content": "<p>otaviopace <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901375128\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>@alexcrichton , with your debug change the log went from:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">registering</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">sigaltstack</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"></span>\n</code></pre></div>\n<p>to this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">registering</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">sigaltstack</span><span class=\"w\"> </span><span class=\"n\">failed</span>: <span class=\"nc\">Invalid</span><span class=\"w\"> </span><span class=\"n\">argument</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Does this mean the Rosetta 2 translation expects a different argument for <code>sigalstack</code>?</p>\n</blockquote>",
        "id": 249900750,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315147
    },
    {
        "content": "<p>otaviopace edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901375128\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>@alexcrichton , with your debug change the log went from:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">registering</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">sigaltstack</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"></span>\n</code></pre></div>\n<p>to this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">registering</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">sigaltstack</span><span class=\"w\"> </span><span class=\"n\">failed</span>: <span class=\"nc\">Invalid</span><span class=\"w\"> </span><span class=\"n\">argument</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Does this mean the Rosetta 2 translation expects a different argument for <code>sigalstack</code>?</p>\n<p>Edit: Just looked into similar issues @peterhuene linked and they get the same <code>Invalid argument (22)</code> result <span aria-label=\"disappointed\" class=\"emoji emoji-1f61e\" role=\"img\" title=\"disappointed\">:disappointed:</span> </p>\n</blockquote>",
        "id": 249900994,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315283
    },
    {
        "content": "<p>otaviopace <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377590\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>Unfortunetally this really isn't a problem with <code>wasmtime</code> itself, I'll close this for now, thanks a lot for the help <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span>️ </p>\n</blockquote>",
        "id": 249901218,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315400
    },
    {
        "content": "<p>otaviopace closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p>I've created a repo just for this: <a href=\"https://github.com/otaviopace/mac-m1-wasmtime-docker\">https://github.com/otaviopace/mac-m1-wasmtime-docker</a>.</p>\n<p>To reproduce the error, one should build the docker image in a linux computer, than try to run it on a Mac M1 computer.</p>\n<p>For moving the image from one computer to the other, Docker Hub can be used, but <a href=\"https://stackoverflow.com/questions/24482822/how-to-share-my-docker-image-without-using-the-docker-hub/48856787#48856787\">this</a> works the same.</p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>Build docker image on Linux computer</li>\n<li>Load/pull built image on a Mac M1 computer</li>\n<li>Run the container</li>\n</ul>\n<h3>Expected Results</h3>\n<p><code>wasmtime</code> shouldn't crash from running amd64 on a Mac M1 computer.</p>\n<h3>Actual Results</h3>\n<p><code>wasmtime</code> crashes on the traphandlers file, like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">cool</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">assertion</span><span class=\"w\"> </span><span class=\"n\">failed</span>: <span class=\"err\">`</span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"p\">)</span><span class=\"err\">`</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">left</span>: <span class=\"err\">`</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">right</span>: <span class=\"err\">`</span><span class=\"mi\">0</span><span class=\"err\">`</span>: <span class=\"nc\">registering</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">sigaltstack</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">local</span><span class=\"o\">/</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">registry</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">github</span><span class=\"p\">.</span><span class=\"n\">com</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"n\">ecc6299db9ec823</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"mf\">0.27.0</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">traphandlers</span><span class=\"o\">/</span><span class=\"n\">unix</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">238</span>:<span class=\"mi\">9</span><span class=\"w\"></span>\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 0.27.0</p>\n<p>Operating system: Mac M1</p>\n<p>Architecture: arm64</p>\n<h3>Extra Info</h3>\n<p>This issue has been created because we're having this problem on <code>graph-node</code>: <a href=\"https://github.com/graphprotocol/graph-node/issues/2325\">https://github.com/graphprotocol/graph-node/issues/2325</a>.</p>\n<p>The weird thing is that we had no issues on the M1 running a Docker image built in Linux with <code>wasmtime</code> before. We have an automated process to generate the images for <code>graph-node</code>, and at some point in time, new images started to break without us changing this Docker automation, <code>wasmtime</code> version, or Docker for Mac version.</p>\n<p>To isolate the problem, I've created a repository that has a simple example with the same issue.</p>\n</blockquote>",
        "id": 249901219,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315400
    },
    {
        "content": "<p>peterhuene <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377799\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>22 is <code>EINVAL</code>.</p>\n<p>My gut tells me that the bug fixed by this [QEMU commit](<br>\nI also found <a href=\"https://github.com/qemu/qemu/commit/ce437484fced8292d90497d7b740335428fffed6\">this QEMU commit</a> seems relevant as something that could lead to misinterpretation of a field like <code>ss_flags</code>.</p>\n<p>That fix went into QEMU 5.2; Docker For Mac seems to package QEMU 5.0.1.</p>\n</blockquote>",
        "id": 249901244,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315422
    },
    {
        "content": "<p>peterhuene edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377799\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>22 is <code>EINVAL</code>.</p>\n<p>My gut tells me that the bug fixed by this <a href=\"https://github.com/qemu/qemu/commit/ce437484fced8292d90497d7b740335428fffed6\">QEMU commit</a> seems relevant as something that could lead to misinterpretation of a field like <code>ss_flags</code>.</p>\n<p>That fix went into QEMU 5.2; Docker For Mac seems to package QEMU 5.0.1.</p>\n</blockquote>",
        "id": 249901281,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315442
    },
    {
        "content": "<p>otaviopace edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377590\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>Unfortunetelly this really isn't a problem with <code>wasmtime</code> itself, I'll close this for now, thanks a lot for the help <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span>️ </p>\n</blockquote>",
        "id": 249901329,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315462
    },
    {
        "content": "<p>otaviopace edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901377590\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>Unfortunetely this really isn't a problem with <code>wasmtime</code> itself, I'll close this for now, thanks a lot for the help <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span>️ </p>\n</blockquote>",
        "id": 249901343,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315470
    },
    {
        "content": "<p>otaviopace <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901379654\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>How do you know which version of QEMU does Docker for Mac use?</p>\n<p>I would like to keep an eye where I can know this version bump happened.</p>\n</blockquote>",
        "id": 249901650,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315607
    },
    {
        "content": "<p>otaviopace edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901379654\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>How do you know which version of QEMU does Docker for Mac use?</p>\n<p>I would like to keep an eye for when this version bump happens.</p>\n</blockquote>",
        "id": 249901702,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315639
    },
    {
        "content": "<p>peterhuene <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901380407\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>I pulled it from the <a href=\"https://docs.docker.com/desktop/mac/release-notes\">Docker for Mac's release notes</a>, last upgrade mentioning QEMU was 3.2.0, so I assume it hasn't been bumped since.</p>\n</blockquote>",
        "id": 249901778,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629315682
    },
    {
        "content": "<p>bnjbvr <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901740722\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>(Glad I could help! thanks for the ping @cfallin, I'm happy to investigate any Mac M1 specific failures.)</p>\n</blockquote>",
        "id": 249959832,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629363849
    },
    {
        "content": "<p>otaviopace <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203#issuecomment-901874296\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3203\">issue #3203</a>:</p>\n<blockquote>\n<p>I've created an issue in Docker for Mac to know if they plan or not to do this version bump soon (of QEMU).</p>\n<p>So if anyone wants to keep an eye/track this, here it is: <a href=\"https://github.com/docker/for-mac/issues/5919\">https://github.com/docker/for-mac/issues/5919</a></p>\n</blockquote>",
        "id": 249978682,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1629376198
    }
]