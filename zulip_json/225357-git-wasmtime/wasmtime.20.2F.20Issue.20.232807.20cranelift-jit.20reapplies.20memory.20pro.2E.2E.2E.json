[
    {
        "content": "<p>mchesser opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2807\">Issue #2807</a>:</p>\n<blockquote>\n<p>After calling <code>JITModule::finalize_definitions</code>, allocations for code/data are <code>mprotect</code>ed to be executable/readonly:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/6b77786a6e758e91da9484a1c80b6fa5f88e1b3d/cranelift/jit/src/memory.rs#L175-L231\">https://github.com/bytecodealliance/wasmtime/blob/6b77786a6e758e91da9484a1c80b6fa5f88e1b3d/cranelift/jit/src/memory.rs#L175-L231</a></p>\n<p>However, <code>self.executable</code> is never updated so <code>mprotect</code> is invoked for _all_ allocations, even ones that have the correct permissions. This makes future <code>finalize_definitions</code> slower.</p>\n<p>I think it can be fixed by just adding:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">executable</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">allocations</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">();</span><span class=\"w\"></span>\n</code></pre></div>\n<p>At the end of each of the protection functions.</p>\n</blockquote>",
        "id": 233265969,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1617684160
    },
    {
        "content": "<p>mchesser edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2807\">Issue #2807</a>:</p>\n<blockquote>\n<p>After calling <code>JITModule::finalize_definitions</code>, allocations for code/data are <code>mprotect</code>ed to be executable/readonly:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/6b77786a6e758e91da9484a1c80b6fa5f88e1b3d/cranelift/jit/src/memory.rs#L175-L231\">https://github.com/bytecodealliance/wasmtime/blob/6b77786a6e758e91da9484a1c80b6fa5f88e1b3d/cranelift/jit/src/memory.rs#L175-L231</a></p>\n<p>However, <code>self.executable</code> is never updated so <code>mprotect</code> is invoked for _all_ allocations, even ones that have the correct permissions. This makes future <code>finalize_definitions</code> slower.</p>\n<p>I think it can be fixed by just adding:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">executable</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">allocations</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">();</span><span class=\"w\"></span>\n</code></pre></div>\n<p>At the end of each of the protection functions, and fixing any clearing code.</p>\n</blockquote>",
        "id": 233266099,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1617684327
    }
]