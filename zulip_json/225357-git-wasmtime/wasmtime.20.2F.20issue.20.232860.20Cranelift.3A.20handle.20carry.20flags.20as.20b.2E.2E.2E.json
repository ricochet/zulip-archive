[
    {
        "content": "<p>cfallin edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2860\">issue #2860</a>:</p>\n<blockquote>\n<p>Hi! While using Cranelift as a backend for a project, I ran into a panic compiling iadd_carry instructions on x86_64. Please let me know if there is any other information I can provide that would be helpful.</p>\n<h3><code>.clif</code> Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">0</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"n\">block0</span>:\n    <span class=\"nc\">v1465</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1467</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bconst</span><span class=\"p\">.</span><span class=\"n\">b1</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1468</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1469</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1470</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_carry</span><span class=\"w\"> </span><span class=\"n\">v1465</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1468</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1467</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1476</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bint</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">v1470</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1356</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1391</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1423</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1447</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1464</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1494</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1516</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1544</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">v1476</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1356</span><span class=\"o\">+</span><span class=\"mi\">274</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">trap</span><span class=\"w\"> </span><span class=\"n\">user0</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<h3>Steps to Reproduce</h3>\n<p><code>cargo run -p cranelift-tools -- compile test.clif --target x86_64</code></p>\n<h3>Expected Results</h3>\n<p>Code successfully generates without a panic.</p>\n<h3>Actual Results</h3>\n<p>Panic: <code>thread 'main' panicked at 'ALU+imm and ALU+carry ops should not appear here!', cranelift/codegen/src/isa/x64/lower.rs:5740:13</code></p>\n<h3>Versions and Environment</h3>\n<p>Cranelift version or commit: main HEAD (4a830b at time of writing)</p>\n<p>Operating system: Linux</p>\n<p>Architecture: x86_64</p>\n</blockquote>",
        "id": 281211799,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1651694439
    },
    {
        "content": "<p>cfallin labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2860\">issue #2860</a>:</p>\n<blockquote>\n<p>Hi! While using Cranelift as a backend for a project, I ran into a panic compiling iadd_carry instructions on x86_64. Please let me know if there is any other information I can provide that would be helpful.</p>\n<h3><code>.clif</code> Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">0</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"n\">block0</span>:\n    <span class=\"nc\">v1465</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1467</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bconst</span><span class=\"p\">.</span><span class=\"n\">b1</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1468</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1469</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1470</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_carry</span><span class=\"w\"> </span><span class=\"n\">v1465</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1468</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1467</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1476</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bint</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">v1470</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1356</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1391</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1423</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1447</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1464</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1494</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1516</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">v1544</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">v1476</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1356</span><span class=\"o\">+</span><span class=\"mi\">274</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">trap</span><span class=\"w\"> </span><span class=\"n\">user0</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<h3>Steps to Reproduce</h3>\n<p><code>cargo run -p cranelift-tools -- compile test.clif --target x86_64</code></p>\n<h3>Expected Results</h3>\n<p>Code successfully generates without a panic.</p>\n<h3>Actual Results</h3>\n<p>Panic: <code>thread 'main' panicked at 'ALU+imm and ALU+carry ops should not appear here!', cranelift/codegen/src/isa/x64/lower.rs:5740:13</code></p>\n<h3>Versions and Environment</h3>\n<p>Cranelift version or commit: main HEAD (4a830b at time of writing)</p>\n<p>Operating system: Linux</p>\n<p>Architecture: x86_64</p>\n</blockquote>",
        "id": 281211828,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1651694450
    },
    {
        "content": "<p>scottmcm <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-1513677734\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2860\">issue #2860</a>:</p>\n<blockquote>\n<p>Is part of this fixed with <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5784\">https://github.com/bytecodealliance/wasmtime/pull/5784</a> ?</p>\n</blockquote>",
        "id": 350867714,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681845552
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2860#issuecomment-1513703434\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2860\">issue #2860</a>:</p>\n<blockquote>\n<p>I'm not entirely sure what this issue is about at this point, so it's hard to say whether it's fixed. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n<p>If it's about addition with carry not having a usable lowering on x86, then I think that was fixed either by #5784 or earlier work. Cranelift has changed a lot since this issue was opened so it's hard to even compare.</p>\n<p>If I consider only the issue title (\"handle carry flags as bools in backends\") then I think this was fixed by #5406 and earlier work.</p>\n<p>For chc4's use case of encoding the behavior of x86 flags into CLIF, I think we've gone the opposite direction since we've removed the notion of flags from the IR entirely. (Again, in #5406 and earlier.) It's always possible to encode values equivalent to x86's flags in integer values and carry those around, though we may not generate particularly efficient code from that encoding.</p>\n<p>Regardless of which interpretation we consider, I think this issue is no longer serving a useful purpose. So I'm going to close it.</p>\n<p>I'd suggest that anyone who encounters issues which sound like this should open a new issue, explaining exactly what you're seeing. Anything that comes up now is probably not related to the difficulties described in this issue.</p>\n</blockquote>",
        "id": 350871342,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681846906
    },
    {
        "content": "<p>jameysharp closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2860\">issue #2860</a>:</p>\n<blockquote>\n<p>Hi! While using Cranelift as a backend for a project, I ran into a panic compiling iadd_carry instructions on x86_64. Please let me know if there is any other information I can provide that would be helpful.</p>\n<h3><code>.clif</code> Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">0</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">block0</span>:\n    <span class=\"nc\">v1465</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v1467</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bconst</span><span class=\"p\">.</span><span class=\"n\">b1</span><span class=\"w\"> </span><span class=\"kc\">false</span>\n<span class=\"w\">    </span><span class=\"n\">v1468</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v1469</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1470</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd_carry</span><span class=\"w\"> </span><span class=\"n\">v1465</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1468</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1467</span>\n<span class=\"w\">    </span><span class=\"n\">v1476</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bint</span><span class=\"p\">.</span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"n\">v1470</span>\n<span class=\"w\">    </span><span class=\"n\">v1356</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">v1391</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span>\n<span class=\"w\">    </span><span class=\"n\">v1423</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span>\n<span class=\"w\">    </span><span class=\"n\">v1447</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span>\n<span class=\"w\">    </span><span class=\"n\">v1464</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span>\n<span class=\"w\">    </span><span class=\"n\">v1494</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span>\n<span class=\"w\">    </span><span class=\"n\">v1516</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span>\n<span class=\"w\">    </span><span class=\"n\">v1544</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v1356</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">v1476</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1356</span><span class=\"o\">+</span><span class=\"mi\">274</span>\n<span class=\"w\">    </span><span class=\"n\">trap</span><span class=\"w\"> </span><span class=\"n\">user0</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Steps to Reproduce</h3>\n<p><code>cargo run -p cranelift-tools -- compile test.clif --target x86_64</code></p>\n<h3>Expected Results</h3>\n<p>Code successfully generates without a panic.</p>\n<h3>Actual Results</h3>\n<p>Panic: <code>thread 'main' panicked at 'ALU+imm and ALU+carry ops should not appear here!', cranelift/codegen/src/isa/x64/lower.rs:5740:13</code></p>\n<h3>Versions and Environment</h3>\n<p>Cranelift version or commit: main HEAD (4a830b at time of writing)</p>\n<p>Operating system: Linux</p>\n<p>Architecture: x86_64</p>\n</blockquote>",
        "id": 350871344,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681846906
    }
]