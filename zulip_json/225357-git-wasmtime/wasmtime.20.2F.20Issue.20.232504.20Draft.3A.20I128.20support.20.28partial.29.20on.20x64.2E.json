[
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-743961307\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>For context, I should also note: this (<code>I128</code> support) is one of the few pieces still missing from the new x64 backend. The Wasm frontend does not use it, but <code>rustc_codegen_clif</code> does (cc @bjorn3). I expect we would need a few more ops before we can try this with cg_clif, though.</p>\n</blockquote>",
        "id": 219747386,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607841256
    },
    {
        "content": "<p>julian-seward1 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-743968618\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@cfallin As a general comment, I see the dilemma.  I haven't yet read the patch, but wanted to ask: part of the motivation for going this route was that we would then be able to remove the complexity, the semantic murkyness, and the potential for generating poor code, caused by having to explicitly represent the carry flag in CLIF.  If we revert to expanding out doubleword arithmetic at the CLIF level, is there some other way we can avoid those disadvantages?</p>\n<p>Also .. does it matter that, doing this per-target (per this patch) potentially makes it possible to use target-specific sequences, which wouldn't be possible if it were done at the CLIF level?</p>\n</blockquote>",
        "id": 219749536,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607845290
    },
    {
        "content": "<p>julian-seward1 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-743970582\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<blockquote>\n<p>doing this per-target (per this patch) potentially makes it possible to use target-specific sequences</p>\n</blockquote>\n<p>For example, doubleword comparison on x64 is a bit elaborate, but for aarch64 it's just <code>cmp ; ccmp</code>.</p>\n</blockquote>",
        "id": 219750081,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607846316
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-743980237\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>I just tested this with cg_clif. As far as I can see this works fine, but there are still missing pieces both related and unrelated to 128bit int support which mean that I can't completely test this yet.</p>\n<p><strong>support necessary in any case:</strong></p>\n<ul>\n<li><code>isplit</code>/<code>iconcat</code></li>\n<li><code>icmp.i128</code></li>\n<li><code>tls_value</code></li>\n<li><code>AbiPurpose::StructArg</code></li>\n</ul>\n<p><strong>support necessary to not require modifications of cg_clif:</strong></p>\n<ul>\n<li><code>load</code>/<code>store</code> of <code>i128</code></li>\n<li><code>rotl.i128</code>/<code>rotr.i128</code></li>\n<li><code>bitrev.i8</code></li>\n</ul>\n</blockquote>",
        "id": 219753936,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607852687
    },
    {
        "content": "<p>julian-seward1 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-743980302\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>One thing that does concern me is <code>struct ValueRegs</code>, in particular the potential inefficiency induced by it.  It's obviously fully general, in the sense that it can hold 4 unrelated <code>Reg</code> values, but it does require passing around a 128-bit thing where before we were just passing around a 32-bit thing (<code>Reg</code>).  And, given that it requires indexing, I reckon it ain't gonna wind up in a vector register, hence will always be in memory.</p>\n<p>I had wondered if such generality is really necessary.  Given that -- IIUC -- all the result virtual register fields are allocated before isel starts, would it be adequate to have an representation which specifies a base virtual register, plus zero, one or two subsequently-numbered vregs of the same class?  Then that would fit in 34 bits (hence, a <code>uint64_t</code>) and could be passed around in a (host) register just as <code>Reg</code> is now.</p>\n<p>Even if that won't work, does <code>ValueRegs</code> really need to be template-typed?  Are there any other types of things we need to store in there?</p>\n</blockquote>",
        "id": 219753948,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607852725
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-743980237\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>I just tested this with cg_clif. As far as I can see this works fine, but there are still missing pieces both related and unrelated to 128bit int support which mean that I can't completely test this yet.</p>\n<p><strong>support necessary in any case:</strong></p>\n<ul>\n<li><code>isplit</code>/<code>iconcat</code> (<a href=\"https://github.com/cfallin/wasmtime/pull/14\">https://github.com/cfallin/wasmtime/pull/14</a>)</li>\n<li><code>icmp.i128</code></li>\n<li><code>tls_value</code></li>\n<li><code>AbiPurpose::StructArg</code></li>\n</ul>\n<p><strong>support necessary to not require modifications of cg_clif:</strong></p>\n<ul>\n<li><code>load</code>/<code>store</code> of <code>i128</code></li>\n<li><code>rotl.i128</code>/<code>rotr.i128</code></li>\n<li><code>bitrev.i8</code></li>\n</ul>\n</blockquote>",
        "id": 219754334,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607853384
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-743980237\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>I just tested this with cg_clif. As far as I can see this works fine, but there are still missing pieces both related and unrelated to 128bit int support which mean that I can't completely test this yet.</p>\n<p><strong>support necessary in any case:</strong></p>\n<ul>\n<li><code>isplit</code>/<code>iconcat</code> (<a href=\"https://github.com/cfallin/wasmtime/pull/14\">https://github.com/cfallin/wasmtime/pull/14</a>)</li>\n<li><code>icmp.i128</code> (<a href=\"https://github.com/cfallin/wasmtime/pull/15\">https://github.com/cfallin/wasmtime/pull/15</a>)</li>\n<li><code>tls_value</code></li>\n<li><code>AbiPurpose::StructArg</code></li>\n</ul>\n<p><strong>support necessary to not require modifications of cg_clif:</strong></p>\n<ul>\n<li><code>load</code>/<code>store</code> of <code>i128</code></li>\n<li><code>rotl.i128</code>/<code>rotr.i128</code></li>\n<li><code>bitrev.i8</code></li>\n<li><code>brz.i128</code>/<code>brnz.i128</code></li>\n</ul>\n</blockquote>",
        "id": 219773847,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607884915
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-743980237\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>I just tested this with cg_clif. As far as I can see this works fine, but there are still missing pieces both related and unrelated to 128bit int support which mean that I can't completely test this yet.</p>\n<p><strong>support necessary in any case:</strong></p>\n<ul>\n<li><code>isplit</code>/<code>iconcat</code> (<a href=\"https://github.com/cfallin/wasmtime/pull/14\">https://github.com/cfallin/wasmtime/pull/14</a>)</li>\n<li><code>icmp.i128</code> (<a href=\"https://github.com/cfallin/wasmtime/pull/15\">https://github.com/cfallin/wasmtime/pull/15</a>)</li>\n<li><code>tls_value</code></li>\n<li><code>AbiPurpose::StructArg</code></li>\n<li><code>call</code> with <code>i128</code> arguments</li>\n</ul>\n<p><strong>support necessary to not require modifications of cg_clif:</strong></p>\n<ul>\n<li><code>load</code>/<code>store</code> of <code>i128</code></li>\n<li><code>rotl.i128</code>/<code>rotr.i128</code></li>\n<li><code>bitrev.i8</code></li>\n<li><code>brz.i128</code>/<code>brnz.i128</code></li>\n</ul>\n</blockquote>",
        "id": 219773894,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607884933
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744059346\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>So I'm starting to warm up to this approach relative to falling back on existing legalizations; it's really not too much more work to get to the end-point and the legalization is pretty hairy too. I'm working on the additional ops now; hopefully ready soon!</p>\n<p>To a few design-question points:</p>\n<blockquote>\n<p>One thing that does concern me is <code>struct ValueRegs</code>, in particular the potential inefficiency induced by it. It's obviously fully general, in the sense that it can hold 4 unrelated <code>Reg</code> values, but it does require passing around a 128-bit thing where before we were just passing around a 32-bit thing (<code>Reg</code>). And, given that it requires indexing, I reckon it ain't gonna wind up in a vector register, hence will always be in memory.</p>\n</blockquote>\n<p>I played with this a bit with Compiler Explorer (<a href=\"https://godbolt.org/z/jjWsKE\">link</a>) -- it seems it's passed by reference as an arg, but returned in two regs (<code>rdx:rax</code>). So, yeah, not as efficient as I had hoped, but at least it's not malloc'ing... though see below for alternative idea.</p>\n<blockquote>\n<p>I had wondered if such generality is really necessary. Given that -- IIUC -- all the result virtual register fields are allocated before isel starts, would it be adequate to have an representation which specifies a base virtual register, plus zero, one or two subsequently-numbered vregs of the same class? Then that would fit in 34 bits (hence, a <code>uint64_t</code>) and could be passed around in a (host) register just as <code>Reg</code> is now.</p>\n</blockquote>\n<p>Tempting idea! This doesn't handle the real-register case though (needed at least for ABI specs). I suppose we could special-case that but then we bifurcate some other APIs (gen load/spill, move, ...).</p>\n<p>I'm thinking that we might actually be able to optimize in another (much simpler) way -- on 64-bit machines and with our largest types being 128-bit, we can get away with the 1 / 2-reg cases. Perhaps we could define a static constant for size and, with some config magic, select <code>2</code> unless arm32 (or later, x86-32, etc.) are compiled in. Then we're just passing around 64 bits, which with padding is probably free relative to our current 32-bit size in most cases.</p>\n<blockquote>\n<p>Even if that won't work, does <code>ValueRegs</code> really need to be template-typed? Are there any other types of things we need to store in there?</p>\n</blockquote>\n<p>Yes, I did this to try to keep to the spirit of <code>Reg</code>, <code>WritableReg</code>, <code>VirtualReg</code>, <code>RealReg</code>. At least for the former two, I tried at first doing <code>Writable&lt;ValueRegs&gt;</code> instead, but <code>Writable</code> is defined in <code>regalloc</code> and requires implementation of a private trait, i.e., it's closed to new uses. IMHO it's somewhat nice for <code>regs()</code> to return (an array of) the correctly-typed thing in many cases...<br>\n</p>\n</blockquote>",
        "id": 219777743,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607889176
    },
    {
        "content": "<p>julian-seward1 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744062556\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@cfallin Great work, btw!  I should have said that earlier.<br>\n</p>\n</blockquote>",
        "id": 219779155,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607890725
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744103299\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>Just added implementations for (I think) all of the relevant <code>i128</code> ops. Will make a cleanup pass and address some of the comments above later. @bjorn3, I didn't get to the TLS support or <code>StructArg</code> support yet, but this <em>might</em> be close enough to hack something together? If not, I'll return to this in a bit :-)</p>\n</blockquote>",
        "id": 219790625,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607906963
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744134063\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@bjorn3 I just added what I <em>think</em> might be a sufficient implementation of ELF TLS support (basically just copying your recipe in the old x86 backend), and also permitted <code>StructReturn</code>-purpose args to compile. I'm not sure if any more needs to be done for the latter (does cg_clif rely on some sort of legalization that lowers into a struct-return pointer?).</p>\n<p>Let me know if this is sufficient to get cg_clif working! If so, I'll clean this up a bit and split out some pieces to actually land it.</p>\n</blockquote>",
        "id": 219795182,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607914490
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744134063\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@bjorn3 I just added what I <em>think</em> might be a sufficient implementation of ELF TLS support (basically just copying your recipe in the old x86 backend), and also permitted <code>StructReturn</code> (edit: and <code>StructArgument</code>)-purpose args to compile. I'm not sure if any more needs to be done for the latter (does cg_clif rely on some sort of legalization that lowers into a struct-return pointer?).</p>\n<p>Let me know if this is sufficient to get cg_clif working! If so, I'll clean this up a bit and split out some pieces to actually land it.</p>\n</blockquote>",
        "id": 219795482,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607914868
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744134063\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@bjorn3 I just added what I <em>think</em> might be a sufficient implementation of ELF TLS support (basically just copying your recipe in the old x86 backend), and also permitted <code>StructReturn</code> (edit: and <code>StructArgument</code>)-purpose args to compile. I'm not sure if any more needs to be done for the latter (does cg_clif rely on some sort of legalization that lowers into a struct-arg/return pointer?).</p>\n<p>Let me know if this is sufficient to get cg_clif working! If so, I'll clean this up a bit and split out some pieces to actually land it.</p>\n</blockquote>",
        "id": 219795494,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607914891
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744298014\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<blockquote>\n<p>Let me know if this is sufficient to get cg_clif working!</p>\n</blockquote>\n<p>Almost. The standard library compiles with the above TLS fix, but std_example fails at several points:</p>\n<ul>\n<li><code>saturating_sub::&lt;i128&gt;()</code> (<code>select.i128</code>?)</li>\n<li>u128 -&gt; float cast (incorrect return value)</li>\n<li><code>__m128i</code> -&gt; <code>[u8; 16]</code> transmute (<code>raw_bitcast</code> between <code>i64x2</code> and <code>i128</code>?)</li>\n</ul>\n</blockquote>",
        "id": 219815434,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607937203
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744298014\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<blockquote>\n<p>Let me know if this is sufficient to get cg_clif working!</p>\n</blockquote>\n<p>Almost. The standard library compiles with the above TLS fix, but std_example fails at several points:</p>\n<ul>\n<li><code>saturating_sub::&lt;i128&gt;()</code> (<code>select.i128</code>?)</li>\n<li>u128 -&gt; float cast (incorrect return value)</li>\n<li>&lt;strike&gt;<code>__m128i</code> -&gt; <code>[u8; 16]</code> transmute (<code>raw_bitcast</code> between <code>i64x2</code> and <code>i128</code>?)&lt;/strike&gt; (edit: it fixed itself somehow)</li>\n</ul>\n</blockquote>",
        "id": 219816119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607937676
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744327408\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>I got a SIGSEGV on simple-raytracer. I reduced it to:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">struct</span> <span class=\"nc\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">x</span>: <span class=\"kt\">f64</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">y</span>: <span class=\"kt\">f64</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">z</span>: <span class=\"kt\">f64</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">neg</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">x</span>: <span class=\"o\">-</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">y</span>: <span class=\"o\">-</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">y</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">z</span>: <span class=\"o\">-</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">x</span>: <span class=\"mf\">0.0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">y</span>: <span class=\"mf\">0.0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">z</span>: <span class=\"mf\">0.0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}.</span><span class=\"n\">neg</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">rr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">cont</span><span class=\"w\"></span>\n<span class=\"n\">Continuing</span><span class=\"p\">.</span><span class=\"w\"></span>\n\n<span class=\"n\">Program</span><span class=\"w\"> </span><span class=\"n\">received</span><span class=\"w\"> </span><span class=\"n\">signal</span><span class=\"w\"> </span><span class=\"n\">SIGSEGV</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Segmentation</span><span class=\"w\"> </span><span class=\"n\">fault</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"mh\">0x0000560560f17c2a</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">main</span>::<span class=\"n\">Vec3</span>::<span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">10</span><span class=\"w\"></span>\n<span class=\"mi\">10</span><span class=\"w\">                  </span><span class=\"n\">x</span>: <span class=\"o\">-</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">rr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">disassemble</span><span class=\"o\">/</span><span class=\"n\">r</span><span class=\"w\"></span>\n<span class=\"n\">Dump</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">assembler</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">main</span>::<span class=\"n\">Vec3</span>::<span class=\"n\">neg</span>:\n   <span class=\"mh\">0x0000560560f17c17</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span>:     <span class=\"mi\">55</span><span class=\"w\">      </span><span class=\"n\">push</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c18</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">1</span><span class=\"o\">&gt;</span>:     <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\">        </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c1b</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">4</span><span class=\"o\">&gt;</span>:     <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\">   </span><span class=\"n\">movabs</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x8000000000000000</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c25</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">14</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">c0</span><span class=\"w\">  </span><span class=\"n\">movq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm0</span><span class=\"w\"></span>\n<span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x0000560560f17c2a</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">19</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">06</span><span class=\"w\">     </span><span class=\"n\">xorpd</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">xmm0</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c2e</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">23</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\">   </span><span class=\"n\">movabs</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x8000000000000000</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c38</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">33</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">c8</span><span class=\"w\">  </span><span class=\"n\">movq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c3d</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">38</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\">  </span><span class=\"n\">xorpd</span><span class=\"w\">  </span><span class=\"mh\">0x8</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c42</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">43</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\">   </span><span class=\"n\">movabs</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x8000000000000000</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c4c</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">53</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">d0</span><span class=\"w\">  </span><span class=\"n\">movq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c51</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">58</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">  </span><span class=\"n\">xorpd</span><span class=\"w\">  </span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c56</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">63</span><span class=\"o\">&gt;</span>:    <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">07</span><span class=\"w\">     </span><span class=\"n\">movsd</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c5a</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">67</span><span class=\"o\">&gt;</span>:    <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\">  </span><span class=\"n\">movsd</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"mh\">0x8</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c5f</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">72</span><span class=\"o\">&gt;</span>:    <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">  </span><span class=\"n\">movsd</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c64</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">77</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\">        </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c67</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">80</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">5</span><span class=\"n\">d</span><span class=\"w\">      </span><span class=\"n\">pop</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c68</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">81</span><span class=\"o\">&gt;</span>:    <span class=\"nc\">c3</span><span class=\"w\">      </span><span class=\"n\">retq</span><span class=\"w\"></span>\n<span class=\"n\">End</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">assembler</span><span class=\"w\"> </span><span class=\"n\">dump</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">rr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">reg</span><span class=\"w\"> </span><span class=\"n\">rsi</span><span class=\"w\"></span>\n<span class=\"n\">rsi</span><span class=\"w\">            </span><span class=\"mh\">0x7ffd802b5678</span><span class=\"w\">      </span><span class=\"mi\">140726753777272</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">rr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"mh\">0x7ffd802b5678</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"cp\">$</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 219820072,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1607940088
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-744327408\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>I got a SIGSEGV on simple-raytracer. I reduced it to:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">struct</span> <span class=\"nc\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">x</span>: <span class=\"kt\">f64</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">y</span>: <span class=\"kt\">f64</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">z</span>: <span class=\"kt\">f64</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">neg</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">x</span>: <span class=\"o\">-</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">y</span>: <span class=\"o\">-</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">y</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">z</span>: <span class=\"o\">-</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">Vec3</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">x</span>: <span class=\"mf\">0.0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">y</span>: <span class=\"mf\">0.0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">z</span>: <span class=\"mf\">0.0</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}.</span><span class=\"n\">neg</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">rr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">cont</span><span class=\"w\"></span>\n<span class=\"n\">Continuing</span><span class=\"p\">.</span><span class=\"w\"></span>\n\n<span class=\"n\">Program</span><span class=\"w\"> </span><span class=\"n\">received</span><span class=\"w\"> </span><span class=\"n\">signal</span><span class=\"w\"> </span><span class=\"n\">SIGSEGV</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Segmentation</span><span class=\"w\"> </span><span class=\"n\">fault</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"mh\">0x0000560560f17c2a</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">main</span>::<span class=\"n\">Vec3</span>::<span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">10</span><span class=\"w\"></span>\n<span class=\"mi\">10</span><span class=\"w\">                  </span><span class=\"n\">x</span>: <span class=\"o\">-</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">rr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">disassemble</span><span class=\"o\">/</span><span class=\"n\">r</span><span class=\"w\"></span>\n<span class=\"n\">Dump</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">assembler</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">main</span>::<span class=\"n\">Vec3</span>::<span class=\"n\">neg</span>:\n   <span class=\"mh\">0x0000560560f17c17</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span>:     <span class=\"mi\">55</span><span class=\"w\">      </span><span class=\"n\">push</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c18</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">1</span><span class=\"o\">&gt;</span>:     <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\">        </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c1b</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">4</span><span class=\"o\">&gt;</span>:     <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\">   </span><span class=\"n\">movabs</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x8000000000000000</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c25</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">14</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">c0</span><span class=\"w\">  </span><span class=\"n\">movq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm0</span><span class=\"w\"></span>\n<span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"mh\">0x0000560560f17c2a</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">19</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">06</span><span class=\"w\">     </span><span class=\"n\">xorpd</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">xmm0</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c2e</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">23</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\">   </span><span class=\"n\">movabs</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x8000000000000000</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c38</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">33</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">c8</span><span class=\"w\">  </span><span class=\"n\">movq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c3d</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">38</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\">  </span><span class=\"n\">xorpd</span><span class=\"w\">  </span><span class=\"mh\">0x8</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c42</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">43</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">b8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\">   </span><span class=\"n\">movabs</span><span class=\"w\"> </span><span class=\"cp\">$</span><span class=\"mh\">0x8000000000000000</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c4c</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">53</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">d0</span><span class=\"w\">  </span><span class=\"n\">movq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rax</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c51</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">58</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">  </span><span class=\"n\">xorpd</span><span class=\"w\">  </span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsi</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c56</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">63</span><span class=\"o\">&gt;</span>:    <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">07</span><span class=\"w\">     </span><span class=\"n\">movsd</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c5a</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">67</span><span class=\"o\">&gt;</span>:    <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">08</span><span class=\"w\">  </span><span class=\"n\">movsd</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm1</span><span class=\"p\">,</span><span class=\"mh\">0x8</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c5f</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">72</span><span class=\"o\">&gt;</span>:    <span class=\"nc\">f2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">  </span><span class=\"n\">movsd</span><span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">xmm2</span><span class=\"p\">,</span><span class=\"mh\">0x10</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c64</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">77</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\">        </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c67</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">80</span><span class=\"o\">&gt;</span>:    <span class=\"mi\">5</span><span class=\"n\">d</span><span class=\"w\">      </span><span class=\"n\">pop</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mh\">0x0000560560f17c68</span><span class=\"w\"> </span><span class=\"o\">&lt;+</span><span class=\"mi\">81</span><span class=\"o\">&gt;</span>:    <span class=\"nc\">c3</span><span class=\"w\">      </span><span class=\"n\">retq</span><span class=\"w\"></span>\n<span class=\"n\">End</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">assembler</span><span class=\"w\"> </span><span class=\"n\">dump</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">rr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">reg</span><span class=\"w\"> </span><span class=\"n\">rsi</span><span class=\"w\"></span>\n<span class=\"n\">rsi</span><span class=\"w\">            </span><span class=\"mh\">0x7ffd802b5678</span><span class=\"w\">      </span><span class=\"mi\">140726753777272</span><span class=\"w\"></span>\n<span class=\"p\">(</span><span class=\"n\">rr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"mh\">0x7ffd802b5678</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"cp\">$</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Edit: This bug is unrelated to this PR. I opened #2507.</p>\n</blockquote>",
        "id": 220247779,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1608214475
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-751633216\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@bjorn3 I just pushed a number of fixes/updates; this I think addresses everything above except for the <code>StructReturn</code> fix and whatever is causing the u128 to/from float conversion error. (I'm testing with a local <code>rustc_codegen_cranelift</code> checkout; I see the same error that you're presumably seeing on <a href=\"http://std_example.rs\">std_example.rs</a> line 79, converting u128-&gt;f32).</p>\n<p>I'm not sure if the latter has to do with the former; it seems that the u128-&gt;f32 conversion is a call into libgcc so I suspect it's an ABI issue rather than an i128 arithmetic issue. (Thank goodness for that; I started to work out the open-coded sequence for each of the u128 to/from f32/f64 cases, signed/unsigned, and quickly ran away...)</p>\n<p>I won't have more time to look at this for a bit (I'm mostly away until after the new year) but if you have any further debugging insights or want to try to implement the <code>StructReturn</code> fix (I think we just need to preprend a StructReturn return value if an arg exists, and wire the value through) please feel free!</p>\n<p>(Also it mostly goes without saying but since this PR has grown quite a bit beyond just i128 arithmetic, I plan to split it up into proper pieces for separate review once we confirm that cg_clif works.)</p>\n</blockquote>",
        "id": 221046926,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609144690
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-751652250\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<blockquote>\n<p>I'm not sure if the latter has to do with the former; it seems that the u128-&gt;f32 conversion is a call into libgcc so I suspect it's an ABI issue rather than an i128 arithmetic issue.</p>\n</blockquote>\n<p>On my system it calls into rust's compiler-builtins.</p>\n<blockquote>\n<p>or want to try to implement the StructReturn fix (I think we just need to preprend a StructReturn return value if an arg exists, and wire the value through)</p>\n</blockquote>\n<p>That and use the correct register. It isn't very important though as the old backend didn't implement it either.</p>\n</blockquote>",
        "id": 221049700,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609148526
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-751663896\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>Minimal repro:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">convert</span><span class=\"p\">(</span><span class=\"n\">i</span>: <span class=\"kt\">u128</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">f32</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"c1\">// this branch is taken</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mf\">0.0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">extract_sign</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// except when this call is removed</span>\n\n<span class=\"w\">    </span><span class=\"mf\">100.0</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">convert</span><span class=\"p\">(</span><span class=\"mi\">100</span><span class=\"kt\">u128</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"mf\">100.0</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">extract_sign</span><span class=\"p\">(</span><span class=\"n\">i</span>: <span class=\"kt\">u128</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Assembly of <code>convert</code>:</p>\n<p><div class=\"codehilite\" data-code-language=\"GAS\"><pre><span></span><code><span class=\"err\">00000000000</span><span class=\"nf\">f4af5</span> <span class=\"err\">&lt;</span><span class=\"no\">_ZN11std_example7convert17ha5c22c0f04088fadE</span><span class=\"err\">&gt;</span><span class=\"p\">:</span>\n   <span class=\"nl\">f4af5:</span>       <span class=\"err\">55</span>                      <span class=\"nf\">push</span>   <span class=\"nv\">%rbp</span>\n   <span class=\"nl\">f4af6:</span>       <span class=\"err\">48</span> <span class=\"err\">89</span> <span class=\"nf\">e5</span>                <span class=\"no\">mov</span>    <span class=\"nv\">%rsp</span><span class=\"p\">,</span><span class=\"nv\">%rbp</span>\n   <span class=\"nl\">f4af9:</span>       <span class=\"err\">48</span> <span class=\"err\">83</span> <span class=\"nf\">ff</span> <span class=\"mi\">00</span>             <span class=\"no\">cmp</span>    <span class=\"no\">$0x0</span><span class=\"p\">,</span><span class=\"nv\">%rdi</span>\n   <span class=\"nl\">f4afd:</span>       <span class=\"err\">40</span> <span class=\"err\">0</span><span class=\"nf\">f</span> <span class=\"mi\">94</span> <span class=\"no\">c0</span>             <span class=\"no\">sete</span>   <span class=\"nv\">%al</span>\n   <span class=\"nl\">f4b01:</span>       <span class=\"err\">48</span> <span class=\"err\">83</span> <span class=\"nf\">fe</span> <span class=\"mi\">00</span>             <span class=\"no\">cmp</span>    <span class=\"no\">$0x0</span><span class=\"p\">,</span><span class=\"nv\">%rsi</span>\n   <span class=\"nl\">f4b05:</span>       <span class=\"err\">40</span> <span class=\"err\">0</span><span class=\"nf\">f</span> <span class=\"mi\">94</span> <span class=\"no\">c1</span>             <span class=\"no\">sete</span>   <span class=\"nv\">%cl</span>\n   <span class=\"nl\">f4b09:</span>       <span class=\"err\">48</span> <span class=\"err\">21</span> <span class=\"nf\">c1</span>                <span class=\"no\">and</span>    <span class=\"nv\">%rax</span><span class=\"p\">,</span><span class=\"nv\">%rcx</span>\n   <span class=\"nl\">f4b0c:</span>       <span class=\"err\">0</span><span class=\"nf\">f</span> <span class=\"mi\">84</span> <span class=\"mi\">08</span> <span class=\"mi\">00</span> <span class=\"mi\">00</span> <span class=\"mi\">00</span>       <span class=\"no\">je</span>     <span class=\"mh\">f4b1a</span> <span class=\"p\">&lt;</span><span class=\"no\">_ZN11std_example7convert17ha5c22c0f04088fadE</span><span class=\"p\">+</span><span class=\"mi\">0x25</span><span class=\"p\">&gt;</span>\n   <span class=\"nl\">f4b12:</span>       <span class=\"err\">0</span><span class=\"nf\">f</span> <span class=\"mi\">57</span> <span class=\"no\">c0</span>                <span class=\"no\">xorps</span>  <span class=\"nv\">%xmm0</span><span class=\"p\">,</span><span class=\"nv\">%xmm0</span>\n   <span class=\"nl\">f4b15:</span>       <span class=\"err\">48</span> <span class=\"err\">89</span> <span class=\"nf\">ec</span>                <span class=\"no\">mov</span>    <span class=\"nv\">%rbp</span><span class=\"p\">,</span><span class=\"nv\">%rsp</span>\n   <span class=\"nl\">f4b18:</span>       <span class=\"err\">5</span><span class=\"nf\">d</span>                      <span class=\"no\">pop</span>    <span class=\"nv\">%rbp</span>\n   <span class=\"nl\">f4b19:</span>       <span class=\"nf\">c3</span>                      <span class=\"no\">retq</span>\n   <span class=\"nl\">f4b1a:</span>       <span class=\"nf\">e8</span> <span class=\"no\">a1</span> <span class=\"mi\">01</span> <span class=\"mi\">00</span> <span class=\"mi\">00</span>          <span class=\"no\">callq</span>  <span class=\"mh\">f4cc0</span> <span class=\"p\">&lt;</span><span class=\"no\">_ZN11std_example12extract_sign17h8b332672bd416c0aE</span><span class=\"p\">&gt;</span>\n   <span class=\"nl\">f4b1f:</span>       <span class=\"nf\">be</span> <span class=\"mi\">00</span> <span class=\"mi\">00</span> <span class=\"no\">c8</span> <span class=\"mi\">42</span>          <span class=\"no\">mov</span>    <span class=\"no\">$0x42c80000</span><span class=\"p\">,</span><span class=\"nv\">%esi</span>\n   <span class=\"nl\">f4b24:</span>       <span class=\"err\">66</span> <span class=\"err\">0</span><span class=\"nf\">f</span> <span class=\"mi\">6</span><span class=\"no\">e</span> <span class=\"no\">c6</span>             <span class=\"no\">movd</span>   <span class=\"nv\">%esi</span><span class=\"p\">,</span><span class=\"nv\">%xmm0</span>\n   <span class=\"nl\">f4b28:</span>       <span class=\"err\">48</span> <span class=\"err\">89</span> <span class=\"nf\">ec</span>                <span class=\"no\">mov</span>    <span class=\"nv\">%rbp</span><span class=\"p\">,</span><span class=\"nv\">%rsp</span>\n   <span class=\"nl\">f4b2b:</span>       <span class=\"err\">5</span><span class=\"nf\">d</span>                      <span class=\"no\">pop</span>    <span class=\"nv\">%rbp</span>\n   <span class=\"nl\">f4b2c:</span>       <span class=\"nf\">c3</span>                      <span class=\"no\">retq</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 221051603,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609150989
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-751876526\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@bjorn3 thanks for that repro -- the disassembly made it pretty clear what was wrong: brz/brnz on an i128 used an incorrect width of and/or instruction. Pushed a fix just now.</p>\n<p>Locally, <code>./test.sh</code> in rustc_codegen_cranelift using this branch now seems to pass all the tests; it dies later during benchmarking but I'm not sure what's wrong:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Benchmark</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span>: <span class=\"o\">../</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">cargo</span><span class=\"p\">.</span><span class=\"n\">sh</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"></span>\n<span class=\"n\">Error</span>: <span class=\"nc\">Command</span><span class=\"w\"> </span><span class=\"n\">terminated</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">non</span><span class=\"o\">-</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"o\">'-</span><span class=\"n\">i</span><span class=\"sc\">'/'</span><span class=\"o\">--</span><span class=\"n\">ignore</span><span class=\"o\">-</span><span class=\"n\">failure</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">want</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">ignore</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">Alternatively</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"o\">'--</span><span class=\"n\">show</span><span class=\"o\">-</span><span class=\"n\">output</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"w\"> </span><span class=\"n\">what</span><span class=\"w\"> </span><span class=\"n\">went</span><span class=\"w\"> </span><span class=\"n\">wrong</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>(Also, in case it's relevant, I set <code>JIT_SUPPORTED=0</code> in <code>scripts/config.sh</code> as that seemed to get me past an issue related to the TLS relocation not being handled in cranelift-jit. Known issue?)</p>\n<p>In any case, I'm happy that this seems to allow cg_clif to pass the tests in <code>examples/</code> :-)</p>\n</blockquote>",
        "id": 221094202,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609192597
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-751881202\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<blockquote>\n<p>Locally, ./test.sh in rustc_codegen_cranelift using this branch now seems to pass all the tests</p>\n</blockquote>\n<p><span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>\n<blockquote>\n<p>it dies later during benchmarking but I'm not sure what's wrong:</p>\n</blockquote>\n<p>Can you add <code>--show-output</code> to the hyperfine invocation in <code>scripts/tests.sh</code>? I can't test it myself until tomorrow. You could also cd to <code>simple-raytracer</code> and then run <code>../build/cargo.sh build</code> directly to avoid having to build the sysroot again.</p>\n</blockquote>",
        "id": 221095529,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609193852
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-751919821\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>I tried building simple-raytracer, and the <code>cg_clif</code> invocation to compile the <code>tiff</code> crate is dying with a segfault:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">tiff</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">2.1</span><span class=\"w\"></span>\n<span class=\"n\">error</span>: <span class=\"nc\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">tiff</span><span class=\"err\">`</span><span class=\"w\"></span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n  <span class=\"nc\">process</span><span class=\"w\"> </span><span class=\"n\">didn</span><span class=\"o\">'</span><span class=\"na\">t</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">successfully</span>: <span class=\"err\">`</span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">cfallin</span><span class=\"o\">/</span><span class=\"n\">work</span><span class=\"o\">/</span><span class=\"n\">rustc_codegen_cranelift</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">cg_clif</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"k\">crate</span><span class=\"o\">-</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">tiff</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">..</span><span class=\"p\">.]</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">signal</span>: <span class=\"mi\">11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">SIGSEGV</span>: <span class=\"nc\">invalid</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">reference</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I tracked this back to a nonsense pointer passed into <code>slice::copy_from_slice</code> and tracked it backward with rr for a while; but couldn't reach the origin (it's a somewhat manual process tracing through disassemblies and setting memory watchpoints). Valgrind shows that the pointer itself is undefined data. So we're missing some sort of dataflow linkage (a store? ABI semantics related to wide values?) but I've hit my quota for today. Curious to see if you can discover more!</p>\n<p>(I implemented <code>StructReturn</code> slightly more properly but this didn't seem to be the problem; wasn't likely, as you noted, but wanted to be sure.)</p>\n</blockquote>",
        "id": 221106047,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609207423
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-751959529\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>This is a proc macro that has an ABI incompatibility with the cg_llvm comliled rustc due to <code>StructArgument</code> not yet being implemented.</p>\n</blockquote>",
        "id": 221114300,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609222012
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-752004205\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@bjorn3 I went ahead and implemented <code>StructArgument</code> as well. With that done, <code>simple-raytracer</code> builds, and its binary runs to completion. (The following is the first result computed via rustc -&gt; cg_clif -&gt; x64-new-backend, aside from compilations themselves: <a href=\"https://cfallin.org/misc/cg_clif-raytracer-20201229-result.png\">result.png</a>!)</p>\n<p>There do seem to be a few last test failures later in the <code>test.sh</code> run (in the stdlib I guess?): <code>1139 passed; 16 failed</code>, mostly some <code>i8</code>/<code>i16</code> ops and some FP string formatting issues. The former doesn't surprise me too much as narrow-value support is still somewhat young relative to the 32/64-bit paths that are well-hammered by Wasm. In any case, if you (or anyone else) feel like taking a look at those last issues, please do feel free!</p>\n<p>I'll clean up this mess of a draft branch when I'm actually \"working\" again on Jan 4 :-)</p>\n</blockquote>",
        "id": 221121152,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609232842
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-752260196\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>Last two fixes pushed: <code>DIV</code> on 8-bit values places remainders in <code>AH</code>, not <code>DL</code> (the weird and wonderful depths of x86 never cease to amuse!), and our <code>select</code> impl wasn't recognizing that booleans are integers and need integer moves.</p>\n<p>All stdlib tests pass now! I really will close my laptop now and read some books until I clean this up in the new year :-)</p>\n</blockquote>",
        "id": 221172419,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609280068
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-752264958\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>Yay! I hope you will have a great New Year!</p>\n</blockquote>",
        "id": 221173806,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609281383
    },
    {
        "content": "<p>julian-seward1 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-752373518\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@cfallin </p>\n<blockquote>\n<p>DIV on 8-bit values places remainders in AH, not DL<br>\nThat's surely a case of the general redundant-REX (0x40) rule, or in this case the lack of 0x40?  Does the remainder go in DL if there's an 0x40 prefix?</p>\n</blockquote>\n</blockquote>",
        "id": 221198025,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609317012
    },
    {
        "content": "<p>julian-seward1 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-752373518\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>@cfallin </p>\n<blockquote>\n<p>DIV on 8-bit values places remainders in AH, not DL</p>\n</blockquote>\n<p>That's surely a case of the general redundant-REX (0x40) rule, or in this case the lack of 0x40?  Does the remainder go in DL if there's an 0x40 prefix?</p>\n</blockquote>",
        "id": 221198030,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609317026
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-752706444\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<blockquote>\n<p>@cfallin</p>\n<blockquote>\n<p>DIV on 8-bit values places remainders in AH, not DL</p>\n</blockquote>\n<p>That's surely a case of the general redundant-REX (0x40) rule, or in this case the lack of 0x40? Does the remainder go in DL if there's an 0x40 prefix?</p>\n</blockquote>\n<p>Sadly no, a REX prefix doesn't change anything -- it's just the way the 8-bit variant is defined (<a href=\"https://c9x.me/x86/html/file_module_x86_id_72.html\">reference</a>). A likely remnant of the 8086 days when AL and AH were separately-useful registers for byte-sized values...</p>\n</blockquote>",
        "id": 221231926,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609350965
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-752706444\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<blockquote>\n<p>@cfallin</p>\n<blockquote>\n<p>DIV on 8-bit values places remainders in AH, not DL</p>\n</blockquote>\n<p>That's surely a case of the general redundant-REX (0x40) rule, or in this case the lack of 0x40? Does the remainder go in DL if there's an 0x40 prefix?</p>\n</blockquote>\n<p>Sadly no, a REX prefix doesn't change anything -- it's just the way the 8-bit variant is defined (<a href=\"https://c9x.me/x86/html/file_module_x86_id_72.html\">reference</a>). A likely remnant of the 8086 days when AL and AH were separately-useful registers for byte-sized values...</p>\n<p>(Edit: here's <a href=\"https://www.felixcloutier.com/x86/div\">another reference</a> showing more -- a REX byte will change whether the divisor arg refers to low byte of one of the 16 x86-64 registers, or a low/high byte of one of the 8 original registers; but remainder always goes into AH.)</p>\n</blockquote>",
        "id": 221232133,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609351141
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-753775441\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>Did some rebase/squash surgery on this branch -- I will split it into I think 8 PRs:</p>\n<ul>\n<li>Multi-reg value framework</li>\n<li>I128 ops for x64 backend</li>\n<li>TLS support in x64 backend</li>\n<li>StructArg/StructRet ABI support in x64/aarch64</li>\n<li>Fix to #2508 (REX prefix fixes for 8-bit instructions)</li>\n<li>Fix to #2507 (Avoid unaligned SSE loads)</li>\n<li>urem/srem bugfix for 8-bit DIV</li>\n<li>select.b1 bugfix</li>\n</ul>\n<p>Several of the above are dependent on the multi-reg refactor but the rest should be reviewable in parallel.</p>\n</blockquote>",
        "id": 221491961,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609740138
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-753787796\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>The pieces were a bit more interrelated than I had hoped so this became four PRs: #2538 (framework), #2539 (i128 ops), #2540 (TLS), #2541 (struct args). 2539 depends on 2538; and 2540/2541 depend on 2538 and 2539.</p>\n</blockquote>",
        "id": 221493281,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609742252
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504#issuecomment-754787315\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2504\">Issue #2504</a>:</p>\n<blockquote>\n<p>Closing this draft PR now that the real PRs resulting from it are under review.</p>\n</blockquote>",
        "id": 221676959,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1609868399
    }
]