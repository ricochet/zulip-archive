[
    {
        "content": "<p>cfallin opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>\n</blockquote>",
        "id": 194470787,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587143051
    },
    {
        "content": "<p>bnjbvr labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>\n</blockquote>",
        "id": 194472025,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587143566
    },
    {
        "content": "<p>bnjbvr labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>\n</blockquote>",
        "id": 194472026,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587143566
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-615367693\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-615367693\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @bnjbvr</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"cranelift\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>bnjbvr: cranelift</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\" title=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 194473165,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587144111
    },
    {
        "content": "<p>cfallin labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>\n</blockquote>",
        "id": 194515909,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587169297
    },
    {
        "content": "<p>bnjbvr <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-617215842\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-617215842\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>For what it's worth, the <code>x86</code> legalization used a slightly <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/meta/src/isa/x86/legalize.rs#L231-L247\" title=\"https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/meta/src/isa/x86/legalize.rs#L231-L247\">different sequence</a> that ought to be reusable here. Would it make sense to make it a target-independent legalization, and use it in <code>simple_legalize</code> then? (doing it at the CLIR level would allow applying optimizations onto the constants, esp. GVN could common out the constants instead of regenerating as many times as the popcnt instruction is used)</p>\n</blockquote>",
        "id": 194809629,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1587479337
    },
    {
        "content": "<p>akirilov-arm <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-690505468\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>Note that the proper implementation for 32- and 64-bit operands may use the Neon <code>CNT</code> instruction (for example, <a href=\"https://godbolt.org/z/78EWMe\">this</a> is what GCC and LLVM do), so a target-independent legalization may be counterproductive. However, I am not sure about 8- and 16-bit operands.</p>\n</blockquote>",
        "id": 209676581,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1599757001
    },
    {
        "content": "<p>akirilov-arm <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-763021734\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>I decided to compare the approach using the Neon <code>CNT</code> instruction (which I'll call \"vector\") with the one that just used operations on general-purpose registers (i.e. the existing implementation in Cranelift, which I'll call \"scalar\"), so I wrote several microbenchmarks.</p>\n<p>Here's the scalar implementation for 8-bit operands:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x55555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0xf</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And the vector one:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">fmov</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cnt</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">umov</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>16-bit scalar:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x55555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0f0f0f0f</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0xff</span><span class=\"w\"></span>\n</code></pre></div>\n<p>16-bit vector:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">fmov</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cnt</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">addp</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">umov</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>32-bit scalar:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x55555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0f0f0f0f</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x01010101</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">24</span><span class=\"w\"></span>\n</code></pre></div>\n<p>32-bit vector (almost the same as the 64-bit one - only the first instruction differs):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">fmov</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cnt</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">addv</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">umov</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>For the 64-bit case I tried 2 scalar variants - one that doesn't use multiplication and another one that does; here's the first one:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x5555555555555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x3333333333333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x3333333333333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0f0f0f0f0f0f0f0f</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsl</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsl</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsl</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">32</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">56</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And the second one:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x5555555555555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x3333333333333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x3333333333333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0f0f0f0f0f0f0f0f</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0101010101010101</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">56</span><span class=\"w\"></span>\n</code></pre></div>\n<p>64-bit vector:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">fmov</span><span class=\"w\"> </span><span class=\"n\">dt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cnt</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">addv</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">umov</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Here are the results for various microarchitectures in terms of speedup achieved by the vector implementation, i.e. higher numbers mean that the latter is better (the raw values that are measured are actually runtimes, hence speedup):</p>\n<table>\n<thead>\n<tr>\n<th>CPU core</th>\n<th>8-bit latency speedup</th>\n<th>8-bit throughput speedup</th>\n<th>16-bit latency speedup</th>\n<th>16-bit throughput speedup</th>\n<th>32-bit latency speedup</th>\n<th>32-bit throughput speedup</th>\n<th>64-bit latency speedup</th>\n<th>64-bit throughput speedup</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Arm Cortex-A55</td>\n<td>252.84%</td>\n<td>276.55%</td>\n<td>224.39%</td>\n<td>241.52%</td>\n<td>256.10%</td>\n<td>282.28%</td>\n<td>293.79%</td>\n<td>321.77%</td>\n</tr>\n<tr>\n<td>Arm Neoverse N1</td>\n<td>132.56%</td>\n<td>348.84%</td>\n<td>135.26%</td>\n<td>243.04%</td>\n<td>96.96%</td>\n<td>197.12%</td>\n<td>123.08%</td>\n<td>213.46%</td>\n</tr>\n</tbody>\n</table>\n<p>In addition, here's how the alternative 64-bit scalar implementation (using multiplication) performs:<br>\nCPU core|Latency speedup|Throughput speedup<br>\n-|-|-<br>\nArm Cortex-A55|111.81%|109.10%<br>\nArm Neoverse N1|112.60%|110.45%</p>\n<p>The results demonstrate quite clearly that the vector variant is better than the scalar one; the only regression is in the 32-bit latency value. While the alternative 64-bit scalar implementation is a definite improvement, it still lags behind the vector one.</p>\n</blockquote>",
        "id": 223267138,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1611079577
    },
    {
        "content": "<p>akirilov-arm edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-763021734\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>I decided to compare the approach using the Neon <code>CNT</code> instruction (which I'll call \"vector\") with the one that just used operations on general-purpose registers (i.e. the existing implementation in Cranelift, which I'll call \"scalar\"), so I wrote several microbenchmarks.</p>\n<p>Here's the scalar implementation for 8-bit operands:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x55555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0xf</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And the vector one:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">fmov</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cnt</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">umov</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>16-bit scalar:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x55555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0f0f0f0f</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0xff</span><span class=\"w\"></span>\n</code></pre></div>\n<p>16-bit vector:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">fmov</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cnt</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">addp</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">umov</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>32-bit scalar:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x55555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x33333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0f0f0f0f</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x01010101</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">24</span><span class=\"w\"></span>\n</code></pre></div>\n<p>32-bit vector (almost the same as the 64-bit one - only the first instruction differs):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">fmov</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cnt</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">addv</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">umov</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>For the 64-bit case I tried 2 scalar variants - one that doesn't use multiplication and another one that does; here's the first one:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x5555555555555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x3333333333333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x3333333333333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0f0f0f0f0f0f0f0f</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsl</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsl</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsl</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">32</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">56</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And the second one:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x5555555555555555</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x3333333333333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x3333333333333333</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0f0f0f0f0f0f0f0f</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mh\">0x0101010101010101</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xt</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lsr</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"mi\">56</span><span class=\"w\"></span>\n</code></pre></div>\n<p>64-bit vector:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">fmov</span><span class=\"w\"> </span><span class=\"n\">dt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cnt</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">addv</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">umov</span><span class=\"w\"> </span><span class=\"n\">wd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"p\">.</span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Here are the results for various microarchitectures in terms of speedup achieved by the vector implementation, i.e. higher numbers mean that the latter is better:</p>\n<table>\n<thead>\n<tr>\n<th>CPU core</th>\n<th>8-bit latency speedup</th>\n<th>8-bit throughput speedup</th>\n<th>16-bit latency speedup</th>\n<th>16-bit throughput speedup</th>\n<th>32-bit latency speedup</th>\n<th>32-bit throughput speedup</th>\n<th>64-bit latency speedup</th>\n<th>64-bit throughput speedup</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Arm Cortex-A55</td>\n<td>252.84%</td>\n<td>276.55%</td>\n<td>224.39%</td>\n<td>241.52%</td>\n<td>256.10%</td>\n<td>282.28%</td>\n<td>293.79%</td>\n<td>321.77%</td>\n</tr>\n<tr>\n<td>Arm Neoverse N1</td>\n<td>132.56%</td>\n<td>348.84%</td>\n<td>135.26%</td>\n<td>243.04%</td>\n<td>96.96%</td>\n<td>197.12%</td>\n<td>123.08%</td>\n<td>213.46%</td>\n</tr>\n</tbody>\n</table>\n<p>In addition, here's how the alternative 64-bit scalar implementation (using multiplication) performs:<br>\nCPU core|Latency speedup|Throughput speedup<br>\n-|-|-<br>\nArm Cortex-A55|111.81%|109.10%<br>\nArm Neoverse N1|112.60%|110.45%</p>\n<p>The results are based on median runtimes from 20 runs; standard errors were 0.02% or less.</p>\n<p>The data demonstrates quite clearly that the vector variant is better than the scalar one; the only regression is in the 32-bit latency value. While the alternative 64-bit scalar implementation is a definite improvement, it still lags behind the vector one.</p>\n</blockquote>",
        "id": 223270507,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1611080923
    },
    {
        "content": "<p>cfallin closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>We currently use a sequence of instructions intended for 64-bit operation, and zero-extend narrower inputs. The original implementation by @jgouly almost works for 32 bits (and 8/16 bits extended to 32 bits), with a slight issue. We should rework the lowering to fix this issue and remove the need for zero-extending 32-bit operands.</p>\n</blockquote>",
        "id": 223300282,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1611092863
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537#issuecomment-763163039\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1537\">Issue #1537</a>:</p>\n<blockquote>\n<p>Thanks very much for this very detailed benchmarking!</p>\n</blockquote>",
        "id": 223300387,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1611092901
    }
]