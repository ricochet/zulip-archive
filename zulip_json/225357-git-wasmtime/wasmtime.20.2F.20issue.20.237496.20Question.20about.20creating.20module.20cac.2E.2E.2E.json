[
    {
        "content": "<p>iawia002 opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7496\">issue #7496</a>:</p>\n<blockquote>\n<h4>Feature</h4>\n<p>When I'm using the cache, I always encounter the following warning. Initially, I thought it was a failure to write the cache, but upon closer inspection, I found that the cache file was actually created successfully.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">rename</span><span class=\"p\">,</span>\n<span class=\"n\">lock</span><span class=\"w\"> </span><span class=\"n\">path</span>: <span class=\"o\">/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">xxx</span><span class=\"o\">/</span><span class=\"n\">Library</span><span class=\"o\">/</span><span class=\"n\">Caches</span><span class=\"o\">/</span><span class=\"n\">BytecodeAlliance</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">modules</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">--</span><span class=\"mi\">1699432190543</span><span class=\"o\">/</span><span class=\"n\">KhAxrGdzhkuy9f</span><span class=\"o\">-</span><span class=\"n\">lsCzlq73dYFuGl3yOqWQyOpL8cBY</span><span class=\"p\">.</span><span class=\"n\">wip</span><span class=\"o\">-</span><span class=\"n\">atomic</span><span class=\"o\">-</span><span class=\"n\">write</span><span class=\"o\">-</span><span class=\"k\">mod</span><span class=\"p\">,</span>\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">path</span>: <span class=\"o\">/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">xxx</span><span class=\"o\">/</span><span class=\"n\">Library</span><span class=\"o\">/</span><span class=\"n\">Caches</span><span class=\"o\">/</span><span class=\"n\">BytecodeAlliance</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">modules</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">--</span><span class=\"mi\">1699432190543</span><span class=\"o\">/</span><span class=\"n\">KhAxrGdzhkuy9f</span><span class=\"o\">-</span><span class=\"n\">lsCzlq73dYFuGl3yOqWQyOpL8cBY</span><span class=\"p\">,</span>\n<span class=\"n\">err</span>: <span class=\"nc\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>So, I delved into the code and have some questions about the handling of writing cache files. According to the current implementation, every time a new module is written to the cache will inevitably trigger this warning because the directory doesn't exist. I looked at the comments in the code and found that the intention here is to optimize system calls.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// Optimize syscalls: first, try writing to disk. It should succeed in most cases.</span>\n<span class=\"c1\">// Otherwise, try creating the cache directory and retry writing to the file.</span>\n</code></pre></div>\n<p>However, facing this warning every time we run a new module is quite confusing, I'm wondering if we can modify the implementation here.</p>\n<h4>Implementation</h4>\n<p>Check if the parent directory exists before writing the file. If it doesn't exist, create the directory first and then proceed with writing the file.</p>\n<p>I'm not entirely sure about the performance impact of checking the path's existence every time. If it's feasible, I can go ahead and implement it this way.</p>\n<h4>Benefit</h4>\n<p>We won't encounter the warning anymore, and the code will be a bit more concise.</p>\n</blockquote>",
        "id": 400903924,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699435568
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7496#issuecomment-1801519083\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7496\">issue #7496</a>:</p>\n<blockquote>\n<p>Moving the <code>warn!()</code> from <code>fs_write_atomic</code> to <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b9f2a3060b95a479a5e52ad410f77d43bf1a2a59/crates/cache/src/lib.rs#L199\">https://github.com/bytecodealliance/wasmtime/blob/b9f2a3060b95a479a5e52ad410f77d43bf1a2a59/crates/cache/src/lib.rs#L199</a> should fix this.</p>\n</blockquote>",
        "id": 400912612,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699438422
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7496#issuecomment-1801519083\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7496\">issue #7496</a>:</p>\n<blockquote>\n<p>Moving the <code>warn!()</code> from <code>fs_write_atomic</code> to <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b9f2a3060b95a479a5e52ad410f77d43bf1a2a59/crates/cache/src/lib.rs#L199\">https://github.com/bytecodealliance/wasmtime/blob/b9f2a3060b95a479a5e52ad410f77d43bf1a2a59/crates/cache/src/lib.rs#L199</a> should fix this. Or in other words only warn when the write failed after the directory is already created.</p>\n</blockquote>",
        "id": 400912800,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699438487
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7496\">issue #7496</a>:</p>\n<blockquote>\n<h4>Feature</h4>\n<p>When I'm using the cache, I always encounter the following warning. Initially, I thought it was a failure to write the cache, but upon closer inspection, I found that the cache file was actually created successfully.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">rename</span><span class=\"p\">,</span>\n<span class=\"n\">lock</span><span class=\"w\"> </span><span class=\"n\">path</span>: <span class=\"o\">/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">xxx</span><span class=\"o\">/</span><span class=\"n\">Library</span><span class=\"o\">/</span><span class=\"n\">Caches</span><span class=\"o\">/</span><span class=\"n\">BytecodeAlliance</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">modules</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">--</span><span class=\"mi\">1699432190543</span><span class=\"o\">/</span><span class=\"n\">KhAxrGdzhkuy9f</span><span class=\"o\">-</span><span class=\"n\">lsCzlq73dYFuGl3yOqWQyOpL8cBY</span><span class=\"p\">.</span><span class=\"n\">wip</span><span class=\"o\">-</span><span class=\"n\">atomic</span><span class=\"o\">-</span><span class=\"n\">write</span><span class=\"o\">-</span><span class=\"k\">mod</span><span class=\"p\">,</span>\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">path</span>: <span class=\"o\">/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">xxx</span><span class=\"o\">/</span><span class=\"n\">Library</span><span class=\"o\">/</span><span class=\"n\">Caches</span><span class=\"o\">/</span><span class=\"n\">BytecodeAlliance</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">modules</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">--</span><span class=\"mi\">1699432190543</span><span class=\"o\">/</span><span class=\"n\">KhAxrGdzhkuy9f</span><span class=\"o\">-</span><span class=\"n\">lsCzlq73dYFuGl3yOqWQyOpL8cBY</span><span class=\"p\">,</span>\n<span class=\"n\">err</span>: <span class=\"nc\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>So, I delved into the code and have some questions about the handling of writing cache files. According to the current implementation, every time a new module is written to the cache will inevitably trigger this warning because the directory doesn't exist. I looked at the comments in the code and found that the intention here is to optimize system calls.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// Optimize syscalls: first, try writing to disk. It should succeed in most cases.</span>\n<span class=\"c1\">// Otherwise, try creating the cache directory and retry writing to the file.</span>\n</code></pre></div>\n<p>However, facing this warning every time we run a new module is quite confusing, I'm wondering if we can modify the implementation here.</p>\n<h4>Implementation</h4>\n<p>Check if the parent directory exists before writing the file. If it doesn't exist, create the directory first and then proceed with writing the file.</p>\n<p>I'm not entirely sure about the performance impact of checking the path's existence every time. If it's feasible, I can go ahead and implement it this way.</p>\n<h4>Benefit</h4>\n<p>We won't encounter the warning anymore, and the code will be a bit more concise.</p>\n</blockquote>",
        "id": 400972559,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699458734
    }
]