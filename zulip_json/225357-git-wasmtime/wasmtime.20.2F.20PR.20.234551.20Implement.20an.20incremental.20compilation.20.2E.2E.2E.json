[
    {
        "content": "<p>bnjbvr opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>:</p>\n<blockquote>\n<p>[Opening a draft for discussions; there are a remaining TODOs i'll need to address, and I hope to write a better PR description here.]</p>\n<p>This is the implementation of <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4155\">https://github.com/bytecodealliance/wasmtime/issues/4155</a>, using the \"inverted API\" approach suggested by @cfallin (thanks!) in Cranelift, and trait object to provide a backend for an all-included experience in Wasmtime. </p>\n<p>Thanks to both @alexcrichton and @cfallin for your very useful feedback on Zulip.</p>\n<p>Fixes #4155.</p>\n</blockquote>",
        "id": 291227048,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659029882
    },
    {
        "content": "<p>bnjbvr edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>:</p>\n<blockquote>\n<p>[Opening a draft for discussions; there are a remaining TODOs i'll need to address, and I hope to write a better PR description here.]</p>\n<p>This is the implementation of <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4155\">https://github.com/bytecodealliance/wasmtime/issues/4155</a>, using the \"inverted API\" approach suggested by @cfallin (thanks!) in Cranelift, and trait object to provide a backend for an all-included experience in Wasmtime. </p>\n<p>Thanks to both @alexcrichton and @cfallin for your very useful feedback on Zulip.</p>\n<p>Fixes #4155.</p>\n</blockquote>",
        "id": 291227097,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659029897
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932553701\">PR review comment</a>:</p>\n<blockquote>\n<p>A 64bit hash may be too small to be safely used in adversarial cases.</p>\n</blockquote>",
        "id": 291233163,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033025
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054575571\">PR review</a>.</p>",
        "id": 291233164,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033025
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054579849\">PR review</a>.</p>",
        "id": 291233672,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033257
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932556728\">PR review comment</a>:</p>\n<blockquote>\n<p>Won't this cause miscompilations when you at first call functions a, a, b and the next time a, b, b as there is no way to distinguish them based on the cache key?</p>\n</blockquote>",
        "id": 291233674,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033257
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932558642\">PR review comment</a>:</p>\n<blockquote>\n<p>Shouldn't this use a cryptographically secure hash function? FxHasher is known to have hash collisions. It is a quick and dirty hash function only suitable when you can handle hash collisions, like in a hash table.</p>\n</blockquote>",
        "id": 291233955,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033406
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054582569\">PR review</a>.</p>",
        "id": 291233956,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033407
    },
    {
        "content": "<p>bjorn3 edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932558642\">PR review comment</a>.</p>",
        "id": 291234018,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033453
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932560533\">PR review comment</a>:</p>\n<blockquote>\n<p>I believe you can access all these through the public api's. I did prefer that over direct accesses as it is less likely to violate invariants.</p>\n</blockquote>",
        "id": 291234218,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033558
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054585243\">PR review</a>.</p>",
        "id": 291234219,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033558
    },
    {
        "content": "<p>afonso360 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054593006\">PR review</a>.</p>",
        "id": 291235056,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033977
    },
    {
        "content": "<p>afonso360 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932566058\">PR review comment</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>        for _ in 0..self.param(&amp;self.config.funcrefs_per_function)? {\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 291235057,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659033977
    },
    {
        "content": "<p>afonso360 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054603383\">PR review</a>.</p>",
        "id": 291236116,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659034546
    },
    {
        "content": "<p>afonso360 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932573265\">PR review comment</a>:</p>\n<blockquote>\n<p>Can we refactor this to use <code>generate_func</code> above?</p>\n</blockquote>",
        "id": 291236117,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659034546
    },
    {
        "content": "<p>afonso360 deleted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932573265\">PR review comment</a>.</p>",
        "id": 291239061,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659035930
    },
    {
        "content": "<p>afonso360 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1054631179\">PR review</a>.</p>",
        "id": 291239313,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659036060
    },
    {
        "content": "<p>afonso360 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r932592413\">PR review comment</a>:</p>\n<blockquote>\n<p>Can we refactor this to use <code>generate_func</code> above?</p>\n</blockquote>",
        "id": 291239314,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659036061
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1055839596\">PR review</a>.</p>",
        "id": 291351948,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659113890
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1055852968\">PR review</a>.</p>",
        "id": 291353542,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659114696
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934506412\">PR review comment</a>:</p>\n<blockquote>\n<p>That's the thing: there's a perfect bijection between Func's <code>FuncRef</code> and <code>ExternalName</code>, so we don't need to record the external names, and we can just be \"resilient\" with them, meaning that it's fine to the actual callees change. This will end up generating different <code>MachReloc</code> later.</p>\n<p>I think Chris' suggestion to split the <code>Function</code>/<code>MachCompileResult</code> into the \"core\" and parameters ought to make this clearer and easier to understand.</p>\n</blockquote>",
        "id": 291571556,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659359125
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057264498\">PR review</a>.</p>",
        "id": 291571557,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659359125
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934506771\">PR review comment</a>:</p>\n<blockquote>\n<p>See other answer below.</p>\n</blockquote>",
        "id": 291571605,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659359150
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057265080\">PR review</a>.</p>",
        "id": 291571606,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659359150
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057267329\">PR review</a>.</p>",
        "id": 291571900,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659359247
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934508251\">PR review comment</a>:</p>\n<blockquote>\n<p>It doesn't have to be, because right now the incremental cache first looks up using the <code>CacheKeyHash</code>, and then compares against the <code>CacheKey</code>, exactly as <code>HashMap</code>s do first the hashing and then use the <code>PartialEq</code> to check for equality.</p>\n<p>This was a very safe first way to implement this, and it's also what limits performance of reloads. An alternative way would be to use a safe, longer hash here (as you suggest in this and the other comment above), and see if we can get rid of the equality check in that case. I'd like to experiment with this, likely later.</p>\n</blockquote>",
        "id": 291571901,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659359247
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934508383\">PR review comment</a>:</p>\n<blockquote>\n<p>Good catch, thanks!</p>\n</blockquote>",
        "id": 291571914,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659359255
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057267518\">PR review</a>.</p>",
        "id": 291571915,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659359255
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 291577707,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659361707
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057487366\">PR review</a>.</p>",
        "id": 291590724,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659367629
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934656379\">PR review comment</a>:</p>\n<blockquote>\n<blockquote>\n<p>That's the thing: there's a perfect bijection between Func's FuncRef and ExternalName, so we don't need to record the external names, and we can just be \"resilient\" with them, meaning that it's fine to the actual callees change. This will end up generating different MachReloc later.</p>\n</blockquote>\n<p>I don't see how a bijection helps.</p>\n</blockquote>",
        "id": 291590725,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659367629
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057493510\">PR review</a>.</p>",
        "id": 291591256,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659367881
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934660672\">PR review comment</a>:</p>\n<blockquote>\n<p>Right now, the <code>MachReloc</code>s contain some <code>ExternalName</code>s, when the <code>MachCompileResult</code> is cached. When we load from the cache, and have a function with different <code>FuncRef</code>s -&gt; <code>ExternalName</code>s, we can:</p>\n<ol>\n<li>first lookup what <code>FuncRef</code> in the original function caused the <code>ExternalName</code> to pop up in the <code>MachReloc</code>, since it's a bijection</li>\n<li>use the <code>FuncRef</code> -&gt; <code>ExternalName</code> from the function-to-compile to rewrite the <code>MachReloc</code> on the fly</li>\n</ol>\n</blockquote>",
        "id": 291591261,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659367882
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057499384\">PR review</a>.</p>",
        "id": 291591872,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659368141
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934664892\">PR review comment</a>:</p>\n<blockquote>\n<p>(... so we might as well just use the <code>FuncRef</code> everywhere directly, to avoid maintaining the invariant that we want this bijection; and this is in line with what Chris suggested in his comment, so I'm doing that now.)</p>\n</blockquote>",
        "id": 291591877,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659368143
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1057591868\">PR review</a>.</p>",
        "id": 291602528,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659372646
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934730187\">PR review comment</a>:</p>\n<blockquote>\n<blockquote>\n<p>When we load from the cache, and have a function with different FuncRefs -&gt; ExternalNames, we can:</p>\n</blockquote>\n<p>But what if you have a function with the same FuncRef -&gt; ExternalName, but where the body eg calls functions in a different order?</p>\n</blockquote>",
        "id": 291602529,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659372646
    },
    {
        "content": "<p>bjorn3 edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r934730187\">PR review comment</a>.</p>",
        "id": 291602539,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659372653
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1058268290\">PR review</a>.</p>",
        "id": 291675134,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659426192
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r935221922\">PR review comment</a>:</p>\n<blockquote>\n<p>Each different function call (<code>ir::Opcode::Call</code>) references the <code>FuncRef</code> it's calling, so this is entirely determined by the CLIF IR. If two functions have the same body and each call two functions, but two different functions, then two different <code>FuncRef</code> are involved, leading to different lookups in the <code>FuncRef -&gt; ExternalName</code> mapping, thus different <code>ExternalName</code>s. (Well, that's assuming that the <code>ExternalName</code>s are all different from each other, which would be important if we stayed down that path but that's not the case.)</p>\n</blockquote>",
        "id": 291675135,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659426193
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1058746857\">PR review</a>.</p>",
        "id": 291706624,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659445951
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r935577797\">PR review comment</a>:</p>\n<blockquote>\n<p>You are normalizing away the difference between different ExternalName's away here, right? <code>CachedExternalName::User</code> doesn't have any field to distinguish one from another.</p>\n</blockquote>",
        "id": 291706625,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659445952
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1058751774\">PR review</a>.</p>",
        "id": 291706961,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659446133
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r935581179\">PR review comment</a>:</p>\n<blockquote>\n<p>Indeed, because they're \"spurious\", at this point; only the <code>FuncRef</code> really matters, and there's a way to go from <code>ExternalName</code> back to <code>FuncRef</code> (in the _source_ function that filled the cache), and then from the <code>FuncRef</code> to <code>ExternalName</code> (in the function for which we're reusing the cache).</p>\n<p>But don't get too attached to this, it's going to be simplified by Chris' suggestion below :)</p>\n</blockquote>",
        "id": 291706962,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1659446133
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 292642475,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660073075
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 292769915,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660143081
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 292780892,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660146503
    },
    {
        "content": "<p>bnjbvr edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>:</p>\n<blockquote>\n<p>This is the implementation of <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4155\">https://github.com/bytecodealliance/wasmtime/issues/4155</a>, using the \"inverted API\" approach suggested by @cfallin (thanks!) in Cranelift, and trait object to provide a backend for an all-included experience in Wasmtime. </p>\n<p>After the suggestion of Chris, <code>Function</code> has been split into mostly two parts:</p>\n<ul>\n<li>on the one hand, <code>FunctionStencil</code> contains all the fields required during compilation, and that act as a compilation cache key: if two function stencils are the same, then the result of their compilation (<code>CompiledCodeBase&lt;Stencil&gt;</code>) will be the same. This makes caching trivial, as the only thing to cache is the <code>FunctionStencil</code>.</li>\n<li>on the other hand, <code>FunctionParameters</code> contain the... function parameters that are required to finalize the result of compilation into a <code>CompiledCode</code> (aka <code>CompiledCodeBase&lt;Final&gt;</code>) with proper final relocations etc., by applying fixups and so on.</li>\n</ul>\n<p>Most changes are here to accomodate those requirements, in particular that <code>FunctionStencil</code> should be <code>Hash</code>able to be used as a key in the cache:</p>\n<ul>\n<li>most source locations are now relative to a base source location in the function, and as such they're encoded as <code>RelSourceLoc</code> in the <code>FunctionStencil</code>. This required changes so that there's no need to explicitly mark a <code>SourceLoc</code> as the base source location, it's automatically detected instead the first time a non-default <code>SourceLoc</code> is set.</li>\n<li>user-defined external names in the <code>FunctionStencil</code> (aka before this patch <code>ExternalName::User { namespace, index }</code>) are now references into an external table of <code>UserExternalNameRef -&gt; UserExternalName</code>, present in the <code>FunctionParameters</code>, and must be explicitly declared using <code>Function::declare_imported_user_function</code>.</li>\n<li>some refactorings have been made for function names:<ul>\n<li><code>ExternalName</code> was used as the type for a <code>Function</code>'s name; while it thus allowed <code>ExternalName::Libcall</code> in this place, this would have been quite confusing to use it there. Instead, a new enum <code>UserFuncName</code> is introduced for this name, that's either a user-defined function name (the above <code>UserExternalName</code>) or a test case name.</li>\n<li>The future of <code>ExternalName</code> is likely to become a full reference into the <code>FunctionParameters</code>'s mapping, instead of being \"either a handle for user-defined external names, or the thing itself for other variants\". I'm running out of time to do this, and this is not trivial as it implies touching ISLE which I'm less familiar with.</li>\n</ul>\n</li>\n</ul>\n<p>The cache computes a sha256 hash of the <code>FunctionStencil</code>, and uses this as the cache key. No equality check (using <code>PartialEq</code>) is performed in addition to the hash being the same, as we hope that this is sufficient data to avoid collisions.</p>\n<p>A basic fuzz target has been introduced that tries to do the bare minimum:</p>\n<ul>\n<li>check that a function successfully compiled and cached will be also successfully reloaded from the cache, and returns the exact same function.</li>\n<li>check that a trivial modification in the external mapping of <code>UserExternalNameRef -&gt; UserExternalName</code> hits the cache, and that other modifications don't hit the cache.<ul>\n<li>This last check is less efficient and less likely to happen, so probably should be rethought a bit.</li>\n</ul>\n</li>\n</ul>\n<p>Thanks to both @alexcrichton and @cfallin for your very useful feedback on Zulip.</p>\n<p>Some numbers show that for a large wasm module we're using internally, this is a 20% compile-time speedup, because so many <code>FunctionStencil</code>s are the same, even within a single module. For a group of modules that have a lot of code in common, we get hit rates up to 70% when they're used together. When a single function changes in a wasm module, every other function is reloaded; that's still slower than I expect (between 10% and 50% of the overall compile time), so there's likely room for improvement. </p>\n<p>Fixes #4155.</p>\n</blockquote>",
        "id": 292784826,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660147477
    },
    {
        "content": "<p><strong>bnjbvr</strong> has marked <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> as ready for review.</p>",
        "id": 292786330,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660148045
    },
    {
        "content": "<p><strong>bnjbvr</strong> requested <a href=\"https://github.com/cfallin\">cfallin</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a>.</p>",
        "id": 292786347,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660148052
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 292792385,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660150129
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 292793199,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660150394
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 292970969,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660237769
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070077008\">PR review</a>.</p>",
        "id": 292972671,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660238440
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 292983880,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660242446
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070224462\">PR review</a>.</p>",
        "id": 292991283,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245155
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943837886\">PR review comment</a>:</p>\n<blockquote>\n<p>This error message is confusing if the consumer of cranelift is not wasmtime.</p>\n</blockquote>",
        "id": 292991284,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245155
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070229320\">PR review</a>.</p>",
        "id": 292991674,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245284
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943842368\">PR review comment</a>:</p>\n<blockquote>\n<p>Maybe use SecondaryMap instead? BTreeMap results in a lot of code bloat (significantly more than HashMap) and is not very efficient for dense maps. It is reasonably efficient for sparse maps though.</p>\n</blockquote>",
        "id": 292991675,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245284
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070234695\">PR review</a>.</p>",
        "id": 292992105,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245424
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943846905\">PR review comment</a>:</p>\n<blockquote>\n<p>Does using RelSourceLoc the same way as SourceLoc give correct results? In cg_clif SourceLoc is already function local. (It is backed by an IndexSet with mir::SourceLoc as entries)</p>\n</blockquote>",
        "id": 292992106,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245425
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070241874\">PR review</a>.</p>",
        "id": 292993130,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245785
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943851673\">PR review comment</a>:</p>\n<blockquote>\n<p>What are calls to these supposed to be replaced with?</p>\n</blockquote>",
        "id": 292993131,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245785
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1070242770\">PR review</a>.</p>",
        "id": 292993253,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245837
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943852328\">PR review comment</a>:</p>\n<blockquote>\n<p>???? Why do you need a Function to define a data object?</p>\n</blockquote>",
        "id": 292993255,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245837
    },
    {
        "content": "<p>bjorn3 edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r943852328\">PR review comment</a>.</p>",
        "id": 292993334,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660245854
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944585477\">PR review comment</a>:</p>\n<blockquote>\n<p>I've ran into bad perf regressions b/o SecondaryMap auto resize behaviors, so I'm a bit dubious about this. We could reevaluate later.</p>\n</blockquote>",
        "id": 293137198,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660318558
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071269792\">PR review</a>.</p>",
        "id": 293137199,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660318559
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071271223\">PR review</a>.</p>",
        "id": 293137437,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660318626
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944586393\">PR review comment</a>:</p>\n<blockquote>\n<p>Yes, it's mostly used internally so I wouldn't even expect embedders to interact with it.</p>\n</blockquote>",
        "id": 293137438,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660318626
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071279093\">PR review</a>.</p>",
        "id": 293138596,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660318979
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944591666\">PR review comment</a>:</p>\n<blockquote>\n<p>It was to process relocations (to extract the , but now I can see that <code>DataDescription</code> abuses the <code>MachReloc</code> and it should be its own type that doesn't use <code>ir::ExternalName</code> at all, now that the latter uses references into an external table for lookup. I'll try doing this quickly, but if it takes too long I'd prefer that somebody who understands this code better take a look.</p>\n</blockquote>",
        "id": 293138599,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660318979
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071305982\">PR review</a>.</p>",
        "id": 293142727,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320165
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944609087\">PR review comment</a>:</p>\n<blockquote>\n<p>I managed to put them back eventually.</p>\n</blockquote>",
        "id": 293142728,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320165
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944609623\">PR review comment</a>:</p>\n<blockquote>\n<p>That wasn't too hard, eventually; there's now a <code>ModuleReloc</code> that is a <code>MachReloc</code> but using <code>ModuleExtName</code> (which embeds user-defined name) instead of <code>ir::ExternalName</code> for names.</p>\n</blockquote>",
        "id": 293142874,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320210
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071306750\">PR review</a>.</p>",
        "id": 293142875,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320210
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 293144931,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320890
    },
    {
        "content": "<p>bnjbvr has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a>.</p>",
        "id": 293145055,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320928
    },
    {
        "content": "<p>bnjbvr has disabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a>.</p>",
        "id": 293145074,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320937
    },
    {
        "content": "<p>bnjbvr updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a> from <code>wip-05-09_wasm_cache</code> to <code>main</code>.</p>",
        "id": 293145109,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320951
    },
    {
        "content": "<p>bnjbvr has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a>.</p>",
        "id": 293145198,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660320968
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071329018\">PR review</a>.</p>",
        "id": 293146430,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660321342
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944624362\">PR review comment</a>:</p>\n<blockquote>\n<p>These haven't yet been re-added.</p>\n</blockquote>",
        "id": 293146431,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660321342
    },
    {
        "content": "<p>bnjbvr merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551\">PR #4551</a>.</p>",
        "id": 293151204,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660322865
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1071425536\">PR review</a>.</p>",
        "id": 293161034,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660326135
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r944679458\">PR review comment</a>:</p>\n<blockquote>\n<p>@bnjbvr?</p>\n</blockquote>",
        "id": 293161035,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660326135
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r946491567\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah yeah, seems I added it back in one implementation, but not in the trait. Is that something that you were using, @bjorn3? I could add it back later, if required</p>\n</blockquote>",
        "id": 293675091,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660639052
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1073715873\">PR review</a>.</p>",
        "id": 293675092,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660639052
    },
    {
        "content": "<p>bjorn3 created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r946522164\">PR review comment</a>:</p>\n<blockquote>\n<p>This change means that <code>declare_func_in_data</code> and <code>declare_data_in_data</code> are no longer forwarded to <code>FooModule</code> when you call them on a <code>&amp;mut FooModule</code>, which is incorrect if those functions have been overwritten by <code>FooModule</code>.</p>\n</blockquote>",
        "id": 293678721,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660640853
    },
    {
        "content": "<p>bjorn3 submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1073758830\">PR review</a>.</p>",
        "id": 293678722,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660640853
    },
    {
        "content": "<p>bnjbvr created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#discussion_r946528207\">PR review comment</a>:</p>\n<blockquote>\n<p>I see; it's likely subpar design if the default implementation is incorrect for some implementations by default, but that's a different discussion to have :) Will post a small patch for this chunk.</p>\n</blockquote>",
        "id": 293679444,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660641229
    },
    {
        "content": "<p>bnjbvr submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4551#pullrequestreview-1073767394\">PR review</a>.</p>",
        "id": 293679445,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1660641229
    }
]