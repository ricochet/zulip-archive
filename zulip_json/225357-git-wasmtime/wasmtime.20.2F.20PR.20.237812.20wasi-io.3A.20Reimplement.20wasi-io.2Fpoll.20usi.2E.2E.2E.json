[
    {
        "content": "<p><strong>badeend</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 417956606,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706127333
    },
    {
        "content": "<p>badeend opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a> from <code>badeend:pollable</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>Prior discussion: <a href=\"#narrow/stream/217126-wasmtime/topic/Change.20Subscribe.20trait\">https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/Change.20Subscribe.20trait</a></p>\n<ul>\n<li>Renamed the existing <code>Pollable</code> struct to <code>PollableResource</code></li>\n<li>Reimplemented wasi-io/poll. This introduces a new <code>Pollable</code> trait which is lower level, doesn't require heap allocations to poll, has mutable access to the WasiView, and can be used as a standalone resource without a parent. The Subscribe trait is kept intact, but this is now a utility interface, implemented in terms of Pollable.</li>\n<li>Eliminate the (now) unnecessary surrogate parent resource of clock pollables</li>\n<li>Added ResourceTable <code>take</code> &amp; <code>restore</code> as a general purpose replacement for <code>iter_entries</code>. That one was used only by the old <code>poll</code> implementation.</li>\n</ul>\n<hr>\n<p>Additionally:</p>\n<ul>\n<li>@pchickey  Forbid empty poll list. Fixes: <a href=\"https://github.com/WebAssembly/wasi-io/issues/67\">WebAssembly/wasi-io#67</a></li>\n</ul>\n</blockquote>",
        "id": 417956607,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706127333
    },
    {
        "content": "<p><strong>badeend</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 417956608,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706127333
    },
    {
        "content": "<p><strong>badeend</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 417956609,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706127333
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1908966626\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @peterhuene</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"wasi\", \"wasmtime:api\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>peterhuene: wasmtime:api</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 417969004,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706132712
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/sunfishcode\">sunfishcode</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 417971299,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706133663
    },
    {
        "content": "<p><strong>pchickey</strong> requested <a href=\"https://github.com/pchickey\">pchickey</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 417977535,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706136717
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1842603282\">PR review</a>:</p>\n<blockquote>\n<p>Thanks, this is excellent work. The new internal interface is definitely superior to the old one, and I appreciate the new tests as well. The lease system for resource table is a much better interface than iter_entries.</p>\n<p>I believe that all of the <code>Slot</code> and <code>SlotIdentity</code> implementation makes sense and is correct (especially because, surprisingly to me, the only unsafe is in <code>unsafe impl Send</code>), but I wanted to tag @alexcrichton to double-check that part because it is not code I feel super confident in my ability to assess that code. If he is happy with that, this can land.</p>\n</blockquote>",
        "id": 417984924,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706141153
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1842603282\">PR review</a>:</p>\n<blockquote>\n<p>Thanks, this is excellent work. The new internal interface is definitely superior to the old one, and I appreciate the new tests as well. The lease system for resource table is a much better interface than iter_entries.</p>\n<p>I believe that all of the <code>Slot</code> and <code>SlotIdentity</code> implementation makes sense and is correct (especially because, surprisingly to me, the only unsafe is in <code>unsafe impl Send</code>), but I wanted to tag @alexcrichton to double-check that part because it is not code I feel super confident in my ability to assess that code. If he is happy with that, this can land.</p>\n</blockquote>",
        "id": 417984925,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706141153
    },
    {
        "content": "<p>pchickey created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1465680695\">PR review comment</a>:</p>\n<blockquote>\n<p>I agree we need this change in the wits, lets just be sure to upstream these to the spec repo as well. We will come up with some process for how we keep the docs evolving and improving while assuring that the interface itself doesn't change.</p>\n</blockquote>",
        "id": 417984926,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706141153
    },
    {
        "content": "<p>pchickey created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1465687345\">PR review comment</a>:</p>\n<blockquote>\n<p>This is a very bikesheddy suggestion, so feel free to disregard it, but is <code>BoxPollable</code> a better name for this? That way <code>Resource&lt;PollableResource&gt;</code> isnt repeating the word.</p>\n</blockquote>",
        "id": 417984928,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706141153
    },
    {
        "content": "<p><strong>pchickey</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 417985231,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706141305
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1842676372\">PR review</a>:</p>\n<blockquote>\n<p>Thanks for this! I've left a few comments but it's getting a bit later here so I'm going to head out. I want to read more about the <code>Lease&lt;T&gt;</code> though as that looks quite subtle and I need to think more about it.</p>\n</blockquote>",
        "id": 417992118,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706145901
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1842676372\">PR review</a>:</p>\n<blockquote>\n<p>Thanks for this! I've left a few comments but it's getting a bit later here so I'm going to head out. I want to read more about the <code>Lease&lt;T&gt;</code> though as that looks quite subtle and I need to think more about it.</p>\n</blockquote>",
        "id": 417992119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706145901
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1465732875\">PR review comment</a>:</p>\n<blockquote>\n<p>There's quite a lot of errors which go through the <code>Err</code> here so I'm a bit wary of using <code>unwrap_err</code> to assert that a particular trap happened, could this instead a particular property about the error, such as its message?</p>\n</blockquote>",
        "id": 417992120,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706145901
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1465731189\">PR review comment</a>:</p>\n<blockquote>\n<p>This I think is actually subtly incorrect because it drops the future after the call to <code>poll</code> which signals that the future should be cancelled rather than keeping it alive until the whole poll is done. I think that means that we may not be guaranteed to get wakeups from cancelled futures, although we might get those for now given how the code is currently constructed. I think that this'll need to be a bit fancier with the adapter instead of having a blanket impl</p>\n</blockquote>",
        "id": 417992122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706145901
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1465733967\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this, and the functions below, be implemented in terms of <code>poll_ready_fn</code> perhaps?</p>\n</blockquote>",
        "id": 417992123,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706145901
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1842603282\">PR review</a>:</p>\n<blockquote>\n<p>Thanks, this is excellent work. The new internal interface is definitely superior to the old one, and I appreciate the new tests as well. The lease system for resource table is a much better interface than iter_entries.</p>\n<p>I believe that all of the <code>Slot</code> and <code>SlotIdentity</code> implementation makes sense and is correct (especially because, surprisingly to me, the only unsafe is in <code>unsafe impl Send</code>), but I wanted to tag @alexcrichton to double-check that part because I do not feel super confident in my ability to assess that code. If he is happy with that, this can land.</p>\n</blockquote>",
        "id": 417996421,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706148690
    },
    {
        "content": "<p>badeend updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 418032974,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706172884
    },
    {
        "content": "<p>badeend submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1843151528\">PR review</a>.</p>",
        "id": 418033178,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706172961
    },
    {
        "content": "<p>badeend created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1466038011\">PR review comment</a>:</p>\n<blockquote>\n<p>Certainly</p>\n</blockquote>",
        "id": 418033179,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706172961
    },
    {
        "content": "<p>badeend submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1843164832\">PR review</a>.</p>",
        "id": 418033638,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706173154
    },
    {
        "content": "<p>badeend created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1466044014\">PR review comment</a>:</p>\n<blockquote>\n<p>Check!</p>\n</blockquote>",
        "id": 418033639,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706173154
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1846450944\">PR review</a>:</p>\n<blockquote>\n<p>Ok I've gotten a chance now to take a closer look at <code>Lease&lt;T&gt;</code> and the changes <code>ResourceTable</code>. Given this new API design for the pollable trait something along these lines is required (e.g. <code>iter_children</code> can't work any more). The specific implementation here I think has a drawback where it's very \"panicky\" if you get it wrong. Most other aspects of WASI are \"error-y\" in that they try to return traps if anything is gotten wrong. This I think is pretty important for not accidentally becoming a DoS vector for embeddings. For example a panicking <code>Drop</code> implementation means that an early-return in an embedder function might accidentally take down the whole process where a wasm trap would only take down a single instance.</p>\n<p>Given that my main thought on this is that this should ideally not ever panic and instead should switch to returning errors where possible. I might also recommending going a little bit further perhaps with a scheme such as:</p>\n<ul>\n<li>Leave <code>TableEntry::entry</code> as <code>Box&lt;dyn Any&gt;</code>.</li>\n<li>Change <code>take</code> to returning <code>Box&lt;T&gt;</code>. This would replace <code>entry</code> with something like <code>Box::new(Tombstone)</code> which is a private type to this module.</li>\n<li>Change <code>restore</code> to taking <code>Box&lt;T&gt;</code> and <code>Resource&lt;T&gt;</code>.</li>\n</ul>\n<p>That way it's largely up to embedders to \"get everything right\" but they'd already be required to do so with this current API. Additionally any failed downcasts can additionally add a check for <code>Tombstone</code> to perhaps return a more precise error other than <code>ResourceTableError::WrongType</code> with a new variant such as <code>TakenValue</code>.</p>\n</blockquote>",
        "id": 418342593,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706298927
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1912686538\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>Thanks for the feedback.<br>\nI agree on the \"panicky\" point. I'll add an error type and remove the panics.</p>\n<p>One thing that's not in this PR, but I assume will most likely be added at some point, are untyped <code>take_any</code> and <code>restore_any</code> variants. The drawback of reverting the Lease &amp; SlotIdentity design, is that the <code>restore(_any)</code> API becomes (even) easier to misuse. Because then the consumer can restore any value at the index of a previously differently typed entry. I'm worried about the developer experience of this, as the place where they encounter the WrongType errors could be miles away from where the problem actually is.</p>\n<p>Anyway, I'm fine with your suggestions. I just wanted to make sure the trade-offs are known.<br>\n</p>\n</blockquote>",
        "id": 418350132,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706302664
    },
    {
        "content": "<p>badeend edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1912686538\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>Thanks for the feedback.<br>\nI agree on the \"panicky\" point. I'll add an error type and remove the panics.</p>\n<p>One thing that's not in this PR, but I assume will most likely be added at some point, are untyped <code>take_any</code> and <code>restore_any</code> variants. The drawback of reverting the Lease &amp; SlotIdentity design, is that the <code>restore(_any)</code> API becomes (even) easier to misuse. Because then the consumer can restore any value at the index of a previously differently typed entry. I'm worried about the developer experience of this, as the corruption would happen silently and the place where they encounter the WrongType errors could be miles away from where the problem actually is.</p>\n<p>Anyway, I'm fine with your suggestions. I just wanted to make sure the trade-offs are known.<br>\n</p>\n</blockquote>",
        "id": 418350440,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706302810
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1912716433\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>Hm ok, for that I think you have a good point about accidentally messing up these APIs. I think this may still be surmountable perhaps with some trickery, but I'd also need to see the usage of <code>take_any</code> and restore to know better. Want to discuss on a future PR with that implemented or hash it out here? (I'm fine either way)</p>\n</blockquote>",
        "id": 418353282,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706304328
    },
    {
        "content": "<p>badeend updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 419286221,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706805427
    },
    {
        "content": "<p>badeend created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1474762523\">PR review comment</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/WebAssembly/wasi-io/pull/69\">https://github.com/WebAssembly/wasi-io/pull/69</a></p>\n</blockquote>",
        "id": 419286291,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706805448
    },
    {
        "content": "<p>badeend submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1856965451\">PR review</a>.</p>",
        "id": 419286292,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706805449
    },
    {
        "content": "<p>badeend submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1856965811\">PR review</a>.</p>",
        "id": 419286337,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706805458
    },
    {
        "content": "<p>badeend created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1474762787\">PR review comment</a>:</p>\n<blockquote>\n<p>The design has changed in the meantime. Now it's not just a box anymore, so I went with <code>PollableHandle</code>.<br>\n</p>\n</blockquote>",
        "id": 419286342,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706805458
    },
    {
        "content": "<p>badeend submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#pullrequestreview-1856967109\">PR review</a>.</p>",
        "id": 419286511,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706805495
    },
    {
        "content": "<p>badeend created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#discussion_r1474763609\">PR review comment</a>:</p>\n<blockquote>\n<p>The tests were failing precisely because of that. To fix it, I ended up rougly back at the <code>Subscribe</code> design, but this time returning a custom WasiFuture type that has an additional <code>WasiView</code> parameter on its <code>poll</code> method. To prevent scope creep of this PR, I kept <code>Subscribe</code> alive for now (as <code>PollableAsync</code>). But in the long run, I don't think there's much value in havin them both, as <code>Subscribe</code> can be trivially converted to <code>Pollable</code> from:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[async_trait::async_trait]</span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">PollableAsync</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">HostFutureIncomingResponse</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">ready</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"bp\">Self</span>::<span class=\"n\">Pending</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">Self</span>::<span class=\"n\">Ready</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">.</span><span class=\"k\">await</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>to:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Pollable</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">HostFutureIncomingResponse</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">ready</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;'</span><span class=\"na\">a</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">Pin</span><span class=\"o\">&lt;</span><span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">WasiFuture</span><span class=\"o\">&lt;</span><span class=\"n\">Output</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nb\">Send</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">a</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nb\">Box</span>::<span class=\"n\">pin</span><span class=\"p\">(</span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"bp\">Self</span>::<span class=\"n\">Pending</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">Self</span>::<span class=\"n\">Ready</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"p\">.</span><span class=\"k\">await</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">})</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>One obvious downside is the added visual noise.</p>\n</blockquote>",
        "id": 419286515,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706805496
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1921739171\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>I chose to go with a hybrid approach. For the public API, I changed it to what you suggested. Internally, I removed Lease &amp; SlotIdentity. But I kept Slot to perform the resource type check. Also, as part of the updated design (see above) I needed <code>take_any</code> and <code>restore_any</code> so I included those as well.<br>\n</p>\n</blockquote>",
        "id": 419286560,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706805508
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1927503952\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>Reading over this and see how this all turned out, I'm personally starting to get second thoughts on this. We're effectively reimplementing our own <code>Future</code> trait and as I'm sure you've seen we start implementing our own primitive functions (e.g. <code>poll_fn</code>) as well as we can't use standard things like <code>async fn</code> or <code>#[async_trait]</code>. I'm a bit worried that the direction this is taking us is straying off the path of maintainability for async support as things get more advanced over time.</p>\n<p>Now that's all easy to say but this PR is still solving a concrete problem which is letting implementations access resources while polling, so I don't think simply closing this PR is an option. That being said after having read over this I wonder if there's perhaps an alternative implementation route that we can take.</p>\n<p>Originally when designing <code>Future</code>-the-trait we ran into this issue of situations wanting to pass more context along through the <code>poll</code> method but the context doesn't survive longer than a single call to <code>poll</code>. To do that we ended up creating <a href=\"https://docs.rs/tokio/latest/tokio/task/struct.LocalKey.html\">task-local variables</a> which are like thread locals but instead stick with a task. That doesn't solve the immediate problem at hand though since you want mutable access, not just readable access.</p>\n<p>To solve the mutability problem I realized that the <code>take</code>/<code>restore</code> bits look like <code>Option&lt;T&gt;</code> and so they've already got runtime state associated with them. One alternative would be to use a <code>RefCell&lt;T&gt;</code> instead and effectively repurpose that runtime state. That would enable acquiring <code>&amp;mut T</code> from <code>&amp;ResourceTable</code> so long as it's done \"correctly\" which is basically already the situation we have today (make sure you <code>restore</code> after you <code>take</code>).</p>\n<p>How would you feel about something like that? We could still preserve <code>get_mut</code> as a method which has no runtime overhead (apart from storage space) but I'm imagining that a <code>borrow_mut()</code> method would be added. I'll note that <code>get</code> would have to go away in this world and be replaced with <code>borrow()</code> as a consequence, which likely affects code we have today.</p>\n<p>While <code>RefCell</code> is unlikely to win any award for being the most ergonomic thing in the world this feels like it might provide a better tradeoff because we wouldn't fall off the well-trodden-path of Rust async into custom traits and such. I would want to make sure it works for your use case though.</p>\n<p>I also realize though that you've probably already put in a great deal of work to this PR with 2 versions now so I'm hesitant to ask for a third. I'd be happy to help sketch this out and do some of the refactoring work to see if I feel like it's going to pay off.</p>\n</blockquote>",
        "id": 419889415,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707153178
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1928455198\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>I think you mean changing</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">ready</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>to </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">ready</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">table</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">ResourceTable</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>right?</p>\n<p>That doesn;t work because <code>&amp;ResourceTable</code> is not Send as <code>ResourceTable</code> is not Sync.</p>\n</blockquote>",
        "id": 419943741,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707173853
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1935734455\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>Good point, yes, I'm more-or-less saying we should do that. (either that or use a task-local but I think that still captures <code>&amp;T</code>). </p>\n<p>Mind trying make <code>ResourceTable</code> implement <code>Sync</code>? I think that's probably the addition of a few trait bounds in its internal trait objects. I think everything we put in there is already <code>Sync</code> although if it things aren't currently <code>Sync</code> that'll pose a larger problem.</p>\n</blockquote>",
        "id": 420631495,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707477426
    },
    {
        "content": "<p>badeend updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>.</p>",
        "id": 420885080,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707653198
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1937753694\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>I understand your concerns, yet I'd rather not go for round three right now, which would include reverting <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7802\">https://github.com/bytecodealliance/wasmtime/pull/7802</a>. So instead, I've changed the questionable types to be private to the <code>poll.rs</code> module. That way, all the iffy-ness is contained to just a single file that we can iterate on later. From the outside nothing significant has changed, except that now I can use <code>poll_ready_fn</code>, which is what I personally was after.</p>\n</blockquote>",
        "id": 420889545,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707657784
    },
    {
        "content": "<p>badeend edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1937753694\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>I understand your concerns, yet I'd rather not go for round three right now, which would include reverting <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7802\">https://github.com/bytecodealliance/wasmtime/pull/7802</a>. So instead, I've changed the questionable types to be private to the <code>poll.rs</code> module. That way, all the iffy-ness is contained to just a single file that we can iterate on later. From the outside nothing significant has changed, except that now I can use <code>poll_ready_fn</code>, which is what I personally was after.</p>\n<p>Hope that's OK for you</p>\n</blockquote>",
        "id": 420893685,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707661575
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1942524419\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>Wanted to say I have not forgotten about this, I have been looking for time to write up something longer-form, which I hope to get to by tomorrow. Is this blocking anything though that it would be prudent to land now rather than later? If so I think it's good to go as-is, but otherwise I'd like to take some more time to write up longer-form thoughts.</p>\n</blockquote>",
        "id": 421325110,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707858172
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1942549993\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>There's no immediate rush from my side, so feel free to take your time.</p>\n</blockquote>",
        "id": 421326303,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707858737
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1944415868\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>Ok thanks again for your patience here, very much appreciated!</p>\n<p>I've gotten some time to think and work on this. I was leaning towards merging this, but then I realized that I'd prefer to avoid a situation where we land this and then later revert most of it towards a different strategy. In that sense I wanted, time permitting, to take a moment and figure out if alternative strategies would work. I'm getting a growing sense of unease with this direction as it's more-or-less a custom <code>Future</code> trait and is something we'd ideally avoid.</p>\n<p>So assuming that the main goal of this PR is to get access to <code>ResourceTable</code> during <code>async fn ready</code> I originally suggested the <code>borrow</code>/<code>borrow_mut</code> idea above using <code>RefCell</code>. I tried implementing that and turns out it doesn't work. That means that <code>ResourceTable</code> contains <code>RefCell</code> and <code>async fn ready</code> would close over <code>&amp;ResourceTable</code> (e.g. it's a new function argument). In such a situation it means that the returned future, which must be <code>Send</code>, closes over <code>&amp;ResourceTable</code>. That type is not <code>Send</code> because it requires <code>ResourceTable: Sync</code> which is not satisfied with <code>RefCell</code>. So that cans the idea of. using <code>RefCell</code>.</p>\n<p>After talking a bit more with @pchickey, however, I'm growing more fond of the idea of using <code>RwLock&lt;T&gt;</code> here instead of <code>RefCell&lt;T&gt;</code>. Not for the actual blocking aspect but instead only for the \"it's <code>Sync</code>\" aspect. To that end I <a href=\"https://github.com/alexcrichton/wasmtime/commit/980c8b7b852b974bd7c73c8ff95108e5dbf77618\">implemented this on a branch</a> and got tests passing with it. The changes are:</p>\n<ul>\n<li>Replace <code>ResourceTable::get</code> with <code>ResourceTable::{borrow, borrow_mut}</code> that return <code>RwLock{Read,Write}Guard&lt;T&gt;</code>.</li>\n<li>Remove table methods returning <code>Any</code></li>\n<li>Add <code>&amp;ResourceTable</code> as an argument to the <code>ready</code> async function.</li>\n<li>Replace most usage of <code>table().get()</code> with <code>table().get_mut()</code> (avoids locks)</li>\n<li>Use <code>u32</code> indices in <code>Pollable</code>'s <code>make_future</code> internals instead of <code>Any</code></li>\n<li>Rewrite headers in wasi-http to avoid needing <code>Any</code> by representing headers as <code>Resource&lt;Resource&lt;hyper::HeaderMap&gt;&gt;</code></li>\n</ul>\n<p>The major consequences of this decision, however, are:</p>\n<ul>\n<li><code>ResourceTable::{borrow, borrow_mut}</code> require atomic manipulations. No blocking, but it's atomics for something that's not contended 99.9% of the time.</li>\n<li>The <code>std::sync::RwLock</code> type cannot be used because <code>std::sync::RwLock{Read,Write}Guard</code> is not <code>Send</code>. I temporarily added a <code>tokio</code> dependency to <code>wasmtime</code>-the-crate and used <code>tokio::sync::RwLock</code> instead. Long-term I would like to avoid a <code>tokio</code> dep in the <code>wasmtime</code> crate.</li>\n<li>There's a few minor cleanup still to be had in terms of threading a few more errors in a few more places.</li>\n</ul>\n<p>Personally I'm inclined to take a route that looks like this, namely threading arguments through <code>async fn</code> rather than threading arguments through <code>fn poll</code>. This is a foundational change to how things work though, especially around a new footgun of not being able to <code>borrow_mut</code> twice. In that sense I'd like to get feedback along the lines of:</p>\n<ul>\n<li>@pchickey does this all sound reasonable enough to you?</li>\n<li>@badeend does this still solve your original use case, and if so what do you think about this approach vs the <code>poll</code> approach?</li>\n</ul>\n</blockquote>",
        "id": 421511368,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707937026
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812#issuecomment-1944416808\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7812\">PR #7812</a>:</p>\n<blockquote>\n<p>also cc @elliottt since you've touched a lot of WASI internals and you probably want to take a look too</p>\n</blockquote>",
        "id": 421511469,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1707937068
    }
]