[
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-773318631\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @peterhuene</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"wasmtime:api\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>peterhuene: wasmtime:api</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 225161709,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612446893
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-773394280\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>API-wise I personally feel like this would instead be a flag on <code>Linker</code> rather than a compile-time option, but the code is also so small here to support this I think it may be worthwhile exploring how we might be able to support this externally. Creating a <code>Func::new</code> which simply panics or returns a trap isn't so hard, and ideally clients that would specifically like to allow imports they don't allow could opt-in easily by implementing such behavior.</p>\n<p>For example one option to implement this externally today is that instead of <code>Linker::instantiate</code> you'd use <code>Linker::get</code> manually on the module's imports, filling in missing ones as necessary. Put another way I think you could write a function that takes <code>&amp;Linker</code> and <code>&amp;Module</code> and instantiates the module with this behavior only using the public API of the <code>wasmtime</code> crate.</p>\n<p>One worry I'd have with this as-is as well is that it assumes all missing imports are missing function imports, but it could be a missing import of any type and it's not entirely clear what you'd do for the other types of missing imports (e.g. a missing imported table for example).</p>\n</blockquote>",
        "id": 225174666,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612452574
    },
    {
        "content": "<p>AlexEne <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-773547705\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>Yes, it just allows functions to be missing, for other things it still has the behavior it had today, as I'm not sure what a \"sane\" alternative would be for missing non-functions.</p>\n<p>I like your alternative, I wasn't aware it's possible. do you have an example where those APIs are used that I could start from?</p>\n</blockquote>",
        "id": 225208976,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612466614
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-773558037\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>I believe a function like this should work for your purposes: </p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">instantiate</span><span class=\"p\">(</span><span class=\"n\">linker</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">Linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">module</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">Module</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">Instance</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Vec</span>::<span class=\"n\">new</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">.</span><span class=\"n\">imports</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">import</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"p\">.</span><span class=\"n\">ty</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">ExternType</span>::<span class=\"n\">Func</span><span class=\"p\">(</span><span class=\"n\">ty</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">Func</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                        </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">Trap</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"s\">\"function not implemented\"</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"p\">})</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">anyhow</span>::<span class=\"n\">bail</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"import not defined\"</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">Instance</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">imports</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 225211686,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612467730
    },
    {
        "content": "<p>tschneidereit <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-774230777\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>I do feel that having a <code>Linker</code> flag for this would be good, perhaps called something like <code>unstable_allow_missing_function_imports</code> or so, to make the \"functions only\" part clear.</p>\n<p>Additionally, it'd be great to also add this as an option <code>--unstable-allow-missing-function-imports</code> to the CLI. @AlexEne, do you think that's something you could add?</p>\n</blockquote>",
        "id": 225342523,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612552159
    },
    {
        "content": "<p>AlexEne <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-774403093\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>Yes, I can check how to add that to the CLI too. (and fix the name)</p>\n</blockquote>",
        "id": 225388138,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612589180
    },
    {
        "content": "<p>AlexEne <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-775083190\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>@tschneidereit on the command line option. I've added a <code>unstable_allow_missing_function_imports</code> in <code>wasmtime/src/lib.rs</code> in <code>CommonOptions</code>, and in the <code>Config</code> class from <code>wasmtime/src/config.rs</code>.</p>\n<p>I've also added a boolean setting in the linker, but it's unclear to me where I should configure the linker to use that value from <code>Config</code>.</p>\n</blockquote>",
        "id": 225531559,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612784282
    },
    {
        "content": "<p>AlexEne edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-775083190\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>@tschneidereit on the command line option. I've added a <code>unstable_allow_missing_function_imports</code> in <code>wasmtime/src/lib.rs</code> in <code>CommonOptions</code>, and in the <code>Config</code> class from <code>wasmtime/src/config.rs</code>.</p>\n<p>I've also added a boolean setting in the linker, but it's unclear to me where I should configure the linker to use that value from <code>Config</code>.</p>\n<p>@alexcrichton: On the manual specification of missing methods, the code does look promising, I did translate it to <code>C</code> as that's how i'm using wasmtime, so it will require some changes to expose the <code>linker.get(</code> methods through the <code>c-api</code> crate as it's not public now.<br>\nIn adition to that, crafting the trap message from C is a bit clunky as <code>wasm_trap_new</code> requires the <code>store</code> as a parameter. This means that I have to bypass it by using a global <code>static wasm_trap_t*</code> as the store can't be captured in a C++ lambda in order to dynamically create the trap when the missing method is invoked from wasm.<br>\n</p>\n</blockquote>",
        "id": 225558837,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612797590
    },
    {
        "content": "<p>AlexEne edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-775083190\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>@tschneidereit on the command line option. I've added a <code>unstable_allow_missing_function_imports</code> in <code>wasmtime/src/lib.rs</code> in <code>CommonOptions</code>, and in the <code>Config</code> class from <code>wasmtime/src/config.rs</code>.</p>\n<p>I've also added a boolean setting in the linker, but it's unclear to me where I should configure the linker to use that value from <code>Config</code>.</p>\n<p>@alexcrichton: On the manual specification of missing methods, the code does look promising, I did translate it to <code>C</code> as that's how i'm using wasmtime, so it will require some changes to expose the <code>linker.get(</code> methods through the <code>c-api</code> crate as it's not public now. This also requires making <code>ImportType</code> public as now it's <code>pub(crate)</code>.<br>\nIn adition to that, crafting the trap message from C is a bit clunky as <code>wasm_trap_new</code> requires the <code>store</code> as a parameter. This means that I have to bypass it by using a global <code>static wasm_trap_t*</code> as the store can't be captured in a C++ lambda in order to dynamically create the trap when the missing method is invoked from wasm.<br>\n</p>\n</blockquote>",
        "id": 225560064,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612798066
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-775241223\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>I don't think that this needs to be in <code>Config</code>, at most I think it just needs a flag on <code>Linker</code>. @tschneidereit would you be ok with just a CLI flag, though? Since this is easy enough to implement externally and since this is in theory behavior that will get subsumed by wasm standards in the future, I'd prefer to avoid changing the <code>Linker</code> type if we can.</p>\n<p>@AlexEne for the C API I think <code>wasm_importtype_t</code> already exists, and for acquiring the store you could either store that in a global variable or use the <code>wasmtime_*</code> APIs for functions which give you a <code>wasmtime_caller_t</code> which you can acquire the store from. We may not have the method in the C API yet to get the <code>wasm_store_t</code> from that but it's possible to implement.</p>\n</blockquote>",
        "id": 225562696,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612799139
    },
    {
        "content": "<p>AlexEne <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-775315647\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>Yes, <code>wasm_importtype_t</code> exists, the one that I mentioned was <code>ImportType</code> (the rust counterpart and parameter to <code>linker.get(</code>  as that's currently defined as <code>pub(crate)</code> and can't be created in order to call the linker current method. It's not a big deal, I can shuffle things around so it's possible to create it from the <code>c-api</code> crate.</p>\n</blockquote>",
        "id": 225579472,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1612805639
    },
    {
        "content": "<p>AlexEne <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637#issuecomment-797492331\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/2637\">Issue #2637</a>:</p>\n<blockquote>\n<p>It seems that there isn't really an consensus on how to proceed with this, so I will close this PR for now, and will handle this in my mirror as my use-case can be solved by a patch of a couple of lines in the linker that makes this behavior default.</p>\n<p>Once optional imports are implemented this would not be needed anyway.<br>\n</p>\n</blockquote>",
        "id": 230028452,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1615555932
    }
]