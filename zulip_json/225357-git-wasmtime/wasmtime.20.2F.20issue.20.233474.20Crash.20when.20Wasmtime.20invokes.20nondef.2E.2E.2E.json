[
    {
        "content": "<p>itowlson opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474\">issue #3474</a>:</p>\n<blockquote>\n<p>I originally raised this at AssemblyScript (<a href=\"https://github.com/AssemblyScript/assemblyscript/issues/2099\">https://github.com/AssemblyScript/assemblyscript/issues/2099</a>) but they appear to view it as an issue with Wasm runtimes; they have raised a Wasmer bug but my use case is Wasmtime.</p>\n<hr>\n<p>Consider the following AssemblyScript program:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"wasi\"</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">()</span>: <span class=\"nc\">void</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"foo\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"n\">Math</span><span class=\"p\">.</span><span class=\"n\">random</span><span class=\"p\">().</span><span class=\"n\">toString</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"s\">\"start\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Compile this using</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">asc</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">explicitStart</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">debug</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Now run <code>wasmtime run --invoke foo ./build/untouched.wasm</code></p>\n<p>It crashes with:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">invoke</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">foo</span><span class=\"err\">`</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">exit</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"n\">outside</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"mi\">126</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">       </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n           <span class=\"mi\">0</span>:  <span class=\"mh\">0x5a9</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!~</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">index</span><span class=\"o\">/</span><span class=\"n\">abort</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"mi\">1</span>: <span class=\"mh\">0x2c4a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!~</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">rt</span><span class=\"o\">/</span><span class=\"n\">itcms</span><span class=\"o\">/</span><span class=\"n\">visitRoots</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"mi\">2</span>: <span class=\"mh\">0x2e73</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!~</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">rt</span><span class=\"o\">/</span><span class=\"n\">itcms</span><span class=\"o\">/</span><span class=\"n\">step</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"mi\">3</span>: <span class=\"mh\">0x2fb2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!~</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">rt</span><span class=\"o\">/</span><span class=\"n\">itcms</span><span class=\"o\">/</span><span class=\"n\">interrupt</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"mi\">4</span>: <span class=\"mh\">0x31ea</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!~</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">rt</span><span class=\"o\">/</span><span class=\"n\">itcms</span><span class=\"o\">/</span><span class=\"n\">__new</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"mi\">5</span>: <span class=\"mh\">0x3441</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!~</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">util</span><span class=\"o\">/</span><span class=\"n\">number</span><span class=\"o\">/</span><span class=\"n\">dtoa</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"mi\">6</span>: <span class=\"mh\">0x322c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!~</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">number</span><span class=\"o\">/</span><span class=\"n\">F64</span>#<span class=\"n\">toString</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"mi\">7</span>: <span class=\"mh\">0x337b</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!</span><span class=\"n\">assembly</span><span class=\"o\">/</span><span class=\"n\">index</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"err\">```</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The crash occurs within the AssemblyScript garbage collector while trying to allocate a string.</p>\n<p>I believe the reason AssemblyScript considers this a runtime bug is that they set up the GC in the implicit <code>_start</code> function.  Calling <code>wasmtime run --invoke foo</code> bypasses <code>_start</code> and therefore the GC is not set up when it needs to do the allocation.</p>\n<p>This also occurs when invoking the function via the Wasmtime Rust crate hosted in my own program (<a href=\"https://github.com/deislabs/wagi/issues/128\">https://github.com/deislabs/wagi/issues/128</a>).</p>\n<p>There are additional details and discussion in the original AssemblyScript issue <a href=\"https://github.com/AssemblyScript/assemblyscript/issues/2099\">https://github.com/AssemblyScript/assemblyscript/issues/2099</a>.</p>\n</blockquote>",
        "id": 259037783,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1635208056
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474#issuecomment-951734116\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474\">issue #3474</a>:</p>\n<blockquote>\n<p>There are two kinds of wasi programs:</p>\n<ul>\n<li>commands: These are like executables and need <code>_start</code> invoked one time. Once it returns you are no longer allowed to call into it ever again.</li>\n<li>reactors: These are like libraries and need <code>_initialize</code> invoked one time. Once it returns you are allowed to call any exported function as many times as you want. (subject to restrictions defined by the specific reactor you are running)</li>\n</ul>\n<p>If assemblyscript wants to allow invoking functions other than <code>_start</code>, it will need to create wasi reactors AFAIK and thus provide an <code>_initialize</code> function instead of a <code>_start</code> function. It is not valid to provide both.</p>\n<p><a href=\"https://github.com/WebAssembly/WASI/issues/13\">https://github.com/WebAssembly/WASI/issues/13</a></p>\n</blockquote>",
        "id": 259069301,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1635239088
    },
    {
        "content": "<p>esoterra <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474#issuecomment-1915071216\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474\">issue #3474</a>:</p>\n<blockquote>\n<p>@itowlson are you saying that we aren't calling the module <code>_start</code> function during module initialization as <a href=\"https://webassembly.github.io/spec/core/exec/modules.html#instantiation\">required by spec</a>?</p>\n</blockquote>",
        "id": 418674403,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706545621
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474#issuecomment-1915187649\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474\">issue #3474</a>:</p>\n<blockquote>\n<p>WASI's <code>_start</code> and the wasm start function are entirely separate. The wasm start function is always called during module instantiation, before you get access to the wasm module instance. Because of this, it is impossible for functions called by the start function to get access to any of the exports of the wasm module that is running the start function. This includes the memory export that WASI needs for pointer accesses. For this reason WASI uses a separate <code>_start</code> (for commands) or <code>_initialize</code> (for reactors) function that runs after the wasm module has been instantiated.</p>\n</blockquote>",
        "id": 418682419,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706548078
    },
    {
        "content": "<p>esoterra <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474#issuecomment-1915296108\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3474\">issue #3474</a>:</p>\n<blockquote>\n<p>I see, I was mixing up</p>\n<ul>\n<li><a href=\"https://webassembly.github.io/spec/core/syntax/modules.html#syntax-start\">Module <code>start</code></a></li>\n<li><a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#-start-definitions\">Component <code>start</code></a>, and</li>\n<li><a href=\"https://github.com/WebAssembly/WASI/blob/main/legacy/application-abi.md#current-unstable-abi\">Preview 1 <code>_start</code></a></li>\n</ul>\n<p>My bad, please disregard the above comment.</p>\n</blockquote>",
        "id": 418693364,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706551900
    }
]