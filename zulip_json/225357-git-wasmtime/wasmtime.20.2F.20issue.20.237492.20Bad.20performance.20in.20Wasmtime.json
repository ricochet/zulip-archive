[
    {
        "content": "<p>hungryzzz opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>Hi, I run the attached case in <code>Wasmtime</code> and <code>WasmEdge</code> respectively and I find that the execution time of <code>Wasmtime</code> is 4x slower than which of <code>WasmEdge</code>(measured by <code>time</code> tool).</p>\n<ul>\n<li><code>Wasmtime</code>: 4.20s</li>\n<li><code>WasmEdge</code>: 1.05s</li>\n</ul>\n<p>I try to use the <code>perf</code> tool to locate the time consuming part of code, the report is as followed.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mf\">99.66</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">jitted</span><span class=\"o\">-</span><span class=\"mi\">2354298</span><span class=\"o\">-</span><span class=\"mf\">2.</span><span class=\"n\">so</span><span class=\"w\">  </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>::<span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.03</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">jitted</span><span class=\"o\">-</span><span class=\"mi\">2354298</span><span class=\"o\">-</span><span class=\"mf\">1.</span><span class=\"n\">so</span><span class=\"w\">  </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>::<span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.03</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">update_min_vruntime</span><span class=\"w\">                                                                                                 </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">zap_pte_range</span><span class=\"p\">.</span><span class=\"n\">isra</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">libc</span><span class=\"o\">-</span><span class=\"mf\">2.31.</span><span class=\"n\">so</span><span class=\"w\">         </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">__memset_avx2_erms</span><span class=\"w\">                                                                                                  </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">__vma_adjust</span><span class=\"w\">                                                                                                        </span><span class=\"err\">◆</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">error_entry</span><span class=\"w\">                                                                                                         </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">filemap_map_pages</span><span class=\"w\">                                                                                                   </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">page_add_file_rmap</span><span class=\"w\">                                                                                                  </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">             </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">wasmtime_cranelift_shared</span>::<span class=\"n\">compiled_function</span>::<span class=\"n\">collect_address_maps</span>::<span class=\"n\">cvt</span><span class=\"w\">                                             </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">entry_SYSCALL_64_after_hwframe</span><span class=\"w\">                                                                                      </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">mem_cgroup_from_task</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">charge_memcg</span><span class=\"w\">                                                                                                        </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">kmem_cache_alloc</span><span class=\"w\">                                                                                                    </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">___slab_alloc</span><span class=\"w\">                                                                                                       </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">update_cfs_rq_h_load</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">kmem_cache_free</span><span class=\"w\">                                                                                                     </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">libc</span><span class=\"o\">-</span><span class=\"mf\">2.31.</span><span class=\"n\">so</span><span class=\"w\">         </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">realloc</span>\n</code></pre></div>\n<p>&lt;img width=\"1233\" alt=\"截屏2023-11-07 20 26 59\" src=\"<a href=\"https://github.com/bytecodealliance/wasmtime/assets/32137313/27299d97-fe40-48a0-91c0-fcbefbac746a\">https://github.com/bytecodealliance/wasmtime/assets/32137313/27299d97-fe40-48a0-91c0-fcbefbac746a</a>\"&gt;</p>\n<p>Also,  I try to dump the machine code generated by <code>WasmEdge</code>(<code>LLVM</code>) and I get a shorter machine code than <code>Wasmtime</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># Machine code generated by LLVM, only  36 instructions compared with 127 instructions generated by Wasmtime.</span>\n<span class=\"m\">0000000000000140</span><span class=\"w\"> </span>&lt;f3&gt;:\n<span class=\"w\"> </span><span class=\"m\">140</span>:<span class=\"w\">   </span><span class=\"m\">40</span><span class=\"w\"> </span>f6<span class=\"w\"> </span>c6<span class=\"w\"> </span><span class=\"m\">20</span><span class=\"w\">             </span><span class=\"nb\">test</span><span class=\"w\">   </span><span class=\"nv\">$0</span>x20,%sil\n<span class=\"w\"> </span><span class=\"m\">144</span>:<span class=\"w\">   </span><span class=\"m\">75</span><span class=\"w\"> </span>2b<span class=\"w\">                   </span>jne<span class=\"w\">    </span><span class=\"m\">171</span><span class=\"w\"> </span>&lt;f3+0x31&gt;\n<span class=\"w\"> </span><span class=\"m\">146</span>:<span class=\"w\">   </span>4c<span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">07</span><span class=\"w\">                </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rdi<span class=\"o\">)</span>,%r8\n<span class=\"w\"> </span><span class=\"m\">149</span>:<span class=\"w\">   </span><span class=\"m\">40</span><span class=\"w\"> </span>0f<span class=\"w\"> </span>b6<span class=\"w\"> </span>c6<span class=\"w\">             </span>movzbl<span class=\"w\"> </span>%sil,%eax\n<span class=\"w\"> </span>14d:<span class=\"w\">   </span>4d<span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%r8<span class=\"o\">)</span>,%r8\n<span class=\"w\"> </span><span class=\"m\">150</span>:<span class=\"w\">   </span><span class=\"m\">42</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">74</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\">          </span>mov<span class=\"w\">    </span>0x10<span class=\"o\">(</span>%rax,%r8,1<span class=\"o\">)</span>,%esi\n<span class=\"w\"> </span><span class=\"m\">155</span>:<span class=\"w\">   </span><span class=\"m\">42</span><span class=\"w\"> </span>2b<span class=\"w\"> </span><span class=\"m\">74</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\">          </span>sub<span class=\"w\">    </span>0x14<span class=\"o\">(</span>%rax,%r8,1<span class=\"o\">)</span>,%esi\n<span class=\"w\"> </span>15a:<span class=\"w\">   </span><span class=\"m\">39</span><span class=\"w\"> </span>ce<span class=\"w\">                   </span>cmp<span class=\"w\">    </span>%ecx,%esi\n<span class=\"w\"> </span>15c:<span class=\"w\">   </span><span class=\"m\">73</span><span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>jae<span class=\"w\">    </span><span class=\"m\">163</span><span class=\"w\"> </span>&lt;f3+0x23&gt;\n<span class=\"w\"> </span>15e:<span class=\"w\">   </span>e9<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>jmpq<span class=\"w\">   </span><span class=\"m\">163</span><span class=\"w\"> </span>&lt;f3+0x23&gt;\n<span class=\"w\"> </span><span class=\"m\">163</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>fa<span class=\"w\"> </span>ff<span class=\"w\">             </span>cmp<span class=\"w\">    </span><span class=\"nv\">$0</span>xffff,%dx\n<span class=\"w\"> </span><span class=\"m\">167</span>:<span class=\"w\">   </span><span class=\"m\">75</span><span class=\"w\"> </span><span class=\"m\">09</span><span class=\"w\">                   </span>jne<span class=\"w\">    </span><span class=\"m\">172</span><span class=\"w\"> </span>&lt;f3+0x32&gt;\n<span class=\"w\"> </span><span class=\"m\">169</span>:<span class=\"w\">   </span><span class=\"m\">42</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>7c<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">50</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>cmpl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,0x50<span class=\"o\">(</span>%rax,%r8,1<span class=\"o\">)</span>\n<span class=\"w\"> </span>16f:<span class=\"w\">   </span><span class=\"m\">74</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\">                   </span>je<span class=\"w\">     </span><span class=\"m\">172</span><span class=\"w\"> </span>&lt;f3+0x32&gt;\n<span class=\"w\"> </span><span class=\"m\">171</span>:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>retq\n<span class=\"w\"> </span><span class=\"m\">172</span>:<span class=\"w\">   </span><span class=\"m\">41</span><span class=\"w\"> </span><span class=\"m\">89</span><span class=\"w\"> </span>d1<span class=\"w\">                </span>mov<span class=\"w\">    </span>%edx,%r9d\n<span class=\"w\"> </span><span class=\"m\">175</span>:<span class=\"w\">   </span><span class=\"m\">89</span><span class=\"w\"> </span>c8<span class=\"w\">                   </span>mov<span class=\"w\">    </span>%ecx,%eax\n<span class=\"w\"> </span><span class=\"m\">177</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">84</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>nopw<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n<span class=\"w\"> </span>17e:<span class=\"w\">   </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span>\n<span class=\"w\"> </span><span class=\"m\">180</span>:<span class=\"w\">   </span><span class=\"m\">85</span><span class=\"w\"> </span>c0<span class=\"w\">                   </span><span class=\"nb\">test</span><span class=\"w\">   </span>%eax,%eax\n<span class=\"w\"> </span><span class=\"m\">182</span>:<span class=\"w\">   </span><span class=\"m\">75</span><span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\">                   </span>jne<span class=\"w\">    </span><span class=\"m\">194</span><span class=\"w\"> </span>&lt;f3+0x54&gt;\n<span class=\"w\"> </span><span class=\"m\">184</span>:<span class=\"w\">   </span><span class=\"m\">89</span><span class=\"w\"> </span>ce<span class=\"w\">                   </span>mov<span class=\"w\">    </span>%ecx,%esi\n<span class=\"w\"> </span><span class=\"m\">186</span>:<span class=\"w\">   </span><span class=\"m\">81</span><span class=\"w\"> </span>e6<span class=\"w\"> </span>ff<span class=\"w\"> </span>7f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>and<span class=\"w\">    </span><span class=\"nv\">$0</span>x7fff,%esi\n<span class=\"w\"> </span>18c:<span class=\"w\">   </span><span class=\"m\">81</span><span class=\"w\"> </span>fe<span class=\"w\"> </span>ff<span class=\"w\"> </span>7f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>cmp<span class=\"w\">    </span><span class=\"nv\">$0</span>x7fff,%esi\n<span class=\"w\"> </span><span class=\"m\">192</span>:<span class=\"w\">   </span><span class=\"m\">74</span><span class=\"w\"> </span>dd<span class=\"w\">                   </span>je<span class=\"w\">     </span><span class=\"m\">171</span><span class=\"w\"> </span>&lt;f3+0x31&gt;\n<span class=\"w\"> </span><span class=\"m\">194</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">41</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>f9<span class=\"w\"> </span>ff<span class=\"w\">          </span>cmp<span class=\"w\">    </span><span class=\"nv\">$0</span>xffff,%r9w\n<span class=\"w\"> </span><span class=\"m\">199</span>:<span class=\"w\">   </span><span class=\"m\">74</span><span class=\"w\"> </span><span class=\"m\">15</span><span class=\"w\">                   </span>je<span class=\"w\">     </span>1b0<span class=\"w\"> </span>&lt;f3+0x70&gt;\n<span class=\"w\"> </span>19b:<span class=\"w\">   </span>ff<span class=\"w\"> </span>c1<span class=\"w\">                   </span>inc<span class=\"w\">    </span>%ecx\n<span class=\"w\"> </span>19d:<span class=\"w\">   </span>8d<span class=\"w\"> </span><span class=\"m\">34</span><span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\">                </span>lea<span class=\"w\">    </span><span class=\"o\">(</span>%rdx,%rax,1<span class=\"o\">)</span>,%esi\n<span class=\"w\"> </span>1a0:<span class=\"w\">   </span>ff<span class=\"w\"> </span>c8<span class=\"w\">                   </span>dec<span class=\"w\">    </span>%eax\n<span class=\"w\"> </span>1a2:<span class=\"w\">   </span><span class=\"m\">40</span><span class=\"w\"> </span>0f<span class=\"w\"> </span>b6<span class=\"w\"> </span>f6<span class=\"w\">             </span>movzbl<span class=\"w\"> </span>%sil,%esi\n<span class=\"w\"> </span>1a6:<span class=\"w\">   </span><span class=\"m\">41</span><span class=\"w\"> </span>ff<span class=\"w\"> </span>c1<span class=\"w\">                </span>inc<span class=\"w\">    </span>%r9d\n<span class=\"w\"> </span>1a9:<span class=\"w\">   </span><span class=\"m\">41</span><span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span>3c<span class=\"w\"> </span><span class=\"m\">30</span><span class=\"w\"> </span>0a<span class=\"w\">          </span>cmpb<span class=\"w\">   </span><span class=\"nv\">$0</span>xa,<span class=\"o\">(</span>%r8,%rsi,1<span class=\"o\">)</span>\n<span class=\"w\"> </span>1ae:<span class=\"w\">   </span><span class=\"m\">75</span><span class=\"w\"> </span>d0<span class=\"w\">                   </span>jne<span class=\"w\">    </span><span class=\"m\">180</span><span class=\"w\"> </span>&lt;f3+0x40&gt;\n<span class=\"w\"> </span>1b0:<span class=\"w\">   </span>ff<span class=\"w\"> </span>c2<span class=\"w\">                   </span>inc<span class=\"w\">    </span>%edx\n<span class=\"w\"> </span>1b2:<span class=\"w\">   </span>e9<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>jmpq<span class=\"w\">   </span>1b7<span class=\"w\"> </span>&lt;f3+0x77&gt;\n</code></pre></div>\n<p>I think maybe there are some missing optimizations in <code>Cranelift</code> so <code>Wasmtime</code> generates a suboptimal machine code and executes longer than <code>WasmEdge</code>.</p>\n<h3>Versions and Environment</h3>\n<ul>\n<li><code>Wasmtime</code>: e0bfa7336de20f76048edbdc0157ee637a2c5fea (build release version)</li>\n<li><code>WasmEdge</code>: 7d4213b3abd5360c88e9120c3bc68ffd9b8a6870</li>\n<li>kernel version: Linux 5.15.0-83-generic</li>\n</ul>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/13279963/case.zip\">case.zip</a></p>\n</blockquote>",
        "id": 400732031,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699361135
    },
    {
        "content": "<p>hungryzzz edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>Hi, I run the attached case in <code>Wasmtime</code> and <code>WasmEdge</code> respectively and I find that the execution time of <code>Wasmtime</code> is 4x slower than which of <code>WasmEdge</code>(measured by <code>time</code> tool).</p>\n<ul>\n<li><code>Wasmtime</code>: 4.20s</li>\n<li><code>WasmEdge</code>: 1.05s</li>\n</ul>\n<p>I try to use the <code>perf</code> tool to locate the time consuming part of code, the report is as followed.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mf\">99.66</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">jitted</span><span class=\"o\">-</span><span class=\"mi\">2354298</span><span class=\"o\">-</span><span class=\"mf\">2.</span><span class=\"n\">so</span><span class=\"w\">  </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>::<span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.03</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">jitted</span><span class=\"o\">-</span><span class=\"mi\">2354298</span><span class=\"o\">-</span><span class=\"mf\">1.</span><span class=\"n\">so</span><span class=\"w\">  </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>::<span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.03</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">update_min_vruntime</span><span class=\"w\">                                                                                                 </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">zap_pte_range</span><span class=\"p\">.</span><span class=\"n\">isra</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">libc</span><span class=\"o\">-</span><span class=\"mf\">2.31.</span><span class=\"n\">so</span><span class=\"w\">         </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">__memset_avx2_erms</span><span class=\"w\">                                                                                                  </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">__vma_adjust</span><span class=\"w\">                                                                                                        </span><span class=\"err\">◆</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">error_entry</span><span class=\"w\">                                                                                                         </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.02</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">filemap_map_pages</span><span class=\"w\">                                                                                                   </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">page_add_file_rmap</span><span class=\"w\">                                                                                                  </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">             </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">wasmtime_cranelift_shared</span>::<span class=\"n\">compiled_function</span>::<span class=\"n\">collect_address_maps</span>::<span class=\"n\">cvt</span><span class=\"w\">                                             </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">entry_SYSCALL_64_after_hwframe</span><span class=\"w\">                                                                                      </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">mem_cgroup_from_task</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">charge_memcg</span><span class=\"w\">                                                                                                        </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">kmem_cache_alloc</span><span class=\"w\">                                                                                                    </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">___slab_alloc</span><span class=\"w\">                                                                                                       </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">update_cfs_rq_h_load</span><span class=\"w\">                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"n\">kernel</span><span class=\"p\">.</span><span class=\"n\">kallsyms</span><span class=\"p\">]</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">kmem_cache_free</span><span class=\"w\">                                                                                                     </span><span class=\"err\">▒</span>\n<span class=\"mf\">0.01</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"n\">libc</span><span class=\"o\">-</span><span class=\"mf\">2.31.</span><span class=\"n\">so</span><span class=\"w\">         </span><span class=\"p\">[.]</span><span class=\"w\"> </span><span class=\"n\">realloc</span>\n</code></pre></div>\n<p>&lt;img width=\"1233\" alt=\"截屏2023-11-07 20 26 59\" src=\"<a href=\"https://github.com/bytecodealliance/wasmtime/assets/32137313/27299d97-fe40-48a0-91c0-fcbefbac746a\">https://github.com/bytecodealliance/wasmtime/assets/32137313/27299d97-fe40-48a0-91c0-fcbefbac746a</a>\"&gt;</p>\n<p>Also,  I try to dump the machine code generated by <code>WasmEdge</code>(<code>LLVM</code>) and I get a shorter machine code than <code>Wasmtime</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># Machine code generated by LLVM, only  36 instructions compared with 127 instructions generated by Wasmtime.</span>\n<span class=\"m\">0000000000000140</span><span class=\"w\"> </span>&lt;f3&gt;:\n<span class=\"w\"> </span><span class=\"m\">140</span>:<span class=\"w\">   </span><span class=\"m\">40</span><span class=\"w\"> </span>f6<span class=\"w\"> </span>c6<span class=\"w\"> </span><span class=\"m\">20</span><span class=\"w\">             </span><span class=\"nb\">test</span><span class=\"w\">   </span><span class=\"nv\">$0</span>x20,%sil\n<span class=\"w\"> </span><span class=\"m\">144</span>:<span class=\"w\">   </span><span class=\"m\">75</span><span class=\"w\"> </span>2b<span class=\"w\">                   </span>jne<span class=\"w\">    </span><span class=\"m\">171</span><span class=\"w\"> </span>&lt;f3+0x31&gt;\n<span class=\"w\"> </span><span class=\"m\">146</span>:<span class=\"w\">   </span>4c<span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">07</span><span class=\"w\">                </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%rdi<span class=\"o\">)</span>,%r8\n<span class=\"w\"> </span><span class=\"m\">149</span>:<span class=\"w\">   </span><span class=\"m\">40</span><span class=\"w\"> </span>0f<span class=\"w\"> </span>b6<span class=\"w\"> </span>c6<span class=\"w\">             </span>movzbl<span class=\"w\"> </span>%sil,%eax\n<span class=\"w\"> </span>14d:<span class=\"w\">   </span>4d<span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">                </span>mov<span class=\"w\">    </span><span class=\"o\">(</span>%r8<span class=\"o\">)</span>,%r8\n<span class=\"w\"> </span><span class=\"m\">150</span>:<span class=\"w\">   </span><span class=\"m\">42</span><span class=\"w\"> </span>8b<span class=\"w\"> </span><span class=\"m\">74</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\">          </span>mov<span class=\"w\">    </span>0x10<span class=\"o\">(</span>%rax,%r8,1<span class=\"o\">)</span>,%esi\n<span class=\"w\"> </span><span class=\"m\">155</span>:<span class=\"w\">   </span><span class=\"m\">42</span><span class=\"w\"> </span>2b<span class=\"w\"> </span><span class=\"m\">74</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">14</span><span class=\"w\">          </span>sub<span class=\"w\">    </span>0x14<span class=\"o\">(</span>%rax,%r8,1<span class=\"o\">)</span>,%esi\n<span class=\"w\"> </span>15a:<span class=\"w\">   </span><span class=\"m\">39</span><span class=\"w\"> </span>ce<span class=\"w\">                   </span>cmp<span class=\"w\">    </span>%ecx,%esi\n<span class=\"w\"> </span>15c:<span class=\"w\">   </span><span class=\"m\">73</span><span class=\"w\"> </span><span class=\"m\">05</span><span class=\"w\">                   </span>jae<span class=\"w\">    </span><span class=\"m\">163</span><span class=\"w\"> </span>&lt;f3+0x23&gt;\n<span class=\"w\"> </span>15e:<span class=\"w\">   </span>e9<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>jmpq<span class=\"w\">   </span><span class=\"m\">163</span><span class=\"w\"> </span>&lt;f3+0x23&gt;\n<span class=\"w\"> </span><span class=\"m\">163</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>fa<span class=\"w\"> </span>ff<span class=\"w\">             </span>cmp<span class=\"w\">    </span><span class=\"nv\">$0</span>xffff,%dx\n<span class=\"w\"> </span><span class=\"m\">167</span>:<span class=\"w\">   </span><span class=\"m\">75</span><span class=\"w\"> </span><span class=\"m\">09</span><span class=\"w\">                   </span>jne<span class=\"w\">    </span><span class=\"m\">172</span><span class=\"w\"> </span>&lt;f3+0x32&gt;\n<span class=\"w\"> </span><span class=\"m\">169</span>:<span class=\"w\">   </span><span class=\"m\">42</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>7c<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">50</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>cmpl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,0x50<span class=\"o\">(</span>%rax,%r8,1<span class=\"o\">)</span>\n<span class=\"w\"> </span>16f:<span class=\"w\">   </span><span class=\"m\">74</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\">                   </span>je<span class=\"w\">     </span><span class=\"m\">172</span><span class=\"w\"> </span>&lt;f3+0x32&gt;\n<span class=\"w\"> </span><span class=\"m\">171</span>:<span class=\"w\">   </span>c3<span class=\"w\">                      </span>retq\n<span class=\"w\"> </span><span class=\"m\">172</span>:<span class=\"w\">   </span><span class=\"m\">41</span><span class=\"w\"> </span><span class=\"m\">89</span><span class=\"w\"> </span>d1<span class=\"w\">                </span>mov<span class=\"w\">    </span>%edx,%r9d\n<span class=\"w\"> </span><span class=\"m\">175</span>:<span class=\"w\">   </span><span class=\"m\">89</span><span class=\"w\"> </span>c8<span class=\"w\">                   </span>mov<span class=\"w\">    </span>%ecx,%eax\n<span class=\"w\"> </span><span class=\"m\">177</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span>0f<span class=\"w\"> </span>1f<span class=\"w\"> </span><span class=\"m\">84</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>nopw<span class=\"w\">   </span>0x0<span class=\"o\">(</span>%rax,%rax,1<span class=\"o\">)</span>\n<span class=\"w\"> </span>17e:<span class=\"w\">   </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span>\n<span class=\"w\"> </span><span class=\"m\">180</span>:<span class=\"w\">   </span><span class=\"m\">85</span><span class=\"w\"> </span>c0<span class=\"w\">                   </span><span class=\"nb\">test</span><span class=\"w\">   </span>%eax,%eax\n<span class=\"w\"> </span><span class=\"m\">182</span>:<span class=\"w\">   </span><span class=\"m\">75</span><span class=\"w\"> </span><span class=\"m\">10</span><span class=\"w\">                   </span>jne<span class=\"w\">    </span><span class=\"m\">194</span><span class=\"w\"> </span>&lt;f3+0x54&gt;\n<span class=\"w\"> </span><span class=\"m\">184</span>:<span class=\"w\">   </span><span class=\"m\">89</span><span class=\"w\"> </span>ce<span class=\"w\">                   </span>mov<span class=\"w\">    </span>%ecx,%esi\n<span class=\"w\"> </span><span class=\"m\">186</span>:<span class=\"w\">   </span><span class=\"m\">81</span><span class=\"w\"> </span>e6<span class=\"w\"> </span>ff<span class=\"w\"> </span>7f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>and<span class=\"w\">    </span><span class=\"nv\">$0</span>x7fff,%esi\n<span class=\"w\"> </span>18c:<span class=\"w\">   </span><span class=\"m\">81</span><span class=\"w\"> </span>fe<span class=\"w\"> </span>ff<span class=\"w\"> </span>7f<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>cmp<span class=\"w\">    </span><span class=\"nv\">$0</span>x7fff,%esi\n<span class=\"w\"> </span><span class=\"m\">192</span>:<span class=\"w\">   </span><span class=\"m\">74</span><span class=\"w\"> </span>dd<span class=\"w\">                   </span>je<span class=\"w\">     </span><span class=\"m\">171</span><span class=\"w\"> </span>&lt;f3+0x31&gt;\n<span class=\"w\"> </span><span class=\"m\">194</span>:<span class=\"w\">   </span><span class=\"m\">66</span><span class=\"w\"> </span><span class=\"m\">41</span><span class=\"w\"> </span><span class=\"m\">83</span><span class=\"w\"> </span>f9<span class=\"w\"> </span>ff<span class=\"w\">          </span>cmp<span class=\"w\">    </span><span class=\"nv\">$0</span>xffff,%r9w\n<span class=\"w\"> </span><span class=\"m\">199</span>:<span class=\"w\">   </span><span class=\"m\">74</span><span class=\"w\"> </span><span class=\"m\">15</span><span class=\"w\">                   </span>je<span class=\"w\">     </span>1b0<span class=\"w\"> </span>&lt;f3+0x70&gt;\n<span class=\"w\"> </span>19b:<span class=\"w\">   </span>ff<span class=\"w\"> </span>c1<span class=\"w\">                   </span>inc<span class=\"w\">    </span>%ecx\n<span class=\"w\"> </span>19d:<span class=\"w\">   </span>8d<span class=\"w\"> </span><span class=\"m\">34</span><span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\">                </span>lea<span class=\"w\">    </span><span class=\"o\">(</span>%rdx,%rax,1<span class=\"o\">)</span>,%esi\n<span class=\"w\"> </span>1a0:<span class=\"w\">   </span>ff<span class=\"w\"> </span>c8<span class=\"w\">                   </span>dec<span class=\"w\">    </span>%eax\n<span class=\"w\"> </span>1a2:<span class=\"w\">   </span><span class=\"m\">40</span><span class=\"w\"> </span>0f<span class=\"w\"> </span>b6<span class=\"w\"> </span>f6<span class=\"w\">             </span>movzbl<span class=\"w\"> </span>%sil,%esi\n<span class=\"w\"> </span>1a6:<span class=\"w\">   </span><span class=\"m\">41</span><span class=\"w\"> </span>ff<span class=\"w\"> </span>c1<span class=\"w\">                </span>inc<span class=\"w\">    </span>%r9d\n<span class=\"w\"> </span>1a9:<span class=\"w\">   </span><span class=\"m\">41</span><span class=\"w\"> </span><span class=\"m\">80</span><span class=\"w\"> </span>3c<span class=\"w\"> </span><span class=\"m\">30</span><span class=\"w\"> </span>0a<span class=\"w\">          </span>cmpb<span class=\"w\">   </span><span class=\"nv\">$0</span>xa,<span class=\"o\">(</span>%r8,%rsi,1<span class=\"o\">)</span>\n<span class=\"w\"> </span>1ae:<span class=\"w\">   </span><span class=\"m\">75</span><span class=\"w\"> </span>d0<span class=\"w\">                   </span>jne<span class=\"w\">    </span><span class=\"m\">180</span><span class=\"w\"> </span>&lt;f3+0x40&gt;\n<span class=\"w\"> </span>1b0:<span class=\"w\">   </span>ff<span class=\"w\"> </span>c2<span class=\"w\">                   </span>inc<span class=\"w\">    </span>%edx\n<span class=\"w\"> </span>1b2:<span class=\"w\">   </span>e9<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>jmpq<span class=\"w\">   </span>1b7<span class=\"w\"> </span>&lt;f3+0x77&gt;\n</code></pre></div>\n<p>I think maybe there are some missing optimizations in <code>Cranelift</code> so <code>Wasmtime</code> generates a suboptimal machine code and gets longer execution time than <code>WasmEdge</code>.</p>\n<h3>Versions and Environment</h3>\n<ul>\n<li><code>Wasmtime</code>: e0bfa7336de20f76048edbdc0157ee637a2c5fea (build release version)</li>\n<li><code>WasmEdge</code>: 7d4213b3abd5360c88e9120c3bc68ffd9b8a6870</li>\n<li>kernel version: Linux 5.15.0-83-generic</li>\n</ul>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/13279963/case.zip\">case.zip</a></p>\n</blockquote>",
        "id": 400738594,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699363345
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802081416\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>Thanks for this and <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7495\">https://github.com/bytecodealliance/wasmtime/issues/7495</a>! Would you be able to provide the original source code as well? That'd likely help in investigating this.</p>\n</blockquote>",
        "id": 400963840,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699456155
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802120656\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>@alexcrichton Hi, does the original source code refer to <code>C</code> code? If yes, I don't have the original C code file either unfortunately.</p>\n</blockquote>",
        "id": 400967544,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699457260
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802123193\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>Ah I was curious about whatever source it came from, not necessarily C, but if you don't have the source then no worries.</p>\n</blockquote>",
        "id": 400967779,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699457327
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802127710\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>The earilest original source is from C. After compiling it to <code>wasm</code>, we mutate it and get the above case.</p>\n</blockquote>",
        "id": 400968283,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699457467
    },
    {
        "content": "<p>hungryzzz edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802127710\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>The earilest original source is from C. After compiling it to <code>wasm</code>, we mutate it and get the above case, so it will be quite different with the original source code. Actually, I have reduced the original <code>wasm</code> file, so the size of the buggy case I submmit is quite small(around 120 wasm instructions, only 3 functions) compared to the original one. I hope this will help your further investigating.</p>\n</blockquote>",
        "id": 400969602,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699457839
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802181129\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>Echoing Alex: thanks very much for reporting these perf bugs!</p>\n<p>@hungryzzz, out of curiosity, are you fuzzing performance across wasm runtimes? Do you have any additional details you can share about what you're doing and what your goals are?</p>\n</blockquote>",
        "id": 400973317,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699458975
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802229008\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>@fitzgen Yes, I am fuzzing performance using differential testing across wasm runtime. The current exection mode of the most wasm runtimes is AOT(compile the whole module to machine code and execute it), so I think the execution time of them should be close, if not, there maybe something wrong(misoptimization etc.) with the code generation of runtime.</p>\n<p>Our ideal pipeline of the fuzzing is, 1) generate lots of wasm test case; 2) differential testing across wasm runtimes and find the suspected performance bugs; 3) reduce buggy cases to a small size one to help further debuging(because the wasm bytecode generated from <code>emcc</code> is usually very very long).</p>\n</blockquote>",
        "id": 400978698,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699460465
    },
    {
        "content": "<p>hungryzzz deleted a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802229008\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>@fitzgen Yes, I am fuzzing performance using differential testing across wasm runtime. The current exection mode of the most wasm runtimes is AOT(compile the whole module to machine code and execute it), so I think the execution time of them should be close, if not, there maybe something wrong(misoptimization etc.) with the code generation of runtime.</p>\n<p>Our ideal pipeline of the fuzzing is, 1) generate lots of wasm test case; 2) differential testing across wasm runtimes and find the suspected performance bugs; 3) reduce buggy cases to a small size one to help further debuging(because the wasm bytecode generated from <code>emcc</code> is usually very very long).</p>\n</blockquote>",
        "id": 400979838,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699460814
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802240624\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>@fitzgen Yes, I am fuzzing performance using differential testing across wasm runtime. The current exection mode of the most wasm runtimes is AOT(compile the whole module to machine code and execute it), so I think the execution time of them should be close, if not, there maybe something wrong(misoptimization etc.) with the code generation of runtime.</p>\n</blockquote>",
        "id": 400979925,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699460843
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1802675186\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>VTune outputs this:</p>\n<p>&lt;img width=\"1111\" alt=\"Screenshot 2023-11-08 at 3 06 41 PM\" src=\"<a href=\"https://github.com/bytecodealliance/wasmtime/assets/64996/88e31d0b-9c53-462f-abe1-b94bd5030388\">https://github.com/bytecodealliance/wasmtime/assets/64996/88e31d0b-9c53-462f-abe1-b94bd5030388</a>\"&gt;</p>\n<p>which seems to point a smoking-ish gun at DSB Coverage/Misses. I just learned about this today and still know very little about it. For individual instructions this is what I'm seeing:</p>\n<p>&lt;img width=\"1856\" alt=\"Screenshot 2023-11-08 at 3 07 27 PM\" src=\"<a href=\"https://github.com/bytecodealliance/wasmtime/assets/64996/a97b0607-512a-4540-8d63-e6002c496b1e\">https://github.com/bytecodealliance/wasmtime/assets/64996/a97b0607-512a-4540-8d63-e6002c496b1e</a>\"&gt;</p>\n<p>I have not yet dug further at this time.</p>\n</blockquote>",
        "id": 401023351,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699477666
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1804476217\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>Sort of where I'm leaning for this and <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7495\">https://github.com/bytecodealliance/wasmtime/issues/7495</a> is that this may not be too too actionable without the original source. </p>\n<p>In general Cranelift is not expected to be able to beat LLVM, which I believe WasmEdge is using. Cranelift is intended to be competitive with \"peer JITs\" such as v8 and SpiderMonkey but it won't ever be able to reach parity with LLVM on all inputs. So in that sense it's not always a \"fair\" comparison to compare LLVM and Cranelift.</p>\n<p>Now that being said Wasmtime and Cranelift as a whole still want to be fast. Much of the speed of Wasmtime/Cranelift comes from pre-optimized WebAssembly modules. For example Rust/C programs originally go through LLVM's optimizer which takes care of advanced optimizations that Cranelift may not do. Afterwards Cranelift is intended to generate high-quality machine code with a high-quality instruction selector as well as optimizations around Wasmtime's injection of runtime management code (e.g. egraphs plus table bounds checks). So despite LLVM-vs-Cranelift not being \"fair\" it's something we're still interested in (hence thanks again for these issues!).</p>\n<p>It sounds, though, like the pipeline to produce these wasm files was to take an origin C program and mutate it. This starts moving into the realm of the original program no longer being optimized by LLVM, meaning that the onus is on Cranelift to perform more advanced optimizations that LLVM implements. This is unlikely to happen, however, given Cranelift's use case.</p>\n<p>So given all this that's what leads me to the conclusion that this may not be actionable. The bugs, from what I can tell, here and on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7495\">https://github.com/bytecodealliance/wasmtime/issues/7495</a> rely on optimizations that LLVM does but Cranelift doesn't do. I am guessing, however, that if the original source were C or Rust that when optimized and then run through both wasm runtimes the performance would be similar because LLVM's optimizations would kick in when producing the wasm. So overall my current conclusion is that Cranelift is missing optimizations, but it's intentional.</p>\n<p>Now a lot of what I'm saying above is merely conjecture. I haven't bottomed out the exact performance differences and what's going on where. It may very well be a small tweak to Cranelift fixes performance of these cases. That being said I'm personally having a difficult time analyzing this without a comparison of the original source code. So I'd ask again, I know that this is reduced and mutated from an original source program, but is it possible to get the source program and the list of mutations? </p>\n</blockquote>",
        "id": 401221802,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699557886
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1805109911\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>@alexcrichton Hi, the codes are generated by randomizing wasm bytecodes. Thank you for your efforts. I will get back to you later once I have new clues.</p>\n</blockquote>",
        "id": 401289893,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699593822
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492#issuecomment-1808573591\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7492\">issue #7492</a>:</p>\n<blockquote>\n<p>Ok if the original source + mutations aren't available then no worries.</p>\n<p>I'll again restate though that what I'm saying above is currently a hypothesis and isn't something I've been able to definitively prove. In the abstract though LLVM is expected to beat Cranelift when fed arbitrary code and there's only so much that we can do about that. Cranelift should be more competitive when fed LLVM-optimized wasm code, however.</p>\n</blockquote>",
        "id": 401808514,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1699894448
    }
]