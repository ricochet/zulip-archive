[
    {
        "content": "<p>elliottt opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a> from <code>elliottt:trevor/copy-callee-saves</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>Rework the tail calling convention on x64 to support tail calls by changing the complication strategy in the following ways:</p>\n<ol>\n<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>\n<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>\n<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>\n</ol>\n<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 429752675,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711493880
    },
    {
        "content": "<p><strong>elliottt</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429752677,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711493881
    },
    {
        "content": "<p><strong>elliottt</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429752678,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711493881
    },
    {
        "content": "<p>elliottt edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Rework the tail calling convention on x64 to support tail calls by changing the complication strategy in the following ways:</p>\n<ol>\n<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>\n<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>\n<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>\n</ol>\n<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>\n<p>Co-authored-by: Jamey Sharp &lt;<a href=\"mailto:jsharp@fastly.com\">jsharp@fastly.com</a>&gt;</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 429752751,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711493910
    },
    {
        "content": "<p>elliottt updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429755576,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711495549
    },
    {
        "content": "<p>elliottt edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Rework the tail calling convention on x64 to support tail calls by changing the complication strategy in the following ways:</p>\n<ol>\n<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>\n<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>\n<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>\n</ol>\n<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>\n<h2>TODO</h2>\n<ul>\n<li>[ ] Account for the extra space used by <code>GrowFrame</code> in the stack check</li>\n<li>[ ] Revisit the use of <code>r14</code> for the stack limit in the <code>Tail</code> calling convention</li>\n</ul>\n<p>Co-authored-by: Jamey Sharp &lt;<a href=\"mailto:jsharp@fastly.com\">jsharp@fastly.com</a>&gt;</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 429755781,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711495650
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2021657848\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @cfallin, @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"cranelift\", \"cranelift:area:aarch64\", \"cranelift:area:machinst\", \"cranelift:area:x64\", \"isle\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>cfallin: isle</li>\n<li>fitzgen: isle</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 429757399,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711496684
    },
    {
        "content": "<p>jameysharp submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1962018223\">PR review</a>:</p>\n<blockquote>\n<p>I'm proud of the work Trevor and I did on this!</p>\n<p>Here's a few quick comments edits after giving this another complete read-through.</p>\n</blockquote>",
        "id": 429763719,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711501209
    },
    {
        "content": "<p>jameysharp submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1962018223\">PR review</a>:</p>\n<blockquote>\n<p>I'm proud of the work Trevor and I did on this!</p>\n<p>Here's a few quick comments edits after giving this another complete read-through.</p>\n</blockquote>",
        "id": 429763721,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711501209
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1540287172\">PR review comment</a>:</p>\n<blockquote>\n<p>Nitpick:</p>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>            // pointer that are pushed on the stack already.\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 429763722,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711501209
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1540288801\">PR review comment</a>:</p>\n<blockquote>\n<p>After we wrote this we discovered the <code>fp_to_arg_offset</code> method which I now realize we could also use here instead of hard-coding 16. That might also be handy for generalizing this in shared code when we extend this work to other targets.</p>\n</blockquote>",
        "id": 429763723,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711501209
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1540286070\">PR review comment</a>:</p>\n<blockquote>\n<p>We should update this comment. I guess this will do:</p>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>        // Finally, do the actual tail call!\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 429763724,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711501209
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2021737866\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Also I see we have only one function in the precise-output compile filetests that exercises <code>grow_frame</code>, and none that exercise <code>shrink_frame</code>. I suppose we ought to extend the tests.</p>\n</blockquote>",
        "id": 429764015,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711501413
    },
    {
        "content": "<p>elliottt edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Rework the tail calling convention on x64 to support tail calls by changing the compilation strategy in the following ways:</p>\n<ol>\n<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>\n<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>\n<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>\n</ol>\n<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>\n<h2>TODO</h2>\n<ul>\n<li>[ ] Account for the extra space used by <code>GrowFrame</code> in the stack check</li>\n<li>[ ] Revisit the use of <code>r14</code> for the stack limit in the <code>Tail</code> calling convention</li>\n</ul>\n<p>Co-authored-by: Jamey Sharp &lt;<a href=\"mailto:jsharp@fastly.com\">jsharp@fastly.com</a>&gt;</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 429777225,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711511521
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2023006882\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Super excited for this! Going to start digging in.</p>\n<p>Concurrently, would you mind running the default sightglass suite with vs without this change (when enabling the wasm tail calls proposal for both) to determine if this fully resolves <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759\">https://github.com/bytecodealliance/wasmtime/issues/6759</a> ?</p>\n</blockquote>",
        "id": 429881921,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711551893
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2023020006\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<blockquote>\n<p>Concurrently, would you mind running the default sightglass suite with vs without this change (when enabling the wasm tail calls proposal for both) to determine if this fully resolves #6759 ?</p>\n</blockquote>\n<p>Or I guess the comparison we really care about is</p>\n<ul>\n<li><code>main</code> with default wasm features, versus</li>\n<li>this branch with wasm tail calls enabled</li>\n</ul>\n<p>This gives us the \"wasmtime\" vs \"tail\" calling conventions comparison we want.</p>\n</blockquote>",
        "id": 429883222,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711552236
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1963691200\">PR review</a>:</p>\n<blockquote>\n<p>Thanks!! Lots of nitpicks, but generally really like this.</p>\n<p>+1 to comment about more filetests and the lack of <code>shrink_frame</code> testing. Seems like it would be good to exercise the following cases, which it seems like we aren't already:</p>\n<ul>\n<li>tail call from a function with multiple stack args to a function with a single stack arg</li>\n<li>tail call from a function with multiple stack args to a function with zero stack args</li>\n<li>tail call from a function with a single stack arg to a function with multiple stack args</li>\n<li>tail call from a function with zero stack args to a function with multiple stack args</li>\n</ul>\n</blockquote>",
        "id": 429912035,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560437
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1963691200\">PR review</a>:</p>\n<blockquote>\n<p>Thanks!! Lots of nitpicks, but generally really like this.</p>\n<p>+1 to comment about more filetests and the lack of <code>shrink_frame</code> testing. Seems like it would be good to exercise the following cases, which it seems like we aren't already:</p>\n<ul>\n<li>tail call from a function with multiple stack args to a function with a single stack arg</li>\n<li>tail call from a function with multiple stack args to a function with zero stack args</li>\n<li>tail call from a function with a single stack arg to a function with multiple stack args</li>\n<li>tail call from a function with zero stack args to a function with multiple stack args</li>\n</ul>\n</blockquote>",
        "id": 429912037,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560437
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541338773\">PR review comment</a>:</p>\n<blockquote>\n<p>Is this doing more than just manipulating SP? I guess it also has to adjust FP and the return pointer to add more stack slots.</p>\n<p>As written, the docs make it sound like this is doing the full \"reconstruct the frame\" thing, but I thought (and maybe I've gotten lost given all the different sequencing versions we've talked about for this stuff) we were planning on avoiding that from now on?</p>\n<p>All this to say, I feel like the docs for this pseudo inst (and <code>ShrinkFrame</code> below) could be a bit more precise.</p>\n</blockquote>",
        "id": 429912038,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560437
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541478467\">PR review comment</a>:</p>\n<blockquote>\n<p>This does not include stack arguments right? I think it is worth noting that in the comment.</p>\n<p>(Sorry if these nitpicks on comments are too nitpicky. It's just that all this ABI code is so subtle and finicky and has to be Just Right, that I am constantly questioning everything, and if my questions aren't immediately answered in the comments I get really nervous that I am missing/overlooking something)</p>\n</blockquote>",
        "id": 429912039,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560437
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541471700\">PR review comment</a>:</p>\n<blockquote>\n<p>Has this <code>TODO</code> been addressed?</p>\n</blockquote>",
        "id": 429912040,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560437
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541497979\">PR review comment</a>:</p>\n<blockquote>\n<p>Ditto regarding naming here in <code>ShrinkFrame</code> as well.</p>\n</blockquote>",
        "id": 429912041,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541501124\">PR review comment</a>:</p>\n<blockquote>\n<p>Same suggestion on rewording this comment the way I suggested for the corresponding comment in <code>GrowFrame</code>.</p>\n</blockquote>",
        "id": 429912042,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541499323\">PR review comment</a>:</p>\n<blockquote>\n<p>Ditto regarding comment and whether args are included in the size and ditto regarding the hardcoding of <code>16</code> vs using <code>fp_to_arg_offset</code></p>\n</blockquote>",
        "id": 429912043,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541491277\">PR review comment</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>            // Copy the `i`th word in the stack from `SP + amount + i * 8`\n            // to `SP + i * 8`. Do this from lower to higher addresses to\n            // avoid clobbering words we haven't copied yet.\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 429912044,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541496385\">PR review comment</a>:</p>\n<blockquote>\n<p>I think this snippet of code would be easier to read if we didn't name the readable- and writable-GPR versions of <code>tmp</code> as <code>src</code> and <code>dst</code>. This is essentially doing <code>mov tmp, [SP + N]; move [SP + M], tmp</code> but that isn't obvious to me as a reader.</p>\n<p>If we renamed <code>src</code> to <code>readable_tmp</code> and <code>dst</code> to <code>writable_tmp</code> (or something, open to bikeshedding so long as it is clear they are naming the same register) I think this code would be much clearer, and that clarity is easily worth losing the struct literal field shorthand notation here.</p>\n</blockquote>",
        "id": 429912045,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541514612\">PR review comment</a>:</p>\n<blockquote>\n<p>Likewise about frame pointers being enabled.</p>\n</blockquote>",
        "id": 429912046,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541515746\">PR review comment</a>:</p>\n<blockquote>\n<p>FWIW, this is the kind of thing I'm referring to when I talk about diagrams being nice to have in <code>{Grow,Shrink}Frame</code>.</p>\n</blockquote>",
        "id": 429912047,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541508463\">PR review comment</a>:</p>\n<blockquote>\n<p>Is this going to break return calls on non-x64 until we get around to poring these architectures to the new tail call strategy? I don't think this PR should regress any existing functionality.</p>\n</blockquote>",
        "id": 429912049,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541523555\">PR review comment</a>:</p>\n<blockquote>\n<p>Can we document what base this is an offset from? SP right?</p>\n</blockquote>",
        "id": 429912050,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541518985\">PR review comment</a>:</p>\n<blockquote>\n<p>Nice.</p>\n</blockquote>",
        "id": 429912051,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541532980\">PR review comment</a>:</p>\n<blockquote>\n<p>Can we debug assert that we have frame pointers enabled here?</p>\n</blockquote>",
        "id": 429912052,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541511489\">PR review comment</a>:</p>\n<blockquote>\n<p>Can we debug assert that frame pointers are enabled here? Or guard this on frame pointers being enabled?</p>\n</blockquote>",
        "id": 429912053,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541537860\">PR review comment</a>:</p>\n<blockquote>\n<p>I guess the offset is either SP or FP depending on whether the call is a tail call or not? That is pretty subtle and seems relatively easy to mix up. Is there a reason we can't keep using <code>StackAMode</code> here? That would avoid mix ups because we would always have to match on the amode to determine whether we are dealing with SP or FP offsets. I think it would be fine to have <code>unreachable!()</code> arms in these matches if we always use SP for regular calls and FP for tail calls, but avoiding the mix-up footgun is nice.</p>\n</blockquote>",
        "id": 429912054,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541527824\">PR review comment</a>:</p>\n<blockquote>\n<p>(And presumably this change is because we don't need the full generality of <code>StackAMode</code> anymore?)</p>\n</blockquote>",
        "id": 429912055,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541480252\">PR review comment</a>:</p>\n<blockquote>\n<p>Diagrams of the stack frame, with labeled sections/slots, could help alleviate some of my fears/questions here. Y'all should know I'm a sucker for ASCII diagrams in comments by now :-p</p>\n</blockquote>",
        "id": 429912056,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541475431\">PR review comment</a>:</p>\n<blockquote>\n<p>+1 for using <code>fp_to_arg_offset</code> and avoiding the hard coding here (or at least consolidating the hard coding in that method).</p>\n</blockquote>",
        "id": 429912057,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560438
    },
    {
        "content": "<p>elliottt updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429912391,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711560554
    },
    {
        "content": "<p>jameysharp submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964041400\">PR review</a>.</p>",
        "id": 429917437,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711562291
    },
    {
        "content": "<p>jameysharp submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964041400\">PR review</a>.</p>",
        "id": 429917438,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711562291
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541574817\">PR review comment</a>:</p>\n<blockquote>\n<p>No. I haven't traced through enough to understand how we should influence the stack check yet.</p>\n</blockquote>",
        "id": 429917439,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711562291
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541573573\">PR review comment</a>:</p>\n<blockquote>\n<p><code>GrowFrame</code> does a memmove of everything in the frame except for the argument area, to make more room in the argument area. That includes all the stack slots, the callee-saved registers, and the saved FP and return address. To keep the stack pointers in sync with that change, it also subtracts the given amount from both the FP and SP registers. <code>ShrinkFrame</code> is the same but in the other direction.</p>\n<p>Ulrich's suggestion in today's Cranelift meeting that we allocate the maximum necessary space during the prologue instead lets us get rid of this memmove and only maybe have to move the return address, but we want to land this version first.</p>\n</blockquote>",
        "id": 429917440,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711562291
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541583490\">PR review comment</a>:</p>\n<blockquote>\n<p>We haven't removed the assert in <code>emit_return_call_common_sequence</code> that frame pointers are enabled, but yeah, we should add that in both <code>ShrinkFrame</code> and <code>GrowFrame</code> as well.</p>\n</blockquote>",
        "id": 429917441,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711562291
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541596873\">PR review comment</a>:</p>\n<blockquote>\n<p>This offset always describes the number of bytes into the argument area. Whether we find the argument area relative to FP or SP depends on how <code>gen_arg</code>'s caller is set up, not on ABI details. That's why we switched away from encoding that decision here.</p>\n</blockquote>",
        "id": 429917442,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711562291
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541560935\">PR review comment</a>:</p>\n<blockquote>\n<p>Nope, we're using <code>Call</code> instead of <code>ReturnCall</code> here specifically to avoid breaking aarch64 and riscv64 until we can get around to applying similar changes to them. <code>from_func</code> was always using <code>Call</code> for the opcode before so passing that here now doesn't change what data structures that function constructs, and then we rely on the distinction in the new <code>is_tail_call</code> helper to ensure that the generated code isn't changed.</p>\n</blockquote>",
        "id": 429917443,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711562291
    },
    {
        "content": "<p>elliottt updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429927190,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711565874
    },
    {
        "content": "<p>elliottt updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429927343,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711565917
    },
    {
        "content": "<p>jameysharp submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964650889\">PR review</a>.</p>",
        "id": 429938844,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711570245
    },
    {
        "content": "<p>jameysharp created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1541965387\">PR review comment</a>:</p>\n<blockquote>\n<p>On all targets, the stack limit check is based solely on <code>stackslots_size</code> plus the number of spillslots. (And spillslots are always word-sized, I see, which I'm confused about, but that's not the point right now.)</p>\n<p>As far as I can tell, this means the stack limit check never accounts for the size of a callee's argument or setup areas. So I guess we don't need to worry about it for tail calls either?</p>\n</blockquote>",
        "id": 429938845,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711570245
    },
    {
        "content": "<p>elliottt edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Rework the tail calling convention on x64 to support tail calls by changing the compilation strategy in the following ways:</p>\n<ol>\n<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>\n<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>\n<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>\n</ol>\n<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>\n<h2>TODO</h2>\n<ul>\n<li>[ ] Account for the extra space used by <code>GrowFrame</code> in the stack check</li>\n<li>[x] Revisit the use of <code>r14</code> for the stack limit in the <code>Tail</code> calling convention</li>\n</ul>\n<p>Co-authored-by: Jamey Sharp &lt;<a href=\"mailto:jsharp@fastly.com\">jsharp@fastly.com</a>&gt;</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 429940563,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711570778
    },
    {
        "content": "<p>elliottt updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429943883,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711571703
    },
    {
        "content": "<p>elliottt submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964749647\">PR review</a>.</p>",
        "id": 429947581,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711572836
    },
    {
        "content": "<p>elliottt created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1542030491\">PR review comment</a>:</p>\n<blockquote>\n<p>I went with <code>tmp</code> and <code>tmp_w</code> like we had in the previous implementation <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> </p>\n</blockquote>",
        "id": 429947584,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711572837
    },
    {
        "content": "<p>elliottt updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429948397,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711573159
    },
    {
        "content": "<p>elliottt updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429958913,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711578153
    },
    {
        "content": "<p>elliottt updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429961885,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711579766
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964909352\">PR review</a>:</p>\n<blockquote>\n<p>Looks great! Thanks! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n<p>Excited for the benchmark results!</p>\n</blockquote>",
        "id": 429964743,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711581391
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1542142486\">PR review comment</a>:</p>\n<blockquote>\n<p>Nice, thanks for these tests.</p>\n</blockquote>",
        "id": 429964744,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711581391
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#pullrequestreview-1964909352\">PR review</a>:</p>\n<blockquote>\n<p>Looks great! Thanks! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n<p>Excited for the benchmark results!</p>\n</blockquote>",
        "id": 429964745,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711581391
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#discussion_r1542140114\">PR review comment</a>:</p>\n<blockquote>\n<p>These comments are fantastic -- thanks!</p>\n</blockquote>",
        "id": 429964746,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711581391
    },
    {
        "content": "<p>elliottt <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2024139787\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Here are the execution benchmarks for <code>spidermonkey</code>, <code>bz2</code>, and <code>pulldown-cmark</code> relative to the current tail calls implementation on main:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">204255214.50</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">513219.80</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.08</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.08</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">2862185961</span><span class=\"w\"> </span><span class=\"mf\">2862312218.75</span><span class=\"w\"> </span><span class=\"mi\">2862598037</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">2657985419</span><span class=\"w\"> </span><span class=\"mf\">2658057004.25</span><span class=\"w\"> </span><span class=\"mi\">2658128352</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">13264568.75</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">1.43</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.06</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.06</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">239534828</span><span class=\"w\"> </span><span class=\"mf\">239534828.25</span><span class=\"w\"> </span><span class=\"mi\">239534829</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">226270259</span><span class=\"w\"> </span><span class=\"mf\">226270259.50</span><span class=\"w\"> </span><span class=\"mi\">226270260</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">391358.50</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">894.30</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.02</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.02</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">20465937</span><span class=\"w\"> </span><span class=\"mf\">20466114.00</span><span class=\"w\"> </span><span class=\"mi\">20466584</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">20074442</span><span class=\"w\"> </span><span class=\"mf\">20074755.50</span><span class=\"w\"> </span><span class=\"mi\">20075106</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>Running the same benchmarks on main without tail calls and this branch with tail calls separately, yields the following results:</p>\n<h3>main</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">226286674</span><span class=\"w\"> </span><span class=\"mf\">226286674.00</span><span class=\"w\"> </span><span class=\"mi\">226286674</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">trevor</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">20080325</span><span class=\"w\"> </span><span class=\"mf\">20080512.75</span><span class=\"w\"> </span><span class=\"mi\">20080999</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">trevor</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">2659583881</span><span class=\"w\"> </span><span class=\"mf\">2659624337.75</span><span class=\"w\"> </span><span class=\"mi\">2659672231</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">trevor</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<h3>this branch</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">226270259</span><span class=\"w\"> </span><span class=\"mf\">226270259.50</span><span class=\"w\"> </span><span class=\"mi\">226270260</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">trevor</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">20074405</span><span class=\"w\"> </span><span class=\"mf\">20074419.00</span><span class=\"w\"> </span><span class=\"mi\">20074445</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">trevor</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">    </span><span class=\"n\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"mi\">2657979471</span><span class=\"w\"> </span><span class=\"mf\">2658099662.50</span><span class=\"w\"> </span><span class=\"mi\">2658220755</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">trevor</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">tail</span><span class=\"o\">-</span><span class=\"n\">calls</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>It's exciting to see that the max for the tail-calls branch is smaller than the min of main for spidermonkey, though even if that's spurious they're still in the same ballpark <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n</blockquote>",
        "id": 429964933,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711581492
    },
    {
        "content": "<p>jameysharp edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Rework the tail calling convention on x64 to support tail calls by changing the compilation strategy in the following ways:</p>\n<ol>\n<li>Instead of making a shadow frame that we copy over the old one, instead determine if we need to grow or shrink the stack argument area and emit a special-purpose instruction to handle that case.</li>\n<li>As we're now growing and shrinking the frame in a separate instruction sequence, emit arguments as moving to FP offsets instead of SP offsets, placing them where they'll need to go for the tail call being setup.</li>\n<li>Finally, when emitting a <code>Inst::ReturnCall</code> in the x64 backend, reuse the <code>gen_clobber_save</code> and <code>gen_epilogue_frame_restore</code> functions to setup the frame and any callee-saved registers to the state expected by the callee we're jumping to.</li>\n</ol>\n<p>With these three changes in place, we modified the x64 abi for tail calls to include a list of callee-saved registers, and observed that we now save them in the prologue, and restore them right before jumping to the tail-callee.</p>\n<h2>TODO</h2>\n<ul>\n<li>[x] Account for the extra space used by <code>GrowFrame</code> in the stack check</li>\n<li>[x] Revisit the use of <code>r14</code> for the stack limit in the <code>Tail</code> calling convention</li>\n</ul>\n<p>Co-authored-by: Jamey Sharp &lt;<a href=\"mailto:jsharp@fastly.com\">jsharp@fastly.com</a>&gt;</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 429965054,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711581584
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246#issuecomment-2024144099\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>:</p>\n<blockquote>\n<p>Ship it!</p>\n</blockquote>",
        "id": 429965284,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711581725
    },
    {
        "content": "<p>elliottt merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8246\">PR #8246</a>.</p>",
        "id": 429967949,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711583419
    }
]