[
    {
        "content": "<p>fitzgen opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759\">issue #6759</a>:</p>\n<blockquote>\n<p>That is, regular calls with the <code>tail</code> calling convention should be as fast as regular calls with the <code>fast</code> calling convention.</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771\">https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771</a></p>\n<blockquote>\n<p>So @jameysharp and I did a little profiling/investigation of switching the internal Wasm calling convention over to tail on our sightglass benchmarks. I was really expecting this to have no measurable change, but unfortunately it looks like it has a ~7% overhead on bz2 and spidermonkey.wasm and ~1% overhead on pulldown-cmark. This is surprising! We think this means that we ~frequently call functions that don't have enough register pressure to clobber all callee-save registers, and since tail only has caller-save registers and zero callee-save registers, we are doing more spills than we used to. Enough more that it is really measurable.</p>\n</blockquote>\n<p>Here are the histograms of number of clobbered callee-save registers in a function for some of our benchmarks:</p>\n<p>&lt;details&gt;</p>\n<h3>pulldown-cmark</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">757</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.9682959048877162</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4428038716280174</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.967290755240832</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">9</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">459</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">298</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>spidermonkey</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">18279</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.8119153126538674</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4034432514706436</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.77653946303978</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">233</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">11655</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">6624</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>bz2</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">127</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.5511811023622047</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.5659198268780583</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.452104904209808</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">113</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>I think we just need to support callee-save registers in the <code>tail</code> calling convention. For simplicity, we can probably just match sys-v / the default native calling convention. A little unfortunate, as it means that chains of tail calls will be saving and restoring callee-save registers that the next function isn't going to use (won't be used again till the chain completes) but we definitely can't pessimize regular calls for the sake of tail call chains.</p>\n</blockquote>",
        "id": 377393306,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689964117
    },
    {
        "content": "<p><a href=\"https://github.com/fitzgen\">fitzgen</a> added the <a href=\"https://api.github.com/repos/bytecodealliance/wasmtime/labels/cranelift\">cranelift</a> label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759\">Issue #6759</a>.</p>",
        "id": 377393308,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689964117
    },
    {
        "content": "<p><a href=\"https://github.com/fitzgen\">fitzgen</a> added the <a href=\"https://api.github.com/repos/bytecodealliance/wasmtime/labels/cranelift:goal:optimize-speed\">cranelift:goal:optimize-speed</a> label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759\">Issue #6759</a>.</p>",
        "id": 377393309,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689964117
    },
    {
        "content": "<p>fitzgen edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759\">issue #6759</a>:</p>\n<blockquote>\n<p>That is, regular calls with the <code>tail</code> calling convention should be as fast as regular calls with the <code>fast</code> calling convention.</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771\">https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771</a></p>\n<blockquote>\n<p>So @jameysharp and I did a little profiling/investigation of switching the internal Wasm calling convention over to tail on our sightglass benchmarks. I was really expecting this to have no measurable change, but unfortunately it looks like it has a ~7% overhead on bz2 and spidermonkey.wasm and ~1% overhead on pulldown-cmark. This is surprising! We think this means that we ~frequently call functions that don't have enough register pressure to clobber all callee-save registers, and since tail only has caller-save registers and zero callee-save registers, we are doing more spills than we used to. Enough more that it is really measurable.</p>\n</blockquote>\n<p>Here are the histograms of number of clobbered callee-save registers in a function for some of our benchmarks:</p>\n<p>&lt;details&gt;</p>\n<h3>pulldown-cmark</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">757</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.9682959048877162</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4428038716280174</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.967290755240832</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">9</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">459</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">298</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>spidermonkey</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">18279</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.8119153126538674</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4034432514706436</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.77653946303978</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">233</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">11655</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">6624</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>bz2</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">127</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.5511811023622047</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.5659198268780583</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.452104904209808</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">113</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>I think we just need to support callee-save registers in the <code>tail</code> calling convention. For simplicity, we can probably just match sys-v / the default native calling convention. A little unfortunate, as it means that chains of tail calls will be saving and restoring callee-save registers that the next function isn't going to use (won't be used again till the chain completes) but we definitely can't pessimize regular calls for the sake of tail call chains.<br>\n```[tasklist]</p>\n<h3>Tasks</h3>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~~~</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 377397803,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689965150
    },
    {
        "content": "<p>fitzgen edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759\">issue #6759</a>:</p>\n<blockquote>\n<p>That is, regular calls with the <code>tail</code> calling convention should be as fast as regular calls with the <code>fast</code> calling convention.</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771\">https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771</a></p>\n<blockquote>\n<p>So @jameysharp and I did a little profiling/investigation of switching the internal Wasm calling convention over to tail on our sightglass benchmarks. I was really expecting this to have no measurable change, but unfortunately it looks like it has a ~7% overhead on bz2 and spidermonkey.wasm and ~1% overhead on pulldown-cmark. This is surprising! We think this means that we ~frequently call functions that don't have enough register pressure to clobber all callee-save registers, and since tail only has caller-save registers and zero callee-save registers, we are doing more spills than we used to. Enough more that it is really measurable.</p>\n</blockquote>\n<p>Here are the histograms of number of clobbered callee-save registers in a function for some of our benchmarks:</p>\n<p>&lt;details&gt;</p>\n<h3>pulldown-cmark</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">757</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.9682959048877162</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4428038716280174</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.967290755240832</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">9</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">459</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">298</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>spidermonkey</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">18279</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.8119153126538674</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4034432514706436</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.77653946303978</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">233</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">11655</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">6624</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>bz2</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">127</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.5511811023622047</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.5659198268780583</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.452104904209808</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">113</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>I think we just need to support callee-save registers in the <code>tail</code> calling convention. For simplicity, we can probably just match sys-v / the default native calling convention. A little unfortunate, as it means that chains of tail calls will be saving and restoring callee-save registers that the next function isn't going to use (won't be used again till the chain completes) but we definitely can't pessimize regular calls for the sake of tail call chains.</p>\n</blockquote>",
        "id": 377397839,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689965161
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759\">issue #6759</a>:</p>\n<blockquote>\n<p>That is, regular calls with the <code>tail</code> calling convention should be as fast as regular calls with the <code>fast</code> calling convention.</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771\">https://github.com/bytecodealliance/wasmtime/issues/1065#issuecomment-1624395771</a></p>\n<blockquote>\n<p>So @jameysharp and I did a little profiling/investigation of switching the internal Wasm calling convention over to tail on our sightglass benchmarks. I was really expecting this to have no measurable change, but unfortunately it looks like it has a ~7% overhead on bz2 and spidermonkey.wasm and ~1% overhead on pulldown-cmark. This is surprising! We think this means that we ~frequently call functions that don't have enough register pressure to clobber all callee-save registers, and since tail only has caller-save registers and zero callee-save registers, we are doing more spills than we used to. Enough more that it is really measurable.</p>\n</blockquote>\n<p>Here are the histograms of number of clobbered callee-save registers in a function for some of our benchmarks:</p>\n<p>&lt;details&gt;</p>\n<h3>pulldown-cmark</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">757</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.9682959048877162</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4428038716280174</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.967290755240832</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">9</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">459</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">298</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>spidermonkey</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">18279</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.8119153126538674</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.4034432514706436</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">5.77653946303978</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">233</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">11655</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">6624</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">     </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<h3>bz2</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">samples</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">127</span>\n#<span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n#<span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Mean</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.5511811023622047</span>\n#<span class=\"w\"> </span><span class=\"n\">Standard</span><span class=\"w\"> </span><span class=\"n\">deviation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1.5659198268780583</span>\n#<span class=\"w\"> </span><span class=\"n\">Variance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2.452104904209808</span>\n#\n#<span class=\"w\"> </span><span class=\"n\">Each</span><span class=\"w\"> </span><span class=\"err\">∎</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n#\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">113</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"p\">]</span>: <span class=\"err\">∎∎∎∎∎∎∎</span>\n<span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n <span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">]</span>:\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>I think we just need to support callee-save registers in the <code>tail</code> calling convention. For simplicity, we can probably just match sys-v / the default native calling convention. A little unfortunate, as it means that chains of tail calls will be saving and restoring callee-save registers that the next function isn't going to use (won't be used again till the chain completes) but we definitely can't pessimize regular calls for the sake of tail call chains.</p>\n</blockquote>",
        "id": 437914046,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715307312
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759#issuecomment-2103726369\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6759\">issue #6759</a>:</p>\n<blockquote>\n<p>I believe that this is done now, so closing.</p>\n</blockquote>",
        "id": 437914047,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715307312
    }
]