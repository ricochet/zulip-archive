[
    {
        "content": "<p><strong>juamedgod</strong> requested <a href=\"https://github.com/jameysharp\">jameysharp</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6348\">PR #6348</a>.</p>",
        "id": 356110774,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683303950
    },
    {
        "content": "<p><strong>juamedgod</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6348\">PR #6348</a>.</p>",
        "id": 356110776,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683303950
    },
    {
        "content": "<p>juamedgod opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6348\">PR #6348</a> from <code>juamedgod:windows-opendir-fix</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<h3>Description</h3>\n<p>We were testing the new wasmtime 8.0.1 on Windows and are getting \"Permission denied\" errors opening directories, while reading files under those directories work fine.</p>\n<h3>Test Case</h3>\n<p>The issue is reproducible using the below rust program (built as lister.wasm in the snippets) that directly calls opendir:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"w\"> </span><span class=\"n\">libc</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">ffi</span>::<span class=\"n\">CString</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">libc</span>::<span class=\"p\">{</span><span class=\"n\">opendir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closedir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">c_char</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">env</span><span class=\"p\">;</span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">args</span>: <span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"nb\">String</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">env</span>::<span class=\"n\">args</span><span class=\"p\">().</span><span class=\"n\">collect</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Usage: listdir &lt;directory&gt;\"</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">dir_name_cstring</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">CString</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">].</span><span class=\"n\">clone</span><span class=\"p\">()).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">dir_ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">opendir</span><span class=\"p\">(</span><span class=\"n\">dir_name_cstring</span><span class=\"p\">.</span><span class=\"n\">as_ptr</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">c_char</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">dir_ptr</span><span class=\"p\">.</span><span class=\"n\">is_null</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Error opening directory\"</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">closedir</span><span class=\"p\">(</span><span class=\"n\">dir_ptr</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Opening directory worked\"</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Steps to Reproduce</h3>\n<p>Build a wasm module using the test case snippet, and invoke it pointing to a directory using wasmtime-8.0.1 on Windows:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">c</span>:<span class=\"err\">\\</span><span class=\"n\">tests</span><span class=\"err\">\\</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">v8</span><span class=\"p\">.</span><span class=\"mf\">0.1</span><span class=\"o\">-</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">windows</span><span class=\"err\">\\</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">mapdir</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">app</span>::<span class=\"n\">c</span>:<span class=\"o\">/</span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">c</span>:<span class=\"err\">\\</span><span class=\"n\">tests</span><span class=\"err\">\\</span><span class=\"n\">lister</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">app</span>\n<span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">opening</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n</code></pre></div>\n<p>The same command works when using 8.0.0:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">c</span>:<span class=\"err\">\\</span><span class=\"n\">tests</span><span class=\"err\">\\</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">v8</span><span class=\"p\">.</span><span class=\"mf\">0.0</span><span class=\"o\">-</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">windows</span><span class=\"err\">\\</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">mapdir</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">app</span>::<span class=\"n\">c</span>:<span class=\"o\">/</span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">c</span>:<span class=\"err\">\\</span><span class=\"n\">tests</span><span class=\"err\">\\</span><span class=\"n\">lister</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">app</span>\n<span class=\"n\">Opening</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"n\">worked</span>\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasmtime 8.0.1<br>\nOperating system: Windows 10<br>\nArchitecture: x86_64</p>\n<h3>Extra details</h3>\n<p>The bug seems to be related to the changes in #6163. The code is failing here:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-common/cap-std-sync/src/dir.rs#L93\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-common/cap-std-sync/src/dir.rs#L93</a></p>\n<p>Which was not previously applied to directories. That results on the directory being reopened which ends up calling Windows ReOpenFile, and that returns a \"Access denied\".</p>\n<p>We have \"fixed\" the issue by moving the code to be executed only for files, but that may not be the best solution. It would be great of you could give us some tips if that is not the proper solution to improve the patch.<br>\n</p>\n</blockquote>",
        "id": 356110777,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683303950
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6348#pullrequestreview-1415131681\">PR review</a>:</p>\n<blockquote>\n<p>Thank you for finding and fixing this bug!</p>\n</blockquote>",
        "id": 356117592,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683305622
    },
    {
        "content": "<p>jameysharp submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6348#pullrequestreview-1417165254\">PR review</a>:</p>\n<blockquote>\n<p>This fix makes sense, and thank you for the new tests as well!</p>\n</blockquote>",
        "id": 356767265,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683565279
    },
    {
        "content": "<p>jameysharp merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6348\">PR #6348</a>.</p>",
        "id": 356775876,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683567619
    }
]