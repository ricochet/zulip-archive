[
    {
        "content": "<p><a href=\"https://github.com/jameysharp\">jameysharp</a> added the cranelift label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8197\">Issue #8197</a>.</p>",
        "id": 428014622,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1710968353
    },
    {
        "content": "<p><a href=\"https://github.com/jameysharp\">jameysharp</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8197\">Issue #8197</a>.</p>",
        "id": 428014623,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1710968354
    },
    {
        "content": "<p>jameysharp opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8197\">issue #8197</a>:</p>\n<blockquote>\n<h3><code>.clif</code> Test Case</h3>\n<p>Wasmtime currently translates this WebAssembly module:</p>\n<div class=\"codehilite\" data-code-language=\"Common Lisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nv\">module</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nv\">$fn</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">result</span><span class=\"w\"> </span><span class=\"nv\">i32</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"nv\">table</span><span class=\"w\"> </span><span class=\"nv\">$fnptrs</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"nv\">funcref</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"nv\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">param</span><span class=\"w\"> </span><span class=\"nv\">i32</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"nb\">loop</span>\n<span class=\"w\">          </span><span class=\"nv\">local.get</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">          </span><span class=\"nv\">call_indirect</span><span class=\"w\"> </span><span class=\"nv\">$fnptrs</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nv\">$fn</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"nv\">br</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"nv\">end</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>To this CLIF, before optimization:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span>:<span class=\"mi\">0</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">vmctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">gv0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vmctx</span>\n<span class=\"w\">    </span><span class=\"n\">gv1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">gv0</span><span class=\"o\">+</span><span class=\"mi\">8</span>\n<span class=\"w\">    </span><span class=\"n\">gv2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">gv1</span>\n<span class=\"w\">    </span><span class=\"n\">gv3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vmctx</span>\n<span class=\"w\">    </span><span class=\"n\">gv4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">gv3</span><span class=\"o\">+</span><span class=\"mi\">72</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">vmctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i32</span> <span class=\"nc\">fast</span>\n<span class=\"w\">    </span><span class=\"n\">sig1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">vmctx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">uext</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">uext</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i64</span> <span class=\"nc\">system_v</span>\n<span class=\"w\">    </span><span class=\"n\">stack_limit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">gv2</span>\n\n<span class=\"w\">                                </span><span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span>: <span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span>: <span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span>: <span class=\"kt\">i32</span><span class=\"p\">)</span>:\n                                    <span class=\"nc\">v3</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v2</span>\n<span class=\"w\">                                    </span><span class=\"n\">v28</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">v3</span>\n<span class=\"o\">@</span><span class=\"mi\">0027</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block2</span>\n\n<span class=\"w\">                                </span><span class=\"n\">block2</span>:\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">uge</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">uextend</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">v3</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">global_value</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">gv4</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ishl_imm</span><span class=\"w\"> </span><span class=\"n\">v6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v9</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"w\"> </span><span class=\"n\">v7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v8</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v11</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">select_spectre_guard</span><span class=\"w\"> </span><span class=\"n\">v5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v9</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v12</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">table_oob</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">table</span><span class=\"w\"> </span><span class=\"n\">v11</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v13</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band_imm</span><span class=\"w\"> </span><span class=\"n\">v12</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">2</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">brif</span><span class=\"w\"> </span><span class=\"n\">v12</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block5</span><span class=\"p\">(</span><span class=\"n\">v13</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">block4</span>\n\n<span class=\"w\">                                </span><span class=\"n\">block4</span><span class=\"w\"> </span><span class=\"n\">cold</span>:\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v16</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">global_value</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">gv3</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v17</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">v16</span><span class=\"o\">+</span><span class=\"mi\">56</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v18</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">v17</span><span class=\"o\">+</span><span class=\"mi\">72</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v19</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">call_indirect</span><span class=\"w\"> </span><span class=\"n\">sig1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v18</span><span class=\"p\">(</span><span class=\"n\">v16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">v15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block5</span><span class=\"p\">(</span><span class=\"n\">v19</span><span class=\"p\">)</span>\n\n<span class=\"w\">                                </span><span class=\"n\">block5</span><span class=\"p\">(</span><span class=\"n\">v14</span>: <span class=\"kt\">i64</span><span class=\"p\">)</span>:\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v20</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">global_value</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">gv3</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v21</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">v20</span><span class=\"o\">+</span><span class=\"mi\">64</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v22</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">v21</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v23</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">icall_null</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"o\">+</span><span class=\"mi\">24</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v24</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"n\">v23</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v22</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">trapz</span><span class=\"w\"> </span><span class=\"n\">v24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bad_sig</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v25</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"o\">+</span><span class=\"mi\">16</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v26</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"p\">.</span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"n\">notrap</span><span class=\"w\"> </span><span class=\"n\">aligned</span><span class=\"w\"> </span><span class=\"n\">readonly</span><span class=\"w\"> </span><span class=\"n\">v14</span><span class=\"o\">+</span><span class=\"mi\">32</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">b</span><span class=\"w\">                               </span><span class=\"n\">v27</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">call_indirect</span><span class=\"w\"> </span><span class=\"n\">sig0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v25</span><span class=\"p\">(</span><span class=\"n\">v26</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">)</span>\n<span class=\"o\">@</span><span class=\"mi\">002</span><span class=\"n\">e</span><span class=\"w\">                               </span><span class=\"n\">jump</span><span class=\"w\"> </span><span class=\"n\">block2</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Steps to Reproduce</h3>\n<p>Optimize this CLIF with the egraph pass enabled using <code>opt_level=speed</code>.</p>\n<h3>Expected Results</h3>\n<p>I think the loads of <code>v17</code> and <code>v18</code> should stay in the <code>cold</code> block.</p>\n<h3>Actual Results</h3>\n<p>The loads of <code>v17</code> and <code>v18</code> are hoisted to the entry block, since they have the <code>notrap</code> and <code>readonly</code> flags set and depend only on the vmctx parameter, <code>v0</code>.</p>\n<h3>Versions and Environment</h3>\n<p>Cranelift version or commit: tested on afaf1c73f67c42e638590608579b2b02c7f65ca3</p>\n<h3>Extra Info</h3>\n<p>This is not a correctness bug but might be a performance problem. I haven't measured it, just noticed it while looking at the CLIF that Wasmtime currently generates for <code>call_indirect</code>.</p>\n<p>cc: @cfallin</p>\n</blockquote>",
        "id": 428014630,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1710968355
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8197#issuecomment-2016582642\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8197\">issue #8197</a>:</p>\n<blockquote>\n<p>I suppose we could add a(nother) special case to the block-placement logic, where LICM etc is implemented: if the original block is cold, keep the op in the same block. That's probably limited in scope enough that it's both (i) tractable and (ii) shouldn't have unforeseen impacts?</p>\n</blockquote>",
        "id": 429108184,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1711222161
    }
]