[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>Currently the set of CLI flags added to Wasmtime has been ad-hoc and generally \"throw another option in there\" style historically, which is great for easily adding new options (which happens a fair bit), but I  personally feel like there have been some growing pains that may be worthwhile to address sooner rather than later. </p>\n<p>Some concerns I have with the current CLI are:</p>\n<ul>\n<li>Discoverability is hard right now as <code>--help</code> or <code> -h</code> prints out quite a lot of information.</li>\n<li>Not a lot of single-letter flags are in use so CLI commands tend to be quite long</li>\n<li>It's tough to review \"at a glance\" what Wasmtime's capabilities are on the CLI through the help page since there's so much to sift through</li>\n<li>Some options have little papercuts like trying to remember <code>--dir</code> vs <code>--mapdir</code>, there's no way to inherit the caller's environment or a single env var from the environment easily, etc.</li>\n<li>Options can be randomly <code>--disable-foo</code> or <code>--enable-foo</code> and it's not clear why which is which when you're approaching the CLI for the first time.</li>\n</ul>\n<p>To be clear none of these are dealbreakers by any means. While I think the Wasmtime CLI is important the embedding API are where things \"get serious\" so it's ok for the CLI to not be perfect. That being said folks often interact with Wasmtime through the CLI to start off with and it's also mega-useful during development and debugging and such.</p>\n<p>So given all the above I'd like to propose a (hopefully) brief bikeshed about the Wasmtime CLI. I'd like to ideally address the above concerns and provide guidelines of how to add new options into the future. This will hopefully clean up our CLI, make it a bit more ergonomic to use, all while not hindering our ability to easily add various knobs here and there as they're implemented.</p>\n<p>At a high level my proposal is \"let's do what <code>rustc</code> does\". I'm very biased in that regard as I helped design rustc's CLI as well. Some things I like about rustc though are:</p>\n<ul>\n<li>The output of <code>rustc -h</code> fits more-or-less on one terminal. This serves as a good index from which you can learn more.</li>\n<li>There are \"option groups\" that are behind other flags, such as <code>rustc -C foo</code> or <code>rustc -Z foo</code>. These single-letter capital flags are easy to type and easy to remember and serve as a good place to house sub-options.</li>\n<li>More information can be read through <code>rustc -C help</code> which provides an window into all the codegen capabilities of rustc</li>\n<li>Instead of <code>--enable-foo</code> or <code>--disable-foo</code> most rustc options are <code>-C foo</code> for <code>--enable-foo</code> or <code>-C foo=no</code> for <code>--disable-foo</code>. This makes it easy for callers to forcibly enable/disable something and you don't have to worry about what the defaults are since as a user you typically want to turn something on or off and you don't care too much about whatever the default happens to be.</li>\n</ul>\n<p>My proposal here for Wasmtime's option groups are:</p>\n<h3>Codegen options (<code>-C</code> or <code>--codegen</code>)</h3>\n<ul>\n<li>All <code>--disable-foo</code> flags become <code>-C foo=no</code></li>\n<li>All <code>--enable-foo</code> flags become <code>-C foo</code></li>\n<li><code>-C foo</code> is shorthand for <code>-C foo=yes</code></li>\n<li><code>*=yes</code> can support <code>y</code>, <code>yes</code>, <code>true</code>, etc</li>\n<li><code>*=no</code> can support <code>n</code>, <code>no</code>, <code>false</code>, etc</li>\n<li>\n<p>Non-boolean flags support <code>-C name=val</code> where <code>val</code> is parsed as whatever<br>\n<code>name</code> wants.</p>\n</li>\n<li>\n<p>Can support comma-separation as well such as <code>-C foo,bar</code> or <code>-C foo=n,bar</code></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>old cli flag</th>\n<th>new cli flag</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--compiler &lt;COMPILER&gt;</code></td>\n<td><code>-C compiler=..</code></td>\n</tr>\n<tr>\n<td><code>-O, --optimize</code></td>\n<td><code>-C opt-level=N</code> / <code>-O</code></td>\n</tr>\n<tr>\n<td><code>--opt-level &lt;LEVEL&gt;</code></td>\n<td><code>-C opt-level=N</code></td>\n</tr>\n<tr>\n<td><code>--config &lt;CONFIG_PATH&gt;</code></td>\n<td><code>-C cache-config=..</code></td>\n</tr>\n<tr>\n<td><code>--disable-address-map</code></td>\n<td><code>-C address-map=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-cache</code></td>\n<td><code>-C cache=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-parallel-compilation</code></td>\n<td><code>-C parallel-compilation=no</code></td>\n</tr>\n<tr>\n<td><code>--epoch-interruption</code></td>\n<td><code>-C epoch-interruption</code></td>\n</tr>\n<tr>\n<td><code>-g</code></td>\n<td><code>-C debuginfo</code> / <code>-g</code></td>\n</tr>\n<tr>\n<td><code>--dynamic-memory-guard-size &lt;SIZE&gt;</code></td>\n<td><code>-C dynamic-memory-guard-size=...</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-forced</code></td>\n<td><code>-C static-memory-forced</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-guard-size &lt;SIZE&gt;</code></td>\n<td><code>-C static-memory-guard-size=N</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-maximum-size &lt;MAXIMUM&gt;</code></td>\n<td><code>-C static-memory-maximum-size=N</code></td>\n</tr>\n<tr>\n<td><code>--relaxed-simd-deterministic</code></td>\n<td><code>-C relaxed-simd-deterministic</code></td>\n</tr>\n<tr>\n<td><code>--cranelift-enable &lt;SETTING&gt;</code></td>\n<td><code>-C cranelift-NAME</code></td>\n</tr>\n<tr>\n<td><code>--enable-cranelift-debug-verifier</code></td>\n<td><code>-C cranelift-debug-verifier</code></td>\n</tr>\n<tr>\n<td><code>--enable-cranelift-nan-canonicalization</code></td>\n<td><code>-C cranelift-nan-canonicalization</code></td>\n</tr>\n<tr>\n<td><code>--cranelift-set &lt;NAME=VALUE&gt;</code></td>\n<td><code>-C cranelift-NAME=VALUE</code></td>\n</tr>\n</tbody>\n</table>\n<h3>Runtime options (<code>-R</code> or <code>--runtime</code>)</h3>\n<ul>\n<li>Various <code>*-unknown-*</code> options are all <code>-R unknown-*</code> now.</li>\n<li>Same system for boolean flags as <code>-C</code> options</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>old cli flag</th>\n<th>new cli flag</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--allow-unknown-exports</code></td>\n<td><code>-R unknown-exports-allow</code></td>\n</tr>\n<tr>\n<td><code>--trap-unknown-imports</code></td>\n<td><code>-R unknown-imports-trap</code></td>\n</tr>\n<tr>\n<td><code>--default-values-unknown-imports</code></td>\n<td><code>-R unknown-imports-default</code></td>\n</tr>\n<tr>\n<td><code>--coredump-on-trap &lt;PATH&gt;</code></td>\n<td><code>-R coredump=..</code></td>\n</tr>\n<tr>\n<td><code>--disable-logging</code></td>\n<td><code>-R logging=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-memory-init-cow</code></td>\n<td><code>-R memory-init-cow=no</code></td>\n</tr>\n<tr>\n<td><code>--dynamic-memory-reserved-for-growth &lt;SIZE&gt;</code></td>\n<td><code>-R dynamic-memory-reserved-for-growth=...</code></td>\n</tr>\n<tr>\n<td><code>--fuel &lt;N&gt;</code></td>\n<td><code>-R fuel=N</code></td>\n</tr>\n<tr>\n<td><code>--log-to-files</code></td>\n<td><code>-R log-to-files</code></td>\n</tr>\n<tr>\n<td><code>--max-instances &lt;MAX_INSTANCES&gt;</code></td>\n<td><code>-R max-instances=N</code></td>\n</tr>\n<tr>\n<td><code>--max-memories &lt;MAX_MEMORIES&gt;</code></td>\n<td><code>-R max-memories=N</code></td>\n</tr>\n<tr>\n<td><code>--max-memory-size &lt;BYTES&gt;</code></td>\n<td><code>-R max-memory-size=N</code></td>\n</tr>\n<tr>\n<td><code>--max-table-elements &lt;MAX_TABLE_ELEMENTS&gt;</code></td>\n<td><code>-R max-table-elements=N</code></td>\n</tr>\n<tr>\n<td><code>--max-tables &lt;MAX_TABLES&gt;</code></td>\n<td><code>-R max-tables=N</code></td>\n</tr>\n<tr>\n<td><code>--max-wasm-stack &lt;MAX_WASM_STACK&gt;</code></td>\n<td><code>-R max-wasm-stack=N</code></td>\n</tr>\n<tr>\n<td><code>--pooling-allocator</code></td>\n<td><code>-R pooling-allocator</code></td>\n</tr>\n<tr>\n<td><code>--trap-on-grow-failure</code></td>\n<td><code>-R trap-on-grow-failure</code></td>\n</tr>\n<tr>\n<td><code>--wasm-timeout &lt;TIME&gt;</code></td>\n<td><code>-R timeout=N</code></td>\n</tr>\n</tbody>\n</table>\n<h3>WASI options (<code>-W</code> or <code>--wasi</code>)</h3>\n<ul>\n<li>\n<p>Separate from runtime options as this'll have WASI-proposal-specific<br>\n  configuration options.</p>\n</li>\n<li>\n<p>Leave <code>--env</code> as its own standalone flag</p>\n</li>\n<li>Add support for <code>--env FOO</code> which inherits the env var <code>FOO</code> from the outer<br>\n  process.</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>old cli flag</th>\n<th>new cli flag</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--listenfd</code></td>\n<td><code>-W listenfd</code></td>\n</tr>\n<tr>\n<td><code>--tcplisten &lt;SOCKET ADDRESS&gt;</code></td>\n<td><code>-W tcplisten=...</code></td>\n</tr>\n<tr>\n<td><code>--wasi-modules &lt;MODULE,MODULE,...&gt;</code></td>\n<td><code>-W common</code></td>\n</tr>\n<tr>\n<td><code>--wasi-modules &lt;MODULE,MODULE,...&gt;</code></td>\n<td><code>-W experimental-threads</code></td>\n</tr>\n<tr>\n<td><code>--dir &lt;DIRECTORY&gt;</code></td>\n<td><code>-W dir=..</code></td>\n</tr>\n<tr>\n<td><code>--mapdir &lt;GUEST_DIR::HOST_DIR&gt;</code></td>\n<td><code>-W dir=a::b</code></td>\n</tr>\n<tr>\n<td><code>--env &lt;NAME=VAL&gt;</code></td>\n<td><code>--env ...</code></td>\n</tr>\n</tbody>\n</table>\n<h3>Other flags</h3>\n<p>These are the other flags supported by Wasmtime which don't necessarily fit into the groups above. They're either important enough I think they should stick around at the top level or they have enough of their own \"sub-syntax\" that I'm not sure they fit well in the groups above.</p>\n<ul>\n<li>\n<p><code>--wasm-features &lt;FEATURE,FEATURE,...&gt;</code> - perhaps add something like a <code>-F</code><br>\n  shortcut, I find it a bit annoying to always type this out. Support <code>--wasm-features help</code> for the extended help section on this.</p>\n</li>\n<li>\n<p><code>--preload &lt;NAME=MODULE_PATH&gt;</code> - allow omitting <code>NAME</code> and infer it by default<br>\n  from <code>MODULE_PATH</code>.</p>\n</li>\n<li>\n<p><code>--profile &lt;STRATEGY&gt;</code> - leave as-is</p>\n</li>\n<li><code>--invoke &lt;FUNCTION&gt;</code> - leave as-is</li>\n<li><code>--allow-precompiled</code> - leave as-is</li>\n<li><code>--target &lt;TARGET&gt;</code> - leave as-is</li>\n<li><code>--output &lt;OUTPUT&gt;</code> - leave as-is</li>\n<li><code>--emit-clif &lt;PATH&gt;</code> - leave as-is</li>\n</ul>\n<hr>\n<p>I'm curious what others think about this! If it's broadly amenable and folks are ok with the breakage I'm happy to implement this myself, I don't think it'll take all that long (perhaps just a day or so)</p>\n</blockquote>",
        "id": 376183706,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689636915
    },
    {
        "content": "<p>sunfishcode <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1639955767\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>Overall I like the ideas here; my main concern is that an end user may not always know whether something is a \"codegen\" option or a \"runtime\" option, for example epoch interruption or memory configuration. I don't have a fully formed idea yet, but I wonder if it would make sense to instead group the options by something like:</p>\n<ul>\n<li>Performance tuning: optimization level, caching, parallel compilation, memory init cow, etc.</li>\n<li>Wasm semantics: NaN canonicalization, deterministic relaxed simd, max memory size etc., trap on grow failure, etc.</li>\n<li>Debugging: -g, logging, profiling, etc.</li>\n<li>WASI flags as you say</li>\n</ul>\n<p>What do you think?</p>\n</blockquote>",
        "id": 376294983,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689675921
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1640931743\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>Nah yeah I agree. My best strawman for an ordering like you're suggesting is something along the lines of:</p>\n<ul>\n<li><code>-P</code> - performance tuning</li>\n<li><code>-C</code> - codegen</li>\n<li><code>-D</code> - debugging</li>\n<li><code>-W</code> - wasm semantics</li>\n<li><code>-S</code> - WASI &amp; system config</li>\n</ul>\n<p>&lt;details&gt;</p>\n<table>\n<thead>\n<tr>\n<th>old cli flag</th>\n<th>new cli flag</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-O, --optimize</code></td>\n<td><code>-P opt-level=N</code> / <code>-O</code></td>\n</tr>\n<tr>\n<td><code>--opt-level &lt;LEVEL&gt;</code></td>\n<td><code>-P opt-level=N</code></td>\n</tr>\n<tr>\n<td><code>--dynamic-memory-guard-size &lt;SIZE&gt;</code></td>\n<td><code>-P dynamic-memory-guard-size=...</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-forced</code></td>\n<td><code>-P static-memory-forced</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-guard-size &lt;SIZE&gt;</code></td>\n<td><code>-P static-memory-guard-size=N</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-maximum-size &lt;MAXIMUM&gt;</code></td>\n<td><code>-P static-memory-maximum-size=N</code></td>\n</tr>\n<tr>\n<td><code>--dynamic-memory-reserved-for-growth &lt;SIZE&gt;</code></td>\n<td><code>-P dynamic-memory-reserved-for-growth=...</code></td>\n</tr>\n<tr>\n<td><code>--pooling-allocator</code></td>\n<td><code>-P pooling-allocator</code></td>\n</tr>\n<tr>\n<td><code>--disable-memory-init-cow</code></td>\n<td><code>-P memory-init-cow=no</code></td>\n</tr>\n<tr>\n<td><code>--compiler &lt;COMPILER&gt;</code></td>\n<td><code>-C compiler=..</code></td>\n</tr>\n<tr>\n<td><code>--enable-cranelift-debug-verifier</code></td>\n<td><code>-C cranelift-debug-verifier</code></td>\n</tr>\n<tr>\n<td><code>--cranelift-enable &lt;SETTING&gt;</code></td>\n<td><code>-C cranelift-NAME</code></td>\n</tr>\n<tr>\n<td><code>--cranelift-set &lt;NAME=VALUE&gt;</code></td>\n<td><code>-C cranelift-NAME=VALUE</code></td>\n</tr>\n<tr>\n<td><code>--config &lt;CONFIG_PATH&gt;</code></td>\n<td><code>-C cache-config=..</code></td>\n</tr>\n<tr>\n<td><code>--disable-cache</code></td>\n<td><code>-C cache=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-parallel-compilation</code></td>\n<td><code>-C parallel-compilation=no</code></td>\n</tr>\n<tr>\n<td><code>-g</code></td>\n<td><code>-D debuginfo</code> / <code>-g</code></td>\n</tr>\n<tr>\n<td><code>--disable-address-map</code></td>\n<td><code>-D address-map=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-logging</code></td>\n<td><code>-D logging=no</code></td>\n</tr>\n<tr>\n<td><code>--log-to-files</code></td>\n<td><code>-D log-to-files</code></td>\n</tr>\n<tr>\n<td><code>--coredump-on-trap &lt;PATH&gt;</code></td>\n<td><code>-D coredump=..</code></td>\n</tr>\n<tr>\n<td><code>--relaxed-simd-deterministic</code></td>\n<td><code>-W relaxed-simd-deterministic</code></td>\n</tr>\n<tr>\n<td><code>--enable-cranelift-nan-canonicalization</code></td>\n<td><code>-W cranelift-nan-canonicalization</code></td>\n</tr>\n<tr>\n<td><code>--fuel &lt;N&gt;</code></td>\n<td><code>-W fuel=N</code></td>\n</tr>\n<tr>\n<td><code>--epoch-interruption</code></td>\n<td><code>-W epoch-interruption</code></td>\n</tr>\n<tr>\n<td><code>--allow-unknown-exports</code></td>\n<td><code>-W unknown-exports-allow</code></td>\n</tr>\n<tr>\n<td><code>--trap-unknown-imports</code></td>\n<td><code>-W unknown-imports-trap</code></td>\n</tr>\n<tr>\n<td><code>--default-values-unknown-imports</code></td>\n<td><code>-W unknown-imports-default</code></td>\n</tr>\n<tr>\n<td><code>--max-instances &lt;MAX_INSTANCES&gt;</code></td>\n<td><code>-W max-instances=N</code></td>\n</tr>\n<tr>\n<td><code>--max-memories &lt;MAX_MEMORIES&gt;</code></td>\n<td><code>-W max-memories=N</code></td>\n</tr>\n<tr>\n<td><code>--max-memory-size &lt;BYTES&gt;</code></td>\n<td><code>-W max-memory-size=N</code></td>\n</tr>\n<tr>\n<td><code>--max-table-elements &lt;MAX_TABLE_ELEMENTS&gt;</code></td>\n<td><code>-W max-table-elements=N</code></td>\n</tr>\n<tr>\n<td><code>--max-tables &lt;MAX_TABLES&gt;</code></td>\n<td><code>-W max-tables=N</code></td>\n</tr>\n<tr>\n<td><code>--max-wasm-stack &lt;MAX_WASM_STACK&gt;</code></td>\n<td><code>-W max-wasm-stack=N</code></td>\n</tr>\n<tr>\n<td><code>--trap-on-grow-failure</code></td>\n<td><code>-W trap-on-grow-failure</code></td>\n</tr>\n<tr>\n<td><code>--wasm-timeout &lt;TIME&gt;</code></td>\n<td><code>-W timeout=N</code></td>\n</tr>\n<tr>\n<td><code>--listenfd</code></td>\n<td><code>-S listenfd</code></td>\n</tr>\n<tr>\n<td><code>--tcplisten &lt;SOCKET ADDRESS&gt;</code></td>\n<td><code>-S tcplisten=...</code></td>\n</tr>\n<tr>\n<td><code>--wasi-modules &lt;MODULE,MODULE,...&gt;</code></td>\n<td><code>-S common</code></td>\n</tr>\n<tr>\n<td><code>--wasi-modules &lt;MODULE,MODULE,...&gt;</code></td>\n<td><code>-S experimental-threads</code></td>\n</tr>\n<tr>\n<td><code>--dir &lt;DIRECTORY&gt;</code></td>\n<td><code>-S dir=..</code></td>\n</tr>\n<tr>\n<td><code>--mapdir &lt;GUEST_DIR::HOST_DIR&gt;</code></td>\n<td><code>-S dir=a::b</code></td>\n</tr>\n</tbody>\n</table>\n<p>&lt;/details&gt;</p>\n<p>One thing that feels a bit odd though is that I was hoping for a clean split where <code>wasmtime compile</code> would be a strict subset of <code>wasmtime run</code> options or something like that. For example there's no need for <code>wasmtime compile</code> to support <code>-S</code> or <code>-D</code> options in theory. That's what I was roughly hoping for above where <code>wasmtime compile</code> would drop all the <code>-R</code> options but keep all the <code>-C</code> options.</p>\n<p>Here it's not so straightforward though because fuel is both a wasm semantics option and a compilation option. Other wasm semantic options like <code>max-memory-size</code> don't affect the compilation though. This may not be a great thing to optimize for though and the more I think about it the more it feels sort of arbitrary. </p>\n<p>In any case I like the idea of the categories you're thinking of too, would you move any of the above options around though?</p>\n</blockquote>",
        "id": 376464068,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689711154
    },
    {
        "content": "<p>sunfishcode <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1642485993\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>Some bikeshed suggestions:</p>\n<ul>\n<li>Name the performance tuning flag <code>-O</code>, as in <code>-O pooling-allocator</code> and so on, because that's familiar to me from common compiler flags, though I don't know if that will have the same association for others.</li>\n<li>Rename <code>cranelift-nan-canonicalization</code> to just <code>nan-canonlicalization</code> and maybe have winch fail if that flag is given and it isn't supported yet. Because from an end-user perspective, this is a semantics thing, not a cranelift thing.</li>\n</ul>\n<p>The <code>compile</code> vs. <code>run</code> split is a good point. My best idea is to have <code>compile</code> accept all the same options as <code>run</code>, and record those options along with the output so that <code>run</code> can default to them. <code>run</code> could allow some of those flags to be overridden, but not all, because some will be baked into the compiled code. But it's awkward for users to figure out which flags need to be specified at <code>compile</code> and which can be overridden at <code>run</code>.</p>\n<p>But maybe that's ok? Maybe the priority should be to make the simple <code>run</code> user experience the simplest, and organizing the options in terms of tuning/semantics/debugging/etc. seems best for that?<br>\n</p>\n</blockquote>",
        "id": 376743465,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689788109
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1642527077\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>Don't feel like joining this particular bike shed, but one TODO item to record for posterity if we change the flags to enable different Wasm proposals is we will want to send a PR to update <a href=\"https://webassembly.org/roadmap/\">https://webassembly.org/roadmap/</a> as well.</p>\n</blockquote>",
        "id": 376751000,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689789978
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1642592707\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>I like the idea of <code>-O</code> for tuning, yeah, and renaming to <code>nan-canonicalization</code> sounds good to me. I also agree it's probably best to optimize for <code>run</code> and <code>compile</code> can do what's necessary to support the flags, so given that I think the proposal would be:</p>\n<table>\n<thead>\n<tr>\n<th>old cli flag</th>\n<th>new cli flag</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>-O, --optimize</code></td>\n<td><code>-O opt-level=N</code></td>\n</tr>\n<tr>\n<td><code>--opt-level &lt;LEVEL&gt;</code></td>\n<td><code>-O opt-level=N</code></td>\n</tr>\n<tr>\n<td><code>--dynamic-memory-guard-size &lt;SIZE&gt;</code></td>\n<td><code>-O dynamic-memory-guard-size=...</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-forced</code></td>\n<td><code>-O static-memory-forced</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-guard-size &lt;SIZE&gt;</code></td>\n<td><code>-O static-memory-guard-size=N</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-maximum-size &lt;MAXIMUM&gt;</code></td>\n<td><code>-O static-memory-maximum-size=N</code></td>\n</tr>\n<tr>\n<td><code>--dynamic-memory-reserved-for-growth &lt;SIZE&gt;</code></td>\n<td><code>-O dynamic-memory-reserved-for-growth=...</code></td>\n</tr>\n<tr>\n<td><code>--pooling-allocator</code></td>\n<td><code>-O pooling-allocator</code></td>\n</tr>\n<tr>\n<td><code>--disable-memory-init-cow</code></td>\n<td><code>-O memory-init-cow=no</code></td>\n</tr>\n<tr>\n<td><code>--compiler &lt;COMPILER&gt;</code></td>\n<td><code>-C compiler=..</code></td>\n</tr>\n<tr>\n<td><code>--enable-cranelift-debug-verifier</code></td>\n<td><code>-C cranelift-debug-verifier</code></td>\n</tr>\n<tr>\n<td><code>--cranelift-enable &lt;SETTING&gt;</code></td>\n<td><code>-C cranelift-NAME</code></td>\n</tr>\n<tr>\n<td><code>--cranelift-set &lt;NAME=VALUE&gt;</code></td>\n<td><code>-C cranelift-NAME=VALUE</code></td>\n</tr>\n<tr>\n<td><code>--config &lt;CONFIG_PATH&gt;</code></td>\n<td><code>-C cache-config=..</code></td>\n</tr>\n<tr>\n<td><code>--disable-cache</code></td>\n<td><code>-C cache=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-parallel-compilation</code></td>\n<td><code>-C parallel-compilation=no</code></td>\n</tr>\n<tr>\n<td><code>-g</code></td>\n<td><code>-D debuginfo</code> / <code>-g</code></td>\n</tr>\n<tr>\n<td><code>--disable-address-map</code></td>\n<td><code>-D address-map=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-logging</code></td>\n<td><code>-D logging=no</code></td>\n</tr>\n<tr>\n<td><code>--log-to-files</code></td>\n<td><code>-D log-to-files</code></td>\n</tr>\n<tr>\n<td><code>--coredump-on-trap &lt;PATH&gt;</code></td>\n<td><code>-D coredump=..</code></td>\n</tr>\n<tr>\n<td><code>--relaxed-simd-deterministic</code></td>\n<td><code>-W relaxed-simd-deterministic</code></td>\n</tr>\n<tr>\n<td><code>--enable-cranelift-nan-canonicalization</code></td>\n<td><code>-W nan-canonicalization</code></td>\n</tr>\n<tr>\n<td><code>--fuel &lt;N&gt;</code></td>\n<td><code>-W fuel=N</code></td>\n</tr>\n<tr>\n<td><code>--epoch-interruption</code></td>\n<td><code>-W epoch-interruption</code></td>\n</tr>\n<tr>\n<td><code>--allow-unknown-exports</code></td>\n<td><code>-W unknown-exports-allow</code></td>\n</tr>\n<tr>\n<td><code>--trap-unknown-imports</code></td>\n<td><code>-W unknown-imports-trap</code></td>\n</tr>\n<tr>\n<td><code>--default-values-unknown-imports</code></td>\n<td><code>-W unknown-imports-default</code></td>\n</tr>\n<tr>\n<td><code>--max-instances &lt;MAX_INSTANCES&gt;</code></td>\n<td><code>-W max-instances=N</code></td>\n</tr>\n<tr>\n<td><code>--max-memories &lt;MAX_MEMORIES&gt;</code></td>\n<td><code>-W max-memories=N</code></td>\n</tr>\n<tr>\n<td><code>--max-memory-size &lt;BYTES&gt;</code></td>\n<td><code>-W max-memory-size=N</code></td>\n</tr>\n<tr>\n<td><code>--max-table-elements &lt;MAX_TABLE_ELEMENTS&gt;</code></td>\n<td><code>-W max-table-elements=N</code></td>\n</tr>\n<tr>\n<td><code>--max-tables &lt;MAX_TABLES&gt;</code></td>\n<td><code>-W max-tables=N</code></td>\n</tr>\n<tr>\n<td><code>--max-wasm-stack &lt;MAX_WASM_STACK&gt;</code></td>\n<td><code>-W max-wasm-stack=N</code></td>\n</tr>\n<tr>\n<td><code>--trap-on-grow-failure</code></td>\n<td><code>-W trap-on-grow-failure</code></td>\n</tr>\n<tr>\n<td><code>--wasm-timeout &lt;TIME&gt;</code></td>\n<td><code>-W timeout=N</code></td>\n</tr>\n<tr>\n<td><code>--listenfd</code></td>\n<td><code>-S listenfd</code></td>\n</tr>\n<tr>\n<td><code>--tcplisten &lt;SOCKET ADDRESS&gt;</code></td>\n<td><code>-S tcplisten=...</code></td>\n</tr>\n<tr>\n<td><code>--wasi-modules &lt;MODULE,MODULE,...&gt;</code></td>\n<td><code>-S common</code></td>\n</tr>\n<tr>\n<td><code>--wasi-modules &lt;MODULE,MODULE,...&gt;</code></td>\n<td><code>-S experimental-threads</code></td>\n</tr>\n<tr>\n<td><code>--dir &lt;DIRECTORY&gt;</code></td>\n<td><code>-S dir=..</code></td>\n</tr>\n<tr>\n<td><code>--mapdir &lt;GUEST_DIR::HOST_DIR&gt;</code></td>\n<td><code>-S dir=a::b</code></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</blockquote>",
        "id": 376763396,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689792853
    },
    {
        "content": "<p>tschneidereit <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1642606506\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>Also don't feel like I need to share my favorite shed coloring scheme, but a question: is it possible to have <code>help</code> output for specific flags? I.e., can I do <code>wasmtime help run -O</code> (or <code>wasmtime help -O</code>) and get output just for all <code>-O</code> flags?</p>\n</blockquote>",
        "id": 376765985,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689793507
    },
    {
        "content": "<p>tschneidereit <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1642608610\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>And another question: can we in redesigning this look into making flags available as env vars as well where reasonable? Ideally in a way that works for libwasmtime embeddings, not just the CLI? Obviously that doesn't make sense for most options, but it'd be excellent for debug/profiling things, for example.</p>\n</blockquote>",
        "id": 376766407,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689793616
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1642865023\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>I'm not sure of a way to configure clap to do that, but I've also found that if I'm looking for a specific option then <code>wasmtime --help | less</code> and searching for <code>foo</code> is good enough for exploring a specific option. Or alternatively with the groups above it'd be <code>wasmtime -W help</code> or similar.</p>\n<blockquote>\n<p>And another question: can we in redesigning this look into making flags available as env vars as well where reasonable? Ideally in a way that works for libwasmtime embeddings, not just the CLI?</p>\n</blockquote>\n<p>On one hand this is easy because I think clap exposes the ability to do this. On the other hand this isn't easy because embeddings aren't using clap they're using <code>Config</code>. I do agree though that for profiling and debugging options env vars are mega-useful since you don't have to thread them around everywhere.</p>\n</blockquote>",
        "id": 376805532,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1689806994
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1697902146\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>I've made a PR for this at <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6925\">https://github.com/bytecodealliance/wasmtime/pull/6925</a></p>\n</blockquote>",
        "id": 387937073,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1693332526
    },
    {
        "content": "<p>tschneidereit <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1774935932\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>I guess we can close this?</p>\n</blockquote>",
        "id": 398059197,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1698058473
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741#issuecomment-1775341564\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>Ah yes, thanks!</p>\n</blockquote>",
        "id": 398098700,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1698071590
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6741\">issue #6741</a>:</p>\n<blockquote>\n<p>Currently the set of CLI flags added to Wasmtime has been ad-hoc and generally \"throw another option in there\" style historically, which is great for easily adding new options (which happens a fair bit), but I  personally feel like there have been some growing pains that may be worthwhile to address sooner rather than later. </p>\n<p>Some concerns I have with the current CLI are:</p>\n<ul>\n<li>Discoverability is hard right now as <code>--help</code> or <code> -h</code> prints out quite a lot of information.</li>\n<li>Not a lot of single-letter flags are in use so CLI commands tend to be quite long</li>\n<li>It's tough to review \"at a glance\" what Wasmtime's capabilities are on the CLI through the help page since there's so much to sift through</li>\n<li>Some options have little papercuts like trying to remember <code>--dir</code> vs <code>--mapdir</code>, there's no way to inherit the caller's environment or a single env var from the environment easily, etc.</li>\n<li>Options can be randomly <code>--disable-foo</code> or <code>--enable-foo</code> and it's not clear why which is which when you're approaching the CLI for the first time.</li>\n</ul>\n<p>To be clear none of these are dealbreakers by any means. While I think the Wasmtime CLI is important the embedding API are where things \"get serious\" so it's ok for the CLI to not be perfect. That being said folks often interact with Wasmtime through the CLI to start off with and it's also mega-useful during development and debugging and such.</p>\n<p>So given all the above I'd like to propose a (hopefully) brief bikeshed about the Wasmtime CLI. I'd like to ideally address the above concerns and provide guidelines of how to add new options into the future. This will hopefully clean up our CLI, make it a bit more ergonomic to use, all while not hindering our ability to easily add various knobs here and there as they're implemented.</p>\n<p>At a high level my proposal is \"let's do what <code>rustc</code> does\". I'm very biased in that regard as I helped design rustc's CLI as well. Some things I like about rustc though are:</p>\n<ul>\n<li>The output of <code>rustc -h</code> fits more-or-less on one terminal. This serves as a good index from which you can learn more.</li>\n<li>There are \"option groups\" that are behind other flags, such as <code>rustc -C foo</code> or <code>rustc -Z foo</code>. These single-letter capital flags are easy to type and easy to remember and serve as a good place to house sub-options.</li>\n<li>More information can be read through <code>rustc -C help</code> which provides an window into all the codegen capabilities of rustc</li>\n<li>Instead of <code>--enable-foo</code> or <code>--disable-foo</code> most rustc options are <code>-C foo</code> for <code>--enable-foo</code> or <code>-C foo=no</code> for <code>--disable-foo</code>. This makes it easy for callers to forcibly enable/disable something and you don't have to worry about what the defaults are since as a user you typically want to turn something on or off and you don't care too much about whatever the default happens to be.</li>\n</ul>\n<p>My proposal here for Wasmtime's option groups are:</p>\n<h3>Codegen options (<code>-C</code> or <code>--codegen</code>)</h3>\n<ul>\n<li>All <code>--disable-foo</code> flags become <code>-C foo=no</code></li>\n<li>All <code>--enable-foo</code> flags become <code>-C foo</code></li>\n<li><code>-C foo</code> is shorthand for <code>-C foo=yes</code></li>\n<li><code>*=yes</code> can support <code>y</code>, <code>yes</code>, <code>true</code>, etc</li>\n<li><code>*=no</code> can support <code>n</code>, <code>no</code>, <code>false</code>, etc</li>\n<li>\n<p>Non-boolean flags support <code>-C name=val</code> where <code>val</code> is parsed as whatever<br>\n<code>name</code> wants.</p>\n</li>\n<li>\n<p>Can support comma-separation as well such as <code>-C foo,bar</code> or <code>-C foo=n,bar</code></p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>old cli flag</th>\n<th>new cli flag</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--compiler &lt;COMPILER&gt;</code></td>\n<td><code>-C compiler=..</code></td>\n</tr>\n<tr>\n<td><code>-O, --optimize</code></td>\n<td><code>-C opt-level=N</code> / <code>-O</code></td>\n</tr>\n<tr>\n<td><code>--opt-level &lt;LEVEL&gt;</code></td>\n<td><code>-C opt-level=N</code></td>\n</tr>\n<tr>\n<td><code>--config &lt;CONFIG_PATH&gt;</code></td>\n<td><code>-C cache-config=..</code></td>\n</tr>\n<tr>\n<td><code>--disable-address-map</code></td>\n<td><code>-C address-map=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-cache</code></td>\n<td><code>-C cache=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-parallel-compilation</code></td>\n<td><code>-C parallel-compilation=no</code></td>\n</tr>\n<tr>\n<td><code>--epoch-interruption</code></td>\n<td><code>-C epoch-interruption</code></td>\n</tr>\n<tr>\n<td><code>-g</code></td>\n<td><code>-C debuginfo</code> / <code>-g</code></td>\n</tr>\n<tr>\n<td><code>--dynamic-memory-guard-size &lt;SIZE&gt;</code></td>\n<td><code>-C dynamic-memory-guard-size=...</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-forced</code></td>\n<td><code>-C static-memory-forced</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-guard-size &lt;SIZE&gt;</code></td>\n<td><code>-C static-memory-guard-size=N</code></td>\n</tr>\n<tr>\n<td><code>--static-memory-maximum-size &lt;MAXIMUM&gt;</code></td>\n<td><code>-C static-memory-maximum-size=N</code></td>\n</tr>\n<tr>\n<td><code>--relaxed-simd-deterministic</code></td>\n<td><code>-C relaxed-simd-deterministic</code></td>\n</tr>\n<tr>\n<td><code>--cranelift-enable &lt;SETTING&gt;</code></td>\n<td><code>-C cranelift-NAME</code></td>\n</tr>\n<tr>\n<td><code>--enable-cranelift-debug-verifier</code></td>\n<td><code>-C cranelift-debug-verifier</code></td>\n</tr>\n<tr>\n<td><code>--enable-cranelift-nan-canonicalization</code></td>\n<td><code>-C cranelift-nan-canonicalization</code></td>\n</tr>\n<tr>\n<td><code>--cranelift-set &lt;NAME=VALUE&gt;</code></td>\n<td><code>-C cranelift-NAME=VALUE</code></td>\n</tr>\n</tbody>\n</table>\n<h3>Runtime options (<code>-R</code> or <code>--runtime</code>)</h3>\n<ul>\n<li>Various <code>*-unknown-*</code> options are all <code>-R unknown-*</code> now.</li>\n<li>Same system for boolean flags as <code>-C</code> options</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>old cli flag</th>\n<th>new cli flag</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--allow-unknown-exports</code></td>\n<td><code>-R unknown-exports-allow</code></td>\n</tr>\n<tr>\n<td><code>--trap-unknown-imports</code></td>\n<td><code>-R unknown-imports-trap</code></td>\n</tr>\n<tr>\n<td><code>--default-values-unknown-imports</code></td>\n<td><code>-R unknown-imports-default</code></td>\n</tr>\n<tr>\n<td><code>--coredump-on-trap &lt;PATH&gt;</code></td>\n<td><code>-R coredump=..</code></td>\n</tr>\n<tr>\n<td><code>--disable-logging</code></td>\n<td><code>-R logging=no</code></td>\n</tr>\n<tr>\n<td><code>--disable-memory-init-cow</code></td>\n<td><code>-R memory-init-cow=no</code></td>\n</tr>\n<tr>\n<td><code>--dynamic-memory-reserved-for-growth &lt;SIZE&gt;</code></td>\n<td><code>-R dynamic-memory-reserved-for-growth=...</code></td>\n</tr>\n<tr>\n<td><code>--fuel &lt;N&gt;</code></td>\n<td><code>-R fuel=N</code></td>\n</tr>\n<tr>\n<td><code>--log-to-files</code></td>\n<td><code>-R log-to-files</code></td>\n</tr>\n<tr>\n<td><code>--max-instances &lt;MAX_INSTANCES&gt;</code></td>\n<td><code>-R max-instances=N</code></td>\n</tr>\n<tr>\n<td><code>--max-memories &lt;MAX_MEMORIES&gt;</code></td>\n<td><code>-R max-memories=N</code></td>\n</tr>\n<tr>\n<td><code>--max-memory-size &lt;BYTES&gt;</code></td>\n<td><code>-R max-memory-size=N</code></td>\n</tr>\n<tr>\n<td><code>--max-table-elements &lt;MAX_TABLE_ELEMENTS&gt;</code></td>\n<td><code>-R max-table-elements=N</code></td>\n</tr>\n<tr>\n<td><code>--max-tables &lt;MAX_TABLES&gt;</code></td>\n<td><code>-R max-tables=N</code></td>\n</tr>\n<tr>\n<td><code>--max-wasm-stack &lt;MAX_WASM_STACK&gt;</code></td>\n<td><code>-R max-wasm-stack=N</code></td>\n</tr>\n<tr>\n<td><code>--pooling-allocator</code></td>\n<td><code>-R pooling-allocator</code></td>\n</tr>\n<tr>\n<td><code>--trap-on-grow-failure</code></td>\n<td><code>-R trap-on-grow-failure</code></td>\n</tr>\n<tr>\n<td><code>--wasm-timeout &lt;TIME&gt;</code></td>\n<td><code>-R timeout=N</code></td>\n</tr>\n</tbody>\n</table>\n<h3>WASI options (<code>-W</code> or <code>--wasi</code>)</h3>\n<ul>\n<li>\n<p>Separate from runtime options as this'll have WASI-proposal-specific<br>\n  configuration options.</p>\n</li>\n<li>\n<p>Leave <code>--env</code> as its own standalone flag</p>\n</li>\n<li>Add support for <code>--env FOO</code> which inherits the env var <code>FOO</code> from the outer<br>\n  process.</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>old cli flag</th>\n<th>new cli flag</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>--listenfd</code></td>\n<td><code>-W listenfd</code></td>\n</tr>\n<tr>\n<td><code>--tcplisten &lt;SOCKET ADDRESS&gt;</code></td>\n<td><code>-W tcplisten=...</code></td>\n</tr>\n<tr>\n<td><code>--wasi-modules &lt;MODULE,MODULE,...&gt;</code></td>\n<td><code>-W common</code></td>\n</tr>\n<tr>\n<td><code>--wasi-modules &lt;MODULE,MODULE,...&gt;</code></td>\n<td><code>-W experimental-threads</code></td>\n</tr>\n<tr>\n<td><code>--dir &lt;DIRECTORY&gt;</code></td>\n<td><code>-W dir=..</code></td>\n</tr>\n<tr>\n<td><code>--mapdir &lt;GUEST_DIR::HOST_DIR&gt;</code></td>\n<td><code>-W dir=a::b</code></td>\n</tr>\n<tr>\n<td><code>--env &lt;NAME=VAL&gt;</code></td>\n<td><code>--env ...</code></td>\n</tr>\n</tbody>\n</table>\n<h3>Other flags</h3>\n<p>These are the other flags supported by Wasmtime which don't necessarily fit into the groups above. They're either important enough I think they should stick around at the top level or they have enough of their own \"sub-syntax\" that I'm not sure they fit well in the groups above.</p>\n<ul>\n<li>\n<p><code>--wasm-features &lt;FEATURE,FEATURE,...&gt;</code> - perhaps add something like a <code>-F</code><br>\n  shortcut, I find it a bit annoying to always type this out. Support <code>--wasm-features help</code> for the extended help section on this.</p>\n</li>\n<li>\n<p><code>--preload &lt;NAME=MODULE_PATH&gt;</code> - allow omitting <code>NAME</code> and infer it by default<br>\n  from <code>MODULE_PATH</code>.</p>\n</li>\n<li>\n<p><code>--profile &lt;STRATEGY&gt;</code> - leave as-is</p>\n</li>\n<li><code>--invoke &lt;FUNCTION&gt;</code> - leave as-is</li>\n<li><code>--allow-precompiled</code> - leave as-is</li>\n<li><code>--target &lt;TARGET&gt;</code> - leave as-is</li>\n<li><code>--output &lt;OUTPUT&gt;</code> - leave as-is</li>\n<li><code>--emit-clif &lt;PATH&gt;</code> - leave as-is</li>\n</ul>\n<hr>\n<p>I'm curious what others think about this! If it's broadly amenable and folks are ok with the breakage I'm happy to implement this myself, I don't think it'll take all that long (perhaps just a day or so)</p>\n</blockquote>",
        "id": 398098702,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1698071590
    }
]