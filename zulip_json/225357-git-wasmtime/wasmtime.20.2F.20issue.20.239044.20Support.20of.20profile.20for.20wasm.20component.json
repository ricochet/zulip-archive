[
    {
        "content": "<p>wynterr opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044\">issue #9044</a>:</p>\n<blockquote>\n<p>Hi, </p>\n<p>I was trying to use perf to do profiling when using <code>wasmtime serve</code> to serve a wasm component(compiled from <a href=\"https://github.com/sunfishcode/hello-wasi-http\">https://github.com/sunfishcode/hello-wasi-http</a> without any change). The command I run is <code>perf record  wasmtime serve --profile=perfmap target/wasm32-wasi/debug/hello_wasi_http.wasm</code>. After calling the endpoint for a couple times, I stop the serve and use <code>perf report --input perf.data</code> to check the profile. However, I see this line with unresolved symbol:</p>\n<blockquote>\n<p>1.84%  wasmtime         wasmtime           [.] 0x000000000151eb88</p>\n</blockquote>\n<p>Also, I find no <a href=\"http://perf-xxxx.map\">perf-xxxx.map</a> file under /tmp.</p>\n<p>I wonder is profiling not supported for component serving, or anything I was not doing right?</p>\n<h3>To reproduce:</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"p\">:</span><span class=\"c1\">//github.com/sunfishcode/hello-wasi-http</span>\n<span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">perf</span><span class=\"w\"> </span><span class=\"n\">record</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">serve</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">profile</span><span class=\"o\">=</span><span class=\"n\">perfmap</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">hello_wasi_http</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">endpoint</span>\n<span class=\"n\">perf</span><span class=\"w\"> </span><span class=\"n\">report</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"n\">perf</span><span class=\"p\">.</span><span class=\"n\">data</span>\n</code></pre></div>\n</blockquote>",
        "id": 455117261,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722344334
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044#issuecomment-2258524232\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044\">issue #9044</a>:</p>\n<blockquote>\n<p>To confirm, you're on Linux? </p>\n<p>Locally I ran <code>perf record wasmtime serve --profile perfmap ./target/wasm32-wasi/release/hello_wasi_http.wasm</code> with <code>perf version 6.8.1</code> and <code>wasmtime-cli 23.0.1</code>. I hit that a few times and then using <code>perf report</code> I see <code>0.88%  tokio-runtime-w  [JIT] tid 4066067  [.] wit_bindgen::rt::run_ctors_once::hf08958e4a83e86d1</code> which I believe is the symbolication.</p>\n</blockquote>",
        "id": 455141185,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722350454
    },
    {
        "content": "<p>wynterr <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044#issuecomment-2262303683\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044\">issue #9044</a>:</p>\n<blockquote>\n<blockquote>\n<p>To confirm, you're on Linux?</p>\n<p>Locally I ran <code>perf record wasmtime serve --profile perfmap ./target/wasm32-wasi/release/hello_wasi_http.wasm</code> with <code>perf version 6.8.1</code> and <code>wasmtime-cli 23.0.1</code>. I hit that a few times and then using <code>perf report</code> I see <code>0.88% tokio-runtime-w [JIT] tid 4066067 [.] wit_bindgen::rt::run_ctors_once::hf08958e4a83e86d1</code> which I believe is the symbolication.</p>\n</blockquote>\n<p>Thanks for your reply. I'm on Linux with <code>perf version 6.5.13</code> and <code>wasmtime-cli 21.0.1 (cedf9aa0f 2024-05-22)</code>. Actually I made a mistake before and I do find the <code>/tmp/perf-XXXX.map</code> file now. But still seeing symbols like <code>0.98%  wasmtime         [unknown]             [k] 0xffffffffc02c076f</code> from <code>perf report</code> and didn't find things like <code>wit_bindgen::rt::run_ctors_once</code><br>\nI'm actually quite new to this and not very sure about how to read the perf report to find the symbol that relates to things inside my wasm component.</p>\n</blockquote>",
        "id": 455580686,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722499296
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044#issuecomment-2263820981\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044\">issue #9044</a>:</p>\n<blockquote>\n<p>Under \"To reproduce\" above are those the exact commands you used? I ran those myself locally and apart from a missing <code>cd hello-wasi-http</code> those worked for me. For the <code># call the endpoint</code> step I ran <code>wrk http://localhost:8080 -t 1 -d 1</code>. In the output I see JIT symbols as expected with nothing un-symbolicated.</p>\n<p>Perhaps perfmap support was improved or something in <code>perf</code> between 6.5 and 6.8? I don't know much about <code>perf</code> versions myself and the historicaly development of perfmap support.</p>\n</blockquote>",
        "id": 455739500,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722540824
    },
    {
        "content": "<p>wynterr <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044#issuecomment-2268952430\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044\">issue #9044</a>:</p>\n<blockquote>\n<p>Yes I do follow the exact commands in \"To reproduce\" except the missing <code>cd hello-wasi-http</code>. But I was using <code>curl http://localhost:8080</code> to hit the endpoint.<br>\nAfter using <code>wrk http://localhost:8080 -t 1 -d 1</code> to hit the endpoint I do find some <code>[JIT] tid xxxx</code> in shared objects and symbol <code>wit_bindgen::rt::run_ctors_once</code>, even though records with things like <code>0.03%  tokio-runtime-w  [unknown]                  [k] 0xffffffffc02d1028</code> still exist but with very small overhead.<br>\nI also tried to run <code>curl http://localhost:8080</code> more times and in the end I also saw some <code>[JIT] tid xxxx</code> in shared objects. I guess the reason is that <code>perf record</code> only samples a small part of records to show so you have to make more requests to make the function call visible. </p>\n</blockquote>",
        "id": 456531539,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722860790
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044#issuecomment-2277257666\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044\">issue #9044</a>:</p>\n<blockquote>\n<p>Aha! The <code>[k]</code> there means that it's time spent in the kernel, which I believe means that your <code>perf</code> invocation can't symbolize kernel stack traces. I belive that's unrelated to wasmtime profiling. If  you're seeing <code>[JIT]</code> entries then profiling should be working.</p>\n</blockquote>",
        "id": 459386129,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1723185984
    },
    {
        "content": "<p>wynterr closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9044\">issue #9044</a>:</p>\n<blockquote>\n<p>Hi, </p>\n<p>I was trying to use perf to do profiling when using <code>wasmtime serve</code> to serve a wasm component(compiled from <a href=\"https://github.com/sunfishcode/hello-wasi-http\">https://github.com/sunfishcode/hello-wasi-http</a> without any change). The command I run is <code>perf record  wasmtime serve --profile=perfmap target/wasm32-wasi/debug/hello_wasi_http.wasm</code>. After calling the endpoint for a couple times, I stop the serve and use <code>perf report --input perf.data</code> to check the profile. However, I see this line with unresolved symbol:</p>\n<blockquote>\n<p>1.84%  wasmtime         wasmtime           [.] 0x000000000151eb88</p>\n</blockquote>\n<p>Also, I find no <a href=\"http://perf-xxxx.map\">perf-xxxx.map</a> file under /tmp.</p>\n<p>I wonder is profiling not supported for component serving, or anything I was not doing right?</p>\n<h3>To reproduce:</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"p\">:</span><span class=\"c1\">//github.com/sunfishcode/hello-wasi-http</span>\n<span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">perf</span><span class=\"w\"> </span><span class=\"n\">record</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">serve</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">profile</span><span class=\"o\">=</span><span class=\"n\">perfmap</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">hello_wasi_http</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">endpoint</span>\n<span class=\"n\">perf</span><span class=\"w\"> </span><span class=\"n\">report</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"n\">perf</span><span class=\"p\">.</span><span class=\"n\">data</span>\n</code></pre></div>\n</blockquote>",
        "id": 462540301,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1723724745
    }
]