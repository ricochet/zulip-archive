[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3857\">issue #3857</a>:</p>\n<blockquote>\n<p>This past Friday some tests were done on CI - <a href=\"https://github.com/bytecodealliance/wasmtime/pull/3853\">https://github.com/bytecodealliance/wasmtime/pull/3853</a> - to figure out what was going wrong and the culprit ended up being the stack overflow tests on Windows. Our testing efforts were thwarted by the fact that if the test harness is run with <code>--test-threads 1</code> then stack overflow tests will all legitimately stack overflow on Windows, presumably because we're by default giving too much stack space to WebAssembly. </p>\n<p>This can be reproduced locally on Windows with:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">test</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The best fix for this is likely to decrease the default amount of stack given to WebAssembly (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b57dc5e3346747824dcb512cc99f94c14763cbab/crates/wasmtime/src/config.rs#L118\">specified here</a>), perhaps only on Windows.</p>\n</blockquote>",
        "id": 273501186,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1646060400
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3857#issuecomment-1054366649\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3857\">issue #3857</a>:</p>\n<blockquote>\n<p>I'm performing a test run at <a href=\"https://github.com/alexcrichton/wasmtime/actions/runs/1911049688\">https://github.com/alexcrichton/wasmtime/actions/runs/1911049688</a> to see what happens when we limit the stack size of wasm for the entire test suite, and then run the tests on windows with <code>--test-threads 1</code></p>\n</blockquote>",
        "id": 273504825,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1646061775
    },
    {
        "content": "<p>alexcrichton edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3857#issuecomment-1054366649\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3857\">issue #3857</a>:</p>\n<blockquote>\n<p>I'm performing a test run at <del>https://github.com/alexcrichton/wasmtime/actions/runs/1911049688</del> <a href=\"https://github.com/alexcrichton/wasmtime/actions/runs/1911091901\">https://github.com/alexcrichton/wasmtime/actions/runs/1911091901</a> to see what happens when we limit the stack size of wasm for the entire test suite, and then run the tests on windows with <code>--test-threads 1</code></p>\n</blockquote>",
        "id": 273506495,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1646062326
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3857#issuecomment-1054399130\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3857\">issue #3857</a>:</p>\n<blockquote>\n<p>Learnings so far:</p>\n<ul>\n<li>According to <a href=\"https://github.com/alexcrichton/wasmtime/runs/5361838714?check_suite_focus=true\">https://github.com/alexcrichton/wasmtime/runs/5361838714?check_suite_focus=true</a> the test suite works as-is (as of b57dc5e3346747824dcb512cc99f94c14763cbab) with 64k to 256k, of wasm stack.<ul>\n<li>At 512k and above of wasm stack <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b57dc5e3346747824dcb512cc99f94c14763cbab/tests/all/stack_overflow.rs#L5\">this test</a> fails as the host tries to probe that it has 512k of stack.</li>\n<li>At 16-32k of wasm stack <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b57dc5e3346747824dcb512cc99f94c14763cbab/tests/all/call_hook.rs#L291\">this test</a> fails because it's intermingling host/wasm stack and the wasm stack's allocation starts at the first recursive call, it's not per-call.</li>\n<li>At 8k and below of wasm stack we start seeing lots of various failures in the test suite</li>\n</ul>\n</li>\n<li>According to <a href=\"https://github.com/alexcrichton/wasmtime/runs/5361992788?check_suite_focus=true\">https://github.com/alexcrichton/wasmtime/runs/5361992788?check_suite_focus=true</a> if we probe for 128k bytes of stack in <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b57dc5e3346747824dcb512cc99f94c14763cbab/tests/all/stack_overflow.rs#L5\">this test</a> then the test suite passes with 512k of wasm stack.</li>\n</ul>\n</blockquote>",
        "id": 273510258,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1646063689
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3857\">issue #3857</a>:</p>\n<blockquote>\n<p>This past Friday some tests were done on CI - <a href=\"https://github.com/bytecodealliance/wasmtime/pull/3853\">https://github.com/bytecodealliance/wasmtime/pull/3853</a> - to figure out what was going wrong and the culprit ended up being the stack overflow tests on Windows. Our testing efforts were thwarted by the fact that if the test harness is run with <code>--test-threads 1</code> then stack overflow tests will all legitimately stack overflow on Windows, presumably because we're by default giving too much stack space to WebAssembly. </p>\n<p>This can be reproduced locally on Windows with:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">test</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The best fix for this is likely to decrease the default amount of stack given to WebAssembly (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b57dc5e3346747824dcb512cc99f94c14763cbab/crates/wasmtime/src/config.rs#L118\">specified here</a>), perhaps only on Windows.</p>\n</blockquote>",
        "id": 273531889,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1646072292
    }
]