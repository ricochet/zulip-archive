[
    {
        "content": "<p>quasis opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>Running a WASM file with a binary argument, such as:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">hmac_md5_128</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">printf</span><span class=\"w\"> </span><span class=\"s\">\"\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\"</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"s\">\"String to hash\"</span><span class=\"w\"></span>\n</code></pre></div>\n<p>or</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">hmac_md5_128</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">printf</span><span class=\"w\"> </span><span class=\"s\">\"\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\"</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"s\">\"String to hash\"</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Aborts execution with the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">Invalid</span><span class=\"w\"> </span><span class=\"n\">UTF</span><span class=\"o\">-</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I see three problems with this:</p>\n<ol>\n<li>There is no standard I'm aware of that requires the arguments to be textual</li>\n<li>There is no standard that requires them to be UTF-8 encoded</li>\n<li>Wasmtime is doing unneeded work while validating the arguments, and/or converting them to UTF-8<br>\n</li>\n</ol>\n</blockquote>",
        "id": 300583252,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664053723
    },
    {
        "content": "<p>quasis labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>Running a WASM file with a binary argument, such as:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">hmac_md5_128</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">printf</span><span class=\"w\"> </span><span class=\"s\">\"\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\"</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"s\">\"String to hash\"</span><span class=\"w\"></span>\n</code></pre></div>\n<p>or</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">hmac_md5_128</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">printf</span><span class=\"w\"> </span><span class=\"s\">\"\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\"</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"s\">\"String to hash\"</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Aborts execution with the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">Invalid</span><span class=\"w\"> </span><span class=\"n\">UTF</span><span class=\"o\">-</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I see three problems with this:</p>\n<ol>\n<li>There is no standard I'm aware of that requires the arguments to be textual</li>\n<li>There is no standard that requires them to be UTF-8 encoded</li>\n<li>Wasmtime is doing unneeded work while validating the arguments, and/or converting them to UTF-8<br>\n</li>\n</ol>\n</blockquote>",
        "id": 300583253,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664053723
    },
    {
        "content": "<p>quasis edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>Running a WASM file with a binary argument, such as:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">hmac_md5</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">printf</span><span class=\"w\"> </span><span class=\"s\">\"\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\"</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"s\">\"String to hash\"</span><span class=\"w\"></span>\n</code></pre></div>\n<p>or</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">hmac_md5</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">printf</span><span class=\"w\"> </span><span class=\"s\">\"\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\\xaa\"</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"s\">\"String to hash\"</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Aborts execution with the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">Invalid</span><span class=\"w\"> </span><span class=\"n\">UTF</span><span class=\"o\">-</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I see three problems with this:</p>\n<ol>\n<li>There is no standard I'm aware of that requires the arguments to be textual</li>\n<li>There is no standard that requires them to be UTF-8 encoded</li>\n<li>Wasmtime is doing unneeded work while validating the arguments, and/or converting them to UTF-8<br>\n</li>\n</ol>\n</blockquote>",
        "id": 300583529,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664053929
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1257072280\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>Arguments are text, not binary data. For example on Windows it has to transcode from UTF-16 (as provided by the OS) to UTF-8 (as expected by wasi programs) Additionally null bytes are not allowed in arguments on Windows and Unix as they indicate the end of the argument (on Unix) or the end of the entire commandline (on Windows).</p>\n</blockquote>",
        "id": 300587362,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664056880
    },
    {
        "content": "<p>quasis <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1257074684\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>I believe we have to differentiate between two types of arguments here: arguments to wasmtime itself and arguments to the executed program. The program in its minimal variant will look like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">int</span><span class=\"w\"></span>\n<span class=\"n\">main</span><span class=\"p\">(</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">argc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">argv</span><span class=\"p\">[])</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"c1\">// parse 2nd type of arguments here and convert them to whatever encoding necessary,</span>\n<span class=\"w\">    </span><span class=\"c1\">// or fail if encoding doesn't fit the design</span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Right now wasmtime is forcing UTF-8 arguments on the program itself, which is IMHO quite limiting for the program (if done by design).<br>\n</p>\n</blockquote>",
        "id": 300588604,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664058018
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1257134209\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>If you want the program to run on Windows, UTF-16 to UTF-8 conversion has to be done one way or another as wasi programs don't know the host architecture.</p>\n</blockquote>",
        "id": 300614113,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664088848
    },
    {
        "content": "<p>sunfishcode <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1257249590\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>Also, command-line arguments are already not suitable for passing arbitrary binary data, because they're passed to C programs as NUL-terminated strings, so they can't contain embedded 0 bytes. If you want to pass arbitrary binary data as arguments to programs today, I suggest using an escape or quoting system, or a format like BASE64, to ensure that all the bytes are preserved.<br>\n</p>\n</blockquote>",
        "id": 300678591,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664130026
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1258102833\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>I believe there's a bug here where the <code>wasmtime</code> executable shouldn't panic on invalid-utf-8, but otherwise I agree with others that your program shouldn't rely on being able to receive arbitrary bytes as arguments.</p>\n<p>Additionally the <code>wasmtime</code> CLI has no way of actually communicating this argument to the program at this time. The <code>wasmtime</code> cli can only invoke functions which take numbers as input, which means that even if this were accepted it wouldn't end up doing anything.</p>\n</blockquote>",
        "id": 300822882,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664201513
    },
    {
        "content": "<p>quasis <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1258359938\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>I believe we're concentrating on the wrong side of the coin. Binary arguments are useful for unit tests, where you fully control the environment, know the limitations, and want as little opcodes as possible between the essence of the test and the environment.</p>\n<p>The other side of the coin is the forceful conversion of arguments to the UTF-8 encoding, which is a rather large constraint IMHO considering the zoo of character encodings out there. Perhaps the problem with UTF-16 on Windows, which as I understand is the main reason for conversion to UTF-8, can be solved some other way?</p>\n<p>p.s. There is a relevant discussion on the SG-16 group page: <a href=\"https://github.com/sg16-unicode/sg16/issues/66\">https://github.com/sg16-unicode/sg16/issues/66</a>, it seems they aim to solve the same problem that we're facing?</p>\n</blockquote>",
        "id": 300862285,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664212321
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1258375860\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<blockquote>\n<p>Binary arguments are useful for unit tests, where you fully control the environment, know the limitations, and want as little opcodes as possible between the essence of the test and the environment.</p>\n</blockquote>\n<p>On Windows, binary arguments would have to have a multiple-of-two size as the argument list consist of a single 16bit character list. In addition on Windows the program itself it responsible for parsing the argument list from a single string into however many arguments the user intended to parse. This is not the responsibility of the shell like on Unix. This means that if your binary argument contains a space character, it would either cause two arguments to be passed, or you would need to escape it, which doesn't really work well with binary arguments I would think.</p>\n<blockquote>\n<p>The other side of the coin is the forceful conversion of arguments to the UTF-8 encoding, which is a rather large constraint IMHO considering the zoo of character encodings out there.</p>\n</blockquote>\n<p>How would you suggest making wasi programs agnostic to the character encoding without forcefully converting from and to UTF-8 at the boundary between the wasi program and the runtime? On Windows the A variants of all system api's have a behavior depending on the system character set, which wasi programs can't query and even if it could, now wasi programs would need to ship with huge tables translating between every possible character set and whatever encoding it uses internally (like UTF-8).</p>\n</blockquote>",
        "id": 300864776,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664213167
    },
    {
        "content": "<p>quasis <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1258449489\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<blockquote>\n<p>How would you suggest making wasi programs agnostic to the character encoding without forcefully converting from and to UTF-8 at the boundary between the wasi program and the runtime?</p>\n</blockquote>\n<p>Perhaps a flag to wasmtime, which defaults to UTF-8? Something like:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">default</span><span class=\"o\">-</span><span class=\"n\">encoding</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">system</span><span class=\"o\">|</span><span class=\"n\">utf</span><span class=\"o\">-</span><span class=\"mi\">8</span><span class=\"o\">|..</span><span class=\"p\">.]</span><span class=\"w\"></span>\n</code></pre></div>\n<p>This was the first thing I was looking for after facing the problem the first time. It might not be perfect, but at least intuitive. :)</p>\n</blockquote>",
        "id": 300877335,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664217327
    },
    {
        "content": "<p>sunfishcode <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1258459347\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<blockquote>\n<p>I believe we're concentrating on the wrong side of the coin. Binary arguments are useful for unit tests, where you fully control the environment, know the limitations, and want as little opcodes as possible between the essence of the test and the environment.</p>\n</blockquote>\n<p>For a truly minimal unit test, could you use the embedding API, instead of the CLI? Command-line arguments involve quite a lot of code, on both the host side and in wasm, even ignoring the character encoding issues. With the embedding API, you can have a function that takes an array of <code>u8</code> directly, which would avoid the whole question about string encodings, and avoid all the command-line argument code too.<br>\n</p>\n</blockquote>",
        "id": 300878873,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664217903
    },
    {
        "content": "<p>quasis <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1258655104\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<blockquote>\n<p>For a truly minimal unit test, could you use the embedding API, instead of the CLI? Command-line arguments involve quite a lot of code, on both the host side and in wasm, even ignoring the character encoding issues. With the embedding API, you can have a function that takes an array of <code>u8</code> directly, which would avoid the whole question about string encodings, and avoid all the command-line argument code too.</p>\n</blockquote>\n<p>I definitely agree with your reasoning. My only comment on that, is that Linux CLI is based on a mature code-base and provides a \"battle-proven\" solution for almost any upstream/downstream problem, while embedding API almost always lacks an \"in-house\" solution and requires a third partly library, that is generally either not mature enough or not maintained for years. So there are advantages and disadvantages in both approaches.</p>\n</blockquote>",
        "id": 300902908,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664227798
    },
    {
        "content": "<p>sunfishcode <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954#issuecomment-1259763867\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4954\">issue #4954</a>:</p>\n<blockquote>\n<p>I'm a little unclear about what you're referring to. When I say embedding API, II mean Wasmtime's embedding API: <a href=\"https://docs.wasmtime.dev/lang.html\">https://docs.wasmtime.dev/lang.html</a></p>\n<p>I can also mention that the current direction for WASI is that it will define command-line arguments to be Unicode strings. While it may be useful in some unit-test-like use cases to let users that know how the host environment works to take advantage of it, the goal in many real-world wasm use cases is to have modules that <em>don't</em> know the environment, and don't interact with the \"system\" character encoding, because such knowledge would make them less portable.</p>\n<p>This only applies to things which are called \"strings\", which includes command-line arguments. If you have APIs that take <code>u8</code>s, you'll always be able to pass arbitrary bytes through.<br>\n</p>\n</blockquote>",
        "id": 301056657,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1664296376
    }
]