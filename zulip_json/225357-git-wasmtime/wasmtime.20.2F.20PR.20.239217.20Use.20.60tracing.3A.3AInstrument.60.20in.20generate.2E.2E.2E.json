[
    {
        "content": "<p><strong>swlynch99</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a>.</p>",
        "id": 468915153,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725915600
    },
    {
        "content": "<p><strong>swlynch99</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a>.</p>",
        "id": 468915154,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725915601
    },
    {
        "content": "<p>swlynch99 opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a> from <code>swlynch99:wit-bindgen-span-fix</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<p>This PR fixes #9210.</p>\n<p>Previously, if we had a WIT file with a function</p>\n<div class=\"codehilite\" data-code-language=\"wit\"><pre><span></span><code>async-fn: func();\n</code></pre></div>\n<p>then the generated code in <code>add_to_linker_get_host</code> would look like this (if tracing is enabled and the function is async)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">inst</span><span class=\"p\">.</span><span class=\"n\">func_wrap_async</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s\">\"my-func\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">caller</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">StoreContextMut</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">():</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">__internal</span><span class=\"p\">::</span><span class=\"nb\">Box</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">span</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"s\">\"wit-bindgen import\"</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"test\"</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"my-func\"</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_enter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">span</span><span class=\"p\">.</span><span class=\"n\">enter</span><span class=\"p\">();</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">event</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"call\"</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">host</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">host_getter</span><span class=\"p\">(</span><span class=\"n\">caller</span><span class=\"p\">.</span><span class=\"n\">data_mut</span><span class=\"p\">());</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"p\">::</span><span class=\"n\">my_func</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">event</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">field</span><span class=\"p\">::</span><span class=\"n\">debug</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">r</span><span class=\"p\">),</span>\n<span class=\"w\">                </span><span class=\"s\">\"return\"</span>\n<span class=\"w\">            </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">})</span>\n<span class=\"w\">    </span><span class=\"p\">},</span>\n<span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>This keeps the tracing span active, even when the resulting future is suspended. The end result is that other unrelated tokio tasks running on the same thread in the meantime will be shown as executing within the <code>wit-bindgen import</code> span.</p>\n<p>This commit changes the codegen to instead generate</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">inst</span><span class=\"p\">.</span><span class=\"n\">func_wrap_async</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s\">\"async-fn\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">caller</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">StoreContextMut</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">():</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Instrument</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">span</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"s\">\"wit-bindgen import\"</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"test\"</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"async-fn\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">__internal</span><span class=\"p\">::</span><span class=\"nb\">Box</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">event</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"call\"</span><span class=\"p\">);</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">host</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">host_getter</span><span class=\"p\">(</span><span class=\"n\">caller</span><span class=\"p\">.</span><span class=\"n\">data_mut</span><span class=\"p\">());</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"p\">::</span><span class=\"n\">async_fn</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">event</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                    </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span>\n<span class=\"w\">                    </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">field</span><span class=\"p\">::</span><span class=\"n\">debug</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">r</span><span class=\"p\">),</span>\n<span class=\"w\">                    </span><span class=\"s\">\"return\"</span>\n<span class=\"w\">                </span><span class=\"p\">);</span>\n<span class=\"w\">                </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">instrument</span><span class=\"p\">(</span><span class=\"n\">span</span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">},</span>\n<span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>Here, <code>tracing::Instrument</code> takes care of entering the span when the future is polled and exiting it when it is suspended.</p>\n<p>I have also manually verified that the codegen for sync functions remains exactly the same.</p>\n</blockquote>",
        "id": 468915155,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725915600
    },
    {
        "content": "<p>swlynch99 updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a>.</p>",
        "id": 468924765,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725919045
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217#pullrequestreview-2291033444\">PR review</a>:</p>\n<blockquote>\n<p>Thanks for this!</p>\n</blockquote>",
        "id": 468925663,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725919354
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a>.</p>",
        "id": 468925673,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725919359
    },
    {
        "content": "<p>swlynch99 edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<p>This PR fixes #9210.</p>\n<p>Previously, if we had a WIT file with a function</p>\n<div class=\"codehilite\" data-code-language=\"wit\"><pre><span></span><code>async-fn: func();\n</code></pre></div>\n<p>then the generated code in <code>add_to_linker_get_host</code> would look like this (if tracing is enabled and the function is async)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">inst</span><span class=\"p\">.</span><span class=\"n\">func_wrap_async</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s\">\"my-func\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">caller</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">StoreContextMut</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">():</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">__internal</span><span class=\"p\">::</span><span class=\"nb\">Box</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">span</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"s\">\"wit-bindgen import\"</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"test\"</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"my-func\"</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_enter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">span</span><span class=\"p\">.</span><span class=\"n\">enter</span><span class=\"p\">();</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">event</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"call\"</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">host</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">host_getter</span><span class=\"p\">(</span><span class=\"n\">caller</span><span class=\"p\">.</span><span class=\"n\">data_mut</span><span class=\"p\">());</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"p\">::</span><span class=\"n\">my_func</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">event</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">field</span><span class=\"p\">::</span><span class=\"n\">debug</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">r</span><span class=\"p\">),</span>\n<span class=\"w\">                </span><span class=\"s\">\"return\"</span>\n<span class=\"w\">            </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">})</span>\n<span class=\"w\">    </span><span class=\"p\">},</span>\n<span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>This keeps the tracing span active, even when the resulting future is suspended. The end result is that other unrelated tokio tasks running on the same thread in the meantime will be shown as executing within the <code>wit-bindgen import</code> span.</p>\n<p>This commit changes the codegen to instead generate</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">inst</span><span class=\"p\">.</span><span class=\"n\">func_wrap_async</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"s\">\"async-fn\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">caller</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">StoreContextMut</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">():</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Instrument</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">span</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"s\">\"wit-bindgen import\"</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"test\"</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"async-fn\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">__internal</span><span class=\"p\">::</span><span class=\"nb\">Box</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">event</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"call\"</span><span class=\"p\">);</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">host</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">host_getter</span><span class=\"p\">(</span><span class=\"n\">caller</span><span class=\"p\">.</span><span class=\"n\">data_mut</span><span class=\"p\">());</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"p\">::</span><span class=\"n\">async_fn</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">event</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                    </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">Level</span><span class=\"p\">::</span><span class=\"n\">TRACE</span><span class=\"p\">,</span>\n<span class=\"w\">                    </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tracing</span><span class=\"p\">::</span><span class=\"n\">field</span><span class=\"p\">::</span><span class=\"n\">debug</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">r</span><span class=\"p\">),</span>\n<span class=\"w\">                    </span><span class=\"s\">\"return\"</span>\n<span class=\"w\">                </span><span class=\"p\">);</span>\n<span class=\"w\">                </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">instrument</span><span class=\"p\">(</span><span class=\"n\">span</span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">},</span>\n<span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>Here, <code>tracing::Instrument</code> takes care of entering the span when the future is polled and exiting it when it is suspended.</p>\n<p>I have also manually verified that the codegen for sync functions remains exactly the same.</p>\n</blockquote>",
        "id": 468926699,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725919785
    },
    {
        "content": "<p>swlynch99 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217#issuecomment-2339374921\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a>:</p>\n<blockquote>\n<p>The macos wasmtime CI job seems to be stalled when running <code>cargo fetch</code>? I'm not sure what's up with that.</p>\n</blockquote>",
        "id": 468943941,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725927662
    },
    {
        "content": "<p>pchickey <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217#issuecomment-2339377804\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a>:</p>\n<blockquote>\n<p>Sometimes runners just flake, lets try it again</p>\n</blockquote>",
        "id": 468944324,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725927848
    },
    {
        "content": "<p>pchickey merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9217\">PR #9217</a>.</p>",
        "id": 468945792,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1725928706
    }
]