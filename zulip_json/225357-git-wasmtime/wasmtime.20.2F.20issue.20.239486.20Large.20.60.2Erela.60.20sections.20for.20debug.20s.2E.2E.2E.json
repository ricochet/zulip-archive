[
    {
        "content": "<p>SingleAccretion edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9486\">issue #9486</a>:</p>\n<blockquote>\n<p>Reproduction:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"o\">-</span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">-</span><span class=\"n\">level</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">with</span><span class=\"o\">-</span><span class=\"n\">di</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">llvm</span><span class=\"o\">-</span><span class=\"n\">objdump</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">with</span><span class=\"o\">-</span><span class=\"n\">di</span><span class=\"p\">.</span><span class=\"n\">cwasm</span>\n</code></pre></div>\n<p>Expected result: the output does not contain an excessive number of relocations.</p>\n<p>Actual result: there are lots of them:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">debug_abbrev</span><span class=\"w\">      </span><span class=\"mf\">000704e1</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span>\n<span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">debug_str</span><span class=\"w\">         </span><span class=\"mi\">00164</span><span class=\"n\">a48</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span>\n<span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">debug_line</span><span class=\"w\">        </span><span class=\"mi\">00247334</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span>\n<span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"n\">debug_line</span><span class=\"w\">   </span><span class=\"mi\">00055</span><span class=\"n\">ef0</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n<span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">debug_ranges</span><span class=\"w\">      </span><span class=\"mf\">0003e530</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span>\n<span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"n\">debug_ranges</span><span class=\"w\"> </span><span class=\"mi\">00097</span><span class=\"n\">fb0</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n<span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">debug_loc</span><span class=\"w\">         </span><span class=\"mf\">0062e922</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span>\n<span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"n\">debug_loc</span><span class=\"w\">    </span><span class=\"mi\">00</span><span class=\"n\">cc02a0</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n<span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">debug_info</span><span class=\"w\">        </span><span class=\"mi\">00200</span><span class=\"n\">ebf</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span>\n<span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"n\">debug_info</span><span class=\"w\">   </span><span class=\"mi\">0065</span><span class=\"n\">c958</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n<span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">debug_frame</span><span class=\"w\">       </span><span class=\"mi\">0009</span><span class=\"n\">ada8</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span>\n<span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"n\">debug_frame</span><span class=\"w\">  </span><span class=\"mi\">000</span><span class=\"n\">abe40</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n</code></pre></div>\n<p>Looking at <code>.debug_loc</code> in particular, we can see the following for the very first location list:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">llvm</span><span class=\"o\">-</span><span class=\"n\">objdump</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">rela</span><span class=\"p\">.</span><span class=\"n\">debug_loc</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">with</span><span class=\"o\">-</span><span class=\"n\">di</span><span class=\"p\">.</span><span class=\"n\">cwasm</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">rel</span><span class=\"p\">.</span><span class=\"n\">txt</span>\n\n<span class=\"n\">RELOCATION</span><span class=\"w\"> </span><span class=\"n\">RECORDS</span><span class=\"w\"> </span><span class=\"n\">FOR</span><span class=\"w\"> </span><span class=\"p\">[.</span><span class=\"n\">debug_loc</span><span class=\"p\">]:</span>\n<span class=\"nc\">OFFSET</span><span class=\"w\">           </span><span class=\"n\">TYPE</span><span class=\"w\">                     </span><span class=\"n\">VALUE</span>\n<span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x26</span>\n<span class=\"mi\">0000000000000008</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x5b</span>\n<span class=\"mi\">0000000000000013</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x5b</span>\n<span class=\"mi\">000000000000001</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x68</span>\n<span class=\"mi\">0000000000000026</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x68</span>\n<span class=\"mi\">000000000000002</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x91</span>\n<span class=\"mi\">0000000000000049</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x73</span>\n<span class=\"mi\">0000000000000051</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x81</span>\n<span class=\"mi\">000000000000005</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x81</span>\n<span class=\"mi\">0000000000000064</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_64</span><span class=\"w\">              </span><span class=\"n\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"p\">]::</span><span class=\"n\">_start</span><span class=\"o\">+</span><span class=\"mh\">0x88</span>\n</code></pre></div>\n<p>The debug info and code are part of the same 'object file' - much of this should be unnecessary.</p>\n</blockquote>",
        "id": 477841430,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1729375257
    }
]