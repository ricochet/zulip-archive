[
    {
        "content": "<p>ShuyaoJiang opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7732\">issue #7732</a>:</p>\n<blockquote>\n<h3>Summary</h3>\n<p>Hi, I ran the attached case (C program, compiled to Wasm by <code>Emscripten</code>) in different Wasm runtimes, and found abnormal performance in <code>Wasmtime</code> compared with other runtimes. The execution time of this case (time interval from the start to the end of the execution of Wasm bytecode running command) on different runtimes is as follows:</p>\n<ul>\n<li>Wasmtime: 136ms</li>\n<li>WasmEdge (AOT): 16ms</li>\n<li>WAMR (AOT): 11ms</li>\n</ul>\n<p>We found that in most other test cases, Wasmtime can achieve similar performance (1-2x) with the other two runtimes. However, in this case, Wasmtime is about 10x slower than the other two runtimes.</p>\n<h4>Emscripten</h4>\n<ul>\n<li>emcc (Emscripten gcc/clang-like replacement + linker emulating GNU ld) 3.1.49 (04a0cad4d4c9f5d62876821274d78cd0a52427af)<br>\nclang version 18.0.0 (<a href=\"https://github.com/llvm/llvm-project\">https://github.com/llvm/llvm-project</a> 269685545e439ad050b67740533c59f965cae955)<br>\nTarget: wasm32-unknown-emscripten<br>\nThread model: posix</li>\n</ul>\n<h4>Wasm Runtime Version</h4>\n<ul>\n<li>Wasmtime: cli 15.0.0</li>\n<li>WasmEdge: 0.13.5</li>\n<li>WAMR: 1.2.3</li>\n</ul>\n<h4>Hardware &amp; OS</h4>\n<ul>\n<li>CPU: Intel(R) Xeon(R) E5-2686 v4 CPU @ 2.30GHz</li>\n<li>Memory: 16GB</li>\n<li>OS: Ubuntu 20.04.6 LTS</li>\n</ul>\n<h3>Additional details</h3>\n<p>The attached source program is synthesized by a <a href=\"https://github.com/csmith-project/csmith\">Csmith</a> seed and a code snippet from another program. The inserted code snippet is on lines <code>2370-2375</code> of the source program, which is a loop accessing a pointer to a constant (the code snippet is attached below). So, we think that this abnormal performance may be caused by some improper handling when accessing such pointers to constant. Could you please check this situation? Thank you!</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">print_hash_value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">print_hash_value</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">print_hash_value</span><span class=\"p\">)</span>\n<span class=\"p\">{</span><span class=\"w\"> </span><span class=\"cm\">/* block id: 394 */</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"o\">*</span><span class=\"n\">g_1123</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/13787307/1702378284212.zip\">1702378284212.zip</a><br>\n</p>\n</blockquote>",
        "id": 410302914,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1703774457
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7732#issuecomment-1874479936\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7732\">issue #7732</a>:</p>\n<blockquote>\n<p>Thanks for the bug report.</p>\n<p>Similar to the other issue you filed, can you separate timing of the compilation and execution phases and let us know whether execution is still 10x slower than others?</p>\n<p>Thanks!</p>\n</blockquote>",
        "id": 410897692,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1704225338
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7732#issuecomment-1909132554\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7732\">issue #7732</a>:</p>\n<blockquote>\n<p>I've taken a look at this locally (thanks for the report!) and I've used this script</p>\n<p>&lt;details&gt;</p>\n<p>&lt;summary&gt;&lt;code&gt;run.mjs&lt;/code&gt;&lt;/summary&gt;</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"k\">import</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nx\">readFile</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"kr\">from</span><span class=\"w\"> </span><span class=\"s1\">'node:fs/promises'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nx\">WASI</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"kr\">from</span><span class=\"w\"> </span><span class=\"s1\">'wasi'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nx\">argv</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"kr\">from</span><span class=\"w\"> </span><span class=\"s1\">'node:process'</span><span class=\"p\">;</span>\n\n<span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"ow\">new</span><span class=\"w\"> </span><span class=\"nx\">WASI</span><span class=\"p\">({</span>\n<span class=\"w\">  </span><span class=\"nx\">version</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s1\">'preview1'</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nx\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">argv</span><span class=\"p\">.</span><span class=\"nx\">slice</span><span class=\"p\">(</span><span class=\"mf\">2</span><span class=\"p\">),</span>\n<span class=\"p\">});</span>\n\n<span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">m</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">argv</span><span class=\"p\">[</span><span class=\"mf\">2</span><span class=\"p\">];</span>\n<span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">wasm</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">await</span><span class=\"w\"> </span><span class=\"nx\">WebAssembly</span><span class=\"p\">.</span><span class=\"nx\">compile</span><span class=\"p\">(</span><span class=\"k\">await</span><span class=\"w\"> </span><span class=\"nx\">readFile</span><span class=\"p\">(</span><span class=\"nx\">m</span><span class=\"p\">));</span>\n<span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">obj</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">wasi</span><span class=\"p\">.</span><span class=\"nx\">getImportObject</span><span class=\"p\">();</span>\n<span class=\"nx\">obj</span><span class=\"p\">.</span><span class=\"nx\">env</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nx\">memory</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"ow\">new</span><span class=\"w\"> </span><span class=\"nx\">WebAssembly</span><span class=\"p\">.</span><span class=\"nx\">Memory</span><span class=\"p\">({</span><span class=\"nx\">shared</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">initial</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">8000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">maximum</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">16000</span><span class=\"p\">}),</span>\n<span class=\"p\">};</span>\n<span class=\"nx\">obj</span><span class=\"p\">.</span><span class=\"nx\">wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"s1\">'thread-spawn'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kd\">function</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">throw</span><span class=\"w\"> </span><span class=\"ow\">new</span><span class=\"w\"> </span><span class=\"ne\">Error</span><span class=\"p\">(</span><span class=\"s1\">'wasi thread spawn'</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"p\">};</span>\n<span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">await</span><span class=\"w\"> </span><span class=\"nx\">WebAssembly</span><span class=\"p\">.</span><span class=\"nx\">instantiate</span><span class=\"p\">(</span><span class=\"nx\">wasm</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">obj</span><span class=\"p\">);</span>\n\n<span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">initial</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">performance</span><span class=\"p\">.</span><span class=\"nx\">now</span><span class=\"p\">();</span>\n<span class=\"nx\">wasi</span><span class=\"p\">.</span><span class=\"nx\">start</span><span class=\"p\">(</span><span class=\"nx\">instance</span><span class=\"p\">);</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">performance</span><span class=\"p\">.</span><span class=\"nx\">now</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"nx\">initial</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>to compare Wasmtime and node (as those were the easiest comparisons I could get on hand). </p>\n<p>I added a little instrumentation to <code>wasmtime run</code> and I got Node executing this function in 1.2ms and Wasmtime was in 400us. Given that I don't think that this is related to runtime, so I would instead also be interested in what @fitzgen of seeing if the timing for Wasmtime included the compilation to native for the Wasm module.</p>\n<p>Now that being said if Cranelift takes 100ms to compile something that LLVM compiles in 10ms that's also a bug, so still interested in this!</p>\n</blockquote>",
        "id": 417985670,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706141536
    }
]