[
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1318070718\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @peterhuene</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"cranelift\", \"cranelift:wasm\", \"wasmtime:api\", \"wasmtime:config\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>peterhuene: wasmtime:api</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 310545094,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1668660597
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1318070886\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<h4>Label Messager: wasmtime:config</h4>\n<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>\ncomplete this check list:</p>\n<ul>\n<li>\n<p>[ ] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>\n      it.</p>\n<p>&lt;details&gt;</p>\n<p>Our documentation should be of the following form:</p>\n<p>```text<br>\nShort, simple summary sentence.</p>\n<p>More details. These details can be multiple paragraphs. There should be<br>\ninformation about not just the method, but its parameters and results as<br>\nwell.</p>\n<p>Is this method fallible? If so, when can it return an error?</p>\n<p>Can this method panic? If so, when does it panic?</p>\n<h1>Example</h1>\n<p>Optional example here.<br>\n```</p>\n<p>&lt;/details&gt;</p>\n</li>\n<li>\n<p>[ ] If you added a new <code>Config</code> method, or modified an existing one, you<br>\n  ensured that this configuration is exercised by the fuzz targets.</p>\n<p>&lt;details&gt;</p>\n<p>For example, if you expose a new strategy for allocating the next instance<br>\nslot inside the pooling allocator, you should ensure that at least one of our<br>\nfuzz targets exercises that new strategy.</p>\n<p>Often, all that is required of you is to ensure that there is a knob for this<br>\nconfiguration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>\nof its nested <code>struct</code>s).</p>\n<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>\nconfiguration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>\n<p>&lt;/details&gt;</p>\n</li>\n<li>\n<p>[ ] If you are enabling a configuration option by default, make sure that it<br>\n  has been fuzzed for at least two weeks before turning it on by default.</p>\n</li>\n</ul>\n<p>[fuzzing-config]: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194\">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>\n[fuzzing-docs]: <a href=\"https://docs.wasmtime.dev/contributing-fuzzing.html\">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>\n<hr>\n<p>&lt;details&gt;</p>\n<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>\n<p>To add new label messages or remove existing label messages, edit the<br>\n&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/label-messager-action\">Learn more.</a></p>\n<p>&lt;/details&gt;</p>\n</blockquote>",
        "id": 310545144,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1668660609
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1318348142\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<p>call_ref is simply translated as a cranelift indirect_call. A faster cranelift indirect call that does not check the callee signature can (and should) eventually be added and used. Further, no null check is elided.</p>\n</blockquote>\n<p>call_indirect doesn't check the function signature, nor does it check for null pointers.</p>\n</blockquote>",
        "id": 310573571,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1668677750
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1441885473\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>I'm interested in resuming work on this patch and dedicating the necessary time to bring it into an acceptable state. I have a patch which merges this PR with the recent changes to <code>main</code> (c.f. <a href=\"https://github.com/effect-handlers/wasmtime/issues/13\">effect-handlers/wasmtime#13</a>). I will merge that patch into this PR later today.</p>\n<p>I think the current status is as follows:</p>\n<ul>\n<li>Compatible with latest wasm-tools</li>\n<li>All new function reference instructions have been implemented (save for <code>return_call_ref</code>) (tested on x86_64).</li>\n<li>10 test case failures:</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">failures</span>:\n    <span class=\"nc\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">br_table</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">br_table_pooling</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">linking</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">linking_pooling</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">return_call_ref</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">return_call_ref_pooling</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">table</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">table_pooling</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">type_equivalence</span>\n<span class=\"w\">    </span><span class=\"n\">wast</span>::<span class=\"n\">Cranelift</span>::<span class=\"n\">spec</span>::<span class=\"n\">function_references</span>::<span class=\"n\">type_equivalence_pooling</span>\n\n<span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">result</span>: <span class=\"nc\">FAILED</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"mi\">872</span><span class=\"w\"> </span><span class=\"n\">passed</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">ignored</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">measured</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">finished</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">77.91</span><span class=\"n\">s</span>\n</code></pre></div>\n<p>Here <code>return_call_ref</code> is expected to fail as we have not implemented the tail calls proposal. I haven't worked out why <code>linking</code> and <code>type_equivalence</code> fail yet. The test <code>br_table</code> fails because of how the <code>wast</code> crate of <code>wasm-tools</code> elaborates single element tables</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t</span> <span class=\"p\">(</span><span class=\"k\">func</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$tf</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">table</span> <span class=\"nv\">$t</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"err\">null</span> <span class=\"nv\">$t</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"k\">elem</span> <span class=\"nv\">$tf</span><span class=\"p\">)))</span>\n</code></pre></div>\n<p>The <code>table</code> test fails due to the incompleteness of the type reconstruction procedure <code>wasmtime::values::Val::ty()</code>. The procedure has to infer the nullability of an <code>ExternRef</code> or <code>FuncRef</code> by looking at their respective shape, which is impossible.</p>\n<p>I will probably need some help with this latter issue as it seems to require a slight redesign/refactor to keep source value type information around, at least in the <code>wast</code> crate of wasmtime. I will probably also need some help with diagnosing the remaining failure cases. I am also positive that there are several code quality improvements that need to be implemented in order to make this PR satisfactory.</p>\n</blockquote>",
        "id": 329731864,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1677162275
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1507429885\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>This review got auto-assigned to me but I think @fitzgen and @alexcrichton have the right context for the review here.</p>\n</blockquote>",
        "id": 349183027,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681410163
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1514746801\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>@alexcrichton @fitzgen I have reverted the changes to the wasmtime public API. The end result is not too bad; there are a couple of more test failures now. I haven't looked into the failures in detail yet.</p>\n</blockquote>",
        "id": 351050728,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681911279
    },
    {
        "content": "<p>dhil edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1514746801\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>@alexcrichton @fitzgen I have reverted the changes to the wasmtime public API. The end result is not too bad; there are a couple of more test failures now. I haven't looked into the failures in detail yet.</p>\n<p>If you want I can reopen this PR from my personal fork such that you can get write permissions. I think GitHub do not grant write permissions on PRs originating from an organisation account.</p>\n</blockquote>",
        "id": 351051785,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681911508
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1515099901\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>Some things I'm seeing:</p>\n<ul>\n<li>I sent <a href=\"https://github.com/effect-handlers/wasmtime/pull/19\">https://github.com/effect-handlers/wasmtime/pull/19</a> to surface the failures here on this PR</li>\n<li>One test failure, <code>wast::Cranelift::spec::function_references::linking</code>, relates to <a href=\"https://github.com/bytecodealliance/wasmtime/blob/ef7af28ef095277f5979dcbc6ff03964c1e0ba12/crates/wasmtime/src/types/matching.rs#L183-L193\">this function</a> which needs to be souped up for typed function references. Note though that this function will need to grow <code>&amp;ModuleTypes</code> arguments to perform the subtyping check between two different modules (this is basically the same code that's in <code>wasmparser</code>, just at link-time instead of validation-time).</li>\n<li><code>wast::Cranelift::spec::function_references::table</code> looks like it may be a bug in table initialization?</li>\n<li><code>wast::Cranelift::spec::function_references::br_table</code> is failing due to <a href=\"https://github.com/bytecodealliance/wasm-tools/pull/952\">https://github.com/bytecodealliance/wasm-tools/pull/952</a> I think</li>\n<li><code>wast::Cranelift::spec::function_references::type_equivalence</code> looks like it may be some sort of code generator bug? Unsure.</li>\n</ul>\n<p>There are additionally a number of tests as you've found which all panic due to the one you inserted to avoid changes to the public API. Those tests will need to be skipped as-is from the upstream testsuite, but they can be copied to to <code>tests/misc_testsuite</code> with updates to run in Wasmtime.</p>\n</blockquote>",
        "id": 351111171,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681924920
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1516534670\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<p>Some things I'm seeing:</p>\n<div class=\"codehilite\"><pre><span></span><code>* I sent [Get more CI passing effect-handlers/wasmtime#19](https://github.com/effect-handlers/wasmtime/pull/19) to surface the failures here on this PR\n\n* One test failure, `wast::Cranelift::spec::function_references::linking`, relates to [this function](https://github.com/bytecodealliance/wasmtime/blob/ef7af28ef095277f5979dcbc6ff03964c1e0ba12/crates/wasmtime/src/types/matching.rs#L183-L193) which needs to be souped up for typed function references. Note though that this function will need to grow `&amp;ModuleTypes` arguments to perform the subtyping check between two different modules (this is basically the same code that&#39;s in `wasmparser`, just at link-time instead of validation-time).\n\n* `wast::Cranelift::spec::function_references::table` looks like it may be a bug in table initialization?\n\n* `wast::Cranelift::spec::function_references::br_table` is failing due to [Support for Wast table initialisation syntactic sugar with typeful references wasm-tools#952](https://github.com/bytecodealliance/wasm-tools/pull/952) I think\n\n* `wast::Cranelift::spec::function_references::type_equivalence` looks like it may be some sort of code generator bug? Unsure.\n</code></pre></div>\n\n<p>There are additionally a number of tests as you've found which all panic due to the one you inserted to avoid changes to the public API. Those tests will need to be skipped as-is from the upstream testsuite, but they can be copied to to <code>tests/misc_testsuite</code> with updates to run in Wasmtime.</p>\n</blockquote>\n<p>Excellent, thank you! I am down to two failures now <code>type_equivalence</code> and <code>table</code>.</p>\n</blockquote>",
        "id": 351359622,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682004457
    },
    {
        "content": "<p>dhil edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1516534670\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>Excellent, thank you! I am down to two failures now <code>type_equivalence</code> and <code>table</code>.</p>\n<blockquote>\n<p>There are additionally a number of tests as you've found which all panic due to the one you inserted to avoid changes to the public API. Those tests will need to be skipped as-is from the upstream testsuite, but they can be copied to to <code>tests/misc_testsuite</code> with updates to run in Wasmtime.</p>\n</blockquote>\n<p>I will move some of the content of the ignored tests to the misc testsuite too.</p>\n</blockquote>",
        "id": 351359858,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682004496
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1532758696\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>I have been trying to track down the remaining two failures. In the <code>table.wast</code> file, the problem is that tables aren't properly initialised. Looking at the code it indeed seems like table initialisers get ignored altogether (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/module_environ.rs#L303-L307\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/environ/src/module_environ.rs#L303-L307</a>), which would explain why table entries always seem to be initialised to <code>null</code> (c.f. <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/instance.rs#L872-L874\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/runtime/src/instance.rs#L872-L874</a>). From reading the code, I understand that great care is being taken to ensure lazy initialisation of tables, and thus, I wonder what semantics you want for tables with initialising expressions? @alexcrichton @fitzgen </p>\n</blockquote>",
        "id": 355382534,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683108104
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1533510312\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<p>Looking at the code it indeed seems like table initialisers get ignored altogether</p>\n</blockquote>\n<p>Indeed! Table intializers were added with the function-references proposal so that's why they're \"ignored\". When we updated <code>wasmparser</code> we probably should have made it an error if a non-null initializer was indicated.</p>\n<p>I think what you'll want to do is to update <code>TableInitialization</code> to store the default initializer and then update <code>try_func_table_init</code> to not use <code>FuncTable</code> if there's a non-null initializer. We can probably lazy-initialize with initializers but that's fine to to in a future PR. It's probably best to get the base set of functionality working first.</p>\n</blockquote>",
        "id": 355577999,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683138429
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1549335620\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>Commit 5de9a246fc0c8a0b9ae7a4a60b2ce74cceba86ce implements a fix for the table initialisation problem, though, it is ended up a bit more roundabout than I initially anticipated. If I understand correctly, <code>TableInitialization</code> is global per module, so to avoid penalising pre-function-references code I introduced a new table initialisation strategy <code>EagerFuncTable</code>, which eagerly initialises all table fields. I am not sure whether this aligns with what you had in mind.</p>\n<p>As for the final failing test <code>type-equivalence</code>, it fails, seemingly, because the type test for <code>call_indirect</code> is nominal rather than structural (c.f. <a href=\"https://github.com/bytecodealliance/wasmtime/blob/6dc3eb717d7cf9b3539557ea7b393dd51225336d/crates/cranelift/src/func_environ.rs#L1662C1-L1665\">https://github.com/bytecodealliance/wasmtime/blob/6dc3eb717d7cf9b3539557ea7b393dd51225336d/crates/cranelift/src/func_environ.rs#L1662C1-L1665</a>). Here is a minimal example to reproduce:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s0</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s1</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s0</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s1</span><span class=\"p\">))))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$s1</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">table</span> <span class=\"k\">funcref</span> <span class=\"p\">(</span><span class=\"k\">elem</span> <span class=\"nv\">$s1</span><span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"run\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"nb\">call_indirect</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"err\">ref.</span><span class=\"k\">func</span> <span class=\"nv\">$s1</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">0</span><span class=\"p\">))</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"err\">assert_</span><span class=\"nb\">return</span> <span class=\"p\">(</span><span class=\"err\">invoke</span> <span class=\"s2\">\"run\"</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>I am not quite sure what the best course of action is here. I would have expected type/type signature canonicalisation to solve this problem.</p>\n</blockquote>",
        "id": 358673668,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684230082
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1549914494\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<p>which eagerly initialises all table fields. I am not sure whether this aligns with what you had in mind.</p>\n</blockquote>\n<p>Seems reasonable to me! One adjustment I might recommend though is to reuse the existing <code>TableInitialization::Segments</code> initializer. That's the \"eager\" mode which is optimized, if possible, to <code>TableInitialization::FuncTable</code> which is lazy initialization. During that optimization you can add a check that if anything is not null-initialized then the optimization can be skipped. I think this'll all have the same effect as what you've implemented but avoids <code>EagerTableInitializer</code> and <code>Segments</code> being sort of duplicates of each other.</p>\n<p>I'll look more into the <code>call_indirect</code> issue now.</p>\n</blockquote>",
        "id": 358772098,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684251546
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1549930882\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>Ok so I can definitely imagine that canonicalization has a bug in it and something isn't working as expected. My guess is that something is hashing a module-local u32 when it actually needs to hash something module-independent, or something like that. </p>\n<p>That being said I'm not sure that your reduction showcases the issue? You're invoking, indirectly, a function that takes two parameters with only one parameter. In that sense I think a runtime error is expected there?</p>\n</blockquote>",
        "id": 358775058,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684252176
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551349261\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<p>Ok so I can definitely imagine that canonicalization has a bug in it and something isn't working as expected. My guess is that something is hashing a module-local u32 when it actually needs to hash something module-independent, or something like that.</p>\n<p>That being said I'm not sure that your reduction showcases the issue? You're invoking, indirectly, a function that takes two parameters with only one parameter. In that sense I think a runtime error is expected there?</p>\n</blockquote>\n<p>Ah yes, sorry. I deleted a little bit too much. Here is a (valid) repro:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s0</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s1</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s0</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s2</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s0</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s1</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t2</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s2</span><span class=\"p\">))))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$s1</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$f1</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$f2</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t2</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">table</span> <span class=\"k\">funcref</span> <span class=\"p\">(</span><span class=\"k\">elem</span> <span class=\"nv\">$f1</span> <span class=\"nv\">$f2</span> <span class=\"nv\">$s1</span><span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"run\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"nb\">call_indirect</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"err\">ref.</span><span class=\"k\">func</span> <span class=\"nv\">$s1</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<p>It is extracted from <code>type-equivalence.wast</code>, the <code>;; Indirect types</code> section.</p>\n</blockquote>",
        "id": 358977341,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684328433
    },
    {
        "content": "<p>dhil edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551349261\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<p>Ok so I can definitely imagine that canonicalization has a bug in it and something isn't working as expected. My guess is that something is hashing a module-local u32 when it actually needs to hash something module-independent, or something like that.</p>\n<p>That being said I'm not sure that your reduction showcases the issue? You're invoking, indirectly, a function that takes two parameters with only one parameter. In that sense I think a runtime error is expected there?</p>\n</blockquote>\n<p>Ah yes, sorry. I deleted a little bit too much. Here is a (valid) repro:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s0</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s1</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s0</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s2</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s0</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s1</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t2</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s2</span><span class=\"p\">))))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$s1</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$f1</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$f2</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t2</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">table</span> <span class=\"k\">funcref</span> <span class=\"p\">(</span><span class=\"k\">elem</span> <span class=\"nv\">$f1</span> <span class=\"nv\">$f2</span> <span class=\"nv\">$s1</span><span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"run\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"nb\">call_indirect</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"err\">ref.</span><span class=\"k\">func</span> <span class=\"nv\">$s1</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"err\">assert_</span><span class=\"nb\">return</span> <span class=\"p\">(</span><span class=\"err\">invoke</span> <span class=\"s2\">\"run\"</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>It is extracted from <code>type-equivalence.wast</code>, the <code>;; Indirect types</code> section.</p>\n</blockquote>",
        "id": 358977452,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684328458
    },
    {
        "content": "<p>dhil edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551349261\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<p>Ok so I can definitely imagine that canonicalization has a bug in it and something isn't working as expected. My guess is that something is hashing a module-local u32 when it actually needs to hash something module-independent, or something like that.</p>\n<p>That being said I'm not sure that your reduction showcases the issue? You're invoking, indirectly, a function that takes two parameters with only one parameter. In that sense I think a runtime error is expected there?</p>\n</blockquote>\n<p>Ah yes, sorry. I deleted a little bit too much. Here is a (valid) repro:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s0</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s1</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s0</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s2</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s0</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s1</span><span class=\"p\">))))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t2</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$s2</span><span class=\"p\">))))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$s1</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$s1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"nv\">$f2</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t2</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">table</span> <span class=\"k\">funcref</span> <span class=\"p\">(</span><span class=\"k\">elem</span> <span class=\"nv\">$f2</span> <span class=\"nv\">$s1</span><span class=\"p\">))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"run\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"nb\">call_indirect</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$t1</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"err\">ref.</span><span class=\"k\">func</span> <span class=\"nv\">$s1</span><span class=\"p\">)</span> <span class=\"p\">(</span><span class=\"nb\">i32.const</span> <span class=\"mi\">0</span><span class=\"p\">))</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"err\">assert_</span><span class=\"nb\">return</span> <span class=\"p\">(</span><span class=\"err\">invoke</span> <span class=\"s2\">\"run\"</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>It is extracted from <code>type-equivalence.wast</code>, the <code>;; Indirect types</code> section.</p>\n</blockquote>",
        "id": 358977682,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684328515
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551352905\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>which eagerly initialises all table fields. I am not sure whether this aligns with what you had in mind.</p>\n</blockquote>\n<p>Seems reasonable to me! One adjustment I might recommend though is to reuse the existing <code>TableInitialization::Segments</code> initializer. That's the \"eager\" mode which is optimized, if possible, to <code>TableInitialization::FuncTable</code> which is lazy initialization. During that optimization you can add a check that if anything is not null-initialized then the optimization can be skipped. I think this'll all have the same effect as what you've implemented but avoids <code>EagerTableInitializer</code> and <code>Segments</code> being sort of duplicates of each other.</p>\n<p>I'll look more into the <code>call_indirect</code> issue now.</p>\n</blockquote>\n<p>I have attempted to clean this up in the latest commit. Is this closer to what you had in mind?</p>\n</blockquote>",
        "id": 358977887,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684328565
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1551484653\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>Ok so I think the issue is in two locations:</p>\n<ul>\n<li><a href=\"https://github.com/effect-handlers/wasmtime/blob/function-references/crates/wasmtime/src/signatures.rs#L74\">Here</a> in the engine-level signature registry, which is a hash map of types across modules registered in an engine.</li>\n<li><a href=\"https://github.com/effect-handlers/wasmtime/blob/function-references/crates/environ/src/module_types.rs#L40\">Here</a> where there's a module-level map of types-to-indexes which should be deduplicating the above types but isn't.</li>\n</ul>\n<p>This bug is due to <a href=\"https://github.com/effect-handlers/wasmtime/blob/function-references/crates/types/src/lib.rs#L172\"><code>derive(Hash)</code></a> on <code>WasmFuncType</code> which delegates all the way through to <code>WasmHeapType</code> which hashes the raw index. I think the best solution would be to remove the auto-derived trait impls from <code>WasmType</code> about equality and hashing, and then work backwards from there. The raw <code>WasmHeapType::Index</code> should probably take a <code>SignatureIndex</code> to assist in deduplicating within a module. That should solve the second bullet above.</p>\n<p>The first bullet above, however, is much more difficult. That'll need to perform a \"deep hash\" of the entire structural type since it must be module-independent (and <code>SignatureIndex</code> is module-local). If the second bullet is enough to get tests passing for this PR though then that seems ok to defer to an issue and get this landed instead. </p>\n<p>(to clarify, at this point I think it's fine to land this PR so long as it passes CI, it's been long enough and I'm sure y'all are tired of rebasing. It's ok to defer work so long as there's issues on file and the work is gated, which it all is)</p>\n</blockquote>",
        "id": 358996467,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684333100
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1554388609\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>Thanks! I see the culprit now. Just to clarify, when you say</p>\n<blockquote>\n<p>The raw WasmHeapType::Index should probably take a SignatureIndex to assist in deduplicating within a module.</p>\n</blockquote>\n<p>Do you mean that <code>WasmHeapType</code> should be parameterised by a <code>SignatureIndex</code> rather than <code>u32</code>? I can see how that would make the interning easier, though, how does this affect conversion to/from <code>wasmparser</code> types?</p>\n</blockquote>",
        "id": 359616406,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684493349
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1554729088\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>No need to worry about conversion into a <code>wasmparser</code> type, that in theory shouldn't happen (or at least not that I know of). For conversion from a <code>wasmparser</code> type it may mean that a <code>From</code> impl needs to be removed in favor of a method on <code>ModuleTypes</code> or something like that where the indexing/hashing context is available.</p>\n<p>So thinking more on this, sort of what this wants is <code>WasmType&lt;T&gt;</code> where a <code>Module</code> store <code>WasmType&lt;SignatureIndex&gt;</code> but an <code>Engine</code> stores a <code>WasmType&lt;VMSharedSignatureIndex&gt;</code>. I think then the <code>derive(Hash)</code> should continue to work with <code>PartialEq</code> as well?</p>\n</blockquote>",
        "id": 359690214,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684508799
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1557031851\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>I am OK with trying this approach, but it is a sizeable refactoring I think as <code>WasmType&lt;T&gt;</code> implies a type bound on <code>Table</code>, <code>Global</code>, and <code>EntityType</code> (at least). I suppose for each of those the same logic applies: at the module level we want <code>T = SignatureIndex</code> and at the engine level <code>T = VMSharedSignatureIndex</code> (if relevant).</p>\n<p>The <code>From</code> trait will need to be removed, or at least supported by an alternative to support conversion from typed references.</p>\n<p>Should I give this refactoring a go?</p>\n</blockquote>",
        "id": 360235419,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684754081
    },
    {
        "content": "<p>dhil edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1557031851\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>I am OK with trying this approach, but it is a sizeable refactoring I think as <code>WasmType&lt;T&gt;</code> implies a type bound on <code>Table</code>, <code>Global</code>, and <code>EntityType</code> (I suppose if they are only module-local then they can instantiate <code>T = SignatureIndex</code> internally). </p>\n<p>The <code>From</code> trait will need to be removed, or at least supported by an alternative to support conversion from typed references.</p>\n<p>Should I give this refactoring a go?</p>\n</blockquote>",
        "id": 360252277,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684758338
    },
    {
        "content": "<p>CosineP <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1557467207\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>This needs to happen for typed continuations support as well.   Currently we assume everything is a function, but if we do this refactor I think we can look up in the types table whether a ref is a function or a continuation, which we need to know in a number of places in Wasmtime (at least in the embedding API; we managed to fudge the table layout stuff).   But as a result I can say firsthand it is absolutely a hefty undertaking which is why we resorted to our current hack.   I may still have a local branch with part of this refactoring underway.</p>\n</blockquote>",
        "id": 360312120,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684770577
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1557722953\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>If you're ok with it, I think it's ok to set the test to ignore and land this. It's true that this refactoring will require a bit of finesse, but it's one I'm happy to take on myself rather than having y'all do yet-more work on top of what you've already got here. </p>\n<p>Otherwise I'd be happy to merge this with a green CI run (which will require ignoring tests) and a list of items to tackle tracked in an issue (such as fixing the failing tests, this possible refactoring, the embedder API, etc)</p>\n</blockquote>",
        "id": 360350839,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684781087
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1559163707\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>I have added the test <code>type-equivalence.wast</code> to the ignore set. How should we go about documenting the issues? Should I open each issue as a separate issue here on GitHub?</p>\n</blockquote>",
        "id": 360511684,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684843805
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1559371933\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>I think one tracking issue should be good to start off with and it can branch from there as necessary. I'll work on giving this a final pass today. Thanks again for y'all's work here!</p>\n</blockquote>",
        "id": 360533369,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684848802
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1561292503\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>@dhil to answer <a href=\"https://github.com/effect-handlers/wasmtime/pull/21#pullrequestreview-1441048960\">this question</a> (over here for a bit more visibility) my thinking is that at the wasm AST layer there's only \"this index\" as a type but at the Wasmtime layer we'll be able to be more principled than that by having, for example:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">enum</span> <span class=\"nc\">WasmHeapType</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">Func</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">Extern</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">TypedFunc</span><span class=\"p\">(</span><span class=\"n\">SignatureIndex</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"n\">Array</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">TypedArray</span><span class=\"p\">(</span><span class=\"n\">StorageType</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"n\">Struct</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">TypedStruct</span><span class=\"p\">(</span><span class=\"n\">StructIndex</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"c1\">// ..</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>or something along the lines of that where <code>WasmHeapType</code> stores effectively the discriminant of what it refers to rather than requiring the indexing operation to then verify the type of the result.</p>\n<p>One of the things I was worried about was that there was the pervasive assumption that <code>WasmHeapType::Index(_)</code> was a function which won't be true once the GC proposal was implemented. I wanted to head off issues there by having the Wasmtime-level name be called <code>TypedFunc</code> so it's clear that all the cases handling <code>Func</code> and <code>TypedFunc</code> are only there for handling function-related things. In the future when more variants are added it'll require adding more <code>match</code> arms to handle in all these places.</p>\n</blockquote>",
        "id": 360810772,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1684939314
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1562754872\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>I've opened a issue to track the unresolved bits of this PR. See #6455. I hopefully I managed to cover them all.</p>\n</blockquote>",
        "id": 361033124,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1685014868
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1563423756\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p>Seems like there are some conflicts and this needs a rebase/merge.</p>\n</blockquote>",
        "id": 361153195,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1685044042
    },
    {
        "content": "<p>dhil <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1564002478\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<blockquote>\n<p>Seems like there are some conflicts and this needs a rebase/merge.</p>\n</blockquote>\n<p>I have synchronised with upstream again. Hopefully everything ticks green again :-)</p>\n</blockquote>",
        "id": 361251252,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1685089400
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288#issuecomment-1564614634\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5288\">issue #5288</a>:</p>\n<blockquote>\n<p><span aria-label=\"confetti\" class=\"emoji emoji-1f38a\" role=\"img\" title=\"confetti\">:confetti:</span> </p>\n</blockquote>",
        "id": 361374121,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1685117223
    }
]