[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3403\">issue #3403</a>:</p>\n<blockquote>\n<p>I've been attempting to debug some C code recently but unfortunately I keep running into an error that indicates \"failed to emit DWARF debug information\" when passing the <code>-g</code> flag to the <code>wasmtime</code> CLI. The reproduction of this is:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"c1\">// foo.c</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"foo\"</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">50</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">29</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\">  </span><span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">O3</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">mexec</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">=</span><span class=\"n\">reactor</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">g</span><span class=\"w\"></span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">Error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span><span class=\"w\"></span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">emit</span><span class=\"w\"> </span><span class=\"n\">DWARF</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">The</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">location</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"n\">must</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">before</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">beginning</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Inspecting the results of <code>llvm-dwarfdump</code> I see:</p>\n<p>&lt;details&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span>:       <span class=\"nc\">file</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">WASM</span><span class=\"w\"></span>\n\n<span class=\"p\">.</span><span class=\"n\">debug_info</span><span class=\"w\"> </span><span class=\"n\">contents</span>:\n<span class=\"mh\">0x00000000</span>: <span class=\"nc\">Compile</span><span class=\"w\"> </span><span class=\"n\">Unit</span>: <span class=\"nc\">length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x00000093</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">DWARF32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0004</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">abbr_offset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">addr_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x04</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"mh\">0x00000097</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000000b</span>: <span class=\"nc\">DW_TAG_compile_unit</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_producer</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"clang version 12.0.0 (https://github.com/llvm/llvm-project d28af7c654d8db0b68c175db5ce212d74fb5e9bc)\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_language</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">DW_LANG_C99</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_name</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"s\">\"foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_stmt_list</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_comp_dir</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_ranges</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"w\"></span>\n<span class=\"w\">                 </span><span class=\"p\">[</span><span class=\"mh\">0x0000000e</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x00000012</span><span class=\"p\">))</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000026</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000000e</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_high_pc</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000012</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_frame_base</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x3</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_GNU_all_call_sites</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"foo\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_external</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000041</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">dead</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_high_pc</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000004</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_frame_base</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x3</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_GNU_all_call_sites</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"bar\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_prototyped</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_external</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000005c</span>:     <span class=\"nc\">DW_TAG_formal_parameter</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_name</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"a\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000006c</span>:     <span class=\"nc\">DW_TAG_variable</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span>:\n                     <span class=\"p\">[</span><span class=\"mh\">0xfffffffe</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x100000002</span><span class=\"p\">)</span>: <span class=\"nc\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x70</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_name</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"b\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x00000083</span><span class=\"w\"> </span><span class=\"s\">\"int[50]\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000007b</span>:     <span class=\"nc\">NULL</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000007c</span>:   <span class=\"nc\">DW_TAG_base_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_encoding</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">DW_ATE_signed</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_byte_size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x04</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000083</span>:   <span class=\"nc\">DW_TAG_array_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000088</span>:     <span class=\"nc\">DW_TAG_subrange_type</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000008f</span><span class=\"w\"> </span><span class=\"s\">\"__ARRAY_SIZE_TYPE__\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_count</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x32</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000008e</span>:     <span class=\"nc\">NULL</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000008f</span>:   <span class=\"nc\">DW_TAG_base_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"__ARRAY_SIZE_TYPE__\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_byte_size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x08</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_encoding</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">DW_ATE_unsigned</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000096</span>:   <span class=\"nc\">NULL</span><span class=\"w\"></span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>With some digging the issue appears to be this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mh\">0x0000006c</span>:     <span class=\"nc\">DW_TAG_variable</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span>:\n                     <span class=\"p\">[</span><span class=\"mh\">0xfffffffe</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x100000002</span><span class=\"p\">)</span>: <span class=\"nc\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x70</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>where gimli is doing addition in the <a href=\"https://github.com/gimli-rs/gimli/blob/d20becf924f623a501f24738c35558e6222e6946/src/read/rnglists.rs#L597-L599\">32-bit address space for ranges</a> which means that from gimli's perspective the start address of this variable is 0xfffffffe and the end address is 0x2, hence the error from gimli itself.</p>\n<p>This appears to come about with DWARF debug information for dead code in a program. It appears that LLD <a href=\"https://github.com/llvm/llvm-project/blob/2372249d8689928a8d4a59baed3671613743653a/lld/wasm/InputChunks.cpp#L512-L513\">specifically uses the value of -2</a> for representing relocations against dead functions that don't actually show up in the output. The <code>DW_AT_location</code> attribute here I believe is encoded as a offset/length which means that the offset receives the relocation of -2 and when gimli adds the length it gets the error that the range is messed up.</p>\n<p>I believe the real fix here is to basically avoid generating native DWARF debugging information for dead code, or code that comes at the address of -1. <code>llvm-dwarfdump</code> already itself prints:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mh\">0x00000041</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">dead</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and for something like that we should probably just skip over that and not copy over any other attributes related to this subprogram (function). I unfortunately don't know the dwarf code well enough in Wasmtime to know of a great place to put this.</p>\n</blockquote>",
        "id": 255752130,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1633098243
    },
    {
        "content": "<p>alexcrichton labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3403\">issue #3403</a>:</p>\n<blockquote>\n<p>I've been attempting to debug some C code recently but unfortunately I keep running into an error that indicates \"failed to emit DWARF debug information\" when passing the <code>-g</code> flag to the <code>wasmtime</code> CLI. The reproduction of this is:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"c1\">// foo.c</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"foo\"</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">50</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">29</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\">  </span><span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">O3</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">mexec</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">=</span><span class=\"n\">reactor</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">g</span><span class=\"w\"></span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">Error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span><span class=\"w\"></span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">emit</span><span class=\"w\"> </span><span class=\"n\">DWARF</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">The</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">location</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"n\">must</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">before</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">beginning</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Inspecting the results of <code>llvm-dwarfdump</code> I see:</p>\n<p>&lt;details&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span>:       <span class=\"nc\">file</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">WASM</span><span class=\"w\"></span>\n\n<span class=\"p\">.</span><span class=\"n\">debug_info</span><span class=\"w\"> </span><span class=\"n\">contents</span>:\n<span class=\"mh\">0x00000000</span>: <span class=\"nc\">Compile</span><span class=\"w\"> </span><span class=\"n\">Unit</span>: <span class=\"nc\">length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x00000093</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">DWARF32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0004</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">abbr_offset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">addr_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x04</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"mh\">0x00000097</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000000b</span>: <span class=\"nc\">DW_TAG_compile_unit</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_producer</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"clang version 12.0.0 (https://github.com/llvm/llvm-project d28af7c654d8db0b68c175db5ce212d74fb5e9bc)\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_language</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">DW_LANG_C99</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_name</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"s\">\"foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_stmt_list</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_comp_dir</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_ranges</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"w\"></span>\n<span class=\"w\">                 </span><span class=\"p\">[</span><span class=\"mh\">0x0000000e</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x00000012</span><span class=\"p\">))</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000026</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000000e</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_high_pc</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000012</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_frame_base</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x3</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_GNU_all_call_sites</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"foo\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_external</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000041</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">dead</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_high_pc</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000004</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_frame_base</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x3</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_GNU_all_call_sites</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"bar\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_prototyped</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_external</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000005c</span>:     <span class=\"nc\">DW_TAG_formal_parameter</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_name</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"a\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000006c</span>:     <span class=\"nc\">DW_TAG_variable</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span>:\n                     <span class=\"p\">[</span><span class=\"mh\">0xfffffffe</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x100000002</span><span class=\"p\">)</span>: <span class=\"nc\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x70</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_name</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"b\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x00000083</span><span class=\"w\"> </span><span class=\"s\">\"int[50]\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000007b</span>:     <span class=\"nc\">NULL</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000007c</span>:   <span class=\"nc\">DW_TAG_base_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_encoding</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">DW_ATE_signed</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_byte_size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x04</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000083</span>:   <span class=\"nc\">DW_TAG_array_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000088</span>:     <span class=\"nc\">DW_TAG_subrange_type</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000008f</span><span class=\"w\"> </span><span class=\"s\">\"__ARRAY_SIZE_TYPE__\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_count</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x32</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000008e</span>:     <span class=\"nc\">NULL</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000008f</span>:   <span class=\"nc\">DW_TAG_base_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"__ARRAY_SIZE_TYPE__\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_byte_size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x08</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_encoding</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">DW_ATE_unsigned</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000096</span>:   <span class=\"nc\">NULL</span><span class=\"w\"></span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>With some digging the issue appears to be this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mh\">0x0000006c</span>:     <span class=\"nc\">DW_TAG_variable</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span>:\n                     <span class=\"p\">[</span><span class=\"mh\">0xfffffffe</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x100000002</span><span class=\"p\">)</span>: <span class=\"nc\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x70</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>where gimli is doing addition in the <a href=\"https://github.com/gimli-rs/gimli/blob/d20becf924f623a501f24738c35558e6222e6946/src/read/rnglists.rs#L597-L599\">32-bit address space for ranges</a> which means that from gimli's perspective the start address of this variable is 0xfffffffe and the end address is 0x2, hence the error from gimli itself.</p>\n<p>This appears to come about with DWARF debug information for dead code in a program. It appears that LLD <a href=\"https://github.com/llvm/llvm-project/blob/2372249d8689928a8d4a59baed3671613743653a/lld/wasm/InputChunks.cpp#L512-L513\">specifically uses the value of -2</a> for representing relocations against dead functions that don't actually show up in the output. The <code>DW_AT_location</code> attribute here I believe is encoded as a offset/length which means that the offset receives the relocation of -2 and when gimli adds the length it gets the error that the range is messed up.</p>\n<p>I believe the real fix here is to basically avoid generating native DWARF debugging information for dead code, or code that comes at the address of -1. <code>llvm-dwarfdump</code> already itself prints:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mh\">0x00000041</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">dead</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and for something like that we should probably just skip over that and not copy over any other attributes related to this subprogram (function). I unfortunately don't know the dwarf code well enough in Wasmtime to know of a great place to put this.</p>\n</blockquote>",
        "id": 255752157,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1633098252
    },
    {
        "content": "<p>alexcrichton labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/3403\">issue #3403</a>:</p>\n<blockquote>\n<p>I've been attempting to debug some C code recently but unfortunately I keep running into an error that indicates \"failed to emit DWARF debug information\" when passing the <code>-g</code> flag to the <code>wasmtime</code> CLI. The reproduction of this is:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"c1\">// foo.c</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"foo\"</span><span class=\"p\">)))</span><span class=\"w\"></span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">50</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"p\">[</span><span class=\"mi\">29</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\">  </span><span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">O3</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">mexec</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">=</span><span class=\"n\">reactor</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">g</span><span class=\"w\"></span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">Error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span><span class=\"w\"></span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n    <span class=\"mi\">0</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">emit</span><span class=\"w\"> </span><span class=\"n\">DWARF</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"mi\">1</span>: <span class=\"nc\">The</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">location</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"n\">must</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">before</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">beginning</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Inspecting the results of <code>llvm-dwarfdump</code> I see:</p>\n<p>&lt;details&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span>:       <span class=\"nc\">file</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">WASM</span><span class=\"w\"></span>\n\n<span class=\"p\">.</span><span class=\"n\">debug_info</span><span class=\"w\"> </span><span class=\"n\">contents</span>:\n<span class=\"mh\">0x00000000</span>: <span class=\"nc\">Compile</span><span class=\"w\"> </span><span class=\"n\">Unit</span>: <span class=\"nc\">length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x00000093</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">DWARF32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0004</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">abbr_offset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x0000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">addr_size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x04</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"mh\">0x00000097</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000000b</span>: <span class=\"nc\">DW_TAG_compile_unit</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_producer</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"clang version 12.0.0 (https://github.com/llvm/llvm-project d28af7c654d8db0b68c175db5ce212d74fb5e9bc)\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_language</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">DW_LANG_C99</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_name</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"s\">\"foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_stmt_list</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_comp_dir</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">              </span><span class=\"n\">DW_AT_ranges</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span><span class=\"w\"></span>\n<span class=\"w\">                 </span><span class=\"p\">[</span><span class=\"mh\">0x0000000e</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x00000012</span><span class=\"p\">))</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000026</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000000e</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_high_pc</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000012</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_frame_base</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x3</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_GNU_all_call_sites</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"foo\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_external</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000041</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">dead</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_high_pc</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x00000004</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_frame_base</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x3</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_GNU_all_call_sites</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"bar\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_prototyped</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_external</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000005c</span>:     <span class=\"nc\">DW_TAG_formal_parameter</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_name</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"a\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000006c</span>:     <span class=\"nc\">DW_TAG_variable</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span>:\n                     <span class=\"p\">[</span><span class=\"mh\">0xfffffffe</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x100000002</span><span class=\"p\">)</span>: <span class=\"nc\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x70</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_name</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"s\">\"b\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_file</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"s\">\"/home/acrichto/code/wasmtime/foo.c\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_decl_line</span><span class=\"w\">       </span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x00000083</span><span class=\"w\"> </span><span class=\"s\">\"int[50]\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000007b</span>:     <span class=\"nc\">NULL</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000007c</span>:   <span class=\"nc\">DW_TAG_base_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_encoding</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">DW_ATE_signed</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_byte_size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x04</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000083</span>:   <span class=\"nc\">DW_TAG_array_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_type</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"mh\">0x0000007c</span><span class=\"w\"> </span><span class=\"s\">\"int\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000088</span>:     <span class=\"nc\">DW_TAG_subrange_type</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_type</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mh\">0x0000008f</span><span class=\"w\"> </span><span class=\"s\">\"__ARRAY_SIZE_TYPE__\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_count</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"mh\">0x32</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000008e</span>:     <span class=\"nc\">NULL</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x0000008f</span>:   <span class=\"nc\">DW_TAG_base_type</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_name</span><span class=\"w\">      </span><span class=\"p\">(</span><span class=\"s\">\"__ARRAY_SIZE_TYPE__\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_byte_size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x08</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_encoding</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">DW_ATE_unsigned</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"mh\">0x00000096</span>:   <span class=\"nc\">NULL</span><span class=\"w\"></span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>With some digging the issue appears to be this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mh\">0x0000006c</span>:     <span class=\"nc\">DW_TAG_variable</span><span class=\"w\"></span>\n<span class=\"w\">                  </span><span class=\"n\">DW_AT_location</span><span class=\"w\">        </span><span class=\"p\">(</span><span class=\"mh\">0x00000000</span>:\n                     <span class=\"p\">[</span><span class=\"mh\">0xfffffffe</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x100000002</span><span class=\"p\">)</span>: <span class=\"nc\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x70</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_WASM_location</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_stack_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">DW_OP_piece</span><span class=\"w\"> </span><span class=\"mh\">0x4</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>where gimli is doing addition in the <a href=\"https://github.com/gimli-rs/gimli/blob/d20becf924f623a501f24738c35558e6222e6946/src/read/rnglists.rs#L597-L599\">32-bit address space for ranges</a> which means that from gimli's perspective the start address of this variable is 0xfffffffe and the end address is 0x2, hence the error from gimli itself.</p>\n<p>This appears to come about with DWARF debug information for dead code in a program. It appears that LLD <a href=\"https://github.com/llvm/llvm-project/blob/2372249d8689928a8d4a59baed3671613743653a/lld/wasm/InputChunks.cpp#L512-L513\">specifically uses the value of -2</a> for representing relocations against dead functions that don't actually show up in the output. The <code>DW_AT_location</code> attribute here I believe is encoded as a offset/length which means that the offset receives the relocation of -2 and when gimli adds the length it gets the error that the range is messed up.</p>\n<p>I believe the real fix here is to basically avoid generating native DWARF debugging information for dead code, or code that comes at the address of -1. <code>llvm-dwarfdump</code> already itself prints:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mh\">0x00000041</span>:   <span class=\"nc\">DW_TAG_subprogram</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">DW_AT_low_pc</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">dead</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and for something like that we should probably just skip over that and not copy over any other attributes related to this subprogram (function). I unfortunately don't know the dwarf code well enough in Wasmtime to know of a great place to put this.</p>\n</blockquote>",
        "id": 255752158,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1633098252
    }
]