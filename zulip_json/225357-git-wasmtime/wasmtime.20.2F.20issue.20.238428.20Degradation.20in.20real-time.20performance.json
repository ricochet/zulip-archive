[
    {
        "content": "<p><a href=\"https://github.com/daichifukui\">daichifukui</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8428\">Issue #8428</a>.</p>",
        "id": 434695896,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1713776891
    },
    {
        "content": "<p>daichifukui opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8428\">issue #8428</a>:</p>\n<blockquote>\n<h3>Describe the bug</h3>\n<p>We are experiencing degradation in real-time performance with the latest version of Wasmtime runtime.</p>\n<h3>Conditions</h3>\n<ul>\n<li>wasmtime-cli 21.0.0 (dac3bdb07 2024-04-14)</li>\n<li>cargo-wasi 0.1.28 (e811d4889b 2023-06-12)</li>\n<li>rustc 1.77.2 (25ef9e3d8 2024-04-09)</li>\n</ul>\n<h3>Steps to reproduce</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"p\">{</span><span class=\"n\">thread</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">time</span>::<span class=\"p\">{</span><span class=\"n\">Instant</span><span class=\"p\">};</span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">duration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">time</span>::<span class=\"n\">Duration</span>::<span class=\"n\">from_millis</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"o\">*</span><span class=\"mi\">1000</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"k\">u32</span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Instant</span>::<span class=\"n\">now</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"n\">thread</span>::<span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"n\">duration</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">elapsed_time</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">.</span><span class=\"n\">elapsed</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Time elapsed is: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">elapsed_time</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">release</span>\n\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"w\"> </span><span class=\"mf\">21.0.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">dac3bdb07</span><span class=\"w\"> </span><span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">04</span><span class=\"o\">-</span><span class=\"mi\">14</span><span class=\"p\">)</span>\n\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">rust_clock_nanosleep</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.00209518</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001975393</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002069423</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001098972</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001260921</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002105879</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002093792</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002016636</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001522486</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001914764</span><span class=\"n\">s</span>\n</code></pre></div>\n<h3>Expected behaviour</h3>\n<p>The latency is expected to vary in microseconds.<br>\nFYI, using an older version of wasmtime such as v8.0.1, the performance is as follows.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">v8</span><span class=\"p\">.</span><span class=\"mf\">0.1</span><span class=\"o\">-</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">rust_clock_nanosleep</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000509875</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000589676</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000437833</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000510245</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000517657</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000513208</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000521429</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000516253</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000525438</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000400342</span><span class=\"n\">s</span>\n</code></pre></div>\n<p>In addition, if we disable preview2 through the <code>-S</code> option, with the latest version of wasmtime, the performance gets better than enabling preview2:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Spreview2</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">rust_clock_nanosleep</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000515945</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000522065</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000437704</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000522172</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000532635</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000460092</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000514949</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000519259</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000514321</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.00051906</span><span class=\"n\">s</span>\n</code></pre></div>\n<h3>Actual behaviour</h3>\n<p>The latency varies in about milliseconds.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">rust_clock_nanosleep</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.00209518</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001975393</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002069423</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001098972</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001260921</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002105879</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002093792</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002016636</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001522486</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001914764</span><span class=\"n\">s</span>\n</code></pre></div>\n<p>As we can see expected behaviour when disabling preview2, it is considered that the performance degradation is related to the difference between the implimentations of preview1, meaning that the difference between <code>wasmtime-wasi</code> and <code>wasi-common</code> has something to do with this issue.</p>\n<h3>Additional context</h3>\n<p>In the background, we are planning to use Wasmtime on top of a control system.<br>\nWe believe that using a WASM runtime would make applications for control systems more portable and scalable.<br>\nThis is because WASM uses a CPU-agnostic binary format and consumes less computing resource than a container runtime.<br>\nAs timing is critical in control systems, we would like to have better real-time performance with WASM runtimes.<br>\nWAMR is designed as a lightweight standalone WASM runtime and can be used for a control system, but it primarily implements an interpreter, so this could potentially lead to slower execution times compared to a JIT compiler like Wasmtime.</p>\n</blockquote>",
        "id": 434695900,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1713776893
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8428\">issue #8428</a>:</p>\n<blockquote>\n<h3>Describe the bug</h3>\n<p>We are experiencing degradation in real-time performance with the latest version of Wasmtime runtime.</p>\n<h3>Conditions</h3>\n<ul>\n<li>wasmtime-cli 21.0.0 (dac3bdb07 2024-04-14)</li>\n<li>cargo-wasi 0.1.28 (e811d4889b 2023-06-12)</li>\n<li>rustc 1.77.2 (25ef9e3d8 2024-04-09)</li>\n</ul>\n<h3>Steps to reproduce</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">rs</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"p\">{</span><span class=\"n\">thread</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">time</span>::<span class=\"p\">{</span><span class=\"n\">Instant</span><span class=\"p\">};</span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">duration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">time</span>::<span class=\"n\">Duration</span>::<span class=\"n\">from_millis</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"o\">*</span><span class=\"mi\">1000</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"k\">u32</span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Instant</span>::<span class=\"n\">now</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"n\">thread</span>::<span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"n\">duration</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">elapsed_time</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">.</span><span class=\"n\">elapsed</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Time elapsed is: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">elapsed_time</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">release</span>\n\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"w\"> </span><span class=\"mf\">21.0.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">dac3bdb07</span><span class=\"w\"> </span><span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">04</span><span class=\"o\">-</span><span class=\"mi\">14</span><span class=\"p\">)</span>\n\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">rust_clock_nanosleep</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.00209518</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001975393</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002069423</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001098972</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001260921</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002105879</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002093792</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002016636</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001522486</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001914764</span><span class=\"n\">s</span>\n</code></pre></div>\n<h3>Expected behaviour</h3>\n<p>The latency is expected to vary in microseconds.<br>\nFYI, using an older version of wasmtime such as v8.0.1, the performance is as follows.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">v8</span><span class=\"p\">.</span><span class=\"mf\">0.1</span><span class=\"o\">-</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">rust_clock_nanosleep</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000509875</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000589676</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000437833</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000510245</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000517657</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000513208</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000521429</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000516253</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000525438</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000400342</span><span class=\"n\">s</span>\n</code></pre></div>\n<p>In addition, if we disable preview2 through the <code>-S</code> option, with the latest version of wasmtime, the performance gets better than enabling preview2:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Spreview2</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">rust_clock_nanosleep</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000515945</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000522065</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000437704</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000522172</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000532635</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000460092</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000514949</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000519259</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.000514321</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.00051906</span><span class=\"n\">s</span>\n</code></pre></div>\n<h3>Actual behaviour</h3>\n<p>The latency varies in about milliseconds.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">to</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasi</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">rust_clock_nanosleep</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.00209518</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001975393</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002069423</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001098972</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001260921</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002105879</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002093792</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.002016636</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001522486</span><span class=\"n\">s</span>\n<span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"n\">is</span>: <span class=\"mf\">1.001914764</span><span class=\"n\">s</span>\n</code></pre></div>\n<p>As we can see expected behaviour when disabling preview2, it is considered that the performance degradation is related to the difference between the implimentations of preview1, meaning that the difference between <code>wasmtime-wasi</code> and <code>wasi-common</code> has something to do with this issue.</p>\n<h3>Additional context</h3>\n<p>In the background, we are planning to use Wasmtime on top of a control system.<br>\nWe believe that using a WASM runtime would make applications for control systems more portable and scalable.<br>\nThis is because WASM uses a CPU-agnostic binary format and consumes less computing resource than a container runtime.<br>\nAs timing is critical in control systems, we would like to have better real-time performance with WASM runtimes.<br>\nWAMR is designed as a lightweight standalone WASM runtime and can be used for a control system, but it primarily implements an interpreter, so this could potentially lead to slower execution times compared to a JIT compiler like Wasmtime.</p>\n</blockquote>",
        "id": 435425575,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1714062346
    }
]