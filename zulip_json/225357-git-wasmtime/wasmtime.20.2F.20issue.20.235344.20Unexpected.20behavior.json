[
    {
        "content": "<p>erxiaozhou opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344\">issue #5344</a>:</p>\n<blockquote>\n<h2>Environment</h2>\n<p>Code Version: git commit id ff5abfd9938c78cd75c6c5d6a41565097128c5d3<br>\nHardware Architecture: x86_64<br>\nOperating system: Ubuntu 20.04</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/10115352/reply_570_2_unexpected_execution.zip\">reply_570_2_unexpected_execution.zip</a></p>\n<h2>command</h2>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">invoke</span><span class=\"w\"> </span><span class=\"n\">to_test</span><span class=\"w\"> </span><span class=\"n\">reply_wasmi_570_2</span><span class=\"o\">/</span><span class=\"n\">replay_570_2_unexpected_execution</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n</code></pre></div>\n<h2>Expected behavior:</h2>\n<p>An exception indicating that \"alignment must not be larger than natural\"</p>\n<h2>Current behavior:</h2>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Output</span>: <span class=\"mi\">1</span><span class=\"w\"></span>\n</code></pre></div>\n<h2>Steps to generate this test case</h2>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/10115459/570_2.zip\">570_2.zip</a></p>\n</blockquote>",
        "id": 312891583,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1669742068
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344#issuecomment-1331020491\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344\">issue #5344</a>:</p>\n<blockquote>\n<p>Thanks for the report, but this is a somewhat benign issue. The problem I think you're running into here is that the provided module is encoded as:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"mh\">0x44</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">i64_store</span><span class=\"w\"> </span><span class=\"n\">memarg</span>:<span class=\"nc\">MemArg</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">align</span>: <span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">max_align</span>: <span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">offset</span>: <span class=\"mi\">68</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">memory</span>: <span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"></span>\n</code></pre></div>\n<p>where the <code>i64.store</code> is encoded with <code>0x37 0x40 0x00 0x44</code>. Using an MVP decoder that decodes as an alignment of 0x40 and an offset of 0x00 which is indeed, as you've pointed out, an error as \"alignment must not be larger than natural\". The <code>wasmparser</code> crate which Wasmtime uses, however, implements the multi-memory proposal which reinterprets the binary encoding of a memarg where <code>0x40</code> means \"alignment is 1 and the next byte is memory\" which causes wasmparser to decode to the above structure, which is indeed valid (under the multi-memory proposal).</p>\n<p>This more-or-less a bug in <code>wasmparser</code>'s binary decoding and/or validation. Right now features are not checked/verified at the binary decoding layer, only at the AST structural layer, meaning that this binary encoding is not properly gated or conditionalized behind the <code>multi_memory</code> proposal at this time.</p>\n<p>Would you be interested in helping to fix this?</p>\n</blockquote>",
        "id": 312894791,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1669742951
    },
    {
        "content": "<p>erxiaozhou <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344#issuecomment-1333354908\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344\">issue #5344</a>:</p>\n<blockquote>\n<blockquote>\n<p>Thanks for the report, but this is a somewhat benign issue. The problem I think you're running into here is that the provided module is encoded as:</p>\n<p><code>\n...\n 0x44 | 37 40 00 44 | i64_store memarg:MemArg { align: 0, max_align: 3, offset: 68, memory: 0 }\n...\n</code></p>\n<p>where the <code>i64.store</code> is encoded with <code>0x37 0x40 0x00 0x44</code>. Using an MVP decoder that decodes as an alignment of 0x40 and an offset of 0x00 which is indeed, as you've pointed out, an error as \"alignment must not be larger than natural\". The <code>wasmparser</code> crate which Wasmtime uses, however, implements the multi-memory proposal which reinterprets the binary encoding of a memarg where <code>0x40</code> means \"alignment is 1 and the next byte is memory\" which causes wasmparser to decode to the above structure, which is indeed valid (under the multi-memory proposal).</p>\n<p>This more-or-less a bug in <code>wasmparser</code>'s binary decoding and/or validation. Right now features are not checked/verified at the binary decoding layer, only at the AST structural layer, meaning that this binary encoding is not properly gated or conditionalized behind the <code>multi_memory</code> proposal at this time.</p>\n<p>Would you be interested in helping to fix this?</p>\n</blockquote>\n<p>Thank you for your nice reply! I'll be happy to fix this after I finish my current work.</p>\n</blockquote>",
        "id": 313222003,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1669881618
    },
    {
        "content": "<p>Robbepop <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344#issuecomment-2395599298\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344\">issue #5344</a>:</p>\n<blockquote>\n<p>@alexcrichton has this been fixed already with <code>BinaryReader</code> including <code>WasmFeatures</code> now since some versions of <code>wasmparser</code>? <a href=\"https://docs.rs/wasmparser/0.218.0/wasmparser/struct.BinaryReader.html#method.new_features\">https://docs.rs/wasmparser/0.218.0/wasmparser/struct.BinaryReader.html#method.new_features</a></p>\n</blockquote>",
        "id": 475148671,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728251808
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344\">issue #5344</a>:</p>\n<blockquote>\n<h2>Environment</h2>\n<p>Code Version: git commit id ff5abfd9938c78cd75c6c5d6a41565097128c5d3<br>\nHardware Architecture: x86_64<br>\nOperating system: Ubuntu 20.04</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/10115352/reply_570_2_unexpected_execution.zip\">reply_570_2_unexpected_execution.zip</a></p>\n<h2>command</h2>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">invoke</span><span class=\"w\"> </span><span class=\"n\">to_test</span><span class=\"w\"> </span><span class=\"n\">reply_wasmi_570_2</span><span class=\"o\">/</span><span class=\"n\">replay_570_2_unexpected_execution</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n</code></pre></div>\n<h2>Expected behavior:</h2>\n<p>An exception indicating that \"alignment must not be larger than natural\"</p>\n<h2>Current behavior:</h2>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Output</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<h2>Steps to generate this test case</h2>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/10115459/570_2.zip\">570_2.zip</a></p>\n</blockquote>",
        "id": 475149660,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728252617
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344#issuecomment-2395603696\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5344\">issue #5344</a>:</p>\n<blockquote>\n<p>Good point! This now reports:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">reply_570_2_unexpected_execution</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WebAssembly</span><span class=\"w\"> </span><span class=\"n\">translation</span><span class=\"w\"> </span><span class=\"n\">error</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">Invalid</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"n\">WebAssembly</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mi\">69</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">malformed</span><span class=\"w\"> </span><span class=\"n\">memop</span><span class=\"w\"> </span><span class=\"n\">alignment</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">alignment</span><span class=\"w\"> </span><span class=\"n\">too</span><span class=\"w\"> </span><span class=\"n\">large</span>\n</code></pre></div>\n<p>which I believe is the correct error here. Specifically this module is valid-by-default due to the multi-memory proposal, but it's invalid if the multi-memory proposal is disabled.</p>\n</blockquote>",
        "id": 475149662,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728252617
    }
]