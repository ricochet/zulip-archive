[
    {
        "content": "<p>ifsheldon opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933\">PR #9933</a> from <code>ifsheldon:fix-silent-error-part-1</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This attempts to partially solve #9932, adding checking return code of the executed command <code>cargo build</code>, which can fail, for example, if a target has not been added.</p>\n<p>I don't know whether there are similar cases somewhere else, in which the return code of an executed command is simply ignored.</p>\n<p>In this file, however, when I asked Claude \"are there anything else that will cause silent failures in this file\", it says the following. I think what it says makes sense, but I don't know much about cmake, so I don't know if it's correct.<br>\n&lt;details&gt;<br>\nYes, there are a few potential sources of silent failures in this CMake file:</p>\n<ol>\n<li>The <code>create_rust_test</code> function also uses <code>cargo run</code> without checking return codes:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"CMake\"><pre><span></span><code><span class=\"nb\">function</span><span class=\"p\">(</span><span class=\"s\">CREATE_RUST_TEST</span><span class=\"w\"> </span><span class=\"s\">EXAMPLE</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"c\"># These tests might fail silently during test execution</span>\n<span class=\"w\">    </span><span class=\"nb\">if</span><span class=\"p\">(</span><span class=\"s\">ARGC</span><span class=\"w\"> </span><span class=\"s\">GREATER</span><span class=\"w\"> </span><span class=\"s\">1</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"nb\">add_test</span><span class=\"p\">(</span><span class=\"s\">NAME</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span><span class=\"s\">-rust</span><span class=\"w\"> </span><span class=\"s\">COMMAND</span><span class=\"w\"> </span><span class=\"s\">cargo</span><span class=\"w\"> </span><span class=\"s\">run</span><span class=\"w\"> </span><span class=\"s\">--example</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"s\">--features</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">ARGV1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"s\">WORKING_DIRECTORY</span><span class=\"w\"> </span><span class=\"s\">../..</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nb\">else</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"nb\">add_test</span><span class=\"p\">(</span><span class=\"s\">NAME</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span><span class=\"s\">-rust</span><span class=\"w\"> </span><span class=\"s\">COMMAND</span><span class=\"w\"> </span><span class=\"s\">cargo</span><span class=\"w\"> </span><span class=\"s\">run</span><span class=\"w\"> </span><span class=\"s\">--example</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"s\">WORKING_DIRECTORY</span><span class=\"w\"> </span><span class=\"s\">../..</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nb\">endif</span><span class=\"p\">()</span>\n<span class=\"nb\">endfunction</span><span class=\"p\">()</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>The <code>add_subdirectory</code> command at the beginning might fail silently if the directory doesn't exist:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"CMake\"><pre><span></span><code><span class=\"nb\">add_subdirectory</span><span class=\"p\">(</span><span class=\"o\">${</span><span class=\"nv\">CMAKE_CURRENT_SOURCE_DIR</span><span class=\"o\">}</span><span class=\"s\">/../crates/c-api</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">CMAKE_CURRENT_BINARY_DIR</span><span class=\"o\">}</span><span class=\"s\">/wasmtime</span><span class=\"p\">)</span>\n</code></pre></div>\n<ol start=\"3\">\n<li>In the <code>CREATE_TARGET</code> function, the linking against CoreFoundation on Apple platforms doesn't verify if the framework exists:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"CMake\"><pre><span></span><code><span class=\"nb\">if</span><span class=\"p\">(</span><span class=\"s\">APPLE</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nb\">target_link_libraries</span><span class=\"p\">(</span><span class=\"s\">wasmtime-</span><span class=\"o\">${</span><span class=\"nv\">TARGET</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"s\">PRIVATE</span><span class=\"w\"> </span><span class=\"s2\">\"-framework CoreFoundation\"</span><span class=\"p\">)</span>\n<span class=\"nb\">endif</span><span class=\"p\">()</span>\n</code></pre></div>\n<p>To make the file more robust, you could:</p>\n<ol>\n<li>Add existence checks for required directories and files</li>\n<li>Add <code>REQUIRED</code> to framework findings</li>\n<li>Set test properties to fail on non-zero return codes:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"CMake\"><pre><span></span><code><span class=\"nb\">function</span><span class=\"p\">(</span><span class=\"s\">CREATE_RUST_TEST</span><span class=\"w\"> </span><span class=\"s\">EXAMPLE</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nb\">if</span><span class=\"p\">(</span><span class=\"s\">ARGC</span><span class=\"w\"> </span><span class=\"s\">GREATER</span><span class=\"w\"> </span><span class=\"s\">1</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"nb\">add_test</span><span class=\"p\">(</span><span class=\"s\">NAME</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span><span class=\"s\">-rust</span>\n<span class=\"w\">                </span><span class=\"s\">COMMAND</span><span class=\"w\"> </span><span class=\"s\">cargo</span><span class=\"w\"> </span><span class=\"s\">run</span><span class=\"w\"> </span><span class=\"s\">--example</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"s\">--features</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">ARGV1</span><span class=\"o\">}</span>\n<span class=\"w\">                </span><span class=\"s\">WORKING_DIRECTORY</span><span class=\"w\"> </span><span class=\"s\">../..</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nb\">else</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"nb\">add_test</span><span class=\"p\">(</span><span class=\"s\">NAME</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span><span class=\"s\">-rust</span>\n<span class=\"w\">                </span><span class=\"s\">COMMAND</span><span class=\"w\"> </span><span class=\"s\">cargo</span><span class=\"w\"> </span><span class=\"s\">run</span><span class=\"w\"> </span><span class=\"s\">--example</span><span class=\"w\"> </span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span>\n<span class=\"w\">                </span><span class=\"s\">WORKING_DIRECTORY</span><span class=\"w\"> </span><span class=\"s\">../..</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nb\">endif</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"c\"># Make the test fail if cargo returns non-zero</span>\n<span class=\"w\">    </span><span class=\"nb\">set_tests_properties</span><span class=\"p\">(</span><span class=\"o\">${</span><span class=\"nv\">EXAMPLE</span><span class=\"o\">}</span><span class=\"s\">-rust</span><span class=\"w\"> </span><span class=\"s\">PROPERTIES</span><span class=\"w\"> </span><span class=\"s\">WILL_FAIL</span><span class=\"w\"> </span><span class=\"s\">FALSE</span><span class=\"p\">)</span>\n<span class=\"nb\">endfunction</span><span class=\"p\">()</span>\n</code></pre></div>\n<p>Also, it's worth noting that the relative paths (<code>../..</code>) in <code>WORKING_DIRECTORY</code> could be fragile if the directory structure changes. It would be more robust to use absolute paths or CMake variables to reference directories.<br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 492151134,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736185101
    },
    {
        "content": "<p><strong>ifsheldon</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933\">PR #9933</a>.</p>",
        "id": 492151135,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736185102
    },
    {
        "content": "<p><strong>ifsheldon</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933\">PR #9933</a>.</p>",
        "id": 492151136,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736185102
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933#issuecomment-2573960064\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933\">PR #9933</a>:</p>\n<blockquote>\n<p>Thanks! I think that <code>execute_process</code> probably isn't the right thing here but rather it's best to set up a \"target\" (I think that's the right CMake terminology) which is based on executing the process instead. That would also defer execution to the test step rather than running it during the configure step as well.</p>\n<p>If you're not comfortable with CMake though I'm happy to make this change too. (I don't know what/who Claude is myself)</p>\n</blockquote>",
        "id": 492188828,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736198993
    },
    {
        "content": "<p>ifsheldon <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933#issuecomment-2574273948\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933\">PR #9933</a>:</p>\n<blockquote>\n<p>Yeah, please help, as this change might affect many test cases checking examples working.</p>\n</blockquote>",
        "id": 492228653,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736216987
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933#issuecomment-2575923018\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933\">PR #9933</a>:</p>\n<blockquote>\n<p>I've done some refactoring in <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9940\">https://github.com/bytecodealliance/wasmtime/pull/9940</a></p>\n</blockquote>",
        "id": 492360081,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736273051
    },
    {
        "content": "<p>alexcrichton closed without merge <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9933\">PR #9933</a>.</p>",
        "id": 492400636,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736289714
    }
]