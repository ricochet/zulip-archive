[
    {
        "content": "<p>Artentus opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Hello,</p>\n<p>I am currently trying to write a Cranelift backend that targets a 32 bit architecture but am encountering some issues.   <br>\nSince all the existing backends are 64 bit am I not sure whether this is due to missing support or my lack of understanding.</p>\n<p>For example, <code>codegen::machinst::valueregs::ValueRegs</code> states in its description <code>we cap the capacity of this at four (when any 32-bit target is enabled) or two (otherwise)</code>, however the capacity is hardcoded to 2.</p>\n<p>Also, inside the <code>codegen::machinst::isle::isle_lower_prelude_methods</code> macro, the function <code>temp_writable_reg</code> assumes only a single register is returned. However, this function is called in <code>IsleContext&lt;'_, '_, MInst, XYZBackend&gt;::imm</code>, which takes 64 bit values, so on a 32 bit target two registers are required.</p>\n<p>In general, the <code>Context</code> trait generated by ISLE requires 64 bit quantities in most places. How is one expected to implement these for a 32 bit target? Do you invent non-existing instructions that operate on 64 bit and then lower them into equivalent real instructions?</p>\n</blockquote>",
        "id": 321255959,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1673643534
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1382494377\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Cool, it's nice to hear from people working on more Cranelift backends! I'm curious what architecture you're targeting; glancing at your GitHub, I'm guessing it's your A32 RISC ISA? I'd also love to hear some about your goal: Do you want to run Wasmtime on this target, or compile Rust to it with cg-clif, or something else?</p>\n<p>As you noticed, we don't currently have backends implemented for any 32-bit targets, so I'm not particularly surprised that you're running into situations where we didn't quite think through the implications for a 32-bit target.</p>\n<p>There are existing cases where backends use what we refer to as \"pseudo-instructions\", which are what I think you're describing as \"non-existing instructions\". You can find a bunch of examples with <code>git grep -E 'pseudo-?inst'</code>; we haven't been super consistent about spelling apparently. Maybe there are cases where that would help with 64-bit assumptions, but off-hand my guess is there will be few if any of those cases.</p>\n<p>For the most part I think you'll just need to do for 64-bit types what the existing backends do for 128-bit types: split the value across two registers and figure out how to combine register pairs as needed. For some relatively simple examples, look at how various backends implement <code>(lower (has_type $I128 (iadd x y)))</code>.</p>\n<p>The only case where you should need four registers in <code>ValueRegs</code> is if you're going to support 128-bit integers with 32-bit registers, and we're very inconsistent about I128 support across the existing backends anyway. So I'd just skip that for now. Once you have a proof of concept working we can figure out how to handle issues like <code>ValueRegs</code> being too small. It's a little tricky because I'm guessing making it bigger will have a measurable impact on compile time, and also because we'll need to do some API design work.</p>\n<p>The only <code>fn imm</code> I see that takes a 64-bit value and calls <code>temp_writable_reg</code> is in the riscv64 backend. You don't have to implement that. It was apparently convenient for that backend but you can do something different if you need to.</p>\n<p>I hope this helps give you a starting point. We're happy to answer questions if we can!</p>\n</blockquote>",
        "id": 321271106,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1673649513
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1382586410\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Hey, thanks for that detailed answer.</p>\n<p>Yes you are right, I'm doing this for academic purposes atm. The ISA I'm targeting is similar to RV32I in a lot of ways so if you don't wanna read through it just pretend its RV32I. This is also the reason why I mostly used the RiscV backend as a template.</p>\n<p>My goal is to compile Rust. I messed around with LLVM but writing a backend for that turned out to be really difficult. And since I know my way around Rust a lot better than C++ I decided to give Cranelift a go. Since this is mostly about the learning experience I don't really care that the generated code is not quite on par with LLVM.</p>\n<p>Alright so I will ignore i128s for now. I guess as long as I don't use them in the code I want to compile they should never be emitted right? Same with floats probably.</p>\n<p>I'm gonna read through the other backedns ISLE code and see how it's being done there. I'm still finding my way around ISLE.</p>\n</blockquote>",
        "id": 321278780,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1673653130
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1382589191\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>If you want the rust standard library to compile without patches you need both i128 and floats. It is possible to patch them out though with a bit of work.</p>\n</blockquote>",
        "id": 321279582,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1673653589
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1382937230\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>I’d suggest looking at the aarch64 and x64 backends when looking for inspiration.</p>\n</blockquote>",
        "id": 321413229,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1673734235
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1383024886\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Ok, I got a very simple function to correctly compile now.  <br>\nBefore I continue I wanna ask: are there any tests I should modify/add specifically for the backend?  <br>\nThe other backends contain very little testing directly so I guess it happens somewhere else.</p>\n</blockquote>",
        "id": 321429910,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1673748373
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1383047098\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Nice! Most testing is done via file tests (‘cranelift/filetests/filetests/isa/*’), fuzzing, and wasmtime exercising the codegen.</p>\n</blockquote>",
        "id": 321436369,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1673753944
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1383047864\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Ah thanks, that's what I was looking for.</p>\n</blockquote>",
        "id": 321436735,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1673754338
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396377493\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>I have implemented all of the arithmetic and bitwise operations now, except for division and remainder.  <br>\nThe architecture doesn't have division or remainder instructions so they have to be implemented algorithmically.  <br>\nHowever emitting the algorithm inline does not seem like a wise choice, instead I want to generate a call to some function (I believe in LLVM the function in question would be called <code>divsi3</code>).</p>\n<p>But since none of the other backends do this I don't know how to go about it. I can manage to emit a call but where does the function come from, how do I define it?  <br>\nIdeally the function would be defined in target-specific code to hand-optimize it.</p>\n</blockquote>",
        "id": 322191793,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674097078
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396378397\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>@Artentus we have a mechanism for this with <code>LibCall</code>s; we do have a few such calls in some of the instruction lowerings.</p>\n</blockquote>",
        "id": 322191915,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674097187
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396380375\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>I saw that in the memcpy lowering but couldn't figure out how to actually define new ones.</p>\n</blockquote>",
        "id": 322192247,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674097382
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396383809\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>The enum is defined <a href=\"https://github.com/bytecodealliance/wasmtime/blob/7cea73a81da4ac86b1188676a89b4d99a8349d04/cranelift/codegen/src/ir/libcall.rs#L22\">here</a>. If you grep for one of the existing ones, e.g. <code>FloorF32</code>, you'll see the places in the code where it's used and how the relocation can be handled to link to an actual function (e.g. in Wasmtime <a href=\"https://github.com/bytecodealliance/wasmtime/blob/7cea73a81da4ac86b1188676a89b4d99a8349d04/crates/jit/src/code_memory.rs#L286\">here</a> to <a href=\"https://github.com/bytecodealliance/wasmtime/blob/7cea73a81da4ac86b1188676a89b4d99a8349d04/crates/runtime/src/libcalls.rs#L506\">this function</a>).</p>\n</blockquote>",
        "id": 322192579,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674097693
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396384744\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>(Forgot to finish: then you can follow that example to define a new one; also in general, when adding a new option to an enum, the compile errors will usually lead you to where you need to make changes.)</p>\n</blockquote>",
        "id": 322192651,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674097791
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396388555\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Thanks!</p>\n<p>However I assume this only works within the runtime correct?  <br>\nDoes that mean if I want to compile Rust using the rustc cranelift backend I have to supply these through the linker?</p>\n</blockquote>",
        "id": 322193182,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674098240
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396443311\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Yes, you would need to somehow provide implementations of the libcalls that the relocation resolution can find. cc @bjorn3 for the best way to do that...</p>\n</blockquote>",
        "id": 322200133,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674104538
    },
    {
        "content": "<p>afonso360 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396642880\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p><span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span> Hey, See #4460 for an example on how to define a new LibCall. Mostly once you provide the correct name in the <a href=\"https://github.com/bytecodealliance/wasmtime/blob/7cea73a81da4ac86b1188676a89b4d99a8349d04/cranelift/module/src/lib.rs#L56\">module</a> crate, the linker can usually figure it out automatically.</p>\n</blockquote>",
        "id": 322227627,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674118887
    },
    {
        "content": "<p>afonso360 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1396642880\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p><span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span> Hey, See #4460 for an example on how to define a new LibCall. Mostly once you provide the correct name in the <a href=\"https://github.com/bytecodealliance/wasmtime/blob/7cea73a81da4ac86b1188676a89b4d99a8349d04/cranelift/module/src/lib.rs#L56\">module</a> crate, the linker can usually figure it out automatically.</p>\n<p>That PR also does some setup groundwork to emit libcall's from isle that you shouldn't need to repeat.</p>\n</blockquote>",
        "id": 322227985,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674119005
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1397356949\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Yes I mostly copied the code from x64 <code>emit_vm_call</code> and it's correctly generating these calls now.  <br>\nMy main problem is how to get linkable object files that contain these functions, since there is no existing compilers for this target.</p>\n</blockquote>",
        "id": 322337554,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674149693
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1397431397\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>You could add it to the compiler-builtins rust crate I think. This crate is included in everything rustc compiles.</p>\n</blockquote>",
        "id": 322350337,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674153126
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1399191915\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>I am currently working on lowering for loads and stores, and there are these two ir instructions I'm unsure about: <code>uload32</code> and <code>sload32</code>.  <br>\nOn a 32 bit architecture these are both functionally identical to just <code>load.i32</code> but I'm wondering if the compiler will still try to emit these.</p>\n<p>I tried experimenting and defined this test function:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">uload32</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i32</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span>: <span class=\"kt\">i32</span><span class=\"p\">)</span>:\n  <span class=\"nc\">v1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">uload32</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">42</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>But this yields the following error: <code>inst1 (return v1): arg 0 (v1) has type i64, must match function signature of i32</code></p>\n<p>So do I just completely ignore these?</p>\n</blockquote>",
        "id": 322672212,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674282704
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1399212997\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>uload and iload generally return a 64bit value by zero/sign extending a 32bit loaded value.</p>\n</blockquote>",
        "id": 322687031,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674292148
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1399212997\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>uload and sload generally return a 64bit value by zero/sign extending a 32bit loaded value.</p>\n</blockquote>",
        "id": 322687039,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674292156
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1399214343\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Well, <code>uload8</code>, <code>sload8</code>, <code>uload16</code> and <code>sload16</code> do work fine with 32 bit. This code compiles perfectly fine:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">uload8</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i32</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span>: <span class=\"kt\">i32</span><span class=\"p\">)</span>:\n  <span class=\"nc\">v1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">uload8</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"o\">+</span><span class=\"mi\">42</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 322688164,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674292682
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1399267688\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Looks like <code>uload*</code> and <code>sload*</code> have a constraint that their output size is bigger than what they load (up to 64bit). So for example <code>uload32</code> will always return an <code>i64</code> and <code>uload16</code> an <code>i32</code> or <code>i64</code>. <a href=\"https://github.com/bytecodealliance/wasmtime/blob/69cd0a6b1a78c9c793b549256d76c879b48cb3db/cranelift/codegen/meta/src/shared/instructions.rs#L814\">https://github.com/bytecodealliance/wasmtime/blob/69cd0a6b1a78c9c793b549256d76c879b48cb3db/cranelift/codegen/meta/src/shared/instructions.rs#L814</a></p>\n</blockquote>",
        "id": 322739527,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674313468
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1399353410\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Ah, I guess that makes sense. So I should probably implement all of them for both 32 bit _and_ 64 bit right?</p>\n</blockquote>",
        "id": 322789765,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674343795
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1399423892\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>uload8 and sload8 should he implemented for i16, i32 and i64 (i16 can be skipped for wasm I think, uload16 and sload16 should be implemented for i32 and i64. Uload32 and uload64 should be implemented for i64.</p>\n</blockquote>",
        "id": 322822164,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674373839
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1399423892\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>uload8 and sload8 should he implemented for i16, i32 and i64 (i16 can be skipped for wasm I think, uload16 and sload16 should be implemented for i32 and i64. Uload32 and sload32 should be implemented for i64.</p>\n</blockquote>",
        "id": 322822170,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674373856
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1406800561\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<blockquote>\n<p>If you want the rust standard library to compile without patches you need both i128 and floats.</p>\n</blockquote>\n<p>Unfortunately it seems like this is true even for the core library. I tried to compile it but am gettings loads of errors related to invalid SSA types (f32 and i128).</p>\n<p>So how do I go about patching that stuff out?</p>\n</blockquote>",
        "id": 324108285,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674839464
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1406815620\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>I know there are usages in <code>core::time</code> and <code>core::num</code>. Try commenting them out and see what breaks. Then comment everything out that depends on those impls and repeat. You might take some inspiration from the patch file <a href=\"https://github.com/bjorn3/rustc_codegen_cranelift/commit/425b527dc31c4d88ed2099bcc91af96cebf8a463\">https://github.com/bjorn3/rustc_codegen_cranelift/commit/425b527dc31c4d88ed2099bcc91af96cebf8a463</a> introduced to remove i128 usage from libcore. It doesn't apply to the latest version anymore, but it may be useful as guide.</p>\n</blockquote>",
        "id": 324111230,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674840209
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1407490240\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Thank you very much, I actually managed to have it compile the (modified) core library without errors.</p>\n<p>However I must say it is very awkward having to inject a custom core library.  <br>\nI think I will actually do the work and add libcalls for all the float instructions. It's tedious but not difficult.</p>\n<p>128 bit integers on the other hand do pose a problem, I'm not sure what to do about that.</p>\n</blockquote>",
        "id": 324349402,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1674940663
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1407709481\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>For rustc_codegen_cranelift the patches directory contains various kinds of patches. Those with <code>-sysroot-</code> are applied to the standard library. You can commit your changes, do <code>git format-patch HEAD~..HEAD</code> (or if you have multiple commits use the appropriate amount of <code>~</code>) and then move the generated patch to the patches directory and rename it to include <code>-sysroot-</code>. After that running <code>./y.rs prepare</code> again will apply the patch to the standard library sources that <code>./y.rs build</code> uses. If you need to only build libcore and not the rest of the standard library, you can edit <code>build_sysroot/Cargo.toml</code> to remove the dependencies on the rest. (you will likely need to keep compiler_builtins) Note that you will have to do <code>./y.rs prepare</code> again after editing it as it is copied elsewhere. (I plan to make this automatic, but haven't gotten to it yet.)</p>\n</blockquote>",
        "id": 324459680,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675009763
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1407716031\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>I think adding support for 128 bit integers in the backend is the better solution than patching the core library.  <br>\nModifying Cranelift to support 4 register values wasn't actually all that difficult.</p>\n</blockquote>",
        "id": 324463522,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675011625
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1411011667\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>I'm successfully compiling code now, including the entire Rust core and alloc libraries.</p>\n<p>However after inspecting the generated code I am seeing some very weird things being generated.  <br>\nTo be clear, I never expected Cranelift to generate code that is optimized to the same degree as LLVM, it clearly states so after all.  <br>\nBut I did not expect it to do such hilariously bad things.</p>\n<p>I compiled this very basic hello world main function:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">mod</span> <span class=\"nn\">io</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">serial_write</span><span class=\"p\">(</span><span class=\"n\">s</span>: <span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"c1\">// ...</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">io</span>::<span class=\"n\">serial_write</span><span class=\"p\">(</span><span class=\"s\">\"Hello World!\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And this is the generated assembly (manually commented):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"></span>\n<span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"s\">\"Hello World!\"</span><span class=\"w\"> </span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"o\">-</span><span class=\"n\">relocation</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"n\">ldui</span><span class=\"w\"> </span><span class=\"n\">t7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">a0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">t7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"s\">\"Hello World!\"</span><span class=\"w\"> </span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"o\">+</span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">st</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">a1</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">a0</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"s\">\"Hello World!\"</span><span class=\"w\"> </span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"o\">+</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"n\">ldi</span><span class=\"w\"> </span><span class=\"n\">a2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"></span>\n<span class=\"n\">st</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">a1</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">a2</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"o\">+</span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">ld</span><span class=\"w\"> </span><span class=\"n\">a2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">a2</span><span class=\"p\">]</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"o\">+</span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"></span>\n<span class=\"n\">ld</span><span class=\"w\"> </span><span class=\"n\">a3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">a3</span><span class=\"p\">]</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"o\">+</span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"n\">st</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">a4</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">a2</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"o\">+</span><span class=\"mi\">20</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"></span>\n<span class=\"n\">st</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">a4</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">a3</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"o\">+</span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"n\">ld</span><span class=\"w\"> </span><span class=\"n\">a0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">a4</span><span class=\"p\">]</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">load</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"o\">+</span><span class=\"mi\">20</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"></span>\n<span class=\"n\">ld</span><span class=\"w\"> </span><span class=\"n\">a1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">a4</span><span class=\"p\">]</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">io</span>::<span class=\"n\">serial_write</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"o\">-</span><span class=\"n\">relocation</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"n\">ldui</span><span class=\"w\"> </span><span class=\"n\">t7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">t7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">jl</span><span class=\"w\"> </span><span class=\"n\">ra</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"w\"></span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">free</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"></span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"></span>\n</code></pre></div>\n<p>As you can see what should be loading two simple arguments into <code>a0</code>  and <code>a1</code> registers is actually round tripping two times through memory for absolutely no reason.  <br>\nAlso it is not making use of offsetting memory instructions at all, instead emitting an add+load/store.</p>\n</blockquote>",
        "id": 325007955,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675196445
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1411024363\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>@Artentus I wonder if it would make sense to move some of this discussion to a Zulip thread? We're interested in helping you support your ISA, but normally we like to use GitHub issues more for targeted single issues.</p>\n<p>In any case, it's hard to say much without actually playing with your new backend. Are you enabling optimizations? How did you implement the ABI? What does the CLIF look like? The redundant ops could be coming from any one of several layers.</p>\n</blockquote>",
        "id": 325009477,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675196956
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1411025303\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<blockquote>\n<p>I'm successfully compiling code now, including the entire Rust core and alloc libraries.</p>\n</blockquote>\n<p><span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>\n<blockquote>\n<p>However after inspecting the generated code I am seeing some very weird things being generated.</p>\n</blockquote>\n<p>Yeah, rustc generates terrible MIR with a lot of copies in it. I try to remove some of the copies in cg_clif, but many are passed through to Cranelift. Cranelift doesn't have the optimization passes necessary to remove them. If you enable optimizations for cg_clif you this will enable some optimizations working on MIR which may tidy it up a bit.</p>\n</blockquote>",
        "id": 325009639,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675197006
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1411050991\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>@cfallin got it. I have just never used Zulip in my life so I have to sign up first.</p>\n<p>@bjorn3 I'm already compiling the compiler itself in release mode if that's what you mean. Test program was also compiled in release mode.</p>\n</blockquote>",
        "id": 325012929,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675198215
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1412072164\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>I just checked it and this is indeed caused by the MIR containing copies:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">_0</span>: <span class=\"p\">();</span><span class=\"w\">                      </span><span class=\"c1\">// return place in scope 0 at /app/example.rs:7:15: 7:15</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_1</span>: <span class=\"p\">();</span><span class=\"w\">                          </span><span class=\"c1\">// in scope 0 at /app/example.rs:8:5: 8:37</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">_2</span>: <span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">;</span><span class=\"w\">                    </span><span class=\"c1\">// in scope 0 at /app/example.rs:8:22: 8:36</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_3</span>: <span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">;</span><span class=\"w\">                        </span><span class=\"c1\">// in scope 0 at /app/example.rs:8:22: 8:36</span>\n\n<span class=\"w\">    </span><span class=\"n\">bb0</span>: <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"s\">\"Hello World!\"</span><span class=\"p\">;</span><span class=\"w\">       </span><span class=\"c1\">// scope 0 at /app/example.rs:8:22: 8:36</span>\n<span class=\"w\">        </span><span class=\"n\">_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">_3</span><span class=\"p\">;</span><span class=\"w\">                         </span><span class=\"c1\">// scope 0 at /app/example.rs:8:22: 8:36</span>\n<span class=\"w\">        </span><span class=\"n\">_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">serial_write</span><span class=\"p\">(</span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"n\">_2</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">bb1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// scope 0 at /app/example.rs:8:5: 8:37</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">bb1</span>: <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"p\">;</span><span class=\"w\">                          </span><span class=\"c1\">// scope 0 at /app/example.rs:9:2: 9:2</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The first store is <code>_3 = const \"Hello World!\";</code>, the first load and store is <code>_2 = _3;</code> and the last load is the <code>move _2</code> argument. Compiling with <code>-Zmir-opt-level=3</code> optimizes away the <code>_2 = _3</code>.</p>\n<p>This seems to be a case where cg_clif itself should be able to avoid stack allocation, but for some reason it doesn't. I'm currently investigating.</p>\n</blockquote>",
        "id": 325159996,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675258652
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1412101315\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Found it. This was a regression from <a href=\"https://github.com/bjorn3/rustc_codegen_cranelift/commit/777d4732dc2389752ebaa4fc7256245c4873bc25\">https://github.com/bjorn3/rustc_codegen_cranelift/commit/777d4732dc2389752ebaa4fc7256245c4873bc25</a>. I've fixed it in <a href=\"https://github.com/bjorn3/rustc_codegen_cranelift/commit/df04fd6fba2e1b2b85a108e3ec7e56c731456ba9\">https://github.com/bjorn3/rustc_codegen_cranelift/commit/df04fd6fba2e1b2b85a108e3ec7e56c731456ba9</a> for a 12% runtime perf win on a benchmark I use. Thanks for pointing this out!</p>\n</blockquote>",
        "id": 325164710,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675259859
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1413115812\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>That's great news! 12% from such a small change is huge.</p>\n<p>This patch did get rid of one of the unnecessary copies.  <br>\nI believe the second one is because of a transmute from <code>&amp;str</code> to <code>&amp;[u8]</code> which Cranelift can't optimize out. But that's fine.</p>\n<p>I also figured out how to optimize those add+load/store sequences into a single instruction.<br>\nJust needed a rule to cover <code>stack_addr</code> followed by <code>load</code> or <code>store</code> IR instructions.</p>\n<p>Since everything is working I believe I can now close this. Thanks to everyone who helped me with this, I got way more and way faster responses than I ever expected. The codebase was also very pleasant to work with, especially compared to the mess that is LLVM.</p>\n<p>If you're interested I can PR the changes that are required to fully support 32 bit targets in cranelift_codegen.  <br>\nIt's very little code, essentially just extending <code>ValueRegs</code> to size of 4. Easily feature gated as well so if no 32 bit targets are enabled there won't be any impact.</p>\n</blockquote>",
        "id": 325312202,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675310025
    },
    {
        "content": "<p>Artentus closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>Hello,</p>\n<p>I am currently trying to write a Cranelift backend that targets a 32 bit architecture but am encountering some issues.   <br>\nSince all the existing backends are 64 bit am I not sure whether this is due to missing support or my lack of understanding.</p>\n<p>For example, <code>codegen::machinst::valueregs::ValueRegs</code> states in its description <code>we cap the capacity of this at four (when any 32-bit target is enabled) or two (otherwise)</code>, however the capacity is hardcoded to 2.</p>\n<p>Also, inside the <code>codegen::machinst::isle::isle_lower_prelude_methods</code> macro, the function <code>temp_writable_reg</code> assumes only a single register is returned. However, this function is called in <code>IsleContext&lt;'_, '_, MInst, XYZBackend&gt;::imm</code>, which takes 64 bit values, so on a 32 bit target two registers are required.</p>\n<p>In general, the <code>Context</code> trait generated by ISLE requires 64 bit quantities in most places. How is one expected to implement these for a 32 bit target? Do you invent non-existing instructions that operate on 64 bit and then lower them into equivalent real instructions?</p>\n</blockquote>",
        "id": 325312204,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675310025
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1414006204\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<blockquote>\n<p>If you're interested I can PR the changes that are required to fully support 32 bit targets in cranelift_codegen.<br>\nIt's very little code, essentially just extending ValueRegs to size of 4. Easily feature gated as well so if no 32 bit targets are enabled there won't be any impact.</p>\n</blockquote>\n<p>We actually had exactly this code before, when we had a (partial) arm32 backend in-tree! I think it's probably best to wait until we add a new target to bring this back, as we are also considering other ways now of supporting wide values (namely: legalization/narrowing rules in the mid-end, as Cranelift used to do actually) that might be simpler in the end.</p>\n<p>I'm happy you got this working though, it's a really neat demo of portability! And if you want to contribute any documentation regarding rough edges or confusing bits you hit, that might also be a good outcome from this :-)</p>\n</blockquote>",
        "id": 325439012,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675354725
    },
    {
        "content": "<p>Artentus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1414263713\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<p>A pice of documentation I would have loved to have is a listing of all CLIF instructions, just to know what needs to be implemented instead of trying to compile something and then reading error messages about missing lowering rules.  <br>\nSome of the instructions also have quirks that weren't immediately obvious to me.</p>\n<p>If you tell me where to put it I can start working on it.</p>\n</blockquote>",
        "id": 325481688,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675366467
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572#issuecomment-1414270619\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/5572\">issue #5572</a>:</p>\n<blockquote>\n<blockquote>\n<p>A pice of documentation I would have loved to have is a listing of all CLIF instructions, just to know what needs to be implemented instead of trying to compile something and then reading error messages about missing lowering rules. Some of the instructions also have quirks that weren't immediately obvious to me.</p>\n<p>If you tell me where to put it I can start working on it.</p>\n</blockquote>\n<p>The closest we have to that is the <a href=\"https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/trait.InstBuilder.html\">InstBuilder trait docs</a> that are generated from the source (that ultimately come from the doc-strings in <code>cranelift/codegen/meta/shared/src/instructions.rs</code>). Any updates to those descriptions that would have been helpful are very welcome contributions!</p>\n<p>We have a <a href=\"https://github.com/bytecodealliance/wasmtime/tree/main/cranelift/docs\">cranelift/docs/</a> directory as well that could use some attention in general; if you come up with any more general thoughts from your experience please do feel free to start a <code>porting.md</code> or similar! It's on our <a href=\"https://github.com/bytecodealliance/rfcs/pull/30\">roadmap</a> for this year to update docs and a porting-to-new-ISA guide is something we do want to build out, eventually.</p>\n</blockquote>",
        "id": 325483000,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675366841
    }
]