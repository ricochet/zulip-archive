[
    {
        "content": "<p>sunshowers opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9660\">issue #9660</a>:</p>\n<blockquote>\n<p>Discovered this while working on #9652.</p>\n<p>Looking at <code>LocalMemory::new</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/memory.rs#L484-L487\">https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/memory.rs#L484-L487</a></p>\n<p>It passes in <code>alloc.byte_size()</code> as the <code>accessible</code> parameter to <code>MemoryImageSlot::create</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/cow.rs#L337-L345\">https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/cow.rs#L337-L345</a></p>\n<p><code>self.accessible</code> is not rounded up to the host page size and is instead stored directly. But other places assume that <code>self.accessible</code> is page-aligned, for example:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/cow.rs#L425\">https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/cow.rs#L425</a></p>\n<p>This ends up resolving to <code>mprotect</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/sys/unix/vm.rs#L9-L11\">https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/sys/unix/vm.rs#L9-L11</a></p>\n<p><code>mprotect</code> requires that its address is page-aligned, and will produce an <code>EINVAL</code> if it isn't.</p>\n<p>I think there are likely also places where it panics or possibly even causes UB.</p>\n</blockquote>",
        "id": 483989331,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1732308663
    },
    {
        "content": "<p>sunshowers edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9660\">issue #9660</a>:</p>\n<blockquote>\n<p>Discovered this while working on #9652.</p>\n<p>Looking at <code>LocalMemory::new</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/memory.rs#L484-L487\">https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/memory.rs#L484-L487</a></p>\n<p>It passes in <code>alloc.byte_size()</code> as the <code>accessible</code> parameter to <code>MemoryImageSlot::create</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/cow.rs#L337-L345\">https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/cow.rs#L337-L345</a></p>\n<p><code>self.accessible</code> is not rounded up to the host page size and is instead stored directly. But other places assume that <code>self.accessible</code> is page-aligned, for example:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/cow.rs#L425\">https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/cow.rs#L425</a></p>\n<p>This ends up resolving to <code>mprotect</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/sys/unix/vm.rs#L9-L11\">https://github.com/bytecodealliance/wasmtime/blob/bc656c72126ca3dcdc9477960b88a1816d2c09cb/crates/wasmtime/src/runtime/vm/sys/unix/vm.rs#L9-L11</a></p>\n<p><code>mprotect</code> requires that its address is page-aligned, and will produce an <code>EINVAL</code> if it isn't.</p>\n<p>I think there are likely also places where it panics or possibly even causes UB.</p>\n</blockquote>",
        "id": 483989578,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1732308771
    },
    {
        "content": "<p>sunshowers <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9660#issuecomment-2494988390\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9660\">issue #9660</a>:</p>\n<blockquote>\n<p>In <a href=\"#narrow/channel/206238-general/topic/centralizing.20memory.20allocation.20code.20in.20Mmap.20.28.239544.29/near/483991533\">Zulip</a> we decided to:</p>\n<ul>\n<li>for now, skip attempting to do CoW if <code>byte_size</code> is smaller than the host page size</li>\n<li>in the future, extend <code>MemoryImageSlot</code> to track both the accessible size and a rounded-up form of it.</li>\n</ul>\n</blockquote>",
        "id": 484002548,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1732315154
    }
]