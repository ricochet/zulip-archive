[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9942\">issue #9942</a>:</p>\n<blockquote>\n<p>Given this input CLIF:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"nc\">tail</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">sig0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"nc\">tail</span>\n<span class=\"w\">    </span><span class=\"n\">fn0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colocated</span><span class=\"w\"> </span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">sig0</span>\n\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v19</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">fn0</span><span class=\"p\">(</span><span class=\"n\">v2</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">v20</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">iadd</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v19</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v20</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I'm currently seeing on <code>main</code></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"n\">pulley</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">x86_64</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">../</span><span class=\"n\">clif</span><span class=\"o\">/</span><span class=\"n\">wasm_func_0</span><span class=\"p\">.</span><span class=\"n\">clif</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">opt_level</span><span class=\"o\">=</span><span class=\"n\">speed</span>\n<span class=\"p\">.</span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"mi\">157</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">69</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">160</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">158</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"n\">Disassembly</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">34</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"p\">:</span>\n<span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">         </span><span class=\"n\">push_frame_save</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x21</span>\n<span class=\"w\">       </span><span class=\"mi\">9</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">                           </span><span class=\"n\">xmov</span><span class=\"w\"> </span><span class=\"n\">x21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x0</span>\n<span class=\"w\">       </span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">02</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">                  </span><span class=\"n\">call1</span><span class=\"w\"> </span><span class=\"n\">x21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x0</span><span class=\"w\">    </span><span class=\"c1\">// target = 0xc</span>\n<span class=\"w\">      </span><span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"mi\">05</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\">                           </span><span class=\"n\">xmov</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x21</span>\n<span class=\"w\">      </span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">                           </span><span class=\"n\">xadd32</span><span class=\"w\"> </span><span class=\"n\">x0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x0</span>\n<span class=\"w\">      </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">         </span><span class=\"n\">pop_frame_restore</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x21</span>\n<span class=\"w\">      </span><span class=\"mi\">21</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">                                 </span><span class=\"n\">ret</span>\n</code></pre></div>\n<p>Notably instruction at 12, <code>xmov x5, x21</code>, I'm not sure why that exists. In theory that should not be there and the subsequent <code>xadd32</code> should be <code>xadd32 x0, x21, x0</code> and that would remove the need for the insertion of the <code>xmov</code>. This <code>xmov</code> is being inserted as part of register allocation as logging shows that the input program is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">VCode</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">Entry</span><span class=\"w\"> </span><span class=\"n\">block</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Block</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">([]):</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">original</span><span class=\"w\"> </span><span class=\"n\">IR</span><span class=\"w\"> </span><span class=\"n\">block</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">block0</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Inst</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">args</span><span class=\"w\"> </span><span class=\"n\">v192</span><span class=\"o\">=</span><span class=\"n\">x0</span>\n<span class=\"w\">  </span><span class=\"n\">Inst</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">call</span><span class=\"w\"> </span><span class=\"n\">CallInfo</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PulleyCall</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">User</span><span class=\"p\">(</span><span class=\"n\">userextname0</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">XReg</span><span class=\"p\">(</span><span class=\"n\">v192</span><span class=\"p\">)]</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[],</span><span class=\"w\"> </span><span class=\"n\">defs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">CallRetPair</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">vreg</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Writable</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">reg</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v196</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">preg</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">p0i</span><span class=\"w\"> </span><span class=\"p\">}],</span><span class=\"w\"> </span><span class=\"n\">clobbers</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">PRegSet</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">65534</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">65535</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4294967295</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">callee_conv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Tail</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">caller_conv</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Tail</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">callee_pop_size</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"n\">Inst</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">xadd32</span><span class=\"w\"> </span><span class=\"n\">v195</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v192</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v196</span>\n<span class=\"w\">  </span><span class=\"n\">Inst</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">rets</span><span class=\"w\"> </span><span class=\"n\">v195</span><span class=\"o\">=</span><span class=\"n\">x0</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>On aarch64 I see:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"n\">pulley</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">aarch64</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">../</span><span class=\"n\">clif</span><span class=\"o\">/</span><span class=\"n\">wasm_func_0</span><span class=\"p\">.</span><span class=\"n\">clif</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">opt_level</span><span class=\"o\">=</span><span class=\"n\">speed</span>\n<span class=\"p\">.</span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"mi\">253</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">191</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">169</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">253</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">145</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">248</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">248</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">248</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">170</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">148</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">248</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">65</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">248</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">253</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">193</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">168</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">192</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">95</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">214</span>\n\n<span class=\"n\">Disassembly</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"p\">:</span>\n<span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">fd</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">bf</span><span class=\"w\"> </span><span class=\"n\">a9</span><span class=\"w\">             </span><span class=\"n\">stp</span><span class=\"w\">     </span><span class=\"n\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x30</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"o\">-</span><span class=\"mh\">0x10</span><span class=\"p\">]</span><span class=\"o\">!</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">fd</span><span class=\"w\"> </span><span class=\"mi\">03</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">91</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">     </span><span class=\"n\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span>\n<span class=\"w\">   </span><span class=\"mi\">8</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f8</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">f8</span><span class=\"w\">             </span><span class=\"kt\">str</span><span class=\"w\">     </span><span class=\"n\">x24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">sp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"o\">-</span><span class=\"mh\">0x10</span><span class=\"p\">]</span><span class=\"o\">!</span>\n<span class=\"w\">   </span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f8</span><span class=\"w\"> </span><span class=\"mi\">03</span><span class=\"w\"> </span><span class=\"mi\">02</span><span class=\"w\"> </span><span class=\"n\">aa</span><span class=\"w\">             </span><span class=\"n\">mov</span><span class=\"w\">     </span><span class=\"n\">x24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x2</span>\n<span class=\"w\">  </span><span class=\"mi\">10</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">94</span><span class=\"w\">             </span><span class=\"n\">bl</span><span class=\"w\">      </span><span class=\"p\">#</span><span class=\"mh\">0x10</span>\n<span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">02</span><span class=\"w\"> </span><span class=\"mi\">03</span><span class=\"w\"> </span><span class=\"mi\">02</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">b</span><span class=\"w\">             </span><span class=\"n\">add</span><span class=\"w\">     </span><span class=\"n\">w2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">w24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">w2</span>\n<span class=\"w\">  </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">f8</span><span class=\"w\"> </span><span class=\"mi\">07</span><span class=\"w\"> </span><span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"n\">f8</span><span class=\"w\">             </span><span class=\"n\">ldr</span><span class=\"w\">     </span><span class=\"n\">x24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">sp</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"mh\">0x10</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">fd</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c1</span><span class=\"w\"> </span><span class=\"n\">a8</span><span class=\"w\">             </span><span class=\"n\">ldp</span><span class=\"w\">     </span><span class=\"n\">x29</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x30</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">sp</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"mh\">0x10</span>\n<span class=\"w\">  </span><span class=\"mi\">20</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">c0</span><span class=\"w\"> </span><span class=\"mi\">03</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">d6</span><span class=\"w\">             </span><span class=\"n\">ret</span>\n</code></pre></div>\n<p>which does the right thing after the call instruction at 10 and the <code>add</code> instruction at 14 doesn't have a <code>mov</code> in front. Additionally for x64 it also looks \"correct\":</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">features</span><span class=\"w\"> </span><span class=\"n\">pulley</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">x86_64</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">../</span><span class=\"n\">clif</span><span class=\"o\">/</span><span class=\"n\">wasm_func_0</span><span class=\"p\">.</span><span class=\"n\">clif</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">opt_level</span><span class=\"o\">=</span><span class=\"n\">speed</span>\n<span class=\"p\">.</span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"mi\">85</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">137</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">229</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">131</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">236</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">76</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">137</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">73</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">137</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">255</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">232</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">68</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">248</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">76</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">139</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">131</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">196</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">137</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">236</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">93</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">195</span>\n\n<span class=\"n\">Disassembly</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">u0</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"p\">:</span>\n<span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">55</span><span class=\"w\">                      </span><span class=\"n\">pushq</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">e5</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">             </span><span class=\"n\">subq</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rsp</span>\n<span class=\"w\">   </span><span class=\"mi\">8</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">             </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span>\n<span class=\"w\">   </span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ff</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">r15</span>\n<span class=\"w\">   </span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">e8</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">callq</span><span class=\"w\">   </span><span class=\"mh\">0x14</span>\n<span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"n\">f8</span><span class=\"w\">                </span><span class=\"n\">addl</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r15d</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eax</span>\n<span class=\"w\">  </span><span class=\"mi\">17</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"w\">             </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">r15</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"n\">b</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">83</span><span class=\"w\"> </span><span class=\"n\">c4</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">             </span><span class=\"n\">addq</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x10</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rsp</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"mi\">89</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"w\">                </span><span class=\"n\">movq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">rsp</span>\n<span class=\"w\">  </span><span class=\"mi\">22</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mi\">5</span><span class=\"n\">d</span><span class=\"w\">                      </span><span class=\"n\">popq</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rbp</span>\n<span class=\"w\">  </span><span class=\"mi\">23</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">c3</span><span class=\"w\">                      </span><span class=\"n\">retq</span>\n</code></pre></div>\n<p>Notably the <code>addl</code> has no preceding <code>mov</code> instruction.</p>\n<p>Is this the Pulley backend perhaps missing something with respect to regalloc metadata?</p>\n<p>The generated <code>get_operands</code> method for the instruction here is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">        </span><span class=\"n\">RawInst</span><span class=\"p\">::</span><span class=\"n\">Xadd32</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"p\">,</span><span class=\"n\">src2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">collector</span><span class=\"p\">.</span><span class=\"n\">reg_use</span><span class=\"p\">(</span><span class=\"n\">src1</span><span class=\"p\">);</span>\n<span class=\"n\">collector</span><span class=\"p\">.</span><span class=\"n\">reg_use</span><span class=\"p\">(</span><span class=\"n\">src2</span><span class=\"p\">);</span>\n\n<span class=\"w\">            </span><span class=\"n\">collector</span><span class=\"p\">.</span><span class=\"n\">reg_def</span><span class=\"p\">(</span><span class=\"n\">dst</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>which is in theory pretty similar to how x64/aarch64 both work. I'm not sure if this is falling off a regalloc heuristic or a meaningful difference between x64/aarch64 though.</p>\n</blockquote>",
        "id": 492375679,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736279148
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the pulley label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9942\">Issue #9942</a>.</p>",
        "id": 493410463,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1736790403
    }
]