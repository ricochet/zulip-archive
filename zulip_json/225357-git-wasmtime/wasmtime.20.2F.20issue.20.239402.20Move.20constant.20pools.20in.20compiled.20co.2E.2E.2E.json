[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402\">issue #9402</a>:</p>\n<blockquote>\n<p>Today Cranelift's constant-pools are located in the .text section of the executable, typically located after the function itself. While convenient for code generation this exposes a possible attack vector in Wasmtime where it's trivial to put a \"gadget\" somewhere in memory. For example using a sequence of <code>v128.const</code> it would be pretty easy to assemble \"machine code\" at the end of a function. In the face of a bug in Cranelift this could make it possibly easier to amplify into a sandbox escape perhaps.</p>\n<p>As a defense-in-depth measure we should try to move the constant pools out of the .text section and into a .data or otherwise read-only section. (not writable or executable). This won't be trivial to do due to the fact that relocations from the text section point at the data section and the relocation range may not always be large enough for the entire text section. Regardless though I wanted to file an issue about this idea.</p>\n</blockquote>",
        "id": 475674327,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728422590
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402#issuecomment-2400857804\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402\">issue #9402</a>:</p>\n<blockquote>\n<p>It would definitely be nice to have support for this -- in principle we could return two blobs of bytes as the result of per-function compilation instead of one, and have a relocation type that is \"offset from start of this function's code to start of this function's constants\".</p>\n<p>Out of curiosity, do you happen to know how <code>ld</code> handles .rodata references today for very large aarch64/riscv64/... binaries? I wonder if it uses its support for relaxation (assuming most pessimistic range sequence then shrinking if able) -- it'd be unfortunate to have to use <code>adrp</code>/<code>adr</code>/<code>ldr</code> rather than the immediate-pcrel form of <code>ldr</code> for every constant. I'm not able to find anything on this at the moment...</p>\n</blockquote>",
        "id": 475676913,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728423052
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402#issuecomment-2400953463\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402\">issue #9402</a>:</p>\n<blockquote>\n<p>That's an excellent question, and one I don't know the answer to myself. I can try to play around with an assembler though and see what happens perhaps!</p>\n</blockquote>",
        "id": 475689313,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728427944
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402#issuecomment-2400973014\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402\">issue #9402</a>:</p>\n<blockquote>\n<p>I tried briefly to trigger something interesting, but got stuck at trying to get clang (on macOS/aarch64) to use the short-form LDR-with-immediate instruction; for any load from rodata it seems to use an <code>adrp</code>/<code>adr</code> pair.</p>\n<p>For example with (separate files to avoid a neat optimization where clang const-folds the load of constant data):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">c</span>\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">;</span>\n\n<span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">((</span><span class=\"n\">int</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">s</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">c</span>\n<span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"1234\"</span><span class=\"p\">;</span>\n\n<span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">c</span>\n<span class=\"p\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">stdio</span><span class=\"p\">.</span><span class=\"n\">h</span><span class=\"o\">&gt;</span>\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">();</span>\n<span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"%d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">());</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I see <code>_foo</code>'s body as</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mi\">0000000100003</span><span class=\"n\">f44</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">_foo</span><span class=\"o\">&gt;</span><span class=\"p\">:</span>\n<span class=\"mi\">100003</span><span class=\"n\">f44</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">b0000028</span><span class=\"w\">     </span><span class=\"n\">adrp</span><span class=\"w\">    </span><span class=\"n\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x100008000</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">_s</span><span class=\"o\">&gt;</span>\n<span class=\"mi\">100003</span><span class=\"n\">f48</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">91000108</span><span class=\"w\">     </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"mh\">0x0</span>\n<span class=\"mi\">100003</span><span class=\"n\">f4c</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">f9400108</span><span class=\"w\">     </span><span class=\"n\">ldr</span><span class=\"w\"> </span><span class=\"n\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x8</span><span class=\"p\">]</span>\n<span class=\"mi\">100003</span><span class=\"n\">f50</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">b9400100</span><span class=\"w\">     </span><span class=\"n\">ldr</span><span class=\"w\"> </span><span class=\"n\">w0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x8</span><span class=\"p\">]</span>\n<span class=\"mi\">100003</span><span class=\"n\">f54</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">d65f03c0</span><span class=\"w\">     </span><span class=\"n\">ret</span>\n</code></pre></div>\n<p>Maybe it wouldn't be so bad to unconditionally emit that form actually; loads from constant pools will be relatively rare. It does burn a register though to compute the address.</p>\n</blockquote>",
        "id": 475691518,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728429228
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402#issuecomment-2401012293\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402\">issue #9402</a>:</p>\n<blockquote>\n<p>Good point!</p>\n<p>Looks like</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[no_mangle]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">foo</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"kt\">f64</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"mf\">1.3484</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><a href=\"https://godbolt.org/z/W8Ez5cTYz\">generates</a></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">.</span><span class=\"n\">LCPI0_0</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">xword</span><span class=\"w\">  </span><span class=\"mh\">0x3ff5930be0ded289</span>\n<span class=\"n\">foo</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"nc\">adrp</span><span class=\"w\">    </span><span class=\"n\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">LCPI0_0</span>\n<span class=\"w\">        </span><span class=\"n\">ldr</span><span class=\"w\">     </span><span class=\"n\">d0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"nc\">lo12</span><span class=\"p\">:.</span><span class=\"n\">LCPI0_0</span><span class=\"p\">]</span>\n<span class=\"w\">        </span><span class=\"n\">ret</span>\n</code></pre></div>\n<p>so yeah it looks like we may want to be a tiny bit clever (don't always \"just\" materialize the address) but otherwise looks like solving this issue would involve always doing <code>adrp</code> on aarch64 and the equivalent on riscv64</p>\n</blockquote>",
        "id": 475695726,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728432018
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the cranelift:area:security label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9402\">Issue #9402</a>.</p>",
        "id": 476239879,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1728600865
    }
]