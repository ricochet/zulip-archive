[
    {
        "content": "<p>abrown opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a> from <code>abrown:pku-rebased-again</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This change implements [ColorGuard] in Wasmtime's pooling allocator. The gory details are covered in the documentation to the code, but, at a very high-level, this allows fitting more memory slots into the same address space used by Wasmtime's pooling allocator. This is done by \"striping\" the memory slots with different memory protection keys (MPK) and using the faults given by OOB accesses (<code>SIGSEGV</code>) to regions protected by other protection keys.</p>\n<p>[ColorGuard]: <a href=\"https://plas2022.github.io/files/pdf/SegueColorGuard.pdf\">https://plas2022.github.io/files/pdf/SegueColorGuard.pdf</a></p>\n<p>This is still at an early stage and will require follow-on PRs. The key goal of this PR is to introduce stripes and refactor the <code>MemoryPool</code> logic to allow this. MPK will be off by default for now: turning it on can still cause issues so use at your own risk! Eventually, once these issues are worked out (e.g., via fuzzing), the feature will be set to auto-enable so that the MPK part of this only is active if MPK is available on the system. This feature is mainly relevant to users on x86_64 Linux; a noop implementation fills in the API gaps for other environments.</p>\n</blockquote>",
        "id": 392220770,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695252135
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1636664915\">PR review</a>.</p>",
        "id": 392223034,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695254005
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1332291806\">PR review comment</a>:</p>\n<blockquote>\n<p>Guess I should not upgrade this package. It results in a huge vet certification and the addition of <code>unarray</code> which has unsafe code to audit. <code>wiggle</code> uses version 1.0.0 which is declared exempt as <code>safe-to-deploy</code>. I think we should only have to audit this as <code>safe-to-run</code> since it is a test dependency but once declared <code>safe-to-deploy</code> it would seem that we need to vet at the higher level.</p>\n</blockquote>",
        "id": 392223035,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695254005
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392223520,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695254416
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392223592,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695254469
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392224766,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695255545
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392226565,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695257154
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392348585,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695310932
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392354734,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695312963
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392354956,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695313061
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392356086,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695313461
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392356586,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695313644
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392369817,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695318886
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392397743,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331127
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1638567744\">PR review</a>.</p>",
        "id": 392398104,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331352
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1638567744\">PR review</a>.</p>",
        "id": 392398106,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331352
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333517320\">PR review comment</a>:</p>\n<blockquote>\n<p>s/allocated memory/allocated virtual memory/</p>\n</blockquote>",
        "id": 392398107,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331352
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333518738\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this enum be <code>pub use</code>'d here in this module to avoid users from needing to depend on <code>wasmtime-runtime</code>?</p>\n</blockquote>",
        "id": 392398108,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331352
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333518142\">PR review comment</a>:</p>\n<blockquote>\n<p>If you're ok with it I'd prefer to leave out mention of <code>wasmtime_runtime</code> since that's ideally a crate no one depends on but Wasmtime.</p>\n</blockquote>",
        "id": 392398109,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333520656\">PR review comment</a>:</p>\n<blockquote>\n<p>Could the <code>.unwrap()</code> be removed to ensure that the \"should panic\" part is the internals of <code>pkey_alloc</code>?</p>\n</blockquote>",
        "id": 392398110,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333519992\">PR review comment</a>:</p>\n<blockquote>\n<p>I think this can be replaced with <code>io::Error::last_os_error()</code> perhaps? (and returning <code>io::Error</code> instead of <code>String</code>)</p>\n</blockquote>",
        "id": 392398111,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333526964\">PR review comment</a>:</p>\n<blockquote>\n<p>One thing I might recommend is to investigate the <code>call</code> benchmark with <code>perf</code> to see if there's a perf regression on x86_64. These single-instruction functions for example are good candidates for <code>#[inline]</code> and will likely be required to get good perf.</p>\n</blockquote>",
        "id": 392398112,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333522281\">PR review comment</a>:</p>\n<blockquote>\n<p>Here this would actually best be represented as <code>pub enum ProtectionKey {}</code> which indicates that it's not only zero-sized but it actually can't exist at all. This would optmize <code>Option&lt;ProtectionKey&gt;</code> into a zero-size structure for example on unsupported platforms.</p>\n</blockquote>",
        "id": 392398113,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333527804\">PR review comment</a>:</p>\n<blockquote>\n<p>s/0/ALLOW_ACCESS/</p>\n</blockquote>",
        "id": 392398114,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333529587\">PR review comment</a>:</p>\n<blockquote>\n<p>This is something I think that we'll need to watch out for perf-wise in the <code>call</code> benchmarks. In theory I was hoping that this would be <code>pkru::write(mask.0)</code>.</p>\n</blockquote>",
        "id": 392398115,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333529870\">PR review comment</a>:</p>\n<blockquote>\n<p>This may be best as <code>trace!</code> lest it be otherwise pretty verbose</p>\n</blockquote>",
        "id": 392398116,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333536618\">PR review comment</a>:</p>\n<blockquote>\n<p>Could these two be <code>unreachable!()</code> to panic if they're accidentally called?</p>\n</blockquote>",
        "id": 392398117,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333600698\">PR review comment</a>:</p>\n<blockquote>\n<p>Should <code>Self</code> perhaps store the whole <code>layout</code> and maybe <code>constraints</code> while we're at it? (reducing duplication and keeping things close to their source of truth)</p>\n</blockquote>",
        "id": 392398118,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333539265\">PR review comment</a>:</p>\n<blockquote>\n<p>I think these docs are now duplicated with the memory pooling ones perhaps?</p>\n</blockquote>",
        "id": 392398119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333598764\">PR review comment</a>:</p>\n<blockquote>\n<p>We talked about this in person as well but I think that <code>limits.memory_pages</code> and <code>tunables.static_memory_bound</code> should be communicated separately to the <code>SlabConstraints</code>.</p>\n</blockquote>",
        "id": 392398120,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333599416\">PR review comment</a>:</p>\n<blockquote>\n<p>Generally I'm pretty wary of <code>as</code> casts related to memory code. It's not really an issue for 64-bit platforms but it's one where it can be an issue for 32-bit platforms possibly. Could the fields in <code>SlabConstraints</code> have the same types as the inputs here to avoid casts though?</p>\n</blockquote>",
        "id": 392398122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333607461\">PR review comment</a>:</p>\n<blockquote>\n<p>This is one check which I think that we'll want to change. By taking into account the two variables I mentioned above I think this may need to change. </p>\n<p>Rather I think the rough invariant we want to test here is that for all slots in the layout there are guard bytes before, there's <code>static_memory_bound + guard</code> bytes after it to the next slot in the stripe. This I think may be best modeled with extra methods on the layout such as <code>fn slot_offset(&amp;self, stripe: usize, slot: usize) -&gt; usize</code> or something like that. This loop could then check:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stripe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"n\">stripes</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">slot</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"n\">slots</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">assert_slot_is_valid</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">layout</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">stripe</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">slot</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>more-or-less</p>\n</blockquote>",
        "id": 392398123,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333602692\">PR review comment</a>:</p>\n<blockquote>\n<p>Since there's a method <code>as_unstriped_slot_index</code> could there perhaps be a sibiling method for converting in this direction instead of inlining here? Mostly in the hopes that keeping the two near each other would be helpful for future modifications</p>\n</blockquote>",
        "id": 392398124,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333617099\">PR review comment</a>:</p>\n<blockquote>\n<p>I might approach the calculation a bit differently here, along the lines of:</p>\n<ul>\n<li>There are two main invariants for each slot:<ul>\n<li>From the base pointer up to <code>limits.memory_pages</code> must be mappable as committed memory to be owned by the slot. AKA this is the minimum size of the slot.</li>\n<li>The region from <code>limits.memory_pages * PAGE_SIZE .. static_memory_bound + guard</code> must all be guaranteed to be inaccessible by the current slot, AKA it must either be a guard region or a different stripe</li>\n</ul>\n</li>\n<li>The maximum number of possible stripes is then <code>(static_memory_bound + guard) / (limits.memory_pages * PAGE_SIZE)</code>. For example with 4G bound, 2G guard, and 1G limit of growth, we can only use 6 stripes.</li>\n<li>If we have more stripes than the maximum needed, then everything is adjacent.</li>\n<li>If we have less stripes than the maximum, then each slot is inflated. For example with a 4G bound and a 2G guard and a 256MB limit, that's 24 maximum stripes but we can't ever have that many. If we got 8 stripes then I think each stripe is 6G/8 big, ~750M. This means each slot is 750M and will only ever use up to 256M of the beginning of it.</li>\n</ul>\n<p>Whether or not that's simpler or not than this current calculation I'm not sure, but this is at least how I've been thinking of it and how the difference between the memory limit and memory bound I think should be factored in.</p>\n</blockquote>",
        "id": 392398125,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333603283\">PR review comment</a>:</p>\n<blockquote>\n<p>copy/pasted comment</p>\n</blockquote>",
        "id": 392398127,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1333610766\">PR review comment</a>:</p>\n<blockquote>\n<p>I'd be a bit hesitant about doing some of the above calculations and then page-aligning afterwards. Could the inputs all be page-aligned at the beginning as appropriate instead?</p>\n</blockquote>",
        "id": 392398128,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695331353
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640177163\">PR review</a>.</p>",
        "id": 392542025,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695395779
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334520390\">PR review comment</a>:</p>\n<blockquote>\n<p>Just to confirm: we believe these are impossible because an engine configured with an on-demand allocator will never assign a pkey to one of the stores it creates?</p>\n</blockquote>",
        "id": 392542028,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695395780
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392546818,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695396955
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392560085,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695400146
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640374956\">PR review</a>.</p>",
        "id": 392569495,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695403291
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334647723\">PR review comment</a>:</p>\n<blockquote>\n<p>Correct yeah, or at least that's the theory</p>\n</blockquote>",
        "id": 392569496,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695403291
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392570351,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695403605
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640383712\">PR review</a>.</p>",
        "id": 392570582,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695403687
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334653707\">PR review comment</a>:</p>\n<blockquote>\n<p>I was tempted to do that but then worried that it would take up a few extra bytes. If you're ok with that, I'll move those in and maybe remove some of the fields that they duplicate.</p>\n</blockquote>",
        "id": 392570584,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695403687
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640391650\">PR review</a>.</p>",
        "id": 392571484,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695404052
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334659197\">PR review comment</a>:</p>\n<blockquote>\n<p>Well, it is very convenient to (1) have all these values use the same type so we can do the arithmetic directly without distracting conversions and (2) so we can interact with all the <code>std</code> stuff that just uses <code>usize</code>. Since they at some point need to be converted to the same type to do the arithmetic, would you prefer if I turned them all into <code>u64</code> here and then made conversions to <code>usize</code> in all the places we interact with slices/ranges/etc.?</p>\n</blockquote>",
        "id": 392571485,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695404052
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640393229\">PR review</a>.</p>",
        "id": 392571621,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695404129
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334660270\">PR review comment</a>:</p>\n<blockquote>\n<p>Alternately, I could just panic here with <code>.try_into().unwrap()</code>? (Or return an error... maybe 32-bit systems don't want to deal with memory sizes they can't address?)</p>\n</blockquote>",
        "id": 392571622,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695404129
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392572169,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695404327
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392572490,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695404440
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392573736,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695404977
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392575200,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695405572
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640495224\">PR review</a>.</p>",
        "id": 392583101,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695408978
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334725604\">PR review comment</a>:</p>\n<blockquote>\n<p>The more I read your comment, the more I think this logic is essentially saying the same thing. Ignoring the fact that maybe <code>static_memory_bound</code> isn't handled yet, the other differences are minor:</p>\n<ul>\n<li>I'm using <code>guard_bytes</code> for <code>static_memory_bound + guard</code> and <code>max_memory_byes</code> for <code>limits.memory_pages * PAGE_SIZE</code>; I think we need to settle on a single variable (bikeshed the name) to contain these values to avoid the mental juggling of \"oh, we mean how big the memory is by this calculation\"</li>\n<li>we need at least 2 stripes here, see <code>needed_num_stripes</code>; <code>guard_bytes / max_memory_bytes</code> is essentially what you wrote up above, but we need to handle the case where this doesn't divide evenly (<code>usize::from(...)</code>)</li>\n<li>we need to minimize the number of stripes, see <code>num_stripes</code>: we may have fewer pkeys or memory slots than stripes needed.</li>\n<li>to handle the slot-inflation case, I calculate <code>needed_guard_bytes</code>--I'm considering this the entire region after a memory that needs to be inaccessible, a.k.a the MPK-reduced original guard size</li>\n</ul>\n</blockquote>",
        "id": 392583102,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695408978
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640497159\">PR review</a>.</p>",
        "id": 392583296,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695409077
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334726930\">PR review comment</a>:</p>\n<blockquote>\n<p><code>max_memory_bytes</code> should be Wasm-page aligned but we need to realign after all the division, subtraction, etc.</p>\n</blockquote>",
        "id": 392583299,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695409078
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640499567\">PR review</a>.</p>",
        "id": 392583546,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695409194
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334728482\">PR review comment</a>:</p>\n<blockquote>\n<p><code>usize::try_from(...).unwrap()</code> would be my preferred route, if conversions are necessary and we can't just make them go away.</p>\n</blockquote>",
        "id": 392583547,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695409194
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640507777\">PR review</a>.</p>",
        "id": 392584748,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695409614
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334733421\">PR review comment</a>:</p>\n<blockquote>\n<p>Haven't finished reading through stuff but: will <code>pkeys.len()</code> and <code>layout.num_stripes</code> ever be different? If so, I find that pretty surprising. What's the motivation for that?</p>\n</blockquote>",
        "id": 392584749,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695409614
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334753476\">PR review comment</a>:</p>\n<blockquote>\n<p>If you want:</p>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>        self.stripes().iter().all(|s| s.allocator.is_empty())\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 392588431,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695411329
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640540319\">PR review</a>.</p>",
        "id": 392588432,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695411330
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640543017\">PR review</a>.</p>",
        "id": 392588703,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695411453
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334755136\">PR review comment</a>:</p>\n<blockquote>\n<p>I like these typed conversions between index types.</p>\n</blockquote>",
        "id": 392588704,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695411453
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640547613\">PR review</a>.</p>",
        "id": 392589235,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695411692
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334757883\">PR review comment</a>:</p>\n<blockquote>\n<p>\"Comprehends\" reads a little weird here?</p>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>    /// The size of each slot in the memory pool; this contains the maximum\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 392589236,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695411692
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640587088\">PR review</a>.</p>",
        "id": 392594311,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695413745
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334781922\">PR review comment</a>:</p>\n<blockquote>\n<p>Proposed alternative API to mpk from our discussion the other day:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">struct</span> <span class=\"nc\">PKeys</span><span class=\"p\">(</span><span class=\"kt\">u32</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// mask of pkey bits we are allowed to use</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">PKeys</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">new</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">PKeys</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// do this in a OnceLock, allocates pkeys from OS and creates the mask</span>\n\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">all_keys</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">PKeySet</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// Get the set of all of our pkeys</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// following methods have debug asserts that we only ever have pkeys that fit our mask</span>\n\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">activate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pkey</span>: <span class=\"nc\">PKey</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// activate one pkey</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">activate_many</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">set</span>: <span class=\"nc\">PKeySet</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// activate many pkeys at the same time</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">deactivate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pkey</span>: <span class=\"nc\">PKey</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// deactivate one pkey</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">deactivate_many</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">set</span>: <span class=\"nc\">PKeySet</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// deactivate many pkeys at the same time</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">protect</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pkey</span>: <span class=\"nc\">PKey</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">region</span>: <span class=\"o\">..</span><span class=\"p\">.);</span><span class=\"w\"> </span><span class=\"c1\">// do the pkey_mprotect thing on this region, associating it with the given pkey</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"nb\">Drop</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">PKeys</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// return our allocated pkeys to the OS</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">struct</span> <span class=\"nc\">PKey</span><span class=\"p\">(</span><span class=\"kt\">u32</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// just the bits for this pkey, must be within the PKeys mask</span>\n\n<span class=\"k\">struct</span> <span class=\"nc\">PKeySet</span><span class=\"p\">(</span><span class=\"kt\">u32</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"c1\">// bit set of multiple pkeys, all within the owning PKeys mask</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">PKeySet</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">empty</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">Self</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">// no bits set</span>\n<span class=\"p\">}</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 392594313,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695413745
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640593775\">PR review</a>.</p>",
        "id": 392594984,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695414120
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334786316\">PR review comment</a>:</p>\n<blockquote>\n<p>We might want to name this something a little more specific to MPK. <code>MpkEnabled</code>?</p>\n<p>Alternatively, I can imagine other scenarios where we will want tri-state, should-we-enable enums like this and we could keep this name but then make its documentation not mention MPK.</p>\n</blockquote>",
        "id": 392594985,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695414120
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640596624\">PR review</a>.</p>",
        "id": 392595368,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695414272
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334788091\">PR review comment</a>:</p>\n<blockquote>\n<p>Can we export a <code>PoolingAllocationConfig::mpk_available() -&gt; bool</code> static method? We have that internally anyways, and it seems like it would be useful to embedders.</p>\n</blockquote>",
        "id": 392595370,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695414272
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640597436\">PR review</a>.</p>",
        "id": 392595437,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695414315
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334788671\">PR review comment</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>    /// By default this value is `disabled`, but may become 'auto' in future releases.\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 392595439,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695414316
    },
    {
        "content": "<p>fitzgen edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334788671\">PR review comment</a>.</p>",
        "id": 392595462,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695414330
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640732466\">PR review</a>.</p>",
        "id": 392615077,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695424741
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334877616\">PR review comment</a>:</p>\n<blockquote>\n<p>Yes: imagine the case where we (for some odd reason) only want a pooling allocator to have five memory slots. We can only have a maximum of five stripes. If we have fifteen keys available, we need to pick a subset of them for striping.</p>\n</blockquote>",
        "id": 392615078,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695424741
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392615244,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695424820
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392615338,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695424896
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334879958\">PR review comment</a>:</p>\n<blockquote>\n<p>I agonized over this suggestion when I was refactoring this PR, trying to make it work. I _would_ like to have a more clear holding structure for the protection keys, especially in case we need to drop them at some point. But once we store things away in the <code>mpk</code> global state (<code>OnceLock</code>) there's no point to managing the lifetime with a separate struct; plus, it requires more code iterate over the keys, etc. What I settled on was <code>ProtectionMask</code>, which incorporates part of this, and then I just kept top-level functions (<code>keys</code>, <code>allow</code>, etc.) to make it more clear that the module itself is containing the state, not some struct. I do think we could re-factor this a bit as things move along; I left a <code>TODO</code> in there about this.</p>\n</blockquote>",
        "id": 392615861,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695425279
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1640735676\">PR review</a>.</p>",
        "id": 392615862,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695425279
    },
    {
        "content": "<p>abrown edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1334879958\">PR review comment</a>.</p>",
        "id": 392615918,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695425300
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 392615984,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695425357
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393067508,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695661761
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1642664476\">PR review</a>.</p>",
        "id": 393069172,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695662342
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1336184292\">PR review comment</a>:</p>\n<blockquote>\n<p>I think <code>wasmtime_runtime::mpk::is_available()</code> should be public already which is in the same crate?</p>\n</blockquote>",
        "id": 393069173,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695662342
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393069474,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695662431
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1642666895\">PR review</a>.</p>",
        "id": 393069499,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695662438
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1336185877\">PR review comment</a>:</p>\n<blockquote>\n<p>Renamed to <code>MpkEnabled</code>.</p>\n</blockquote>",
        "id": 393069501,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695662438
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1642881045\">PR review</a>.</p>",
        "id": 393096199,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695671217
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1336321419\">PR review comment</a>:</p>\n<blockquote>\n<p><code>wasmtime_runtime</code> is an implementation detail that isn't available to users of the public <code>wasmtime</code> API. So I am imagining that we would expose that functionality in the public <code>wasmtime</code> API, and as a static method on <code>PoolingAllocationConfig</code> seemed like a nice place but I am happy to bikeshed.</p>\n<p>This is also something that can be added after the initial MPK support lands.</p>\n</blockquote>",
        "id": 393096200,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695671217
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1643059850\">PR review</a>.</p>",
        "id": 393120857,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695680068
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1336435893\">PR review comment</a>:</p>\n<blockquote>\n<p>I realized as I went back over this that we don't ever need to iterate over slots: the layout has the sizes for every slot, so we just need to check that the layout is correct once: <code>assert!(s.slot_bytes * s.num_stripes &gt;= c.expected_slot_bytes + c.guard_bytes)</code>.</p>\n</blockquote>",
        "id": 393120858,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695680068
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393120935,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695680099
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1643061238\">PR review</a>.</p>",
        "id": 393121122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695680171
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1336436846\">PR review comment</a>:</p>\n<blockquote>\n<p>Ok, I think I'm doing this more correctly in 52b245a7d. I'm internally using <code>expected_slot_bytes</code> as the name since it is more descriptive (to me) than <code>static_memory_bound</code>.</p>\n</blockquote>",
        "id": 393121123,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695680171
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393121415,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695680323
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393129443,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695684509
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393130344,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695685187
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393146559,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695694678
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1644862566\">PR review</a>:</p>\n<blockquote>\n<p>Nice I like how the calculation ended up <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> </p>\n<p>Could this still have a test though which is along the lines of \"check the guard/inaccessible property for the first slot of each stripe, the last, and one in the middle\"? Currently there's \"Check that the memory-striping will not allow OOB access\" but if you're ok I'd like to be a bit more pedantic and assert individually for each slot in the stripe (assuming all \"middle slots\" are the same and only the first/last/middle are the interesting ones)</p>\n</blockquote>",
        "id": 393319111,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758955
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1644862566\">PR review</a>:</p>\n<blockquote>\n<p>Nice I like how the calculation ended up <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> </p>\n<p>Could this still have a test though which is along the lines of \"check the guard/inaccessible property for the first slot of each stripe, the last, and one in the middle\"? Currently there's \"Check that the memory-striping will not allow OOB access\" but if you're ok I'd like to be a bit more pedantic and assert individually for each slot in the stripe (assuming all \"middle slots\" are the same and only the first/last/middle are the interesting ones)</p>\n</blockquote>",
        "id": 393319112,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758955
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337579087\">PR review comment</a>:</p>\n<blockquote>\n<p>as a \"neat trick\" you can replace the body of this method with <code>match *self {}</code> which is a way to code-document \"this isn't reachable\" and it's compiler-checked where if it becomes reachable that becomes an error one day. Same with the one below, and it avoids the question of \"what if this is accidentally called?\"</p>\n</blockquote>",
        "id": 393319114,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758955
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337705362\">PR review comment</a>:</p>\n<blockquote>\n<p>One thing we talked about which I wanted to write down here (but doesn't have to be handled in this PR) -- if a newly spawned thread disallows all but protection key 0 then that's a problem for us since we only frob the mask in/out of wasm and new threads may not do that. (e.g. think like a hostcall that gets a chunk of wasm memory and uses rayon to operate on it)</p>\n</blockquote>",
        "id": 393319116,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758955
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337705981\">PR review comment</a>:</p>\n<blockquote>\n<p>Mind updating these variable names with their <code>layout.$name</code> equivalent?</p>\n</blockquote>",
        "id": 393319117,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758955
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337710097\">PR review comment</a>:</p>\n<blockquote>\n<p>It might be worth expanding this to say that the compression and fitting things in the guard region is what's theoretically happening but representation-wise we're shrinking the slot instead and allocating more slots.</p>\n</blockquote>",
        "id": 393319118,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758956
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337707605\">PR review comment</a>:</p>\n<blockquote>\n<p>This I don't think is quite right because the <code>bound</code> here is actually a function of the distance from one stripe's slot to the next slot in the same stripe. I think <code>slot_bytes</code> is the per-slot size which doesn't account for this?</p>\n</blockquote>",
        "id": 393319119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758956
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337711542\">PR review comment</a>:</p>\n<blockquote>\n<p>I saw the <code>.try_into()</code> above to avoid a lossy <code>as</code>, and sorry you may have already mentioned this, but could the inputs here be <code>u64</code> instead of <code>usize</code>? (or whatever the original type was for each variable) </p>\n<p>Otherwise this is a portability risk to 32-bit where a 64-bit size is requested causing the <code>.try_into().unwrap()</code> above to panic instead of return an error. Since many calculations below already handle overflow I figure it'd be easier to handle it there then above.</p>\n</blockquote>",
        "id": 393319120,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758956
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337713146\">PR review comment</a>:</p>\n<blockquote>\n<p>Instead of returning a <code>Result</code> here could the <code>Result</code> be pushed to <code>calculate</code> instead? That way this function itself would be infallible</p>\n</blockquote>",
        "id": 393319121,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758956
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337720304\">PR review comment</a>:</p>\n<blockquote>\n<p>Also reading further I see now that this is infallible if <code>calculate</code> returns <code>Ok</code>.</p>\n<p>In that case I think it's fine to leave this as-is, I see how it's hard to deduplicate otherwise.</p>\n</blockquote>",
        "id": 393319122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758956
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337708938\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this return <code>(u32, Self)</code> to move inference of the stripe from <code>index</code> here too?</p>\n</blockquote>",
        "id": 393319123,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758956
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1337721080\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this additionally check that the guard sizes are also page aligned?</p>\n</blockquote>",
        "id": 393319124,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695758956
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1647190744\">PR review</a>.</p>",
        "id": 393535244,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695834160
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1338932998\">PR review comment</a>:</p>\n<blockquote>\n<p>If some 32-bit user requests some kind memory configuration requiring 64-bit-sized addresses, how does that even work on a 32-bit machine? Don't we want to fail them early? Perhaps with a more descriptive error than an <code>unwrap()</code>?</p>\n</blockquote>",
        "id": 393535245,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695834161
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1647195520\">PR review</a>.</p>",
        "id": 393535740,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695834343
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1338936475\">PR review comment</a>:</p>\n<blockquote>\n<p>(Part of the reason this is readable is because of this \"use <code>usize</code> everywhere\" choice. When I switch to <code>u64</code> there are 40+ other places that will need to be fixed up with <code>try_into</code> or <code>as</code>).</p>\n</blockquote>",
        "id": 393535741,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695834343
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1647259733\">PR review</a>.</p>",
        "id": 393541789,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695836777
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1338985564\">PR review comment</a>:</p>\n<blockquote>\n<p>Definitely making a request on a 32-bit machine that can't be satisfied should return an error, but IMO it should be a normal error instead of a panic. Also to clarify I don't think everything should change to <code>u64</code>, only this structure. The <code>SlotLayout</code> structure should definitely use <code>usize</code> as it's tailored for the current machine, and my hope would be that <code>calculate</code> is the only location where <code>u64</code> is translated to <code>usize</code>, fallibly</p>\n</blockquote>",
        "id": 393541790,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695836778
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393546363,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695838544
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#pullrequestreview-1647549142\">PR review</a>.</p>",
        "id": 393569320,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695848234
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072#discussion_r1339206424\">PR review comment</a>:</p>\n<blockquote>\n<p>Ok, I misunderstood... for some reason I thought we were trying to refactor SlabLayout. Let me try this...</p>\n</blockquote>",
        "id": 393569321,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695848234
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393583029,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695856179
    },
    {
        "content": "<p><strong>abrown</strong> has marked <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a> as ready for review.</p>",
        "id": 393583049,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695856202
    },
    {
        "content": "<p><strong>abrown</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393583063,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695856204
    },
    {
        "content": "<p><strong>abrown</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393583065,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695856204
    },
    {
        "content": "<p><strong>abrown</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393583066,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695856204
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393584506,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695857369
    },
    {
        "content": "<p>abrown has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393584722,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695857503
    },
    {
        "content": "<p>abrown merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7072\">PR #7072</a>.</p>",
        "id": 393594106,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1695863332
    }
]