[
    {
        "content": "<p>arlyon opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033\">issue #8033</a>:</p>\n<blockquote>\n<p>Thanks for filing a feature request! Please fill out the TODOs below.</p>\n<h4>Feature</h4>\n<p>I am using a WasiHttpView to selectively allow / reject destination authorities for the outgoing-handler. If the sandbox rejects a  request, I would expect it to return an error to <code>outgoing_handler::handle</code> on the guest such that they may handle it, however that is not the case.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">send_request</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">request</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">OutgoingRequest</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">wasmtime</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span>\n<span class=\"w\">        </span><span class=\"n\">wasmtime</span>::<span class=\"n\">component</span>::<span class=\"n\">Resource</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">HostFutureIncomingResponse</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">where</span>\n<span class=\"w\">        </span><span class=\"bp\">Self</span>: <span class=\"nb\">Sized</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// try to remove the port if it exists</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">authority</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">request</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">authority</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">rsplit_once</span><span class=\"p\">(</span><span class=\"sc\">':'</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"p\">(</span><span class=\"n\">authority</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">authority</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">unwrap_or</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">authority</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">allowed_authorities</span><span class=\"p\">.</span><span class=\"n\">contains</span><span class=\"p\">(</span><span class=\"n\">authority</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span>::<span class=\"n\">error</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                </span><span class=\"s\">\"plugin tried to access {} which is not in the list of allowed authorities\"</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">authority</span>\n<span class=\"w\">            </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">wasmtime</span>::<span class=\"n\">Error</span>::<span class=\"n\">msg</span><span class=\"p\">(</span><span class=\"s\">\"not allowed to access authority\"</span><span class=\"p\">));</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n\n<span class=\"w\">        </span><span class=\"n\">default_send_request</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// inside guest</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">outgoing_handler</span>::<span class=\"n\">handle</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">None</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">tracing</span>::<span class=\"n\">error</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"unable to send request\"</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">continue</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n</code></pre></div>\n<p>In reality, throwing an error here does not return control to the guest, but throws an error which is trapped by the runtime. Note the first line is my error handling:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Error</span>:\n   <span class=\"mi\">0</span>: <span class=\"nc\">plugin</span><span class=\"w\"> </span><span class=\"n\">london</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">update</span>: <span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n          <span class=\"mi\">0</span>: <span class=\"mh\">0x4cf4f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span>:<span class=\"nc\">shim</span><span class=\"o\">!</span><span class=\"n\">indirect</span><span class=\"o\">-</span><span class=\"n\">wasi</span>:<span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">outgoing</span><span class=\"o\">-</span><span class=\"n\">handler</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"o\">-</span><span class=\"n\">handle</span>\n<span class=\"w\">          </span><span class=\"mi\">1</span>: <span class=\"mh\">0x33c42</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">881</span><span class=\"o\">&gt;</span>\n\n<span class=\"w\">      </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n          <span class=\"nc\">not</span><span class=\"w\"> </span><span class=\"n\">allowed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"n\">authority</span>\n\n<span class=\"w\">      </span><span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n         <span class=\"mi\">0</span>: <span class=\"nc\">anyhow</span>::<span class=\"n\">error</span>::<span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">anyhow</span>::<span class=\"n\">Error</span><span class=\"o\">&gt;</span>::<span class=\"n\">msg</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">registry</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">index</span><span class=\"p\">.</span><span class=\"n\">crates</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"o\">-</span><span class=\"mi\">6</span><span class=\"n\">f17d22bba15001f</span><span class=\"o\">/</span><span class=\"n\">anyhow</span><span class=\"o\">-</span><span class=\"mf\">1.0.77</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">83</span>:<span class=\"mi\">36</span>\n<span class=\"w\">         </span><span class=\"mi\">1</span>: <span class=\"o\">&lt;</span><span class=\"n\">litehouse</span>::<span class=\"n\">runtime</span>::<span class=\"n\">PluginRunner</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">WasiHttpView</span><span class=\"o\">&gt;</span>::<span class=\"n\">send_request</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">litehouse</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">94</span>:<span class=\"mi\">24</span>\n<span class=\"w\">         </span><span class=\"mi\">2</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">http_impl</span>::<span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">bindings</span>::<span class=\"n\">wasi</span>::<span class=\"n\">http</span>::<span class=\"n\">outgoing_handler</span>::<span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span>::<span class=\"n\">handle</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">http_impl</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">97</span>:<span class=\"mi\">15</span>\n<span class=\"w\">         </span><span class=\"mi\">3</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">bindings</span>::<span class=\"n\">wasi</span>::<span class=\"n\">http</span>::<span class=\"n\">outgoing_handler</span>::<span class=\"n\">add_to_linker</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">11</span>:<span class=\"mi\">5</span>\n<span class=\"w\">         </span><span class=\"mi\">4</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">HostFunc</span>::<span class=\"n\">entrypoint</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">68</span>:<span class=\"mi\">35</span>\n<span class=\"w\">         </span><span class=\"mi\">5</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">call_host</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">227</span>:<span class=\"mi\">15</span>\n<span class=\"w\">         </span><span class=\"mi\">6</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">HostFunc</span>::<span class=\"n\">entrypoint</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">60</span>:<span class=\"mi\">17</span>\n<span class=\"w\">         </span><span class=\"mi\">7</span>: <span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">panic</span>::<span class=\"n\">unwind_safe</span>::<span class=\"n\">AssertUnwindSafe</span><span class=\"o\">&lt;</span><span class=\"n\">F</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">function</span>::<span class=\"nb\">FnOnce</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;&gt;</span>::<span class=\"n\">call_once</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"mi\">30</span><span class=\"n\">dfb9e046aeb878db04332c74de76e52fb7db10</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">core</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">panic</span><span class=\"o\">/</span><span class=\"n\">unwind_safe</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">272</span>:<span class=\"mi\">9</span>\n</code></pre></div>\n<h4>Benefit</h4>\n<p>Plugins should be allowed to recover in this case.</p>\n<h4>Implementation</h4>\n<p>No dice, I am not super familiar with how adding this capability would fit into the wider system.</p>\n<h4>Alternatives</h4>\n<p>For now, crashing the plugin is OK but not desirable. I would like the plugin author to be able to control how it is handled.<br>\n</p>\n</blockquote>",
        "id": 424117850,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1709244634
    },
    {
        "content": "<p>arlyon edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033\">issue #8033</a>:</p>\n<blockquote>\n<p>Thanks for filing a feature request! Please fill out the TODOs below.</p>\n<h4>Feature</h4>\n<p>I am using a WasiHttpView to selectively allow / reject destination authorities for the outgoing-handler. If the sandbox rejects a  request, I would expect it to return an error to <code>outgoing_handler::handle</code> on the guest such that they may handle it, however that is not the case.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">send_request</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">request</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">OutgoingRequest</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">wasmtime</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span>\n<span class=\"w\">        </span><span class=\"n\">wasmtime</span>::<span class=\"n\">component</span>::<span class=\"n\">Resource</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">HostFutureIncomingResponse</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">where</span>\n<span class=\"w\">        </span><span class=\"bp\">Self</span>: <span class=\"nb\">Sized</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// try to remove the port if it exists</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">authority</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">request</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">authority</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">rsplit_once</span><span class=\"p\">(</span><span class=\"sc\">':'</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"p\">(</span><span class=\"n\">authority</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">authority</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">unwrap_or</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">authority</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">allowed_authorities</span><span class=\"p\">.</span><span class=\"n\">contains</span><span class=\"p\">(</span><span class=\"n\">authority</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span>::<span class=\"n\">error</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                </span><span class=\"s\">\"plugin tried to access {} which is not in the list of allowed authorities\"</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">authority</span>\n<span class=\"w\">            </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">wasmtime</span>::<span class=\"n\">Error</span>::<span class=\"n\">msg</span><span class=\"p\">(</span><span class=\"s\">\"not allowed to access authority\"</span><span class=\"p\">));</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n\n<span class=\"w\">        </span><span class=\"n\">default_send_request</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// inside guest</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">outgoing_handler</span>::<span class=\"n\">handle</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">None</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">tracing</span>::<span class=\"n\">error</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"unable to send request\"</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">continue</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n</code></pre></div>\n<p>In reality, throwing an error here does not return control to the guest, but throws an error which is trapped by the runtime. Note the first line is my error handling:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Error</span>:\n   <span class=\"mi\">0</span>: <span class=\"nc\">plugin</span><span class=\"w\"> </span><span class=\"n\">london</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">update</span>: <span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n          <span class=\"mi\">0</span>: <span class=\"mh\">0x4cf4f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span>:<span class=\"nc\">shim</span><span class=\"o\">!</span><span class=\"n\">indirect</span><span class=\"o\">-</span><span class=\"n\">wasi</span>:<span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">outgoing</span><span class=\"o\">-</span><span class=\"n\">handler</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"o\">-</span><span class=\"n\">handle</span>\n<span class=\"w\">          </span><span class=\"mi\">1</span>: <span class=\"mh\">0x33c42</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">881</span><span class=\"o\">&gt;</span>\n\n<span class=\"w\">      </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n          <span class=\"nc\">not</span><span class=\"w\"> </span><span class=\"n\">allowed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"n\">authority</span>\n\n<span class=\"w\">      </span><span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n         <span class=\"mi\">0</span>: <span class=\"nc\">anyhow</span>::<span class=\"n\">error</span>::<span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">anyhow</span>::<span class=\"n\">Error</span><span class=\"o\">&gt;</span>::<span class=\"n\">msg</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">registry</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">index</span><span class=\"p\">.</span><span class=\"n\">crates</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"o\">-</span><span class=\"mi\">6</span><span class=\"n\">f17d22bba15001f</span><span class=\"o\">/</span><span class=\"n\">anyhow</span><span class=\"o\">-</span><span class=\"mf\">1.0.77</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">83</span>:<span class=\"mi\">36</span>\n<span class=\"w\">         </span><span class=\"mi\">1</span>: <span class=\"o\">&lt;</span><span class=\"n\">litehouse</span>::<span class=\"n\">runtime</span>::<span class=\"n\">PluginRunner</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">WasiHttpView</span><span class=\"o\">&gt;</span>::<span class=\"n\">send_request</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">litehouse</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">94</span>:<span class=\"mi\">24</span>\n<span class=\"w\">         </span><span class=\"mi\">2</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">http_impl</span>::<span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">bindings</span>::<span class=\"n\">wasi</span>::<span class=\"n\">http</span>::<span class=\"n\">outgoing_handler</span>::<span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span>::<span class=\"n\">handle</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">http_impl</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">97</span>:<span class=\"mi\">15</span>\n<span class=\"w\">         </span><span class=\"mi\">3</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">bindings</span>::<span class=\"n\">wasi</span>::<span class=\"n\">http</span>::<span class=\"n\">outgoing_handler</span>::<span class=\"n\">add_to_linker</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">11</span>:<span class=\"mi\">5</span>\n<span class=\"w\">         </span><span class=\"mi\">4</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">HostFunc</span>::<span class=\"n\">entrypoint</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">68</span>:<span class=\"mi\">35</span>\n<span class=\"w\">         </span><span class=\"mi\">5</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">call_host</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">227</span>:<span class=\"mi\">15</span>\n<span class=\"w\">         </span><span class=\"mi\">6</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">HostFunc</span>::<span class=\"n\">entrypoint</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">60</span>:<span class=\"mi\">17</span>\n<span class=\"w\">         </span><span class=\"mi\">7</span>: <span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">panic</span>::<span class=\"n\">unwind_safe</span>::<span class=\"n\">AssertUnwindSafe</span><span class=\"o\">&lt;</span><span class=\"n\">F</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">function</span>::<span class=\"nb\">FnOnce</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;&gt;</span>::<span class=\"n\">call_once</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"mi\">30</span><span class=\"n\">dfb9e046aeb878db04332c74de76e52fb7db10</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">core</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">panic</span><span class=\"o\">/</span><span class=\"n\">unwind_safe</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">272</span>:<span class=\"mi\">9</span>\n\n<span class=\"o\">..</span><span class=\"p\">.</span>\n</code></pre></div>\n<h4>Benefit</h4>\n<p>Plugins should be allowed to recover in this case.</p>\n<h4>Implementation</h4>\n<p>No dice, I am not super familiar with how adding this capability would fit into the wider system.</p>\n<h4>Alternatives</h4>\n<p>For now, crashing the plugin is OK but not desirable. I would like the plugin author to be able to control how it is handled.<br>\n</p>\n</blockquote>",
        "id": 424117897,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1709244655
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033#issuecomment-1972173497\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033\">issue #8033</a>:</p>\n<blockquote>\n<p>Thanks for the report!</p>\n<p>In the WIT itself there's the ability to return an <code>error-code</code>, and would that be sufficient for your use case here? If so I think that the <code>WasiHttpView</code> isn't quite set up to plumb an error through to the place where it's called, for example <a href=\"https://github.com/bytecodealliance/wasmtime/blob/9949140d4a3187f61dd53692edf714b478436161/crates/wasi-http/src/http_impl.rs#L97-L104\">here</a> the error is propagated with <code>?</code> which is where the trap comes from. If that location is updated to try to downcast the error to an <code>ErrorCode</code>, however, that I think would then enable you to return an <code>ErrorCode</code> in your custom implementation?</p>\n<p>Would you be interested in making a PR for this change?</p>\n</blockquote>",
        "id": 424131968,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1709251195
    },
    {
        "content": "<p>arlyon <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033#issuecomment-1972930437\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033\">issue #8033</a>:</p>\n<blockquote>\n<p>Yes! Thanks for the pointers, the change was fairly straightforward. Figuring out the test setup was a little more complex but all good now. PR linked above.</p>\n</blockquote>",
        "id": 424200908,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1709288929
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033\">issue #8033</a>:</p>\n<blockquote>\n<p>Thanks for filing a feature request! Please fill out the TODOs below.</p>\n<h4>Feature</h4>\n<p>I am using a WasiHttpView to selectively allow / reject destination authorities for the outgoing-handler. If the sandbox rejects a  request, I would expect it to return an error to <code>outgoing_handler::handle</code> on the guest such that they may handle it, however that is not the case.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">send_request</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">request</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">OutgoingRequest</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">wasmtime</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span>\n<span class=\"w\">        </span><span class=\"n\">wasmtime</span>::<span class=\"n\">component</span>::<span class=\"n\">Resource</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">HostFutureIncomingResponse</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">where</span>\n<span class=\"w\">        </span><span class=\"bp\">Self</span>: <span class=\"nb\">Sized</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// try to remove the port if it exists</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">authority</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">request</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">authority</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">rsplit_once</span><span class=\"p\">(</span><span class=\"sc\">':'</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"p\">(</span><span class=\"n\">authority</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">authority</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">unwrap_or</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">authority</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">allowed_authorities</span><span class=\"p\">.</span><span class=\"n\">contains</span><span class=\"p\">(</span><span class=\"n\">authority</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">tracing</span>::<span class=\"n\">error</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                </span><span class=\"s\">\"plugin tried to access {} which is not in the list of allowed authorities\"</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">authority</span>\n<span class=\"w\">            </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">wasmtime</span>::<span class=\"n\">Error</span>::<span class=\"n\">msg</span><span class=\"p\">(</span><span class=\"s\">\"not allowed to access authority\"</span><span class=\"p\">));</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n\n<span class=\"w\">        </span><span class=\"n\">default_send_request</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// inside guest</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">outgoing_handler</span>::<span class=\"n\">handle</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">None</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">tracing</span>::<span class=\"n\">error</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">\"unable to send request\"</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">continue</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n</code></pre></div>\n<p>In reality, throwing an error here does not return control to the guest, but throws an error which is trapped by the runtime. Note the first line is my error handling:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Error</span>:\n   <span class=\"mi\">0</span>: <span class=\"nc\">plugin</span><span class=\"w\"> </span><span class=\"n\">london</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">update</span>: <span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n          <span class=\"mi\">0</span>: <span class=\"mh\">0x4cf4f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span>:<span class=\"nc\">shim</span><span class=\"o\">!</span><span class=\"n\">indirect</span><span class=\"o\">-</span><span class=\"n\">wasi</span>:<span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">outgoing</span><span class=\"o\">-</span><span class=\"n\">handler</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"o\">-</span><span class=\"n\">handle</span>\n<span class=\"w\">          </span><span class=\"mi\">1</span>: <span class=\"mh\">0x33c42</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">881</span><span class=\"o\">&gt;</span>\n\n<span class=\"w\">      </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span>:\n          <span class=\"nc\">not</span><span class=\"w\"> </span><span class=\"n\">allowed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"n\">authority</span>\n\n<span class=\"w\">      </span><span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n         <span class=\"mi\">0</span>: <span class=\"nc\">anyhow</span>::<span class=\"n\">error</span>::<span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">anyhow</span>::<span class=\"n\">Error</span><span class=\"o\">&gt;</span>::<span class=\"n\">msg</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">registry</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">index</span><span class=\"p\">.</span><span class=\"n\">crates</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"o\">-</span><span class=\"mi\">6</span><span class=\"n\">f17d22bba15001f</span><span class=\"o\">/</span><span class=\"n\">anyhow</span><span class=\"o\">-</span><span class=\"mf\">1.0.77</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">83</span>:<span class=\"mi\">36</span>\n<span class=\"w\">         </span><span class=\"mi\">1</span>: <span class=\"o\">&lt;</span><span class=\"n\">litehouse</span>::<span class=\"n\">runtime</span>::<span class=\"n\">PluginRunner</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">types</span>::<span class=\"n\">WasiHttpView</span><span class=\"o\">&gt;</span>::<span class=\"n\">send_request</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">litehouse</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">94</span>:<span class=\"mi\">24</span>\n<span class=\"w\">         </span><span class=\"mi\">2</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">http_impl</span>::<span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi_http</span>::<span class=\"n\">bindings</span>::<span class=\"n\">wasi</span>::<span class=\"n\">http</span>::<span class=\"n\">outgoing_handler</span>::<span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span>::<span class=\"n\">handle</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">http_impl</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">97</span>:<span class=\"mi\">15</span>\n<span class=\"w\">         </span><span class=\"mi\">3</span>: <span class=\"nc\">wasmtime_wasi_http</span>::<span class=\"n\">bindings</span>::<span class=\"n\">wasi</span>::<span class=\"n\">http</span>::<span class=\"n\">outgoing_handler</span>::<span class=\"n\">add_to_linker</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">11</span>:<span class=\"mi\">5</span>\n<span class=\"w\">         </span><span class=\"mi\">4</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">HostFunc</span>::<span class=\"n\">entrypoint</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">68</span>:<span class=\"mi\">35</span>\n<span class=\"w\">         </span><span class=\"mi\">5</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">call_host</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">227</span>:<span class=\"mi\">15</span>\n<span class=\"w\">         </span><span class=\"mi\">6</span>: <span class=\"nc\">wasmtime</span>::<span class=\"n\">runtime</span>::<span class=\"n\">component</span>::<span class=\"n\">func</span>::<span class=\"n\">host</span>::<span class=\"n\">HostFunc</span>::<span class=\"n\">entrypoint</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">arlyon</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">cargo</span><span class=\"o\">/</span><span class=\"n\">git</span><span class=\"o\">/</span><span class=\"n\">checkouts</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mi\">41807828</span><span class=\"n\">cb3a7a7e</span><span class=\"o\">/</span><span class=\"mi\">4</span><span class=\"n\">d54a99</span><span class=\"o\">/</span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">func</span><span class=\"o\">/</span><span class=\"n\">host</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">60</span>:<span class=\"mi\">17</span>\n<span class=\"w\">         </span><span class=\"mi\">7</span>: <span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">panic</span>::<span class=\"n\">unwind_safe</span>::<span class=\"n\">AssertUnwindSafe</span><span class=\"o\">&lt;</span><span class=\"n\">F</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">function</span>::<span class=\"nb\">FnOnce</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;&gt;</span>::<span class=\"n\">call_once</span>\n<span class=\"w\">                   </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"mi\">30</span><span class=\"n\">dfb9e046aeb878db04332c74de76e52fb7db10</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">core</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">panic</span><span class=\"o\">/</span><span class=\"n\">unwind_safe</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">272</span>:<span class=\"mi\">9</span>\n\n<span class=\"o\">..</span><span class=\"p\">.</span>\n</code></pre></div>\n<h4>Benefit</h4>\n<p>Plugins should be allowed to recover in this case.</p>\n<h4>Implementation</h4>\n<p>No dice, I am not super familiar with how adding this capability would fit into the wider system.</p>\n<h4>Alternatives</h4>\n<p>For now, crashing the plugin is OK but not desirable. I would like the plugin author to be able to control how it is handled.<br>\n</p>\n</blockquote>",
        "id": 424308576,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1709319564
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033#issuecomment-1973755889\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8033\">issue #8033</a>:</p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8035\">https://github.com/bytecodealliance/wasmtime/pull/8035</a>, so closing (thanks!)</p>\n</blockquote>",
        "id": 424308577,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1709319564
    }
]