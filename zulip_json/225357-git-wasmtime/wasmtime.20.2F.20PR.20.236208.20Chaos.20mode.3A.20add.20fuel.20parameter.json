[
    {
        "content": "<p>remlse opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a> from <code>remlse:chaos-mode-fuel-param</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>part of #4134 </p>\n<p>The fuel parameter limits the maximum number of perturbations introduced by the control plane. It can be used to binary-search for specific perturbations that triggered a bug.</p>\n</blockquote>",
        "id": 349064755,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681381121
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#pullrequestreview-1386172911\">PR review</a>.</p>",
        "id": 350044961,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681505818
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 350966706,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1681890650
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 353188301,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682587757
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 353285817,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682601019
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 353296487,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682602387
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 353423462,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682618508
    },
    {
        "content": "<p><strong>remlse</strong> has marked <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a> as ready for review.</p>",
        "id": 353765235,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682675719
    },
    {
        "content": "<p><strong>remlse</strong> requested <a href=\"https://github.com/jameysharp\">jameysharp</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 353765256,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682675721
    },
    {
        "content": "<p><strong>remlse</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers\">wasmtime-fuzz-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 353765258,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682675721
    },
    {
        "content": "<p><strong>remlse</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 353765260,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682675721
    },
    {
        "content": "<p><strong>remlse</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 353765261,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682675721
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#pullrequestreview-1406347238\">PR review</a>.</p>",
        "id": 353999658,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682703567
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#pullrequestreview-1406347238\">PR review</a>.</p>",
        "id": 353999660,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682703567
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1180660307\">PR review comment</a>:</p>\n<blockquote>\n<p>I would describe this a little differently, because the intent is for this to be able to control other compiler mutations as well, not just those introduced by chaos-mode. \"Set the fuel limit, which controls the number of mutations or optimizations that the compiler will perform before stopping. Currently applies to chaos perturbations but may apply to other optimization decisions in the future.\" or something like that?</p>\n</blockquote>",
        "id": 353999661,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682703567
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1180659269\">PR review comment</a>:</p>\n<blockquote>\n<p>This doc-comment covers two of the three cases I think -- it also returns <code>true</code> if fuel is activated and there is enough fuel, right?</p>\n<p>It might make sense to describe at a slightly higher level: \"Tries to consume fuel, returning true if successful (or if fuel-limiting is disabled).\"</p>\n</blockquote>",
        "id": 353999662,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682703567
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1180663868\">PR review comment</a>:</p>\n<blockquote>\n<p>This is unfortunately not the right way to go about this, I think: we should funnel all settings that control compilation through the settings plumbing, rather than pulling inputs from implicit/ambient environment. (The latter may seem easier for a specific setting, such as running a fuzz case on the command line, but can lead to really surprising and subtle bugs later, and also precludes other options like a tool that bisects automatically.)</p>\n<p>I think this is a good opportunity to flesh out the text format, not just for printing but for parsing as well. If we can print a textual form of the control-plane (analogous to the <code>set option=value</code>, we could have <code>control_plane chaos=... fuel=...</code> or somesuch) and parse it, then the fuzzing debug flow would be: print the formatted fuzz testcase as CLIF; then iterate on it by tweaking the setting. Alternately we can add command-line options to <code>clif-util test</code>.</p>\n</blockquote>",
        "id": 353999663,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682703567
    },
    {
        "content": "<p>remlse created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1182453252\">PR review comment</a>:</p>\n<blockquote>\n<p>I'm assuming the subtle bugs you're referring to would be forgetting to set the fuel correctly in some case. To address this, I think it's necessary to remove the <code>Arbitrary</code> implementation of the control plane to avoid constructing one without having consulted the fuel setting first.</p>\n<p>The ad-hoc CLI argument parsing is still there, now in the TestCase arbitrary implementation. Which feels a little dirty. But I didn't see another way, I thought it was more important to ensure a control plane is created with the fuel already specified.</p>\n<p>The text representation and parsing I'm still working on.</p>\n<p>If the control plane fuel is part of cranelift's settings, should it be part of the text representation of a control plane as well? How should a text representation like this be interpreted:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">other_flags</span><span class=\"o\">&gt;</span>\n<span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">control_plane_fuel</span><span class=\"o\">=</span><span class=\"mi\">16</span>\n<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">target</span><span class=\"o\">&gt;</span>\n\n<span class=\"n\">control_plane</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"o\">=</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">=</span><span class=\"mi\">1100</span>\n<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">function</span><span class=\"o\">&gt;</span>\n</code></pre></div>\n<p>What if the control plane value (8) is a different one than the cranelift setting (16)?</p>\n</blockquote>",
        "id": 355127571,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683028880
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355127589,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683028887
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355128136,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683029000
    },
    {
        "content": "<p>remlse created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1182469211\">PR review comment</a>:</p>\n<blockquote>\n<p>I've tried to incorporate the general information in there into the heading at the crate level documentation and linked to that from <code>ControlPlane::new</code> (which replaces <code>set_fuel</code>).</p>\n</blockquote>",
        "id": 355131665,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683029839
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1183179766\">PR review comment</a>:</p>\n<blockquote>\n<blockquote>\n<p>I'm assuming the subtle bugs you're referring to would be forgetting to set the fuel correctly in some case. To address this, I think it's necessary to remove the Arbitrary implementation of the control plane to avoid constructing one without having consulted the fuel setting first.</p>\n</blockquote>\n<p>Is it necessarily only one or the other? Why is discarding <code>Arbitrary</code> altogether the only other choice? For example, could we instead inject a fuel value into the control-plane object after creating one with <code>Arbitrary</code>?</p>\n<p>More generally: reading environment variables from inside a library is to be avoided because it circumvents the embedder's control of the library, and means that the library's behavior will be non-deterministic from the point of view of the API user. I ask for a control-plane with some bytes and compile on my system; you do the same on your system; we get two different results, because our ambient process state is different.</p>\n<p>So the sort of bug I worry about isn't \"forgot to set fuel\" but \"perplexing divergence in behavior that only makes sense once we check all basic assumptions and examine our shell configuration for environment variables\" -- much less fun to debug!</p>\n</blockquote>",
        "id": 355297156,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683078277
    },
    {
        "content": "<p>remlse created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1183346475\">PR review comment</a>:</p>\n<blockquote>\n<p>The argument parsing is still in the same file, the fuzz target<br>\n<code>cranelift-fuzzgen</code>. Which library do you mean?</p>\n<p>I guess the problem I was working around is that the flags are generated in the <code>Arbitrary</code> implementation of <code>TestCase</code>, which doesn't take any arguments. And it's not possible to change the flags afterwards (?).</p>\n<p>So it seems to me the CLI argument must be parsed before or during the the construction of an arbitrary <code>TestCase</code>. Otherwise we can't set the appropriate cranelift flag. Parsing CLI args <em>before</em> test case generation with arbitrary doesn't work though:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">fuzz_target</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">data</span>: <span class=\"kp\">&amp;</span><span class=\"p\">[</span><span class=\"kt\">u8</span><span class=\"p\">]</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">env</span>::<span class=\"n\">args</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">find_map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">arg</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"p\">.</span><span class=\"n\">strip_prefix</span><span class=\"p\">(</span><span class=\"s\">\"--fuel=\"</span><span class=\"p\">).</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">.</span><span class=\"n\">to_owned</span><span class=\"p\">()))</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">fuel</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"p\">.</span><span class=\"n\">parse</span><span class=\"p\">().</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">\"fuel should be a valid integer\"</span><span class=\"p\">));</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">testcase</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TestCase</span>::<span class=\"n\">generate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">Unstructured</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"n\">testcase</span><span class=\"p\">.</span><span class=\"n\">ctrl_planes</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">testcase</span><span class=\"p\">.</span><span class=\"n\">ctrl_planes</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">set_fuel</span><span class=\"p\">(</span><span class=\"n\">testcase</span><span class=\"p\">.</span><span class=\"n\">isa</span><span class=\"p\">.</span><span class=\"n\">flags</span><span class=\"p\">().</span><span class=\"n\">control_plane_fuel</span><span class=\"p\">())</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>The problem here is <code>TestCase::generate(/* ... */).unwrap()</code>. As far as I can tell from the cargo fuzz book and the expansion of the <code>fuzz_target!</code> macro, the body of a fuzz target is not allowed to reject an input (<code>data: &amp;[u8]</code>) because its structure is unsuitable. That should (can?) only be done by putting the structured input right as the argument (fuzz_target!(|data: TestCase|). I might be wrong about this.</p>\n<p>So that leads me to think our only option is to parse the CLI argument in some implementation of <code>Arbitrary</code>. Would it be better to make a separate struct and <code>Arbitrary</code> implementation just for the purpose of parsing the CLI args, to separate these concerns? Pseudo-code:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">struct</span> <span class=\"nc\">Foo</span><span class=\"p\">(</span><span class=\"n\">TestCase</span><span class=\"p\">);</span>\n\n<span class=\"k\">impl</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Arbitrary</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">arbitrary</span><span class=\"p\">(</span><span class=\"n\">u</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Unstructured</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">arbitrary</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">parse_fuel_from_cli_args</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">testcase</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TestCase</span>::<span class=\"n\">generate</span><span class=\"p\">(</span><span class=\"n\">u</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">testcase</span><span class=\"p\">.</span><span class=\"n\">set_all_fuel</span><span class=\"p\">(</span><span class=\"n\">testcase</span><span class=\"p\">.</span><span class=\"n\">isa</span><span class=\"p\">.</span><span class=\"n\">flags</span><span class=\"p\">().</span><span class=\"n\">control_plane_fuel</span><span class=\"p\">());</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">Foo</span><span class=\"p\">(</span><span class=\"n\">testcase</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">fuzz_target</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">foo</span>: <span class=\"nc\">Foo</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"p\">(</span><span class=\"n\">testcase</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">;</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 355348370,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683100075
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355360359,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683103170
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1184104676\">PR review comment</a>:</p>\n<blockquote>\n<blockquote>\n<p>The argument parsing is still in the same file, the fuzz target <code>cranelift-fuzzgen</code>. Which library do you mean?</p>\n</blockquote>\n<p>I guess I meant it a little more abstractly: the implementation of <code>Arbitrary</code> is a library layer of sorts, and should depend only on its inputs.</p>\n<blockquote>\n<p>I guess the problem I was working around is that the flags are generated in the <code>Arbitrary</code> implementation of <code>TestCase</code>, which doesn't take any arguments. And it's not possible to change the flags afterwards (?).</p>\n</blockquote>\n<p>That I think is the key assumption that is guiding this into the direction I'm not sure about :-) The <code>TestCase</code> should be defined to contain only the plain-old-data inputs; we shouldn't be building the compiler context with flags inside the <code>Arbitrary</code> impl itself. We should be able to then build whatever context we need in the fuzzing entrypoint: the compiler context is a pure function of the <code>TestCase</code> and the fuel parameter.</p>\n<p>So I'm imagining something like:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"nc\">TestCase</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">flags</span>: <span class=\"nc\">cranelift_codegen</span>::<span class=\"n\">Settings</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>and then</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">TestCase</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">build_isa</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fuel</span>: <span class=\"o\">..</span><span class=\"p\">.)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">isa</span>::<span class=\"n\">OwnedTargetIsa</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>or even <code>fn build_isa(&amp;self, user_params: &amp;UserParams)</code> and build the user params however we want (e.g. <code>UserParams::from_env()</code>). That makes the plumbing explicit and removes the dependency on environment variables from inside what should be a pure function :-)</p>\n<hr>\n<p>Taking a step back, I think we've discussed at least two different kinds of \"fuel\" and three different sources of the setting, and I want to at least outline this taxonomy here to make sure we're on the same page and have a framework to think about it further.</p>\n<p>Kinds of fuel:<br>\n- Fuel that \"masks\" other settings (e.g. chaos-decision values), and<br>\n- Fuel that is a separate dimension or axis that controls many different mutations in the compiler.</p>\n<p>Overall the latter is the more useful long-term, but the former is useful when controlled by the user to bisect failures, so both are interesting in some context.</p>\n<p>Sources of fuel setting:<br>\n- User parameter (CLIF option on clif-util, environment variable read from toplevel fuzz-test entry point, ...). Useful for the bisection kind of fuel.<br>\n- Cranelift settings, or a separate control-plane setting that is passed in alongside settings. Useful for the kind of fuel that can be used to limit optimization effort (the latter), and also for bisection when driven in certain ways (CLIF file editing etc).<br>\n- Programmatic generation of control-plane state: useful for e.g. tools that try to bisect automatically.</p>\n<p>The approach we're trying to take here is squarely the first kind of fuel, for now, and with the first source. If we can fix up the plumbing a little bit as above to isolate the read-of-ambient-state in as clean a way as possible, then I think I'm happy. Thanks!</p>\n</blockquote>",
        "id": 355579118,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683138680
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355725647,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683195527
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355729673,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683196343
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355761787,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683204112
    },
    {
        "content": "<p>remlse created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1184970268\">PR review comment</a>:</p>\n<blockquote>\n<p>This is the reason I wrapped the <code>isa_builder</code> in an <code>Rc</code>. <code>to_optimized</code> takes a reference and returns an owned <code>Self</code>, so the <code>isa_builder</code> must either be cloned or shared.</p>\n<p>I tried to make the <code>isa_builder</code> <code>Clone</code>, for that I would have to make the following also <code>Clone</code>:</p>\n<ul>\n<li><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/codegen/src/result.rs#L12\"><code>CodegenError</code></a></li>\n<li><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/codegen/src/isa/unwind/systemv.rs#L18\"><code>RegisterMappingError</code></a></li>\n</ul>\n<p>If making these two <code>Clone</code> is better than using <code>Rc</code>, I can change that.</p>\n</blockquote>",
        "id": 355764180,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683204665
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#pullrequestreview-1414117504\">PR review</a>:</p>\n<blockquote>\n<p>Thanks, I think this is reasonable enough to land. We can certainly further tweak the way that the fuel settings are plumbed later, if desired, but I don't want to hold this PR up any more than I already have, so let's merge.</p>\n</blockquote>",
        "id": 355922277,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683254174
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1185656695\">PR review comment</a>:</p>\n<blockquote>\n<p>... actually, now that I look at the CI failure, I think we can both eliminate the Cranelift setting (which is causing the failure because the \"default settings\" test is not updated) and just use <code>fuel</code> directly here. If we want a mode later where a setting can also set fuel, we can certainly add that, but this setting doesn't appear to be wired up to the control plane anywhere except here so I think it's best to just omit.</p>\n</blockquote>",
        "id": 355922578,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683254314
    },
    {
        "content": "<p>remlse created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1185662689\">PR review comment</a>:</p>\n<blockquote>\n<p>You suggested to flesh out the text representation of the control plane right now, so I didn't fix the tests related to that yet. I have a commit pretty much ready for that purpose, although there will probably be a couple iterations on that as well until it fits nicely with the rest of the parsing.</p>\n<p>I'm totally fine with keeping the PR open until that's done as well.</p>\n</blockquote>",
        "id": 355924945,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683255660
    },
    {
        "content": "<p>remlse edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1185662689\">PR review comment</a>.</p>",
        "id": 355925056,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683255696
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355927467,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683256777
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355927739,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683256896
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 355936436,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683262046
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1185711008\">PR review comment</a>:</p>\n<blockquote>\n<p>To be honest I think at this point I'd rather merge this logically consistent piece (without the Cranelift setting at all, and without any text parsing) and then we can review further bits as they're done -- otherwise the patch gets a bit unwieldy.</p>\n</blockquote>",
        "id": 355941841,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683264401
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 356000421,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683280447
    },
    {
        "content": "<p>remlse updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 356003557,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683281251
    },
    {
        "content": "<p>remlse created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#discussion_r1185921542\">PR review comment</a>:</p>\n<blockquote>\n<p>Ok, I removed everything except the part in cranelift-control and the reading of the CLI argument.</p>\n</blockquote>",
        "id": 356004355,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683281467
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208#pullrequestreview-1415444926\">PR review</a>.</p>",
        "id": 356162721,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683319879
    },
    {
        "content": "<p>cfallin merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6208\">PR #6208</a>.</p>",
        "id": 356168042,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1683322266
    }
]