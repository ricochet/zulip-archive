[
    {
        "content": "<p>hungryzzz opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<h3>Test Cases</h3>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/15354072/cases.zip\">cases.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h3>Expected Results &amp; Actual Results</h3>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 3.07s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 4.68s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>The difference between the attached two cases is as follow, i.e., changing the value which will be store to address 0 from <code>1</code> to <code>0</code> outsize the loop, which can bring 1.6s performance decreasing on Wasmtime but has no effect on WasmEdge. Moreover, the address 0 will be then stored the same value 0, so the first storage will not affect the loop in theory.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>cases<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n23c23\n&lt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">1</span>\n---\n&gt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"c1\">;; part of `good.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>  <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n\n<span class=\"c1\">;; part of `bad.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span> <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n</code></pre></div>\n<p>And I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code>, and find the instruction sequence of <code>Wasmtime</code> is different before and after change but the <code>WasmEdge</code> one only changes an immediate of an instruction from <code>1</code> to <code>0</code>.</p>\n<p>I have two confusion of the machine code generatd by <code>Wasmtime</code>:<br>\n1. Why the instruction sequence are different between two cases? In my view, maybe only changing the immediate of an instruction  just as <code>WasmEdge</code> is enough.<br>\n2. Why the difference of the two instruction sequences which are both out of the loop, can cause 1.6s performance difference?</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>binary-diff<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wasmedge.asm<span class=\"w\"> </span>bad.wasmedge.asm\n45c45\n&lt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n---\n&gt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n\n\n<span class=\"c1\"># difference of machine code generated by wasmtime</span>\n<span class=\"c1\"># good.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">                        </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span><span class=\"m\">41</span><span class=\"w\"> </span>bb<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">56</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">99</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5d:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">                        </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>b8<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"m\">55</span>:<span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">81</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5b:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<h3>Profiling Information</h3>\n<p>I use Perf tool to profile the hotspot and the results are as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># good.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.82<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.05<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">18</span>.60<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"w\">  </span><span class=\"m\">0</span>.03<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.42<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">22</span>.37<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">17</span>.68<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">24</span>.94<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">75</span>.04<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># the commands to profile</span>\nperf<span class=\"w\"> </span>record<span class=\"w\"> </span>-k<span class=\"w\"> </span>mono<span class=\"w\"> </span>~/wasmtime/target/release/wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--profile<span class=\"w\"> </span>jitdump<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\nperf<span class=\"w\"> </span>inject<span class=\"w\"> </span>--jit<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.data<span class=\"w\"> </span>--output<span class=\"w\"> </span>perf.jit.data\nperf<span class=\"w\"> </span>report<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.jit.data<span class=\"w\"> </span>--no-children\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<ul>\n<li>Wasmtime version or commit: 91ec9a589cc6c7f031ef4c</li>\n<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>\n</li>\n</ul>\n</blockquote>",
        "id": 439256204,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715963195
    },
    {
        "content": "<p>hungryzzz edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<h3>Test Cases</h3>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/15354072/cases.zip\">cases.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h3>Expected Results &amp; Actual Results</h3>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 3.07s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 4.68s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>The difference between the attached two cases is as follow, i.e., changing the value which will be store to address 0 from <code>1</code> to <code>0</code> outsize the loop, which can bring 1.6s performance decreasing on Wasmtime but has no effect on WasmEdge. Moreover, the address 0 will be then stored the same value 0, so the first storage will not affect the loop in theory.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>cases<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n23c23\n&lt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">1</span>\n---\n&gt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"c1\">;; part of `good.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>  <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n\n<span class=\"c1\">;; part of `bad.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span> <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n</code></pre></div>\n<p>And I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code>, and find the instruction sequence of <code>Wasmtime</code> is different before and after change but the <code>WasmEdge</code> one only changes an immediate of an instruction from <code>1</code> to <code>0</code>.</p>\n<p>I have two confusion of the machine code generatd by <code>Wasmtime</code>:<br>\n1. Why the instruction sequence are different between two cases? In my view, maybe only changing the immediate of an instruction  just as <code>WasmEdge</code> is enough.<br>\n2. Why the difference of the two instruction sequences which are both out of the loop, can cause 1.6s performance difference?</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>binary-diff<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wasmedge.asm<span class=\"w\"> </span>bad.wasmedge.asm\n45c45\n&lt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n---\n&gt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n\n\n<span class=\"c1\"># difference of machine code generated by wasmtime</span>\n<span class=\"c1\"># good.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">             </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span><span class=\"m\">41</span><span class=\"w\"> </span>bb<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">56</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">99</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5d:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">              </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>b8<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"m\">55</span>:<span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">81</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5b:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<h3>Profiling Information</h3>\n<p>I use Perf tool to profile the hotspot and the results are as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># good.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.82<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.05<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">18</span>.60<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"w\">  </span><span class=\"m\">0</span>.03<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.42<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">22</span>.37<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">17</span>.68<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">24</span>.94<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">75</span>.04<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># the commands to profile</span>\nperf<span class=\"w\"> </span>record<span class=\"w\"> </span>-k<span class=\"w\"> </span>mono<span class=\"w\"> </span>~/wasmtime/target/release/wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--profile<span class=\"w\"> </span>jitdump<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\nperf<span class=\"w\"> </span>inject<span class=\"w\"> </span>--jit<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.data<span class=\"w\"> </span>--output<span class=\"w\"> </span>perf.jit.data\nperf<span class=\"w\"> </span>report<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.jit.data<span class=\"w\"> </span>--no-children\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<ul>\n<li>Wasmtime version or commit: 91ec9a589cc6c7f031ef4c</li>\n<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>\n</li>\n</ul>\n</blockquote>",
        "id": 439256303,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715963232
    },
    {
        "content": "<p>hungryzzz edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<h3>Test Cases</h3>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/15354072/cases.zip\">cases.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h3>Expected Results &amp; Actual Results</h3>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 3.07s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 4.68s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>The difference between the attached two cases is as follow, i.e., changing the value which will be store to address 0 from <code>1</code> to <code>0</code> outsize the loop, which can bring 1.6s performance decreasing on Wasmtime but has no effect on WasmEdge. Moreover, the address 0 will be then stored the same value 0, so the first storage will not affect the loop in theory.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>cases<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n23c23\n&lt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">1</span>\n---\n&gt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"c1\">;; part of `good.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>  <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n\n<span class=\"c1\">;; part of `bad.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span> <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n</code></pre></div>\n<p>And I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code>, and find the instruction sequence of <code>Wasmtime</code> is different before and after change but the <code>WasmEdge</code> one only changes an immediate of an instruction from <code>1</code> to <code>0</code>.</p>\n<p>I have two confusion of the machine code generatd by <code>Wasmtime</code>:<br>\n1. Why the instruction sequence are different between two cases? In my view, maybe only changing the immediate of an instruction  just as <code>WasmEdge</code> is enough.<br>\n2. Why the difference of the two instruction sequences which are both out of the loop, can cause 1.6s performance difference?</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>binary-diff<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wasmedge.asm<span class=\"w\"> </span>bad.wasmedge.asm\n45c45\n&lt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n---\n&gt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n\n\n<span class=\"c1\"># difference of machine code generated by wasmtime</span>\n<span class=\"c1\"># good.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span><span class=\"m\">41</span><span class=\"w\"> </span>bb<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">56</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">99</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5d:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>b8<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"m\">55</span>:<span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">81</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5b:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<h3>Profiling Information</h3>\n<p>I use Perf tool to profile the hotspot and the results are as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># good.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.82<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.05<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">18</span>.60<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"w\">  </span><span class=\"m\">0</span>.03<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.42<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">22</span>.37<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">17</span>.68<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">24</span>.94<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">75</span>.04<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># the commands to profile</span>\nperf<span class=\"w\"> </span>record<span class=\"w\"> </span>-k<span class=\"w\"> </span>mono<span class=\"w\"> </span>~/wasmtime/target/release/wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--profile<span class=\"w\"> </span>jitdump<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\nperf<span class=\"w\"> </span>inject<span class=\"w\"> </span>--jit<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.data<span class=\"w\"> </span>--output<span class=\"w\"> </span>perf.jit.data\nperf<span class=\"w\"> </span>report<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.jit.data<span class=\"w\"> </span>--no-children\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<ul>\n<li>Wasmtime version or commit: 91ec9a589cc6c7f031ef4c</li>\n<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>\n</li>\n</ul>\n</blockquote>",
        "id": 439256371,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715963264
    },
    {
        "content": "<p>hungryzzz edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<h3>Test Cases</h3>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/15354072/cases.zip\">cases.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h3>Expected Results &amp; Actual Results</h3>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 3.07s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 4.68s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>The difference between the attached two cases is as follow, i.e., changing the value which will be store to address 0 from <code>1</code> to <code>0</code> outsize the loop, which can bring 1.6s performance decreasing on Wasmtime but has no effect on WasmEdge. Moreover, the address 0 will be then stored the same value 0, so the first storage will not affect the loop in theory.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>cases<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n23c23\n&lt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">1</span>\n---\n&gt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"c1\">;; part of `good.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>  <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n\n<span class=\"c1\">;; part of `bad.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span> <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n</code></pre></div>\n<p>And I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code>, and find the instruction sequence of <code>Wasmtime</code> is different before and after change but the <code>WasmEdge</code> one only changes an immediate of an instruction from <code>1</code> to <code>0</code>.</p>\n<p>I have two confusions to the machine code generatd by <code>Wasmtime</code>:<br>\n1. Why the instruction sequence are different between two cases? In my view, maybe only changing the immediate of an instruction  just as <code>WasmEdge</code> is enough.<br>\n2. Why the difference of the two instruction sequences which are both out of the loop, can cause 1.6s performance difference?</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>binary-diff<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wasmedge.asm<span class=\"w\"> </span>bad.wasmedge.asm\n45c45\n&lt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n---\n&gt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n\n\n<span class=\"c1\"># difference of machine code generated by wasmtime</span>\n<span class=\"c1\"># good.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span><span class=\"m\">41</span><span class=\"w\"> </span>bb<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">56</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">99</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5d:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>b8<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"m\">55</span>:<span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">81</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5b:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<h3>Profiling Information</h3>\n<p>I use Perf tool to profile the hotspot and the results are as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># good.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.82<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.05<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">18</span>.60<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"w\">  </span><span class=\"m\">0</span>.03<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.42<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">22</span>.37<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">17</span>.68<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">24</span>.94<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">75</span>.04<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># the commands to profile</span>\nperf<span class=\"w\"> </span>record<span class=\"w\"> </span>-k<span class=\"w\"> </span>mono<span class=\"w\"> </span>~/wasmtime/target/release/wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--profile<span class=\"w\"> </span>jitdump<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\nperf<span class=\"w\"> </span>inject<span class=\"w\"> </span>--jit<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.data<span class=\"w\"> </span>--output<span class=\"w\"> </span>perf.jit.data\nperf<span class=\"w\"> </span>report<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.jit.data<span class=\"w\"> </span>--no-children\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<ul>\n<li>Wasmtime version or commit: 91ec9a589cc6c7f031ef4c</li>\n<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>\n</li>\n</ul>\n</blockquote>",
        "id": 439256729,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715963405
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648#issuecomment-2118130278\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">good</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"mi\">29</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10b</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">2</span><span class=\"n\">c</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">32</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">38</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">3</span><span class=\"n\">e</span>: <span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r11d</span>\n<span class=\"mi\">44</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">4</span><span class=\"n\">a</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">50</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">56</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r11b</span><span class=\"p\">,</span><span class=\"mh\">0x14c</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">5</span><span class=\"n\">d</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">91</span><span class=\"w\"> </span><span class=\"n\">bc</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10b</span><span class=\"p\">,</span><span class=\"mh\">0x1bc</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n\n#<span class=\"w\"> </span><span class=\"n\">bad</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"mi\">29</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10b</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">2</span><span class=\"n\">c</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">32</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">38</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">3</span><span class=\"n\">e</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">44</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">4</span><span class=\"n\">a</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">50</span>: <span class=\"nc\">b8</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">eax</span>\n<span class=\"mi\">55</span>: <span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">al</span><span class=\"p\">,</span><span class=\"mh\">0x14c</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">5</span><span class=\"n\">b</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">91</span><span class=\"w\"> </span><span class=\"n\">bc</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10b</span><span class=\"p\">,</span><span class=\"mh\">0x1bc</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>@hungryzzz, would you mind isolating this into a microbenchmark written in assembly and measuring it by itself? (With appropriate values in <code>rcx</code> to make the stores valid and a loop to run a suitable number of iterations, etc...) It would be good to understand if this is really the difference that matters.</p>\n<p>I am fascinated by this case because the assembly differs in only two ways: the <code>mov $1, reg</code> is shifted downward by three instructions, and the register allocator chose <code>rax</code> rather than <code>r11</code>. The latter shouldn't matter at all; and the former shouldn't matter on any out-of-order CPU. The alignment of both sequences is the same, too.</p>\n<p>(As to why the instruction moves: in the <code>good.wasm</code> case the immediate is shared by two of the instructions, so we only load it once, before its first use. Separately we could probably have another lowering rule for <code>mov [byte immediate], (mem)</code> but that would change both cases here.)</p>\n</blockquote>",
        "id": 439269337,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715968844
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648#issuecomment-2118130278\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>#<span class=\"w\"> </span><span class=\"n\">good</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"mi\">29</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10b</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">2</span><span class=\"n\">c</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">32</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">38</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">3</span><span class=\"n\">e</span>: <span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r11d</span>\n<span class=\"mi\">44</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">4</span><span class=\"n\">a</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">50</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">56</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r11b</span><span class=\"p\">,</span><span class=\"mh\">0x14c</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">5</span><span class=\"n\">d</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">91</span><span class=\"w\"> </span><span class=\"n\">bc</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10b</span><span class=\"p\">,</span><span class=\"mh\">0x1bc</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n\n#<span class=\"w\"> </span><span class=\"n\">bad</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"mi\">29</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\">                </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10b</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">2</span><span class=\"n\">c</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">32</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">38</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">3</span><span class=\"n\">e</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">44</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">4</span><span class=\"n\">a</span>: <span class=\"nc\">c7</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">movl</span><span class=\"w\">   </span><span class=\"cp\">$</span><span class=\"mh\">0x0</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">50</span>: <span class=\"nc\">b8</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">          </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">eax</span>\n<span class=\"mi\">55</span>: <span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">81</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">       </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">al</span><span class=\"p\">,</span><span class=\"mh\">0x14c</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n<span class=\"mi\">5</span><span class=\"n\">b</span>: <span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\"> </span><span class=\"mi\">91</span><span class=\"w\"> </span><span class=\"n\">bc</span><span class=\"w\"> </span><span class=\"mi\">01</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\"> </span><span class=\"mi\">00</span><span class=\"w\">    </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10b</span><span class=\"p\">,</span><span class=\"mh\">0x1bc</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>@hungryzzz, would you mind isolating this into a microbenchmark written in assembly and measuring it by itself? (With appropriate values in <code>rcx</code> to make the stores valid and a loop to run a suitable number of iterations, etc...) It would be good to understand if this is really the difference that matters.</p>\n<p>I am fascinated by this case because the assembly differs in only two ways: the <code>mov $1, reg</code> is shifted downward by three instructions, and the register allocator chose <code>rax</code> rather than <code>r11</code>. The latter shouldn't matter at all; and the former shouldn't matter on any out-of-order CPU. The alignment of both sequences is the same, too.</p>\n<p>(As to why the instruction moves: in the <code>good.wasm</code> case the immediate is shared by two of the instructions [EDIT: or at least would have been if the 32-bit store of constant <code>1</code> didn't fold the immediate in], so we only load it once, before its first use. Separately we could probably have another lowering rule for <code>mov [byte immediate], (mem)</code> but that would change both cases here.)</p>\n</blockquote>",
        "id": 439269789,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715968973
    },
    {
        "content": "<p>hungryzzz closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<h3>Test Cases</h3>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/15354072/cases.zip\">cases.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by <code>time</code> tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h3>Expected Results &amp; Actual Results</h3>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 3.07s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 4.68s</li>\n<li>WasmEdge: 1.18s</li>\n</ul>\n<p>The difference between the attached two cases is as follow, i.e., changing the value which will be store to address 0 from <code>1</code> to <code>0</code> outsize the loop, which can bring 1.6s performance decreasing on Wasmtime but has no effect on WasmEdge. Moreover, the address 0 will be then stored the same value 0, so the first storage will not affect the loop in theory.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>cases<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n23c23\n&lt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">1</span>\n---\n&gt;<span class=\"w\">     </span>i32.const<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"c1\">;; part of `good.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>  <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n\n<span class=\"c1\">;; part of `bad.wat`</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span> <span class=\"c1\">;; here</span>\n<span class=\"nb\">i32.store</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.store</span>\n</code></pre></div>\n<p>And I check the machine code generated by <code>Wasmtime</code> and <code>WasmEdge</code>, and find the instruction sequence of <code>Wasmtime</code> is different before and after change but the <code>WasmEdge</code> one only changes an immediate of an instruction from <code>1</code> to <code>0</code>.</p>\n<p>I have two confusions to the machine code generatd by <code>Wasmtime</code>:<br>\n1. Why the instruction sequence are different between two cases? In my view, maybe only changing the immediate of an instruction  just as <code>WasmEdge</code> is enough.<br>\n2. Why the difference of the two instruction sequences which are both out of the loop, can cause 1.6s performance difference?</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>binary-diff<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wasmedge.asm<span class=\"w\"> </span>bad.wasmedge.asm\n45c45\n&lt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n---\n&gt;<span class=\"w\">   </span><span class=\"m\">82</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">02</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rdx<span class=\"o\">)</span>\n\n\n<span class=\"c1\"># difference of machine code generated by wasmtime</span>\n<span class=\"c1\"># good.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span><span class=\"m\">41</span><span class=\"w\"> </span>bb<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">56</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">99</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5d:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"m\">29</span>:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\">                </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n2c:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">32</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">38</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n3e:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">44</span>:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n4a:<span class=\"w\"> </span>c7<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"m\">50</span>:<span class=\"w\"> </span>b8<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">          </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"m\">55</span>:<span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">81</span><span class=\"w\"> </span>4c<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">       </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n5b:<span class=\"w\"> </span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"m\">88</span><span class=\"w\"> </span><span class=\"m\">91</span><span class=\"w\"> </span>bc<span class=\"w\"> </span><span class=\"m\">01</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">    </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<h3>Profiling Information</h3>\n<p>I use Perf tool to profile the hotspot and the results are as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># good.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.82<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.05<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">18</span>.60<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%r11d\n<span class=\"w\">  </span><span class=\"m\">0</span>.03<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x1,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">20</span>.42<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">22</span>.37<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">17</span>.68<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r11b,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n\n<span class=\"c1\"># bad.wasm</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>xor<span class=\"w\">    </span>%r10d,%r10d\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">24</span>.94<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">       </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"m\">75</span>.04<span class=\"w\"> </span>│<span class=\"w\">      </span>movl<span class=\"w\">   </span><span class=\"nv\">$0</span>x0,<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span><span class=\"nv\">$0</span>x1,%eax\n<span class=\"w\">       </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%al,0x14c<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"m\">0</span>.01<span class=\"w\"> </span>│<span class=\"w\">      </span>mov<span class=\"w\">    </span>%r10b,0x1bc<span class=\"o\">(</span>%rcx<span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># the commands to profile</span>\nperf<span class=\"w\"> </span>record<span class=\"w\"> </span>-k<span class=\"w\"> </span>mono<span class=\"w\"> </span>~/wasmtime/target/release/wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--profile<span class=\"w\"> </span>jitdump<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\nperf<span class=\"w\"> </span>inject<span class=\"w\"> </span>--jit<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.data<span class=\"w\"> </span>--output<span class=\"w\"> </span>perf.jit.data\nperf<span class=\"w\"> </span>report<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.jit.data<span class=\"w\"> </span>--no-children\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<ul>\n<li>Wasmtime version or commit: 91ec9a589cc6c7f031ef4c</li>\n<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>\n</li>\n</ul>\n</blockquote>",
        "id": 441236928,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1716988014
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648#issuecomment-2137372862\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<p>@cfallin Really sorry for my late reply. I found that the above performance decreasing cannot replay in another machine so I thought maybe my CPU is too old to run the case well. Therefore I apply a new generation machine to run experiments. I would close this issue and submit a new one for this case, thank you very much!</p>\n</blockquote>",
        "id": 441236932,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1716988015
    },
    {
        "content": "<p>hungryzzz edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648#issuecomment-2137372862\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<p>@cfallin Really sorry for my late reply. I found that the above performance decreasing cannot be replayed in another machine so I thought maybe my CPU is too old to run the case well. Therefore I apply a new generation machine to run experiments. I would close this issue and submit a new one for this case, thank you very much!</p>\n</blockquote>",
        "id": 441237003,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1716988039
    },
    {
        "content": "<p>hungryzzz edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648#issuecomment-2137372862\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8648\">issue #8648</a>:</p>\n<blockquote>\n<p>@cfallin Really sorry for my late reply. I found that the above performance decreasing cannot be replayed in another machine so I thought maybe my CPU is too old to run the case well. Therefore I apply a newer generation machine to run experiments. I would close this issue and submit a new one for this case, thank you very much!</p>\n</blockquote>",
        "id": 441237189,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1716988099
    }
]