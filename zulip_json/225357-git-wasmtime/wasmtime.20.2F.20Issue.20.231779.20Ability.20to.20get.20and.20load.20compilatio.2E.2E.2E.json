[
    {
        "content": "<p>dsherret opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<h4>Feature</h4>\n<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>\n<h4>Benefit</h4>\n<p>This would allow me to manage my own caching and reduce startup times.</p>\n<h4>Implementation</h4>\n<p>Here's how it's done in wasmer.</p>\n<p>Compiling:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">wasm_bytes</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"p\">.</span><span class=\"n\">cache</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiled_module_bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">serialize</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>Loading:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">cache</span>::<span class=\"n\">Artifact</span>::<span class=\"n\">deserialize</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">compiled_module_bytes</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compiler_for_backend</span><span class=\"p\">(</span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">Backend</span>::<span class=\"n\">default</span><span class=\"p\">()).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Expect to have a compiler&quot;</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime_core</span>::<span class=\"n\">load_cache_with</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;*</span><span class=\"n\">compiler</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">import_object</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">imports</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">import_object</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<h4>Alternatives</h4>\n<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>\n</blockquote>",
        "id": 199027157,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590675034
    },
    {
        "content": "<p>dsherret edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<h4>Feature</h4>\n<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>\n<h4>Benefit</h4>\n<p>This would allow me to manage my own caching and reduce startup times.</p>\n<h4>Implementation</h4>\n<p>Here's how it's done in wasmer.</p>\n<p>Compiling:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">wasm_bytes</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"p\">.</span><span class=\"n\">cache</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiled_module_bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">serialize</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>Loading:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">cache</span>::<span class=\"n\">Artifact</span>::<span class=\"n\">deserialize</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">compiled_module_bytes</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compiler_for_backend</span><span class=\"p\">(</span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">Backend</span>::<span class=\"n\">default</span><span class=\"p\">()).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Expected to have a compiler&quot;</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime_core</span>::<span class=\"n\">load_cache_with</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;*</span><span class=\"n\">compiler</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">import_object</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">imports</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">import_object</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<h4>Alternatives</h4>\n<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>\n</blockquote>",
        "id": 199027277,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590675108
    },
    {
        "content": "<p>alexcrichton labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<h4>Feature</h4>\n<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>\n<h4>Benefit</h4>\n<p>This would allow me to manage my own caching and reduce startup times.</p>\n<h4>Implementation</h4>\n<p>Here's how it's done in wasmer.</p>\n<p>Compiling:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">wasm_bytes</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"p\">.</span><span class=\"n\">cache</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiled_module_bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">serialize</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>Loading:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">cache</span>::<span class=\"n\">Artifact</span>::<span class=\"n\">deserialize</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">compiled_module_bytes</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compiler_for_backend</span><span class=\"p\">(</span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">Backend</span>::<span class=\"n\">default</span><span class=\"p\">()).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Expected to have a compiler&quot;</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime_core</span>::<span class=\"n\">load_cache_with</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;*</span><span class=\"n\">compiler</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">import_object</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">imports</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">import_object</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<h4>Alternatives</h4>\n<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>\n</blockquote>",
        "id": 199029177,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590676034
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635383843\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @peterhuene</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"wasmtime:api\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>peterhuene: wasmtime:api</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 199029210,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590676047
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635423912\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<p>Thanks for the report, and seems like a reasonable feature to add to me!</p>\n<p>I think for us the APIs this might look like are:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">deserialize_cache_bytes</span><span class=\"p\">(</span><span class=\"n\">store</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">Store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bytes</span>: <span class=\"kp\">&amp;</span><span class=\"p\">[</span><span class=\"kt\">u8</span><span class=\"p\">])</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">Module</span><span class=\"o\">&gt;</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">serialize_cache_bytes</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>(or something like that)</p>\n<p>Our cache format is not currently where we want it to end up. One aspect we'd like for the caches eventually is that you can \"mmap and go\" with zero changes to what's mmap'd in, but we can probably implement that with something like <code>deserialize_cache_file</code> in the future.</p>\n<p>In any case @dsherret would you be willing to work on adding this feature?</p>\n</blockquote>",
        "id": 199038978,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590680024
    },
    {
        "content": "<p>dsherret <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635427348\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<p>@alexcrichton that API looks perfect to me.</p>\n<p>How much work do you think it would be? Is it just hooking up a few things internally to that public api? If so, then sure!</p>\n<p>I'm actually not using wasmtime at all, but was just evaluating it and this was a blocker for me.</p>\n</blockquote>",
        "id": 199039751,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590680391
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635429409\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<p>I think this may be somewhat nontrivial to implement because the code isn't well-structured this way today. Our <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b017844bef604b757fc358b3bff5be429f2471e6/crates/environ/src/cache.rs#L69-L96\">core caching function</a> would need to be updated to optionally have bytes passed in, or otherwise refactored elsewhere to have \"get the bytes\" refactored into a separate step.</p>\n<p>Overall I don't think it'll be too too difficult of a change, but it will require some refactoring and isn't a simple \"just connect the wires\" sort of change.</p>\n</blockquote>",
        "id": 199040191,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590680606
    },
    {
        "content": "<p>dsherret <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-635710580\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<p>@alexcrichton thanks for pointing me in the direction of the code. I took a look at it briefly and you're right that it would be a bit non-trivial, but overall doesn't look too bad.</p>\n<p>I'm currently dragging my head through the sand with an access violation bug so my brain is kind of fried. I'll maybe come back to this later if I don't make any progress otherwise and want to try using wasmtime... (I'd like to support this project as I really like the idea behind it).</p>\n</blockquote>",
        "id": 199106101,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590717159
    },
    {
        "content": "<p>yurydelendik assigned <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<h4>Feature</h4>\n<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>\n<h4>Benefit</h4>\n<p>This would allow me to manage my own caching and reduce startup times.</p>\n<h4>Implementation</h4>\n<p>Here's how it's done in wasmer.</p>\n<p>Compiling:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">wasm_bytes</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"p\">.</span><span class=\"n\">cache</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiled_module_bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">serialize</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>Loading:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">cache</span>::<span class=\"n\">Artifact</span>::<span class=\"n\">deserialize</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">compiled_module_bytes</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compiler_for_backend</span><span class=\"p\">(</span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">Backend</span>::<span class=\"n\">default</span><span class=\"p\">()).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Expected to have a compiler&quot;</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime_core</span>::<span class=\"n\">load_cache_with</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;*</span><span class=\"n\">compiler</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">import_object</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">imports</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">import_object</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<h4>Alternatives</h4>\n<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>\n</blockquote>",
        "id": 200703667,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1591984983
    },
    {
        "content": "<p>yurydelendik <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-660247348\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<p>@dsherret there is #2020 about to be landed, can you provide any feedback related to this issue?</p>\n</blockquote>",
        "id": 204235638,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1595007537
    },
    {
        "content": "<p>yurydelendik closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a> (assigned to yurydelendik):</p>\n<blockquote>\n<h4>Feature</h4>\n<p>It would be useful to be able to get the bytes from a compilation result and additionally take bytes from a previous compilation and load them into a module.</p>\n<h4>Benefit</h4>\n<p>This would allow me to manage my own caching and reduce startup times.</p>\n<h4>Implementation</h4>\n<p>Here's how it's done in wasmer.</p>\n<p>Compiling:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">wasm_bytes</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">compile_result</span><span class=\"p\">.</span><span class=\"n\">cache</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiled_module_bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">serialize</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>Loading:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">cache</span>::<span class=\"n\">Artifact</span>::<span class=\"n\">deserialize</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">compiled_module_bytes</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s\">&quot;Error deserializing compiled wasm module: {:?}&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">compiler_for_backend</span><span class=\"p\">(</span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">Backend</span>::<span class=\"n\">default</span><span class=\"p\">()).</span><span class=\"n\">expect</span><span class=\"p\">(</span><span class=\"s\">&quot;Expected to have a compiler&quot;</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime_core</span>::<span class=\"n\">load_cache_with</span><span class=\"p\">(</span><span class=\"n\">artifact</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;*</span><span class=\"n\">compiler</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">import_object</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmer_runtime</span>::<span class=\"n\">imports</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{};</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">import_object</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<h4>Alternatives</h4>\n<p>Using the <code>Config::cache_config_load_default</code> is not ideal because it's wasmtime managing a cache for me and it seems I need to keep the <code>.wasm</code> file bytes around.</p>\n</blockquote>",
        "id": 204596744,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1595361952
    },
    {
        "content": "<p>dsherret <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779#issuecomment-662087304\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1779\">Issue #1779</a>:</p>\n<blockquote>\n<p>@yurydelendik sorry, I meant to respond. I looked at the public api earlier and it looked good to me! Thanks! I'm not using wasmtime at the moment though.</p>\n</blockquote>",
        "id": 204598665,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1595363035
    }
]