[
    {
        "content": "<p><a href=\"https://github.com/squeek502\">squeek502</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9054\">Issue #9054</a>.</p>",
        "id": 455495308,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722464181
    },
    {
        "content": "<p>squeek502 opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9054\">issue #9054</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p>(will upload <code>.wasm</code> file in a bit)</p>\n<h3>Steps to Reproduce</h3>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;sys/stat.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;sys/types.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;fcntl.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;unistd.h&gt;</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">mkdirat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mo\">0777</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Opening with O_RDWR fails as expected if the dirfd is AT_FDCWD</span>\n<span class=\"w\">        </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDWR</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Open \"testdir\" for real now since we want to use it as the dirfd for openat</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDONLY</span><span class=\"o\">|</span><span class=\"n\">O_DIRECTORY</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">mkdirat</span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"subdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mo\">0777</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Try to open the subdir with O_RDWR, this should fail with EISDIR but it succeeds</span>\n<span class=\"w\">    </span><span class=\"c1\">// because the O_RDWR is lost and the openat2 syscall is called with O_RDONLY</span>\n<span class=\"w\">    </span><span class=\"c1\">// instead</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">testdir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"subdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDWR</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">testdir</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"shellsession\"><pre><span></span><code>$ WASI_SDK=/home/ryan/Downloads/wasi-sdk-23.0-x86_64-linux\n$ $WASI_SDK/bin/clang --sysroot=$WASI_SDK/share/wasi-sysroot open-dir-tmpdir-rw.c -o open-dir-tmpdir-rw-sdk-23.wasm\n$ strace -e trace=openat2 wasmtime --dir=. open-dir-tmpdir-rw-sdk-23.wasm\nopenat2(3, \"testdir\", {flags=O_RDWR|O_LARGEFILE|O_CLOEXEC, resolve=RESOLVE_NO_MAGICLINKS|RESOLVE_BENEATH}, 24) = -1 EISDIR (Is a directory)\nopenat2(3, \"testdir\", {flags=O_RDONLY|O_LARGEFILE|O_CLOEXEC, resolve=RESOLVE_NO_MAGICLINKS|RESOLVE_BENEATH}, 24) = 11\nopenat2(11, \"subdir\", {flags=O_RDONLY|O_LARGEFILE|O_CLOEXEC, resolve=RESOLVE_NO_MAGICLINKS|RESOLVE_BENEATH}, 24) = 12\n+++ exited with 1 +++\n</code></pre></div>\n<h3>Expected Results</h3>\n<p>The test program should exit with 0, and the last <code>openat</code> call should have <code>O_RDWR</code> set instead of <code>O_RDONLY</code>.</p>\n<h3>Actual Results</h3>\n<p>The test program exits with 1, since the last <code>openat</code> call loses the <code>O_RDWR</code> flag and erroneously sets <code>O_RDONLY</code> instead.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasi-sdk 23.0 and wasmtime 23.0.1</p>\n<p>Operating system: Linux</p>\n<p>Architecture: x86_64</p>\n<h3>Extra Info</h3>\n<p>This is a partial regression of a bug that was fixed by <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6463\">https://github.com/bytecodealliance/wasmtime/pull/6463</a>. This bug is not present in wasmtime versions <code>v9.0.1</code>-<code>v14.0.4</code></p>\n<p>wasi-libc issue: <a href=\"https://github.com/WebAssembly/wasi-libc/issues/415\">https://github.com/WebAssembly/wasi-libc/issues/415</a></p>\n</blockquote>",
        "id": 455495313,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722464181
    },
    {
        "content": "<p>squeek502 edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9054\">issue #9054</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p><a href=\"https://github.com/user-attachments/files/16448323/open-dir-tmpdir-rw-sdk-23.zip\">open-dir-tmpdir-rw-sdk-23.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;sys/stat.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;sys/types.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;fcntl.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;unistd.h&gt;</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">mkdirat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mo\">0777</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Opening with O_RDWR fails as expected if the dirfd is AT_FDCWD</span>\n<span class=\"w\">        </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDWR</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Open \"testdir\" for real now since we want to use it as the dirfd for openat</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDONLY</span><span class=\"o\">|</span><span class=\"n\">O_DIRECTORY</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">mkdirat</span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"subdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mo\">0777</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Try to open the subdir with O_RDWR, this should fail with EISDIR but it succeeds</span>\n<span class=\"w\">    </span><span class=\"c1\">// because the O_RDWR is lost and the openat2 syscall is called with O_RDONLY</span>\n<span class=\"w\">    </span><span class=\"c1\">// instead</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">testdir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"subdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDWR</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">testdir</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"shellsession\"><pre><span></span><code>$ WASI_SDK=/home/ryan/Downloads/wasi-sdk-23.0-x86_64-linux\n$ $WASI_SDK/bin/clang --sysroot=$WASI_SDK/share/wasi-sysroot open-dir-tmpdir-rw.c -o open-dir-tmpdir-rw-sdk-23.wasm\n$ strace -e trace=openat2 wasmtime --dir=. open-dir-tmpdir-rw-sdk-23.wasm\nopenat2(3, \"testdir\", {flags=O_RDWR|O_LARGEFILE|O_CLOEXEC, resolve=RESOLVE_NO_MAGICLINKS|RESOLVE_BENEATH}, 24) = -1 EISDIR (Is a directory)\nopenat2(3, \"testdir\", {flags=O_RDONLY|O_LARGEFILE|O_CLOEXEC, resolve=RESOLVE_NO_MAGICLINKS|RESOLVE_BENEATH}, 24) = 11\nopenat2(11, \"subdir\", {flags=O_RDONLY|O_LARGEFILE|O_CLOEXEC, resolve=RESOLVE_NO_MAGICLINKS|RESOLVE_BENEATH}, 24) = 12\n+++ exited with 1 +++\n</code></pre></div>\n<h3>Expected Results</h3>\n<p>The test program should exit with 0, and the last <code>openat</code> call should have <code>O_RDWR</code> set instead of <code>O_RDONLY</code>.</p>\n<h3>Actual Results</h3>\n<p>The test program exits with 1, since the last <code>openat</code> call loses the <code>O_RDWR</code> flag and erroneously sets <code>O_RDONLY</code> instead.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasi-sdk 23.0 and wasmtime 23.0.1</p>\n<p>Operating system: Linux</p>\n<p>Architecture: x86_64</p>\n<h3>Extra Info</h3>\n<p>This is a partial regression of a bug that was fixed by <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6463\">https://github.com/bytecodealliance/wasmtime/pull/6463</a>. This bug is not present in wasmtime versions <code>v9.0.1</code>-<code>v14.0.4</code></p>\n<p>wasi-libc issue: <a href=\"https://github.com/WebAssembly/wasi-libc/issues/415\">https://github.com/WebAssembly/wasi-libc/issues/415</a></p>\n</blockquote>",
        "id": 455512835,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722472510
    },
    {
        "content": "<p>squeek502 edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9054\">issue #9054</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p><a href=\"https://github.com/user-attachments/files/16448323/open-dir-tmpdir-rw-sdk-23.zip\">open-dir-tmpdir-rw-sdk-23.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;sys/stat.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;sys/types.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;fcntl.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;unistd.h&gt;</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">mkdirat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mo\">0777</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Opening with O_RDWR fails as expected if the dirfd is AT_FDCWD</span>\n<span class=\"w\">        </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDWR</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Open \"testdir\" for real now since we want to use it as the dirfd for openat</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDONLY</span><span class=\"o\">|</span><span class=\"n\">O_DIRECTORY</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">mkdirat</span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"subdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mo\">0777</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Try to open the subdir with O_RDWR, this should fail with EISDIR but it succeeds</span>\n<span class=\"w\">    </span><span class=\"c1\">// because the O_RDWR is lost and the openat2 syscall is called with O_RDONLY</span>\n<span class=\"w\">    </span><span class=\"c1\">// instead</span>\n<span class=\"w\">    </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">testdir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"subdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDWR</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">testdir</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">-1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Built via:</p>\n<div class=\"codehilite\" data-code-language=\"shellsession\"><pre><span></span><code>$ WASI_SDK=/home/ryan/Downloads/wasi-sdk-23.0-x86_64-linux\n$ $WASI_SDK/bin/clang --sysroot=$WASI_SDK/share/wasi-sysroot open-dir-tmpdir-rw.c -o open-dir-tmpdir-rw-sdk-23.wasm\n</code></pre></div>\n<p>Run with strace via:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">strace</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"o\">=</span><span class=\"n\">openat2</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">dir</span><span class=\"o\">=</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">open</span><span class=\"o\">-</span><span class=\"n\">dir</span><span class=\"o\">-</span><span class=\"n\">tmpdir</span><span class=\"o\">-</span><span class=\"n\">rw</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">23.</span><span class=\"n\">wasm</span>\n<span class=\"n\">openat2</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">flags</span><span class=\"o\">=</span><span class=\"n\">O_RDWR</span><span class=\"o\">|</span><span class=\"n\">O_LARGEFILE</span><span class=\"o\">|</span><span class=\"n\">O_CLOEXEC</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">resolve</span><span class=\"o\">=</span><span class=\"n\">RESOLVE_NO_MAGICLINKS</span><span class=\"o\">|</span><span class=\"n\">RESOLVE_BENEATH</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">EISDIR</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"p\">)</span>\n<span class=\"n\">openat2</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"testdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">flags</span><span class=\"o\">=</span><span class=\"n\">O_RDONLY</span><span class=\"o\">|</span><span class=\"n\">O_LARGEFILE</span><span class=\"o\">|</span><span class=\"n\">O_CLOEXEC</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">resolve</span><span class=\"o\">=</span><span class=\"n\">RESOLVE_NO_MAGICLINKS</span><span class=\"o\">|</span><span class=\"n\">RESOLVE_BENEATH</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">11</span>\n<span class=\"n\">openat2</span><span class=\"p\">(</span><span class=\"mi\">11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"subdir\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">flags</span><span class=\"o\">=</span><span class=\"n\">O_RDONLY</span><span class=\"o\">|</span><span class=\"n\">O_LARGEFILE</span><span class=\"o\">|</span><span class=\"n\">O_CLOEXEC</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">resolve</span><span class=\"o\">=</span><span class=\"n\">RESOLVE_NO_MAGICLINKS</span><span class=\"o\">|</span><span class=\"n\">RESOLVE_BENEATH</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">12</span>\n<span class=\"o\">+++</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">+++</span>\n</code></pre></div>\n<h3>Expected Results</h3>\n<p>The test program should exit with 0, and the last <code>openat</code> call should have <code>O_RDWR</code> set instead of <code>O_RDONLY</code>.</p>\n<h3>Actual Results</h3>\n<p>The test program exits with 1, since the last <code>openat</code> call loses the <code>O_RDWR</code> flag and erroneously sets <code>O_RDONLY</code> instead.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasi-sdk 23.0 and wasmtime 23.0.1</p>\n<p>Operating system: Linux</p>\n<p>Architecture: x86_64</p>\n<h3>Extra Info</h3>\n<p>This is a partial regression of a bug that was fixed by <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6463\">https://github.com/bytecodealliance/wasmtime/pull/6463</a>. This bug is not present in wasmtime versions <code>v9.0.1</code>-<code>v14.0.4</code></p>\n<p>wasi-libc issue: <a href=\"https://github.com/WebAssembly/wasi-libc/issues/415\">https://github.com/WebAssembly/wasi-libc/issues/415</a></p>\n</blockquote>",
        "id": 455512881,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722472539
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9054#issuecomment-2264086609\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9054\">issue #9054</a>:</p>\n<blockquote>\n<p>Thanks for the report! It's not clear to me precisely where the fault lies when debugging this. Notes that follow are intended not as a fix for this issue but what I've found so far.</p>\n<p>I've determined that this is \"just a difference\" between <code>-Spreview2={y,n}</code> which is <code>wasi-common</code> (old) vs <code>wasmtime-wasi</code> (new (ish)). The default, <code>wasmtime-wasi</code>, fails this test while <code>wasi-common</code> passes it. It appears due to <a href=\"https://github.com/WebAssembly/wasi-libc/blob/b9ef79d7dbd47c6c5bafdae760823467c2f60b70/libc-bottom-half/cloudlibc/src/libc/fcntl/openat.c#L68\">this line</a> where <code>fd_fdstat_get</code> on the <code>dir</code> variable in the program above is returning different results. This does not look related to <code>path_open</code>.</p>\n<p>In <code>wasmtime-wasi</code> the <code>fd_fdstat_get</code> call returns</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">result</span><span class=\"o\">=</span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">Fdstat</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">fs_filetype</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Directory</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fs_flags</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Fdflags</span><span class=\"p\">(</span><span class=\"mh\">0x0</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">fs_rights_base</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Rights</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">FD_READ</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.),</span><span class=\"w\"> </span><span class=\"n\">fs_rights_inheriting</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Rights</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">FD_READ</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"p\">})</span>\n</code></pre></div>\n<p>whereas <code>wasi-common</code> returns:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">result</span><span class=\"o\">=</span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">Fdstat</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">fs_filetype</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Directory</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fs_flags</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Fdflags</span><span class=\"p\">(</span><span class=\"mh\">0x0</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">fs_rights_base</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Rights</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.),</span><span class=\"w\"> </span><span class=\"n\">fs_rights_inheriting</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Rights</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">FD_READ</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">FD_WRITE</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"p\">})</span>\n</code></pre></div>\n<p>notably there's a difference in <code>fs_rights_inheriting</code>. This means that with <code>wasi-common</code> the request to write this directory is NOT masked out, hence the error. With <code>wasmtime-wasi</code> the request to write is masked out because <code>fs_rights_inheriting</code> doesn't have the write bit set.</p>\n<p>@pchickey as the liberator of rights (hah!) are you able to recall the history around this? Is this something where we should update <code>wasmtime-wasi</code> to have the same fixed return value of <code>fs_rights_inheriting</code>? Or should we update wasi-libc to do something different about masking here?</p>\n</blockquote>",
        "id": 455764060,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1722549697
    }
]