[
    {
        "content": "<p>teapotd <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1162#issuecomment-613940741\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1162#issuecomment-613940741\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1162\" title=\"https://github.com/bytecodealliance/wasmtime/issues/1162\">Issue #1162</a>:</p>\n<blockquote>\n<p>It looks like the bug is in x86 <code>legalize_signature</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/c5b6c57c34f89d865e07939eff67d6687e9339e2/cranelift/codegen/src/isa/x86/abi.rs#L259-L277\" title=\"https://github.com/bytecodealliance/wasmtime/blob/c5b6c57c34f89d865e07939eff67d6687e9339e2/cranelift/codegen/src/isa/x86/abi.rs#L259-L277\">https://github.com/bytecodealliance/wasmtime/blob/c5b6c57c34f89d865e07939eff67d6687e9339e2/cranelift/codegen/src/isa/x86/abi.rs#L259-L277</a></p>\n<p>Function that returns only <code>i128</code> is single-return before legalization, so struct-return parameter is never introduced, even though <code>legalize_args</code> doesn't assign registers properly. After changing it to always backup arguments it generates correct code:</p>\n<div class=\"codehilite\"><pre><span></span>function %test_i128(i64 sret [%rcx], i64 fp [%rbp]) -&gt; i64 sret [%rax], i64 fp [%rbp] windows_fastcall {\n    ss0 = incoming_arg 16, offset -48\n\n                                block0(v3: i64 [%rcx], v6: i64 [%rbp]):\n[RexOp1pushq#50]                    x86_push v6\n[RexOp1copysp#8089]                 copy_special %rsp -&gt; %rbp\n[RexOp1adjustsp_ib#d083]            adjust_sp_down_imm 32\n[RexOp1pu_iq#80b8,%rax]             v0 = iconst.i64 0x4242_3535_1234_5678\n                                    v4 -&gt; v0\n[RexOp1pu_iq#80b8,%rdx]             v1 = iconst.i64 0xabcd_ef01_beef_b411\n                                    v5 -&gt; v1\n[-,-]                               v2 = iconcat v0, v1\n[RexOp1st#8089]                     store notrap aligned v0, v3\n[RexOp1stDisp8#8089]                store notrap aligned v1, v3+8\n[RexOp1rmov#8089]                   regmove v3, %rcx -&gt; %rax\n[RexOp1adjustsp_ib#8083]            adjust_sp_up_imm 32\n[RexOp1popq#58,%rbp]                v7 = x86_pop.i64\n[Op1ret#c3]                         return v3, v7\n}\n\nDisassembly of 46 bytes:\n   0:   40 55                   push    rbp\n   2:   48 89 e5                mov rbp, rsp\n   5:   48 83 ec 20             sub rsp, 0x20\n   9:   48 b8 78 56 34 12 35 35 42 42\n                movabs  rax, 0x4242353512345678\n  13:   48 ba 11 b4 ef be 01 ef cd ab\n                movabs  rdx, 0xabcdef01beefb411\n  1d:   48 89 01                mov qword ptr [rcx], rax\n  20:   48 89 51 08             mov qword ptr [rcx + 8], rdx\n  24:   48 89 c8                mov rax, rcx\n  27:   48 83 c4 20             add rsp, 0x20\n  2b:   40 5d                   pop rbp\n  2d:   c3                      ret\n</pre></div>\n\n\n<p>I'll make a PR.</p>\n</blockquote>",
        "id": 194007183,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1586944473
    },
    {
        "content": "<p>fitzgen closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1162\">Issue #1162</a>:</p>\n<blockquote>\n<ul>\n<li>Run the following test with <a href=\"https://github.com/bytecodealliance/cranelift/issues/1231\">bytecodealliance/cranelift#1231</a> applied.</li>\n<li>Test fails with <code>Verifier errors</code> on Windows 10 x86-64, for details see <a href=\"https://github.com/bytecodealliance/cranelift/pull/1231#issuecomment-561820442\">https://github.com/bytecodealliance/cranelift/pull/1231#issuecomment-561820442</a></li>\n<li>Test does not fail on ubuntu.</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>function %test_i128() -&gt; i128 {\nebb0:\n    v0 = iconst.i64 0x4242_3535_1234_5678\n    v1 = iconst.i64 0xabcd_ef01_beef_b411\n    v2 = iconcat v0, v1\n    return v2\n}\n; run: %fn() == 0x4242_3535_1234_5678_abcd_ef01_beef_b411\n</code></pre></div>\n\n\n</blockquote>",
        "id": 199182455,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1590771738
    }
]