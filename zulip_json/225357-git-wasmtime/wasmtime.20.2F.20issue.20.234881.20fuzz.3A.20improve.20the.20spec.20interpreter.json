[
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1239988964\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@conrad-watt, I see occasional errors when running the <code>wasm-spec-interpreter</code> tests. I am not sure what is going on, but I wonder if the global state on the OCaml side? E.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>cargo <span class=\"nb\">test</span> --features build-libinterpret\n<span class=\"go\">    Finished test [unoptimized + debuginfo] target(s) in 0.03s</span>\n<span class=\"go\">     Running unittests src/lib.rs (/.../wasmtime/target/debug/deps/wasm_spec_interpreter-f7e7d72240eb2160)</span>\n\n<span class=\"go\">running 10 tests</span>\n<span class=\"go\">test with_library::tests::order_of_params ... ok</span>\n<span class=\"go\">test with_library::tests::invalid_function_name ... ok</span>\n<span class=\"go\">test with_library::tests::oob_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::oob ... ok</span>\n<span class=\"go\">test with_library::tests::multiple_invocation_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::load_store_and_export ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not ... ok</span>\n<span class=\"go\">test with_library::tests::order_of_params_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::multiple_invocation ... FAILED</span>\n\n<span class=\"go\">failures:</span>\n\n<span class=\"go\">---- with_library::tests::multiple_invocation stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::multiple_invocation' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) error: type system violation\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:212:10</span>\n<span class=\"go\">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</span>\n\n\n<span class=\"go\">failures:</span>\n<span class=\"go\">    with_library::tests::multiple_invocation</span>\n\n<span class=\"go\">test result: FAILED. 9 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span>\n</code></pre></div>\n<p>I will see more than 75% of test runs like the above fail, but often for different reasons. I wondered if the locking is an issue, but it continues to happen even when I run the tests in single-threaded mode (e.g., <code>cargo test --features build-libinterpret -j 1</code>). Any ideas? </p>\n</blockquote>",
        "id": 297685775,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662591384
    },
    {
        "content": "<p>abrown edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1239988964\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@conrad-watt, I see occasional errors when running the <code>wasm-spec-interpreter</code> tests. I am not sure what is going on, but I wonder if the global state on the OCaml side? E.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>cargo <span class=\"nb\">test</span> --features build-libinterpret\n<span class=\"go\">    Finished test [unoptimized + debuginfo] target(s) in 0.03s</span>\n<span class=\"go\">     Running unittests src/lib.rs (/.../wasmtime/target/debug/deps/wasm_spec_interpreter-f7e7d72240eb2160)</span>\n\n<span class=\"go\">running 10 tests</span>\n<span class=\"go\">test with_library::tests::order_of_params ... ok</span>\n<span class=\"go\">test with_library::tests::invalid_function_name ... ok</span>\n<span class=\"go\">test with_library::tests::oob_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::oob ... ok</span>\n<span class=\"go\">test with_library::tests::multiple_invocation_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::load_store_and_export ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not ... ok</span>\n<span class=\"go\">test with_library::tests::order_of_params_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::multiple_invocation ... FAILED</span>\n\n<span class=\"go\">failures:</span>\n\n<span class=\"go\">---- with_library::tests::multiple_invocation stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::multiple_invocation' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) error: type system violation\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:212:10</span>\n<span class=\"go\">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</span>\n\n\n<span class=\"go\">failures:</span>\n<span class=\"go\">    with_library::tests::multiple_invocation</span>\n\n<span class=\"go\">test result: FAILED. 9 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span>\n</code></pre></div>\n<p>I will see more than 75% of test runs like the above fail, but often for different reasons. I wondered if the locking is an issue, but it continues to happen even when I run the tests in single-threaded mode (e.g., <code>cargo test --features build-libinterpret -j 1</code>). Any ideas? </p>\n</blockquote>",
        "id": 297685796,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662591400
    },
    {
        "content": "<p>abrown edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1239988964\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@conrad-watt, I see occasional errors when running the <code>wasm-spec-interpreter</code> tests. I am not sure what is going on, but I wonder if something is wrong with the global state on the OCaml side? E.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>cargo <span class=\"nb\">test</span> --features build-libinterpret\n<span class=\"go\">    Finished test [unoptimized + debuginfo] target(s) in 0.03s</span>\n<span class=\"go\">     Running unittests src/lib.rs (/.../wasmtime/target/debug/deps/wasm_spec_interpreter-f7e7d72240eb2160)</span>\n\n<span class=\"go\">running 10 tests</span>\n<span class=\"go\">test with_library::tests::order_of_params ... ok</span>\n<span class=\"go\">test with_library::tests::invalid_function_name ... ok</span>\n<span class=\"go\">test with_library::tests::oob_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::oob ... ok</span>\n<span class=\"go\">test with_library::tests::multiple_invocation_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::load_store_and_export ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not ... ok</span>\n<span class=\"go\">test with_library::tests::order_of_params_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::multiple_invocation ... FAILED</span>\n\n<span class=\"go\">failures:</span>\n\n<span class=\"go\">---- with_library::tests::multiple_invocation stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::multiple_invocation' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) error: type system violation\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:212:10</span>\n<span class=\"go\">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</span>\n\n\n<span class=\"go\">failures:</span>\n<span class=\"go\">    with_library::tests::multiple_invocation</span>\n\n<span class=\"go\">test result: FAILED. 9 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span>\n</code></pre></div>\n<p>I will see more than 75% of test runs like the above fail, but often for different reasons. I wondered if the locking is an issue, but it continues to happen even when I run the tests in single-threaded mode (e.g., <code>cargo test --features build-libinterpret -j 1</code>). Any ideas? </p>\n</blockquote>",
        "id": 297685833,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662591422
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1239989718\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Here's another one that shows how the same error state is being seen across multiple tests:</p>\n<p><div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>cargo <span class=\"nb\">test</span> --features build-libinterpret -j <span class=\"m\">1</span>\n<span class=\"go\">    Finished test [unoptimized + debuginfo] target(s) in 0.04s</span>\n<span class=\"go\">     Running unittests src/lib.rs (/home/abrown/Code/wasmtime/target/debug/deps/wasm_spec_interpreter-f7e7d72240eb2160)</span>\n\n<span class=\"go\">running 10 tests</span>\n<span class=\"go\">test with_library::tests::invalid_function_name ... ok</span>\n<span class=\"go\">test with_library::tests::oob_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::order_of_params ... ok</span>\n<span class=\"go\">test with_library::tests::order_of_params_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::oob ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not ... FAILED</span>\n<span class=\"go\">test with_library::tests::multiple_invocation ... FAILED</span>\n<span class=\"go\">test with_library::tests::multiple_invocation_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::load_store_and_export ... FAILED</span>\n\n<span class=\"go\">failures:</span>\n\n<span class=\"go\">---- with_library::tests::simd_not stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::simd_not' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) trap: load\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:268:68</span>\n<span class=\"go\">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</span>\n\n<span class=\"go\">---- with_library::tests::multiple_invocation stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::multiple_invocation' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) trap: load\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:212:10</span>\n\n<span class=\"go\">---- with_library::tests::load_store_and_export stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::load_store_and_export' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) trap: load\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:340:27</span>\n\n\n<span class=\"go\">failures:</span>\n<span class=\"go\">    with_library::tests::load_store_and_export</span>\n<span class=\"go\">    with_library::tests::multiple_invocation</span>\n<span class=\"go\">    with_library::tests::simd_not</span>\n\n<span class=\"go\">test result: FAILED. 7 passed; 3 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 297685897,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662591480
    },
    {
        "content": "<p>abrown edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1239989718\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Here's another one that shows how the same error state is being seen across multiple tests:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>cargo <span class=\"nb\">test</span> --features build-libinterpret -j <span class=\"m\">1</span>\n<span class=\"go\">    Finished test [unoptimized + debuginfo] target(s) in 0.04s</span>\n<span class=\"go\">     Running unittests src/lib.rs (/home/abrown/Code/wasmtime/target/debug/deps/wasm_spec_interpreter-f7e7d72240eb2160)</span>\n\n<span class=\"go\">running 10 tests</span>\n<span class=\"go\">test with_library::tests::invalid_function_name ... ok</span>\n<span class=\"go\">test with_library::tests::oob_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::order_of_params ... ok</span>\n<span class=\"go\">test with_library::tests::order_of_params_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::oob ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::simd_not ... FAILED</span>\n<span class=\"go\">test with_library::tests::multiple_invocation ... FAILED</span>\n<span class=\"go\">test with_library::tests::multiple_invocation_legacy ... ok</span>\n<span class=\"go\">test with_library::tests::load_store_and_export ... FAILED</span>\n\n<span class=\"go\">failures:</span>\n\n<span class=\"go\">---- with_library::tests::simd_not stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::simd_not' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) trap: load\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:268:68</span>\n<span class=\"go\">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</span>\n\n<span class=\"go\">---- with_library::tests::multiple_invocation stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::multiple_invocation' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) trap: load\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:212:10</span>\n\n<span class=\"go\">---- with_library::tests::load_store_and_export stdout ----</span>\n<span class=\"go\">thread 'with_library::tests::load_store_and_export' panicked at 'called `Result::unwrap()` on an `Err` value: \"Error(_, \\\"(Isabelle) trap: load\\\")\"', crates/fuzzing/wasm-spec-interpreter/src/with_library.rs:340:27</span>\n\n\n<span class=\"go\">failures:</span>\n<span class=\"go\">    with_library::tests::load_store_and_export</span>\n<span class=\"go\">    with_library::tests::multiple_invocation</span>\n<span class=\"go\">    with_library::tests::simd_not</span>\n\n<span class=\"go\">test result: FAILED. 7 passed; 3 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span>\n</code></pre></div>\n<p>Note that <code>multiple_invocation</code> and <code>simd_not</code> do not do a <code>load</code>.</p>\n</blockquote>",
        "id": 297685967,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662591507
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240004427\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Update: <code>-j 1</code> may not be doing what I expect it to. When I forcibly limit execution to a single CPU, <code>taskset --cpu-list 7 cargo test --features build-libinterpret</code>, I do not see the errors. And this makes sense, now that I think about it (and don't trust <code>-j 1</code>): different test executions were sneaking in between <code>instantiate</code> and <code>interpret</code>, re-using the single global instance.</p>\n<p>@alexcrichton, perhaps it makes sense to make <code>SpecInstance</code> hold on to the global lock for its lifetime so that no other threads can access its state?</p>\n</blockquote>",
        "id": 297687067,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662592186
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240023673\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"fuzzing\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>fitzgen: fuzzing</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 297689712,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662593997
    },
    {
        "content": "<p>conrad-watt <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240023698\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<blockquote>\n<p>Update: <code>-j 1</code> may not be doing what I expect it to. When I forcibly limit execution to a single CPU, <code>taskset --cpu-list 7 cargo test --features build-libinterpret</code>, I do not see the errors. And this makes sense, now that I think about it (and don't trust <code>-j 1</code>): different test executions were sneaking in between <code>instantiate</code> and <code>interpret</code>, re-using the single global instance.</p>\n</blockquote>\n<p>Ahhh, I'm sorry I didn't think of this. The way I currently handle the global store isn't thread safe as it gets globally reset every time <code>instantiate</code> is called.</p>\n<blockquote>\n<p>@alexcrichton, perhaps it makes sense to make <code>SpecInstance</code> hold on to the global lock for its lifetime so that no other threads can access its state?</p>\n</blockquote>\n<p>I think I can actually fix this with an OCaml-internal hack that would allow us to interleave <code>instantiate</code> and <code>interpret</code> properly - I'll have a quick play in my branch.</p>\n</blockquote>",
        "id": 297689718,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662594000
    },
    {
        "content": "<p>conrad-watt <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240057650\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@abrown I can pick this up tomorrow if there's an issue, but I've pushed what _should_ be a fix to <a href=\"https://github.com/conrad-watt/wasmtime/tree/abrown-merge\">https://github.com/conrad-watt/wasmtime/tree/abrown-merge</a>, as a commit on top of your PR branch here.</p>\n<p>I was able to reproduce your errors above, and after a few runs the latest commit on that branch seems to have the tests passing.</p>\n</blockquote>",
        "id": 297693588,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662597265
    },
    {
        "content": "<p>conrad-watt edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240057650\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@abrown I can pick this up tomorrow if there's an issue, but I've pushed what _should_ be a fix to <a href=\"https://github.com/conrad-watt/wasmtime/tree/abrown-merge\">https://github.com/conrad-watt/wasmtime/tree/abrown-merge</a>, as a commit on top of your PR branch here.</p>\n<p>I was able to reproduce your errors above, and after a few runs the latest commit on that branch seems to have the tests passing.</p>\n<p>EDIT: to go into a little detail, I've changed the OCaml-side definition of the instance so that each instance carries round a reference to a store that's specific to that instantiation. Because everything is updated by reference there should be no visible behavioural change on the Rust side, apart from everything suddenly being thread-safe. This fix will need to be generalised slightly in future if we want to allow multiple modules to be instantiated in the same store.</p>\n</blockquote>",
        "id": 297693916,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662597596
    },
    {
        "content": "<p>conrad-watt edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240057650\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@abrown I can pick this up tomorrow if there's an issue, but I've pushed what _should_ be a fix to <a href=\"https://github.com/conrad-watt/wasmtime/tree/abrown-merge\">https://github.com/conrad-watt/wasmtime/tree/abrown-merge</a>, as a commit on top of your PR branch here.</p>\n<p>I was able to reproduce your errors above, and after a few runs the latest commit on that branch seems to have the tests passing.</p>\n<p>EDIT: to go into a little detail, I've changed the OCaml-side definition of the instance so that each instance carries round a reference to a \"global store\" that's specific to that instantiation. Because everything is updated by reference there should be no visible behavioural change on the Rust side, apart from everything suddenly being thread-safe. This fix will need to be generalised slightly in future if we want to allow multiple modules to be instantiated in the same store.</p>\n</blockquote>",
        "id": 297694113,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662597735
    },
    {
        "content": "<p>conrad-watt edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240057650\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@abrown I can pick this up tomorrow if there's an issue, but I've pushed what _should_ be a fix to <a href=\"https://github.com/conrad-watt/wasmtime/tree/abrown-merge\">https://github.com/conrad-watt/wasmtime/tree/abrown-merge</a>, as a commit on top of your PR branch here.</p>\n<p>I was able to reproduce your errors above, and after a few runs the latest commit on that branch seems to have the tests passing.</p>\n<p>EDIT: to go into a little detail, I've changed the OCaml-side definition of the instance so that each instance carries round a reference to a \"global store\" that's specific to that instantiation. Because everything is updated by reference there should be no visible behavioural change on the Rust side, apart from everything suddenly being thread-safe (modulo the fact that access to the OCaml runtime still needs to be locked). This fix will need to be generalised slightly in future if we want to allow multiple modules to be instantiated in the same store.</p>\n</blockquote>",
        "id": 297694143,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662597780
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240743294\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Thanks! I applied your changes in 19206a3 and I no longer see any test failures. I think this is good to go.</p>\n</blockquote>",
        "id": 297787336,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662644885
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240817456\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Unfortunately, after d29cdbd when I run <code>ALLOWED_ENGINES=spec cargo +nightly fuzz run -s none differential</code> the following test case fails:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">func</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n    <span class=\"nb\">global.get</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">i32.eqz</span>\n    <span class=\"k\">if</span>  <span class=\"c1\">;; label = @1</span>\n      <span class=\"nb\">unreachable</span>\n    <span class=\"k\">end</span>\n    <span class=\"nb\">global.get</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n    <span class=\"nb\">i32.sub</span>\n    <span class=\"nb\">global.set</span> <span class=\"mi\">0</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;1;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n    <span class=\"nb\">global.get</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">i32.eqz</span>\n    <span class=\"k\">if</span>  <span class=\"c1\">;; label = @1</span>\n      <span class=\"nb\">unreachable</span>\n    <span class=\"k\">end</span>\n    <span class=\"nb\">global.get</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n    <span class=\"nb\">i32.sub</span>\n    <span class=\"nb\">global.set</span> <span class=\"mi\">0</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">global</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">mut</span> <span class=\"kt\">i32</span><span class=\"p\">)</span> <span class=\"nb\">i32.const</span> <span class=\"mf\">1000</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"</span><span class=\"se\">\\00</span><span class=\"s2\">[</span><span class=\"se\">\\00</span><span class=\"s2\">\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">0</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<p>The error is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"n\">T14</span>:<span class=\"mi\">40</span>:<span class=\"mi\">47</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasmtime_fuzzing</span>::<span class=\"n\">oracles</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Evaluating</span>: <span class=\"err\">`</span><span class=\"p\">[</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"p\">[]</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"n\">T14</span>:<span class=\"mi\">40</span>:<span class=\"mi\">47</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasmtime_fuzzing</span>::<span class=\"n\">oracles</span><span class=\"p\">]</span><span class=\"w\">  </span>-&gt; <span class=\"nc\">results</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">spec</span>: <span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">Not_found</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"n\">T14</span>:<span class=\"mi\">40</span>:<span class=\"mi\">47</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasmtime_fuzzing</span>::<span class=\"n\">oracles</span><span class=\"p\">]</span><span class=\"w\">  </span>-&gt; <span class=\"nc\">results</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span>: <span class=\"nb\">Ok</span><span class=\"p\">([])</span><span class=\"w\"></span>\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'&lt;</span><span class=\"n\">unnamed</span><span class=\"o\">&gt;'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">only</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">lhs</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">spec</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">fuzzing</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">oracles</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">387</span>:<span class=\"mi\">28</span><span class=\"w\"></span>\n<span class=\"n\">note</span>: <span class=\"nc\">run</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">RUST_BACKTRACE</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"n\">variable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"w\"></span>\n</code></pre></div>\n<p>@conrad-watt, what are the chances that we aren't handling the empty string name?</p>\n</blockquote>",
        "id": 297796941,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662648258
    },
    {
        "content": "<p>abrown edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240817456\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Unfortunately, after d29cdbd when I run <code>ALLOWED_ENGINES=spec cargo +nightly fuzz run -s none differential</code> the following test case fails:</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">func</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n    <span class=\"nb\">global.get</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">i32.eqz</span>\n    <span class=\"k\">if</span>  <span class=\"c1\">;; label = @1</span>\n      <span class=\"nb\">unreachable</span>\n    <span class=\"k\">end</span>\n    <span class=\"nb\">global.get</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n    <span class=\"nb\">i32.sub</span>\n    <span class=\"nb\">global.set</span> <span class=\"mi\">0</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;1;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n    <span class=\"nb\">global.get</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">i32.eqz</span>\n    <span class=\"k\">if</span>  <span class=\"c1\">;; label = @1</span>\n      <span class=\"nb\">unreachable</span>\n    <span class=\"k\">end</span>\n    <span class=\"nb\">global.get</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n    <span class=\"nb\">i32.sub</span>\n    <span class=\"nb\">global.set</span> <span class=\"mi\">0</span>\n  <span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">global</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">mut</span> <span class=\"kt\">i32</span><span class=\"p\">)</span> <span class=\"nb\">i32.const</span> <span class=\"mf\">1000</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"</span><span class=\"se\">\\00</span><span class=\"s2\">[</span><span class=\"se\">\\00</span><span class=\"s2\">\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">0</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<p>The error is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"n\">T14</span>:<span class=\"mi\">40</span>:<span class=\"mi\">47</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasmtime_fuzzing</span>::<span class=\"n\">oracles</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Evaluating</span>: <span class=\"err\">`</span><span class=\"p\">[</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"p\">[]</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"n\">T14</span>:<span class=\"mi\">40</span>:<span class=\"mi\">47</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasmtime_fuzzing</span>::<span class=\"n\">oracles</span><span class=\"p\">]</span><span class=\"w\">  </span>-&gt; <span class=\"nc\">results</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">spec</span>: <span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">Not_found</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"n\">T14</span>:<span class=\"mi\">40</span>:<span class=\"mi\">47</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">DEBUG</span><span class=\"w\"> </span><span class=\"n\">wasmtime_fuzzing</span>::<span class=\"n\">oracles</span><span class=\"p\">]</span><span class=\"w\">  </span>-&gt; <span class=\"nc\">results</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span>: <span class=\"nb\">Ok</span><span class=\"p\">([])</span><span class=\"w\"></span>\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'&lt;</span><span class=\"n\">unnamed</span><span class=\"o\">&gt;'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">only</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">lhs</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">spec</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">fuzzing</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">oracles</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">387</span>:<span class=\"mi\">28</span><span class=\"w\"></span>\n<span class=\"n\">note</span>: <span class=\"nc\">run</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">RUST_BACKTRACE</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"n\">variable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"w\"></span>\n</code></pre></div>\n<p>@conrad-watt, what are the chances that we aren't handling strings with weird bytes?</p>\n</blockquote>",
        "id": 297797061,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662648288
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240819395\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>That actually looks like it maybe related to the FFI boundary and communicating strings with nul bytes in them since the function is called <code>\"\\00[\\00\"</code> and the <code>Evaluating: ...</code> there is printing the nul byte which I guess the terminal does nothing with.</p>\n</blockquote>",
        "id": 297797280,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662648345
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240824354\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Yeah, maybe we need to pass bytes across to OCaml instead of a string?</p>\n</blockquote>",
        "id": 297798093,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662648567
    },
    {
        "content": "<p>alexcrichton edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240819395\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>That actually looks like it may be related to the FFI boundary and communicating strings with nul bytes in them since the function is called <code>\"\\00[\\00\"</code> and the <code>Evaluating: ...</code> there is printing the nul byte which I guess the terminal does nothing with.</p>\n</blockquote>",
        "id": 297799077,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662648845
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240849576\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>This looks like a bug in the <code>ocaml-interop</code> crate:</p>\n<p><a href=\"https://github.com/tezedge/ocaml-interop/blob/550dae57bddb8ae9e3838594bcccc18970f56e99/src/memory.rs#L69-L77\">https://github.com/tezedge/ocaml-interop/blob/550dae57bddb8ae9e3838594bcccc18970f56e99/src/memory.rs#L69-L77</a></p>\n<p>there the <code>string_val</code> function is documented <a href=\"https://v2.ocaml.org/manual/intfc.html\">here</a> as:</p>\n<blockquote>\n<p>String_val(v) returns a pointer to the first byte of the string v, with type char * or, when OCaml is configured with -force-safe-string, with type const char *. This pointer is a valid C string: there is a null byte after the last byte in the string. However, OCaml strings can contain embedded null bytes, which will confuse the usual C functions over strings. </p>\n</blockquote>\n</blockquote>",
        "id": 297802419,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662649711
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240851678\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>that beings said <code>ocaml_sys::string_val</code> looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"sd\">/// Extracts a machine `ptr` to the bytes making up an OCaml `string`</span>\n<span class=\"cp\">#[inline]</span><span class=\"w\"></span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">string_val</span><span class=\"p\">(</span><span class=\"n\">val</span>: <span class=\"nc\">Value</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"kt\">u8</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"kt\">u8</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>so I dunno what's going on (not really that familiar with ocaml and FFI at all myself, this is just what I found looking around). It might be worth trying to use a byte list instead yeah.</p>\n</blockquote>",
        "id": 297802759,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662649807
    },
    {
        "content": "<p>conrad-watt <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240862278\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>FWIW my first reaction (in the spirit of what was discussed above) would be to try using OCaml's <code>bytes</code> type to pass the string from Rust -&gt; OCaml and then calling <code>Bytes.to_string</code> in <code>interpret.ml</code>. LMK if it would be helpful for me to try this locally.</p>\n</blockquote>",
        "id": 297804351,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662650270
    },
    {
        "content": "<p>conrad-watt edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240862278\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>FWIW my first reaction (in the spirit of what was discussed above) would be to try using OCaml's <code>bytes</code> type to pass the string function name from Rust -&gt; OCaml and then calling <code>Bytes.to_string</code> in <code>interpret.ml</code>. LMK if it would be helpful for me to try this locally.</p>\n</blockquote>",
        "id": 297804445,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662650285
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1240981616\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@conrad-watt, yeah, if you try out the \"bytes across the boundary\" approach that would be great; otherwise I can try this later in a day or two when I get back to this.</p>\n</blockquote>",
        "id": 297825668,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662656488
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1241344966\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>I was curious to dig into this a bit. I actually don't think that the problem is with <code>ocaml-interop</code>, instead the <code>e_name</code> function to get the name of an export from the ocaml AST is returning the name of the export as <code>\\u{0}[\\u{0}</code>. It looks like the spec interpreter is mangling the name of the export so we're trying to lookup the raw name in a list of mangled names which then fails to find the export. As a quick-and-dirty hack I hooked up the same name-mangling in Rust:</p>\n<p>&lt;details&gt;</p>\n<div class=\"codehilite\" data-code-language=\"patch\"><pre><span></span><code>diff --git a/crates/fuzzing/wasm-spec-interpreter/src/with_library.rs b/crates/fuzzing/wasm-spec-interpreter/src/with_library.rs\nindex 15be5b5ab..b02f2d6e3 100644\n--- a/crates/fuzzing/wasm-spec-interpreter/src/with_library.rs\n+++ b/crates/fuzzing/wasm-spec-interpreter/src/with_library.rs\n@@ -35,6 +35,7 @@\n use crate::{SpecExport, SpecInstance, SpecValue};\n use ocaml_interop::{BoxRoot, OCamlRuntime, ToOCaml};\n use once_cell::sync::Lazy;\n+use std::fmt::Write;\n use std::sync::Mutex;\n\n static INTERPRET: Lazy&lt;Mutex&lt;()&gt;&gt; = Lazy::new(|| Mutex::new(()));\n@@ -62,7 +63,7 @@ pub fn interpret(\n\n     // Prepare the box-rooted parameters.\n     let instance = instance.to_boxroot(ocaml_runtime);\n-    let name = name.to_string().to_boxroot(ocaml_runtime);\n+    let name = mangle_name(name).to_boxroot(ocaml_runtime);\n     let parameters = parameters.to_boxroot(ocaml_runtime);\n\n     // Interpret the function.\n@@ -96,13 +97,29 @@ pub fn export(instance: &amp;SpecInstance, name: &amp;str) -&gt; Result&lt;SpecExport, String&gt;\n\n     // Prepare the box-rooted parameters.\n     let instance = instance.to_boxroot(ocaml_runtime);\n-    let name = name.to_string().to_boxroot(ocaml_runtime);\n+    let name = mangle_name(name).to_string().to_boxroot(ocaml_runtime);\n\n     // Export the value.\n     let results = ocaml_bindings::export(ocaml_runtime, &amp;instance, &amp;name);\n     results.to_rust(&amp;ocaml_runtime)\n }\n\n+fn mangle_name(name: &amp;str) -&gt; String {\n+    let mut mangled = String::new();\n+    for c in name.chars() {\n+        let val = u32::from(c);\n+        if val &lt; 0x20 || val &gt;= 0x7f {\n+            write!(mangled, \"\\\\u{{{val:02x}}}\").unwrap();\n+        } else {\n+            if c == '\"' || c == '\\\\' {\n+                mangled.push('\\\\');\n+            }\n+            mangled.push(c);\n+        }\n+    }\n+    mangled\n+}\n+\n // Here we declare which functions we will use from the OCaml library. See\n // https://docs.rs/ocaml-interop/0.8.4/ocaml_interop/index.html#example.\n mod ocaml_bindings {\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>and I got past that particular crashing test case. @conrad-watt do you know if this is intentional or perhaps an accident of using the wrong function to find the name of an export? If it's intentional then it might be best to do the name mangling in ocaml to avoid duplicating it in Rust as I did above (which was just the fastest route for me)</p>\n<hr>\n<p>Otherwise though I applied this diff:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/crates/fuzzing/src/oracles/diff_spec.rs b/crates/fuzzing/src/oracles/diff_spec.rs</span><span class=\"w\"></span>\n<span class=\"gh\">index 753a38014..2fd285508 100644</span><span class=\"w\"></span>\n<span class=\"gd\">--- a/crates/fuzzing/src/oracles/diff_spec.rs</span><span class=\"w\"></span>\n<span class=\"gi\">+++ b/crates/fuzzing/src/oracles/diff_spec.rs</span><span class=\"w\"></span>\n<span class=\"gu\">@@ -16,6 +16,8 @@ impl SpecInterpreter {</span><span class=\"w\"></span>\n\n<span class=\"w\"> </span>        config.min_memories = config.min_memories.min(1);<span class=\"w\"></span>\n<span class=\"w\"> </span>        config.max_memories = config.max_memories.min(1);<span class=\"w\"></span>\n<span class=\"gi\">+        config.min_tables = config.min_tables.min(1);</span><span class=\"w\"></span>\n<span class=\"gi\">+        config.max_tables = config.max_tables.min(1);</span><span class=\"w\"></span>\n\n<span class=\"w\"> </span>        config.memory64_enabled = false;<span class=\"w\"></span>\n<span class=\"w\"> </span>        config.threads_enabled = false;<span class=\"w\"></span>\n<span class=\"gu\">@@ -43,9 +45,7 @@ impl DiffEngine for SpecInterpreter {</span><span class=\"w\"></span>\n<span class=\"w\"> </span>    }<span class=\"w\"></span>\n\n<span class=\"w\"> </span>    fn is_stack_overflow(&amp;self, err: &amp;Error) -&gt; bool {<span class=\"w\"></span>\n<span class=\"gd\">-        // TODO: implement this for the spec interpreter</span><span class=\"w\"></span>\n<span class=\"gd\">-        drop(err);</span><span class=\"w\"></span>\n<span class=\"gd\">-        false</span><span class=\"w\"></span>\n<span class=\"gi\">+        err.to_string().contains(\"(Isabelle) call stack exhausted\")</span><span class=\"w\"></span>\n<span class=\"w\"> </span>    }<span class=\"w\"></span>\n<span class=\"w\"> </span>}<span class=\"w\"></span>\n</code></pre></div>\n<p>and I've got 400k executions with no errors so far. (the <code>is_stack_overflow</code> check is required for correctness since the spec interpreter can stack overflow at a different time than wasmtime stack overflows)</p>\n</blockquote>",
        "id": 297888899,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662680991
    },
    {
        "content": "<p>conrad-watt <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1241429123\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>@alexcrichton ahh you're absolutely right! I was inadvertently mangling names in the spec interpreter. I've just pushed a <a href=\"https://github.com/conrad-watt/spec/commit/763f960264fe62a0128de173b8e03cd187579596\">new commit</a> of the spec interpreter that _should_ fix this - If the spec interpreter commit is bumped to <code>763f960264fe62a0128de173b8e03cd187579596</code> does everything work without the need to mangle Rust-provided names?</p>\n</blockquote>",
        "id": 297898919,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662690707
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1243845443\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Works well for me locally, thanks!</p>\n</blockquote>",
        "id": 298394967,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662993655
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1243921906\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Oh actually I may have spoken too soon. I forgot about the fuzzer I left running and it hit this crash:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'&lt;</span><span class=\"n\">unnamed</span><span class=\"o\">&gt;'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"n\">side</span>: <span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"n\">interpreter</span>: <span class=\"nc\">Invalid_argument</span><span class=\"p\">(</span><span class=\"s\">\"Char.chr\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">None</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fuzz</span><span class=\"o\">/</span><span class=\"n\">fuzz_targets</span><span class=\"o\">/</span><span class=\"n\">differential</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">128</span>:<span class=\"mi\">13</span><span class=\"w\"></span>\n</code></pre></div>\n<p>which I think means that the test case failed to get instantiated in the spec interpreter but succeeded in instantiation within Wasmtime. The input module was:</p>\n<div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(module\n  (type (;0;) (func))\n  (func (;0;) (type 0)\n    global.get 0\n    i32.eqz\n    if  ;; label = @1\n      unreachable\n    end\n    global.get 0\n    i32.const 1\n    i32.sub\n    global.set 0\n  )\n  (global (;0;) (mut i32) i32.const 1000)\n  (export \"+1\\c8\\8d\\0d\\02\\00\\00\\00\" (func 0))\n)\n</code></pre></div>\n<p>where the name of the export in Rust-debug-print looks like <code>\"+1\\r\\u{2}\\0\\0\\0\"</code></p>\n</blockquote>",
        "id": 298406239,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1662996980
    },
    {
        "content": "<p>conrad-watt <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1243996287\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>It's great that the fuzzer is able to torture this corner of the implementation :)</p>\n<p>Here's a <a href=\"https://github.com/conrad-watt/spec/commit/c6bab4461e10229e557aae2e1027cadfce0161ce\">new fix</a> - commit <code>c6bab4461e10229e557aae2e1027cadfce0161ce</code>. I did some testing locally, and fingers crossed no further issues...</p>\n</blockquote>",
        "id": 298418155,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1663000488
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1244043116\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Just to make sure I get this straight: all that's left to do is to 1) apply the second diff @alexcrichton provided (<code>min_tables</code> + <code>is_stack_overflow</code>) and 2) point the repository to the second commit @conrad-watt provided. Is that right?</p>\n</blockquote>",
        "id": 298425593,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1663002830
    },
    {
        "content": "<p>abrown edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1244043116\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Just to make sure I get this straight: all that's left to do is to 1) apply the second diff @alexcrichton provided (<code>min_tables</code> + <code>is_stack_overflow</code>) and 2) point the repository to the second commit @conrad-watt provided (c6bab44). Is that right?</p>\n</blockquote>",
        "id": 298425681,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1663002853
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1244122023\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>I believe so, yeah, but so far my fixes have all been driven from the fuzzer so I'd run it for a bit locally as well to ensure nothing shows up</p>\n</blockquote>",
        "id": 298437083,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1663006656
    },
    {
        "content": "<p>abrown <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881#issuecomment-1244410730\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4881\">issue #4881</a>:</p>\n<blockquote>\n<p>Ok, I ran this target for a while with the latest two commits and it seems to be good to go:</p>\n<p><div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span><span class=\"nv\">ALLOWED_ENGINES</span><span class=\"o\">=</span>-v8 cargo +nightly fuzz run differential\n<span class=\"go\">...</span>\n<span class=\"gp\">#</span><span class=\"m\">556973</span> NEW    cov: <span class=\"m\">73704</span> ft: <span class=\"m\">392590</span> corp: <span class=\"m\">12777</span>/4426Kb lim: <span class=\"m\">743</span> exec/s: <span class=\"m\">90</span> rss: 1082Mb L: <span class=\"m\">626</span>/743 MS: <span class=\"m\">1</span> CopyPart-\n<span class=\"go\">=== Execution rate (438172 successes / 557000 attempted modules): 78.67% ===</span>\n<span class=\"go\">        wasmi: 22.82%, spec: 23.46%, wasmtime: 53.71%, v8: 0.00%</span>\n<span class=\"go\">        wasm-smith: 75.49%, single-inst: 24.51%</span>\n<span class=\"gp\">#</span><span class=\"m\">557027</span> REDUCE cov: <span class=\"m\">73704</span> ft: <span class=\"m\">392590</span> corp: <span class=\"m\">12777</span>/4426Kb lim: <span class=\"m\">743</span> exec/s: <span class=\"m\">90</span> rss: 1082Mb L: <span class=\"m\">339</span>/743 MS: <span class=\"m\">4</span> ChangeASCIIInt-CrossOver-CopyPart-EraseBytes-\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 298474250,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1663014969
    }
]