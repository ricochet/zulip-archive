[
    {
        "content": "<p>hungryzzz opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624\">issue #8624</a>:</p>\n<blockquote>\n<h3>Test Cases</h3>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/15321821/cases.zip\">cases.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and WasmEdge(AOT), and collect their execution time respectively (measured by time tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h3>Expected Results &amp; Actual Results</h3>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 1.17s</li>\n<li>WasmEdge: 0.59s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 6.01s</li>\n<li>WasmEdge: 0.59s</li>\n</ul>\n<p>The difference between the attached two cases is as follow, i.e., changing the operand of <code>i32.add</code> from <code>i32.const 0</code> to <code>local.get 1</code>, which can bring 5x performance decreasing on <code>Wasmtime</code> but has no effect on <code>WasmEdge</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>cases<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n62c62\n&lt;<span class=\"w\">                       </span>i32.const<span class=\"w\"> </span><span class=\"m\">0</span>\n---\n&gt;<span class=\"w\">                       </span>local.get<span class=\"w\"> </span><span class=\"m\">1</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"err\">#</span> <span class=\"err\">good.wat</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.add</span>\n\n<span class=\"err\">#</span> <span class=\"err\">bad.wat</span>\n<span class=\"nb\">local.get</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.add</span>\n</code></pre></div>\n<p>At first I thought the performance decreasing was caused by the difference, because the <code>good</code> one uses a constant while the <code>bad</code> one uses a local variable which may need to fetch from memory. So I do a small experiment: repeatly calculate (<code>2000000000</code> times) an addition operation whose operand are a constant or a local variable and measure the execution time respectively. And I find that they are almost the same, <code>1.09s</code> vs. <code>1.1s</code>. Therefore, I think the above performance decreasing is caused by other reasons.</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"err\">#</span> <span class=\"err\">experiment</span> <span class=\"err\">case</span>\n<span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">func</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"cm\">(;1;)</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"wasi_snapshot_preview1\"</span> <span class=\"s2\">\"proc_exit\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">1</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;1;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">local</span> <span class=\"kt\">i32</span> <span class=\"kt\">i32</span><span class=\"p\">)</span>\n    <span class=\"k\">loop</span>\n      <span class=\"c1\">;; i32.const 0</span>\n      <span class=\"nb\">local.get</span> <span class=\"mi\">1</span>\n      <span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n      <span class=\"nb\">i32.add</span>\n      <span class=\"nb\">local.get</span> <span class=\"mi\">0</span>\n      <span class=\"nb\">i32.add</span>\n      <span class=\"nb\">local.tee</span> <span class=\"mi\">0</span>\n      <span class=\"nb\">i32.const</span> <span class=\"mf\">2000000000</span>\n      <span class=\"nb\">i32.ne</span>\n      <span class=\"nb\">br_if</span> <span class=\"mi\">0</span>\n    <span class=\"k\">end</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">call</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">unreachable</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"cm\">(;0;)</span> <span class=\"mf\">8192</span> <span class=\"mf\">8192</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"_start\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"memory\"</span> <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"mi\">0</span><span class=\"p\">)))</span>\n</code></pre></div>\n<h3>Profiling Information</h3>\n<p>I use Perf tool to profile the execution time and find that the hotspot is in the loop where the small difference happens, so I think the difference change some compilation strategy which may cause the performance decreasing.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Samples:<span class=\"w\"> </span>23K<span class=\"w\"> </span>of<span class=\"w\"> </span>event<span class=\"w\"> </span><span class=\"s1\">'cycles'</span>,<span class=\"w\"> </span>Event<span class=\"w\"> </span>count<span class=\"w\"> </span><span class=\"o\">(</span>approx.<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">21853956752</span>\nOverhead<span class=\"w\">  </span>Command<span class=\"w\">          </span>Shared<span class=\"w\"> </span>Object<span class=\"w\">      </span>Symbol\n<span class=\"w\">  </span><span class=\"m\">99</span>.87%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span>jitted-93855-1.so<span class=\"w\">  </span><span class=\"o\">[</span>.<span class=\"o\">]</span><span class=\"w\"> </span>wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\">                                                                                           </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>tokio-runtime-w<span class=\"w\">  </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>__mod_memcg_lruvec_state<span class=\"w\">                                                                                       </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span>ld-2.31.so<span class=\"w\">         </span><span class=\"o\">[</span>.<span class=\"o\">]</span><span class=\"w\"> </span>_dl_relocate_object<span class=\"w\">                                                                                            </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>__do_fault<span class=\"w\">                                                                                                     </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.01%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>pmd_page_vaddr<span class=\"w\">                                                                                                 </span>▒\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># the commands to profile</span>\nperf<span class=\"w\"> </span>record<span class=\"w\"> </span>-k<span class=\"w\"> </span>mono<span class=\"w\"> </span>~/wasmtime/target/release/wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--profile<span class=\"w\"> </span>jitdump<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\nperf<span class=\"w\"> </span>inject<span class=\"w\"> </span>--jit<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.data<span class=\"w\"> </span>--output<span class=\"w\"> </span>perf.jit.data\nperf<span class=\"w\"> </span>report<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.jit.data<span class=\"w\"> </span>--no-children\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<ul>\n<li>Wasmtime version or commit: d0cf46a098d97bab9</li>\n<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>\n</li>\n</ul>\n</blockquote>",
        "id": 438810062,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715781831
    },
    {
        "content": "<p>hungryzzz edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624\">issue #8624</a>:</p>\n<blockquote>\n<h3>Test Cases</h3>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/15321821/cases.zip\">cases.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by time tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h3>Expected Results &amp; Actual Results</h3>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 1.17s</li>\n<li>WasmEdge: 0.59s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 6.01s</li>\n<li>WasmEdge: 0.59s</li>\n</ul>\n<p>The difference between the attached two cases is as follow, i.e., changing the operand of <code>i32.add</code> from <code>i32.const 0</code> to <code>local.get 1</code>, which can bring 5x performance decreasing on <code>Wasmtime</code> but has no effect on <code>WasmEdge</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>cases<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n62c62\n&lt;<span class=\"w\">                       </span>i32.const<span class=\"w\"> </span><span class=\"m\">0</span>\n---\n&gt;<span class=\"w\">                       </span>local.get<span class=\"w\"> </span><span class=\"m\">1</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"err\">#</span> <span class=\"err\">good.wat</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.add</span>\n\n<span class=\"err\">#</span> <span class=\"err\">bad.wat</span>\n<span class=\"nb\">local.get</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.add</span>\n</code></pre></div>\n<p>At first I thought the performance decreasing was caused by the difference, because the <code>good</code> one uses a constant while the <code>bad</code> one uses a local variable which may need to fetch from memory. So I do a small experiment: repeatly calculate (<code>2000000000</code> times) an addition operation whose operand are a constant or a local variable and measure the execution time respectively. And I find that they are almost the same, <code>1.09s</code> vs. <code>1.1s</code>. Therefore, I think the above performance decreasing is caused by other reasons.</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"err\">#</span> <span class=\"err\">experiment</span> <span class=\"err\">case</span>\n<span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">func</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"cm\">(;1;)</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"wasi_snapshot_preview1\"</span> <span class=\"s2\">\"proc_exit\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">1</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;1;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">local</span> <span class=\"kt\">i32</span> <span class=\"kt\">i32</span><span class=\"p\">)</span>\n    <span class=\"k\">loop</span>\n      <span class=\"c1\">;; i32.const 0</span>\n      <span class=\"nb\">local.get</span> <span class=\"mi\">1</span>\n      <span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n      <span class=\"nb\">i32.add</span>\n      <span class=\"nb\">local.get</span> <span class=\"mi\">0</span>\n      <span class=\"nb\">i32.add</span>\n      <span class=\"nb\">local.tee</span> <span class=\"mi\">0</span>\n      <span class=\"nb\">i32.const</span> <span class=\"mf\">2000000000</span>\n      <span class=\"nb\">i32.ne</span>\n      <span class=\"nb\">br_if</span> <span class=\"mi\">0</span>\n    <span class=\"k\">end</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">call</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">unreachable</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"cm\">(;0;)</span> <span class=\"mf\">8192</span> <span class=\"mf\">8192</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"_start\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"memory\"</span> <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"mi\">0</span><span class=\"p\">)))</span>\n</code></pre></div>\n<h3>Profiling Information</h3>\n<p>I use Perf tool to profile the execution time and find that the hotspot is in the loop where the small difference happens, so I think the difference change some compilation strategy which may cause the performance decreasing.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Samples:<span class=\"w\"> </span>23K<span class=\"w\"> </span>of<span class=\"w\"> </span>event<span class=\"w\"> </span><span class=\"s1\">'cycles'</span>,<span class=\"w\"> </span>Event<span class=\"w\"> </span>count<span class=\"w\"> </span><span class=\"o\">(</span>approx.<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">21853956752</span>\nOverhead<span class=\"w\">  </span>Command<span class=\"w\">          </span>Shared<span class=\"w\"> </span>Object<span class=\"w\">      </span>Symbol\n<span class=\"w\">  </span><span class=\"m\">99</span>.87%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span>jitted-93855-1.so<span class=\"w\">  </span><span class=\"o\">[</span>.<span class=\"o\">]</span><span class=\"w\"> </span>wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\">                                                                                           </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>tokio-runtime-w<span class=\"w\">  </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>__mod_memcg_lruvec_state<span class=\"w\">                                                                                       </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span>ld-2.31.so<span class=\"w\">         </span><span class=\"o\">[</span>.<span class=\"o\">]</span><span class=\"w\"> </span>_dl_relocate_object<span class=\"w\">                                                                                            </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>__do_fault<span class=\"w\">                                                                                                     </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.01%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>pmd_page_vaddr<span class=\"w\">                                                                                                 </span>▒\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># the commands to profile</span>\nperf<span class=\"w\"> </span>record<span class=\"w\"> </span>-k<span class=\"w\"> </span>mono<span class=\"w\"> </span>~/wasmtime/target/release/wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--profile<span class=\"w\"> </span>jitdump<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\nperf<span class=\"w\"> </span>inject<span class=\"w\"> </span>--jit<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.data<span class=\"w\"> </span>--output<span class=\"w\"> </span>perf.jit.data\nperf<span class=\"w\"> </span>report<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.jit.data<span class=\"w\"> </span>--no-children\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<ul>\n<li>Wasmtime version or commit: d0cf46a098d97bab9</li>\n<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>\n</li>\n</ul>\n</blockquote>",
        "id": 438819015,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715783922
    },
    {
        "content": "<p>hungryzzz edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624\">issue #8624</a>:</p>\n<blockquote>\n<h3>Test Cases</h3>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/15321821/cases.zip\">cases.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Hi, I run the attached two cases(<code>good.wasm</code>&amp;<code>bad.wasm</code>) in <code>Wasmtime</code> and <code>WasmEdge</code>(AOT), and collect their execution time respectively (measured by time tool).</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># command to collect execution time of wasmtime</span>\nwasmtime<span class=\"w\"> </span>compile<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>-o<span class=\"w\"> </span>bad.cwasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\n\n<span class=\"c1\"># command to collect execution time of wasmedge</span>\nwasmedgec<span class=\"w\"> </span>bad.wasm<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n<span class=\"nb\">time</span><span class=\"w\"> </span>wasmedge<span class=\"w\"> </span>bad-wasmedge-aot.wasm\n</code></pre></div>\n<h3>Expected Results &amp; Actual Results</h3>\n<p>For <code>good.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 1.17s</li>\n<li>WasmEdge: 0.59s</li>\n</ul>\n<p>For <code>bad.wasm</code>, the execution time in different runtimes are as follows:</p>\n<ul>\n<li>Wasmtime: 6.01s</li>\n<li>WasmEdge: 0.59s</li>\n</ul>\n<p>The difference between the attached two cases is as follow, i.e., changing the operand of <code>i32.add</code> from <code>i32.const 0</code> to <code>local.get 1</code>, which can bring 5x performance decreasing on <code>Wasmtime</code> but has no effect on <code>WasmEdge</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>➜<span class=\"w\">  </span>cases<span class=\"w\"> </span>diff<span class=\"w\"> </span>good.wat<span class=\"w\"> </span>bad.wat\n62c62\n&lt;<span class=\"w\">                       </span>i32.const<span class=\"w\"> </span><span class=\"m\">0</span>\n---\n&gt;<span class=\"w\">                       </span>local.get<span class=\"w\"> </span><span class=\"m\">1</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"c1\">;; good.wat</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.add</span>\n\n<span class=\"c1\">;; bad.wat</span>\n<span class=\"nb\">local.get</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n<span class=\"nb\">i32.add</span>\n</code></pre></div>\n<p>At first I thought the performance decreasing was caused by the difference, because the <code>good</code> one uses a constant while the <code>bad</code> one uses a local variable which may need to fetch from memory. So I do a small experiment: repeatly calculate (<code>2000000000</code> times) an addition operation whose operand are a constant or a local variable and measure the execution time respectively. And I find that they are almost the same, <code>1.09s</code> vs. <code>1.1s</code>. Therefore, I think the above performance decreasing is caused by other reasons.</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"c1\">;; experiment case</span>\n<span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">func</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"cm\">(;1;)</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">param</span> <span class=\"kt\">i32</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">import</span> <span class=\"s2\">\"wasi_snapshot_preview1\"</span> <span class=\"s2\">\"proc_exit\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;0;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">1</span><span class=\"p\">)))</span>\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"cm\">(;1;)</span> <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">local</span> <span class=\"kt\">i32</span> <span class=\"kt\">i32</span><span class=\"p\">)</span>\n    <span class=\"k\">loop</span>\n      <span class=\"c1\">;; i32.const 0</span>\n      <span class=\"nb\">local.get</span> <span class=\"mi\">1</span>\n      <span class=\"nb\">i32.const</span> <span class=\"mi\">1</span>\n      <span class=\"nb\">i32.add</span>\n      <span class=\"nb\">local.get</span> <span class=\"mi\">0</span>\n      <span class=\"nb\">i32.add</span>\n      <span class=\"nb\">local.tee</span> <span class=\"mi\">0</span>\n      <span class=\"nb\">i32.const</span> <span class=\"mf\">2000000000</span>\n      <span class=\"nb\">i32.ne</span>\n      <span class=\"nb\">br_if</span> <span class=\"mi\">0</span>\n    <span class=\"k\">end</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">call</span> <span class=\"mi\">0</span>\n    <span class=\"nb\">unreachable</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"cm\">(;0;)</span> <span class=\"mf\">8192</span> <span class=\"mf\">8192</span><span class=\"p\">)</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"_start\"</span> <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n  <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"memory\"</span> <span class=\"p\">(</span><span class=\"k\">memory</span> <span class=\"mi\">0</span><span class=\"p\">)))</span>\n</code></pre></div>\n<h3>Profiling Information</h3>\n<p>I use Perf tool to profile the execution time and find that the hotspot is in the loop where the small difference happens, so I think the difference change some compilation strategy which may cause the performance decreasing.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Samples:<span class=\"w\"> </span>23K<span class=\"w\"> </span>of<span class=\"w\"> </span>event<span class=\"w\"> </span><span class=\"s1\">'cycles'</span>,<span class=\"w\"> </span>Event<span class=\"w\"> </span>count<span class=\"w\"> </span><span class=\"o\">(</span>approx.<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">21853956752</span>\nOverhead<span class=\"w\">  </span>Command<span class=\"w\">          </span>Shared<span class=\"w\"> </span>Object<span class=\"w\">      </span>Symbol\n<span class=\"w\">  </span><span class=\"m\">99</span>.87%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span>jitted-93855-1.so<span class=\"w\">  </span><span class=\"o\">[</span>.<span class=\"o\">]</span><span class=\"w\"> </span>wasm<span class=\"o\">[</span><span class=\"m\">0</span><span class=\"o\">]</span>::function<span class=\"o\">[</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\">                                                                                           </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>tokio-runtime-w<span class=\"w\">  </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>__mod_memcg_lruvec_state<span class=\"w\">                                                                                       </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span>ld-2.31.so<span class=\"w\">         </span><span class=\"o\">[</span>.<span class=\"o\">]</span><span class=\"w\"> </span>_dl_relocate_object<span class=\"w\">                                                                                            </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.02%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>__do_fault<span class=\"w\">                                                                                                     </span>▒\n<span class=\"w\">   </span><span class=\"m\">0</span>.01%<span class=\"w\">  </span>wasmtime<span class=\"w\">         </span><span class=\"o\">[</span>kernel.kallsyms<span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span>k<span class=\"o\">]</span><span class=\"w\"> </span>pmd_page_vaddr<span class=\"w\">                                                                                                 </span>▒\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># the commands to profile</span>\nperf<span class=\"w\"> </span>record<span class=\"w\"> </span>-k<span class=\"w\"> </span>mono<span class=\"w\"> </span>~/wasmtime/target/release/wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--profile<span class=\"w\"> </span>jitdump<span class=\"w\"> </span>--allow-precompiled<span class=\"w\"> </span>bad.cwasm\nperf<span class=\"w\"> </span>inject<span class=\"w\"> </span>--jit<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.data<span class=\"w\"> </span>--output<span class=\"w\"> </span>perf.jit.data\nperf<span class=\"w\"> </span>report<span class=\"w\"> </span>--input<span class=\"w\"> </span>perf.jit.data<span class=\"w\"> </span>--no-children\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<ul>\n<li>Wasmtime version or commit: d0cf46a098d97bab9</li>\n<li>Operating system: Linux ringzzz-OptiPlex-7070 5.15.0-97-generic</li>\n<li>Architecture: Intel(R) Core(TM) i5-9500T CPU @ 2.20GHz<br>\n</li>\n</ul>\n</blockquote>",
        "id": 438826201,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715785724
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624#issuecomment-2112911340\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624\">issue #8624</a>:</p>\n<blockquote>\n<p>Locally on Intel(R) Core(TM) i9-14900K I get 0.9s on bad.wasm and 0.74s on good.wasm</p>\n<p>Profiling good.wasm the hot loop is, according to <code>perf</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\"> </span><span class=\"n\">d5</span>:<span class=\"err\">┌─→</span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">r10d</span><span class=\"w\">                                                                                                                                                                                                                                                                                             </span><span class=\"err\">▒</span>\n<span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">│</span><span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\">    </span><span class=\"cp\">$</span><span class=\"mh\">0x1</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r13d</span><span class=\"w\">                                                                                                                                                                                                                                                                                               </span><span class=\"err\">▒</span>\n<span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">├──</span><span class=\"n\">test</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">r13d</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r13d</span><span class=\"w\">                                                                                                                                                                                                                                                                                              </span><span class=\"err\">▒</span>\n<span class=\"mf\">100.00</span><span class=\"w\"> </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">└──</span><span class=\"n\">jne</span><span class=\"w\">    </span><span class=\"n\">d5</span><span class=\"w\">                                                                                                                                                                                                                                                                                                       </span><span class=\"err\">▒</span>\n</code></pre></div>\n<p>For <code>bad.wasm</code> it's</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\"> </span><span class=\"n\">c5</span>:<span class=\"err\">┌─→</span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rbx</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">r10d</span><span class=\"w\">                                                                                                                                                                                                                                                                                             </span><span class=\"err\">▒</span>\n<span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">│</span><span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"w\">                                                                                                                                                                                                                                                                                              </span><span class=\"err\">▒</span>\n<span class=\"w\">  </span><span class=\"mf\">0.09</span><span class=\"w\"> </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">│</span><span class=\"w\">  </span><span class=\"n\">lea</span><span class=\"w\">    </span><span class=\"mh\">0x1</span><span class=\"p\">(</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">),</span><span class=\"o\">%</span><span class=\"n\">r10d</span><span class=\"w\">                                                                                                                                                                                                                                                                                          </span><span class=\"err\">▒</span>\n<span class=\"w\"> </span><span class=\"mf\">55.32</span><span class=\"w\"> </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">│</span><span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\">   </span><span class=\"o\">%</span><span class=\"n\">r10d</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">r10d</span><span class=\"w\">                                                                                                                                                                                                                                                                                              </span><span class=\"err\">▒</span>\n<span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">│↓</span><span class=\"w\"> </span><span class=\"n\">je</span><span class=\"w\">     </span><span class=\"n\">e5</span><span class=\"w\">                                                                                                                                                                                                                                                                                                       </span><span class=\"err\">▒</span>\n<span class=\"w\">  </span><span class=\"mf\">0.06</span><span class=\"w\"> </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">│</span><span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">r10</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"w\">                                                                                                                                                                                                                                                                                                </span><span class=\"err\">▒</span>\n<span class=\"w\">  </span><span class=\"mf\">0.03</span><span class=\"w\"> </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">│</span><span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">rcx</span><span class=\"p\">,(</span><span class=\"o\">%</span><span class=\"n\">rsp</span><span class=\"p\">)</span><span class=\"w\">                                                                                                                                                                                                                                                                                              </span><span class=\"err\">▒</span>\n<span class=\"w\"> </span><span class=\"mf\">44.51</span><span class=\"w\"> </span><span class=\"err\">│</span><span class=\"w\">    </span><span class=\"err\">└──</span><span class=\"n\">jmp</span><span class=\"w\">    </span><span class=\"n\">c5</span><span class=\"w\">                                                                                                                                                                                                                                                                                                       </span><span class=\"err\">▒</span>\n<span class=\"w\">       </span><span class=\"err\">│</span><span class=\"w\"> </span><span class=\"n\">e5</span>:   <span class=\"nc\">xor</span><span class=\"w\">    </span><span class=\"o\">%</span><span class=\"n\">edi</span><span class=\"p\">,</span><span class=\"o\">%</span><span class=\"n\">edi</span><span class=\"w\">                                                                                                                                                                                                                                                                                                </span><span class=\"err\">▒</span>\n</code></pre></div>\n<p>I believe WasmEdge is an LLVM-based backend so it probably unrolls this loop or something similar. </p>\n</blockquote>",
        "id": 438835371,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715788320
    },
    {
        "content": "<p>hungryzzz <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624#issuecomment-2115478225\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624\">issue #8624</a>:</p>\n<blockquote>\n<p>I find that there is not difference between the binary generated by <code>WasmEdge</code> before and after changes, so I think maybe the block which contains the small changes is optimized (eliminated) during code generation in LLVM.</p>\n</blockquote>",
        "id": 439040047,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715871397
    },
    {
        "content": "<p>hungryzzz edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624#issuecomment-2115478225\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624\">issue #8624</a>:</p>\n<blockquote>\n<p>I find that there is not difference between the binary generated by <code>WasmEdge</code> before and after changes, so I think maybe the block which contains the small changes is optimized (eliminated) during code generation in LLVM.</p>\n<p>So maybe the performance decreasing in <code>Wasmtime</code> is caused by the newly generated instructions in loop, but I am still surprised that only the small changes in machine code can make more than 5 times performance impact...</p>\n</blockquote>",
        "id": 439041058,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715871645
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624#issuecomment-2115819169\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8624\">issue #8624</a>:</p>\n<blockquote>\n<p>My guess is you're hitting micro-architectural limits or things like that. Basically various cliffs in the CPU in terms of performance where once you fall off the happy path it's both difficult to explain why and difficult to understand the effects. That's just my best guess though.</p>\n</blockquote>",
        "id": 439068080,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715880361
    }
]