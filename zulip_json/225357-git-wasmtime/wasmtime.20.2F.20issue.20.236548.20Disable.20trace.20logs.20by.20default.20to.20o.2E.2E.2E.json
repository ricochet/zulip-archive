[
    {
        "content": "<p>TimonPost opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6548\">issue #6548</a>:</p>\n<blockquote>\n<p>There has been a performance regression for module compilation. The PR #5382 added the <code>trace-log</code> feature by default (<a href=\"https://github.com/bytecodealliance/wasmtime/pull/5382/files#diff-3a16b8de8e683460bef7c9ef4c6b2d0ec0e15efb8b404eef3a848742ce8625f4L45\">this line</a>)</p>\n<p>Historically high-frequent trace logs have been a performance bottleneck. Some efforts were made to revert that (#4481, #4484, #2758). In #4484 @bnjbvr added this feature flag, claiming perf increment of 32%, whereafter this flag was enabled by default in #5382.</p>\n<p>The following numbers are from sampling the app once before and after with the macos instruments profiler.</p>\n<p>The module compilation code takes in total 29.5 sec, of that three log functions here take up ~13 secs in total (43% of total). </p>\n<p>![image](<a href=\"https://github.com/bytecodealliance/wasmtime/assets/19969910/55794c87-7315-4f33-9b07-2bb05aa5e015\">https://github.com/bytecodealliance/wasmtime/assets/19969910/55794c87-7315-4f33-9b07-2bb05aa5e015</a>)</p>\n<p>Disabling trace logs results in total 10.3s, which is roughly ~65% faster.</p>\n<p>&lt;img width=\"1332\" alt=\"image\" src=\"<a href=\"https://github.com/bytecodealliance/wasmtime/assets/19969910/4636be43-e9c7-4013-84a8-242f9f17ab22\">https://github.com/bytecodealliance/wasmtime/assets/19969910/4636be43-e9c7-4013-84a8-242f9f17ab22</a>\"&gt;</p>\n<h4>Feature</h4>\n<p>We probably want to disable 'trace-log' by default as shown this takes ~60% of the total module compilation. Also we likely want to expose upstream control over this feature.</p>\n<h4>Benefit</h4>\n<p>Speeds up compilation by 60% :). </p>\n<h4>Implementation</h4>\n<ul>\n<li>Remove the <code>trace-log</code> feature from the default features array in <code>codegen</code>.</li>\n<li>Add <code>trace-log</code> feature to various crates that depend on <code>codegen</code>, and from those crates expose the ability to 'enable' trace logs as opt in.</li>\n<li>Also expose this feature for <code>wasmtime</code> crate so that we can decide on enabling/disabling logs. </li>\n</ul>\n<h4>Details</h4>\n<ul>\n<li>Macos 13.0.1, Apple M1 Max</li>\n<li>Precompiled Wasm module is roughly 400MB</li>\n</ul>\n</blockquote>",
        "id": 364911558,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1686328557
    },
    {
        "content": "<p>TimonPost edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6548\">issue #6548</a>:</p>\n<blockquote>\n<p>There has been a performance regression for module compilation. The PR #5382 added the <code>trace-log</code> feature by default (<a href=\"https://github.com/bytecodealliance/wasmtime/pull/5382/files#diff-3a16b8de8e683460bef7c9ef4c6b2d0ec0e15efb8b404eef3a848742ce8625f4L45\">this line</a>)</p>\n<p>Historically high-frequent trace logs have been a performance bottleneck. Some efforts were made to revert that (#4481, #4484, #2758). In #4484 @bnjbvr added this feature flag, claiming perf increment of 32%, whereafter this flag was enabled by default in #5382.</p>\n<p>The following numbers are from sampling the app once before and after with the macos instruments profiler.</p>\n<p>The module compilation code takes in total 29.5 sec, of that three log functions here take up ~13 secs in total (43% of total). </p>\n<p>![image](<a href=\"https://github.com/bytecodealliance/wasmtime/assets/19969910/55794c87-7315-4f33-9b07-2bb05aa5e015\">https://github.com/bytecodealliance/wasmtime/assets/19969910/55794c87-7315-4f33-9b07-2bb05aa5e015</a>)</p>\n<p>Disabling trace logs results in total 10.3s, which is roughly ~65% faster.</p>\n<p>&lt;img width=\"1332\" alt=\"image\" src=\"<a href=\"https://github.com/bytecodealliance/wasmtime/assets/19969910/4636be43-e9c7-4013-84a8-242f9f17ab22\">https://github.com/bytecodealliance/wasmtime/assets/19969910/4636be43-e9c7-4013-84a8-242f9f17ab22</a>\"&gt;</p>\n<p>Branch for this instrumentation can be found here: <a href=\"https://github.com/bytecodealliance/wasmtime/compare/main...TimonPost:wasmtime:timon/make-trace-logs-not-default?expand=1\">https://github.com/bytecodealliance/wasmtime/compare/main...TimonPost:wasmtime:timon/make-trace-logs-not-default?expand=1</a></p>\n<h4>Feature</h4>\n<p>We probably want to disable 'trace-log' by default as shown this takes ~60% of the total module compilation. Also we likely want to expose upstream control over this feature.</p>\n<h4>Benefit</h4>\n<p>Speeds up compilation by 60% :). </p>\n<h4>Implementation</h4>\n<ul>\n<li>Remove the <code>trace-log</code> feature from the default features array in <code>codegen</code>.</li>\n<li>Add <code>trace-log</code> feature to various crates that depend on <code>codegen</code>, and from those crates expose the ability to 'enable' trace logs as opt in.</li>\n<li>Also expose this feature for <code>wasmtime</code> crate so that we can decide on enabling/disabling logs. </li>\n</ul>\n<h4>Details</h4>\n<ul>\n<li>Macos 13.0.1, Apple M1 Max</li>\n<li>Precompiled Wasm module is roughly 400MB</li>\n</ul>\n</blockquote>",
        "id": 364912439,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1686328765
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6548#issuecomment-1584890660\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6548\">issue #6548</a>:</p>\n<blockquote>\n<p>I think this was just an accident, so I've opened #6549 as the minimal fix. It would be nice to also add trace-log features to other crates which enable the feature in cranelift-codegen, but I don't think it's immediately necessary.</p>\n</blockquote>",
        "id": 364917704,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1686330006
    },
    {
        "content": "<p>repi <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6548#issuecomment-1584922626\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6548\">issue #6548</a>:</p>\n<blockquote>\n<p>Thanks that minimal fix improves compilation speed for our big model on my machine from 7.0 s -&gt; 5.55s <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> which is very significant and about what we saw last time when we implemented the feature flag for excluding the heavy trace log statements.</p>\n</blockquote>",
        "id": 364924962,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1686331813
    },
    {
        "content": "<p>jameysharp closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/6548\">issue #6548</a>:</p>\n<blockquote>\n<p>There has been a performance regression for module compilation. The PR #5382 added the <code>trace-log</code> feature by default (<a href=\"https://github.com/bytecodealliance/wasmtime/pull/5382/files#diff-3a16b8de8e683460bef7c9ef4c6b2d0ec0e15efb8b404eef3a848742ce8625f4L45\">this line</a>)</p>\n<p>Historically high-frequent trace logs have been a performance bottleneck. Some efforts were made to revert that (#4481, #4484, #2758). In #4484 @bnjbvr added this feature flag, claiming perf increment of 32%, whereafter this flag was enabled by default in #5382.</p>\n<p>The following numbers are from sampling the app once before and after with the macos instruments profiler.</p>\n<p>The module compilation code takes in total 29.5 sec, of that three log functions here take up ~13 secs in total (43% of total). </p>\n<p>![image](<a href=\"https://github.com/bytecodealliance/wasmtime/assets/19969910/55794c87-7315-4f33-9b07-2bb05aa5e015\">https://github.com/bytecodealliance/wasmtime/assets/19969910/55794c87-7315-4f33-9b07-2bb05aa5e015</a>)</p>\n<p>Disabling trace logs results in total 10.3s, which is roughly ~65% faster.</p>\n<p>&lt;img width=\"1332\" alt=\"image\" src=\"<a href=\"https://github.com/bytecodealliance/wasmtime/assets/19969910/4636be43-e9c7-4013-84a8-242f9f17ab22\">https://github.com/bytecodealliance/wasmtime/assets/19969910/4636be43-e9c7-4013-84a8-242f9f17ab22</a>\"&gt;</p>\n<p>Branch for this instrumentation can be found here: <a href=\"https://github.com/bytecodealliance/wasmtime/compare/main...TimonPost:wasmtime:timon/make-trace-logs-not-default?expand=1\">https://github.com/bytecodealliance/wasmtime/compare/main...TimonPost:wasmtime:timon/make-trace-logs-not-default?expand=1</a></p>\n<h4>Feature</h4>\n<p>We probably want to disable 'trace-log' by default as shown this takes ~60% of the total module compilation. Also we likely want to expose upstream control over this feature.</p>\n<h4>Benefit</h4>\n<p>Speeds up compilation by 60% :). </p>\n<h4>Implementation</h4>\n<ul>\n<li>Remove the <code>trace-log</code> feature from the default features array in <code>codegen</code>.</li>\n<li>Add <code>trace-log</code> feature to various crates that depend on <code>codegen</code>, and from those crates expose the ability to 'enable' trace logs as opt in.</li>\n<li>Also expose this feature for <code>wasmtime</code> crate so that we can decide on enabling/disabling logs. </li>\n</ul>\n<h4>Details</h4>\n<ul>\n<li>Macos 13.0.1, Apple M1 Max</li>\n<li>Precompiled Wasm module is roughly 400MB</li>\n</ul>\n</blockquote>",
        "id": 364938512,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1686335324
    }
]