[
    {
        "content": "<p>ShuyaoJiang opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733\">issue #7733</a>:</p>\n<blockquote>\n<h3>Summary</h3>\n<p>Hi, I ran the attached case (C program, compiled to Wasm by <code>Emscripten</code>) in different Wasm runtimes, and found abnormal performance in <code>Wasmtime</code> compared with other runtimes. The execution time of this case (time interval from the start to the end of the execution of Wasm bytecode running command) on different runtimes is as follows:</p>\n<ul>\n<li>Wasmtime: 129ms</li>\n<li>WasmEdge (AOT): 15ms</li>\n<li>WAMR (AOT): 11ms</li>\n</ul>\n<p>We found that in most other test cases, Wasmtime can achieve similar performance (1-2x) with the other two runtimes. However, in this case, Wasmtime is about 10x slower than the other two runtimes.</p>\n<h4>Emscripten</h4>\n<ul>\n<li>emcc (Emscripten gcc/clang-like replacement + linker emulating GNU ld) 3.1.49 (04a0cad4d4c9f5d62876821274d78cd0a52427af)<br>\nclang version 18.0.0 (<a href=\"https://github.com/llvm/llvm-project\">https://github.com/llvm/llvm-project</a> 269685545e439ad050b67740533c59f965cae955)<br>\nTarget: wasm32-unknown-emscripten<br>\nThread model: posix</li>\n</ul>\n<h4>Wasm Runtime Version</h4>\n<ul>\n<li>Wasmtime: cli 15.0.0</li>\n<li>WasmEdge: 0.13.5</li>\n<li>WAMR: 1.2.3</li>\n</ul>\n<h4>Hardware &amp; OS</h4>\n<ul>\n<li>CPU: Intel(R) Xeon(R) E5-2686 v4 CPU @ 2.30GHz</li>\n<li>Memory: 16GB</li>\n<li>OS: Ubuntu 20.04.6 LTS</li>\n</ul>\n<h3>Additional details</h3>\n<p>The attached source program is synthesized by a <a href=\"https://github.com/csmith-project/csmith\">Csmith</a> seed and a code snippet from another program. The inserted code snippet is on lines <code>2386-2388</code> of the source program, which is an increment operation in nested loops. So, we think that this abnormal performance may be caused by this operation. Could you please check this situation? Thank you!</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/files/13787423/1702317926850.zip\">1702317926850.zip</a></p>\n</blockquote>",
        "id": 410304357,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1703775190
    },
    {
        "content": "<p>tschneidereit <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733#issuecomment-1871371667\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733\">issue #7733</a>:</p>\n<blockquote>\n<p>Hi @ShuyaoJiang, thank you for filing this and the other performance issues, much appreciated!</p>\n<p>Would it be possible to also share (for this and the other issues you filed) the exact commands you used to compile the code, and also to execute the resulting <code>.wasm</code> file in all of the runtimes? That'd greatly help us in investigating what's going on.</p>\n</blockquote>",
        "id": 410323525,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1703785192
    },
    {
        "content": "<p>ShuyaoJiang <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733#issuecomment-1871822050\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733\">issue #7733</a>:</p>\n<blockquote>\n<p>Hi, here are the commands I used:</p>\n<h4>Compile</h4>\n<ul>\n<li>Compile C to Wasm</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">emcc</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">O2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">WASM</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">TOTAL_MEMORY</span><span class=\"o\">=</span><span class=\"mi\">512</span><span class=\"n\">MB</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">I</span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"n\">csmith</span><span class=\"o\">/</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">C_PROGRAM</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASM_TARGET</span><span class=\"o\">&gt;</span>\n</code></pre></div>\n<ul>\n<li>Build AOT targets for <code>WasmEdge</code> and <code>WAMR</code></li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">wasmedge</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">wasmedgec</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASM_TARGET</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASMEDGE_AOT_TARGET</span><span class=\"p\">(.</span><span class=\"n\">wasm</span><span class=\"p\">)</span><span class=\"o\">&gt;</span>\n<span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">micro</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">wamr</span><span class=\"o\">-</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">wamrc</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WAMR_AOT_TARGET</span><span class=\"p\">(.</span><span class=\"n\">aot</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASM_TARGET</span><span class=\"o\">&gt;</span>\n</code></pre></div>\n<h4>Execute <code>.wasm</code> file (the execution time is collected in this phase)</h4>\n<ul>\n<li>Wasmtime</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASM_TARGET</span><span class=\"o\">&gt;</span>\n</code></pre></div>\n<ul>\n<li>Wasmer</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">wasmer</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">wasmer</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASM_TARGET</span><span class=\"o\">&gt;</span>\n</code></pre></div>\n<ul>\n<li>WasmEdge (AOT)</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"p\">.</span><span class=\"n\">wasmedge</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">wasmedge</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASMEDGE_AOT_TARGET</span><span class=\"p\">(.</span><span class=\"n\">wasm</span><span class=\"p\">)</span><span class=\"o\">&gt;</span>\n</code></pre></div>\n<ul>\n<li>WAMR (AOT)</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">ubuntu</span><span class=\"o\">/</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">micro</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">product</span><span class=\"o\">-</span><span class=\"n\">mini</span><span class=\"o\">/</span><span class=\"n\">platforms</span><span class=\"o\">/</span><span class=\"n\">linux</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">iwasm</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WAMR_AOT_TARGET</span><span class=\"p\">(.</span><span class=\"n\">aot</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">WASM_TARGET</span><span class=\"o\">&gt;</span>\n</code></pre></div>\n</blockquote>",
        "id": 410402634,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1703836819
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733#issuecomment-1874477916\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733\">issue #7733</a>:</p>\n<blockquote>\n<p>This is measuring compilation time as well, you can separate the phases via</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">allow</span><span class=\"o\">-</span><span class=\"n\">precompiled</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">cwasm</span>\n</code></pre></div>\n<p>When you separate the compilation and execution phases are you still seeing Wasmtime as 10x slower?</p>\n</blockquote>",
        "id": 410897450,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1704225214
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733#issuecomment-1912759654\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7733\">issue #7733</a>:</p>\n<blockquote>\n<p>Ok I've dug into this in the same manner as <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7732#issuecomment-1909132554\">https://github.com/bytecodealliance/wasmtime/issues/7732#issuecomment-1909132554</a> and I've at least locally confirmed that v8 takes ~2ms to execute this file and Wasmtime takes ~350us. In that sense I suspect that the 100ms+ times reported in the OP were probably including the compilation time for the module. </p>\n<p>I'm hesitant to go ahead and close this to ensure you can confirm that when separating out the compilation phase you get expected timings, however.</p>\n</blockquote>",
        "id": 418357840,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1706306901
    }
]