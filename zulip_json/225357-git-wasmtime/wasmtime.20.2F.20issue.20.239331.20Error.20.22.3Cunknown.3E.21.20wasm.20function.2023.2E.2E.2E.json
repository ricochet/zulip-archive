[
    {
        "content": "<p>nerdachse edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9331\">issue #9331</a>:</p>\n<blockquote>\n<p>I am experimenting with a <code>wasmtime</code> powered plugin system.</p>\n<p>So far everything works like a charm. Thanks a bunch for your awesome work!</p>\n<p>I am using the component model, wasmtime-wasi in an async fashion!</p>\n<p>Now inside a plugin/component I do this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">OnRequestGuest</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">onwsrequest</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">String</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"n\">NAME</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"fm\">format!</span><span class=\"p\">(</span><span class=\"s\">\"A received a message from host: {msg}\"</span><span class=\"p\">));</span>\n<span class=\"w\">        </span><span class=\"c1\">//publish(\"thanks_for_watching\");</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">onrequest</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Request</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Response</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">Request</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">head</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Parts</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">uri</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">method</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<span class=\"w\">            </span><span class=\"o\">..</span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"fm\">format!</span><span class=\"p\">(</span><span class=\"s\">\"Thanks for your call to {uri} via {method}!\"</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">html</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">leptos</span><span class=\"p\">::</span><span class=\"n\">ssr</span><span class=\"p\">::</span><span class=\"n\">render_to_string</span><span class=\"p\">(</span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">view</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"n\">h1</span><span class=\"o\">&gt;</span><span class=\"p\">{</span><span class=\"n\">h1</span><span class=\"p\">}</span><span class=\"o\">&lt;/</span><span class=\"n\">h1</span><span class=\"o\">&gt;</span>\n<span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"n\">p</span><span class=\"o\">&gt;</span><span class=\"s\">\"This site was built with leptos and love!\"</span><span class=\"o\">&lt;/</span><span class=\"n\">p</span><span class=\"o\">&gt;</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">});</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">build_response</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"n\">uri</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">(),</span>\n<span class=\"w\">            </span><span class=\"n\">method</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">(),</span>\n<span class=\"w\">            </span><span class=\"fm\">vec!</span><span class=\"p\">[],</span>\n<span class=\"w\">            </span><span class=\"n\">html</span><span class=\"p\">.</span><span class=\"n\">as_bytes</span><span class=\"p\">().</span><span class=\"n\">to_vec</span><span class=\"p\">(),</span>\n<span class=\"w\">        </span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">html</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">leptos</span><span class=\"p\">::</span><span class=\"n\">ssr</span><span class=\"p\">::</span><span class=\"n\">render_to_string</span><span class=\"p\">(</span><span class=\"k\">move</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">view</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"n\">h1</span><span class=\"o\">&gt;</span><span class=\"n\">Welcome</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">Ladida</span><span class=\"o\">!&lt;/</span><span class=\"n\">h1</span><span class=\"o\">&gt;</span>\n<span class=\"w\">                </span><span class=\"o\">&lt;</span><span class=\"n\">p</span><span class=\"o\">&gt;</span><span class=\"n\">Here</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">future</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">forged</span><span class=\"o\">!&lt;/</span><span class=\"n\">p</span><span class=\"o\">&gt;</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">});</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">ladida</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">build_response</span><span class=\"p\">(</span><span class=\"n\">uri</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">method</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[],</span><span class=\"w\"> </span><span class=\"n\">html</span><span class=\"p\">.</span><span class=\"n\">as_bytes</span><span class=\"p\">().</span><span class=\"n\">to_vec</span><span class=\"p\">());</span>\n\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">router</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">matchit</span><span class=\"p\">::</span><span class=\"n\">Router</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"c1\">//router.insert(\"/\", root).unwrap();</span>\n<span class=\"w\">        </span><span class=\"n\">router</span><span class=\"p\">.</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"s\">\"/ladida\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ladida</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"c1\">//</span>\n<span class=\"w\">        </span><span class=\"c1\">//router.at(&amp;uri).unwrap().value.clone();</span>\n<span class=\"w\">        </span><span class=\"n\">root</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>As soon as I enable the line: </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">router</span><span class=\"p\">.</span><span class=\"n\">at</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">uri</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">value</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>it fails with </p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">29</span><span class=\"n\">T22</span><span class=\"p\">:</span><span class=\"mi\">32</span><span class=\"p\">:</span><span class=\"mf\">43.061351</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">ERROR</span><span class=\"w\"> </span><span class=\"n\">simple_host</span><span class=\"p\">::</span><span class=\"n\">pluginsystem</span><span class=\"p\">::</span><span class=\"n\">routes</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">An</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">occurred</span><span class=\"w\"> </span><span class=\"n\">during</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">onrequest</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"o\">@</span><span class=\"s\">\".../compiled_plugins_folder/my_plugin.wasm\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x1450c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">231</span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x13a02</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">208</span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x14b6f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">238</span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x14ae0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">237</span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0xda0e</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"mi\">5</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0xcc83</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"mi\">6</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x4b7c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">68</span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"mi\">7</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x96c0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">86</span><span class=\"o\">&gt;</span>\n<span class=\"w\"> </span><span class=\"err\">```</span>\n\n<span class=\"o\">**</span><span class=\"n\">when</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">host</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">my</span><span class=\"w\"> </span><span class=\"n\">usage</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">still</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">sync</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">another</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">saying</span><span class=\"w\"> </span><span class=\"n\">something</span><span class=\"w\"> </span><span class=\"n\">like</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Cannot</span><span class=\"w\"> </span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">runtime</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">runtime</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">usage</span><span class=\"w\"> </span><span class=\"n\">like</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">block_on</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">allowed</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">something</span><span class=\"w\"> </span><span class=\"n\">along</span><span class=\"w\"> </span><span class=\"n\">these</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"p\">.</span><span class=\"o\">**</span>\n\n<span class=\"n\">Can</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">explain</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">what</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"kr\">do</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">circumvent</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"o\">?</span>\n\n<span class=\"n\">Thank</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">very</span><span class=\"w\"> </span><span class=\"n\">much</span><span class=\"o\">!</span>\n<span class=\"o\">~~~</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 473497207,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1727649652
    },
    {
        "content": "<p>nerdachse edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9331\">issue #9331</a>:</p>\n<blockquote>\n<p>Nevermind, it was my error alone. Sorry for the noise!</p>\n</blockquote>",
        "id": 473498668,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1727650147
    },
    {
        "content": "<p>nerdachse closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/9331\">issue #9331</a>:</p>\n<blockquote>\n<p>Nevermind, it was my error alone. Sorry for the noise!</p>\n</blockquote>",
        "id": 473498673,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1727650149
    }
]