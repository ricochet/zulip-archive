[
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1423032999\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<p>This is the code necessary on cg_clif's side for this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">struct</span> <span class=\"nc\">MeasuremeProfiler</span><span class=\"p\">(</span><span class=\"n\">SelfProfilerRef</span><span class=\"p\">);</span>\n\n<span class=\"k\">struct</span> <span class=\"nc\">TimingGuard</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">profiler</span>: <span class=\"nc\">std</span>::<span class=\"n\">mem</span>::<span class=\"n\">ManuallyDrop</span><span class=\"o\">&lt;</span><span class=\"n\">SelfProfilerRef</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">inner</span>: <span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">rustc_data_structures</span>::<span class=\"n\">profiling</span>::<span class=\"n\">TimingGuard</span><span class=\"o\">&lt;'</span><span class=\"nb\">static</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"nb\">Drop</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">TimingGuard</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">drop</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">inner</span><span class=\"p\">.</span><span class=\"n\">take</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">std</span>::<span class=\"n\">mem</span>::<span class=\"n\">ManuallyDrop</span>::<span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">profiler</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span>::<span class=\"n\">timing</span>::<span class=\"n\">Profiler</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MeasuremeProfiler</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">start_pass</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">pass</span>: <span class=\"nc\">cranelift_codegen</span>::<span class=\"n\">timing</span>::<span class=\"n\">Pass</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">any</span>::<span class=\"n\">Any</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">timing_guard</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TimingGuard</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">profiler</span>: <span class=\"nc\">std</span>::<span class=\"n\">mem</span>::<span class=\"n\">ManuallyDrop</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">clone</span><span class=\"p\">()),</span>\n<span class=\"w\">            </span><span class=\"n\">inner</span>: <span class=\"nb\">None</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">};</span>\n<span class=\"w\">        </span><span class=\"n\">timing_guard</span><span class=\"p\">.</span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"o\">&amp;*</span><span class=\"p\">(</span><span class=\"o\">&amp;*</span><span class=\"n\">timing_guard</span><span class=\"p\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">SelfProfilerRef</span>\n<span class=\"w\">                    </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">SelfProfilerRef</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">generic_activity</span><span class=\"p\">(</span><span class=\"n\">pass</span><span class=\"p\">.</span><span class=\"n\">description</span><span class=\"p\">()),</span>\n<span class=\"w\">        </span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">timing_guard</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">cranelift_codegen</span>::<span class=\"n\">timing</span>::<span class=\"n\">set_thread_profiler</span><span class=\"p\">(</span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">MeasuremeProfiler</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">cx</span><span class=\"p\">.</span><span class=\"n\">profiler</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">(),</span>\n<span class=\"p\">)));</span>\n</code></pre></div>\n<p>Most of it deals with a lifetime issue on measureme's side.</p>\n</blockquote>",
        "id": 326652855,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675879534
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1423035705\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<p>Measureme also supports outputting chrome profiler profiles, but chrome's profiler seems to suffer from float rounding errors causing some issues.</p>\n</blockquote>",
        "id": 326653236,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675879647
    },
    {
        "content": "<p>bjorn3 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1423035705\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<p>Measureme also supports outputting chrome profiler profiles, but chrome's profiler seems to suffer from float rounding errors causing some issues for very short passes.</p>\n</blockquote>",
        "id": 326653288,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675879661
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1423086953\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<p>I've reviewed everything in this PR except the most important commit (\"Introduce a Profiler trait\"), which I want to take a little longer to think about. I think it's a good idea! I just want to dig into the details.</p>\n<p>Everything else I think is easy to approve: it's a bunch of good cleanups.</p>\n<p>If you'd like to split that one commit to a separate PR I'd be happy to merge the rest now and either I or somebody else will review the Profiler trait parts later. But it's also okay if you'd like to just wait for it to all be reviewed and merged at once.</p>\n<p>I'm not familiar with the measureme profiler. Is that something we could use in other Cranelift drivers like Wasmtime as well, or is it a module in rustc? I'd love to get flamegraphs like your demo for other uses of Cranelift as well.</p>\n</blockquote>",
        "id": 326661939,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675882265
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1423125854\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<blockquote>\n<p>If you'd like to split that one commit to a separate PR I'd be happy to merge the rest now and either I or somebody else will review the Profiler trait parts later. But it's also okay if you'd like to just wait for it to all be reviewed and merged at once.</p>\n</blockquote>\n<p>I'm fine with waiting until the entire PR is reviewed, but if you prefer a smaller PR I can split it out.</p>\n<blockquote>\n<p>I'm not familiar with the measureme profiler. Is that something we could use in other Cranelift drivers like Wasmtime as well, or is it a module in rustc? I'd love to get flamegraphs like your demo for other uses of Cranelift as well.</p>\n</blockquote>\n<p>See <a href=\"https://github.com/rust-lang/measureme/\">https://github.com/rust-lang/measureme/</a>. Having a measureme based profiler in Cranelift would be possible, but the <code>Profiler</code> interface is still necessary as it wouldn't be possible for Cranelift to use the exact same version of measureme as rustc without <code>#![feature(rustc_private)]</code>. Measureme is designed to be as low overhead as possible (the rustc benchmark suite runs with it enabled by default to allow for more detailed investigation.) It supports both wall time based and on x86 instruction based profiling. It supports both interval and instant events and allows extra metadata (like the name of the function being processed or the size of a compiled artifact).</p>\n</blockquote>",
        "id": 326667943,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1675884281
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1462841088\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<p>@jameysharp gentle ping</p>\n</blockquote>",
        "id": 340714640,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1678396867
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1462913725\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<p>Oh, I think you'll need to rebase before I can merge since the set of required CI jobs changed.</p>\n</blockquote>",
        "id": 340724925,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1678400788
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1463749642\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<p>Rebased</p>\n<blockquote>\n<p>If you feel like opening another PR to make that change I'd be happy to take it.</p>\n</blockquote>\n<p>Sure</p>\n</blockquote>",
        "id": 340849758,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1678452068
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749#issuecomment-1528768413\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/5749\">issue #5749</a>:</p>\n<blockquote>\n<p>cg_clif side of this implemented in <a href=\"https://github.com/bjorn3/rustc_codegen_cranelift/commit/ef07e8e60f994ec014d049a95591426fb92ebb79\">https://github.com/bjorn3/rustc_codegen_cranelift/commit/ef07e8e60f994ec014d049a95591426fb92ebb79</a></p>\n</blockquote>",
        "id": 354336801,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1682768254
    }
]