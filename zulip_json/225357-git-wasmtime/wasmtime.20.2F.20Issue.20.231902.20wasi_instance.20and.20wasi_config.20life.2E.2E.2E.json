[
    {
        "content": "<p>AlexEne opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>&lt;!-- Please try to describe precisely what you would like to do in<br>\nCranelift/Wasmtime and/or expect from it. You can answer the questions below if<br>\nthey're relevant and delete this text before submitting. Thanks for opening an<br>\nissue! --&gt;</p>\n<h4>Feature</h4>\n<p>&lt;!-- What is the feature or code improvement you would like to do in<br>\nCranelift/Wasmtime? --&gt;</p>\n<p>The example here <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c</a> isn't clear on what the correct lifetime management should be for the wasi_instance and wasi_config.</p>\n<p>When we link teh wasi_instance, dp we still need to delete it? </p>\n<p>What is the correct order to delete the wasi_instance and wasm_module_instance that was linked to the wasi_instance?</p>\n<p>Is it safe to call <code>wasi_config_delete(...)</code> after calling <code>wasi_instance_new</code>?</p>\n<h4>Benefit</h4>\n<p>&lt;!-- What is the value of adding this in Cranelift/Wasmtime? --&gt;<br>\nWould clarify the ownership for the C/C++ usage of the wasmtime API.</p>\n<h4>Implementation</h4>\n<p>&lt;!-- Do you have an implementation plan, and/or ideas for data structures or<br>\nalgorithms to use? --&gt;<br>\nI can probably amend the example if needed.</p>\n<h4>Alternatives</h4>\n<p>&lt;!-- Have you considered alternative implementations? If so, how are they<br>\nbetter or worse than your proposal? --&gt;<br>\nNone</p>\n</blockquote>",
        "id": 201384854,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592571220
    },
    {
        "content": "<p>AlexEne edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>&lt;!-- Please try to describe precisely what you would like to do in<br>\nCranelift/Wasmtime and/or expect from it. You can answer the questions below if<br>\nthey're relevant and delete this text before submitting. Thanks for opening an<br>\nissue! --&gt;</p>\n<h4>Feature</h4>\n<p>&lt;!-- What is the feature or code improvement you would like to do in<br>\nCranelift/Wasmtime? --&gt;</p>\n<p>The example here <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c</a> isn't clear on what the correct lifetime management should be for the wasi_instance and wasi_config.</p>\n<p>When we link the wasi_instance, do we still need to delete it? </p>\n<p>What is the correct order to delete the <code>wasi_instance</code> and <code>wasm_module_instance</code> that was linked to the wasi_instance?</p>\n<p>Is it safe to call <code>wasi_config_delete(...)</code> after calling <code>wasi_instance_new</code>?</p>\n<h4>Benefit</h4>\n<p>&lt;!-- What is the value of adding this in Cranelift/Wasmtime? --&gt;<br>\nWould clarify the ownership for the C/C++ usage of the wasmtime API.</p>\n<h4>Implementation</h4>\n<p>&lt;!-- Do you have an implementation plan, and/or ideas for data structures or<br>\nalgorithms to use? --&gt;<br>\nI can probably amend the example if needed.</p>\n<h4>Alternatives</h4>\n<p>&lt;!-- Have you considered alternative implementations? If so, how are they<br>\nbetter or worse than your proposal? --&gt;<br>\nNone</p>\n</blockquote>",
        "id": 201384960,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592571249
    },
    {
        "content": "<p>AlexEne <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-646620297\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>Also the linker probably needs to be deleted at some point too.</p>\n</blockquote>",
        "id": 201385102,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592571328
    },
    {
        "content": "<p>AlexEne edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-646620297\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>Also the linker probably needs to be deleted at some point too.</p>\n<p>This line needs to probably be deleted, tho I don't super understand how the module is instantiated, as we seem to miss a <code>wasmtime_instance_new</code> call.<br>\n<code>wasm_instance_t *instance = NULL;</code></p>\n</blockquote>",
        "id": 201387650,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592572529
    },
    {
        "content": "<p>AlexEne edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-646620297\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>Also the linker probably needs to be deleted at some point too.</p>\n<p>Another thing I found in that example is that this line needs to probably be deleted. <br>\nI don't super understand how the module is instantiated, as we seem to miss a <code>wasmtime_instance_new</code> call:<br>\n<code>wasm_instance_t *instance = NULL;</code></p>\n</blockquote>",
        "id": 201388546,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592572937
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-648330651\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>Thanks for the report! It's a good point that the documentation on this is pretty lax!</p>\n<p>Currently the memory management is that if you get an owned handle you must call delete on it to free its resources. Other than that you're free to delete your own personal handle for anything at any time. For example you can \"delete\" a <code>wasm_store_t</code> immediately after instantiation. Underlying resources won't get deallocated unless all references to the underlying resource go away. (aka everything is reference counted)</p>\n</blockquote>",
        "id": 201761679,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592935948
    },
    {
        "content": "<p>AlexEne <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-648419846\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>This makes lots of sense. Thanks for explaining this it makes it easier for C++/C users as it was unclear what to do in the case of a failure. E.g:</p>\n<div class=\"codehilite\"><pre><span></span><code>wasm_config_t* config = wasm_config_new();\nwasmtime_config_debug_info_set(config, true);\n\nengine = wasm_engine_new_with_config(config);\n</code></pre></div>\n\n\n<p>Initially I assumed that methods 'take\" ownership of data (e.g. <code>wasi_engine_new_with_config</code> would own the config from now on in the code above. I'm super glad it's not the case as it simplifies a lot for things for users of the API. Previously it wasn't clear what to do with config in case engine is returned null, was it de-allocated by the lib?, does it need to be de-allocated by the user of the lib? etc.</p>\n<p>I think one good next step is to go through the examples for C/C++ and call free on all things that have come from a <code>wasmtime_thing_new();</code>.  I can try raising a patch with that maybe in the following days if I get a chance.</p>\n<p>On the secondary point in this particular example here: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c</a>, I am not sure how it works as it doesn't call anything that returns a module <code>instance</code> as far as I could tell. <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83</a>  <br>\nLower we see a function called from a module, but it conflicts with previous examples (without WASI and a linker), that first need to instantiate a module before using a function exported from it. E.g: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/hello.c#L90\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/hello.c#L90</a> calls <code>wasmtime_instance_new</code>. It looks like in the wasi example there's a missing <code>wasmtime_linker_instantiate</code>.</p>\n<p>Is <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83\">this example</a> the correct way correct way of using the linker + wasi API? </p>\n</blockquote>",
        "id": 201782652,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592946139
    },
    {
        "content": "<p>AlexEne edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-648419846\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>This makes lots of sense. Thanks for explaining this it makes it easier for C++/C users as it was unclear what to do in the case of a failure. E.g:</p>\n<div class=\"codehilite\"><pre><span></span><code>wasm_config_t* config = wasm_config_new();\nwasmtime_config_debug_info_set(config, true);\n\nengine = wasm_engine_new_with_config(config);\n</code></pre></div>\n\n\n<p>Initially I assumed that methods 'take\" ownership of data (e.g. <code>wasi_engine_new_with_config</code> would own the config from now on in the code above. I'm super glad it's not the case as it simplifies a lot for things for users of the API. Previously it wasn't clear what to do with config in case engine is returned null, was it de-allocated by the lib?, does it need to be de-allocated by the user of the lib? etc. Now all that is clear!</p>\n<p>I think one good next step is to go through the examples for C/C++ and call free on all things that have come from a <code>wasmtime_thing_new();</code>.  I can try raising a patch with that maybe in the following days if I get a chance.</p>\n<p>On the secondary point in this particular example here: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c</a>, I am not sure how it works as it doesn't call anything that returns a module <code>instance</code> as far as I could tell. <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83</a>  <br>\nLower we see a function called from a module, but it conflicts with previous examples (without WASI and a linker), that first need to instantiate a module before using a function exported from it. E.g: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/hello.c#L90\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/hello.c#L90</a> calls <code>wasmtime_instance_new</code>. It looks like in the wasi example there's a missing <code>wasmtime_linker_instantiate</code>.</p>\n<p>Is <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83\">this example</a> the correct way correct way of using the linker + wasi API? </p>\n</blockquote>",
        "id": 201782704,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592946170
    },
    {
        "content": "<p>AlexEne edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-648419846\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>This makes lots of sense. Thanks for explaining this it makes it easier for C++/C users as it was unclear what to do in the case of a failure. E.g:</p>\n<div class=\"codehilite\"><pre><span></span><code>wasm_config_t* config = wasm_config_new();\nwasmtime_config_debug_info_set(config, true);\n\nengine = wasm_engine_new_with_config(config);\n</code></pre></div>\n\n\n<p>Initially I assumed that methods 'take\" ownership of data (e.g. <code>wasi_engine_new_with_config</code> would own the config from now on in the code above. I'm super glad it's not the case as it simplifies a lot for things for users of the API. Previously it wasn't clear what to do with config in case engine is returned null, was it de-allocated by the lib?, does it need to be de-allocated by the user of the lib? etc. Now all that is clear!</p>\n<p>I think one good next step is to go through the examples for C/C++ and call free on all things that have come from a <code>wasmtime_thing_new();</code>.  I can try raising a patch with that maybe in the following days if I get a chance.</p>\n<p>On the secondary point in this particular example here: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c</a>, I am not sure how it works as it doesn't call anything that returns a module <code>instance</code> as far as I could tell. <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83</a>  <br>\nLower we see a function called from a module, but it conflicts with previous examples (without WASI and a linker), that first need to instantiate a module before using a function exported from it. E.g: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/hello.c#L90\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/hello.c#L90</a> calls <code>wasmtime_instance_new</code>. It looks like in the wasi example there's a missing <code>wasmtime_linker_instantiate</code>.</p>\n<p>Is <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c#L83\">this example</a> the correct way correct way of using the linker + wasi lib? </p>\n</blockquote>",
        "id": 201784333,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592946936
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-648441075\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>Oh sorry so to clarify, the <code>own</code> annotation in <code>wasm.h</code> is the guide for when you own a piece of data. As a parameter it means you're given ownership to the function. In the case of <code>wasm_engine_new_with_config</code> that's actually one of the few APIs that takes ownership of the <code>config</code>. The function unconditionally takes ownership regardless of result value right now.</p>\n<p>(and to be clear all of this could be better documented)</p>\n<p>The examples <em>should</em> have all the appropriate <code>*_delete</code> calls and shouldn't leak memory, although something may have been missed!</p>\n<p>For the WASI example I don't think that it's survived refactorings too well, it looks indeed like <code>instance</code> is unused since <code>wasmtime_linker_get_default</code> is used to fetch the function to call. For WASI <code>wasmtime_linker_module</code> is implicitly instantiating the provided module.</p>\n</blockquote>",
        "id": 201786753,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592948176
    },
    {
        "content": "<p>AlexEne <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902#issuecomment-648462705\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>Alright, I think this solves all questions I had around it. Thanks for explaining it.<br>\nI will raise a small PR to the example delete the instance and add a few comments, but it doesn't need this issue to hang around so I can close it.</p>\n</blockquote>",
        "id": 201792398,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592951567
    },
    {
        "content": "<p>AlexEne closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/1902\">Issue #1902</a>:</p>\n<blockquote>\n<p>&lt;!-- Please try to describe precisely what you would like to do in<br>\nCranelift/Wasmtime and/or expect from it. You can answer the questions below if<br>\nthey're relevant and delete this text before submitting. Thanks for opening an<br>\nissue! --&gt;</p>\n<h4>Feature</h4>\n<p>&lt;!-- What is the feature or code improvement you would like to do in<br>\nCranelift/Wasmtime? --&gt;</p>\n<p>The example here <a href=\"https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c\">https://github.com/bytecodealliance/wasmtime/blob/master/examples/wasi/main.c</a> isn't clear on what the correct lifetime management should be for the wasi_instance and wasi_config.</p>\n<p>When we link the wasi_instance, do we still need to delete it? </p>\n<p>What is the correct order to delete the <code>wasi_instance</code> and <code>wasm_module_instance</code> that was linked to the wasi_instance?</p>\n<p>Is it safe to call <code>wasi_config_delete(...)</code> after calling <code>wasi_instance_new</code>?</p>\n<h4>Benefit</h4>\n<p>&lt;!-- What is the value of adding this in Cranelift/Wasmtime? --&gt;<br>\nWould clarify the ownership for the C/C++ usage of the wasmtime API.</p>\n<h4>Implementation</h4>\n<p>&lt;!-- Do you have an implementation plan, and/or ideas for data structures or<br>\nalgorithms to use? --&gt;<br>\nI can probably amend the example if needed.</p>\n<h4>Alternatives</h4>\n<p>&lt;!-- Have you considered alternative implementations? If so, how are they<br>\nbetter or worse than your proposal? --&gt;<br>\nNone</p>\n</blockquote>",
        "id": 201792399,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1592951567
    }
]