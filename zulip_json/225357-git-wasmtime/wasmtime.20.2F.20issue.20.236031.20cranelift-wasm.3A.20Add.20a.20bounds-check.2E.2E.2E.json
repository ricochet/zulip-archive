[
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031#issuecomment-1472624754\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031\">issue #6031</a>:</p>\n<blockquote>\n<p>FWIW: I looked over the wasm filetest changes pretty closely, but did not go over the ISA-specific versions of those same tests in much detail.</p>\n</blockquote>",
        "id": 342405234,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1678994933
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031#issuecomment-1472625315\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031\">issue #6031</a>:</p>\n<blockquote>\n<p>Going to gather sightglass numbers now...</p>\n</blockquote>",
        "id": 342405318,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1678994962
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031#issuecomment-1472643127\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031\">issue #6031</a>:</p>\n<blockquote>\n<p>Looks like this gives not just execution speed ups, but also compilation speed ups (presumably due to processing less IR):</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">sightglass</span><span class=\"w\"> </span><span class=\"n\">benchmark</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">engine</span><span class=\"o\">-</span><span class=\"n\">flags</span><span class=\"o\">=</span><span class=\"s\">\"--static-memory-maximum-size=0 --dynamic-memory-guard-size=65536\"</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">insts</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">default</span><span class=\"p\">.</span><span class=\"n\">suite</span>\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">354918771.70</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">209612.26</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.08</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.08</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">4757395008</span><span class=\"w\"> </span><span class=\"mf\">4757613072.90</span><span class=\"w\"> </span><span class=\"mi\">4757854325</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">4402584769</span><span class=\"w\"> </span><span class=\"mf\">4402694301.20</span><span class=\"w\"> </span><span class=\"mi\">4403032801</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2246146.90</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">322.54</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.07</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.07</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">35406698</span><span class=\"w\"> </span><span class=\"mf\">35406850.20</span><span class=\"w\"> </span><span class=\"mi\">35407505</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">33160532</span><span class=\"w\"> </span><span class=\"mf\">33160703.30</span><span class=\"w\"> </span><span class=\"mi\">33161229</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">20037307.30</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">5.37</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.05</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.05</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">402201103</span><span class=\"w\"> </span><span class=\"mf\">402201106.00</span><span class=\"w\"> </span><span class=\"mi\">402201111</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">382163791</span><span class=\"w\"> </span><span class=\"mf\">382163798.70</span><span class=\"w\"> </span><span class=\"mi\">382163803</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">compilation</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">80907.10</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">30178.64</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">9350309</span><span class=\"w\"> </span><span class=\"mf\">9389659.00</span><span class=\"w\"> </span><span class=\"mi\">9444444</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">9276889</span><span class=\"w\"> </span><span class=\"mf\">9308751.90</span><span class=\"w\"> </span><span class=\"mi\">9338252</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">compilation</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1534345.20</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">211755.93</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">218580786</span><span class=\"w\"> </span><span class=\"mf\">218834739.10</span><span class=\"w\"> </span><span class=\"mi\">219048529</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">216969499</span><span class=\"w\"> </span><span class=\"mf\">217300393.90</span><span class=\"w\"> </span><span class=\"mi\">217501790</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 342408375,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1678995912
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031#issuecomment-1472741602\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031\">issue #6031</a>:</p>\n<blockquote>\n<p>Hm ok well I also see now that a test failed with something that should trap which didn't, which means now that I missed something in review, so I'm much less confident in my review now.</p>\n</blockquote>",
        "id": 342422949,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1679000877
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031#issuecomment-1472782203\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031\">issue #6031</a>:</p>\n<blockquote>\n<p>Ah yeah after digging in I believe that's correct. The configuration requires dynamic memories to have a 64k guard page region but the pooling allocator in this configuration specifically isn't decommitting memory past the end to avoid syscalls, which means that there's actually no guard pages at all upon reinstantiation. That's ok with today's impelmentation of bounds checks which don't try to exploit the fact that the arithmetic can be simplified (e.g. this PR).</p>\n<p>This is a tough problem though because that was one of the assumptions about dynamic memory and the pooling allocator, that we could avoid decommitting memory and save on syscalls/contention. This is making me realize though that if we want to take advantage of guard pages on dynamic memories (which I suspect we do since it should help drastically simplify the complexity of analysis required to handle multiple bounds checks) then this optimization isn't possible.</p>\n<p>The offending lines I think are <a href=\"https://github.com/bytecodealliance/wasmtime/blob/5ae8575296d5b524cde42ad10badf8c89945105a/crates/runtime/src/cow.rs#L512-L528\">here</a> which those need to be executed unconditionally if the guard size for memory is more than 0 bytes, which I think is basically always.</p>\n</blockquote>",
        "id": 342427384,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1679002787
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031#issuecomment-1472811938\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/6031\">issue #6031</a>:</p>\n<blockquote>\n<blockquote>\n<p>The offending lines I think are <a href=\"https://github.com/bytecodealliance/wasmtime/blob/5ae8575296d5b524cde42ad10badf8c89945105a/crates/runtime/src/cow.rs#L512-L528\">here</a> which those need to be executed unconditionally if the guard size for memory is more than 0 bytes, which I think is basically always.</p>\n</blockquote>\n<p>Thanks! I was digging into the test but hadn't got that far before I was interrupted. Always nice when someone debugs the issue for you :)</p>\n</blockquote>",
        "id": 342430824,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1679004271
    }
]