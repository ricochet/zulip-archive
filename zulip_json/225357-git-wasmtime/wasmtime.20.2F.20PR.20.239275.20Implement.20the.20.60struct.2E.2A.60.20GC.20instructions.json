[
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/elliottt\">elliottt</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471135637,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726622103
    },
    {
        "content": "<p>fitzgen opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a> from <code>fitzgen:gc-struct-instructions</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This commit implements the <code>struct.*</code> instructions for the GC proposal.  These instructions allow allocating new structs and getting and setting their fields.</p>\n<p>The implemented instructions are:</p>\n<ul>\n<li><code>struct.new</code></li>\n<li><code>struct.new_default</code></li>\n<li><code>struct.get</code></li>\n<li><code>struct.get_s</code></li>\n<li><code>struct.get_u</code></li>\n<li><code>struct.set</code></li>\n</ul>\n<p>The <code>struct.new*</code> instructions are also allowed in constant expressions, but support for that is not yet implemented.</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 471135638,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726622103
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471135639,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726622103
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471135640,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726622103
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471135655,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726622115
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471137075,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726622856
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#issuecomment-2357390707\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"cranelift\", \"cranelift:wasm\", \"wasmtime:api\", \"wasmtime:ref-types\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>fitzgen: wasmtime:ref-types</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 471150078,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726628061
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764326506\">PR review comment</a>:</p>\n<blockquote>\n<p>TODO</p>\n</blockquote>",
        "id": 471152757,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2311515528\">PR review</a>:</p>\n<blockquote>\n<p>Nice progress! <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> </p>\n</blockquote>",
        "id": 471152758,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764327902\">PR review comment</a>:</p>\n<blockquote>\n<p>If you want I think it'd be fine to <code>pub use</code> the inner module up to here. That loses the \"type check\" that it's exactly the same signature with/without gc but I think that's ok given all the CI checks we have.</p>\n</blockquote>",
        "id": 471152759,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764329248\">PR review comment</a>:</p>\n<blockquote>\n<p>Another alternative would be a cranelift pass perhaps? Optimizing away <code>trapz</code> shouldn't be too too hard in theory for most simple cases. (I realize egraphs won't work for this at all, but we can always write a custom pass too)</p>\n</blockquote>",
        "id": 471152760,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764332544\">PR review comment</a>:</p>\n<blockquote>\n<p>Is <code>::trusted()</code> the right default here? I would have thought that this would be \"can possibly trap\" flags. We can stuff in a debug trap code which doesn't cause trap table information to get emitted but it should still hinder optimizations and such in Cranelift (which I think we want at least for now?)</p>\n</blockquote>",
        "id": 471152761,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764333637\">PR review comment</a>:</p>\n<blockquote>\n<p>This method may want to be refactored to return <code>(ir::Value, u32)</code> to enable optionally embedding the offset in the load/store instruction. For now it'd always return 0 but maybe a future refactoring to have to optimize this a bit in the future.</p>\n</blockquote>",
        "id": 471152762,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764328861\">PR review comment</a>:</p>\n<blockquote>\n<p>Another idea, if you're interested to cut down on the duplication here, change the spec trait to be like the component compiler where it has a method to return <code>fn gc_compiler(&amp;mut self) -&gt; Option&lt;&amp;mut dyn GcCompiler&gt;;</code> (in the cranelift-wasm crate) where the <code>GcCompiler</code> trait has all these struct translation methods. That way when gc is disabled you don't even need to impl <code>GcCompiler</code>, it just returns <code>None</code>, and only in the gc enabled case are there all the methods.</p>\n</blockquote>",
        "id": 471152763,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764335379\">PR review comment</a>:</p>\n<blockquote>\n<p>As a minor possible optimization (future PR) this should be pretty easy to optimize in the egraph pass to downgrade this to <code>iadd</code>. It's pretty obvious by construction that this can't overflow, along with many other patterns too.</p>\n<p>Whether it's worth it I'm not sure. Optimizing bounds checks is naturally going to be much more involved than just this b/c we want to rely on guard pages exclusively in theory.</p>\n</blockquote>",
        "id": 471152764,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764327336\">PR review comment</a>:</p>\n<blockquote>\n<p>Perhaps route these all to a shared definition of a function to avoid needing to duplicate the message?</p>\n</blockquote>",
        "id": 471152765,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629281
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1764335898\">PR review comment</a>:</p>\n<blockquote>\n<p>One idea for a future trick: we could unmap the lowest page of memory in the GC heap so address 0 in the gc heap translates to a fault. That way we could push this trap into an annotated trap code on the <code>MemFlags</code> on the load below (or store for <code>struct.set</code>) which means we could, by construction, completely eliminate this trap as well. </p>\n<p>(possibly all on top of a cranelift optimization pass to remove the checks entirely)</p>\n</blockquote>",
        "id": 471152766,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726629282
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313191313\">PR review</a>.</p>",
        "id": 471299394,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676203
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765353560\">PR review comment</a>:</p>\n<blockquote>\n<p>This is a good idea -- I'll do a follow up to cut down on the boilerplate but leave it as-is for this PR.</p>\n</blockquote>",
        "id": 471299396,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676203
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765357035\">PR review comment</a>:</p>\n<blockquote>\n<p>If it is a GC ref that this function allocated, or has already accessed, then we should be able to clean it up. In theory at least; in practice it might be a little tricky without introducing some new powers to the mid-end. But for an argument that we haven't accessed yet, then we can't really do anything without the type info, I don't think.</p>\n</blockquote>",
        "id": 471299854,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676335
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313196972\">PR review</a>.</p>",
        "id": 471299855,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676335
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313200383\">PR review</a>.</p>",
        "id": 471300237,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676436
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765360881\">PR review comment</a>:</p>\n<blockquote>\n<p>I think we actually don't want to hinder optimizations. These aren't visible to Wasm semantics, or at least the whole point is they shouldn't be, so if the optimizer can prove that a load is redundant or whatever then I think we should let it.</p>\n</blockquote>",
        "id": 471300238,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676436
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765362437\">PR review comment</a>:</p>\n<blockquote>\n<p>Yeah, I was also thinking it may want to take a <code>object_size: Option&lt;u32&gt;</code> argument as well to make bounds checks of repeated accesses dedupe-able by the mid-end. (Has to be an <code>Option</code> because we don't statically know array lengths).</p>\n</blockquote>",
        "id": 471300463,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676509
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313202860\">PR review</a>.</p>",
        "id": 471300464,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676510
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313206830\">PR review</a>.</p>",
        "id": 471300798,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676609
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765364540\">PR review comment</a>:</p>\n<blockquote>\n<p>But: simple, naive things first and we can clean up the code we generate in follow ups.</p>\n</blockquote>",
        "id": 471300801,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676609
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313214927\">PR review</a>.</p>",
        "id": 471301544,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676839
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765371333\">PR review comment</a>:</p>\n<blockquote>\n<p>Ideally we'd have a mid-end ISLE rule something like</p>\n<div class=\"codehilite\" data-code-language=\"Common Lisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nv\">rule</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">simplify</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">uadd_overflow_trap</span><span class=\"w\"> </span><span class=\"nv\">$i64</span><span class=\"w\"> </span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"nv\">y</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">if-let</span><span class=\"w\"> </span><span class=\"nv\">$true</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">add_cannot_overflow</span><span class=\"w\"> </span><span class=\"nv\">$I64</span><span class=\"w\"> </span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"nv\">y</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">iadd</span><span class=\"w\"> </span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"nv\">y</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>where <code>add_cannot_overflow</code> handles constants and <code>(uextend ...)</code>s and such.</p>\n<p>But because <code>uadd_overflow_trap</code> has side effects, we can't write such a rule in the mid-end today.</p>\n</blockquote>",
        "id": 471301545,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726676840
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#pullrequestreview-2313221037\">PR review</a>.</p>",
        "id": 471302124,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726677013
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275#discussion_r1765375045\">PR review comment</a>:</p>\n<blockquote>\n<p>We discussed this a bit in today's cranelift meeting. In summary, this is neat but kind of conflicts with our plans of eventually using linear memories to implement the GC heap, since the pooling allocator would have to allocate a linear memory for the GC heap, then unmap the first page, give it to Wasm until the instance is done, then remap the first page before returning it to the memory pool. This is all doable of course, but the extra special-case code paths are annoying and adding more virtual memory calls in the pooling allocator is always fraught perf-wise.</p>\n</blockquote>",
        "id": 471302126,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726677013
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471304482,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726677766
    },
    {
        "content": "<p>fitzgen has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471304501,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726677774
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471307330,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726678755
    },
    {
        "content": "<p>fitzgen merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/9275\">PR #9275</a>.</p>",
        "id": 471312128,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1726680421
    }
]