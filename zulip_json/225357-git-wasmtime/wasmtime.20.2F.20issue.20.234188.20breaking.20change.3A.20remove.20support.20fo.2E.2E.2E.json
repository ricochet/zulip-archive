[
    {
        "content": "<p>PureWhiteWu <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188#issuecomment-1137798447\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188\">issue #4188</a>:</p>\n<blockquote>\n<p>r? @alexcrichton </p>\n</blockquote>",
        "id": 283933989,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1653509143
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188#issuecomment-1137802713\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188\">issue #4188</a>:</p>\n<blockquote>\n<p>@PureWhiteWu thank you for this report!</p>\n<p>I agree that the current behavior is somewhat surprising and error-prone. The root issue seems to be that we have settings that silently update other settings as well. IMHO we should strive for the property that the order of calls to methods on <code>Config</code> doesn't matter.</p>\n<p>@alexcrichton Any thoughts on that invariant? I suspect there may be a way to achieve requirements like \"turning on reftypes enables safepoints under the hood\" in another way, by having a \"fixup phase\" when the <code>Config</code> is actually used. So basically, (i) setter methods each set an independent field, and no two methods touch overlapping state; then (ii) we \"legalize\" or \"fix up\" the config by, e.g., turning on safepoints unconditionally when reftypes are enabled, once the user hands us the config.</p>\n<p>I feel that a focus on the <code>strategy</code> in particular is somewhat tangential. It's one place where the above proposed invariant is violated, but there could be others (we should audit this). And FWIW, there are at least early talks to build some other \"strategies\" (a baseline compiler with linear time guarantees, at least) so at some point we would add it back if we removed it today. But, I'm not  totally firm on that and could be convinced to have it removed for now if that's the direction we go.</p>\n</blockquote>",
        "id": 283934502,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1653509441
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188#issuecomment-1137811166\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188\">issue #4188</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @peterhuene</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"wasmtime:api\", \"wasmtime:c-api\", \"wasmtime:config\", \"wasmtime:docs\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>peterhuene: wasmtime:api, wasmtime:c-api</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 283935555,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1653510037
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188#issuecomment-1137811291\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188\">issue #4188</a>:</p>\n<blockquote>\n<h4>Label Messager: wasmtime:config</h4>\n<p>It looks like you are changing Wasmtime's configuration options. Make sure to<br>\ncomplete this check list:</p>\n<ul>\n<li>\n<p>[ ] If you added a new <code>Config</code> method, you wrote extensive documentation for<br>\n      it.</p>\n<p>&lt;details&gt;</p>\n<p>Our documentation should be of the following form:</p>\n<p>```text<br>\nShort, simple summary sentence.</p>\n<p>More details. These details can be multiple paragraphs. There should be<br>\ninformation about not just the method, but its parameters and results as<br>\nwell.</p>\n<p>Is this method fallible? If so, when can it return an error?</p>\n<p>Can this method panic? If so, when does it panic?</p>\n<h1>Example</h1>\n<p>Optional example here.<br>\n```</p>\n<p>&lt;/details&gt;</p>\n</li>\n<li>\n<p>[ ] If you added a new <code>Config</code> method, or modified an existing one, you<br>\n  ensured that this configuration is exercised by the fuzz targets.</p>\n<p>&lt;details&gt;</p>\n<p>For example, if you expose a new strategy for allocating the next instance<br>\nslot inside the pooling allocator, you should ensure that at least one of our<br>\nfuzz targets exercises that new strategy.</p>\n<p>Often, all that is required of you is to ensure that there is a knob for this<br>\nconfiguration option in [<code>wasmtime_fuzzing::Config</code>][fuzzing-config] (or one<br>\nof its nested <code>struct</code>s).</p>\n<p>Rarely, this may require authoring a new fuzz target to specifically test this<br>\nconfiguration. See [our docs on fuzzing][fuzzing-docs] for more details.</p>\n<p>&lt;/details&gt;</p>\n</li>\n<li>\n<p>[ ] If you are enabling a configuration option by default, make sure that it<br>\n  has been fuzzed for at least two weeks before turning it on by default.</p>\n</li>\n</ul>\n<p>[fuzzing-config]: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194\">https://github.com/bytecodealliance/wasmtime/blob/ca0e8d0a1d8cefc0496dba2f77a670571d8fdcab/crates/fuzzing/src/generators.rs#L182-L194</a><br>\n[fuzzing-docs]: <a href=\"https://docs.wasmtime.dev/contributing-fuzzing.html\">https://docs.wasmtime.dev/contributing-fuzzing.html</a></p>\n<hr>\n<p>&lt;details&gt;</p>\n<p>To modify this label's message, edit the &lt;code&gt;.github/label-messager/wasmtime-config.md&lt;/code&gt; file.</p>\n<p>To add new label messages or remove existing label messages, edit the<br>\n&lt;code&gt;.github/label-messager.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/label-messager-action\">Learn more.</a></p>\n<p>&lt;/details&gt;</p>\n</blockquote>",
        "id": 283935570,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1653510047
    },
    {
        "content": "<p>PureWhiteWu <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188#issuecomment-1137818036\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188\">issue #4188</a>:</p>\n<blockquote>\n<p>@cfallin Thanks for your quick reply!<br>\nThe problem is not only about <code>reference_type</code> and <code>enable_safepoints</code>, there's also many other flags affected.</p>\n<p>Here's the log I got.</p>\n<p>The problematic version:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"n\">shared</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"n\">opt_level</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"speed\"</span><span class=\"w\"></span>\n<span class=\"n\">tls_model</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"none\"</span><span class=\"w\"></span>\n<span class=\"n\">libcall_call_conv</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"isa_default\"</span><span class=\"w\"></span>\n<span class=\"n\">baldrdash_prologue_words</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">probestack_size_log2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"></span>\n<span class=\"n\">regalloc_checker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_verifier</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">is_pic</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">use_colocated_libcalls</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">avoid_div_traps</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_float</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_nan_canonicalization</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_pinned_reg</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">use_pinned_reg_as_heap_base</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_simd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_atomics</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_safepoints</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_llvm_abi_extensions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">unwind_info</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">machine_code_cfg_info</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">emit_all_ones_funcaddrs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_probestack</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">probestack_func_adjusts_sp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_jump_tables</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_heap_access_spectre_mitigation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_table_access_spectre_mitigation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The correct version:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"n\">shared</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"n\">opt_level</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"speed\"</span><span class=\"w\"></span>\n<span class=\"n\">tls_model</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"none\"</span><span class=\"w\"></span>\n<span class=\"n\">libcall_call_conv</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"isa_default\"</span><span class=\"w\"></span>\n<span class=\"n\">baldrdash_prologue_words</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">probestack_size_log2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"></span>\n<span class=\"n\">regalloc_checker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_verifier</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">is_pic</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">use_colocated_libcalls</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">avoid_div_traps</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_float</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_nan_canonicalization</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_pinned_reg</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">use_pinned_reg_as_heap_base</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_simd</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_atomics</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_safepoints</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_llvm_abi_extensions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">unwind_info</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">machine_code_cfg_info</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">emit_all_ones_funcaddrs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_probestack</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">probestack_func_adjusts_sp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"></span>\n<span class=\"n\">enable_jump_tables</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_heap_access_spectre_mitigation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n<span class=\"n\">enable_table_access_spectre_mitigation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"></span>\n</code></pre></div>\n<p>And I think there's also other flags and isa_flags that may be affected by this, so it's not only about <code>reference_type</code>.</p>\n<blockquote>\n<p>by having a \"fixup phase\" when the Config is actually used</p>\n</blockquote>\n<p>In fact, I didn't find a easy way to achieve this, because <code>flags</code> and <code>isa_flags</code> are strongly associated with the compiler backend, so it's not easy to move it into <code>Config</code>.</p>\n<blockquote>\n<p>And FWIW, there are at least early talks to build some other \"strategies\" (a baseline compiler with linear time guarantees, at least) so at some point we would add it back if we removed it today.</p>\n</blockquote>\n<p>Firstly, maybe we could make this another config field instead of <code>strategy</code>, such as a <code>flag</code> field of <code>Cranelift</code>(if it's also based on <code>Cranelift</code> with some optimizations disabled)?<br>\nSecondly, I wonder for how long this will become a reality, and if this will take half a year or even a year to implement, I think leave the problem to that time is a better choice.</p>\n</blockquote>",
        "id": 283936570,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1653510578
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188#issuecomment-1137836596\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188\">issue #4188</a>:</p>\n<blockquote>\n<p>Maybe have Config::with_strategy and remove the strategy method?</p>\n</blockquote>",
        "id": 283938694,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1653511871
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188#issuecomment-1137854453\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188\">issue #4188</a>:</p>\n<blockquote>\n<p>To echo Chris thanks for bringing this up @PureWhiteWu! This has actually bit me many times in the past in one way or another so it's definitely something I'd like to see fixed. Additionally sorry for the breakage, it wasn't intended to be so impactful to validate runtime settings but in a sense I also think it's good to turn up bugs like this since this was something that needed fixing anyway.</p>\n<p>I would agree with everything Chris said as well. The intention of <code>Config</code> is that the order of method calls don't matter. Unfortunately as you can see <code>Config</code> has not stood the test of time well and it doesn't actually achieve this today. To highlight another location that breaks these invariants that's independent of <code>strategy</code>, the <code>Config::target</code> method will <a href=\"https://github.com/bytecodealliance/wasmtime/blob/bffce37050abb22e3f07583a9a695ac790236f91/crates/cranelift/src/builder.rs#L62-L65\">completely overwrite the ISA flags</a> which will remove some previously configured options, notably the cranelift settings.</p>\n<p>Overall I think that we should probably change all the methods of <code>Config</code> to be idempotent. To expand a bit on what Chris mentioned:</p>\n<ul>\n<li>When setting a field, no other fields should ever be modified (e.g. enabling reference types shouldn't enable bulk memory in the method)</li>\n<li>The <code>CompilerBuilder</code> trait should be entirely removed from <code>Config</code></li>\n<li>Remove all other \"state\" in <code>Config</code> that represents some sort of owned resource like <code>CacheConfig</code>, <code>ProfilingAgent</code>, etc. I don't think state like <code>RuntimeMemoryCreator</code> can be removed but that's ok.</li>\n<li>Defer all validation an inter-option relations to <code>Engine::new</code>. Here we would do the sanitization Chris mentioned where for example if reference types are enabled we'd enable unwind information and bulk memory. This would also be where we'd do things like load cache config, configure cranelift, etc.</li>\n</ul>\n<p>I think that would make it so the <code>strategy</code> option would still make sense (and we could add to it in the future with a baseline compiler). Additionaly it would fix preexisting issues around <code>target</code> and other inter-related fields. @PureWhiteWu would you be up for a refactoring like this? I'd be happy to help with any issues that arose. </p>\n</blockquote>",
        "id": 283941252,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1653513261
    },
    {
        "content": "<p>PureWhiteWu <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188#issuecomment-1138231254\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/4188\">issue #4188</a>:</p>\n<blockquote>\n<p>@alexcrichton Thanks for your instructions! I'm happy to have a try!</p>\n<p>I'll close this pr, since this seems isn't the right way to fix the problems.</p>\n<p>I've opened an issue for this #4189, and will submit a new pr asap.</p>\n</blockquote>",
        "id": 283976764,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1653548700
    }
]