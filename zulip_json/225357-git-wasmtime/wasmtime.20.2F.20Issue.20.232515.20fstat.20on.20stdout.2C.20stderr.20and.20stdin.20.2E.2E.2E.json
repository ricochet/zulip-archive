[
    {
        "content": "<p>abbec opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515\">Issue #2515</a>:</p>\n<blockquote>\n<p>I am using this program to test:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"cp\">#include</span> <span class=\"cpf\">&lt;stdio.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;stdlib.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;sys/stat.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;sys/types.h&gt;</span><span class=\"cp\"></span>\n\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;wasi/api.h&gt;</span><span class=\"cp\"></span>\n\n<span class=\"kt\">int</span> <span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"kt\">int</span> <span class=\"n\">argc</span><span class=\"p\">,</span> <span class=\"kt\">char</span> <span class=\"o\">**</span><span class=\"n\">argv</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n\n        <span class=\"n\">__wasi_fdstat_t</span> <span class=\"n\">statbuf</span><span class=\"p\">;</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"__wasi_fd_fdstat_get for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">statbuf</span><span class=\"p\">));</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"rights for stdout: %llu</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_rights_base</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"type for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_filetype</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"has filestat_get rights for stdout: %s</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_rights_base</span> <span class=\"o\">&amp;</span> <span class=\"n\">__WASI_RIGHTS_FD_FILESTAT_GET</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span> <span class=\"o\">?</span> <span class=\"s\">\"yes\"</span> <span class=\"o\">:</span> <span class=\"s\">\"no\"</span><span class=\"p\">);</span>\n\n        <span class=\"n\">__wasi_filestat_t</span> <span class=\"n\">filestat</span><span class=\"p\">;</span>\n        <span class=\"kt\">int</span> <span class=\"n\">filestat_res</span> <span class=\"o\">=</span> <span class=\"n\">__wasi_fd_filestat_get</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">filestat</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"__wasi_fd_filestat_get for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">filestat_res</span><span class=\"p\">);</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">filestat_res</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"  E: __wasi_fd_filestat_get returned error: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">filestat_res</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"k\">struct</span> <span class=\"nc\">stat</span> <span class=\"n\">sb</span><span class=\"p\">;</span>\n        <span class=\"kt\">int</span> <span class=\"n\">f</span> <span class=\"o\">=</span> <span class=\"n\">fstat</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">sb</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"fstat for stdout (fd: %d): %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"n\">f</span><span class=\"p\">);</span>\n\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">f</span> <span class=\"o\">&lt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                <span class=\"n\">perror</span><span class=\"p\">(</span><span class=\"s\">\"  E: fstat returned error\"</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"k\">return</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Running it with wasmtime I get:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">fstat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">136314954</span><span class=\"w\"></span>\n<span class=\"k\">type</span> <span class=\"nc\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">filestat_get</span><span class=\"w\"> </span><span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"nc\">yes</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">E</span>: <span class=\"nc\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"n\">fstat</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fd</span>: <span class=\"mi\">1</span><span class=\"p\">)</span>: <span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">E</span>: <span class=\"nc\">fstat</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"nc\">Bad</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">descriptor</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and running the same with Wasmer, I instead get:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmer</span><span class=\"w\"> </span><span class=\"n\">fstat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">136315089</span><span class=\"w\"></span>\n<span class=\"k\">type</span> <span class=\"nc\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">filestat_get</span><span class=\"w\"> </span><span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"nc\">yes</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">fstat</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fd</span>: <span class=\"mi\">1</span><span class=\"p\">)</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n</code></pre></div>\n<h2>Expected outcome</h2>\n<p>Should be able to <code>fstat</code> <code>stdout</code>, right? We are trying to port a program that does that to WASI and we are running in to this.</p>\n</blockquote>",
        "id": 220099094,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1608114500
    },
    {
        "content": "<p>abbec labeled <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515\">Issue #2515</a>:</p>\n<blockquote>\n<p>I am using this program to test:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"cp\">#include</span> <span class=\"cpf\">&lt;stdio.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;stdlib.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;sys/stat.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;sys/types.h&gt;</span><span class=\"cp\"></span>\n\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;wasi/api.h&gt;</span><span class=\"cp\"></span>\n\n<span class=\"kt\">int</span> <span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"kt\">int</span> <span class=\"n\">argc</span><span class=\"p\">,</span> <span class=\"kt\">char</span> <span class=\"o\">**</span><span class=\"n\">argv</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n\n        <span class=\"n\">__wasi_fdstat_t</span> <span class=\"n\">statbuf</span><span class=\"p\">;</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"__wasi_fd_fdstat_get for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">statbuf</span><span class=\"p\">));</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"rights for stdout: %llu</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_rights_base</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"type for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_filetype</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"has filestat_get rights for stdout: %s</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_rights_base</span> <span class=\"o\">&amp;</span> <span class=\"n\">__WASI_RIGHTS_FD_FILESTAT_GET</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span> <span class=\"o\">?</span> <span class=\"s\">\"yes\"</span> <span class=\"o\">:</span> <span class=\"s\">\"no\"</span><span class=\"p\">);</span>\n\n        <span class=\"n\">__wasi_filestat_t</span> <span class=\"n\">filestat</span><span class=\"p\">;</span>\n        <span class=\"kt\">int</span> <span class=\"n\">filestat_res</span> <span class=\"o\">=</span> <span class=\"n\">__wasi_fd_filestat_get</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">filestat</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"__wasi_fd_filestat_get for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">filestat_res</span><span class=\"p\">);</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">filestat_res</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"  E: __wasi_fd_filestat_get returned error: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">filestat_res</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"k\">struct</span> <span class=\"nc\">stat</span> <span class=\"n\">sb</span><span class=\"p\">;</span>\n        <span class=\"kt\">int</span> <span class=\"n\">f</span> <span class=\"o\">=</span> <span class=\"n\">fstat</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">sb</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"fstat for stdout (fd: %d): %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"n\">f</span><span class=\"p\">);</span>\n\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">f</span> <span class=\"o\">&lt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                <span class=\"n\">perror</span><span class=\"p\">(</span><span class=\"s\">\"  E: fstat returned error\"</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"k\">return</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Running it with wasmtime I get:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">fstat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">136314954</span><span class=\"w\"></span>\n<span class=\"k\">type</span> <span class=\"nc\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">filestat_get</span><span class=\"w\"> </span><span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"nc\">yes</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">E</span>: <span class=\"nc\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"n\">fstat</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fd</span>: <span class=\"mi\">1</span><span class=\"p\">)</span>: <span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">E</span>: <span class=\"nc\">fstat</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"nc\">Bad</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">descriptor</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and running the same with Wasmer, I instead get:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmer</span><span class=\"w\"> </span><span class=\"n\">fstat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">136315089</span><span class=\"w\"></span>\n<span class=\"k\">type</span> <span class=\"nc\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">filestat_get</span><span class=\"w\"> </span><span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"nc\">yes</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">fstat</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fd</span>: <span class=\"mi\">1</span><span class=\"p\">)</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n</code></pre></div>\n<h2>Expected outcome</h2>\n<p>Should be able to <code>fstat</code> <code>stdout</code>, right? We are trying to port a program that does that to WASI and we are running in to this.</p>\n</blockquote>",
        "id": 220099095,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1608114500
    },
    {
        "content": "<p>abbec <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515#issuecomment-746102575\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515\">Issue #2515</a>:</p>\n<blockquote>\n<p>It seems to always hit this path: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/5c1d728e3ae8ee7aa329e294999a2c3086b21676/crates/wasi-common/src/handle.rs#L123\">https://github.com/bytecodealliance/wasmtime/blob/5c1d728e3ae8ee7aa329e294999a2c3086b21676/crates/wasi-common/src/handle.rs#L123</a></p>\n</blockquote>",
        "id": 220101738,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1608116393
    },
    {
        "content": "<p>abbec <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515#issuecomment-746201300\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515\">Issue #2515</a>:</p>\n<blockquote>\n<p>Seems like <code>Stdin</code>, <code>Stdout</code> and <code>Stderr</code> are missing implementations for <code>filestat_get</code> in <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-common/src/sys/stdio.rs\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-common/src/sys/stdio.rs</a>?</p>\n</blockquote>",
        "id": 220108125,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1608120978
    },
    {
        "content": "<p>pchickey closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515\">Issue #2515</a>:</p>\n<blockquote>\n<p>I am using this program to test:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"cp\">#include</span> <span class=\"cpf\">&lt;stdio.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;stdlib.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;sys/stat.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;sys/types.h&gt;</span><span class=\"cp\"></span>\n\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;wasi/api.h&gt;</span><span class=\"cp\"></span>\n\n<span class=\"kt\">int</span> <span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"kt\">int</span> <span class=\"n\">argc</span><span class=\"p\">,</span> <span class=\"kt\">char</span> <span class=\"o\">**</span><span class=\"n\">argv</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n\n        <span class=\"n\">__wasi_fdstat_t</span> <span class=\"n\">statbuf</span><span class=\"p\">;</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"__wasi_fd_fdstat_get for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">statbuf</span><span class=\"p\">));</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"rights for stdout: %llu</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_rights_base</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"type for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_filetype</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"has filestat_get rights for stdout: %s</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">statbuf</span><span class=\"p\">.</span><span class=\"n\">fs_rights_base</span> <span class=\"o\">&amp;</span> <span class=\"n\">__WASI_RIGHTS_FD_FILESTAT_GET</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span> <span class=\"o\">?</span> <span class=\"s\">\"yes\"</span> <span class=\"o\">:</span> <span class=\"s\">\"no\"</span><span class=\"p\">);</span>\n\n        <span class=\"n\">__wasi_filestat_t</span> <span class=\"n\">filestat</span><span class=\"p\">;</span>\n        <span class=\"kt\">int</span> <span class=\"n\">filestat_res</span> <span class=\"o\">=</span> <span class=\"n\">__wasi_fd_filestat_get</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">filestat</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"__wasi_fd_filestat_get for stdout: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">filestat_res</span><span class=\"p\">);</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">filestat_res</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"  E: __wasi_fd_filestat_get returned error: %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">filestat_res</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"k\">struct</span> <span class=\"nc\">stat</span> <span class=\"n\">sb</span><span class=\"p\">;</span>\n        <span class=\"kt\">int</span> <span class=\"n\">f</span> <span class=\"o\">=</span> <span class=\"n\">fstat</span><span class=\"p\">(</span><span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"o\">&amp;</span><span class=\"n\">sb</span><span class=\"p\">);</span>\n        <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"fstat for stdout (fd: %d): %d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span> <span class=\"n\">fileno</span><span class=\"p\">(</span><span class=\"n\">stdout</span><span class=\"p\">),</span> <span class=\"n\">f</span><span class=\"p\">);</span>\n\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">f</span> <span class=\"o\">&lt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                <span class=\"n\">perror</span><span class=\"p\">(</span><span class=\"s\">\"  E: fstat returned error\"</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"k\">return</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Running it with wasmtime I get:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">fstat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">136314954</span><span class=\"w\"></span>\n<span class=\"k\">type</span> <span class=\"nc\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">filestat_get</span><span class=\"w\"> </span><span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"nc\">yes</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">E</span>: <span class=\"nc\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"n\">fstat</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fd</span>: <span class=\"mi\">1</span><span class=\"p\">)</span>: <span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">E</span>: <span class=\"nc\">fstat</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"nc\">Bad</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">descriptor</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and running the same with Wasmer, I instead get:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmer</span><span class=\"w\"> </span><span class=\"n\">fstat</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_fdstat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">136315089</span><span class=\"w\"></span>\n<span class=\"k\">type</span> <span class=\"nc\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">2</span><span class=\"w\"></span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">filestat_get</span><span class=\"w\"> </span><span class=\"n\">rights</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"nc\">yes</span><span class=\"w\"></span>\n<span class=\"n\">__wasi_fd_filestat_get</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"n\">fstat</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">fd</span>: <span class=\"mi\">1</span><span class=\"p\">)</span>: <span class=\"mi\">0</span><span class=\"w\"></span>\n</code></pre></div>\n<h2>Expected outcome</h2>\n<p>Should be able to <code>fstat</code> <code>stdout</code>, right? We are trying to port a program that does that to WASI and we are running in to this.</p>\n</blockquote>",
        "id": 220157952,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1608145368
    },
    {
        "content": "<p>pchickey <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515#issuecomment-746842435\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515\">Issue #2515</a>:</p>\n<blockquote>\n<p>Thanks for this report and the fix.</p>\n<p>I'm currently working on a total rewrite of wasi-common in #2487. To make sure I don't introduce a regression on this issue, would you mind adding a unit test that stdio files give a reasonable filestat over in <code>crates/test-programs/wasi-tests/src/bin</code>?</p>\n</blockquote>",
        "id": 220158287,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1608145533
    },
    {
        "content": "<p>sakarias88 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515#issuecomment-747428716\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/2515\">Issue #2515</a>:</p>\n<blockquote>\n<p>@pchickey<br>\nSounds good. We will look into it.</p>\n</blockquote>",
        "id": 220240523,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1608210499
    }
]