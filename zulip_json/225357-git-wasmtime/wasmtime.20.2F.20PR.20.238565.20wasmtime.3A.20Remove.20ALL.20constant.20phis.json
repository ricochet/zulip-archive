[
    {
        "content": "<p><strong>jameysharp</strong> requested <a href=\"https://github.com/cfallin\">cfallin</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a>.</p>",
        "id": 437370303,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715051070
    },
    {
        "content": "<p><strong>jameysharp</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a>.</p>",
        "id": 437370304,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715051071
    },
    {
        "content": "<p>jameysharp opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a> from <code>jameysharp:yes-all-constant-phis</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>When we're trying to delete block-params that can be replaced by a single dominating value, we weren't handling some cases.</p>\n<p>In particular, if we concluded that a block formal parameter (say, <code>v3</code>) had more than one value, then we believed that any uses of that parameter (say, defining another formal parameter <code>v4</code>) also had more than one value, and therefore could not be deleted.</p>\n<p>However, in such cases we can try using <code>v3</code> itself as the definition of <code>v4</code>. If there are no other definitions of <code>v4</code>, then it can be deleted.</p>\n<p>With this change, if a block has only one predecessor, it is now true that this pass will delete all of its block params. We couldn't rely on that property before.</p>\n</blockquote>",
        "id": 437370305,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715051071
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565#pullrequestreview-2043534626\">PR review</a>:</p>\n<blockquote>\n<p>This looks good, thanks! Intuitively it seems the difference to me is the two-stage meet of sorts -- we get an actual <code>Value</code> (<code>replacement</code>) then test <em>that</em> against the abstract value and handle the case where it's actually the same as the existing <code>One</code>; is that where these two diverged?</p>\n<p>I'm not sure if there's a comment of some sort that would help with this subtlety (I also didn't write the original and haven't looked at this code in a while so I may have misunderstood some of the original thinking); but it's already quite well commented, so I'll leave it up to you if you can think of any further explanation-comments to add or not. In any case, thanks!</p>\n</blockquote>",
        "id": 437478224,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715095817
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565#issuecomment-2099203930\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a>:</p>\n<blockquote>\n<p>@jameysharp would you mind also doing a Sightglass run on this? It <em>should</em>, from first principles, mainly result in speedups; but I'm getting some weird results when trying it on some weval'd code (-5% deltas) and I'm wondering if it has some unfortunate interactions in my case with regalloc (longer liveranges) or if it's something else. In any case having a baseline measurement on \"normal\" code (not my horrific spaghetti) would be useful I suspect :-)</p>\n</blockquote>",
        "id": 437521667,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715112041
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565#issuecomment-2099412114\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a>:</p>\n<blockquote>\n<blockquote>\n<p>This looks good, thanks! Intuitively it seems the difference to me is the two-stage meet of sorts -- we get an actual <code>Value</code> (<code>replacement</code>) then test _that_ against the abstract value and handle the case where it's actually the same as the existing <code>One</code>; is that where these two diverged?</p>\n<p>I'm not sure if there's a comment of some sort that would help with this subtlety (I also didn't write the original and haven't looked at this code in a while so I may have misunderstood some of the original thinking); but it's already quite well commented, so I'll leave it up to you if you can think of any further explanation-comments to add or not. In any case, thanks!</p>\n</blockquote>\n<p>I'm not sure I understand the way you phrased this question, so I'm going to try answering a different question and see if that helps.</p>\n<p>If we decide that a formal block parameter can be replaced by another value, then we want to forward _that_ value in the dataflow analysis if that formal parameter is used as the actual parameter for another branch. I'm thinking of it like continuing the analysis _as if_ one rewrite had already happened, to see if that makes more rewrites visible.</p>\n<p>The existing implementation did that, except it forwarded any abstract value from the formal parameter, including the <code>Many</code> value indicating that a rewrite is not possible. Where this PR diverges is that once we have learned that a rewrite is not possible for some formal parameter, we should treat it like any other value that we aren't rewriting, such as entry-block formal parameters or instruction results.</p>\n<p>As a result it turns out that the only abstract value we can get from that check is the <code>One</code> case: either the one value we currently believe we can rewrite to, or the non-rewritable value itself. Therefore I simplified <code>join</code> because we always join with the same kind of abstract value. But I don't think of it as a two-stage meet.</p>\n<p>By the way, one thing I worried about is whether this dataflow transfer function is monotonic, and I had trouble convincing myself. Since this is a fix-point, it can optimistically assume that a rewrite will succeed until it finds evidence to the contrary, at which point that evidence propagates. But that means we can have a formal parameter which we assigned an abstract value of <code>One</code> to, and forwarded to other blocks as above, but then on the next iteration we learn it's actually <code>Many</code> so this time we forward a different value onward. Could there exist a CFG where doing so causes the formal parameter to go back to <code>One</code> state?</p>\n<p>Now that I've written this out I remember the answer is trivially \"no\": we join the previous abstract value with the new one, and <code>Many</code> is \"sticky\". So once we've decided we can't rewrite a value, we never go back.</p>\n<blockquote>\n<p>@jameysharp would you mind also doing a Sightglass run on this? It _should_, from first principles, mainly result in speedups; but I'm getting some weird results when trying it on some weval'd code (-5% deltas) and I'm wondering if it has some unfortunate interactions in my case with regalloc (longer liveranges) or if it's something else. In any case having a baseline measurement on \"normal\" code (not my horrific spaghetti) would be useful I suspect :-)</p>\n</blockquote>\n<p>Sightglass on the default benchmark set says there is no significant difference in:</p>\n<ul>\n<li>instantiation (as expected);</li>\n<li>compilation (mildly disappointing), except for small effects in cache-accesses on bz2/pulldown-cmark, which I generally find to be a noisy measure anyway;</li>\n<li>or cache metrics otherwise.</li>\n</ul>\n<p>During execution, by instructions retired, this PR is very slightly worse on all three benchmarks. By CPU cycles, bz2 is faster with this PR and the others are a wash. Now that I know this, I'm not sure what to do with it.</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">cpu</span><span class=\"o\">-</span><span class=\"n\">cycles</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">3838403.12</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">2463605.04</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.06</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">100771190</span><span class=\"w\"> </span><span class=\"mf\">107900272.66</span><span class=\"w\"> </span><span class=\"mi\">126167246</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">100584228</span><span class=\"w\"> </span><span class=\"mf\">104061869.54</span><span class=\"w\"> </span><span class=\"mi\">121997952</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">482232.60</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">94.51</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.02</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.02</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">19708191</span><span class=\"w\"> </span><span class=\"mf\">19708335.27</span><span class=\"w\"> </span><span class=\"mi\">19708917</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">20190380</span><span class=\"w\"> </span><span class=\"mf\">20190567.87</span><span class=\"w\"> </span><span class=\"mi\">20191097</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2499390.23</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">27298.54</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">2658325340</span><span class=\"w\"> </span><span class=\"mf\">2658415971.80</span><span class=\"w\"> </span><span class=\"mi\">2658657194</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">2660806656</span><span class=\"w\"> </span><span class=\"mf\">2660915362.03</span><span class=\"w\"> </span><span class=\"mi\">2661215422</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">84593.43</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">0.36</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">227350470</span><span class=\"w\"> </span><span class=\"mf\">227350471.64</span><span class=\"w\"> </span><span class=\"mi\">227350474</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">227435064</span><span class=\"w\"> </span><span class=\"mf\">227435065.07</span><span class=\"w\"> </span><span class=\"mi\">227435068</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 437541786,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715120574
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565#issuecomment-2099635081\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a>:</p>\n<blockquote>\n<p>OK, cool; that's what I had understood, I was mostly just wondering if there was some sort of doc-comment we could add to clarify. I think it's probably fine as-is.</p>\n<p>Re: termination and monotonicity, I agree. The stickiness of values and using the meet-function of a finite-height lattice alone is enough to ensure termination, but a unique solution (i.e. ensuring that the result is not dependent on processing order or whatnot) requires monotonicity of the transfer functions too (i.e. <code>x &lt;= y implies f(x) &lt;= f(y)</code> for any <code>f</code>, including the abstract-value behavior of blockparams). I think that holds in this case; even the \"<code>Many</code> laundered through a blockparam becomes a <code>One</code>\" property is monotonic. That's because it's never the case that an input moving down the lattice (going from <code>One</code> to <code>Many</code>) can turn the output from <code>Many</code> to <code>One</code> (right?).</p>\n<p>Re: performance: the mixed results are a little concerning combined with my observations from earlier; maybe this is something we could dig a bit further into? I agree the change seems very nice; but if in practice it does bad things to regalloc today then perhaps we can keep it around 'til those issues are resolved or we understand the conditions better...</p>\n</blockquote>",
        "id": 437565959,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715136635
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565#issuecomment-2099935790\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a>:</p>\n<blockquote>\n<blockquote>\n<p>Re: termination and monotonicity, I agree. The stickiness of values and using the meet-function of a finite-height lattice alone is enough to ensure termination, but a unique solution (i.e. ensuring that the result is not dependent on processing order or whatnot) requires monotonicity of the transfer functions too (i.e. <code>x &lt;= y implies f(x) &lt;= f(y)</code> for any <code>f</code>, including the abstract-value behavior of blockparams). I think that holds in this case; even the \"<code>Many</code> laundered through a blockparam becomes a <code>One</code>\" property is monotonic. That's because it's never the case that an input moving down the lattice (going from <code>One</code> to <code>Many</code>) can turn the output from <code>Many</code> to <code>One</code> (right?).</p>\n</blockquote>\n<p>Oh right, uniqueness of the solution would be nice too. Yeah, this is what I had trouble reasoning about.</p>\n<p>Let's say we see that <code>v5</code> is a formal block parameter which on some branch has received <code>v4</code> as its actual parameter, and that <code>v4</code> in turn is another formal block parameter which so far we've only seen <code>v3</code> given as the actual parameter for. Therefore we tentatively conclude that both <code>v4</code> and <code>v5</code> can be rewritten to use <code>v3</code> instead.</p>\n<p>Now later let's say we discover that <code>v4</code> has more actual parameters besides <code>v3</code>, so we bump it to <code>Many</code> on the lattice. With this PR, that changes the value we want to meet with <code>v5</code>'s abstract value from <code>One(v3)</code> to <code>One(v4)</code>. Since those are different values, we bump <code>v5</code> to <code>Many</code> on the lattice as well. But perhaps we'd have gotten a stable fix-point from using <code>One(v4)</code> instead of <code>Many</code>?</p>\n<p>I think there's something here about the fact that we do this analysis pass in reverse post-order that helps, maybe only for reducible flow graphs.</p>\n<p>But I also wonder if this needs a different lattice, distinguishing between \"the one value coming from a blockparam\" versus \"the one value coming from a concrete source such as an instruction result\".</p>\n<blockquote>\n<p>Re: performance: the mixed results are a little concerning combined with my observations from earlier; maybe this is something we could dig a bit further into? I agree the change seems very nice; but if in practice it does bad things to regalloc today then perhaps we can keep it around 'til those issues are resolved or we understand the conditions better...</p>\n</blockquote>\n<p>Let me make the performance question more complicated <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> </p>\n<p>I discovered this missed-optimization bug because I was trying to address #7639, which was prompted by work Amanieu wanted to do in <a href=\"https://github.com/bytecodealliance/regalloc2/issues/170\">bytecodealliance/regalloc2#170</a>. This PR establishes the guarantee that any block which has only one predecessor has no incoming block-params, and that makes it easier to avoid having any block-params on branches that have multiple outgoing destinations, since then only the critical edges have block-params and you can move them into the block that's created for splitting the critical edge.</p>\n<p>I've done a Sightglass run comparing this PR against the local branch I have for eliminating block-params from branches with multiple destinations; that branch is based on this one. Measured by instructions retired during execution, all the usual benchmarks are a little faster on that branch. Spidermonkey is also slightly faster by CPU cycles on that branch.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">312520.28</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">107.30</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.02</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.02</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">19877813</span><span class=\"w\"> </span><span class=\"mf\">19878054.49</span><span class=\"w\"> </span><span class=\"mi\">19878621</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">20190380</span><span class=\"w\"> </span><span class=\"mf\">20190574.77</span><span class=\"w\"> </span><span class=\"mi\">20191114</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">cpu</span><span class=\"o\">-</span><span class=\"n\">cycles</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1068752.77</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">254583.37</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">100489713</span><span class=\"w\"> </span><span class=\"mf\">101440920.46</span><span class=\"w\"> </span><span class=\"mi\">104541932</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">99842117</span><span class=\"w\"> </span><span class=\"mf\">100372167.69</span><span class=\"w\"> </span><span class=\"mi\">100906771</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">14461536.49</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">29120.93</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">2646345104</span><span class=\"w\"> </span><span class=\"mf\">2646446038.97</span><span class=\"w\"> </span><span class=\"mi\">2646651491</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">2660807100</span><span class=\"w\"> </span><span class=\"mf\">2660907575.46</span><span class=\"w\"> </span><span class=\"mi\">2661200553</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">cpu</span><span class=\"o\">-</span><span class=\"n\">cycles</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">2435891.43</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">1730336.92</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">953247671</span><span class=\"w\"> </span><span class=\"mf\">960026022.33</span><span class=\"w\"> </span><span class=\"mi\">990561731</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">953674753</span><span class=\"w\"> </span><span class=\"mf\">962461913.76</span><span class=\"w\"> </span><span class=\"mi\">989849731</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">148464.74</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">0.20</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">227286598</span><span class=\"w\"> </span><span class=\"mf\">227286599.79</span><span class=\"w\"> </span><span class=\"mi\">227286602</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">227435063</span><span class=\"w\"> </span><span class=\"mf\">227435064.53</span><span class=\"w\"> </span><span class=\"mi\">227435066</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">compilation</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">164098.23</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">128446.28</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">424854236</span><span class=\"w\"> </span><span class=\"mf\">425728699.98</span><span class=\"w\"> </span><span class=\"mi\">426706876</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">424694001</span><span class=\"w\"> </span><span class=\"mf\">425564601.75</span><span class=\"w\"> </span><span class=\"mi\">426230047</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">yes</span><span class=\"o\">-</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">27</span><span class=\"n\">c1c1d74</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>I'll do another Sightglass run comparing that branch to <code>no-all-constant-phis-81a89169f.so</code> (the parent of this PR) so we can discuss the performance of the combination.</p>\n</blockquote>",
        "id": 437594843,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715153638
    },
    {
        "content": "<p>jameysharp <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565#issuecomment-2100962412\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a>:</p>\n<blockquote>\n<p>Okay, I've compared <code>no-all-constant-phis-81a89169f.so</code> (the parent of this PR) with <code>no-multi-branch-blockparams-73d4f890e.so</code> (the follow-on change I mentioned). (Sightglass stripped the \"no-\" prefix off my filenames in the below output.)</p>\n<p>Overall effect size is small in all cases. The biggest percentage change is for pulldown-cmark, where the combination is maybe 1% slower during execution by either instructions retired or CPU cycles. No significant difference in compilation.</p>\n<p>&lt;details&gt;&lt;summary&gt;pulldown-cmark Sightglass results&lt;/summary&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">169617.17</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">94.37</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">19708183</span><span class=\"w\"> </span><span class=\"mf\">19708354.86</span><span class=\"w\"> </span><span class=\"mi\">19708941</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">19877805</span><span class=\"w\"> </span><span class=\"mf\">19877972.03</span><span class=\"w\"> </span><span class=\"mi\">19878516</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">cpu</span><span class=\"o\">-</span><span class=\"n\">cycles</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">36355.47</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">19560.48</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">7450646</span><span class=\"w\"> </span><span class=\"mf\">7532210.67</span><span class=\"w\"> </span><span class=\"mi\">7757423</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">7493914</span><span class=\"w\"> </span><span class=\"mf\">7568566.14</span><span class=\"w\"> </span><span class=\"mi\">7749656</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>Spidermonkey is marginally faster during both compilation and execution, by instructions retired; no significant difference in CPU cycles.</p>\n<p>&lt;details&gt;&lt;summary&gt;spidermonkey Sightglass results&lt;/summary&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">11971268.75</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">27736.55</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">2658323222</span><span class=\"w\"> </span><span class=\"mf\">2658418217.79</span><span class=\"w\"> </span><span class=\"mi\">2658675495</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">2646347136</span><span class=\"w\"> </span><span class=\"mf\">2646446949.04</span><span class=\"w\"> </span><span class=\"mi\">2646669800</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">compilation</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">133883.56</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">121584.27</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">425093370</span><span class=\"w\"> </span><span class=\"mf\">425735710.00</span><span class=\"w\"> </span><span class=\"mi\">426816063</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">424905839</span><span class=\"w\"> </span><span class=\"mf\">425601826.44</span><span class=\"w\"> </span><span class=\"mi\">426469074</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>And bz2 is slower by CPU cycles but faster by instructions retired, during execution. No significant difference during compilation.</p>\n<p>&lt;details&gt;&lt;summary&gt;bz2 Sightglass results&lt;/summary&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">cpu</span><span class=\"o\">-</span><span class=\"n\">cycles</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">286689.44</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">172752.93</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">100185679</span><span class=\"w\"> </span><span class=\"mf\">100876101.21</span><span class=\"w\"> </span><span class=\"mi\">102588446</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">100330544</span><span class=\"w\"> </span><span class=\"mf\">101162790.65</span><span class=\"w\"> </span><span class=\"mi\">103125048</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span>:: <span class=\"nc\">instructions</span><span class=\"o\">-</span><span class=\"n\">retired</span><span class=\"w\"> </span>:: <span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">63871.05</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">0.20</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">227350470</span><span class=\"w\"> </span><span class=\"mf\">227350470.75</span><span class=\"w\"> </span><span class=\"mi\">227350472</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">constant</span><span class=\"o\">-</span><span class=\"n\">phis</span><span class=\"o\">-</span><span class=\"mi\">81</span><span class=\"n\">a89169f</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">227286598</span><span class=\"w\"> </span><span class=\"mf\">227286599.70</span><span class=\"w\"> </span><span class=\"mi\">227286601</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">multi</span><span class=\"o\">-</span><span class=\"n\">branch</span><span class=\"o\">-</span><span class=\"n\">blockparams</span><span class=\"o\">-</span><span class=\"mi\">73</span><span class=\"n\">d4f890e</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n</blockquote>",
        "id": 437686923,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715185863
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565#issuecomment-2100984420\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8565\">PR #8565</a>:</p>\n<blockquote>\n<p>Interesting; given the choice between judging performance by instructions-retired and judging performance by cycles, let's take the latter since it's what the user sees; so we have slower (pulldown-cmark), no change (spidermonkey), slower (bz2). Unfortunately it seems there's more to understand here. I share your (assumed) frustration that a clear and obvious optimization doesn't result in a speedup -- in fact I also implemented redundant-phi elimination in waffle yesterday just to see if it changed with wasm-producer-side vs native-side optimizations and got similar slowdowns. I suspect it means we have work to do in regalloc :-/</p>\n</blockquote>",
        "id": 437689243,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1715186538
    }
]